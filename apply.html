<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- 引入 FontAwesome 增加圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f6;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --header-bg: #fff;
        }

        body { 
            padding: 20px; 
            background-color: var(--bg-color);
            color: #333;
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
        }

        /* UI 元件：卡片樣式 */
        .ui-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 25px;
            border: none;
            transition: transform 0.2s;
        }
        
        .ui-card h5 {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* 表格區塊優化 */
        .asset-table-container { 
            max-height: 500px; 
            overflow-y: auto; 
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .table thead th {
            background-color: #fafafa;
            border-top: none;
            color: #555;
            font-weight: 600;
            position: sticky; 
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .table-hover tbody tr:hover {
            background-color: #f1f8ff;
        }

        /* 狀態列 */
        .selection-status {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
        }

        /* 特殊轉移模式區塊 - 視覺區隔 */
        .special-transfer-section {
            background-color: #fff8e1; /* 淡黃色背景，強調注意 */
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 20px;
        }

        /* 分頁控制優化 */
        .pagination-controls { 
            margin-top: 20px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
        }

        /* 搜尋框與篩選器美化 */
        .filter-icon {
            color: #888;
            margin-right: 5px;
        }

        /* 互動選項美化 */
        .custom-control-label {
            cursor: pointer;
            font-weight: 500;
        }
        
        /* 按鈕區 */
        .action-bar {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 30px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:hover {
            background-color: #357abd;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_basic'); ?>
    <?!= include('progress_bar_fly'); ?>

    <div class="container-fluid" style="max-width: 1200px;">
        <div id="status-message"></div>

        <div id="main-form" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0"><i class="fas fa-exchange-alt mr-2 text-primary"></i>財產轉移申請 (批次)</h4>
            </div>
            
            <!-- SECTION 1: 篩選與清單 -->
            <div class="ui-card">
                <h5><i class="fas fa-filter mr-2 filter-icon"></i>步驟 1：選擇資產</h5>
                
                <div class="form-row mb-3">
                    <div class="form-group col-md-4">
                        <label class="text-muted small">地點篩選</label>
                        <select id="location-filter-select" class="form-control custom-select">
                            <option value="">-- 顯示全部地點 --</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="text-muted small">財產類別篩選</label>
                        <select id="category-filter-select" class="form-control custom-select">
                            <option value="">-- 顯示全部類別 --</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="text-muted small">關鍵字搜尋</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" class="form-control" id="search-box" placeholder="輸入產編、名稱或地點...">
                        </div>
                    </div>
                </div>

                <div class="asset-table-container">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 5%;" class="text-center"><input type="checkbox" id="select-all"></th>
                                <th style="width: 20%;">財產編號</th>
                                <th style="width: 25%;">財產名稱</th>
                                <th style="width: 12%;">使用者</th>
                                <th style="width: 12%;">保管人</th>
                                <th style="width: 13%;">目前地點</th>
                                <th style="width: 13%;">財產類別</th>
                            </tr>
                        </thead>
                        <tbody id="asset-list"></tbody>
                    </table>
                </div>
                
                <div id="pagination-controls" class="pagination-controls border-top mt-0"></div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="selection-status">
                        <i class="fas fa-check-circle mr-1"></i> 已勾選 <span id="selected-count" class="font-weight-bold" style="font-size: 1.2em;">0</span> 筆財產
                    </div>
                    <small class="text-muted">請勾選上方列表中的財產以繼續</small>
                </div>
            </div>

            <div class="row">
                <!-- 左側：一般轉移 (預設) -->
                <div class="col-lg-8">
                    <div class="ui-card" id="regular-transfer-card">
                        <h5><i class="fas fa-tasks mr-2 filter-icon"></i>步驟 2：設定轉移資訊 (一般轉移)</h5>
                        
                        <!-- 一般轉移選項與下拉選單的容器 -->
                        <div id="regular-transfer-options">
                            <div class="form-group mb-4">
                                <label class="d-block mb-2 text-muted font-weight-bold">請勾選本次要變更的項目：</label>
                                <div class="d-flex flex-wrap">
                                    <div class="custom-control custom-checkbox mr-4 mb-2">
                                        <input class="custom-control-input" type="checkbox" id="change-location" checked>
                                        <label class="custom-control-label" for="change-location">變更地點</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-4 mb-2">
                                        <input class="custom-control-input" type="checkbox" id="change-keeper" checked>
                                        <label class="custom-control-label" for="change-keeper">變更保管人 <span class="badge badge-warning font-weight-normal">需審核</span></label>
                                    </div>
                                    <div class="custom-control custom-checkbox mb-2">
                                        <input class="custom-control-input" type="checkbox" id="change-user">
                                        <label class="custom-control-label" for="change-user">變更使用人 <span class="badge badge-secondary font-weight-normal">僅限財產總表</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="regular-transfer-selects" class="bg-light p-3 rounded">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="location-select">新地點：</label>
                                    <select class="form-control" id="location-select" name="newLocation">
                                        <option value="">請選擇地點...</option>
                                    </select>
                                    <small class="form-text text-muted">若不變更地點，請留空</small>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="keeper-select">新保管人：</label>
                                    <select class="form-control" id="keeper-select" name="newKeeperEmail">
                                        <option value="">請選擇新保管人...</option>
                                    </select>
                                    <small class="form-text text-muted">若不變更保管人，請留空</small>
                                </div>
                                <!-- 使用人選擇 (預設隱藏) -->
                                <div class="form-group col-md-12 mt-2" id="user-select-group" style="display:none;">
                                    <label for="user-select" class="text-primary font-weight-bold">新使用人：</label>
                                    <select class="form-control border-primary" id="user-select" name="newUserName">
                                        <option value="">請選擇新使用人...</option>
                                    </select>
                                    <small class="form-text text-muted">僅適用於財產總表的資產</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 駐站轉移專用下拉選單 (預設隱藏，會取代上面的 regular-selects) -->
                        <div id="station-transfer-selects" class="bg-light p-3 rounded" style="display:none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-1"></i> <strong>駐站模式說明：</strong> 保管人和使用人將同時設為此駐管。
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="custodian-select">轉移給駐管：</label>
                                    <select class="form-control" id="custodian-select">
                                        <option value="">請選擇駐管...</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="station-location-select">駐站地點：</label>
                                    <select class="form-control" id="station-location-select">
                                        <option value="">請選擇駐站地點...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側：特殊轉移模式 -->
                <div class="col-lg-4">
                    <div class="ui-card special-transfer-section">
                        <h6 class="text-warning-dark font-weight-bold"><i class="fas fa-star mr-2"></i>特殊轉移模式</h6>
                        <p class="small text-muted mb-3">若選用此區功能，左側一般設定將被覆蓋。</p>

                        <!-- 選項1 -->
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input special-transfer-mode" id="station-transfer">
                            <label class="custom-control-label font-weight-bold" for="station-transfer">中心轉移給駐站</label>
                            <div class="small text-muted ml-1">同時變更保管人、使用人和地點</div>
                        </div>

                        <div class="dropdown-divider border-warning opacity-50"></div>

                        <!-- 選項2 -->
                        <div class="custom-control custom-switch mb-3 mt-3">
                            <input type="checkbox" class="custom-control-input special-transfer-mode" id="info-transfer">
                            <label class="custom-control-label font-weight-bold" for="info-transfer">駐站回送中心資訊組</label>
                            <small class="d-block text-danger mt-1" id="info-transfer-hint" style="display:none;">
                                <i class="fas fa-exclamation-triangle"></i> 資料不完整，無法使用
                            </small>
                        </div>

                        <!-- 選項3 -->
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input special-transfer-mode" id="intake-transfer">
                            <label class="custom-control-label font-weight-bold" for="intake-transfer">駐站回送中心收案組</label>
                            <small class="d-block text-danger mt-1" id="intake-transfer-hint" style="display:none;">
                                <i class="fas fa-exclamation-triangle"></i> 資料不完整，無法使用
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="button" class="btn btn-primary btn-lg" onclick="submitApplication()">
                    <i class="fas fa-paper-plane mr-2"></i>提交申請
                </button>
            </div>
            
            <div class="mb-5"></div> <!-- 底部留白 -->
        </div>
    </div>

    <!-- 保持原有的 Script 邏輯，不做任何變更，只確保 DOM ID 存在 -->
    <script>
        let allAssets = [];
        let filteredAssets = [];
        let currentPage = 1;
        let rowsPerPage = 2000;

        document.addEventListener("DOMContentLoaded", () => {
            // Hide main form and show progress bar
            document.getElementById('main-form').style.display = 'none';
            showProgressBar('正在載入資料，請稍候...');

            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onDataError)
                .getTransferData();

            document.getElementById('search-box').addEventListener('input', filterTable);
            document.getElementById('location-filter-select').addEventListener('change', filterTable);
            document.getElementById('category-filter-select').addEventListener('change', filterTable);
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
            
            // ✨ 轉移選項切換監聽
            document.getElementById('change-user').addEventListener('change', toggleUserSelect);

            // ✨ 特殊轉移模式 checkbox 監聽
            document.querySelectorAll('.special-transfer-mode').forEach(checkbox => {
                checkbox.addEventListener('change', handleSpecialTransferModeChange);
            });
            
            // UI 優化：當一般選項改變時，確保特殊選項被取消 (雙向互斥)
            const regularCheckboxes = ['change-location', 'change-keeper', 'change-user'];
            regularCheckboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if(this.checked) {
                       // 如果使用者手動去勾選一般選項，且目前處於特殊模式，是否要取消特殊模式？
                       // 為了 UX 直覺，如果使用者回頭操作一般選項，我們視為他想回到一般模式
                       const isAnySpecialChecked = Array.from(document.querySelectorAll('.special-transfer-mode')).some(c => c.checked);
                       if(isAnySpecialChecked) {
                           // 取消所有特殊模式
                           document.querySelectorAll('.special-transfer-mode').forEach(cb => {
                               cb.checked = false;
                               // 手動觸發 change 事件以重置 UI
                               cb.dispatchEvent(new Event('change'));
                           });
                           // 因為 handleSpecialTransferModeChange 會把一般選項取消，我們這裡要重新勾選被點擊的那個
                           this.checked = true;
                           // 重新觸發一次 user select 的顯示邏輯
                           if(this.id === 'change-user') toggleUserSelect();
                       }
                    }
                });
            });
        });
        
        function toggleUserSelect() {
            const changeUser = document.getElementById('change-user').checked;
            const userSelectGroup = document.getElementById('user-select-group');
            userSelectGroup.style.display = changeUser ? 'block' : 'none';
        }

        function handleSpecialTransferModeChange(event) {
            const selectedCheckbox = event.target;

            // 如果當前 checkbox 被勾選，取消其他 checkbox
            if (selectedCheckbox.checked) {
                document.querySelectorAll('.special-transfer-mode').forEach(cb => {
                    if (cb !== selectedCheckbox) {
                        cb.checked = false;
                    }
                });
            }

            // 根據選擇的模式切換 UI
            const isStationMode = document.getElementById('station-transfer').checked;
            const isInfoMode = document.getElementById('info-transfer').checked;
            const isIntakeMode = document.getElementById('intake-transfer').checked;

            const regularOptions = document.getElementById('regular-transfer-options');
            const regularSelects = document.getElementById('regular-transfer-selects');
            const stationSelects = document.getElementById('station-transfer-selects');
            const regularCard = document.getElementById('regular-transfer-card'); // 獲取卡片參考

            if (isStationMode || isInfoMode || isIntakeMode) {
                // 特殊模式：視覺變更
                regularCard.style.opacity = '0.6'; // 讓一般選項看起來像被禁用
                regularCard.style.pointerEvents = 'none'; // 禁止點擊
                
                // 為了讓駐站模式的選單可以使用，我們需要特殊處理
                if (isStationMode) {
                    regularOptions.style.display = 'none';
                    regularSelects.style.display = 'none';
                    stationSelects.style.display = 'block';
                    // 恢復卡片互動性給駐站下拉選單
                    regularCard.style.opacity = '1';
                    regularCard.style.pointerEvents = 'auto';
                } else {
                    // 資訊組或收案組模式，完全不需要下拉選單
                    regularOptions.style.display = 'none';
                    regularSelects.style.display = 'none';
                    stationSelects.style.display = 'none';
                    // 這裡保持卡片淡出，表示不需要操作此區
                }

                // 取消勾選一般選項 (邏輯層面)
                document.getElementById('change-location').checked = false;
                document.getElementById('change-keeper').checked = false;
                document.getElementById('change-user').checked = false;

                // 清空一般下拉選單
                document.getElementById('keeper-select').value = '';
                document.getElementById('location-select').value = '';
                document.getElementById('user-select').value = '';
                document.getElementById('user-select-group').style.display = 'none';

            } else {
                // 一般模式：恢復原狀
                regularCard.style.opacity = '1';
                regularCard.style.pointerEvents = 'auto';
                
                regularOptions.style.display = 'block';
                regularSelects.style.display = 'block';
                stationSelects.style.display = 'none';

                // 恢復預設勾選
                document.getElementById('change-location').checked = true;
                document.getElementById('change-keeper').checked = true;

                // 清空駐站下拉選單
                document.getElementById('custodian-select').value = '';
                document.getElementById('station-location-select').value = '';
            }
        }

        function onDataLoaded(data) {
            hideProgressBar('資料載入完成！');

            setTimeout(() => {
                document.getElementById('main-form').style.display = 'block';
                populateForm(data);
            }, 300);
        }

        function onDataError(error) {
            hideProgressBar('載入失敗！', 300);

            setTimeout(() => {
                document.getElementById('main-form').style.display = 'block';
                showError(error);
            }, 300);
        }

        function populateForm(data) {
            window.transferData = data;
            allAssets = data.assets;
            filteredAssets = allAssets;

            if (!allAssets || allAssets.length === 0) {
                showError({message: "您目前沒有可轉移的財產。"});
                return;
            }

            document.getElementById('location-filter-select').innerHTML = '<option value="">-- 顯示全部地點 --</option>';
            document.getElementById('category-filter-select').innerHTML = '<option value="">-- 顯示全部類別 --</option>';
            document.getElementById('keeper-select').innerHTML = '<option value="">請選擇新保管人...</option>';
            document.getElementById('user-select').innerHTML = '<option value="">請選擇新使用人...</option>';
            document.getElementById('custodian-select').innerHTML = '<option value="">請選擇駐管...</option>';
            document.getElementById('station-location-select').innerHTML = '<option value="">請選擇駐站地點...</option>';

            currentPage = 1;

            displayPage(currentPage);
            populateLocationFilter(allAssets);
            populateCategoryFilter(allAssets);
            
            const keeperSelect = document.getElementById('keeper-select');
            const locationSelect = document.getElementById('location-select');

            const sortedKeepers = Object.entries(data.keepers).map(([email, name]) => ({ email, name })).sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedKeepers.forEach(keeper => {
                const option = document.createElement('option');
                option.value = keeper.email;
                const displayName = (keeper.email === data.userEmail) ? `${keeper.name} (自己)` : keeper.name;
                option.textContent = displayName;
                keeperSelect.appendChild(option);
            });

            locationSelect.innerHTML = '<option value="">請選擇地點...</option>';
            data.locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });
            locationSelect.disabled = false;
            
            const userSelect = document.getElementById('user-select');
            const sortedUsers = Object.entries(data.users || data.keepers).map(([email, name]) => ({ email, name })).sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                const displayName = (user.email === data.userEmail) ? `${user.name} (自己)` : user.name;
                option.textContent = displayName;
                userSelect.appendChild(option);
            });

            const custodianSelect = document.getElementById('custodian-select');
            const custodians = data.custodians || {};
            const custodianEntries = Object.entries(custodians)
                .map(([email, name]) => ({ email, name }))
                .sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));

            if (custodianEntries.length === 0) {
                custodianSelect.innerHTML = '<option value="">目前沒有駐管資料</option>';
                custodianSelect.disabled = true;
            } else {
                custodianEntries.forEach(custodian => {
                    const option = document.createElement('option');
                    option.value = custodian.email;
                    const displayName = (custodian.email === data.userEmail) ? `${custodian.name} (自己)` : custodian.name;
                    option.textContent = displayName;
                    custodianSelect.appendChild(option);
                });
            }

            const stationLocationSelect = document.getElementById('station-location-select');
            const stationLocations = data.stationLocations || [];

            if (stationLocations.length === 0) {
                stationLocationSelect.innerHTML = '<option value="">目前沒有駐站地點資料</option>';
                stationLocationSelect.disabled = true;
            } else {
                stationLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    stationLocationSelect.appendChild(option);
                });
            }

            const infoTransferCheckbox = document.getElementById('info-transfer');
            const infoTransferHint = document.getElementById('info-transfer-hint');

            if (!data.infoCustodian || !data.infoUser || !data.infoLocation || !data.infoComputerLocation) {
                infoTransferCheckbox.disabled = true;
                infoTransferHint.style.display = 'block';
            }

            const intakeTransferCheckbox = document.getElementById('intake-transfer');
            const intakeTransferHint = document.getElementById('intake-transfer-hint');

            if (!data.intakeCustodian || !data.intakeLocation) {
                intakeTransferCheckbox.disabled = true;
                intakeTransferHint.style.display = 'block';
            }
        }

        function displayPage(page) {
            currentPage = page;
            renderTableForPage(filteredAssets, rowsPerPage, currentPage);
            setupPagination(filteredAssets, rowsPerPage);
        }

        function populateLocationFilter(assets) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            const uniqueLocations = [...new Set(assets.map(asset => asset.location))].sort();
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function populateCategoryFilter(assets) {
            const categoryFilterSelect = document.getElementById('category-filter-select');
            const uniqueCategories = [...new Set(assets.map(asset => asset.category))].sort();
            uniqueCategories.forEach(cat => {
                if (cat) {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilterSelect.appendChild(option);
                }
            });
        }

        function renderTableForPage(assets, rows, page) {
            const assetListBody = document.getElementById('asset-list');
            assetListBody.innerHTML = '';
            
            page--;
            const start = rows * page;
            const end = start + rows;
            const paginatedItems = assets.slice(start, end);

            paginatedItems.forEach(asset => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><input type="checkbox" class="asset-checkbox" value="${asset.id}"></td><td>${asset.id}</td><td>${asset.assetName}</td><td>${asset.userName}</td><td>${asset.leaderName}</td><td>${asset.location}</td><td>${asset.category}</td>`;
                assetListBody.appendChild(row);
            });
            
            updateSelectedCount();
            document.querySelectorAll('.asset-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedCount));
        }
        
        function setupPagination(items, rows) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = "";

            const pageCount = Math.ceil(items.length / rows);
            
            if(pageCount <= 1) return; // 只有一頁時隱藏分頁

            const pageInfo = document.createElement('div');
            pageInfo.innerHTML = `<span class="badge badge-light">第 ${currentPage} / ${pageCount} 頁</span> <span class="text-muted ml-2">(共 ${items.length} 筆)</span>`;
            paginationContainer.appendChild(pageInfo);

            const nav = document.createElement('nav');
            const ul = document.createElement('ul');
            ul.className = 'pagination mb-0';
            
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevLink.onclick = () => { if (currentPage > 1) displayPage(currentPage - 1); };
            prevLi.appendChild(prevLink);
            ul.appendChild(prevLi);

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextLink.onclick = () => { if (currentPage < pageCount) displayPage(currentPage + 1); };
            nextLi.appendChild(nextLink);
            ul.appendChild(nextLi);

            nav.appendChild(ul);
            paginationContainer.appendChild(nav);
        }

        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const categoryFilter = document.getElementById('category-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();

            filteredAssets = allAssets.filter(asset => {
                const locationMatch = (locationFilter === '') || (asset.location.toUpperCase() === locationFilter);
                const categoryMatch = (categoryFilter === '') || (asset.category && asset.category.toUpperCase() === categoryFilter);
                const searchMatch = asset.id.toUpperCase().includes(searchFilter) || 
                                    (asset.assetName && asset.assetName.toUpperCase().includes(searchFilter)) || 
                                    asset.location.toUpperCase().includes(searchFilter);
                return locationMatch && categoryMatch && searchMatch;
            });
            
            displayPage(1);
        }
        
        function updateSelectedCount() {
            const count = document.querySelectorAll('.asset-checkbox:checked').length;
            document.getElementById('selected-count').textContent = count;
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('#asset-list tr').forEach(row => {
                const checkbox = row.querySelector('.asset-checkbox');
                if (checkbox) checkbox.checked = event.target.checked;
            });
            updateSelectedCount();
        }

        function submitApplication() {
            const selectedAssets = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            const keeperSelect = document.getElementById('keeper-select');
            const locationSelect = document.getElementById('location-select');
            const userSelect = document.getElementById('user-select');
            const statusMsg = document.getElementById('status-message');

            const isStationTransfer = document.getElementById('station-transfer').checked;
            const isInfoTransfer = document.getElementById('info-transfer').checked;
            const isIntakeTransfer = document.getElementById('intake-transfer').checked;

            if (selectedAssets.length === 0) {
                statusMsg.className = 'alert alert-warning';
                statusMsg.textContent = '請至少勾選一筆財產！';
                window.scrollTo(0, 0); // 滾動到頂部顯示錯誤
                return;
            }

            let formData;

            if (isStationTransfer) {
                const custodianEmail = document.getElementById('custodian-select').value;
                const stationLocation = document.getElementById('station-location-select').value;

                if (!custodianEmail) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '請選擇駐管！';
                     window.scrollTo(0, 0);
                    return;
                }

                if (!stationLocation) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '請選擇駐站地點！';
                     window.scrollTo(0, 0);
                    return;
                }

                formData = {
                    assetIds: selectedAssets,
                    isStationTransfer: true,
                    custodianEmail: custodianEmail,
                    stationLocation: stationLocation
                };
            } else if (isInfoTransfer) {
                const infoCustodianEmail = window.transferData.infoCustodian
                    ? Object.keys(window.transferData.infoCustodian)[0] : null;
                const infoUserEmail = window.transferData.infoUser
                    ? Object.keys(window.transferData.infoUser)[0] : null;
                const infoLocation = window.transferData.infoLocation;
                const infoComputerLocation = window.transferData.infoComputerLocation;

                if (!infoCustodianEmail || !infoUserEmail || !infoLocation || !infoComputerLocation) {
                    statusMsg.className = 'alert alert-danger';
                    statusMsg.textContent = '資訊組轉移資料不完整！';
                     window.scrollTo(0, 0);
                    return;
                }

                formData = {
                    assetIds: selectedAssets,
                    isInfoTransfer: true,
                    infoCustodianEmail: infoCustodianEmail,
                    infoUserEmail: infoUserEmail,
                    infoLocation: infoLocation,
                    infoComputerLocation: infoComputerLocation
                };
            } else if (isIntakeTransfer) {
                const intakeCustodianEmail = window.transferData.intakeCustodian
                    ? Object.keys(window.transferData.intakeCustodian)[0] : null;
                const intakeLocation = window.transferData.intakeLocation;

                if (!intakeCustodianEmail || !intakeLocation) {
                    statusMsg.className = 'alert alert-danger';
                    statusMsg.textContent = '收案組轉移資料不完整！';
                     window.scrollTo(0, 0);
                    return;
                }

                formData = {
                    assetIds: selectedAssets,
                    isIntakeTransfer: true,
                    intakeCustodianEmail: intakeCustodianEmail,
                    intakeLocation: intakeLocation
                };
            } else {
                const changeLocation = document.getElementById('change-location').checked;
                const changeKeeper = document.getElementById('change-keeper').checked;
                const changeUser = document.getElementById('change-user').checked;

                if (!changeLocation && !changeKeeper && !changeUser) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '請至少選擇一項要變更的項目！';
                     window.scrollTo(0, 0);
                    return;
                }

                if (changeKeeper && !keeperSelect.value) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '您選擇了變更保管人，請選擇新保管人！';
                     window.scrollTo(0, 0);
                    return;
                }

                if (changeLocation && !locationSelect.value) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '您選擇了變更地點，請選擇新地點！';
                     window.scrollTo(0, 0);
                    return;
                }

                if (changeUser && !userSelect.value) {
                    statusMsg.className = 'alert alert-warning';
                    statusMsg.textContent = '您選擇了變更使用人，請選擇新使用人！';
                     window.scrollTo(0, 0);
                    return;
                }

                formData = {
                    assetIds: selectedAssets,
                    newKeeperEmail: changeKeeper ? keeperSelect.value : null,
                    newLocation: changeLocation ? locationSelect.value : null,
                    newUserEmail: changeUser ? userSelect.value : null
                };
            }

            document.getElementById('main-form').style.display = 'none';
            showFlyProgressBar('正在處理轉移申請，請稍候...');
            statusMsg.textContent = '';

            google.script.run.withSuccessHandler(showSuccessAndClose).withFailureHandler(showError).processBatchTransferApplication(formData);
        }
        function showSuccessAndClose(message) {
            const statusMsg = document.getElementById('status-message');
            hideFlyProgressBar('提交成功！', 500);

            setTimeout(() => {
                statusMsg.className = 'alert alert-success';
                statusMsg.textContent = message;

                // 3 秒後重新載入資料，讓使用者可以繼續使用
                setTimeout(() => {
                statusMsg.textContent = '';
                statusMsg.className = '';

                // 重置表單狀態
                document.getElementById('select-all').checked = false;
                document.getElementById('search-box').value = '';
                document.querySelectorAll('.special-transfer-mode').forEach(cb => cb.checked = false);
                document.getElementById('regular-transfer-options').style.display = 'block';
                document.getElementById('regular-transfer-selects').style.display = 'block';
                document.getElementById('station-transfer-selects').style.display = 'none';
                document.getElementById('change-location').checked = true;
                document.getElementById('change-keeper').checked = true;
                document.getElementById('change-user').checked = false;
                document.getElementById('user-select-group').style.display = 'none';
                document.getElementById('keeper-select').value = '';
                document.getElementById('location-select').value = '';
                document.getElementById('user-select').value = '';
                document.getElementById('custodian-select').value = '';
                document.getElementById('station-location-select').value = '';

                // 重新載入資料
                document.getElementById('main-form').style.display = 'none';
                showProgressBar('正在重新載入資料...');
                google.script.run
                    .withSuccessHandler(onDataLoaded)
                    .withFailureHandler(onDataError)
                    .getTransferData();
                }, 1000);
            }, 500);
        }
        function showError(error) {
            const statusMsg = document.getElementById('status-message');
            hideFlyProgressBar('處理失敗', 0);
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "錯誤：" + error.message;
        }
    </script>
</body>
</html>