<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 15px; font-weight: bold; }
        .asset-table-container { max-height: 400px; /* 稍微增加高度以容納更多項目 */ overflow-y: auto; margin-bottom: 15px; }

        /* ✨ 新增分頁樣式 ✨ */
        .pagination-controls { 
            margin-top: 15px; 
            user-select: none; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination-controls .page-link { 
            cursor: pointer; 
        }
        .pagination-controls .page-item.disabled .page-link {
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <div id="main-form">
        <h4>財產轉移申請 (批次)</h4>
        
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="location-filter-select">依地點篩選：</label>
                <select id="location-filter-select" class="form-control">
                    <option value="">-- 顯示全部地點 --</option>
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="category-filter-select">依財產類別篩選：</label>
                <select id="category-filter-select" class="form-control">
                    <option value="">-- 顯示全部類別 --</option>
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="search-box">依關鍵字搜尋：</label>
                <input type="text" class="form-control" id="search-box" placeholder="輸入產編或地點...">
            </div>
        </div>

        <div class="asset-table-container">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                        <th style="width: 30%;">財產編號</th>
                        <th style="width: 35%;">財產名稱</th>
                        <th style="width: 15%;">目前地點</th>
                        <th style="width: 15%;">財產類別</th>
                    </tr>
                </thead>
                <tbody id="asset-list"></tbody>
            </table>
        </div>
        
        <div id="pagination-controls" class="pagination-controls"></div>

        <p>已勾選 <span id="selected-count" class="font-weight-bold">0</span> 筆財產</p>

        <hr>

        <div class="form-group">
            <label for="keeper-select">將勾選的財產轉移給：</label>
            <select class="form-control" id="keeper-select" name="newKeeperEmail" required>
                <option value="">請選擇新保管人...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="location-select">並轉移到地點：</label>
            <select class="form-control" id="location-select" name="newLocation" required disabled>
                <option value="">請先選擇保管人...</option>
            </select>
        </div>

        <button type="button" class="btn btn-primary" onclick="submitApplication()">提交申請</button>
        <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">取消</button>
    </div>
    
    <div id="loading-spinner" style="display:none;">
        <div class="loader"></div>
        <p class="text-center">處理中，請稍候...</p>
    </div>

    <div id="status-message"></div>

    <script>
        let allAssets = [];
        let filteredAssets = [];
        // custodianDataMap 已不再需要

        let currentPage = 1;
        let rowsPerPage = 2000;

        document.addEventListener("DOMContentLoaded", () => {
            google.script.run
                .withSuccessHandler(populateForm)
                .withFailureHandler(showError)
                .getTransferData();
            
            document.getElementById('search-box').addEventListener('input', filterTable);
            document.getElementById('location-filter-select').addEventListener('change', filterTable);
            document.getElementById('category-filter-select').addEventListener('change', filterTable);
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
        });

        function populateForm(data) {
            allAssets = data.assets;
            filteredAssets = allAssets; 

            if (!allAssets || allAssets.length === 0) {
                showError({message: "您目前沒有可轉移的財產。"});
                return;
            }
            
            displayPage(currentPage);
            populateLocationFilter(allAssets);
            populateCategoryFilter(allAssets);
            
            // ✨ **核心修改：使用新的 keepers 和 locations 資料來填充下拉選單**
            const keeperSelect = document.getElementById('keeper-select');
            const locationSelect = document.getElementById('location-select');

            // 填充保管人 (顯示姓名，值為 Email)
            const sortedKeepers = Object.entries(data.keepers).map(([email, name]) => ({ email, name })).sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedKeepers.forEach(keeper => {
                const option = document.createElement('option');
                option.value = keeper.email;
                const displayName = (keeper.email === data.userEmail) ? `${keeper.name} (自己)` : keeper.name;
                option.textContent = displayName;
                keeperSelect.appendChild(option);
            });

            // 填充地點 (不再與保管人連動)
            locationSelect.innerHTML = '<option value="">請選擇地點...</option>'; // 清空並加入預設選項
            data.locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });
            locationSelect.disabled = false; // 直接啟用
        }

        // ✨ **核心修改：此函式負責顯示特定頁面的內容和分頁控制項**
        function displayPage(page) {
            currentPage = page;
            renderTableForPage(filteredAssets, rowsPerPage, currentPage);
            setupPagination(filteredAssets, rowsPerPage);
        }

        function populateLocationFilter(assets) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            const uniqueLocations = [...new Set(assets.map(asset => asset.location))].sort();
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function populateCategoryFilter(assets) {
            const categoryFilterSelect = document.getElementById('category-filter-select');
            const uniqueCategories = [...new Set(assets.map(asset => asset.category))].sort();
            uniqueCategories.forEach(cat => {
                if (cat) { // 過濾掉可能是 null 或 undefined 的值
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilterSelect.appendChild(option);
                }
            });
        }

        // ✨ **核心修改：重構 renderTable 函式，使其只渲染特定頁面的資料**
        function renderTableForPage(assets, rows, page) {
            const assetListBody = document.getElementById('asset-list');
            assetListBody.innerHTML = '';
            
            page--; // 將頁碼轉換為陣列索引 (第1頁對應索引0)
            const start = rows * page;
            const end = start + rows;
            const paginatedItems = assets.slice(start, end);

            paginatedItems.forEach(asset => {
                const row = document.createElement('tr');
                row.innerHTML = `<td><input type="checkbox" class="asset-checkbox" value="${asset.id}"></td><td>${asset.id}</td><td>${asset.assetName}</td><td>${asset.location}</td><td>${asset.category}</td>`;
                assetListBody.appendChild(row);
            });
            
            updateSelectedCount();
            document.querySelectorAll('.asset-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedCount));
        }
        
        // ✨ **新增：建立並渲染分頁控制按鈕**
        function setupPagination(items, rows) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = "";

            const pageCount = Math.ceil(items.length / rows);

            // 頁面資訊
            const pageInfo = document.createElement('div');
            pageInfo.innerHTML = `第 ${currentPage} / ${pageCount} 頁 (共 ${items.length} 筆)`;
            paginationContainer.appendChild(pageInfo);

            // 按鈕群組
            const nav = document.createElement('nav');
            const ul = document.createElement('ul');
            ul.className = 'pagination';
            
            // 上一頁按鈕
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.innerText = '上一頁';
            prevLink.onclick = () => { if (currentPage > 1) displayPage(currentPage - 1); };
            prevLi.appendChild(prevLink);
            ul.appendChild(prevLi);

            // 下一頁按鈕
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.innerText = '下一頁';
            nextLink.onclick = () => { if (currentPage < pageCount) displayPage(currentPage + 1); };
            nextLi.appendChild(nextLink);
            ul.appendChild(nextLi);

            nav.appendChild(ul);
            paginationContainer.appendChild(nav);
        }

        // ✨ **修改：篩選邏輯更新後，重新渲染第一頁和分頁控制項**
        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const categoryFilter = document.getElementById('category-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();

            filteredAssets = allAssets.filter(asset => {
                const locationMatch = (locationFilter === '') || (asset.location.toUpperCase() === locationFilter);
                const categoryMatch = (categoryFilter === '') || (asset.category && asset.category.toUpperCase() === categoryFilter);
                const searchMatch = asset.id.toUpperCase().includes(searchFilter) || 
                                    (asset.assetName && asset.assetName.toUpperCase().includes(searchFilter)) || 
                                    asset.location.toUpperCase().includes(searchFilter);
                return locationMatch && categoryMatch && searchMatch;
            });
            
            displayPage(1); // 從第一頁開始顯示篩選結果
        }
        
        // --- 以下所有輔助函式維持不變 ---
        function updateSelectedCount() {
            const count = document.querySelectorAll('.asset-checkbox:checked').length;
            document.getElementById('selected-count').textContent = count;
        }
        function toggleSelectAll(event) {
            // 注意：這裡只會全選/取消全選「當前頁面」的項目，這是預期行為
            document.querySelectorAll('#asset-list tr').forEach(row => {
                const checkbox = row.querySelector('.asset-checkbox');
                if (checkbox) checkbox.checked = event.target.checked;
            });
            updateSelectedCount();
        }

        // ✨ **移除 updateLocationOptions 函式，因為不再需要**

        function submitApplication() {
            const selectedAssets = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            const keeperSelect = document.getElementById('keeper-select');
            const locationSelect = document.getElementById('location-select');
            const statusMsg = document.getElementById('status-message');
            if (selectedAssets.length === 0 || !keeperSelect.value || !locationSelect.value) {
                statusMsg.className = 'alert alert-warning';
                statusMsg.textContent = '請至少勾選一筆財產，並選擇新的保管人與地點！';
                return;
            }
            document.getElementById('main-form').style.display = 'none';
            document.getElementById('loading-spinner').style.display = 'block';
            statusMsg.textContent = '';
            const formData = { assetIds: selectedAssets, newKeeperEmail: keeperSelect.value, newLocation: locationSelect.value };
            google.script.run.withSuccessHandler(showSuccessAndClose).withFailureHandler(showError).processBatchTransferApplication(formData);
        }
        function showSuccessAndClose(message) {
            const statusMsg = document.getElementById('status-message');
            document.getElementById('loading-spinner').style.display = 'none';
            statusMsg.className = 'alert alert-success';
            statusMsg.textContent = message;
            setTimeout(() => google.script.host.close(), 3000);
        }
        function showError(error) {
            const statusMsg = document.getElementById('status-message');
            document.getElementById('main-form').style.display = 'block';
            document.getElementById('loading-spinner').style.display = 'none';
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "錯誤：" + error.message;
        }
    </script>
</body>
</html>