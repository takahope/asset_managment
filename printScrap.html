<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 450px; overflow-y: auto; }
        .btn-print { min-width: 100px; }

        /* Tab æ¨£å¼ */
        .nav-tabs {
            margin-bottom: 0;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
        }
        .nav-tabs .nav-item {
            display: inline-block;
            margin-bottom: -1px;
            width: auto;
            height: auto;
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem 0.25rem 0 0;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            border-bottom: 3px solid #007bff;
        }

        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        .date-range-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .date-range-selector h6 {
            margin-bottom: 12px;
            color: #495057;
        }
        .date-range-selector input[type="date"] {
            font-size: 14px;
        }

        /* é è¦½å®¹å™¨æ¨£å¼ */
        #preview-container {
            margin-top: 20px;
            animation: fadeIn 0.3s ease-in;
        }
        #preview-title {
            color: #28a745;
            font-weight: 600;
        }
        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .preview-table-container table {
            margin-bottom: 0;
        }
        .preview-table-container thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }

        /* æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .date-range-selector .form-row > div {
                margin-bottom: 10px;
            }
        }

        /* Toast é€šçŸ¥æ¨£å¼ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .custom-toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .custom-toast.toast-success {
            border-left-color: #28a745;
        }

        .custom-toast.toast-error {
            border-left-color: #dc3545;
        }

        .custom-toast.toast-warning {
            border-left-color: #ffc107;
        }

        .custom-toast.toast-info {
            border-left-color: #17a2b8;
        }

        .custom-toast .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .custom-toast .toast-message {
            flex: 1;
            color: #333;
            font-size: 14px;
        }

        .custom-toast.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* é è¦½è¼‰å…¥å‹•ç•« */
        #preview-loading {
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        #preview-loading .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_runner'); ?>
    <?!= include('progress_bar_print'); ?>

    <div id="main-content">
        <h4>åˆ—å°å ±å»¢ç”³è«‹ç´€éŒ„</h4>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p id="intro-text" class="mb-0">æ­¤è™•æœƒä¾ä¿ç®¡äººåˆ—å‡ºæ‰€æœ‰ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥ç‚ºæ¯ä½ä¿ç®¡äººç”¢ç”Ÿä¸€ä»½å½™æ•´çš„å ±å»¢å ±è¡¨ã€‚</p>
            <div>
                <button id="history-btn" class="btn btn-info mr-2" onclick="showHistory()">æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
                <button id="view-toggle-btn" class="btn btn-outline-secondary" onclick="toggleView()">åˆ‡æ›ç°¡æ˜“æ¨¡å¼</button>
            </div>
        </div>

        <div class="form-group">
            <label><b>è«‹é¸æ“‡è¦åˆ—å°çš„è²¡ç”¢é¡åˆ¥ï¼š</b></label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryProperty" value="è²¡ç”¢" checked>
                    <label class="form-check-label" for="categoryProperty">è²¡ç”¢</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryNonConsumable" value="éæ¶ˆè€—å“">
                    <label class="form-check-label" for="categoryNonConsumable">éæ¶ˆè€—å“</label>
                </div>
            </div>
        </div>

        
        <div id="simple-view" style="display: none;">
            <div id="table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th>ä¿ç®¡äºº</th>
                            <th>å¾…å ±å»¢æ•¸é‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="scrap-list">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="detailed-view" style="display: none;">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-success" onclick="generateConsolidatedDoc()">ç”Ÿæˆå ±å»¢ç”³è«‹å–®</button>
            </div>
            <div id="detailed-table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th><input type="checkbox" id="select-all-detailed"></th>
                            <th>è²¡ç”¢ç·¨è™Ÿ</th>
                            <th>è²¡ç”¢åç¨±</th>
                            <th>å‹è™Ÿ/å» ç‰Œ</th>
                            <th>åŸä¿ç®¡äºº</th>
                            <th>åŸä½¿ç”¨äºº</th>
                            <th>å ±å»¢æ—¥æœŸ</th>
                            <th>å ±å»¢åŸå› </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-scrap-list">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">å·²åˆ—å°å ±å»¢æ–‡ä»¶ç´€éŒ„</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Tab å°èˆª -->
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tab-generated-docs-link" data-toggle="tab" href="#tab-generated-docs" role="tab">æŸ¥çœ‹å·²ç”Ÿæˆæ–‡ä»¶</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-generate-by-date-link" data-toggle="tab" href="#tab-generate-by-date" role="tab">åˆ—å°å·²å ±å»¢è³‡ç”¢</a>
                            </li>
                        </ul>

                        <!-- Tab å…§å®¹ -->
                        <div class="tab-content">
                            <!-- Tab 1: æŸ¥çœ‹å·²ç”Ÿæˆæ–‡ä»¶ï¼ˆç¾æœ‰åŠŸèƒ½ï¼‰ -->
                            <div class="tab-pane fade show active" id="tab-generated-docs" role="tabpanel">
                                <div class="table-responsive mt-3">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>æª”æ¡ˆåç¨±</th>
                                                <th>æœ€å¾Œä¿®æ”¹æ™‚é–“</th>
                                                <th>å¤§å°</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="history-list">
                                            <!-- File items will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tab 2: åˆ—å°å·²å ±å»¢è³‡ç”¢ï¼ˆæ–°åŠŸèƒ½ï¼‰ -->
                            <div class="tab-pane fade" id="tab-generate-by-date" role="tabpanel">
                                <div class="mt-3">
                                    <!-- æ—¥æœŸé¸æ“‡å™¨ -->
                                    <div class="date-range-selector">
                                        <h6>ğŸ“… é¸æ“‡å ±å»¢æœŸé–“</h6>
                                        <div class="form-row">
                                            <div class="col-md-5">
                                                <label for="scrap-start-date">èµ·å§‹æ—¥æœŸ</label>
                                                <input type="date" class="form-control" id="scrap-start-date" required>
                                            </div>
                                            <div class="col-md-5">
                                                <label for="scrap-end-date">çµæŸæ—¥æœŸ</label>
                                                <input type="date" class="form-control" id="scrap-end-date" required>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary btn-block" onclick="previewScrapAssetsByDate()">é è¦½</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- è¼‰å…¥ä¸­æç¤º -->
                                    <div id="preview-loading" style="display: none;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                                <span class="sr-only">è¼‰å…¥ä¸­...</span>
                                            </div>
                                            <p class="mt-3 text-muted">æ­£åœ¨æœå°‹ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢ï¼Œè«‹ç¨å€™...</p>
                                        </div>
                                    </div>

                                    <!-- é è¦½å®¹å™¨ -->
                                    <div id="preview-container" style="display: none;">
                                        <hr>
                                        <h6 id="preview-title">ğŸ“Š é è¦½ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢</h6>
                                        <div class="table-responsive preview-table-container">
                                            <table class="table table-hover table-sm">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th>è²¡ç”¢åç¨±</th>
                                                        <th>å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th>ä¿ç®¡äºº</th>
                                                        <th>å ±å»¢æ—¥æœŸ</th>
                                                        <th>å ±å»¢åŸå› </th>
                                                    </tr>
                                                </thead>
                                                <tbody id="preview-list">
                                                    <!-- Preview items will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-success btn-lg" onclick="generateScrapDocByDate()">
                                                <i class="fas fa-file-alt"></i> ç”Ÿæˆå ±å»¢ç”³è«‹å–®
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        console.log('ğŸš€ [é é¢è¼‰å…¥] printScrap.html é–‹å§‹è¼‰å…¥');
        let isDetailedView = true;
        let isAdmin = false; // âœ¨ å…¨åŸŸè®Šæ•¸è¨˜éŒ„æ¬Šé™ç‹€æ…‹

        document.addEventListener("DOMContentLoaded", () => {
            console.log('ğŸ“„ [DOMContentLoaded] DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥æ¬Šé™');
            showLoading(true); // ä¸€é–‹å§‹å°±é¡¯ç¤ºé€²åº¦æ¢ï¼Œé¿å…é é¢å…§å®¹å…ˆé–ƒç¾
            google.script.run
                .withSuccessHandler(hasPermission => {
                    isAdmin = hasPermission; // è¨˜éŒ„æ¬Šé™
                    console.log(`ğŸ‘¤ ä½¿ç”¨è€…æ¬Šé™ç‹€æ…‹: ${isAdmin ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ä½¿ç”¨è€…'}`);
                    
                    // æ ¹æ“šæ¬Šé™èª¿æ•´ UI
                    if (isAdmin) {
                        document.getElementById('intro-text').textContent = 'æ­¤è™•æœƒä¾ä¿ç®¡äººåˆ—å‡ºæ‰€æœ‰ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥ç‚ºæ¯ä½ä¿ç®¡äººç”¢ç”Ÿä¸€ä»½å½™æ•´çš„å ±å»¢å ±è¡¨ã€‚';
                    } else {
                        document.getElementById('intro-text').textContent = 'æ­¤è™•åˆ—å‡ºæ‚¨åä¸‹æ‰€æœ‰ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥å‹¾é¸é …ç›®å¾Œç”¢ç”Ÿå ±å»¢ç”³è«‹å–®ã€‚';
                        // ä¸€èˆ¬ä½¿ç”¨è€…éš±è—åˆ‡æ›è¦–åœ–æŒ‰éˆ•ï¼Œå¼·åˆ¶ä½¿ç”¨è©³ç´°æ¨¡å¼ä»¥ä¾¿å‹¾é¸
                        document.getElementById('view-toggle-btn').style.display = 'none';
                        isDetailedView = true; 
                    }

                    loadData(); // ç„¡è«–æ¬Šé™å¦‚ä½•éƒ½è¼‰å…¥è³‡æ–™ (å¾Œç«¯æœƒéæ¿¾)

                    document.querySelectorAll('input[name="assetCategory"]').forEach(radio => {
                        radio.addEventListener('change', loadData);
                    });
                    document.getElementById('select-all-detailed').addEventListener('change', toggleSelectAll);
                })
                .withFailureHandler(showError)
                .checkAdminPermissions();
        });

        function toggleView() {
            // å¦‚æœæ˜¯ä¸€èˆ¬ä½¿ç”¨è€…ï¼Œç¦æ­¢åˆ‡æ›è¦–åœ– (é›–ç„¶å¾Œç«¯æœ‰ä¿è­·ï¼Œå‰ç«¯ä¹Ÿåšä¸€å±¤)
            if (!isAdmin) return;

            isDetailedView = !isDetailedView;
            const simpleView = document.getElementById('simple-view');
            const detailedView = document.getElementById('detailed-view');
            const toggleBtn = document.getElementById('view-toggle-btn');

            if (isDetailedView) {
                simpleView.style.display = 'none';
                detailedView.style.display = 'block';
                toggleBtn.textContent = 'åˆ‡æ›ç°¡æ˜“æ¨¡å¼';
            } else {
                simpleView.style.display = 'block';
                detailedView.style.display = 'none';
                toggleBtn.textContent = 'åˆ‡æ›è©³ç´°æ¨¡å¼';
            }
            loadData();
        }

        function loadData() {
            console.log('ğŸ” [loadData] è¼‰å…¥è³‡æ–™ä¸­... æ¨¡å¼:', isDetailedView ? 'è©³ç´°' : 'ç°¡æ˜“');
            showLoading(true);
            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;

            // ä¸€èˆ¬ä½¿ç”¨è€…å¼·åˆ¶ä½¿ç”¨è©³ç´°æ¨¡å¼ API
            if (isDetailedView || !isAdmin) {
                google.script.run
                    .withSuccessHandler(renderDetailedTable)
                    .withFailureHandler(showError)
                    .getAllScrappableItems(assetCategory);
            } else {
                google.script.run
                    .withSuccessHandler(renderSimpleTable)
                    .withFailureHandler(showError)
                    .getScrappingDataForAdmin(assetCategory);
            }
        }
// ... (å…¶é¤˜å‡½å¼ä¿æŒä¸è®Š)

        function renderSimpleTable(applicants) {
            console.log('ğŸ“¦ [renderSimpleTable] æ”¶åˆ°è³‡æ–™:', applicants);
            const listBody = document.getElementById('scrap-list');
            listBody.innerHTML = '';

            try {
                // ğŸ›¡ï¸ æª¢æŸ¥ 1: è³‡æ–™æ˜¯å¦ç‚º null (åºåˆ—åŒ–å¤±æ•—å¸¸è¦‹åŸå› )
                if (applicants === null) {
                    throw new Error("æ¥æ”¶åˆ°çš„è³‡æ–™ç‚º nullã€‚è«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å›å‚³äº† Map æˆ– Set (ä¸æ”¯æ´çš„æ ¼å¼)ã€‚");
                }

                // ğŸ›¡ï¸ æª¢æŸ¥ 2: è³‡æ–™æ˜¯å¦ç‚ºé™£åˆ—
                if (!Array.isArray(applicants)) {
                    // å¦‚æœæ˜¯éŒ¯èª¤ç‰©ä»¶
                    if (applicants && applicants.error) throw new Error(applicants.error);
                    throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸç‚ºé™£åˆ—ï¼Œä½†æ”¶åˆ° " + typeof applicants);
                }

                if (applicants.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="3" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚</td></tr>';
                } else {
                    // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
                    applicants.forEach(app => {
                        const row = document.createElement('tr');

                        // ç”³è«‹äºº
                        const nameTd = document.createElement('td');
                        nameTd.textContent = app.applicant;
                        row.appendChild(nameTd);

                        // æ•¸é‡
                        const countTd = document.createElement('td');
                        countTd.textContent = app.count;
                        row.appendChild(countTd);

                        // æŒ‰éˆ•ï¼ˆä½¿ç”¨ addEventListener æ›¿ä»£ onclickï¼‰
                        const btnTd = document.createElement('td');
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary btn-sm btn-print';
                        btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                        btn.addEventListener('click', function() {
                            generateDoc(app.applicant, this);
                        });
                        btnTd.appendChild(btn);
                        row.appendChild(btnTd);

                        listBody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error("âŒ [renderSimpleTable] éŒ¯èª¤:", e);
                listBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼š${e.message}</td></tr>`;
                showError(e);
            } finally {
                showLoading(false);
            }
        }

        function renderDetailedTable(items) {
            console.log('ğŸ“¦ [renderDetailedTable] æ”¶åˆ°è³‡æ–™:', items);
            const listBody = document.getElementById('detailed-scrap-list');
            listBody.innerHTML = '';

            try {
                // ğŸ›¡ï¸ é—œéµæª¢æŸ¥ï¼šå¦‚æœå¾Œç«¯å›å‚³ Map/Setï¼Œé€™è£¡æœƒè®Šæˆ null
                if (items === null) {
                    const msg = "æ¥æ”¶åˆ°çš„è³‡æ–™ç‚º nullã€‚é€™é€šå¸¸æ˜¯å› ç‚ºå¾Œç«¯å›å‚³äº† Google Apps Script ä¸æ”¯æ´çš„æ ¼å¼ (ä¾‹å¦‚ Map æˆ– Set)ã€‚è«‹ä¿®æ”¹å¾Œç«¯å°‡å…¶è½‰æ›ç‚º Arrayã€‚";
                    console.error("âŒ " + msg);
                    throw new Error(msg);
                }

                if (items && items.error) {
                    throw new Error(items.error);
                }

                if (!Array.isArray(items)) {
                    throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸç‚ºé™£åˆ—ï¼Œä½†æ”¶åˆ° " + typeof items);
                }

                if (items.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="8" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚</td></tr>';
                } else {
                    // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
                    items.forEach(item => {
                        const row = document.createElement('tr');

                        // Checkbox å„²å­˜æ ¼
                        const checkboxTd = document.createElement('td');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'detailed-checkbox';
                        checkbox.value = item.assetId;
                        checkboxTd.appendChild(checkbox);
                        row.appendChild(checkboxTd);

                        // å…¶ä»–æ¬„ä½ä½¿ç”¨ textContent å®‰å…¨è¨­å®š
                        [item.assetId, item.assetName, item.modelBrand, item.originalKeeper, item.originalUser || '', item.scrapDate || '', item.scrapReason || ''].forEach(data => {
                            const td = document.createElement('td');
                            td.textContent = data || '';
                            row.appendChild(td);
                        });

                        // å–æ¶ˆæŒ‰éˆ•ï¼ˆä½¿ç”¨ addEventListener æ›¿ä»£ onclickï¼‰
                        const btnTd = document.createElement('td');
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'btn btn-sm btn-danger';
                        cancelBtn.textContent = 'å–æ¶ˆ';
                        cancelBtn.addEventListener('click', () => cancelScrap(item.assetId));
                        btnTd.appendChild(cancelBtn);
                        row.appendChild(btnTd);

                        listBody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error("âŒ [renderDetailedTable] éŒ¯èª¤:", e);
                listBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼š${e.message}</td></tr>`;
                showError(e);
            } finally {
                showLoading(false);
            }
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('.detailed-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }

        function generateDoc(applicantName, btn) {
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;
            showPrintProgressBar('æ­£åœ¨ç‚º ' + applicantName + ' ç”¢ç”Ÿå ±å»¢å ±è¡¨...');

            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
            google.script.run
                .withSuccessHandler(result => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
                    // å…ˆè©¢å•æ˜¯å¦æ›´æ–°ç‹€æ…‹
                    const shouldUpdate = confirm(
                        'ğŸ“„ æ–‡ä»¶ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                        'â“ æ˜¯å¦è¦åŒæ­¥æ›´æ–°å¾Œç«¯è³‡æ–™ï¼Ÿ\n\n' +
                        `âœ… ç¢ºèªï¼šå°‡ ${result.assetIds.length} ç­†è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€\n` +
                        'âš ï¸  è­¦å‘Šï¼šæ›´æ–°å¾Œå°‡ç„¡æ³•å†æ¬¡åˆ—å°æ­¤æ‰¹æ¬¡çš„å ±å»¢ç”³è«‹æ–‡ä»¶\n\n' +
                        'âŒ å–æ¶ˆï¼šåƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ›´æ–°ç‹€æ…‹'
                    );

                    // å†é–‹å•Ÿæ–‡ä»¶
                    window.open(result.fileUrl, '_blank');

                    if (shouldUpdate) {
                        updateScrapStatus(result.assetIds, applicantName, btn);
                    } else {
                        showMessage(`ğŸ“„ å·²æˆåŠŸç‚º ${applicantName} ç”¢ç”Ÿå ±è¡¨ï¼ˆç‹€æ…‹æœªæ›´æ–°ï¼‰`, 'alert-info');
                        loadData();
                        btn.disabled = false;
                        btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .withFailureHandler(error => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                })
                .createScrapDoc(applicantName, assetCategory, null);
        }

        function generateConsolidatedDoc() {
            const selectedIds = Array.from(document.querySelectorAll('.detailed-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚', 'alert-warning');
                return;
            }

            const btn = document.querySelector('.btn-success');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;
            showPrintProgressBar('æ­£åœ¨ç”¢ç”Ÿå½™ç¸½å ±å»¢å ±è¡¨...');

            google.script.run
                .withSuccessHandler(adminName => {
                    const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
                    google.script.run
                        .withSuccessHandler(result => {
                            hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
                            // å…ˆè©¢å•æ˜¯å¦æ›´æ–°ç‹€æ…‹
                            const shouldUpdate = confirm(
                                'ğŸ“„ å½™ç¸½å ±è¡¨ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                
                                `æ˜¯å¦è¦åœ¨åˆ—å°å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„ç‹€æ…‹ç‚ºã€Œå·²å ±å»¢ã€ï¼Ÿ\n\n` +
                                `âš ï¸ é‡è¦æé†’\n` +
                                'é¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                `âœ… ã€ç¢ºå®šã€‘= åˆ—å°å¾Œæ›´æ–°ç‹€æ…‹ï¼Œå°‡ ${result.assetIds.length} ç­†è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€ï¼ˆè²¡ç”¢å°‡æ¨™è¨˜ç‚ºå·²å ±å»¢ï¼Œç„¡æ³•å†æ¬¡åˆ—å°æ­¤ç”³è«‹ï¼‰\n` +
                                `âŒ ã€å–æ¶ˆã€‘= åƒ…åˆ—å°å ±è¡¨ï¼Œä¸æ›´æ–°ç‹€æ…‹ï¼ˆéœ€è‡³â€ç¸½è¡¨æ›´æ–°â€œæ›´æ–°ç‹€æ…‹ï¼‰`
                            );

                            // å†é–‹å•Ÿæ–‡ä»¶
                            window.open(result.fileUrl, '_blank');

                            if (shouldUpdate) {
                                updateScrapStatus(result.assetIds, adminName, btn);
                            } else {
                                showMessage(`ğŸ“„ å·²æˆåŠŸç”¢ç”Ÿå½™ç¸½å ±è¡¨ï¼ˆç‹€æ…‹æœªæ›´æ–°ï¼‰`, 'alert-info');
                                loadData();
                                btn.disabled = false;
                                btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                            }
                        })
                        .withFailureHandler(error => {
                            hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                            showError(error);
                            btn.disabled = false;
                            btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                        })
                        .createScrapDoc(adminName, assetCategory, selectedIds);
                })
                .withFailureHandler(error => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                })
                .getAdminName();
        }
        
        function showMessage(msg, className) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;
            setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = ''; }, 5000);
        }

        function showLoading(isLoading) {
            if (isLoading) {
                showProgressBar('æ­£åœ¨è¼‰å…¥å¾…å ±å»¢æ¸…å–®...');
            } else {
                hideProgressBar('è¼‰å…¥å®Œæˆï¼', 300);
            }
            toggleTableVisibility(!isLoading);
        }

        /**
         * æ§åˆ¶è¡¨æ ¼é¡¯ç¤º/éš±è—
         * @param {boolean} show - true é¡¯ç¤ºè¡¨æ ¼ï¼Œfalse éš±è—è¡¨æ ¼
         */
        function toggleTableVisibility(show) {
            if (show) {
                // æ ¹æ“šç•¶å‰è¦–åœ–æ¨¡å¼é¡¯ç¤ºå°æ‡‰çš„è¡¨æ ¼
                document.getElementById('simple-view').style.display = isDetailedView ? 'none' : 'block';
                document.getElementById('detailed-view').style.display = isDetailedView ? 'block' : 'none';
            } else {
                // éš±è—æ‰€æœ‰è¡¨æ ¼
                document.getElementById('simple-view').style.display = 'none';
                document.getElementById('detailed-view').style.display = 'none';
            }
        }

        function showError(error) {
            console.error("âŒ [showError]", error);
            showLoading(false);
            showMessage('éŒ¯èª¤ï¼š' + (error.message || error), 'alert-danger');
        }

        /**
         * æ›´æ–°å ±å»¢ç‹€æ…‹ï¼ˆå¾ã€Œå ±å»¢ä¸­ã€â†’ã€Œå·²å ±å»¢ã€ï¼‰
         * @param {Array<string>} assetIds - è¦æ›´æ–°çš„è³‡ç”¢IDé™£åˆ—
         * @param {string} userName - æ“ä½œè€…åç¨±
         * @param {HTMLElement} btn - æŒ‰éˆ•å…ƒç´ 
         */
        function updateScrapStatus(assetIds, userName, btn) {
            if (!assetIds || assetIds.length === 0) {
                showMessage('âŒ ç„¡æ³•æ›´æ–°ï¼šè³‡ç”¢IDåˆ—è¡¨ç‚ºç©º', 'alert-danger');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                }
                return;
            }

            // é¡¯ç¤ºæ›´æ–°ç‹€æ…‹
            if (btn) {
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­`;
            }

            google.script.run
                .withSuccessHandler(message => {
                    showMessage(`âœ… ${message}`, 'alert-success');
                    loadData();
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .withFailureHandler(error => {
                    showMessage(
                        'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                        'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†ç‹€æ…‹æœªæ›´æ–°ã€‚\n' +
                        'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚',
                        'alert-warning'
                    );
                    loadData();
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .processScrapConfirmation(assetIds);
        }

        /**
         * å–æ¶ˆå ±å»¢ç”³è«‹
         * @param {string} assetId - è³‡ç”¢ç·¨è™Ÿ
         */
        function cancelScrap(assetId) {
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmation = confirm(`æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­†å ±å»¢ç”³è«‹å—ï¼Ÿ\n\nè²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\næ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`);

            if (!confirmation) return;

            // éš±è—è¡¨æ ¼ï¼Œé˜²æ­¢é‡è¤‡æ“ä½œ
            toggleTableVisibility(false);

            // é¡¯ç¤ºé€²åº¦æ¢
            showProgressBar(`æ­£åœ¨å–æ¶ˆè²¡ç”¢ ${assetId} çš„å ±å»¢ç”³è«‹...`);

            // å‘¼å«å¾Œç«¯å–æ¶ˆå‡½æ•¸
            google.script.run
                .withSuccessHandler(response => {
                    hideProgressBar('å–æ¶ˆå®Œæˆï¼', 500);
                    if (response.success) {
                        showMessage('å ±å»¢ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚æ­£åœ¨æ›´æ–°è³‡æ–™...', 'alert-success');
                        // å»¶é² 1 ç§’å¾Œé‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆloadData æœƒè‡ªå‹•æ¢å¾©è¡¨æ ¼é¡¯ç¤ºï¼‰
                        setTimeout(() => {
                            loadData();
                        }, 1000);
                    } else {
                        showMessage('å–æ¶ˆå¤±æ•—ï¼š' + response.error, 'alert-danger');
                        // æ¢å¾©è¡¨æ ¼é¡¯ç¤º
                        toggleTableVisibility(true);
                    }
                })
                .withFailureHandler(error => {
                    hideProgressBar('æ“ä½œå¤±æ•—', 300);
                    showMessage('å–æ¶ˆå¤±æ•—ï¼š' + error.message, 'alert-danger');
                    // æ¢å¾©è¡¨æ ¼é¡¯ç¤º
                    toggleTableVisibility(true);
                })
                .cancelTransferOrScrap(assetId);
        }

        function showHistory() {
            $('#historyModal').modal('show');
            const listBody = document.getElementById('history-list');
            listBody.innerHTML = '<tr><td colspan="4" class="text-center">æ­£åœ¨è®€å–ä¸­...</td></tr>';

            google.script.run
                .withSuccessHandler(renderDriveFileList)
                .withFailureHandler(error => {
                    listBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
                })
                .getScrapDriveFiles();
        }

        function renderDriveFileList(files) {
            const listBody = document.getElementById('history-list');
            listBody.innerHTML = '';

            if (!files || files.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" class="text-center">ç„¡ç´€éŒ„</td></tr>';
                return;
            }

            files.forEach(file => {
                const row = document.createElement('tr');

                const nameTd = document.createElement('td');
                nameTd.textContent = file.name;
                row.appendChild(nameTd);

                const dateTd = document.createElement('td');
                dateTd.textContent = file.lastUpdated;
                row.appendChild(dateTd);

                const sizeTd = document.createElement('td');
                sizeTd.textContent = file.size;
                row.appendChild(sizeTd);

                const btnTd = document.createElement('td');
                const link = document.createElement('a');
                link.href = file.url;
                link.target = "_blank";
                link.className = "btn btn-sm btn-primary";
                link.textContent = "é–‹å•Ÿ";
                btnTd.appendChild(link);
                row.appendChild(btnTd);

                listBody.appendChild(row);
            });
        }

        /**
         * é¡¯ç¤º Toast é€šçŸ¥ï¼ˆæ›¿ä»£ showMessageï¼‰
         * @param {string} msg - è¨Šæ¯å…§å®¹
         * @param {string} type - é¡å‹ï¼š'success', 'error', 'warning', 'info'
         * @param {number} duration - é¡¯ç¤ºæ™‚é•·ï¼ˆæ¯«ç§’ï¼‰ï¼Œé è¨­ 3000ms
         */
        function showToast(msg, type = 'info', duration = 3000) {
            console.log(`ğŸ‰ [showToast] ${type}: ${msg}`);

            // å–å¾—æˆ–å‰µå»º Toast å®¹å™¨
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
                document.body.appendChild(container);
            }

            // åœ–ç¤ºå°æ‡‰
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            // å‰µå»º Toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${msg}</div>
            `;

            container.appendChild(toast);

            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                toast.classList.add('slide-out');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        /**
         * é è¦½æŒ‡å®šæ—¥æœŸç¯„åœçš„å·²å ±å»¢è³‡ç”¢
         */
        function previewScrapAssetsByDate() {
            console.log('ğŸ” [previewScrapAssetsByDate] é–‹å§‹é è¦½å·²å ±å»¢è³‡ç”¢');

            const startDate = document.getElementById('scrap-start-date').value;
            const endDate = document.getElementById('scrap-end-date').value;

            // é©—è­‰æ—¥æœŸè¼¸å…¥
            if (!startDate || !endDate) {
                showToast('è«‹é¸æ“‡èµ·å§‹å’ŒçµæŸæ—¥æœŸ', 'warning');  // âœ¨ æ”¹ç”¨ Toast
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ', 'warning');  // âœ¨ æ”¹ç”¨ Toast
                return;
            }

            // âœ¨ é¡¯ç¤º Spinner è¼‰å…¥å‹•ç•«
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('preview-loading').style.display = 'block';

            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
            console.log(`ğŸ“… æ—¥æœŸç¯„åœ: ${startDate} ~ ${endDate}, é¡åˆ¥: ${assetCategory}`);

            google.script.run
                .withSuccessHandler(renderPreviewTable)
                .withFailureHandler(error => {
                    console.error('âŒ [previewScrapAssetsByDate] éŒ¯èª¤:', error);
                    // âœ¨ éš±è— Spinnerï¼Œé¡¯ç¤ºéŒ¯èª¤ Toast
                    document.getElementById('preview-loading').style.display = 'none';
                    showToast('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error), 'error');
                })
                .getScrapAssetsByDateRange(startDate, endDate, assetCategory);
        }

        /**
         * æ¸²æŸ“é è¦½è¡¨æ ¼
         * @param {Array} assets - è³‡ç”¢é™£åˆ—
         */
        function renderPreviewTable(assets) {
            console.log('ğŸ“¦ [renderPreviewTable] æ”¶åˆ°è³‡æ–™:', assets);

            // âœ¨ éš±è— Spinner
            document.getElementById('preview-loading').style.display = 'none';

            const container = document.getElementById('preview-container');
            const listBody = document.getElementById('preview-list');
            const titleElement = document.getElementById('preview-title');
            listBody.innerHTML = '';

            try {
                // æª¢æŸ¥è³‡æ–™æ˜¯å¦ç‚º nullï¼ˆåºåˆ—åŒ–å•é¡Œï¼‰
                if (assets === null) {
                    throw new Error('æ¥æ”¶åˆ°çš„è³‡æ–™ç‚º nullã€‚è«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦æ­£ç¢ºè™•ç† Date ç‰©ä»¶åºåˆ—åŒ–ã€‚');
                }

                // æª¢æŸ¥è³‡æ–™æ ¼å¼
                if (!Array.isArray(assets)) {
                    if (assets && assets.error) throw new Error(assets.error);
                    throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸç‚ºé™£åˆ—ï¼Œä½†æ”¶åˆ° ' + typeof assets);
                }

                if (assets.length === 0) {
                    showToast('è©²æ—¥æœŸç¯„åœå…§æ²’æœ‰å·²å ±å»¢çš„è³‡ç”¢', 'info');  // âœ¨ æ”¹ç”¨ Toast
                    container.style.display = 'none';
                    return;
                }

                // ä½¿ç”¨ DOM API å®‰å…¨æ¸²æŸ“ï¼ˆé˜²æ­¢ XSSï¼‰
                assets.forEach(asset => {
                    const row = document.createElement('tr');

                    [
                        asset.assetId,
                        asset.assetName,
                        asset.modelBrand,
                        asset.leaderName,
                        asset.scrapDate,
                        asset.scrapReason
                    ].forEach(text => {
                        const td = document.createElement('td');
                        td.textContent = text || '';
                        row.appendChild(td);
                    });

                    listBody.appendChild(row);
                });

                // æ›´æ–°æ¨™é¡Œé¡¯ç¤ºæ•¸é‡
                titleElement.textContent = `ğŸ“Š é è¦½ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢ï¼ˆ${assets.length} ç­†ï¼‰`;
                showToast(`âœ… æ‰¾åˆ° ${assets.length} ç­†ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢`, 'success');  // âœ¨ æ”¹ç”¨ Toast
                container.style.display = 'block';

            } catch (e) {
                console.error('âŒ [renderPreviewTable] éŒ¯èª¤:', e);
                showToast('æ¸²æŸ“å¤±æ•—ï¼š' + e.message, 'error');  // âœ¨ æ”¹ç”¨ Toast
                container.style.display = 'none';
            }
        }

        /**
         * ç”Ÿæˆæ—¥æœŸç¯„åœçš„å ±å»¢ç”³è«‹å–®
         */
        function generateScrapDocByDate() {
            console.log('ğŸ“„ [generateScrapDocByDate] é–‹å§‹ç”Ÿæˆå ±å»¢ç”³è«‹å–®');

            const startDate = document.getElementById('scrap-start-date').value;
            const endDate = document.getElementById('scrap-end-date').value;
            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;

            if (!startDate || !endDate) {
                showToast('è«‹é¸æ“‡èµ·å§‹å’ŒçµæŸæ—¥æœŸ', 'warning');  // âœ¨ æ”¹ç”¨ Toast
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ç”¢ç”Ÿä¸­`;

            showPrintProgressBar('æ­£åœ¨ç”Ÿæˆå ±å»¢ç”³è«‹å–®...');

            google.script.run
                .withSuccessHandler(result => {
                    console.log('âœ… [generateScrapDocByDate] æ–‡ä»¶ç”ŸæˆæˆåŠŸ:', result);
                    hidePrintProgressBar('ç”³è«‹å–®ç”Ÿæˆå®Œæˆï¼');
                    showToast(`ğŸ“„ å ±å»¢ç”³è«‹å–®å·²æˆåŠŸç”Ÿæˆï¼ˆå…± ${result.assetCount} ç­†è³‡ç”¢ï¼‰`, 'success');  // âœ¨ æ”¹ç”¨ Toast

                    // é–‹å•Ÿæ–‡ä»¶
                    window.open(result.fileUrl, '_blank');

                    // é‡ç½®æŒ‰éˆ•
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-alt"></i> ç”Ÿæˆå ±å»¢ç”³è«‹å–®';

                    // é—œé–‰ modal
                    setTimeout(() => {
                        $('#historyModal').modal('hide');
                    }, 1500);
                })
                .withFailureHandler(error => {
                    console.error('âŒ [generateScrapDocByDate] éŒ¯èª¤:', error);
                    hidePrintProgressBar('ç”Ÿæˆå¤±æ•—');
                    showToast('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error), 'error');  // âœ¨ æ”¹ç”¨ Toast

                    // é‡ç½®æŒ‰éˆ•
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-alt"></i> ç”Ÿæˆå ±å»¢ç”³è«‹å–®';
                })
                .createScrapDocByDateRange(startDate, endDate, assetCategory);
        }
    </script>
</body>
</html>