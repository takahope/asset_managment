<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #007bff; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 450px; overflow-y: auto; }
        .btn-print { min-width: 100px; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>

    <div id="main-content">
        <h4>åˆ—å°å ±å»¢ç”³è«‹ç´€éŒ„</h4>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p>æ­¤è™•æœƒä¾ä¿ç®¡äººåˆ—å‡ºæ‰€æœ‰ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥ç‚ºæ¯ä½ä¿ç®¡äººç”¢ç”Ÿä¸€ä»½å½™æ•´çš„å ±å»¢å ±è¡¨ã€‚</p>
            <button id="view-toggle-btn" class="btn btn-outline-secondary" onclick="toggleView()">åˆ‡æ›è©³ç´°æ¨¡å¼</button>
        </div>

        <div class="form-group">
            <label><b>è«‹é¸æ“‡è¦åˆ—å°çš„è²¡ç”¢é¡åˆ¥ï¼š</b></label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryProperty" value="è²¡ç”¢" checked>
                    <label class="form-check-label" for="categoryProperty">è²¡ç”¢</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryNonConsumable" value="éæ¶ˆè€—å“">
                    <label class="form-check-label" for="categoryNonConsumable">éæ¶ˆè€—å“</label>
                </div>
            </div>
        </div>
        
        <div id="loading-spinner">
            <div class="loader"></div>
            <p class="text-center">æ­£åœ¨è¼‰å…¥å¾…å ±å»¢æ¸…å–®...</p>
        </div>
        
        <div id="simple-view">
            <div id="table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th>ä¿ç®¡äºº</th>
                            <th>å¾…å ±å»¢æ•¸é‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="scrap-list">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="detailed-view" style="display: none;">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-success" onclick="generateConsolidatedDoc()">ç”¢ç”Ÿå½™ç¸½å ±è¡¨</button>
            </div>
            <div id="detailed-table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th><input type="checkbox" id="select-all-detailed"></th>
                            <th>è²¡ç”¢ç·¨è™Ÿ</th>
                            <th>è²¡ç”¢åç¨±</th>
                            <th>åŸä¿ç®¡äºº</th>
                            <th>åŸä½¿ç”¨äºº</th>
                            <th>å ±å»¢æ—¥æœŸ</th>
                            <th>å ±å»¢åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="detailed-scrap-list">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        console.log('ğŸš€ [é é¢è¼‰å…¥] printScrap.html é–‹å§‹è¼‰å…¥');
        let isDetailedView = false;

        document.addEventListener("DOMContentLoaded", () => {
            console.log('ğŸ“„ [DOMContentLoaded] DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥æ¬Šé™');
            google.script.run
                .withSuccessHandler(hasPermission => {
                    if (hasPermission) {
                        console.log('âœ… æ¬Šé™é©—è­‰é€šé');
                        loadData(); 
                        document.querySelectorAll('input[name="assetCategory"]').forEach(radio => {
                            radio.addEventListener('change', loadData);
                        });
                        document.getElementById('select-all-detailed').addEventListener('change', toggleSelectAll);
                    } else {
                        console.warn('â›”ï¸ æ¬Šé™ä¸è¶³');
                        showError({ message: "æ¬Šé™ä¸è¶³ï¼Œåªæœ‰è³‡ç”¢ç®¡ç†å“¡æ‰èƒ½å­˜å–æ­¤é é¢ã€‚" });
                        document.getElementById('main-content').style.display = 'none';
                    }
                })
                .withFailureHandler(showError)
                .checkAdminPermissions();
        });

        function toggleView() {
            isDetailedView = !isDetailedView;
            const simpleView = document.getElementById('simple-view');
            const detailedView = document.getElementById('detailed-view');
            const toggleBtn = document.getElementById('view-toggle-btn');

            if (isDetailedView) {
                simpleView.style.display = 'none';
                detailedView.style.display = 'block';
                toggleBtn.textContent = 'åˆ‡æ›ç°¡æ˜“æ¨¡å¼';
            } else {
                simpleView.style.display = 'block';
                detailedView.style.display = 'none';
                toggleBtn.textContent = 'åˆ‡æ›è©³ç´°æ¨¡å¼';
            }
            loadData();
        }

        function loadData() {
            console.log('ğŸ” [loadData] è¼‰å…¥è³‡æ–™ä¸­... æ¨¡å¼:', isDetailedView ? 'è©³ç´°' : 'ç°¡æ˜“');
            showLoading(true);
            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;

            if (isDetailedView) {
                google.script.run
                    .withSuccessHandler(renderDetailedTable)
                    .withFailureHandler(showError)
                    .getAllScrappableItems(assetCategory);
            } else {
                google.script.run
                    .withSuccessHandler(renderSimpleTable)
                    .withFailureHandler(showError)
                    .getScrappingDataForAdmin(assetCategory);
            }
        }

        function renderSimpleTable(applicants) {
            console.log('ğŸ“¦ [renderSimpleTable] æ”¶åˆ°è³‡æ–™:', applicants);
            const listBody = document.getElementById('scrap-list');
            listBody.innerHTML = '';

            try {
                // ğŸ›¡ï¸ æª¢æŸ¥ 1: è³‡æ–™æ˜¯å¦ç‚º null (åºåˆ—åŒ–å¤±æ•—å¸¸è¦‹åŸå› )
                if (applicants === null) {
                    throw new Error("æ¥æ”¶åˆ°çš„è³‡æ–™ç‚º nullã€‚è«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å›å‚³äº† Map æˆ– Set (ä¸æ”¯æ´çš„æ ¼å¼)ã€‚");
                }

                // ğŸ›¡ï¸ æª¢æŸ¥ 2: è³‡æ–™æ˜¯å¦ç‚ºé™£åˆ—
                if (!Array.isArray(applicants)) {
                    // å¦‚æœæ˜¯éŒ¯èª¤ç‰©ä»¶
                    if (applicants && applicants.error) throw new Error(applicants.error);
                    throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸç‚ºé™£åˆ—ï¼Œä½†æ”¶åˆ° " + typeof applicants);
                }

                if (applicants.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="3" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚</td></tr>';
                } else {
                    applicants.forEach(app => {
                        const row = document.createElement('tr');
                        // å®‰å…¨è™•ç†å–®å¼•è™Ÿ
                        const safeName = (app.applicant || '').replace(/'/g, "\\'");
                        row.innerHTML = `
                            <td>${app.applicant}</td>
                            <td>${app.count}</td>
                            <td>
                                <button id="btn-${app.applicant}" class="btn btn-primary btn-sm btn-print" onclick="generateDoc('${safeName}', this)">
                                    ç”¢ç”Ÿå ±è¡¨
                                </button>
                            </td>
                        `;
                        listBody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error("âŒ [renderSimpleTable] éŒ¯èª¤:", e);
                listBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼š${e.message}</td></tr>`;
                showError(e);
            } finally {
                showLoading(false);
            }
        }

        function renderDetailedTable(items) {
            console.log('ğŸ“¦ [renderDetailedTable] æ”¶åˆ°è³‡æ–™:', items);
            const listBody = document.getElementById('detailed-scrap-list');
            listBody.innerHTML = '';

            try {
                // ğŸ›¡ï¸ é—œéµæª¢æŸ¥ï¼šå¦‚æœå¾Œç«¯å›å‚³ Map/Setï¼Œé€™è£¡æœƒè®Šæˆ null
                if (items === null) {
                    const msg = "æ¥æ”¶åˆ°çš„è³‡æ–™ç‚º nullã€‚é€™é€šå¸¸æ˜¯å› ç‚ºå¾Œç«¯å›å‚³äº† Google Apps Script ä¸æ”¯æ´çš„æ ¼å¼ (ä¾‹å¦‚ Map æˆ– Set)ã€‚è«‹ä¿®æ”¹å¾Œç«¯å°‡å…¶è½‰æ›ç‚º Arrayã€‚";
                    console.error("âŒ " + msg);
                    throw new Error(msg);
                }

                if (items && items.error) {
                    throw new Error(items.error);
                }

                if (!Array.isArray(items)) {
                    throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸç‚ºé™£åˆ—ï¼Œä½†æ”¶åˆ° " + typeof items);
                }

                if (items.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="7" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„è²¡ç”¢ã€‚</td></tr>';
                } else {
                    items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="detailed-checkbox" value="${item.assetId}"></td>
                            <td>${item.assetId}</td>
                            <td>${item.assetName}</td>
                            <td>${item.originalKeeper}</td>
                            <td>${item.originalUser || ''}</td>
                            <td>${item.scrapDate || ''}</td>
                            <td>${item.scrapReason || ''}</td>
                        `;
                        listBody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error("âŒ [renderDetailedTable] éŒ¯èª¤:", e);
                listBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼š${e.message}</td></tr>`;
                showError(e);
            } finally {
                showLoading(false);
            }
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('.detailed-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }

        function generateDoc(applicantName, btn) {
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;
            
            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
            google.script.run
                .withSuccessHandler(result => {
                    showMessage(`å·²æˆåŠŸç‚º ${applicantName} ç”¢ç”Ÿå ±è¡¨ï¼`, 'alert-success');
                    loadData();
                    window.open(result.fileUrl, '_blank');
                })
                .withFailureHandler(error => {
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                })
                .createScrapDoc(applicantName, assetCategory, null);
        }

        function generateConsolidatedDoc() {
            const selectedIds = Array.from(document.querySelectorAll('.detailed-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚', 'alert-warning');
                return;
            }

            const btn = document.querySelector('.btn-success');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;

            google.script.run
                .withSuccessHandler(adminName => {
                    const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
                    google.script.run
                        .withSuccessHandler(result => {
                            showMessage(`å·²æˆåŠŸç”¢ç”Ÿå½™ç¸½å ±è¡¨ï¼`, 'alert-success');
                            loadData();
                            window.open(result.fileUrl, '_blank');
                            btn.disabled = false;
                            btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                        })
                        .withFailureHandler(error => {
                            showError(error);
                            btn.disabled = false;
                            btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                        })
                        .createScrapDoc(adminName, assetCategory, selectedIds);
                })
                .withFailureHandler(error => {
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                })
                .getAdminName();
        }
        
        function showMessage(msg, className) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;
            setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = ''; }, 5000);
        }

        function showLoading(isLoading) {
            document.getElementById('loading-spinner').style.display = isLoading ? 'block' : 'none';
            document.getElementById('simple-view').style.display = isLoading ? 'none' : (isDetailedView ? 'none' : 'block');
            document.getElementById('detailed-view').style.display = isLoading ? 'none' : (isDetailedView ? 'block' : 'none');
        }

        function showError(error) {
            console.error("âŒ [showError]", error);
            showLoading(false);
            showMessage('éŒ¯èª¤ï¼š' + (error.message || error), 'alert-danger');
        }
    </script>
</body>
</html>