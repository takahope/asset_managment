<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Bootstrap CSS (åƒ…ç”¨æ–¼ Modal) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* é…åˆ shared-nav å´é‚Šæ¬„ */
        .duplicate-group-row {
            background-color: #fff7e6;
            font-weight: 600;
        }

        /* ç›¤é»ç®¡ç† Modal */
        .inventory-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 60;
            backdrop-filter: blur(2px);
        }

        .inventory-modal {
            background: #ffffff;
            border-radius: 16px;
            width: min(1040px, 96vw);
            max-height: 94vh;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .inventory-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
        }

        .inventory-modal-body {
            padding: 24px;
            display: grid;
            gap: 20px;
            overflow: visible;
            grid-template-columns: minmax(0, 1fr);
            flex: 1;
            min-height: 0;
        }

        @media (min-width: 1024px) {
            .inventory-modal-body {
                grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.05fr);
            }
        }

        .inventory-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .inventory-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .inventory-card--stretch {
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .inventory-card--stretch .inventory-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inventory-action-footer {
            margin-top: auto;
            padding-top: 8px;
        }

        @media (min-width: 1024px) {
            #inventory-action-area {
                min-height: 560px;
            }
        }

        .inventory-card-header {
            padding: 10px 16px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .inventory-card-header--primary {
            background: #3b82f6;
        }

        .inventory-card-header--neutral {
            background: #6b7280;
        }

        .inventory-card-body {
            padding: 16px;
        }

        .inventory-card-body--primary {
            background: #ffffff;
        }

        .inventory-card-body--neutral {
            background: #f3f4f6;
        }

        .inventory-empty-state {
            font-size: 13px;
            color: #6b7280;
            text-align: center;
            padding: 12px 0;
        }

        .inventory-start-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .inventory-option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inventory-option-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }

        .inventory-primary-button {
            background: #3b82f6;
            color: #ffffff;
            border-radius: 8px;
            padding: 8px 18px;
            font-weight: 600;
        }

        .inventory-primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inventory-modal-footer {
            padding: 12px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
        }

        .inventory-secondary-button {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            color: #475569;
            border-radius: 8px;
            padding: 6px 16px;
            font-size: 14px;
        }

        .inventory-secondary-button:hover {
            background: #f1f5f9;
        }

        .inventory-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: min(62vh, 640px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .inventory-history-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
        }

        .inventory-history-item.is-completed {
            opacity: 0.7;
        }

        .inventory-history-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .inventory-history-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inventory-history-session {
            font-weight: 700;
            color: #111827;
        }

        .inventory-history-count {
            text-align: right;
        }

        .inventory-history-right {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .inventory-history-count-number {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .inventory-history-count-label {
            font-size: 12px;
            color: #6b7280;
        }

        .inventory-history-delete {
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #64748b;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 14px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-history-delete:hover {
            background: #f8fafc;
            color: #dc2626;
            border-color: #fecaca;
        }

        .inventory-history-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inventory-history-meta {
            font-size: 13px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .inventory-history-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #0f766e;
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
        }

        .inventory-badge {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .inventory-badge--open {
            background: #f6c344;
            color: #4b3d00;
        }

        .inventory-badge--completed {
            background: #e5e7eb;
            color: #4b5563;
        }

        .inventory-badge--unknown {
            background: #e2e8f0;
            color: #475569;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>
    <?!= include('toast_progress'); ?>
    <?!= include('batch_processing_list'); ?>
    <?!= include('selectbyqr'); ?>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div id="react-root"></div>

    <!-- Bootstrap Modals (ä¿ç•™ç¾æœ‰çµæ§‹) -->
    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">é‡è¤‡ç”¢ç·¨æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th>è²¡ç”¢åç¨±</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>ä¿ç®¡äºº</th>
                                    <th>ä¿ç®¡ä½ç½®</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingApprovalModal" tabindex="-1" role="dialog" aria-labelledby="pendingApprovalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pendingApprovalTitle">å¾…æ¥æ”¶è³‡ç”¢æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row mb-2">
                        <div class="form-group col-md-5">
                            <label for="pending-location-filter">ä¾åŸä¿ç®¡åœ°é»ç¯©é¸</label>
                            <select id="pending-location-filter" class="form-control">
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-7">
                            <label for="pending-search-box">é—œéµå­—æœå°‹ (ç”¢ç·¨/ç”¢å/åŸä¿ç®¡äºº)</label>
                            <input type="text" id="pending-search-box" class="form-control" placeholder="è¼¸å…¥é—œéµå­—">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 4%;"><input type="checkbox" id="pending-select-all"></th>
                                    <th style="width: 10%;">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th style="width: 11%;">è²¡ç”¢åç¨±</th>
                                    <th style="width: 12%;">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th style="width: 14%;">ä¿ç®¡äººè®Šæ›´</th>
                                    <th style="width: 14%;">ä½¿ç”¨äººè®Šæ›´</th>
                                    <th style="width: 13%;">åœ°é»è®Šæ›´</th>
                                    <th style="width: 11%;">è½‰ç§»é¡å‹</th>
                                    <th style="width: 11%;">ç”³è«‹æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="pending-approval-list"></tbody>
                        </table>
                    </div>
                    <div id="pending-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="submitPendingRejection()">æ‹’çµ•æ‰€é¸</button>
                    <button type="button" class="btn btn-success" onclick="submitPendingApproval()">æ¥å—æ‰€é¸</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentModeModal" tabindex="-1" role="dialog" aria-labelledby="assignmentModeTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentModeTitle">é¸æ“‡åˆ†æ´¾æ–¹å¼</h5>
                    <button type="button" class="close" data-dismiss="modal" onclick="window.inventoryCancelAssignmentMode && window.inventoryCancelAssignmentMode()">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">è«‹é¸æ“‡æœ¬æ¬¡ç›¤é»çš„åˆ†æ´¾æ–¹å¼ï¼š</p>
                    <div class="custom-control custom-radio mb-2">
                        <input type="radio" id="assignment-mode-group" name="assignmentMode" class="custom-control-input" value="group" checked>
                        <label class="custom-control-label" for="assignment-mode-group">ä¾ç…§çµ„åˆ¥åˆ†æ´¾</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="assignment-mode-person" name="assignmentMode" class="custom-control-input" value="person">
                        <label class="custom-control-label" for="assignment-mode-person">ä¾ç…§äººååˆ†æ´¾</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="window.inventoryCancelAssignmentMode && window.inventoryCancelAssignmentMode()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="window.inventoryConfirmAssignmentMode && window.inventoryConfirmAssignmentMode()">é–‹å§‹ç›¤é»</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentAssetsModal" tabindex="-1" role="dialog" aria-labelledby="assignmentAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentAssetsTitle">åˆ†æ´¾æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="assignment-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th>è²¡ç”¢åç¨±</th>
                                    <th>ä½¿ç”¨äºº</th>
                                    <th>ä¿ç®¡äºº</th>
                                    <th>åœ°é»</th>
                                    <th>ç›¤é»çµæœ</th>
                                </tr>
                            </thead>
                            <tbody id="assignment-assets-body"></tbody>
                        </table>
                    </div>
                    <div id="assignment-assets-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨åŸŸå‡½æ•¸æ©‹æ¥ jQuery Modal -->
    <script>
        // å…¨åŸŸè®Šæ•¸ä¾› React èˆ‡ jQuery å…±äº«
        window.pendingApprovals = [];
        window.filteredPendingApprovals = [];
        window.pendingCurrentPage = 1;
        window.pendingRowsPerPage = 50;
        window.duplicateGroups = [];
        window.assignmentRowsPerPage = 500;
        window.assignmentModalState = {
            key: '',
            title: '',
            assets: [],
            page: 1,
            loading: false,
            error: ''
        };

        window.openPendingApprovalModal = () => {
            if (!window.pendingApprovals || window.pendingApprovals.length === 0) return;

            if (!document.getElementById('pendingApprovalModal').dataset.initialized) {
                document.getElementById('pending-location-filter').addEventListener('change', filterPendingApprovals);
                document.getElementById('pending-search-box').addEventListener('input', filterPendingApprovals);
                document.getElementById('pending-select-all').addEventListener('change', (event) => {
                    document.querySelectorAll('.pending-approval-checkbox').forEach(cb => {
                        cb.checked = event.target.checked;
                    });
                });
                document.getElementById('pendingApprovalModal').dataset.initialized = 'true';
            }

            populatePendingFilters();
            filterPendingApprovals();
            $('#pendingApprovalModal').modal('show');
        };

        window.openDuplicateAssetsModal = () => {
            if (!window.duplicateGroups || window.duplicateGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        };

        window.openInventoryAssignmentModal = (state = {}) => {
            window.assignmentModalState = {
                key: '',
                title: '',
                assets: [],
                page: 1,
                loading: false,
                error: '',
                ...state
            };
            renderAssignmentAssetsModal();
            $('#assignmentAssetsModal').modal('show');
        };

        window.updateInventoryAssignmentModal = (state = {}) => {
            window.assignmentModalState = {
                ...window.assignmentModalState,
                ...state
            };
            renderAssignmentAssetsModal();
        };

        function populatePendingFilters() {
            const locationFilter = document.getElementById('pending-location-filter');
            locationFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            const uniqueLocations = [...new Set(window.pendingApprovals.map(item => item.oldLocation))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilter.appendChild(option);
            });
        }

        function filterPendingApprovals() {
            const locationFilter = document.getElementById('pending-location-filter').value.toUpperCase();
            const searchFilter = document.getElementById('pending-search-box').value.toUpperCase();

            window.filteredPendingApprovals = window.pendingApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation && item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    (item.oldKeeper && item.oldKeeper.toUpperCase().includes(searchFilter));
                return locationMatch && searchMatch;
            });

            window.pendingCurrentPage = 1;
            renderPendingPage(window.pendingCurrentPage);
        }

        function renderPendingPage(page) {
            window.pendingCurrentPage = page;
            const listBody = document.getElementById('pending-approval-list');
            const pagination = document.getElementById('pending-pagination');
            listBody.innerHTML = '';

            if (window.filteredPendingApprovals.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚';
                row.appendChild(cell);
                listBody.appendChild(row);
                pagination.textContent = '';
                return;
            }

            const start = (page - 1) * window.pendingRowsPerPage;
            const end = start + window.pendingRowsPerPage;
            const items = window.filteredPendingApprovals.slice(start, end);

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const row = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pending-approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                const transferType = item.transferType || 'åœ°é»';
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                } else if (transferType.includes('ä¿ç®¡äºº')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                } else if (transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = 'åœ°é»';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                fragment.appendChild(row);
            });

            listBody.appendChild(fragment);
            renderPendingPagination();
            document.getElementById('pending-select-all').checked = false;
        }

        function renderPendingPagination() {
            const pagination = document.getElementById('pending-pagination');
            const totalPages = Math.ceil(window.filteredPendingApprovals.length / window.pendingRowsPerPage);

            if (window.filteredPendingApprovals.length === 0) {
                pagination.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                pagination.innerHTML = `<span class="text-muted">å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™</span>`;
                return;
            }

            const info = document.createElement('span');
            info.className = 'text-muted';
            info.textContent = `å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™ï¼Œç¬¬ ${window.pendingCurrentPage} / ${totalPages} é `;

            const nav = document.createElement('ul');
            nav.className = 'pagination mb-0';

            const prev = document.createElement('li');
            prev.className = `page-item ${window.pendingCurrentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.textContent = 'ä¸Šä¸€é ';
            prevLink.addEventListener('click', () => {
                if (window.pendingCurrentPage > 1) renderPendingPage(window.pendingCurrentPage - 1);
            });
            prev.appendChild(prevLink);

            const next = document.createElement('li');
            next.className = `page-item ${window.pendingCurrentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.textContent = 'ä¸‹ä¸€é ';
            nextLink.addEventListener('click', () => {
                if (window.pendingCurrentPage < totalPages) renderPendingPage(window.pendingCurrentPage + 1);
            });
            next.appendChild(nextLink);

            nav.appendChild(prev);
            nav.appendChild(next);

            pagination.innerHTML = '';
            pagination.appendChild(info);
            pagination.appendChild(nav);
        }

        function renderAssignmentAssetsModal() {
            const titleEl = document.getElementById('assignmentAssetsTitle');
            const metaEl = document.getElementById('assignment-assets-meta');
            const bodyEl = document.getElementById('assignment-assets-body');
            const paginationEl = document.getElementById('assignment-assets-pagination');
            const state = window.assignmentModalState || {};

            const normalizedKey = state.key || 'æœªæŒ‡æ´¾';
            const titleLabel = normalizedKey === 'æœªæŒ‡æ´¾'
                ? 'æœªæŒ‡æ´¾'
                : (String(normalizedKey).includes('@')
                    ? `${state.title || normalizedKey} (${normalizedKey})`
                    : (state.title || normalizedKey));

            if (titleEl) titleEl.textContent = `åˆ†æ´¾æ¸…å–® - ${titleLabel}`;
            if (metaEl) metaEl.textContent = state.loading
                ? 'è¼‰å…¥ä¸­...'
                : (state.error ? '' : `å…± ${(state.assets || []).length} ç­†è³‡ç”¢`);

            if (!bodyEl || !paginationEl) return;
            bodyEl.innerHTML = '';
            paginationEl.innerHTML = '';

            if (state.loading) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>è¼‰å…¥ä¸­...';
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            if (state.error) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-danger';
                cell.textContent = state.error;
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            const assets = Array.isArray(state.assets) ? state.assets : [];
            const total = assets.length;
            if (total === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢';
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            const pageCount = Math.max(1, Math.ceil(total / window.assignmentRowsPerPage));
            let page = Number(state.page || 1);
            if (page > pageCount) page = pageCount;

            const start = (page - 1) * window.assignmentRowsPerPage;
            const end = start + window.assignmentRowsPerPage;
            const pageAssets = assets.slice(start, end);
            const fragment = document.createDocumentFragment();

            pageAssets.forEach(asset => {
                const row = document.createElement('tr');
                const cells = [
                    asset.assetId,
                    asset.assetName,
                    asset.userName,
                    asset.keeperName,
                    asset.location,
                    asset.inventoryResult
                ];
                cells.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value || '';
                    row.appendChild(td);
                });
                fragment.appendChild(row);
            });

            bodyEl.appendChild(fragment);

            if (pageCount <= 1) return;

            const info = document.createElement('div');
            info.className = 'text-muted';
            info.textContent = `ç¬¬ ${page} / ${pageCount} é `;
            paginationEl.appendChild(info);

            const nav = document.createElement('div');
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-sm btn-outline-secondary mr-2';
            prevBtn.textContent = 'ä¸Šä¸€é ';
            prevBtn.disabled = page <= 1;
            prevBtn.addEventListener('click', () => {
                if (page > 1) {
                    window.assignmentModalState.page = page - 1;
                    renderAssignmentAssetsModal();
                }
            });

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-sm btn-outline-secondary';
            nextBtn.textContent = 'ä¸‹ä¸€é ';
            nextBtn.disabled = page >= pageCount;
            nextBtn.addEventListener('click', () => {
                if (page < pageCount) {
                    window.assignmentModalState.page = page + 1;
                    renderAssignmentAssetsModal();
                }
            });

            nav.appendChild(prevBtn);
            nav.appendChild(nextBtn);
            paginationEl.appendChild(nav);
        }

        function submitPendingApproval() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ¥æ”¶ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchApproval(selected);
        }

        function submitPendingRejection() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦æ‹’çµ•æ‰€é¸çš„ ${selected.length} ç­†å¾…æ¥æ”¶è³‡ç”¢å—ï¼Ÿ`)) {
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ‹’çµ•ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchRejection(selected);
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = window.duplicateGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `å…± ${totalGroups} çµ„ï¼Œ${totalRows} ç­†è³‡ç”¢`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `ç”¢ç·¨ï¼š${group.assetId || '(ç©ºç™½)'}ï¼ˆ${group.items.length} ç­†ï¼‰`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.leader,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }
    </script>

    <!-- React æ‡‰ç”¨ -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // Icons (åƒè€ƒ onepage_example.html)
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const SearchIcon = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;

        // LoadingCard çµ„ä»¶ - å¡ç‰‡è¼‰å…¥ä½”ä½ç¬¦ï¼ˆæ°´å¹³é•·æ–¹å½¢æ¨£å¼ï¼‰
        const LoadingCard = () => (
            <div className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm">
                <div className="flex items-center gap-3">
                    <div className="flex flex-col items-center gap-1">
                        <div className="w-5 h-5 bg-slate-200 rounded animate-pulse"></div>
                        <div className="w-1.5 h-6 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="h-4 bg-slate-200 rounded w-16 mb-1 animate-pulse"></div>
                        <div className="h-3 bg-slate-100 rounded w-24 animate-pulse"></div>
                    </div>
                    <div className="w-8 h-7 bg-slate-200 rounded animate-pulse"></div>
                </div>
            </div>
        );

        // DashboardCards çµ„ä»¶
        const DashboardCards = ({ counts, onClick, isLoading }) => {
            // è¼‰å…¥ç‹€æ…‹æ¸²æŸ“
            if (isLoading) {
                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3 mb-6">
                        {[1, 2, 3, 4, 5, 6].map(i => <LoadingCard key={i} />)}
                    </div>
                );
            }

            const cards = [
                {
                    id: 'transferring',
                    label: 'è½‰ç§»ä¸­',
                    count: counts.transferring,
                    color: 'bg-cyan-500',
                    icon: 'ğŸ”',
                    description: 'æˆ‘ç”³è«‹è½‰å‡ºã€ç­‰å¾…å°æ–¹æ¥æ”¶'
                },
                {
                    id: 'pending',
                    label: 'å¾…æ¥æ”¶',
                    count: counts.pending,
                    color: 'bg-blue-500',
                    icon: 'ğŸ“¥',
                    description: 'éœ€è¦æ‚¨ç¢ºèªæ¥æ”¶çš„è³‡ç”¢'
                },
                {
                    id: 'lent',
                    label: 'å‡ºå€Ÿä¸­',
                    count: counts.lent,
                    color: 'bg-green-500',
                    icon: 'ğŸ“¤',
                    description: 'ç›®å‰å‡ºå€Ÿçš„è³‡ç”¢'
                },
                {
                    id: 'scrapPending',
                    label: 'å¾…åˆ—å°å ±å»¢ç”³è«‹å–®',
                    count: counts.scrapPending,
                    color: 'bg-orange-500',
                    icon: 'ğŸ—‘ï¸',
                    description: 'å ±å»¢ä¸­çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'transferPending',
                    label: 'å¾…åˆ—å°è½‰ç§»ç”³è«‹å–®',
                    count: counts.transferPending,
                    color: 'bg-purple-500',
                    icon: 'ğŸ”„',
                    description: 'å·²è¢«æ¥æ”¶çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°è½‰ç§»ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'inventory',
                    label: 'å¾…ç›¤é»',
                    count: counts.inventory,
                    color: 'bg-red-500',
                    icon: 'ğŸ“‹',
                    description: 'éœ€è¦æ‚¨å®Œæˆçš„ç›¤é»ä»»å‹™'
                }
            ];

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3 mb-6">
                    {cards.map(card => (
                        <button
                            key={card.id}
                            onClick={() => onClick(card.id)}
                            className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-slate-300 transition-all cursor-pointer text-left group"
                        >
                            <div className="flex items-center gap-3">
                                {/* å·¦å´ï¼šåœ–æ¨™èˆ‡å½©è‰²æŒ‡ç¤ºæ¢ */}
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-xl">{card.icon}</span>
                                    <div className={`w-1.5 h-6 rounded-full ${card.color} opacity-80`}></div>
                                </div>
                                {/* ä¸­é–“ï¼šæ¨™é¡Œèˆ‡æè¿° */}
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-slate-600 group-hover:text-slate-800 transition-colors">{card.label}</p>
                                    <p className="text-xs text-slate-400 whitespace-pre-wrap" title={card.description}>{card.description}</p>
                                </div>
                                {/* å³å´ï¼šæ•¸å­— */}
                                <div className="text-2xl font-bold text-slate-800 tabular-nums">
                                    {card.count}
                                </div>
                            </div>
                        </button>
                    ))}
                </div>
            );
        };

        // InventoryDashboardCard çµ„ä»¶ - ç›¤é»é€²åº¦ç›£æ§å„€è¡¨æ¿
        const InventoryDashboardCard = ({ isAdminView, onRefresh, inventorySessions }) => {
            const [selectedSessionId, setSelectedSessionId] = useState('');
            const [groupStats, setGroupStats] = useState([]);
            const [isLoadingStats, setIsLoadingStats] = useState(false);
            const [statsError, setStatsError] = useState('');
            const [isExpanded, setIsExpanded] = useState(true);
            const sessionDetailsCacheRef = useRef(new Map());

            const sessions = inventorySessions?.activeSessions || [];
            const isLoadingSessions = !inventorySessions;
            const isLoadingDashboard = isLoadingSessions || (sessions.length > 0 && !selectedSessionId);

            const getSessionSortKey = useCallback((session) => {
                const idValue = String(session?.inventoryId || '');
                const idNumber = Number(idValue.replace(/^INV/i, ''));
                if (!Number.isNaN(idNumber) && idNumber > 0) {
                    return idNumber;
                }
                const parsed = Date.parse(session?.inventoryDate || '');
                return Number.isNaN(parsed) ? 0 : parsed;
            }, []);

            const pickLatestSessionId = useCallback((sessionList) => {
                if (!sessionList || sessionList.length === 0) return '';
                const sorted = sessionList.slice().sort((a, b) => getSessionSortKey(b) - getSessionSortKey(a));
                return sorted[0]?.inventoryId || '';
            }, [getSessionSortKey]);

            useEffect(() => {
                if (sessions.length === 0) {
                    setSelectedSessionId('');
                    setGroupStats([]);
                    return;
                }
                const exists = sessions.some(s => s.inventoryId === selectedSessionId);
                if (!exists) {
                    setSelectedSessionId(pickLatestSessionId(sessions));
                }
            }, [sessions, selectedSessionId, pickLatestSessionId]);

            const fetchGroupStats = useCallback((sessionId) => {
                if (!sessionId) {
                    setGroupStats([]);
                    setStatsError('');
                    setIsLoadingStats(false);
                    return;
                }
                setIsLoadingStats(true);
                setStatsError('');
                google.script.run
                    .withSuccessHandler(result => {
                        setGroupStats(result || []);
                        setIsLoadingStats(false);
                    })
                    .withFailureHandler(error => {
                        console.error('è¼‰å…¥ç›¤é»åˆ†çµ„çµ±è¨ˆå¤±æ•—:', error);
                        setGroupStats([]);
                        setStatsError(error.message || 'è¼‰å…¥å¤±æ•—');
                        setIsLoadingStats(false);
                    })
                    .getInventoryStatsByAssignee(sessionId);
            }, []);

            useEffect(() => {
                fetchGroupStats(selectedSessionId);
            }, [selectedSessionId, fetchGroupStats]);

            const normalizeAssignmentKey = useCallback((value) => {
                const raw = String(value || '').trim();
                if (!raw) return '';
                return raw.includes('@') ? raw.toLowerCase() : raw;
            }, []);

            const resolveAssignmentKey = useCallback((value) => {
                const normalized = normalizeAssignmentKey(value);
                return normalized || 'æœªæŒ‡æ´¾';
            }, [normalizeAssignmentKey]);

            const openAssignmentDetails = useCallback((stat) => {
                if (!selectedSessionId) {
                    alert('å°šæœªé¸æ“‡ç›¤é»æœƒè©±');
                    return;
                }

                const assignmentKey = resolveAssignmentKey(stat?.email || stat?.name || stat?.displayName);
                const displayName = stat?.displayName || stat?.name || stat?.email || assignmentKey;

                if (typeof window.openInventoryAssignmentModal === 'function') {
                    window.openInventoryAssignmentModal({
                        key: assignmentKey,
                        title: displayName,
                        assets: [],
                        page: 1,
                        loading: true,
                        error: ''
                    });
                }

                const renderAssets = (details) => {
                    const list = Array.isArray(details) ? details : [];
                    const assets = list.filter(asset => resolveAssignmentKey(asset.assignedUser) === assignmentKey);
                    if (typeof window.updateInventoryAssignmentModal === 'function') {
                        window.updateInventoryAssignmentModal({
                            key: assignmentKey,
                            title: displayName,
                            assets: assets,
                            page: 1,
                            loading: false,
                            error: ''
                        });
                    }
                };

                const cached = sessionDetailsCacheRef.current.get(selectedSessionId);
                if (cached) {
                    renderAssets(cached);
                    return;
                }

                google.script.run
                    .withSuccessHandler(details => {
                        const safeDetails = Array.isArray(details) ? details : [];
                        sessionDetailsCacheRef.current.set(selectedSessionId, safeDetails);
                        renderAssets(safeDetails);
                    })
                    .withFailureHandler(error => {
                        const message = error?.message || 'è¼‰å…¥å¤±æ•—';
                        if (typeof window.updateInventoryAssignmentModal === 'function') {
                            window.updateInventoryAssignmentModal({
                                key: assignmentKey,
                                title: displayName,
                                assets: [],
                                page: 1,
                                loading: false,
                                error: message
                            });
                        } else {
                            alert(`è¼‰å…¥è©³ç´°æ¸…å–®å¤±æ•—ï¼š${message}`);
                        }
                    })
                    .getInventoryDetails(selectedSessionId);
            }, [resolveAssignmentKey, selectedSessionId]);

            // å¦‚æœæ²’æœ‰é€²è¡Œä¸­çš„æœƒè©±ï¼Œä¸é¡¯ç¤ºå¡ç‰‡
            if (!isLoadingSessions && sessions.length === 0) {
                return null;
            }

            const selectedSession = sessions.find(s => s.inventoryId === selectedSessionId);
            const totalCount = Number(selectedSession?.totalCount || 0);
            const verifiedCount = Number(selectedSession?.verifiedCount || 0);
            const progressPercent = totalCount > 0 ? Math.round((verifiedCount / totalCount) * 100) : 0;
            
            // è™•ç†å®Œæˆç›¤é»
            const handleCompleteSession = () => {
                if (!isAdminView) {
                    alert('åƒ…ç®¡ç†å“¡å¯åŸ·è¡Œæ­¤æ“ä½œ');
                    return;
                }

                if (!selectedSessionId) {
                    alert('å°šæœªé¸æ“‡ç›¤é»æœƒè©±');
                    return;
                }

                if (totalCount === 0) {
                    alert('æ­¤ç›¤é»æœƒè©±æ²’æœ‰å¯è™•ç†çš„è³‡ç”¢');
                    return;
                }
                
                if (verifiedCount < totalCount) {
                    alert(`å°šæœ‰ ${totalCount - verifiedCount} ç­†æœªç›¤é»ï¼Œç„¡æ³•å®Œæˆæœƒè©±ã€‚`);
                    return;
                }
                
                if (!confirm(`ç¢ºå®šè¦å®Œæˆç›¤é»æœƒè©±ã€Œ${selectedSessionId}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡çµæŸæ­¤æœƒè©±ï¼Œç„¡æ³•å†ä¿®æ”¹ç›¤é»çµæœã€‚`)) {
                    return;
                }
                
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            alert(`ç›¤é»æœƒè©±å·²å®Œæˆï¼\n\nçµ±è¨ˆï¼š\næ­£å¸¸ï¼š${result.stats.normal}\néºå¤±ï¼š${result.stats.missing}\næå£ï¼š${result.stats.damaged}`);
                            onRefresh && onRefresh();
                        } else {
                            alert(result.message || 'æ“ä½œå¤±æ•—');
                        }
                    })
                    .withFailureHandler(error => {
                        alert('å®Œæˆç›¤é»å¤±æ•—ï¼š' + error.message);
                    })
                    .completeInventorySession(selectedSessionId);
            };
            
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    {/* å¡ç‰‡æ¨™é¡Œï¼ˆå¯æŠ˜ç–Šï¼‰ */}
                    <div 
                        className="px-4 py-3 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors"
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <div className="flex items-center gap-2">
                            <i className="fa-solid fa-chart-line text-teal-500"></i>
                            <h3 className="text-base font-semibold text-slate-800">ç›¤é»é€²åº¦ç›£æ§å„€è¡¨æ¿</h3>
                            {!isExpanded && selectedSession && (
                                <span className="text-xs text-slate-500 ml-2">
                                    ({selectedSession.inventoryDate} - {progressPercent}%)
                                </span>
                            )}
                        </div>
                        <i className={`fa-solid fa-chevron-${isExpanded ? 'up' : 'down'} text-slate-400 transition-transform`}></i>
                    </div>
                    
                    {/* å¡ç‰‡å…§å®¹ */}
                    {isExpanded && (
                        <div className="p-4">
                            {isLoadingDashboard ? (
                                <div className="text-center py-8">
                                    <i className="fa-solid fa-spinner fa-spin text-2xl text-teal-500"></i>
                                    <p className="text-sm text-slate-500 mt-2">è¼‰å…¥ä¸­...</p>
                                </div>
                            ) : (
                                <>
                                    {/* æœƒè©±é¸æ“‡ä¸‹æ‹‰é¸å–® */}
                                    {sessions.length > 1 && (
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-slate-700 mb-2">é¸æ“‡ç›¤é»æœƒè©±</label>
                                            <select 
                                                value={selectedSessionId}
                                                onChange={(e) => setSelectedSessionId(e.target.value)}
                                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                            >
                                                {sessions.map(session => (
                                                    <option key={session.inventoryId} value={session.inventoryId}>
                                                        {session.inventoryDate} - {session.inventoryPerson}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* ç¸½é«”é€²åº¦ */}
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div className="text-center p-3 bg-slate-50 rounded-lg">
                                            <div className="text-3xl font-bold text-teal-600">{progressPercent}%</div>
                                            <div className="text-xs text-slate-500 mt-1">ç¸½é«”å®Œæˆç‡</div>
                                        </div>
                                        <div className="text-center p-3 bg-slate-50 rounded-lg">
                                            <div className="text-3xl font-bold text-slate-700">{verifiedCount}/{totalCount}</div>
                                            <div className="text-xs text-slate-500 mt-1">å·²ç›¤é»/ç¸½æ•¸</div>
                                        </div>
                                    </div>
                                    
                                    {/* é€²åº¦æ¢ */}
                                    <div className="mb-4">
                                        <div className="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                                            <div 
                                                className="bg-gradient-to-r from-teal-500 to-teal-600 h-full transition-all duration-300"
                                                style={{ width: `${progressPercent}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    
                                    {/* åˆ†çµ„çµ±è¨ˆè¡¨ */}
                                    {isLoadingStats ? (
                                        <div className="text-center text-sm text-slate-500 py-4">è¼‰å…¥åˆ†çµ„çµ±è¨ˆä¸­...</div>
                                    ) : statsError ? (
                                        <div className="text-center text-sm text-rose-600 py-4">åˆ†çµ„çµ±è¨ˆè¼‰å…¥å¤±æ•—ï¼š{statsError}</div>
                                    ) : groupStats.length > 0 ? (
                                        <div className="overflow-hidden rounded-lg border border-slate-200 mb-4">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">åˆ†é…å°è±¡</th>
                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">é€²åº¦</th>
                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">æ•¸é‡</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {groupStats.map((stat, idx) => {
                                                        const assignedCount = Number(stat.assignedCount || 0);
                                                        const verifiedCountValue = Number(stat.verifiedCount || 0);
                                                        const percent = assignedCount > 0
                                                            ? Math.round((verifiedCountValue / assignedCount) * 100)
                                                            : 0;
                                                        let colorClass = 'bg-red-500';
                                                        if (percent >= 50) colorClass = 'bg-yellow-500';
                                                        if (percent >= 100) colorClass = 'bg-green-500';
                                                        const label = stat.displayName || stat.name || stat.email || 'æœªæŒ‡æ´¾';
                                                        const isUnassigned = label === 'æœªæŒ‡æ´¾';
                                                        
                                                        return (
                                                            <tr
                                                                key={idx}
                                                                className="hover:bg-slate-50 cursor-pointer"
                                                                onClick={() => openAssignmentDetails(stat)}
                                                                title="æŸ¥çœ‹è©³ç´°æ¸…å–®"
                                                            >
                                                                <td className="px-3 py-2">
                                                                    {isUnassigned ? (
                                                                        <span className="inline-flex items-center gap-2 text-red-600 font-medium">
                                                                            <span>âš ï¸ æœªæŒ‡æ´¾</span>
                                                                            <span className="text-xs text-teal-600 font-normal">æŸ¥çœ‹</span>
                                                                        </span>
                                                                    ) : (
                                                                        <span className="inline-flex items-center gap-2">
                                                                            <span>{label}</span>
                                                                            <span className="text-xs text-teal-600">æŸ¥çœ‹</span>
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="flex-1 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                                            <div 
                                                                                className={`${colorClass} h-full transition-all`}
                                                                                style={{ width: `${percent}%` }}
                                                                            ></div>
                                                                        </div>
                                                                        <span className="text-xs text-slate-600 w-10 text-right">{percent}%</span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-3 py-2 text-right text-slate-600">
                                                                    {verifiedCountValue} / {assignedCount}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="text-center text-sm text-slate-500 py-4">å°šç„¡åˆ†çµ„çµ±è¨ˆè³‡æ–™</div>
                                    )}
                                    
                                    {/* ç®¡ç†å“¡æŒ‰éˆ• */}
                                    {isAdminView && (
                                        <div className="mt-4 flex justify-end gap-2">
                                            <button
                                                onClick={() => {
                                                    fetchGroupStats(selectedSessionId);
                                                    onRefresh && onRefresh();
                                                }}
                                                className="px-4 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors"
                                            >
                                                <i className="fa-solid fa-rotate mr-2"></i>
                                                é‡æ–°è¼‰å…¥
                                            </button>
                                            <button
                                                onClick={handleCompleteSession}
                                                disabled={!selectedSessionId || totalCount === 0 || verifiedCount < totalCount}
                                                className="px-4 py-2 text-sm bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            >
                                                <i className="fa-solid fa-check mr-2"></i>
                                                å®Œæˆç›¤é»
                                            </button>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const InventoryManagementModal = ({ onClose, isAdminView }) => {
            const [historyItems, setHistoryItems] = useState([]);
            const [isHistoryLoading, setIsHistoryLoading] = useState(true);
            const [historyError, setHistoryError] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [filterValue, setFilterValue] = useState('');
            const [filterOptions, setFilterOptions] = useState({ locations: [], keepers: [], users: [], groups: [] });
            const [optionsError, setOptionsError] = useState('');
            const [isOptionsLoading, setIsOptionsLoading] = useState(true);
            const [isStarting, setIsStarting] = useState(false);
            const [startError, setStartError] = useState('');
            const [startMessage, setStartMessage] = useState('');
            const [deleteMessage, setDeleteMessage] = useState('');
            const [deleteError, setDeleteError] = useState('');
            const [deletingSessionId, setDeletingSessionId] = useState('');
            const [groupDropdownOpen, setGroupDropdownOpen] = useState(false);
            const pendingStartOptionsRef = useRef(null);
            const groupDropdownRef = useRef(null);

            const runScript = useCallback((fnName, ...args) => new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)[fnName](...args);
            }), []);

            const loadModalData = useCallback((options = {}) => {
                const { keepDeleteMessage = false } = options;
                setIsHistoryLoading(true);
                setHistoryError('');
                setOptionsError('');
                setStartError('');
                setStartMessage('');
                setIsOptionsLoading(true);
                if (!keepDeleteMessage) {
                    setDeleteMessage('');
                    setDeleteError('');
                }

                const historyPromise = runScript('getInventoryHistory', true);
                const optionsPromise = runScript('getInventoryData');

                Promise.allSettled([historyPromise, optionsPromise]).then(results => {
                    const [historyResult, optionsResult] = results;

                    if (historyResult.status === 'fulfilled') {
                        const history = historyResult.value;
                        if (history === null) {
                            setHistoryError('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                            setHistoryItems([]);
                        } else {
                            setHistoryItems(Array.isArray(history) ? history : []);
                        }
                    } else {
                        const message = historyResult.reason?.message || String(historyResult.reason || 'è¼‰å…¥å¤±æ•—');
                        setHistoryError(`è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—ï¼š${message}`);
                        setHistoryItems([]);
                    }

                    let optionsErrorMessage = '';
                    if (optionsResult.status === 'fulfilled' && optionsResult.value) {
                        setFilterOptions({
                            locations: optionsResult.value.locations || [],
                            keepers: optionsResult.value.keepers || [],
                            users: optionsResult.value.users || [],
                            groups: optionsResult.value.groups || []
                        });
                    } else {
                        const message = optionsResult.reason?.message || String(optionsResult.reason || 'è¼‰å…¥å¤±æ•—');
                        optionsErrorMessage = `ç›¤é»ç¯„åœè¼‰å…¥å¤±æ•—ï¼š${message}`;
                        setFilterOptions({ locations: [], keepers: [], users: [], groups: [] });
                    }

                    setOptionsError(optionsErrorMessage);
                    setIsOptionsLoading(false);
                    setIsHistoryLoading(false);
                });
            }, [runScript]);

            useEffect(() => {
                loadModalData();
            }, [loadModalData]);

            useEffect(() => {
                setFilterValue(filterType === 'group' ? [] : '');
                if (filterType !== 'group') {
                    setGroupDropdownOpen(false);
                }
            }, [filterType]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (groupDropdownRef.current && !groupDropdownRef.current.contains(event.target)) {
                        setGroupDropdownOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const hideAssignmentModal = useCallback(() => {
                if (window.$ && typeof window.$.fn?.modal === 'function') {
                    window.$('#assignmentModeModal').modal('hide');
                }
            }, []);

            const handleOverlayClick = (event) => {
                if (event.target === event.currentTarget) {
                    hideAssignmentModal();
                    onClose();
                }
            };

            const submitStartSession = useCallback((options) => {
                setIsStarting(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setIsStarting(false);
                        if (result && result.success) {
                            loadModalData();
                            setStartMessage(result.message || 'ç›¤é»æœƒè©±å·²æˆåŠŸå»ºç«‹ã€‚');
                        } else {
                            setStartError(result?.error || 'é–‹å§‹ç›¤é»å¤±æ•—');
                        }
                    })
                    .withFailureHandler(error => {
                        setIsStarting(false);
                        setStartError(error.message || 'é–‹å§‹ç›¤é»å¤±æ•—');
                    })
                    .startInventorySession(options);
            }, [loadModalData]);

            const handleAssignmentModeConfirm = useCallback(() => {
                const selectedMode = document.querySelector('input[name="assignmentMode"]:checked');
                const assignmentMode = selectedMode ? selectedMode.value : 'person';
                const options = pendingStartOptionsRef.current;
                pendingStartOptionsRef.current = null;
                hideAssignmentModal();
                if (!options) return;
                submitStartSession({
                    ...options,
                    assignmentMode: assignmentMode
                });
            }, [hideAssignmentModal, submitStartSession]);

            const handleAssignmentModeCancel = useCallback(() => {
                pendingStartOptionsRef.current = null;
                hideAssignmentModal();
            }, [hideAssignmentModal]);

            useEffect(() => {
                window.inventoryConfirmAssignmentMode = handleAssignmentModeConfirm;
                window.inventoryCancelAssignmentMode = handleAssignmentModeCancel;
                return () => {
                    delete window.inventoryConfirmAssignmentMode;
                    delete window.inventoryCancelAssignmentMode;
                    hideAssignmentModal();
                };
            }, [handleAssignmentModeConfirm, handleAssignmentModeCancel]);

            const handleStartSession = () => {
                setStartError('');
                setStartMessage('');

                let selectedValue = '';
                if (filterType === 'location') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('è«‹é¸æ“‡åœ°é»');
                        return;
                    }
                } else if (filterType === 'keeper') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('è«‹é¸æ“‡ä¿ç®¡äºº');
                        return;
                    }
                } else if (filterType === 'user') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('è«‹é¸æ“‡ä½¿ç”¨äºº');
                        return;
                    }
                } else if (filterType === 'group') {
                    if (selectedGroups.length === 0) {
                        setStartError('è«‹é¸æ“‡çµ„åˆ¥');
                        return;
                    }
                    selectedValue = selectedGroups;
                }

                const options = {
                    filterType: filterType,
                    filterValue: selectedValue,
                    assetIds: []
                };

                if (isAdminView) {
                    pendingStartOptionsRef.current = options;
                    if (window.$ && typeof window.$.fn?.modal === 'function') {
                        window.$('#assignmentModeModal').modal('show');
                    } else {
                        submitStartSession({ ...options, assignmentMode: 'person' });
                    }
                    return;
                }
                submitStartSession({ ...options, assignmentMode: 'person' });
            };

            const selectedGroups = Array.isArray(filterValue) ? filterValue : [];
            const availableGroups = filterOptions.groups || [];
            const isGroupOptionsLoading = isOptionsLoading && availableGroups.length === 0;
            const toggleGroupOption = (group) => {
                setFilterValue(prev => {
                    const current = Array.isArray(prev) ? prev : [];
                    if (current.includes(group)) {
                        return current.filter(item => item !== group);
                    }
                    return [...current, group];
                });
            };
            const removeGroupOption = (group) => {
                setFilterValue(prev => {
                    const current = Array.isArray(prev) ? prev : [];
                    return current.filter(item => item !== group);
                });
            };
            const selectAllGroups = () => {
                setFilterValue(availableGroups.slice());
            };
            const clearGroups = () => {
                setFilterValue([]);
            };

            const startDisabled = isStarting;

            const handleDeleteSession = (sessionId) => {
                if (!sessionId) return;
                const shouldDelete = confirm(`ç¢ºå®šè¦åˆªé™¤ç›¤é»æœƒè©±ã€Œ${sessionId}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒåˆªé™¤ç›¤é»ç´€éŒ„èˆ‡æ˜ç´°ï¼Œç„¡æ³•å¾©åŸã€‚`);
                if (!shouldDelete) return;

                setDeleteMessage('');
                setDeleteError('');
                setDeletingSessionId(sessionId);

                google.script.run
                    .withSuccessHandler(result => {
                        setDeletingSessionId('');
                        if (result && result.success) {
                            setDeleteMessage(result.message || 'ç›¤é»æœƒè©±å·²åˆªé™¤ã€‚');
                            loadModalData({ keepDeleteMessage: true });
                        } else {
                            setDeleteError(result?.error || 'åˆªé™¤å¤±æ•—');
                        }
                    })
                    .withFailureHandler(error => {
                        setDeletingSessionId('');
                        setDeleteError(error.message || 'åˆªé™¤å¤±æ•—');
                    })
                    .deleteInventorySession(sessionId);
            };

            const renderHistoryContent = () => {
                if (isHistoryLoading) {
                    return (
                        <div className="inventory-empty-state">
                            <i className="fa-solid fa-spinner fa-spin mr-2 text-slate-400"></i>
                            è¼‰å…¥æ­·å²è¨˜éŒ„ä¸­...
                        </div>
                    );
                }

                if (historyError) {
                    return (
                        <div className="inventory-empty-state text-rose-600">{historyError}</div>
                    );
                }

                if (!historyItems || historyItems.length === 0) {
                    return (
                        <div className="inventory-empty-state">å°šç„¡æ­·å²è¨˜éŒ„</div>
                    );
                }

                return historyItems.map((record, index) => {
                    const statusValue = record.status || '';
                    const statusCode = record.statusCode || '';
                    const isCompleted = statusValue === 'å·²å®Œæˆ' || statusCode === 'COMPLETED';
                    const isOpen = statusValue === 'é€²è¡Œä¸­' || statusCode === 'OPEN';
                    const badgeClass = isCompleted
                        ? 'inventory-badge inventory-badge--completed'
                        : isOpen
                            ? 'inventory-badge inventory-badge--open'
                            : 'inventory-badge inventory-badge--unknown';
                    const badgeLabel = statusValue || (isCompleted ? 'å·²å®Œæˆ' : isOpen ? 'é€²è¡Œä¸­' : 'æœªå®šç¾©');
                    const progressDisplay = record.progressDisplay ||
                        `${Number(record.verifiedCount || 0)} / ${Number(record.totalCount || 0)}`;
                    const timestamp = record.timestamp || record.inventoryDate || 'æœªæä¾›';
                    const summary = record.summary || record.filter || 'æœªæŒ‡å®š';
                    const sessionId = record.sessionId || record.inventoryId || `session-${index}`;
                    const personName = record.inventoryPerson || '';
                    const personEmail = record.inventoryEmail || '';
                    const personLabel = personEmail
                        ? `${personName || personEmail.split('@')[0]} (${personEmail})`
                        : (personName || 'æœªæŒ‡å®š');
                    const itemClass = `inventory-history-item${isCompleted ? ' is-completed' : ''}`;
                    const isDeleting = deletingSessionId === sessionId;

                    return (
                        <div key={sessionId} className={itemClass}>
                            <div className="inventory-history-head">
                                <div className="inventory-history-title">
                                    <span className="inventory-history-session">{sessionId}</span>
                                    <span className={badgeClass}>{badgeLabel}</span>
                                </div>
                                <div className="inventory-history-right">
                                    <div className="inventory-history-count">
                                        <div className="inventory-history-count-number">{progressDisplay}</div>
                                        <div className="inventory-history-count-label">å·²ç›¤é»/ç¸½è¨ˆ</div>
                                    </div>
                                    <button
                                        type="button"
                                        className="inventory-history-delete"
                                        onClick={() => handleDeleteSession(sessionId)}
                                        disabled={isDeleting}
                                        title="åˆªé™¤ç›¤é»æœƒè©±"
                                    >
                                        {isDeleting ? (
                                            <i className="fa-solid fa-spinner fa-spin"></i>
                                        ) : (
                                            <i className="fa-regular fa-trash-can"></i>
                                        )}
                                    </button>
                                </div>
                            </div>
                            <div className="inventory-history-meta">
                                <span>ç¯„åœ: {summary}</span>
                                <span>é–‹å§‹æ™‚é–“: {timestamp}</span>
                            </div>
                            <div className="inventory-history-footer">
                                <i className="fa-regular fa-user"></i>
                                ç›¤é»äººï¼š{personLabel}
                            </div>
                        </div>
                    );
                });
            };

            return (
                <div
                    id="modal-inventory"
                    className="inventory-modal-overlay"
                    role="dialog"
                    aria-modal="true"
                    onClick={handleOverlayClick}
                >
                    <div className="inventory-modal" onClick={(event) => event.stopPropagation()}>
                        <div className="inventory-modal-header">
                            <h3 className="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                <i className="fa-solid fa-clipboard-list text-blue-500"></i>
                                ç›¤é»ç®¡ç† (Inventory Management)
                            </h3>
                            <button
                                type="button"
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                onClick={onClose}
                                aria-label="é—œé–‰"
                            >
                                <i className="fa-solid fa-xmark text-xl"></i>
                            </button>
                        </div>
                        <div className="inventory-modal-body">
                            <div className="inventory-column">
                                <section className="inventory-card inventory-card--stretch" id="inventory-action-area">
                                    <div className="inventory-card-header inventory-card-header--primary">
                                        <i className="fa-solid fa-circle-plus"></i>
                                        é–‹å§‹æ–°çš„ç›¤é»
                                    </div>
                                    <div className="inventory-card-body inventory-card-body--primary">
                                        <>
                                        <div className="text-sm font-semibold text-slate-700 mb-3">é¸æ“‡ç›¤é»ç¯„åœï¼š</div>
                                        <div className="inventory-option-group">
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="all"
                                                    checked={filterType === 'all'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                ç›¤é»æ‰€æœ‰è³‡ç”¢ï¼ˆåœ¨åº«ç‹€æ…‹ï¼‰
                                            </label>
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="location"
                                                    checked={filterType === 'location'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                ä¾åœ°é»ç¯©é¸
                                            </label>
                                            {filterType === 'location' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">è«‹é¸æ“‡åœ°é»</option>
                                                    {filterOptions.locations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="keeper"
                                                    checked={filterType === 'keeper'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                ä¾ä¿ç®¡äººç¯©é¸
                                            </label>
                                            {filterType === 'keeper' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">è«‹é¸æ“‡ä¿ç®¡äºº</option>
                                                    {filterOptions.keepers.map(keeper => (
                                                        <option key={keeper} value={keeper}>{keeper}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="user"
                                                    checked={filterType === 'user'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                ä¾ä½¿ç”¨äººç¯©é¸
                                            </label>
                                            {filterType === 'user' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">è«‹é¸æ“‡ä½¿ç”¨äºº</option>
                                                    {filterOptions.users.map(user => (
                                                        <option key={user} value={user}>{user}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="group"
                                                    checked={filterType === 'group'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                ä¾çµ„åˆ¥ç¯©é¸
                                            </label>
                                            {filterType === 'group' && (
                                                <div className="space-y-2">
                                                    <div className="text-sm text-slate-600">
                                                        é¸æ“‡çµ„åˆ¥ï¼ˆå·²é¸ {selectedGroups.length} é …ï¼‰
                                                    </div>
                                                    <div className="relative" ref={groupDropdownRef}>
                                                        <button
                                                            type="button"
                                                            onClick={() => setGroupDropdownOpen(prev => !prev)}
                                                            className={`w-full px-3 py-2 border rounded-lg text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm ${
                                                                groupDropdownOpen
                                                                    ? 'border-blue-400 ring-2 ring-blue-100'
                                                                    : 'border-slate-200 hover:border-slate-300'
                                                            }`}
                                                        >
                                                            <span className={selectedGroups.length === 0 ? 'text-slate-400' : 'text-slate-700'}>
                                                                {isGroupOptionsLoading
                                                                    ? 'è¼‰å…¥çµ„åˆ¥ä¸­...'
                                                                    : (selectedGroups.length === 0 ? 'è«‹é¸æ“‡çµ„åˆ¥...' : `å·²é¸æ“‡ ${selectedGroups.length} å€‹çµ„åˆ¥`)}
                                                            </span>
                                                            {isGroupOptionsLoading ? (
                                                                <i className="fa-solid fa-spinner fa-spin text-slate-400"></i>
                                                            ) : (
                                                                <i
                                                                    className={`fa-solid fa-chevron-down text-slate-400 transition-transform ${
                                                                        groupDropdownOpen ? 'rotate-180' : ''
                                                                    }`}
                                                                ></i>
                                                            )}
                                                        </button>

                                                        {groupDropdownOpen && (
                                                            <div className="absolute z-50 mt-2 w-full rounded-lg border border-slate-200 bg-white shadow-xl">
                                                                <div className="p-2 border-b border-slate-100 bg-slate-50">
                                                                    <div className="flex justify-between px-1 text-xs">
                                                                        <button
                                                                            type="button"
                                                                            onClick={selectAllGroups}
                                                                            className="text-blue-600 hover:text-blue-800 font-medium"
                                                                        >
                                                                            å…¨é¸
                                                                        </button>
                                                                        <button
                                                                            type="button"
                                                                            onClick={clearGroups}
                                                                            className="text-slate-500 hover:text-slate-700"
                                                                        >
                                                                            æ¸…é™¤æ‰€æœ‰
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div className="max-h-72 overflow-y-auto p-1">
                                                                    {isGroupOptionsLoading ? (
                                                                        <div className="py-6 text-center text-sm text-slate-500">
                                                                            <i className="fa-solid fa-spinner fa-spin mr-2"></i>
                                                                            çµ„åˆ¥è¼‰å…¥ä¸­...
                                                                        </div>
                                                                    ) : availableGroups.length > 0 ? (
                                                                        availableGroups.map(group => (
                                                                            <label
                                                                                key={group}
                                                                                className="flex items-center gap-2 px-3 py-2.5 rounded-md cursor-pointer hover:bg-slate-50 text-sm text-slate-700"
                                                                            >
                                                                                <input
                                                                                    type="checkbox"
                                                                                    className="h-4 w-4 border-slate-300 rounded text-blue-600 focus:ring-blue-500"
                                                                                    checked={selectedGroups.includes(group)}
                                                                                    onChange={() => toggleGroupOption(group)}
                                                                                />
                                                                                <span className="flex-1">{group}</span>
                                                                                {selectedGroups.includes(group) && (
                                                                                    <i className="fa-solid fa-check text-blue-600 text-xs"></i>
                                                                                )}
                                                                            </label>
                                                                        ))
                                                                    ) : (
                                                                        <div className="py-4 text-center text-sm text-slate-500">æ‰¾ä¸åˆ°ç¬¦åˆçš„çµ„åˆ¥</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {selectedGroups.length > 0 && (
                                                        <div className="flex flex-wrap gap-2">
                                                            {selectedGroups.map(group => (
                                                                <span
                                                                    key={group}
                                                                    className="inline-flex items-center gap-1 rounded-full border border-blue-200 bg-blue-50 px-2.5 py-1 text-xs text-blue-700"
                                                                >
                                                                    {group}
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => removeGroupOption(group)}
                                                                        className="inline-flex h-4 w-4 items-center justify-center rounded-full text-blue-600 hover:bg-blue-200"
                                                                        aria-label={`ç§»é™¤ ${group}`}
                                                                    >
                                                                        <i className="fa-solid fa-xmark text-[10px]"></i>
                                                                    </button>
                                                                </span>
                                                            ))}
                                                            <button
                                                                type="button"
                                                                onClick={clearGroups}
                                                                className="text-xs text-slate-500 hover:text-rose-600 underline"
                                                            >
                                                                æ¸…é™¤
                                                            </button>
                                                        </div>
                                                    )}
                                                    <div className="text-xs text-slate-500">
                                                        æç¤ºï¼šé»æ“Šä¸‹æ‹‰é¸å–®å‹¾é¸ï¼Œæ¨™ç±¤å¯å¿«é€Ÿç§»é™¤ã€‚
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="inventory-action-footer">
                                            <button
                                                id="btn-start-continue"
                                                type="button"
                                                onClick={handleStartSession}
                                                disabled={startDisabled}
                                                className="inventory-primary-button"
                                            >
                                                {isStarting ? 'å•Ÿå‹•ä¸­...' : 'é–‹å§‹ç›¤é»'}
                                            </button>
                                        </div>
                                        {startMessage && (
                                            <div className="text-sm text-emerald-600 mt-3">{startMessage}</div>
                                        )}
                                        {optionsError && (
                                            <div className="text-sm text-rose-600 mt-2">{optionsError}</div>
                                        )}
                                        {startError && (
                                            <div className="text-sm text-rose-600 mt-2">{startError}</div>
                                        )}
                                        </>
                                    </div>
                                </section>
                            </div>

                            <div className="inventory-column">
                                <section className="inventory-card" id="history-list-container">
                                    <div className="inventory-card-header inventory-card-header--neutral">
                                        <i className="fa-solid fa-clock-rotate-left"></i>
                                        ç›¤é»æ­·å²è¨˜éŒ„
                                    </div>
                                    <div className="inventory-card-body inventory-card-body--neutral">
                                        {deleteMessage && (
                                            <div className="inventory-empty-state text-emerald-600">{deleteMessage}</div>
                                        )}
                                        {deleteError && (
                                            <div className="inventory-empty-state text-rose-600">{deleteError}</div>
                                        )}
                                        <div id="history-list" className="inventory-history-list">
                                            {renderHistoryContent()}
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div className="inventory-modal-footer">
                            <button
                                type="button"
                                className="inventory-secondary-button"
                                onClick={() => {
                                    hideAssignmentModal();
                                    onClose();
                                }}
                            >
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // FilterSection çµ„ä»¶
        const FilterSection = ({ filters, onFilterChange, isAdmin, allAssets }) => {
            // âœ¨ Debounce æ©Ÿåˆ¶ï¼šæœ¬åœ°æœå°‹ç‹€æ…‹ï¼ˆå³æ™‚æ›´æ–°è¼¸å…¥æ¡†ï¼‰
            const [localSearch, setLocalSearch] = useState(filters.search);
            const debounceTimerRef = useRef(null);

            // âœ¨ ç•¶å¤–éƒ¨ filters.search è®ŠåŒ–æ™‚åŒæ­¥åˆ°æœ¬åœ°ï¼ˆä¾‹å¦‚ Scanner æ¸…ç©ºæœå°‹æ¡†ï¼‰
            useEffect(() => {
                setLocalSearch(filters.search);
            }, [filters.search]);

            // âœ¨ Debounce æœå°‹è™•ç†å‡½æ•¸
            const handleSearchChange = useCallback((value) => {
                setLocalSearch(value);  // ç«‹å³æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º

                // æ¸…é™¤å‰ä¸€å€‹ timer
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }

                // 180ms å¾Œæ‰è§¸ç™¼å¯¦éš›ç¯©é¸
                debounceTimerRef.current = setTimeout(() => {
                    onFilterChange('search', value);
                }, 180);
            }, [onFilterChange]);

            // âœ¨ æ¸…ç† timer
            useEffect(() => {
                return () => {
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                    }
                };
            }, []);

            // âœ¨ æš´éœ²æ¸…ç©ºæœå°‹æ¡†å‡½æ•¸ä¾› Scanner æ¨¡çµ„ä½¿ç”¨
            useEffect(() => {
                window.clearSearchBox = () => {
                    // âœ¨ é—œéµï¼šæ¸…é™¤ debounce timerï¼Œé˜²æ­¢å»¶é²ç¯©é¸è¦†è“‹æ¸…ç©ºæ“ä½œ
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                        debounceTimerRef.current = null;
                    }
                    setLocalSearch('');
                    onFilterChange('search', '');
                };
                return () => {
                    delete window.clearSearchBox;
                };
            }, [onFilterChange]);

            const statusOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.status))].filter(Boolean).sort()
            , [allAssets]);

            const categoryOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.category))].filter(Boolean).sort()
            , [allAssets]);

            const leaderOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.leader))].filter(Boolean).sort()
            , [allAssets]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ç‹€æ…‹ç¯©é¸</label>
                            <select
                                value={filters.status}
                                onChange={(e) => onFilterChange('status', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {statusOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸</label>
                            <select
                                value={filters.category}
                                onChange={(e) => onFilterChange('category', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {categoryOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        {isAdmin && (
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ä¿ç®¡äººç¯©é¸</label>
                                <select
                                    value={filters.leader}
                                    onChange={(e) => onFilterChange('leader', e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                    {leaderOptions.map(opt => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">é—œéµå­—æœå°‹</label>
                            <div className="relative flex">
                                <div className="relative flex-1">
                                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                    <input
                                        id="search-box"
                                        type="text"
                                        value={localSearch}
                                        onChange={(e) => handleSearchChange(e.target.value)}
                                        placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€ä¿ç®¡äºº... (å¯æƒææ¢ç¢¼æŒ‰ Enter)"
                                        className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <button
                                    type="button"
                                    onClick={() => window.Scanner_toggle && window.Scanner_toggle()}
                                    className="px-3 py-2 bg-slate-100 border border-l-0 border-slate-200 rounded-r-lg hover:bg-slate-200 transition-colors"
                                    title="é–‹å•Ÿæ¢ç¢¼æƒæå™¨"
                                >
                                    <i className="fa-solid fa-barcode text-slate-600"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // AlertBanner çµ„ä»¶
        const AlertBanner = ({ count, onClick }) => (
            <div
                className="bg-yellow-50 border-l-4 border-yellow-400 py-2 px-4 mb-6 cursor-pointer hover:bg-yellow-100 transition-colors"
                onClick={onClick}
            >
                <div className="flex items-center">
                    <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span className="text-yellow-800">
                        åµæ¸¬åˆ° {count} ç­†é‡è¤‡ç”¢ç·¨ã€‚
                        <span className="text-blue-600 ml-2 underline">é»æ“ŠæŸ¥çœ‹è©³æƒ…</span>
                    </span>
                </div>
            </div>
        );

        // BatchActionButtons çµ„ä»¶ - æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•å¡ç‰‡
        const BatchActionButtons = ({ onBatchTransfer, onBatchLending, onBatchScrap, hasPendingInventory, onBatchInventory }) => {
            const [batchCount, setBatchCount] = useState(0);

            useEffect(() => {
                // ç›£è½ BatchList è®ŠåŒ–
                const updateCount = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        setBatchCount(window.BatchList_getItems().length);
                    }
                };

                // åˆå§‹æ›´æ–°
                updateCount();

                // å®šæœŸæ›´æ–°ï¼ˆæ¯ 500msï¼‰
                const interval = setInterval(updateCount, 500);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className="text-sm text-slate-600">
                                <i className="fa-solid fa-cart-shopping text-blue-500 mr-2"></i>
                                å·²é¸å– <span className="font-bold text-blue-600">{batchCount}</span> é …è³‡ç”¢
                            </div>
                            {batchCount > 0 && (
                                <button
                                    onClick={() => window.BatchList_toggleSidebar && window.BatchList_toggleSidebar()}
                                    className="text-xs text-blue-500 hover:text-blue-700 underline"
                                >
                                    æŸ¥çœ‹æ¸…å–®
                                </button>
                            )}
                        </div>
                        <div className="flex gap-2 flex-wrap">
                            <button
                                onClick={onBatchTransfer}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-right-left"></i> æ‰¹æ¬¡è½‰ç§»
                            </button>
                            <button
                                onClick={onBatchLending}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-hand-holding-hand"></i> æ‰¹æ¬¡å‡ºå€Ÿ
                            </button>
                            <button
                                onClick={onBatchScrap}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-regular fa-trash-can"></i> æ‰¹æ¬¡å ±å»¢
                            </button>
                            {/* æ‰¹æ¬¡ç›¤é»æŒ‰éˆ• - å¦‚æœæœ‰å¾…ç›¤é»è³‡ç”¢å‰‡é¡¯ç¤º */}
                            {hasPendingInventory && (
                                <button
                                    onClick={onBatchInventory}
                                    disabled={batchCount === 0}
                                    className="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                                >
                                    <i className="fa-solid fa-clipboard-check"></i> æ‰¹æ¬¡ç›¤é»
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // AssetTable çµ„ä»¶
        const AssetTable = ({ assets, isAdmin, currentUserEmail, isInventoryTaskOnly, onCancel, onRestore, onOpenTransferModal, onOpenLendingModal, onOpenScrapModal, onOpenEditModal, isAssetPendingInventory, onOpenInventoryModal, selectedAssetIds = [], onAssetSelect, onSelectAll }) => {
            const statusColors = {
                'åœ¨åº«': 'bg-green-50 text-green-700 border-green-200',
                'å‡ºå€Ÿä¸­': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                'å ±å»¢ä¸­': 'bg-red-50 text-red-700 border-red-200',
                'å·²å ±å»¢': 'bg-gray-50 text-gray-700 border-gray-200',
                'è½‰ç§»ä¸­': 'bg-blue-50 text-blue-700 border-blue-200',
                'å¾…æ¥æ”¶': 'bg-purple-50 text-purple-700 border-purple-200'
            };

            // âœ¨ åˆ†é è¨­å®š
            const ROWS_PER_PAGE = 500;
            const [currentPage, setCurrentPage] = useState(1);

            // âœ¨ ç•¶ assets è®ŠåŒ–æ™‚ï¼ˆç¯©é¸æ¢ä»¶æ”¹è®Šï¼‰ï¼Œé‡ç½®é ç¢¼
            useEffect(() => {
                setCurrentPage(1);
            }, [assets]);

            // âœ¨ è¨ˆç®—åˆ†é è³‡æ–™
            const totalPages = useMemo(() => {
                return Math.max(1, Math.ceil((assets?.length || 0) / ROWS_PER_PAGE));
            }, [assets]);

            const paginatedAssets = useMemo(() => {
                if (!assets) return [];
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                return assets.slice(start, end);
            }, [assets, currentPage]);

            // è¨ˆç®—å¯é¸è³‡ç”¢ï¼ˆåƒ…åœ¨åº«ï¼‰
            const selectableAssets = useMemo(() => {
                return assets ? assets.filter(a => a.status === 'åœ¨åº«') : [];
            }, [assets]);

            // è¨ˆç®—å…¨é¸ç‹€æ…‹
            const isAllSelected = selectableAssets.length > 0 &&
                selectableAssets.every(a => selectedAssetIds.includes(a.assetId));
            const isPartialSelected = selectableAssets.some(a => selectedAssetIds.includes(a.assetId)) && !isAllSelected;

            if (!assets || assets.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                        <p className="text-slate-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    {/* âœ¨ åˆ†é æ§åˆ¶å™¨ - ä½æ–¼è¡¨æ ¼ä¸Šæ–¹ */}
                    <div className="flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <span className="text-sm text-slate-600">
                            ç¬¬ <span className="font-semibold text-blue-600">{currentPage}</span> / {totalPages} é ï¼ˆå…± <span className="font-semibold text-blue-600">{assets.length}</span> ç­†ï¼‰
                        </span>
                        {totalPages > 1 && (
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                    disabled={currentPage <= 1}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage <= 1
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    ä¸Šä¸€é 
                                </button>
                                <button
                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                    disabled={currentPage >= totalPages}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage >= totalPages
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    ä¸‹ä¸€é 
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm" id="asset-list">
                            <thead className="bg-slate-50 border-b border-slate-200 sticky top-0">
                                <tr>
                                    {/* å‹¾é¸æ¬„ä½ - å…¨é¸ checkbox */}
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-center w-10">
                                        <input
                                            type="checkbox"
                                            checked={isAllSelected}
                                            ref={(el) => { if (el) el.indeterminate = isPartialSelected; }}
                                            onChange={(e) => onSelectAll && onSelectAll(e.target.checked)}
                                            className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                            title={`å…¨é¸æ‰€æœ‰ã€Œåœ¨åº«ã€è³‡ç”¢ (${selectableAssets.length} ç­†)`}
                                        />
                                    </th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[160px] max-w-[160px]">è²¡ç”¢åç¨±</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[180px] max-w-[180px]">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ä½¿ç”¨è€…</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ä¿ç®¡äºº</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 min-w-[100px]">ä¿ç®¡ä½ç½®</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢é¡åˆ¥</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ç‹€æ…‹</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-left whitespace-nowrap min-w-[160px]">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {paginatedAssets.map((asset, index) => {
                                    const isTask = typeof isInventoryTaskOnly === 'function'
                                        ? isInventoryTaskOnly(asset)
                                        : false;
                                    const normalizedCurrentEmail = String(currentUserEmail || '').toLowerCase();
                                    const isOwner = normalizedCurrentEmail &&
                                        (normalizedCurrentEmail === String(asset.leaderEmail || '').toLowerCase() ||
                                            normalizedCurrentEmail === String(asset.userEmail || '').toLowerCase());
                                    const canCancel = !isTask && (isAdmin || isOwner);
                                    const isSelectable = asset.status === 'åœ¨åº«';
                                    const isSelected = selectedAssetIds.includes(asset.assetId);
                                    const rowHoverClass = isTask ? 'hover:bg-teal-100' : 'hover:bg-slate-50';
                                    const rowBaseClass = isTask ? 'bg-teal-50' : '';
                                    const rowSelectedClass = isSelected ? 'ring-1 ring-blue-200 ring-inset' : '';

                                    return (
                                        <tr key={`${asset.assetId}-${index}`} className={`${rowHoverClass} transition-colors ${rowBaseClass} ${rowSelectedClass} ${!isTask && isSelected ? 'bg-blue-50' : ''}`}>
                                            {/* å‹¾é¸æ¬„ä½ */}
                                            <td className="px-2 py-3 text-center align-top">
                                                {isSelectable ? (
                                                    <input
                                                        type="checkbox"
                                                        className="asset-checkbox w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                        value={asset.assetId}
                                                        checked={isSelected}
                                                        onChange={() => onAssetSelect && onAssetSelect(asset.assetId)}
                                                        data-is-task={isTask ? 'true' : 'false'}
                                                    />
                                                ) : (
                                                    <span className="text-slate-300" title="åƒ…ã€Œåœ¨åº«ã€è³‡ç”¢å¯é¸å–">-</span>
                                                )}
                                            </td>
                                            <td className="px-2 py-3 font-mono text-slate-600 whitespace-nowrap align-top">{asset.assetId}</td>
                                            <td className="px-2 py-3 font-medium text-slate-800 align-top w-[160px] max-w-[160px]">
                                                <div className="flex items-start gap-2">
                                                    <div className="line-clamp-2 min-w-0 flex-1" title={asset.assetName}>{asset.assetName}</div>
                                                    {isTask && (
                                                        <span className="inline-flex items-center rounded-full bg-teal-100 text-teal-700 text-xs font-semibold px-2 py-0.5 whitespace-nowrap">
                                                            ç›¤é»ä»»å‹™
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top w-[180px] max-w-[180px]">
                                                <div className="line-clamp-2 text-xs break-all" title={asset.modelBrand}>{asset.modelBrand || '-'}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.userName}</td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.leader}</td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <div className="line-clamp-2" title={asset.location}>{asset.location}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <span className="bg-slate-100 px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    {asset.category}
                                                </span>
                                            </td>
                                            <td className="px-2 py-3 align-top">
                                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap ${statusColors[asset.status] || 'bg-slate-100 text-slate-700 border-slate-200'}`}>
                                                    {asset.status}
                                                </span>
                                            </td>
                                            <td className="px-2 py-3 text-left align-top whitespace-nowrap">
                                                {/* æ“ä½œæŒ‰éˆ•å€åŸŸ */}
                                                <div className="flex justify-start gap-2">
                                                    {/* ä¿®æ”¹æŒ‰éˆ• - åƒ…ç®¡ç†å“¡å¯è¦‹ */}
                                                    {isAdmin && (
                                                        <button
                                                            onClick={() => onOpenEditModal(asset)}
                                                            className="text-amber-600 hover:text-amber-800 transition-colors p-1"
                                                            title="ä¿®æ”¹åŸºæœ¬è³‡æ–™"
                                                        >
                                                            <i className="fa-solid fa-pen-to-square text-lg"></i>
                                                        </button>
                                                    )}
                                                    {/* åœ¨åº«è³‡ç”¢ï¼šé¡¯ç¤ºè½‰ç§»ã€å‡ºå€Ÿã€å ±å»¢æŒ‰éˆ• */}
                                                    {!isTask && asset.status === 'åœ¨åº«' && (
                                                        <>
                                                            <button
                                                                onClick={() => onOpenTransferModal(asset)}
                                                                className="text-blue-600 hover:text-blue-800 transition-colors p-1"
                                                                title="è½‰ç§»"
                                                            >
                                                                <i className="fa-solid fa-right-left text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenLendingModal(asset)}
                                                                className="text-purple-600 hover:text-purple-800 transition-colors p-1"
                                                                title="å‡ºå€Ÿ"
                                                            >
                                                                <i className="fa-solid fa-hand-holding-hand text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenScrapModal(asset)}
                                                                className="text-red-600 hover:text-red-800 transition-colors p-1"
                                                                title="å ±å»¢"
                                                            >
                                                                <i className="fa-regular fa-trash-can text-lg"></i>
                                                            </button>
                                                            {/* ç›¤é»æŒ‰éˆ• - å¦‚æœè³‡ç”¢åœ¨å¾…ç›¤é»æ¸…å–®ä¸­é¡¯ç¤º */}
                                                            {isAssetPendingInventory && isAssetPendingInventory(asset.assetId) && (
                                                                <button
                                                                    onClick={() => onOpenInventoryModal(asset)}
                                                                    className="text-teal-600 hover:text-teal-800 transition-colors p-1"
                                                                    title="ç›¤é»ç¢ºèª"
                                                                >
                                                                    <i className="fa-solid fa-clipboard-check text-lg"></i>
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                    {isTask && (
                                                        <>
                                                            {isAssetPendingInventory && isAssetPendingInventory(asset.assetId) && (
                                                                <button
                                                                    onClick={() => onOpenInventoryModal(asset)}
                                                                    className="text-teal-600 hover:text-teal-800 transition-colors p-1"
                                                                    title="ç›¤é»ç¢ºèª"
                                                                >
                                                                    <i className="fa-solid fa-clipboard-check text-lg"></i>
                                                                </button>
                                                            )}
                                                            <span className="text-slate-400 p-1" title="åƒ…é™ç›¤é»">
                                                                <i className="fa-solid fa-lock text-lg"></i>
                                                            </span>
                                                        </>
                                                    )}

                                                    {/* å¾…æ¥æ”¶/è½‰ç§»ä¸­/å ±å»¢ä¸­ï¼šé¡¯ç¤ºå–æ¶ˆæŒ‰éˆ• */}
                                                    {canCancel && (asset.status === 'å¾…æ¥æ”¶' || asset.status === 'è½‰ç§»ä¸­' || asset.status === 'å ±å»¢ä¸­') && (
                                                        <button
                                                            onClick={() => onCancel(asset.assetId, asset.status)}
                                                            className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                                                        >
                                                            å–æ¶ˆ
                                                        </button>
                                                    )}

                                                    {/* å·²å ±å»¢ï¼šç®¡ç†å“¡å¯å›æº¯ */}
                                                    {isAdmin && asset.status === 'å·²å ±å»¢' && (
                                                        <button
                                                            onClick={() => onRestore(asset.assetId)}
                                                            className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm font-medium"
                                                        >
                                                            å›æº¯
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // TransferringModal - è½‰ç§»ä¸­è³‡ç”¢ Modalï¼ˆç”¨æ–¼å–æ¶ˆè½‰ç§»ï¼‰
        const TransferringModal = ({ assets, isLoading, onClose, onCancelSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                newKeeper: '',
                search: ''
            });

            // ç•¶ assets æ”¹è®Šæ™‚ï¼Œé‡ç½®å‹¾é¸ç‹€æ…‹
            useEffect(() => {
                setSelectedAssetIds([]);
                setSelectAll(false);
            }, [assets]);

            // ç¯©é¸é‚è¼¯
            const filteredAssets = useMemo(() => {
                if (!assets) return [];

                return assets.filter(asset => {
                    // æ–°ä¿ç®¡äººç¯©é¸
                    const matchNewKeeper = !filters.newKeeper || asset.newKeeper === filters.newKeeper;

                    // é—œéµå­—æœå°‹
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.assetName && asset.assetName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.newKeeper && asset.newKeeper.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.newLocation && asset.newLocation.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchNewKeeper && matchSearch;
                });
            }, [assets, filters]);

            // å–å¾—å”¯ä¸€æ–°ä¿ç®¡äººåˆ—è¡¨ï¼ˆç”¨æ–¼ç¯©é¸ä¸‹æ‹‰é¸å–®ï¼‰
            const uniqueNewKeepers = useMemo(() => {
                if (!assets) return [];
                return [...new Set(assets.map(a => a.newKeeper).filter(Boolean))].sort();
            }, [assets]);

            // è™•ç†å…¨é¸
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedAssetIds(filteredAssets.map(asset => asset.assetId));
                } else {
                    setSelectedAssetIds([]);
                }
            }, [filteredAssets]);

            // è™•ç†å–®å€‹å‹¾é¸
            const handleCheckboxChange = useCallback((assetId) => {
                setSelectedAssetIds(prev => {
                    if (prev.includes(assetId)) {
                        const newSelected = prev.filter(id => id !== assetId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, assetId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // è™•ç†å–æ¶ˆè½‰ç§»æäº¤
            const handleCancelTransfer = useCallback(() => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è¦å–æ¶ˆçš„é …ç›®ã€‚');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦å–æ¶ˆæ‰€é¸çš„ ${selectedAssetIds.length} ç­†è½‰ç§»ç”³è«‹å—ï¼Ÿ\n\nâš ï¸ å–æ¶ˆå¾Œè³‡ç”¢ç‹€æ…‹å°‡æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('æ­£åœ¨è™•ç†å–æ¶ˆä½œæ¥­...');

                let successCount = 0;
                let failCount = 0;
                let errorMessages = [];

                // ä¾åºè™•ç†æ¯å€‹å–æ¶ˆè«‹æ±‚
                const processNext = (index) => {
                    if (index >= selectedAssetIds.length) {
                        hideToastProgress('å–æ¶ˆå®Œæˆï¼', 300);
                        setIsSubmitting(false);

                        let message = `å–æ¶ˆå®Œæˆï¼\næˆåŠŸï¼š${successCount} ç­†`;
                        if (failCount > 0) {
                            message += `\nå¤±æ•—ï¼š${failCount} ç­†`;
                            if (errorMessages.length > 0) {
                                message += `\n\nå¤±æ•—åŸå› ï¼š\n${errorMessages.slice(0, 3).join('\n')}`;
                                if (errorMessages.length > 3) {
                                    message += `\n...åŠå…¶ä»– ${errorMessages.length - 3} é …`;
                                }
                            }
                        }
                        alert(message);

                        if (successCount > 0) {
                            onCancelSuccess();
                        }
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            if (result.success) {
                                successCount++;
                            } else {
                                failCount++;
                                errorMessages.push(`${selectedAssetIds[index]}: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                            }
                            processNext(index + 1);
                        })
                        .withFailureHandler(error => {
                            failCount++;
                            errorMessages.push(`${selectedAssetIds[index]}: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                            processNext(index + 1);
                        })
                        .cancelTransferOrScrap(selectedAssetIds[index]);
                };

                processNext(0);
            }, [selectedAssetIds, onCancelSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* æ¨™é¡Œåˆ— - é’è‰²ä¸»é¡Œ */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-cyan-50">
                            <h3 className="text-lg font-bold text-cyan-800">
                                <i className="fas fa-exchange-alt mr-2"></i>
                                è½‰ç§»ä¸­è³‡ç”¢ - è¿½è¹¤èˆ‡å–æ¶ˆ
                            </h3>
                            <button
                                onClick={onClose}
                                className="text-cyan-600 hover:text-cyan-800 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // è¼‰å…¥ä¸­ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-cyan-500"></i>
                                    <p className="text-slate-500 font-medium">è¼‰å…¥è½‰ç§»ä¸­è³‡æ–™...</p>
                                </div>
                            ) : !assets || assets.length === 0 ? (
                                // ç„¡è³‡æ–™ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">ç›®å‰æ²’æœ‰è½‰ç§»ä¸­çš„è³‡ç”¢ã€‚</p>
                                    <p className="text-slate-400 text-sm">æ‚¨ç”³è«‹çš„æ‰€æœ‰è½‰ç§»éƒ½å·²å®Œæˆæˆ–å·²è¢«å–æ¶ˆã€‚</p>
                                </div>
                            ) : (
                                <>
                                    {/* èªªæ˜å€å¡Š */}
                                    <div className="mb-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                                        <p className="text-sm text-cyan-800">
                                            <i className="fas fa-info-circle mr-2"></i>
                                            ä»¥ä¸‹æ˜¯æ‚¨ç”³è«‹ä½†å°šæœªè¢«å°æ–¹æ¥æ”¶çš„è½‰ç§»è³‡ç”¢ã€‚æ‚¨å¯ä»¥é¸æ“‡å–æ¶ˆè½‰ç§»ï¼Œè³‡ç”¢ç‹€æ…‹å°‡æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚
                                        </p>
                                    </div>

                                    {/* ç¯©é¸æ§åˆ¶å€ */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {/* æ–°ä¿ç®¡äººç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">æ–°ä¿ç®¡äºº</label>
                                                <select
                                                    value={filters.newKeeper}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, newKeeper: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                                    {uniqueNewKeepers.map(keeper => (
                                                        <option key={keeper} value={keeper}>{keeper}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* é—œéµå­—æœå°‹ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é—œéµå­—æœå°‹</label>
                                                <input
                                                    type="text"
                                                    value={filters.search}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                    placeholder="è²¡ç”¢ç·¨è™Ÿã€åç¨±ã€æ–°ä¿ç®¡äººã€æ–°åœ°é»..."
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>
                                        </div>

                                        {/* ç¯©é¸çµæœçµ±è¨ˆ */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            é¡¯ç¤º <span className="font-bold text-cyan-600">{filteredAssets.length}</span> / {assets.length} ç­†
                                        </div>
                                    </div>

                                    {/* è³‡æ–™è¡¨æ ¼ */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer accent-cyan-500"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '14%'}}>ä¿ç®¡äººè®Šæ›´</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '14%'}}>ä½¿ç”¨äººè®Šæ›´</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '13%'}}>åœ°é»è®Šæ›´</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>è½‰ç§»é¡å‹</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>ç”³è«‹æ™‚é–“</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        const isSelected = selectedAssetIds.includes(asset.assetId);
                                                        const keeperHasChange = asset.newKeeper && asset.oldKeeper !== asset.newKeeper;
                                                        const oldUser = asset.oldUser || asset.userName || '';
                                                        const newUser = asset.newUser || '';
                                                        const userHasChange = newUser && oldUser !== newUser;
                                                        const locationHasChange = asset.newLocation && asset.oldLocation !== asset.newLocation;
                                                        const transferType = asset.transferType || 'åœ°é»';

                                                        return (
                                                            <tr
                                                                key={`${asset.assetId}-${index}`}
                                                                className={`hover:bg-slate-50 transition-colors ${isSelected ? 'bg-cyan-50' : ''}`}
                                                            >
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isSelected}
                                                                        onChange={() => handleCheckboxChange(asset.assetId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer accent-cyan-500"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-700">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-700">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || ''}</td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {keeperHasChange ? (
                                                                        <>
                                                                            {asset.oldKeeper || ''}
                                                                            <span className="text-cyan-600"> â†’ </span>
                                                                            {asset.newKeeper || ''}
                                                                        </>
                                                                    ) : (
                                                                        asset.oldKeeper || ''
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {userHasChange ? (
                                                                        <>
                                                                            {oldUser}
                                                                            <span className="text-cyan-600"> â†’ </span>
                                                                            {newUser}
                                                                        </>
                                                                    ) : (
                                                                        oldUser
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {locationHasChange ? (
                                                                        <>
                                                                            {asset.oldLocation || ''}
                                                                            <span className="text-cyan-600"> â†’ </span>
                                                                            {asset.newLocation || ''}
                                                                        </>
                                                                    ) : (
                                                                        asset.oldLocation || ''
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3">
                                                                    <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                                                        transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')
                                                                            ? 'bg-red-100 text-red-800'
                                                                            : transferType.includes('ä¿ç®¡äºº')
                                                                                ? 'bg-yellow-100 text-yellow-800'
                                                                                : transferType.includes('ä½¿ç”¨äºº')
                                                                                    ? 'bg-sky-100 text-sky-800'
                                                                                    : 'bg-slate-100 text-slate-800'
                                                                    }`}>
                                                                        {transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')
                                                                            ? 'ä¿ç®¡äºº+ä½¿ç”¨äºº'
                                                                            : transferType.includes('ä¿ç®¡äºº')
                                                                                ? 'ä¿ç®¡äºº'
                                                                                : transferType.includes('ä½¿ç”¨äºº')
                                                                                    ? 'ä½¿ç”¨äºº'
                                                                                    : 'åœ°é»'}
                                                                    </span>
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-500 text-xs">{asset.applicationTime || '-'}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* é è…³ */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-cyan-600">{selectedAssetIds.length}</span> ç­†
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    disabled={isSubmitting}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                                >
                                    é—œé–‰
                                </button>
                                <button
                                    onClick={handleCancelTransfer}
                                    disabled={selectedAssetIds.length === 0 || isSubmitting}
                                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                >
                                    {isSubmitting ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i>
                                            è™•ç†ä¸­...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-times-circle"></i>
                                            å–æ¶ˆé¸å–çš„è½‰ç§»
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PendingInventoryModal = ({
          pendingItems,
          isAdmin,
          isLoading,
          error,
          onClose
        }) => {
          const [activeSessionId, setActiveSessionId] = useState('');

          const sessions = useMemo(() => {
            const map = new Map();
            (pendingItems || []).forEach(item => {
              const sessionId = item.inventoryId || 'unknown';
              if (!map.has(sessionId)) {
                map.set(sessionId, {
                  inventoryId: sessionId,
                  inventoryDate: item.inventoryDate || '',
                  inventoryPerson: item.inventoryPerson || '',
                  inventoryEmail: item.inventoryEmail || '',
                  items: []
                });
              }
              map.get(sessionId).items.push(item);
            });
            return Array.from(map.values()).sort((a, b) => {
              const left = a.inventoryDate || '';
              const right = b.inventoryDate || '';
              return right.localeCompare(left, 'zh-Hant');
            });
          }, [pendingItems]);

          useEffect(() => {
            if (sessions.length === 0) {
              setActiveSessionId('');
              return;
            }
            if (!activeSessionId || !sessions.some(session => session.inventoryId === activeSessionId)) {
              setActiveSessionId(sessions[0].inventoryId);
            }
          }, [sessions, activeSessionId]);

          const activeSession = sessions.find(session => session.inventoryId === activeSessionId) || sessions[0];
          const totalCount = (pendingItems || []).length;
          const normalizeAssigned = (item) => {
            const raw = String(item.assignedUser || '').trim();
            let type = item.assignedUserType;
            if (!type || type === 'none') {
              if (raw) {
                type = raw.includes('@') ? 'user' : 'group';
              } else {
                type = 'none';
              }
            }
            const userLabel = item.assignedUserLabel || (type === 'user' && raw ? raw.split('@')[0] : '');
            const groupLabel = item.assignedGroup || (type === 'group' ? (item.assignedUserLabel || raw) : '');
            return { type, userLabel, groupLabel, raw };
          };
          const sessionAssignmentMode = useMemo(() => {
            if (!activeSession) return 'group';
            const items = activeSession.items || [];
            let hasUser = false;
            let hasGroup = false;
            items.forEach(item => {
              const info = normalizeAssigned(item);
              if (info.type === 'user') hasUser = true;
              if (info.type === 'group') hasGroup = true;
            });
            if (hasUser && !hasGroup) return 'user';
            if (hasGroup && !hasUser) return 'group';
            if (hasUser && hasGroup) return 'mixed';
            return 'group';
          }, [activeSession]);

          const formatSessionLabel = (session) => {
            const datePart = session.inventoryDate || 'æœªæä¾›æ—¥æœŸ';
            const personPart = session.inventoryPerson || session.inventoryEmail || 'æœªæŒ‡å®šç›¤é»äºº';
            return `${datePart} / ${personPart}`;
          };

          const resolveAssignedDisplay = (item) => {
            const info = normalizeAssigned(item);
            if (info.type === 'group') {
              return info.groupLabel || 'æœªæŒ‡æ´¾';
            }
            if (info.type === 'user') {
              return info.userLabel || info.raw || 'æœªæŒ‡æ´¾';
            }
            return 'æœªæŒ‡æ´¾';
          };

          const groupedItems = useMemo(() => {
            if (!activeSession) return [];
            const items = activeSession.items || [];
            if (!isAdmin) {
              return [{
                key: 'all',
                label: 'å…¨éƒ¨',
                items: items.slice().sort((a, b) => String(a.assetId || '').localeCompare(String(b.assetId || ''), 'zh-Hant'))
              }];
            }
            const groupMap = new Map();
            items.forEach(item => {
              const info = normalizeAssigned(item);
              let label = '';
              if (sessionAssignmentMode === 'user') {
                if (info.type === 'group') {
                  const groupName = info.groupLabel || 'æœªæŒ‡æ´¾';
                  label = `ç¾¤çµ„ï¼š${groupName}`;
                } else {
                  label = info.userLabel || info.raw || 'æœªæŒ‡æ´¾';
                }
              } else if (sessionAssignmentMode === 'group') {
                const groupName = info.groupLabel || 'æœªæŒ‡æ´¾';
                label = groupName || 'æœªæŒ‡æ´¾';
              } else {
                if (info.type === 'group') {
                  const groupName = info.groupLabel || 'æœªæŒ‡æ´¾';
                  label = `ç¾¤çµ„ï¼š${groupName}`;
                } else if (info.type === 'user') {
                  label = info.userLabel || info.raw || 'æœªæŒ‡æ´¾';
                } else {
                  label = 'æœªæŒ‡æ´¾';
                }
              }
              if (!groupMap.has(label)) {
                groupMap.set(label, []);
              }
              groupMap.get(label).push(item);
            });

            return Array.from(groupMap.entries())
              .map(([label, items]) => ({
                key: label,
                label,
                items: items.slice().sort((a, b) => String(a.assetId || '').localeCompare(String(b.assetId || ''), 'zh-Hant'))
              }))
              .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hant'));
          }, [activeSession, isAdmin, sessionAssignmentMode]);

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                <div className="px-6 py-4 border-b flex justify-between items-center bg-red-50">
                  <h3 className="text-lg font-bold text-red-800">
                    <i className="fa-solid fa-clipboard-list mr-2"></i>
                    å¾…ç›¤é»è³‡ç”¢æ¸…å–®
                  </h3>
                  <button
                    onClick={onClose}
                    className="text-red-600 hover:text-red-800 transition-colors"
                  >
                    <i className="fas fa-times text-xl"></i>
                  </button>
                </div>

                <div className="p-6 max-h-[75vh] overflow-y-auto">
                  {isLoading ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-4">
                      <i className="fas fa-spinner fa-spin text-4xl text-red-500"></i>
                      <p className="text-slate-500 font-medium">è¼‰å…¥å¾…ç›¤é»æ¸…å–®ä¸­...</p>
                    </div>
                  ) : error ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-3 text-center">
                      <i className="fas fa-triangle-exclamation text-4xl text-red-500"></i>
                      <p className="text-slate-600 font-medium">è¼‰å…¥å¤±æ•—</p>
                      <p className="text-sm text-slate-500">{error}</p>
                    </div>
                  ) : sessions.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-4">
                      <i className="fas fa-check-circle text-5xl text-green-500"></i>
                      <p className="text-slate-500 text-lg font-medium">ç›®å‰æ²’æœ‰å¾…ç›¤é»çš„è³‡ç”¢ã€‚</p>
                      <p className="text-slate-400 text-sm">å·²å®Œæˆæ‰€æœ‰ç›¤é»æœƒè©±æˆ–å°šæœªé–‹å§‹ç›¤é»ã€‚</p>
                    </div>
                  ) : (
                    <>
                      <div className="mb-4 flex flex-wrap items-center justify-between gap-3">
                        <div className="text-sm text-slate-600">
                          å…± <span className="font-semibold text-red-600">{totalCount}</span> ç­†å¾…ç›¤é»è³‡ç”¢ï¼Œ<span className="font-semibold text-red-600">{sessions.length}</span> å€‹æœƒè©±
                        </div>
                      </div>

                      <div className="border-b border-slate-200 mb-4 flex flex-wrap gap-2">
                        {sessions.map(session => (
                          <button
                            key={session.inventoryId}
                            onClick={() => setActiveSessionId(session.inventoryId)}
                            className={`px-4 py-2 rounded-t-lg text-sm border ${
                              activeSession?.inventoryId === session.inventoryId
                                ? 'bg-white border-slate-200 border-b-white text-slate-800'
                                : 'bg-slate-50 border-transparent text-slate-500 hover:text-slate-700'
                            }`}
                            title={`æœƒè©±ä»£ç¢¼ï¼š${session.inventoryId}`}
                          >
                            <div className="font-medium line-clamp-1">{formatSessionLabel(session)}</div>
                            <div className="text-xs text-slate-400">{session.items.length} ç­†</div>
                          </button>
                        ))}
                      </div>

                      {activeSession && (
                        <div className="mb-4 text-sm text-slate-500">
                          æœƒè©±è³‡è¨Šï¼š<span className="text-slate-700">{formatSessionLabel(activeSession)}</span>
                        </div>
                      )}

                      {groupedItems.map(group => (
                        <div key={group.key} className="mb-6">
                          {isAdmin && (
                            <div className="mb-2 text-sm font-semibold text-slate-700">
                              {group.label} <span className="text-slate-400">({group.items.length} ç­†)</span>
                            </div>
                          )}
                          <div className="overflow-x-auto border border-slate-200 rounded-lg">
                            <table className="w-full text-sm border-collapse">
                              <thead className="bg-slate-50 sticky top-0">
                                <tr>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">è²¡ç”¢ç·¨è™Ÿ</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">è²¡ç”¢åç¨±</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">ä½¿ç”¨è€…</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">ä¿ç®¡äºº</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">ä¿ç®¡ä½ç½®</th>
                                  {isAdmin && (
                                    <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">æŒ‡æ´¾å°è±¡</th>
                                  )}
                                </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100">
                                {group.items.map((item, index) => (
                                  <tr key={`${group.key}-${item.inventoryId}-${item.assetId}-${index}`} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-3 py-2 font-mono text-slate-700 whitespace-nowrap">{item.assetId || '-'}</td>
                                    <td className="px-3 py-2 text-slate-700">{item.assetName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.userName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.keeperName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.location || '-'}</td>
                                    {isAdmin && (
                                      <td className="px-3 py-2 text-slate-600">{resolveAssignedDisplay(item)}</td>
                                    )}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      ))}
                    </>
                  )}
                </div>

                <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                  >
                    é—œé–‰
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // React Modals
        const LentAssetsModal = ({ lentAssetsDetails, isLoading, onClose, onReturnSuccess }) => {
            const [selectedLendIds, setSelectedLendIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                location: '',
                startDate: '',
                endDate: '',
                overdueOnly: '',
                search: ''
            });

            // ç•¶ lentAssetsDetails æ”¹è®Šæ™‚ï¼Œé‡ç½®å‹¾é¸ç‹€æ…‹
            useEffect(() => {
                setSelectedLendIds([]);
                setSelectAll(false);
            }, [lentAssetsDetails]);

            // ç¯©é¸é‚è¼¯
            const filteredAssets = useMemo(() => {
                if (!lentAssetsDetails) return [];

                return lentAssetsDetails.filter(asset => {
                    // åœ°é»ç¯©é¸
                    const matchLocation = !filters.location || asset.lendingLocation === filters.location;

                    // æ—¥æœŸç¯„åœç¯©é¸
                    const returnDate = new Date(asset.expectedReturnDate);
                    const matchDateRange =
                        (!filters.startDate || returnDate >= new Date(filters.startDate)) &&
                        (!filters.endDate || returnDate <= new Date(filters.endDate));

                    // é€¾æœŸç‹€æ…‹ç¯©é¸
                    let matchOverdue = true;
                    if (filters.overdueOnly === 'overdue' || filters.overdueOnly === 'notOverdue') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const assetReturnDate = new Date(asset.expectedReturnDate);
                        assetReturnDate.setHours(0, 0, 0, 0);
                        const isOverdue = assetReturnDate < today;
                        matchOverdue = filters.overdueOnly === 'overdue' ? isOverdue : !isOverdue;
                    }

                    // é—œéµå­—æœå°‹
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.borrower && asset.borrower.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.reason && asset.reason.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.keeperName && asset.keeperName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.userName && asset.userName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.lenderName && asset.lenderName.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchLocation && matchDateRange && matchOverdue && matchSearch;
                });
            }, [lentAssetsDetails, filters]);

            // å–å¾—å”¯ä¸€åœ°é»åˆ—è¡¨ï¼ˆç”¨æ–¼ç¯©é¸ä¸‹æ‹‰é¸å–®ï¼‰
            const uniqueLocations = useMemo(() => {
                if (!lentAssetsDetails) return [];
                return [...new Set(lentAssetsDetails.map(a => a.lendingLocation).filter(Boolean))].sort();
            }, [lentAssetsDetails]);

            // è™•ç†å…¨é¸
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedLendIds(filteredAssets.map(asset => asset.lendId));
                } else {
                    setSelectedLendIds([]);
                }
            }, [filteredAssets]);

            // è™•ç†å–®å€‹å‹¾é¸
            const handleCheckboxChange = useCallback((lendId) => {
                setSelectedLendIds(prev => {
                    if (prev.includes(lendId)) {
                        const newSelected = prev.filter(id => id !== lendId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, lendId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // è™•ç†æ­¸é‚„æäº¤
            const handleSubmitReturn = useCallback(() => {
                if (selectedLendIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è¦æ­¸é‚„çš„é …ç›®ã€‚');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦æ­¸é‚„æ‰€é¸çš„ ${selectedLendIds.length} ç­†è³‡ç”¢å—ï¼Ÿ\n\nâš ï¸ è«‹ç¢ºèªæ­¤è³‡ç”¢å·²æ­¸é‚„è‡³åŸå­˜æ”¾åœ°é»ã€‚`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('æ­£åœ¨è™•ç†æ­¸é‚„ä½œæ¥­...');

                google.script.run
                    .withSuccessHandler(message => {
                        hideToastProgress('æ­¸é‚„å®Œæˆï¼', 300);
                        setTimeout(() => {
                            alert(message);
                            setIsSubmitting(false);
                            onReturnSuccess();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideToastProgress('æ­¸é‚„å¤±æ•—ï¼', 300);
                        setIsSubmitting(false);
                        alert('æ­¸é‚„å¤±æ•—ï¼š' + error.message);
                    })
                    .processBatchReturn(selectedLendIds);
            }, [selectedLendIds, onReturnSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* æ¨™é¡Œåˆ— */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800">å‡ºå€Ÿä¸­è³‡ç”¢ - æ­¸é‚„ä½œæ¥­</h3>
                            <button
                                onClick={onClose}
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // è¼‰å…¥ä¸­ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                    <p className="text-slate-500 font-medium">è¼‰å…¥å‡ºå€Ÿè³‡æ–™ä¸­...</p>
                                </div>
                            ) : !lentAssetsDetails || lentAssetsDetails.length === 0 ? (
                                // ç„¡è³‡æ–™ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">ç›®å‰æ²’æœ‰å‡ºå€Ÿä¸­çš„è³‡ç”¢ã€‚</p>
                                    <p className="text-slate-400 text-sm">æ‰€æœ‰è³‡ç”¢éƒ½å·²æ­¸é‚„å®Œç•¢ã€‚</p>
                                </div>
                            ) : (
                                <>
                                    {/* ç¯©é¸æ§åˆ¶å€ */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {/* åœ°é»ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">å‡ºå€Ÿå¾Œåœ°é»</label>
                                                <select
                                                    value={filters.location}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, location: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                                    {uniqueLocations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* æ—¥æœŸç¯„åœç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆèµ·ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.startDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆè¿„ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.endDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            {/* é€¾æœŸç‹€æ…‹ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é€¾æœŸç‹€æ…‹</label>
                                                <select
                                                    value={filters.overdueOnly}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, overdueOnly: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">å…¨éƒ¨</option>
                                                    <option value="overdue">å·²é€¾æœŸ</option>
                                                    <option value="notOverdue">æœªé€¾æœŸ</option>
                                                </select>
                                            </div>
                                        </div>

                                        {/* é—œéµå­—æœå°‹ */}
                                        <div className="mt-4">
                                            <label className="block text-xs font-medium text-slate-600 mb-1">é—œéµå­—æœå°‹ï¼ˆè²¡ç”¢ç·¨è™Ÿã€ä¿ç®¡äººã€ä½¿ç”¨äººã€å‡ºå€Ÿäººã€å€Ÿç”¨äººã€å‡ºå€Ÿäº‹ç”±ï¼‰</label>
                                            <input
                                                type="text"
                                                value={filters.search}
                                                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                placeholder="è¼¸å…¥é—œéµå­—æœå°‹..."
                                                className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                disabled={isSubmitting}
                                            />
                                        </div>

                                        {/* ç¯©é¸çµæœçµ±è¨ˆ */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            é¡¯ç¤º <span className="font-bold text-blue-600">{filteredAssets.length}</span> / {lentAssetsDetails.length} ç­†
                                        </div>
                                    </div>

                                    {/* è³‡æ–™è¡¨æ ¼ */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>ä¿ç®¡äºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>ä½¿ç”¨äºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>å‡ºå€Ÿäºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>å€Ÿç”¨äºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>é è¨ˆæ­¸é‚„æ—¥</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>åŸæ”¾ç½®åœ°é»</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>å‡ºå€Ÿå¾Œåœ°é»</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '21%'}}>å‡ºå€Ÿäº‹ç”±</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        // åˆ¤æ–·æ˜¯å¦é€¾æœŸ
                                                        const today = new Date();
                                                        today.setHours(0, 0, 0, 0);
                                                        const returnDate = new Date(asset.expectedReturnDate);
                                                        returnDate.setHours(0, 0, 0, 0);
                                                        const isOverdue = returnDate < today;

                                                        return (
                                                            <tr key={`lent-${asset.lendId}-${index}`} className={`hover:bg-slate-50 transition-colors ${isOverdue ? 'bg-red-50' : ''}`}>
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedLendIds.includes(asset.lendId)}
                                                                        onChange={() => handleCheckboxChange(asset.lendId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-600">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.keeperName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.userName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lenderName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.borrower || '-'}</td>
                                                                <td className={`px-3 py-3 ${isOverdue ? 'text-red-600 font-semibold' : 'text-slate-600'}`}>
                                                                    {asset.expectedReturnDate}
                                                                    {isOverdue && <i className="fas fa-exclamation-triangle ml-1"></i>}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.originalLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lendingLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.reason}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* åº•éƒ¨æ“ä½œåˆ— */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <span>
                                        å·²é¸æ“‡ <span className="font-bold text-blue-600">{selectedLendIds.length}</span> / {filteredAssets.length} ç­†
                                    </span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors font-medium"
                                    disabled={isSubmitting}
                                >
                                    é—œé–‰
                                </button>
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <button
                                        onClick={handleSubmitReturn}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed font-medium shadow-sm"
                                        disabled={selectedLendIds.length === 0 || isSubmitting}
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin"></i>
                                                è™•ç†ä¸­...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-check"></i>
                                                ç¢ºèªæ­¸é‚„æ‰€é¸é …ç›®
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScrapPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // Tab ç‹€æ…‹
            const [activeTab, setActiveTab] = useState('pending'); // 'pending', 'history', 'byDate'

            // å·²ç”Ÿæˆæ–‡ä»¶ Tab ç‹€æ…‹
            const [historyFiles, setHistoryFiles] = useState([]);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);

            // åˆ—å°å·²å ±å»¢è³‡ç”¢ Tab ç‹€æ…‹
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [previewAssets, setPreviewAssets] = useState([]);
            const [isLoadingPreview, setIsLoadingPreview] = useState(false);
            const [isGeneratingByDate, setIsGeneratingByDate] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½å ±è¡¨ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    `æ˜¯å¦è¦åœ¨åˆ—å°å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„ç‹€æ…‹ç‚ºã€Œå·²å ±å»¢ã€ï¼Ÿ\n\n` +
                                    `âš ï¸ é‡è¦æé†’\n` +
                                    'é¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= åˆ—å°å¾Œæ›´æ–°ç‹€æ…‹ï¼Œå°‡ ${result.assetIds.length} ç­†è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€ï¼ˆè²¡ç”¢å°‡æ¨™è¨˜ç‚ºå·²å ±å»¢ï¼Œç„¡æ³•å†æ¬¡åˆ—å°æ­¤ç”³è«‹ï¼‰\n` +
                                    `âŒ ã€å–æ¶ˆã€‘= åƒ…åˆ—å°å ±è¡¨ï¼Œä¸æ›´æ–°ç‹€æ…‹ï¼ˆéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰`
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†ç‹€æ…‹æœªæ›´æ–°ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processScrapConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createScrapDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            // ========== å·²ç”Ÿæˆæ–‡ä»¶ Tab å‡½æ•¸ ==========
            const loadHistoryFiles = useCallback(() => {
                setIsLoadingHistory(true);
                google.script.run
                    .withSuccessHandler((files) => {
                        setHistoryFiles(files || []);
                        setIsLoadingHistory(false);
                    })
                    .withFailureHandler((error) => {
                        console.error('è¼‰å…¥æ­·å²æ–‡ä»¶å¤±æ•—:', error);
                        setHistoryFiles([]);
                        setIsLoadingHistory(false);
                    })
                    .getScrapDriveFiles();
            }, []);

            // Tab åˆ‡æ›æ™‚è¼‰å…¥æ­·å²æ–‡ä»¶
            useEffect(() => {
                if (activeTab === 'history' && historyFiles.length === 0) {
                    loadHistoryFiles();
                }
            }, [activeTab, historyFiles.length, loadHistoryFiles]);

            // ========== åˆ—å°å·²å ±å»¢è³‡ç”¢ Tab å‡½æ•¸ ==========
            const handlePreviewByDate = () => {
                if (!startDate || !endDate) {
                    alert('è«‹é¸æ“‡èµ·å§‹å’ŒçµæŸæ—¥æœŸ');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                    return;
                }

                setIsLoadingPreview(true);
                setPreviewAssets([]);

                google.script.run
                    .withSuccessHandler((assets) => {
                        if (assets === null) {
                            alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                            setPreviewAssets([]);
                        } else if (!Array.isArray(assets)) {
                            alert('è¼‰å…¥å¤±æ•—ï¼šé æœŸç‚ºé™£åˆ—');
                            setPreviewAssets([]);
                        } else if (assets.length === 0) {
                            alert('è©²æ—¥æœŸç¯„åœå…§æ²’æœ‰å·²å ±å»¢çš„è³‡ç”¢');
                            setPreviewAssets([]);
                        } else {
                            setPreviewAssets(assets);
                        }
                        setIsLoadingPreview(false);
                    })
                    .withFailureHandler((error) => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
                        setIsLoadingPreview(false);
                    })
                    .getScrapAssetsByDateRange(startDate, endDate, selectedCategory);
            };

            const handleGenerateByDate = () => {
                if (previewAssets.length === 0) {
                    alert('æ²’æœ‰å¯åˆ—å°çš„è³‡ç”¢');
                    return;
                }

                setIsGeneratingByDate(true);

                google.script.run
                    .withSuccessHandler((result) => {
                        alert(`å ±å»¢ç”³è«‹å–®å·²æˆåŠŸç”Ÿæˆï¼ˆå…± ${result.assetCount} ç­†è³‡ç”¢ï¼‰`);
                        window.open(result.fileUrl, '_blank');
                        setIsGeneratingByDate(false);
                    })
                    .withFailureHandler((error) => {
                        alert('ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                        setIsGeneratingByDate(false);
                    })
                    .createScrapDocByDateRange(startDate, endDate, selectedCategory);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-orange-800">åˆ—å°å ±å»¢ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-orange-600 hover:text-orange-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Tab å°èˆª */}
                        <div className="px-6 border-b bg-slate-50">
                            <div className="flex">
                                <button
                                    onClick={() => setActiveTab('pending')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'pending'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    å¾…å ±å»¢è³‡ç”¢
                                </button>
                                <button
                                    onClick={() => setActiveTab('history')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'history'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    å·²ç”Ÿæˆæ–‡ä»¶
                                </button>
                                <button
                                    onClick={() => setActiveTab('byDate')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'byDate'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    åˆ—å°å·²å ±å»¢è³‡ç”¢
                                </button>
                            </div>
                        </div>

                        {/* ========== Tab 1: å¾…å ±å»¢è³‡ç”¢ ========== */}
                        {activeTab === 'pending' && (
                            <>
                                {/* Category Selector */}
                                <div className="px-6 py-4 border-b bg-orange-50/50">
                                    <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                                    <label className="inline-flex items-center mr-6">
                                        <input
                                            type="radio"
                                            name="scrapCategory"
                                            value="è²¡ç”¢"
                                            checked={selectedCategory === 'è²¡ç”¢'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>è²¡ç”¢</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="scrapCategory"
                                            value="ç‰©å“"
                                            checked={selectedCategory === 'ç‰©å“'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>ç‰©å“</span>
                                    </label>
                                </div>

                                {/* Content */}
                                <div className="flex-1 overflow-y-auto p-6">
                                    {isLoading ? (
                                        <div className="flex items-center justify-center py-16">
                                            <div className="text-center">
                                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
                                                <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                            </div>
                                        </div>
                                    ) : currentAssets.length === 0 ? (
                                        <div className="text-center py-16 text-slate-500">
                                            <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                            <p>ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„{selectedCategory}ã€‚</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-orange-50 sticky top-0">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                className="rounded"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                        <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                        <th className="px-3 py-2 text-left">å ±å»¢æ—¥æœŸ</th>
                                                        <th className="px-3 py-2 text-left">å ±å»¢åŸå› </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {currentAssets.map(asset => (
                                                        <tr key={asset.assetId} className="border-b hover:bg-orange-50/30">
                                                            <td className="px-3 py-2">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedIds.includes(asset.assetId)}
                                                                    onChange={() => handleSelectOne(asset.assetId)}
                                                                    className="rounded"
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">{asset.assetId}</td>
                                                            <td className="px-3 py-2">{asset.assetName}</td>
                                                            <td className="px-3 py-2">{asset.modelBrand}</td>
                                                            <td className="px-3 py-2">{asset.originalKeeper}</td>
                                                            <td className="px-3 py-2">{asset.originalUser || ''}</td>
                                                            <td className="px-3 py-2">{asset.scrapDate || ''}</td>
                                                            <td className="px-3 py-2">{asset.scrapReason || ''}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* ========== Tab 2: å·²ç”Ÿæˆæ–‡ä»¶ ========== */}
                        {activeTab === 'history' && (
                            <div className="flex-1 overflow-y-auto p-6">
                                {isLoadingHistory ? (
                                    <div className="flex items-center justify-center py-16">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                                        <span className="ml-3 text-slate-600">è¼‰å…¥ä¸­...</span>
                                    </div>
                                ) : historyFiles.length === 0 ? (
                                    <div className="text-center py-16 text-slate-500">
                                        <i className="fas fa-folder-open text-5xl mb-4 text-slate-300"></i>
                                        <p>ç›®å‰æ²’æœ‰å·²ç”Ÿæˆçš„å ±å»¢æ–‡ä»¶ã€‚</p>
                                        <button
                                            onClick={loadHistoryFiles}
                                            className="mt-4 px-4 py-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                                        >
                                            <i className="fas fa-sync-alt mr-2"></i>é‡æ–°è¼‰å…¥
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-medium text-slate-700">å·²ç”Ÿæˆçš„å ±å»¢æ–‡ä»¶</h4>
                                            <button
                                                onClick={loadHistoryFiles}
                                                className="text-sm text-orange-600 hover:text-orange-800 transition-colors"
                                            >
                                                <i className="fas fa-sync-alt mr-1"></i>é‡æ–°æ•´ç†
                                            </button>
                                        </div>
                                        <div className="overflow-x-auto border rounded-lg">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">æª”æ¡ˆåç¨±</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">æœ€å¾Œä¿®æ”¹æ™‚é–“</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">å¤§å°</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historyFiles.map((file, idx) => (
                                                        <tr key={idx} className="border-t hover:bg-slate-50">
                                                            <td className="px-4 py-3">{file.name}</td>
                                                            <td className="px-4 py-3 text-slate-600">{file.lastUpdated}</td>
                                                            <td className="px-4 py-3 text-slate-600">{file.size}</td>
                                                            <td className="px-4 py-3">
                                                                <a
                                                                    href={file.url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="text-blue-600 hover:text-blue-800 font-medium"
                                                                >
                                                                    <i className="fas fa-external-link-alt mr-1"></i>é–‹å•Ÿ
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* ========== Tab 3: åˆ—å°å·²å ±å»¢è³‡ç”¢ ========== */}
                        {activeTab === 'byDate' && (
                            <div className="flex-1 overflow-y-auto p-6">
                                {/* é¡åˆ¥é¸æ“‡ */}
                                <div className="mb-4 p-4 bg-orange-50 rounded-lg">
                                    <label className="font-medium text-slate-700 mr-4">è²¡ç”¢é¡åˆ¥ï¼š</label>
                                    <label className="inline-flex items-center mr-6">
                                        <input
                                            type="radio"
                                            name="scrapCategoryByDate"
                                            value="è²¡ç”¢"
                                            checked={selectedCategory === 'è²¡ç”¢'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>è²¡ç”¢</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="scrapCategoryByDate"
                                            value="ç‰©å“"
                                            checked={selectedCategory === 'ç‰©å“'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>ç‰©å“</span>
                                    </label>
                                </div>

                                {/* æ—¥æœŸé¸æ“‡å™¨ */}
                                <div className="mb-6 p-4 bg-slate-50 rounded-lg">
                                    <h4 className="font-medium text-slate-700 mb-3">
                                        <i className="fas fa-calendar-alt mr-2 text-slate-500"></i>
                                        é¸æ“‡å ±å»¢æœŸé–“
                                    </h4>
                                    <div className="flex flex-wrap items-end gap-4">
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">èµ·å§‹æ—¥æœŸ</label>
                                            <input
                                                type="date"
                                                value={startDate}
                                                onChange={(e) => setStartDate(e.target.value)}
                                                className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">çµæŸæ—¥æœŸ</label>
                                            <input
                                                type="date"
                                                value={endDate}
                                                onChange={(e) => setEndDate(e.target.value)}
                                                className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                            />
                                        </div>
                                        <button
                                            onClick={handlePreviewByDate}
                                            disabled={isLoadingPreview}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {isLoadingPreview ? (
                                                <>
                                                    <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                    <span>æœå°‹ä¸­...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <i className="fas fa-search"></i>
                                                    <span>é è¦½</span>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                {/* é è¦½çµæœ */}
                                {previewAssets.length > 0 && (
                                    <>
                                        <h4 className="font-medium text-green-700 mb-3 flex items-center gap-2">
                                            <i className="fas fa-check-circle"></i>
                                            é è¦½ç¬¦åˆæ¢ä»¶çš„è³‡ç”¢ï¼ˆ{previewAssets.length} ç­†ï¼‰
                                        </h4>
                                        <div className="overflow-x-auto border rounded-lg mb-4">
                                            <table className="w-full text-sm">
                                                <thead className="bg-green-50">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-2 text-left">ä¿ç®¡äºº</th>
                                                        <th className="px-3 py-2 text-left">å ±å»¢æ—¥æœŸ</th>
                                                        <th className="px-3 py-2 text-left">å ±å»¢åŸå› </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {previewAssets.map((asset, idx) => (
                                                        <tr key={idx} className="border-t hover:bg-green-50/30">
                                                            <td className="px-3 py-2">{asset.assetId}</td>
                                                            <td className="px-3 py-2">{asset.assetName}</td>
                                                            <td className="px-3 py-2">{asset.modelBrand}</td>
                                                            <td className="px-3 py-2">{asset.leaderName}</td>
                                                            <td className="px-3 py-2">{asset.scrapDate}</td>
                                                            <td className="px-3 py-2">{asset.scrapReason}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="text-center">
                                            <button
                                                onClick={handleGenerateByDate}
                                                disabled={isGeneratingByDate}
                                                className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center gap-2 mx-auto"
                                            >
                                                {isGeneratingByDate ? (
                                                    <>
                                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                        <span>ç”¢ç”Ÿä¸­...</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <i className="fas fa-file-alt"></i>
                                                        <span>ç”Ÿæˆå ±å»¢ç”³è«‹å–®</span>
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Footer - æ ¹æ“š Tab é¡¯ç¤ºä¸åŒå…§å®¹ */}
                        {activeTab === 'pending' && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                                <div className="text-sm text-slate-600">
                                    å·²é¸æ“‡ <span className="font-bold text-orange-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        disabled={isGenerating}
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button
                                        onClick={handleGenerateDoc}
                                        disabled={isGenerating || selectedIds.length === 0}
                                        className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {isGenerating ? (
                                            <>
                                                <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                <span>ç”¢ç”Ÿä¸­...</span>
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-file-alt"></i>
                                                <span>ç”Ÿæˆå ±å»¢ç”³è«‹å–®</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* history å’Œ byDate Tab åªé¡¯ç¤ºé—œé–‰æŒ‰éˆ• */}
                        {(activeTab === 'history' || activeTab === 'byDate') && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                >
                                    é—œé–‰
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TransferPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½è½‰ç§»è¨˜éŒ„ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    'â“ æ˜¯å¦è¦åœ¨ç”Ÿæˆæ–‡ä»¶å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„æ›´æ–°ç‹€æ…‹ï¼Ÿ\n\n' +
                                    'âš ï¸  æé†’ï¼šé¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= æ¨™è¨˜ ${result.assetIds.length} ç­†è½‰ç§»è¨˜éŒ„ç‚ºå·²æ›´æ–°ï¼ˆç„¡æ³•å†æ¬¡åˆ—å°ï¼‰\n` +
                                    'âŒ ã€å–æ¶ˆã€‘= åƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ¨™è¨˜ç‹€æ…‹ï¼ˆå¯å†æ¬¡åˆ—å°ï¼Œéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰'
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†æœªæ¨™è¨˜ç‚ºå·²ä¸Šå‚³ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processUploadConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createTransferDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">åˆ—å°è½‰ç§»ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Category Selector */}
                        <div className="px-6 py-4 border-b bg-purple-50/50">
                            <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                            <label className="inline-flex items-center mr-6">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="è²¡ç”¢"
                                    checked={selectedCategory === 'è²¡ç”¢'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>è²¡ç”¢</span>
                            </label>
                            <label className="inline-flex items-center">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="ç‰©å“"
                                    checked={selectedCategory === 'ç‰©å“'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>ç‰©å“</span>
                            </label>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-16">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                                        <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                    </div>
                                </div>
                            ) : currentAssets.length === 0 ? (
                                <div className="text-center py-16 text-slate-500">
                                    <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                    <p>ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆè½‰ç§»çš„{selectedCategory}è¨˜éŒ„ã€‚</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-purple-50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="rounded"
                                                    />
                                                </th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">åŸåœ°é»</th>
                                                <th className="px-3 py-2 text-left">æ–°ä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°ä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°åœ°é»</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»é¡å‹</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»æ—¥æœŸ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {currentAssets.map(asset => (
                                                <tr key={asset.assetId} className="border-b hover:bg-purple-50/30">
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedIds.includes(asset.assetId)}
                                                            onChange={() => handleSelectOne(asset.assetId)}
                                                            className="rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2">{asset.assetId}</td>
                                                    <td className="px-3 py-2">{asset.assetName}</td>
                                                    <td className="px-3 py-2">{asset.modelBrand}</td>
                                                    <td className="px-3 py-2">{asset.oldKeeper}</td>
                                                    <td className="px-3 py-2">{asset.oldUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.oldLocation}</td>
                                                    <td className="px-3 py-2">{asset.newKeeper}</td>
                                                    <td className="px-3 py-2">{asset.newUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.newLocation}</td>
                                                    <td className="px-3 py-2">{asset.transferType}</td>
                                                    <td className="px-3 py-2">{asset.transferDate}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-purple-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    disabled={isGenerating}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleGenerateDoc}
                                    disabled={isGenerating || selectedIds.length === 0}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? (
                                        <>
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                            <span>ç”¢ç”Ÿä¸­...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-file-alt"></i>
                                            <span>ç”Ÿæˆè½‰ç§»ç”³è«‹å–®</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== å¿«é€Ÿæ“ä½œ Modal çµ„ä»¶ =====

        // è½‰ç§» Modal
        const QuickTransferModal = ({ asset, transferOptions, onClose, onSuccess }) => {
            const [transferMode, setTransferMode] = useState('normal'); // 'normal', 'station', 'info', 'intake'
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            // é§ç«™è½‰ç§»å°ˆç”¨ state
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !transferOptions) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è®Šæ›´ï¼ˆåœ°é»ã€ä¿ç®¡äººæˆ–ä½¿ç”¨äººï¼‰');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('è«‹é¸æ“‡æ–°åœ°é»');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('è«‹é¸æ“‡æ–°ä¿ç®¡äºº');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('è«‹é¸æ“‡æ–°ä½¿ç”¨äºº');
                        return;
                    }
                } else if (transferMode === 'station') {
                    // é§ç«™è½‰ç§»æ¨¡å¼é©—è­‰
                    if (!custodianEmail) {
                        alert('è«‹é¸æ“‡é§ç®¡ï¼');
                        return;
                    }
                    if (!stationLocation) {
                        alert('è«‹é¸æ“‡é§ç«™åœ°é»ï¼');
                        return;
                    }
                }

                const confirmation = confirm(`ç¢ºå®šè¦è½‰ç§»è²¡ç”¢ã€Œ${asset.assetId}ã€å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤è½‰ç§»ç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                // ç‰¹æ®Šæ¨¡å¼çš„é¡å¤–åƒæ•¸
                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('è½‰ç§»ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                è½‰ç§»è²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                            </div>

                            {/* è½‰ç§»æ¨¡å¼é¸æ“‡ */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»æ¨¡å¼</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            name="transferMode"
                                            value="normal"
                                            checked={transferMode === 'normal'}
                                            onChange={(e) => setTransferMode(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>ä¸€èˆ¬è½‰ç§»</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="transferMode"
                                                value="station"
                                                checked={transferMode === 'station'}
                                                onChange={(e) => setTransferMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span>ä¸­å¿ƒè½‰çµ¦é§ç«™</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="info"
                                                    checked={transferMode === 'info'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>é§ç«™å›é€ä¸­å¿ƒè³‡è¨Šçµ„</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="intake"
                                                    checked={transferMode === 'intake'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>é§ç«™å›é€ä¸­å¿ƒæ”¶æ¡ˆçµ„</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* ä¸€èˆ¬è½‰ç§»é¸é … */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    {/* è®Šæ›´åœ°é» */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeLocation}
                                                onChange={(e) => setChangeLocation(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´åœ°é»</span>
                                        </label>
                                        {changeLocation && (
                                            <select
                                                value={newLocation}
                                                onChange={(e) => setNewLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°åœ°é»...</option>
                                                {transferOptions.locations?.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* è®Šæ›´ä¿ç®¡äºº */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeKeeper}
                                                onChange={(e) => setChangeKeeper(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä¿ç®¡äºº</span>
                                        </label>
                                        {changeKeeper && (
                                            <select
                                                value={newKeeperEmail}
                                                onChange={(e) => setNewKeeperEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°ä¿ç®¡äºº...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* è®Šæ›´ä½¿ç”¨äºº */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeUser}
                                                onChange={(e) => setChangeUser(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä½¿ç”¨äºº</span>
                                        </label>
                                        {changeUser && (
                                            <select
                                                value={newUserEmail}
                                                onChange={(e) => setNewUserEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°ä½¿ç”¨äºº...</option>
                                                {transferOptions.users && Object.entries(transferOptions.users).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* é§ç«™è½‰ç§»æ¨¡å¼çš„ä¸‹æ‹‰é¸å–® */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>é§ç«™æ¨¡å¼èªªæ˜ï¼š</strong>ä¿ç®¡äººå’Œä½¿ç”¨äººå°‡åŒæ™‚è¨­ç‚ºæ­¤é§ç®¡ã€‚
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* é§ç®¡é¸æ“‡ */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                è½‰ç§»çµ¦é§ç®¡ï¼š<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={custodianEmail}
                                                onChange={(e) => setCustodianEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡é§ç®¡...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* é§ç«™åœ°é»é¸æ“‡ */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                é§ç«™åœ°é»ï¼š<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={stationLocation}
                                                onChange={(e) => setStationLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡é§ç«™åœ°é»...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* å…¶ä»–ç‰¹æ®Šæ¨¡å¼èªªæ˜ */}
                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šè³‡è¨Šçµ„ä¿ç®¡äººã€ä½¿ç”¨äººå’Œåœ°é»'}
                                        {transferMode === 'intake' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šæ”¶æ¡ˆçµ„ä¿ç®¡äººå’Œåœ°é»'}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å‡ºå€Ÿ Modal
        const QuickLendingModal = ({ asset, lendingOptions, onClose, onSuccess }) => {
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !lendingOptions) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå€Ÿç”¨äººã€åœ°é»ã€æ­¸é‚„æ—¥æœŸï¼‰');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦å‡ºå€Ÿè²¡ç”¢ã€Œ${asset.assetId}ã€çµ¦ ${borrowerName} å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤å‡ºå€Ÿç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('å‡ºå€Ÿç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                å‡ºå€Ÿè²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">ç›®å‰åœ°é»</div>
                                <div className="text-slate-800">{asset.location}</div>
                            </div>

                            <div className="space-y-4">
                                {/* å€Ÿç”¨äºº */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å€Ÿç”¨äººå§“å <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={borrowerName}
                                        onChange={(e) => setBorrowerName(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">è«‹é¸æ“‡å€Ÿç”¨äºº...</option>
                                        {lendingOptions.borrowers?.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* å€Ÿå‡ºå¾Œåœ°é» */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å€Ÿå‡ºå¾Œæ”¾ç½®åœ°é» <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={lendingLocation}
                                        onChange={(e) => setLendingLocation(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">è«‹é¸æ“‡åœ°é»...</option>
                                        {lendingOptions.locations?.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* é è¨ˆæ­¸é‚„æ—¥æœŸ */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        é è¨ˆæ­¸é‚„æ—¥æœŸ <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        value={returnDate}
                                        onChange={(e) => setReturnDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    />
                                </div>

                                {/* å‡ºå€Ÿäº‹ç”± */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å‡ºå€Ÿäº‹ç”±/å‚™è¨»
                                    </label>
                                    <textarea
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        rows="3"
                                        placeholder="è«‹è¼¸å…¥å‡ºå€Ÿäº‹ç”±æˆ–å‚™è¨»..."
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å ±å»¢ Modal
        const QuickScrapModal = ({ asset, onClose, onSuccess }) => {
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (!reason) {
                    alert('è«‹é¸æ“‡å ±å»¢åŸå› ');
                    return;
                }
                if ((reason === 'C' || reason === 'å…¶ä»–') && !remarks.trim()) {
                    alert('é¸æ“‡ã€Œå…¶ä»–ã€åŸå› æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°èªªæ˜');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦ç”³è«‹å ±å»¢è²¡ç”¢ã€Œ${asset.assetId}ã€å—ï¼Ÿ\nå ±å»¢åŸå› ï¼š${reason === 'A' ? 'A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : reason === 'B' ? 'B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : 'C.å…¶ä»–'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤å ±å»¢ç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('å ±å»¢ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                ç”³è«‹å ±å»¢è²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">ç›®å‰ç‹€æ…‹</div>
                                <div className="text-slate-800">{asset.status}</div>
                            </div>

                            {/* è­¦å‘Šè¨Šæ¯ */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">æ³¨æ„äº‹é …</div>
                                        <div>æ­¤æ“ä½œå°‡æœƒå°‡è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå ±å»¢ä¸­ã€ï¼Œå¾…ç®¡ç†å“¡æœ€çµ‚ç¢ºèªã€‚è«‹ç¢ºèªå ±å»¢åŸå› ç„¡èª¤å¾Œå†æäº¤ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                {/* å ±å»¢åŸå›  */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å ±å»¢åŸå›  <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    >
                                        <option value="">è«‹é¸æ“‡åŸå› ...</option>
                                        <option value="A">A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="B">B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="C">C.å…¶ä»–</option>
                                    </select>
                                </div>

                                {/* è©³ç´°èªªæ˜ */}
                                {(reason === 'C' || reason === 'å…¶ä»–') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">
                                            è©³ç´°èªªæ˜ <span className="text-red-500">*</span>
                                        </label>
                                        <textarea
                                            value={remarks}
                                            onChange={(e) => setRemarks(e.target.value)}
                                            rows="4"
                                            placeholder="è«‹è©³ç´°èªªæ˜å ±å»¢åŸå› ..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                        ></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤å ±å»¢ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== æ‰¹æ¬¡æ“ä½œ Modal çµ„ä»¶ =====

        // æ‰¹æ¬¡è½‰ç§» Modal
        const BatchTransferModal = ({ transferOptions, allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [transferMode, setTransferMode] = useState('normal');
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            // å¾ BatchList ç²å–å·²é¸è³‡ç”¢
            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            // ç²å–å·²é¸è³‡ç”¢çš„è©³ç´°è³‡è¨Š
            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!transferOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è½‰ç§»çš„è³‡ç”¢');
                    return;
                }

                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è®Šæ›´ï¼ˆåœ°é»ã€ä¿ç®¡äººæˆ–ä½¿ç”¨äººï¼‰');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('è«‹é¸æ“‡æ–°åœ°é»');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('è«‹é¸æ“‡æ–°ä¿ç®¡äºº');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('è«‹é¸æ“‡æ–°ä½¿ç”¨äºº');
                        return;
                    }
                } else if (transferMode === 'station') {
                    if (!custodianEmail) {
                        alert('è«‹é¸æ“‡é§ç®¡ï¼');
                        return;
                    }
                    if (!stationLocation) {
                        alert('è«‹é¸æ“‡é§ç«™åœ°é»ï¼');
                        return;
                    }
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡è½‰ç§» ${selectedAssetIds.length} ç­†è³‡ç”¢å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡è½‰ç§»ç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡è½‰ç§»ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        // æ¸…ç©º BatchList
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                æ‰¹æ¬¡è½‰ç§»è²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* è½‰ç§»æ¨¡å¼é¸æ“‡ */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»æ¨¡å¼</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input type="radio" name="batchTransferMode" value="normal" checked={transferMode === 'normal'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                        <span>ä¸€èˆ¬è½‰ç§»</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input type="radio" name="batchTransferMode" value="station" checked={transferMode === 'station'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                            <span>ä¸­å¿ƒè½‰çµ¦é§ç«™</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="info" checked={transferMode === 'info'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>é§ç«™å›é€ä¸­å¿ƒè³‡è¨Šçµ„</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="intake" checked={transferMode === 'intake'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>é§ç«™å›é€ä¸­å¿ƒæ”¶æ¡ˆçµ„</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* ä¸€èˆ¬è½‰ç§»é¸é … */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeLocation} onChange={(e) => setChangeLocation(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´åœ°é»</span>
                                        </label>
                                        {changeLocation && (
                                            <select value={newLocation} onChange={(e) => setNewLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°åœ°é»...</option>
                                                {transferOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeKeeper} onChange={(e) => setChangeKeeper(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä¿ç®¡äºº</span>
                                        </label>
                                        {changeKeeper && (
                                            <select value={newKeeperEmail} onChange={(e) => setNewKeeperEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°ä¿ç®¡äºº...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeUser} onChange={(e) => setChangeUser(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä½¿ç”¨äºº</span>
                                        </label>
                                        {changeUser && (
                                            <select value={newUserEmail} onChange={(e) => setNewUserEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°ä½¿ç”¨äºº...</option>
                                                {transferOptions.users && Object.entries(transferOptions.users).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* é§ç«™è½‰ç§» */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>é§ç«™æ¨¡å¼èªªæ˜ï¼š</strong>ä¿ç®¡äººå’Œä½¿ç”¨äººå°‡åŒæ™‚è¨­ç‚ºæ­¤é§ç®¡ã€‚
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»çµ¦é§ç®¡ï¼š<span className="text-red-600">*</span></label>
                                            <select value={custodianEmail} onChange={(e) => setCustodianEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡é§ç®¡...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">é§ç«™åœ°é»ï¼š<span className="text-red-600">*</span></label>
                                            <select value={stationLocation} onChange={(e) => setStationLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡é§ç«™åœ°é»...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šè³‡è¨Šçµ„ä¿ç®¡äººã€ä½¿ç”¨äººå’Œåœ°é»'}
                                        {transferMode === 'intake' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šæ”¶æ¡ˆçµ„ä¿ç®¡äººå’Œåœ°é»'}
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡è½‰ç§»</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // æ‰¹æ¬¡å‡ºå€Ÿ Modal
        const BatchLendingModal = ({ lendingOptions, allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!lendingOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦å‡ºå€Ÿçš„è³‡ç”¢');
                    return;
                }
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå€Ÿç”¨äººã€åœ°é»ã€æ­¸é‚„æ—¥æœŸï¼‰');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡å‡ºå€Ÿ ${selectedAssetIds.length} ç­†è³‡ç”¢çµ¦ ${borrowerName} å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡å‡ºå€Ÿç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡å‡ºå€Ÿç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                æ‰¹æ¬¡å‡ºå€Ÿè²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å€Ÿç”¨äººå§“å <span className="text-red-500">*</span></label>
                                    <select value={borrowerName} onChange={(e) => setBorrowerName(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">è«‹é¸æ“‡å€Ÿç”¨äºº...</option>
                                        {lendingOptions.borrowers?.map(name => (<option key={name} value={name}>{name}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å€Ÿå‡ºå¾Œæ”¾ç½®åœ°é» <span className="text-red-500">*</span></label>
                                    <select value={lendingLocation} onChange={(e) => setLendingLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">è«‹é¸æ“‡åœ°é»...</option>
                                        {lendingOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">é è¨ˆæ­¸é‚„æ—¥æœŸ <span className="text-red-500">*</span></label>
                                    <input type="date" value={returnDate} onChange={(e) => setReturnDate(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å‡ºå€Ÿäº‹ç”±/å‚™è¨»</label>
                                    <textarea value={reason} onChange={(e) => setReason(e.target.value)} rows="3" placeholder="è«‹è¼¸å…¥å‡ºå€Ÿäº‹ç”±æˆ–å‚™è¨»..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡å‡ºå€Ÿ</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // æ‰¹æ¬¡å ±å»¢ Modal
        const BatchScrapModal = ({ allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦å ±å»¢çš„è³‡ç”¢');
                    return;
                }
                if (!reason) {
                    alert('è«‹é¸æ“‡å ±å»¢åŸå› ');
                    return;
                }
                if ((reason === 'C' || reason === 'å…¶ä»–') && !remarks.trim()) {
                    alert('é¸æ“‡ã€Œå…¶ä»–ã€åŸå› æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°èªªæ˜');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡ç”³è«‹å ±å»¢ ${selectedAssetIds.length} ç­†è³‡ç”¢å—ï¼Ÿ\nå ±å»¢åŸå› ï¼š${reason === 'A' ? 'A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : reason === 'B' ? 'B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : 'C.å…¶ä»–'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡å ±å»¢ç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡å ±å»¢ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                æ‰¹æ¬¡ç”³è«‹å ±å»¢è²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* è­¦å‘Šè¨Šæ¯ */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">æ³¨æ„äº‹é …</div>
                                        <div>æ­¤æ“ä½œå°‡æœƒå°‡æ‰€æœ‰é¸ä¸­çš„è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå ±å»¢ä¸­ã€ï¼Œå¾…ç®¡ç†å“¡æœ€çµ‚ç¢ºèªã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å ±å»¢åŸå›  <span className="text-red-500">*</span></label>
                                    <select value={reason} onChange={(e) => setReason(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                        <option value="">è«‹é¸æ“‡åŸå› ...</option>
                                        <option value="A">A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="B">B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="C">C.å…¶ä»–</option>
                                    </select>
                                </div>
                                {(reason === 'C' || reason === 'å…¶ä»–') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">è©³ç´°èªªæ˜ <span className="text-red-500">*</span></label>
                                        <textarea value={remarks} onChange={(e) => setRemarks(e.target.value)} rows="4" placeholder="è«‹è©³ç´°èªªæ˜å ±å»¢åŸå› ..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡å ±å»¢</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== æ–°å¢è³‡ç”¢ Modal ==========
        const AddAssetModal = ({ onClose, onSuccess }) => {
            // è¼‰å…¥èˆ‡æäº¤ç‹€æ…‹
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [dropdownData, setDropdownData] = useState(null);

            // è¡¨å–®ç‹€æ…‹
            const [assetType, setAssetType] = useState('property');
            const [assetId, setAssetId] = useState('');
            const [assetName, setAssetName] = useState('');
            const [modelBrand, setModelBrand] = useState('');
            const [category, setCategory] = useState('');
            const [purchaseDate, setPurchaseDate] = useState('');
            const [useLife, setUseLife] = useState('');
            const [isItAsset, setIsItAsset] = useState(false);
            const [isActuallyComputer, setIsActuallyComputer] = useState(false);
            const [isIsoScope, setIsIsoScope] = useState(false);
            const [location, setLocation] = useState('');
            const [keeperEmail, setKeeperEmail] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [remarks, setRemarks] = useState('');

            // è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™
            useEffect(() => {
                google.script.run
                    .withSuccessHandler((data) => {
                        setDropdownData(data);
                        setIsLoading(false);
                    })
                    .withFailureHandler((error) => {
                        alert('è¼‰å…¥é¸å–®è³‡æ–™å¤±æ•—ï¼š' + error.message);
                        onClose();
                    })
                    .getDropdownData();
            }, []);

            // è³‡è¨Šè³‡ç”¢é€£å‹•é‚è¼¯ï¼šå–æ¶ˆä¸»é¸é …æ™‚æ¸…ç©ºå­é¸é …
            useEffect(() => {
                if (!isItAsset) {
                    setIsActuallyComputer(false);
                    setIsIsoScope(false);
                }
            }, [isItAsset]);

            // è¡¨å–®é©—è­‰èˆ‡æäº¤
            const handleSubmit = () => {
                // å‰ç«¯å¿…å¡«é©—è­‰
                if (!assetId.trim() || !assetName.trim() || !location || !keeperEmail) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆç·¨è™Ÿã€åç¨±ã€åœ°é»ã€ä¿ç®¡äººï¼‰');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦æ–°å¢${assetType === 'property' ? 'è²¡ç”¢' : 'ç‰©å“'}ã€Œ${assetId}ã€å—ï¼Ÿ`)) {
                    return;
                }

                setIsSubmitting(true);
                if (typeof showFlyProgressBar === 'function') {
                    showFlyProgressBar('æ­£åœ¨æ–°å¢è³‡ç”¢...');
                }

                const formData = {
                    assetType,
                    assetId: assetId.trim(),
                    assetName: assetName.trim(),
                    modelBrand: modelBrand.trim(),
                    category: category.trim(),
                    purchaseDate,
                    useLife,
                    isItAsset,
                    isActuallyComputer,
                    isIsoScope,
                    location,
                    keeperEmail,
                    userEmail: userEmail || keeperEmail,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler((message) => {
                        if (typeof hideFlyProgressBar === 'function') {
                            hideFlyProgressBar('æ–°å¢æˆåŠŸï¼', 300);
                        }
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler((error) => {
                        if (typeof hideFlyProgressBar === 'function') {
                            hideFlyProgressBar('æ–°å¢å¤±æ•—', 0);
                        }
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .addNewAsset(formData);
            };

            // æ’åºå¾Œçš„ä¿ç®¡äººåˆ—è¡¨
            const sortedKeepers = useMemo(() => {
                if (!dropdownData?.keepers) return [];
                return Object.entries(dropdownData.keepers)
                    .sort((a, b) => a[1].localeCompare(b[1], 'zh-Hant'));
            }, [dropdownData]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-emerald-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-emerald-800">
                                <i className="fas fa-plus-circle mr-2"></i>
                                æ–°å¢è²¡ç”¢ / ç‰©å“
                            </h3>
                            <button onClick={onClose} disabled={isSubmitting} className="text-emerald-600 hover:text-emerald-800 transition-colors disabled:opacity-50">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-emerald-500"></i>
                                    <p className="text-slate-500 font-medium">è¼‰å…¥é¸å–®è³‡æ–™ä¸­...</p>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* å€å¡Š 1: è³‡æ–™é¡å‹ */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-folder-open mr-2 text-slate-500"></i>è³‡æ–™é¡å‹
                                        </div>
                                        <div className="flex gap-6">
                                            <label className="flex items-center cursor-pointer">
                                                <input type="radio" name="addAssetType" value="property"
                                                    checked={assetType === 'property'}
                                                    onChange={(e) => setAssetType(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>è²¡ç”¢ï¼ˆåˆ—å…¥è²¡ç”¢ç¸½è¡¨ï¼‰</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input type="radio" name="addAssetType" value="item"
                                                    checked={assetType === 'item'}
                                                    onChange={(e) => setAssetType(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>ç‰©å“ï¼ˆåˆ—å…¥ç‰©å“ç¸½è¡¨ï¼‰</span>
                                            </label>
                                        </div>
                                    </div>

                                    {/* å€å¡Š 2: åŸºæœ¬è³‡æ–™ */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-info-circle mr-2 text-slate-500"></i>åŸºæœ¬è³‡æ–™
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {/* ç·¨è™Ÿ */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    ç·¨è™Ÿ <span className="text-red-500">*</span>
                                                </label>
                                                <input type="text" value={assetId} onChange={(e) => setAssetId(e.target.value)}
                                                    placeholder="ä¾‹å¦‚ï¼šA1120001"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                                <p className="text-xs text-slate-500 mt-1">ç³»çµ±å°‡æª¢æŸ¥å”¯ä¸€æ€§</p>
                                            </div>

                                            {/* åç¨± */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    åç¨± <span className="text-red-500">*</span>
                                                </label>
                                                <input type="text" value={assetName} onChange={(e) => setAssetName(e.target.value)}
                                                    placeholder="ä¾‹å¦‚ï¼šASUS ç­†è¨˜å‹é›»è…¦"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* å‹è™Ÿ/å» ç‰Œ */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">å‹è™Ÿ/å» ç‰Œ</label>
                                                <input type="text" value={modelBrand} onChange={(e) => setModelBrand(e.target.value)}
                                                    placeholder="ä¾‹å¦‚ï¼šASUS VivoBook 15"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* é¡åˆ¥ */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">é¡åˆ¥</label>
                                                <input type="text" value={category} onChange={(e) => setCategory(e.target.value)}
                                                    list="add-asset-category-list"
                                                    placeholder="é¸æ“‡æˆ–è¼¸å…¥é¡åˆ¥"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                                <datalist id="add-asset-category-list">
                                                    {dropdownData?.categories?.map(cat => (
                                                        <option key={cat} value={cat} />
                                                    ))}
                                                </datalist>
                                            </div>

                                            {/* å–å¾—æ—¥æœŸ */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">å–å¾—æ—¥æœŸ</label>
                                                <input type="date" value={purchaseDate} onChange={(e) => setPurchaseDate(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* ä½¿ç”¨å¹´é™ */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">ä½¿ç”¨å¹´é™ï¼ˆå¹´ï¼‰</label>
                                                <input type="number" value={useLife} onChange={(e) => setUseLife(e.target.value)}
                                                    min="0" placeholder="ä¾‹å¦‚ï¼š3"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>
                                        </div>

                                        {/* è³‡è¨Šè³‡ç”¢æ¨™è¨˜ */}
                                        <div className="mt-4 p-3 bg-white rounded-lg border border-slate-200">
                                            <label className="flex items-center cursor-pointer">
                                                <input type="checkbox" checked={isItAsset} onChange={(e) => setIsItAsset(e.target.checked)}
                                                    className="mr-2 w-4 h-4"
                                                />
                                                <span className="font-medium text-slate-700">æ­¤è¨­å‚™æ˜¯å¦ç‚ºè³‡è¨Šè³‡ç”¢ï¼Ÿ</span>
                                            </label>

                                            {/* å­é¸é … */}
                                            {isItAsset && (
                                                <div className="ml-6 mt-3 space-y-2">
                                                    <label className="flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={isActuallyComputer} onChange={(e) => setIsActuallyComputer(e.target.checked)}
                                                            className="mr-2 w-4 h-4"
                                                        />
                                                        <span className="text-slate-600">æ­¤è¨­å‚™ç‚ºé›»è…¦ä¸»æ©Ÿ/ç­†é›»</span>
                                                    </label>
                                                    <label className="flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={isIsoScope} onChange={(e) => setIsIsoScope(e.target.checked)}
                                                            className="mr-2 w-4 h-4"
                                                        />
                                                        <span className="text-slate-600">æ­¤è¨­å‚™æ˜¯å¦åœ¨ ISO é©—è­‰ç¯„åœå…§</span>
                                                    </label>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* å€å¡Š 3: ä¿ç®¡èˆ‡ä½ç½® */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-map-marker-alt mr-2 text-slate-500"></i>ä¿ç®¡èˆ‡ä½ç½®
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {/* ä¿ç®¡åœ°é» */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    ä¿ç®¡åœ°é» <span className="text-red-500">*</span>
                                                </label>
                                                <select value={location} onChange={(e) => setLocation(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                >
                                                    <option value="">è«‹é¸æ“‡åœ°é»...</option>
                                                    {dropdownData?.locations?.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* ä¿ç®¡äºº */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    ä¿ç®¡äºº <span className="text-red-500">*</span>
                                                </label>
                                                <select value={keeperEmail} onChange={(e) => {
                                                    setKeeperEmail(e.target.value);
                                                    if (!userEmail) setUserEmail(e.target.value);
                                                }}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                >
                                                    <option value="">è«‹é¸æ“‡ä¿ç®¡äºº...</option>
                                                    {sortedKeepers.map(([email, name]) => (
                                                        <option key={email} value={email}>{name} ({email})</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* ä½¿ç”¨äºº - åƒ…è²¡ç”¢æ¨¡å¼é¡¯ç¤º */}
                                            {assetType === 'property' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">ä½¿ç”¨äººï¼ˆé è¨­åŒä¿ç®¡äººï¼‰</label>
                                                    <select value={userEmail} onChange={(e) => setUserEmail(e.target.value)}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                    >
                                                        <option value="">åŒä¿ç®¡äºº</option>
                                                        {sortedKeepers.map(([email, name]) => (
                                                            <option key={email} value={email}>{name} ({email})</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* å€å¡Š 4: å‚™è¨» */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">å‚™è¨»</label>
                                        <textarea value={remarks} onChange={(e) => setRemarks(e.target.value)}
                                            rows="3" placeholder="é¸å¡«..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">
                                å–æ¶ˆ
                            </button>
                            <button onClick={handleSubmit} disabled={isSubmitting || isLoading} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (
                                    <><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æ–°å¢ä¸­...</span></>
                                ) : (
                                    <><i className="fas fa-check"></i><span>ç¢ºèªæ–°å¢</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== ç·¨è¼¯è³‡ç”¢ Modalï¼ˆåƒ…ç®¡ç†å“¡ï¼‰==========
        const EditAssetModal = ({ asset, onClose, onSuccess }) => {
            // è¼‰å…¥èˆ‡æäº¤ç‹€æ…‹
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [categories, setCategories] = useState([]);

            // è¡¨å–®ç‹€æ…‹ï¼ˆå¾ asset prop è¼‰å…¥åˆå§‹å€¼ï¼‰
            const [assetName, setAssetName] = useState(asset?.assetName || '');
            const [modelBrand, setModelBrand] = useState(asset?.modelBrand || '');
            const [category, setCategory] = useState(asset?.category || '');
            const [purchaseDate, setPurchaseDate] = useState(() => {
                // è™•ç†æ—¥æœŸæ ¼å¼è½‰æ›
                if (!asset?.purchaseDate) return '';
                const date = new Date(asset.purchaseDate);
                if (isNaN(date.getTime())) return '';
                return date.toISOString().split('T')[0];
            });
            const [useLife, setUseLife] = useState(asset?.useLife || '');
            const [isItAsset, setIsItAsset] = useState(asset?.isItAsset === 'æ˜¯');
            const [isActuallyComputer, setIsActuallyComputer] = useState(asset?.isActuallyComputer === 'æ˜¯');
            const [isIsoScope, setIsIsoScope] = useState(asset?.isIsoScope === 'æ˜¯');

            // è¼‰å…¥é¡åˆ¥é¸é …
            useEffect(() => {
                google.script.run
                    .withSuccessHandler((data) => {
                        setCategories(data.categories || []);
                        setIsLoading(false);
                    })
                    .withFailureHandler((error) => {
                        console.error('è¼‰å…¥é¡åˆ¥è³‡æ–™å¤±æ•—ï¼š', error);
                        setIsLoading(false);
                    })
                    .getDropdownData();
            }, []);

            // è³‡è¨Šè³‡ç”¢é€£å‹•é‚è¼¯ï¼šå–æ¶ˆä¸»é¸é …æ™‚æ¸…ç©ºå­é¸é …
            useEffect(() => {
                if (!isItAsset) {
                    setIsActuallyComputer(false);
                    setIsIsoScope(false);
                }
            }, [isItAsset]);

            // è¡¨å–®æäº¤
            const handleSubmit = () => {
                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!assetName.trim()) {
                    alert('è«‹å¡«å¯«åç¨±');
                    return;
                }

                setIsSubmitting(true);

                const updates = {
                    assetName: assetName.trim(),
                    modelBrand: modelBrand.trim(),
                    category: category.trim(),
                    purchaseDate: purchaseDate || '',
                    useLife: useLife || '',
                    isItAsset: isItAsset ? 'æ˜¯' : '',
                    isActuallyComputer: isActuallyComputer ? 'æ˜¯' : '',
                    isIsoScope: isIsoScope ? 'æ˜¯' : ''
                };

                google.script.run
                    .withSuccessHandler((message) => {
                        setIsSubmitting(false);
                        alert(message);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler((error) => {
                        setIsSubmitting(false);
                        alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
                    })
                    .updateAssetBasicInfo(asset.assetId, updates);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        {/* Header */}
                        <div className="bg-amber-50 px-6 py-4 border-b border-amber-100 rounded-t-2xl sticky top-0">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                        <i className="fa-solid fa-pen-to-square text-amber-600"></i>
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-slate-800">ä¿®æ”¹è³‡ç”¢åŸºæœ¬è³‡æ–™</h3>
                                        <p className="text-sm text-slate-500">ç·¨è™Ÿï¼š{asset?.assetId}</p>
                                    </div>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="w-8 h-8 rounded-lg hover:bg-amber-100 flex items-center justify-center transition-colors"
                                >
                                    <i className="fas fa-times text-slate-500"></i>
                                </button>
                            </div>
                        </div>

                        {/* Body */}
                        <div className="p-6 space-y-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-12">
                                    <i className="fas fa-spinner fa-spin text-2xl text-amber-500"></i>
                                    <span className="ml-3 text-slate-600">è¼‰å…¥ä¸­...</span>
                                </div>
                            ) : (
                                <>
                                    {/* åªè®€è³‡è¨Šå€ */}
                                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <h4 className="text-sm font-medium text-slate-700 mb-3 flex items-center gap-2">
                                            <i className="fas fa-info-circle text-slate-400"></i>
                                            è³‡ç”¢è³‡è¨Šï¼ˆä¸å¯ä¿®æ”¹ï¼‰
                                        </h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">ç·¨è™Ÿ</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.assetId || '-'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">ä¿ç®¡åœ°é»</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.location || '-'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">ä¿ç®¡äºº</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.leader || '-'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* å¯ç·¨è¼¯æ¬„ä½ */}
                                    <div className="space-y-4">
                                        <h4 className="text-sm font-medium text-slate-700 flex items-center gap-2">
                                            <i className="fas fa-edit text-amber-500"></i>
                                            å¯ä¿®æ”¹æ¬„ä½
                                        </h4>

                                        {/* åç¨±èˆ‡å‹è™Ÿ */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                                    åç¨± <span className="text-red-500">*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={assetName}
                                                    onChange={(e) => setAssetName(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="è«‹è¼¸å…¥åç¨±"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                                    å‹è™Ÿ/å» ç‰Œ
                                                </label>
                                                <input
                                                    type="text"
                                                    value={modelBrand}
                                                    onChange={(e) => setModelBrand(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="è«‹è¼¸å…¥å‹è™Ÿæˆ–å» ç‰Œ"
                                                />
                                            </div>
                                        </div>

                                        {/* é¡åˆ¥èˆ‡æ—¥æœŸ */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">é¡åˆ¥</label>
                                                <input
                                                    type="text"
                                                    list="edit-category-list"
                                                    value={category}
                                                    onChange={(e) => setCategory(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="é¸æ“‡æˆ–è¼¸å…¥é¡åˆ¥"
                                                />
                                                <datalist id="edit-category-list">
                                                    {categories.map((cat, idx) => (
                                                        <option key={idx} value={cat} />
                                                    ))}
                                                </datalist>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">å–å¾—æ—¥æœŸ</label>
                                                <input
                                                    type="date"
                                                    value={purchaseDate}
                                                    onChange={(e) => setPurchaseDate(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨å¹´é™ï¼ˆå¹´ï¼‰</label>
                                                <input
                                                    type="number"
                                                    value={useLife}
                                                    onChange={(e) => setUseLife(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="ä¾‹å¦‚ï¼š3"
                                                    min="0"
                                                />
                                            </div>
                                        </div>

                                        {/* è³‡è¨Šè³‡ç”¢æ¨™è¨˜ */}
                                        <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                            <h5 className="text-sm font-medium text-blue-800 mb-3 flex items-center gap-2">
                                                <i className="fas fa-laptop text-blue-500"></i>
                                                è³‡è¨Šè³‡ç”¢æ¨™è¨˜
                                            </h5>
                                            <div className="space-y-3">
                                                <label className="flex items-center gap-3 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={isItAsset}
                                                        onChange={(e) => setIsItAsset(e.target.checked)}
                                                        className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                    />
                                                    <span className="text-sm text-slate-700">æ­¤è¨­å‚™æ˜¯å¦ç‚ºè³‡è¨Šè³‡ç”¢ï¼Ÿ</span>
                                                </label>

                                                {/* å­é¸é …ï¼šåªåœ¨ isItAsset å‹¾é¸æ™‚é¡¯ç¤º */}
                                                {isItAsset && (
                                                    <div className="ml-7 space-y-2 pt-2 border-t border-blue-200">
                                                        <label className="flex items-center gap-3 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={isActuallyComputer}
                                                                onChange={(e) => setIsActuallyComputer(e.target.checked)}
                                                                className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                            />
                                                            <span className="text-sm text-slate-600">æ­¤è¨­å‚™ç‚ºé›»è…¦ä¸»æ©Ÿ/ç­†é›»</span>
                                                        </label>
                                                        <label className="flex items-center gap-3 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={isIsoScope}
                                                                onChange={(e) => setIsIsoScope(e.target.checked)}
                                                                className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                            />
                                                            <span className="text-sm text-slate-600">æ­¤è¨­å‚™æ˜¯å¦åœ¨ ISO é©—è­‰ç¯„åœå…§</span>
                                                        </label>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isLoading || isSubmitting}
                                className="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <><i className="fas fa-spinner fa-spin"></i><span>æ›´æ–°ä¸­...</span></>
                                ) : (
                                    <><i className="fas fa-save"></i><span>å„²å­˜è®Šæ›´</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== ç›¤é»ç¢ºèª Modalï¼ˆå–®ç­†/æ‰¹æ¬¡å…±ç”¨ï¼‰==========
            const InventoryConfirmModal = ({ asset, assetIds, isBatch, sessionId, availableSessions, defaultSessionId, isAdmin, onClose, onSuccess }) => {
            const [result, setResult] = useState('æ­£å¸¸');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const initialSessionId = isBatch ? sessionId : (defaultSessionId || sessionId || '');
            const [selectedSessionId, setSelectedSessionId] = useState(initialSessionId);

            useEffect(() => {
                setSelectedSessionId(initialSessionId);
            }, [initialSessionId]);

            const shouldShowSessionSelect = !isBatch && isAdmin && availableSessions && availableSessions.length > 1;
            const formatSessionLabel = (session) => {
                const datePart = session.inventoryDate ? session.inventoryDate : 'æœªæä¾›æ—¥æœŸ';
                const personPart = session.inventoryPerson || session.inventoryEmail || 'æœªæŒ‡å®šç›¤é»äºº';
                return `${datePart} / ${personPart}`;
            };

            const handleSubmit = () => {
                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤ç›¤é»çµæœ...');

                if (!selectedSessionId) {
                    hideFlyProgressBar('ç›¤é»å¤±æ•—', 0);
                    alert('è«‹é¸æ“‡ç›¤é»æœƒè©±');
                    setIsSubmitting(false);
                    return;
                }

                if (isBatch) {
                    // æ‰¹æ¬¡ç›¤é»
                    const assetResults = assetIds.map(id => ({
                        assetId: id,
                        result: result,
                        remarks: remarks
                    }));

                    google.script.run
                        .withSuccessHandler((response) => {
                            hideFlyProgressBar('ç›¤é»å®Œæˆï¼', 300);
                            alert(response.message);
                            setIsSubmitting(false);
                            onSuccess();
                            onClose();
                        })
                        .withFailureHandler((error) => {
                            hideFlyProgressBar('ç›¤é»å¤±æ•—', 0);
                            alert('ç›¤é»å¤±æ•—ï¼š' + error.message);
                            setIsSubmitting(false);
                        })
                        .markBatchInventory(selectedSessionId, assetResults);
                } else {
                    // å–®ç­†ç›¤é»
                    google.script.run
                        .withSuccessHandler((response) => {
                            hideFlyProgressBar('ç›¤é»å®Œæˆï¼', 300);
                            if (response.success) {
                                alert(response.message);
                                onSuccess();
                                onClose();
                            } else {
                                alert('ç›¤é»å¤±æ•—ï¼š' + response.error);
                            }
                            setIsSubmitting(false);
                        })
                        .withFailureHandler((error) => {
                            hideFlyProgressBar('ç›¤é»å¤±æ•—', 0);
                            alert('ç›¤é»å¤±æ•—ï¼š' + error.message);
                            setIsSubmitting(false);
                        })
                        .markAssetInventory(selectedSessionId, asset.assetId, result, remarks);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-teal-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-teal-800">
                                <i className="fa-solid fa-clipboard-check mr-2"></i>
                                {isBatch ? `æ‰¹æ¬¡ç›¤é»ç¢ºèª (${assetIds?.length || 0} ç­†)` : 'ç›¤é»ç¢ºèª'}
                            </h3>
                            <button onClick={onClose} className="text-teal-600 hover:text-teal-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Body */}
                        <div className="p-6 space-y-4">
                            {!isBatch && asset && (
                                <div className="bg-slate-50 rounded-lg p-4 space-y-2">
                                    <p><span className="font-medium text-slate-600">è²¡ç”¢ç·¨è™Ÿï¼š</span>{asset.assetId}</p>
                                    <p><span className="font-medium text-slate-600">è²¡ç”¢åç¨±ï¼š</span>{asset.assetName}</p>
                                    <p><span className="font-medium text-slate-600">ä¿ç®¡äººï¼š</span>{asset.leader || asset.keeperName}</p>
                                    <p><span className="font-medium text-slate-600">åœ°é»ï¼š</span>{asset.location}</p>
                                </div>
                            )}

                            {shouldShowSessionSelect && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">ç›¤é»æœƒè©±</label>
                                    <select
                                        value={selectedSessionId}
                                        onChange={(e) => setSelectedSessionId(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
                                    >
                                        {availableSessions.map(session => (
                                            <option key={session.inventoryId} value={session.inventoryId}>
                                                {formatSessionLabel(session)}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {/* ç›¤é»çµæœé¸é … */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ç›¤é»çµæœ</label>
                                <div className="space-y-2">
                                    {['æ­£å¸¸', 'éºå¤±', 'æå£'].map(opt => (
                                        <label key={opt} className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="radio"
                                                name="inventoryResult"
                                                value={opt}
                                                checked={result === opt}
                                                onChange={(e) => setResult(e.target.value)}
                                                className="w-4 h-4 text-teal-600"
                                            />
                                            <span className={`${opt === 'éºå¤±' ? 'text-red-600' : opt === 'æå£' ? 'text-orange-600' : 'text-green-600'}`}>
                                                {opt}
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* å‚™è¨» */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                                <textarea
                                    value={remarks}
                                    onChange={(e) => setRemarks(e.target.value)}
                                    rows="3"
                                    placeholder="è¼¸å…¥å‚™è¨»..."
                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
                                />
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <><i className="fas fa-spinner fa-spin"></i><span>æäº¤ä¸­...</span></>
                                ) : (
                                    <><i className="fas fa-check"></i><span>ç¢ºèªç›¤é»</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ä¸» App çµ„ä»¶
        function App() {
            const [isReady, setIsReady] = useState(false);
            const [allAssets, setAllAssets] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [viewMode, setViewMode] = useState('user');
            const [currentUserEmail, setCurrentUserEmail] = useState('');
            const [currentUserName, setCurrentUserName] = useState('');
            const [webAppUrl, setWebAppUrl] = useState('');
            const [pendingApprovalsData, setPendingApprovalsData] = useState([]);
            const [inventorySessions, setInventorySessions] = useState(null);
            const [filters, setFilters] = useState({
                status: '',
                category: '',
                leader: '',
                search: ''
            });
            const [activeModal, setActiveModal] = useState(null);
            const [isLoadingCards, setIsLoadingCards] = useState(false);
            const [lentAssetsDetails, setLentAssetsDetails] = useState(null);
            const [isLoadingLentDetails, setIsLoadingLentDetails] = useState(false);
            const [scrapPendingDetails, setScrapPendingDetails] = useState(null);
            const [transferPendingDetails, setTransferPendingDetails] = useState(null);
            const [transferPendingCount, setTransferPendingCount] = useState(0);
            const [isLoadingScrapDetails, setIsLoadingScrapDetails] = useState(false);
            const [isLoadingTransferDetails, setIsLoadingTransferDetails] = useState(false);

            // è½‰ç§»ä¸­ï¼ˆæˆ‘ç”³è«‹çš„è½‰ç§»ï¼‰ç›¸é—œ state
            const [transferringCount, setTransferringCount] = useState(0);
            const [transferringAssets, setTransferringAssets] = useState(null);
            const [isLoadingTransferring, setIsLoadingTransferring] = useState(false);

            // å¿«é€Ÿæ“ä½œ Modal ç›¸é—œ state
            const [quickActionModalType, setQuickActionModalType] = useState(null); // 'transfer', 'lending', 'scrap'
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [transferOptions, setTransferOptions] = useState(null);
            const [lendingOptions, setLendingOptions] = useState(null);

            // æ‰¹æ¬¡æ“ä½œ Modal ç›¸é—œ state
            const [batchModalType, setBatchModalType] = useState(null); // 'transfer', 'lending', 'scrap'
            const [batchActionAssetIds, setBatchActionAssetIds] = useState([]);

            // æ–°å¢è³‡ç”¢ Modal ç›¸é—œ state
            const [showAddAssetModal, setShowAddAssetModal] = useState(false);
            const [addAssetDropdownData, setAddAssetDropdownData] = useState(null);

            // ç·¨è¼¯è³‡ç”¢ Modal ç›¸é—œ stateï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
            const [showEditAssetModal, setShowEditAssetModal] = useState(false);
            const [editingAsset, setEditingAsset] = useState(null);

            // è³‡ç”¢é¸å–ç‹€æ…‹ï¼ˆèˆ‡ BatchList åŒæ­¥ï¼‰
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);

            // ç›¤é»ç®¡ç† Modal ç›¸é—œ state
            const [showInventoryMgmtModal, setShowInventoryMgmtModal] = useState(false);

            // ç›¤é»ç›¸é—œç‹€æ…‹
            const [inventoryPendingByAsset, setInventoryPendingByAsset] = useState({});
            const [pendingInventoryItems, setPendingInventoryItems] = useState([]);
            const [isLoadingPendingInventory, setIsLoadingPendingInventory] = useState(false);
            const [pendingInventoryError, setPendingInventoryError] = useState('');
            const [currentInventorySessionId, setCurrentInventorySessionId] = useState(null);
            const [showInventoryModal, setShowInventoryModal] = useState(false);
            const [inventoryModalAsset, setInventoryModalAsset] = useState(null); // å–®ç­†ç›¤é»
            const [inventoryModalSessions, setInventoryModalSessions] = useState([]);
            const [inventoryModalSessionId, setInventoryModalSessionId] = useState('');
            const [showBatchInventoryModal, setShowBatchInventoryModal] = useState(false);
            const [selectedInventoryAssetIds, setSelectedInventoryAssetIds] = useState([]);
            const [batchInventorySessionId, setBatchInventorySessionId] = useState('');
            const [currentUserGroup, setCurrentUserGroup] = useState('');

            const isAdminView = isAdmin && viewMode === 'admin';
            const normalizeEmail = (value) => String(value || '').trim().toLowerCase();
            const isInventoryTaskOnly = useCallback((asset) => {
                if (!asset) return false;
                if (isAdminView) return false;
                const currentEmail = normalizeEmail(currentUserEmail);
                if (!currentEmail) return false;
                const leaderEmail = normalizeEmail(asset.leaderEmail);
                const userEmail = normalizeEmail(asset.userEmail);
                return leaderEmail !== currentEmail && userEmail !== currentEmail;
            }, [isAdminView, currentUserEmail]);
            const assetIndex = useMemo(() => {
                const map = new Map();
                (allAssets || []).forEach(asset => {
                    map.set(asset.assetId, asset);
                });
                return map;
            }, [allAssets]);
            const resolveAssetIsTask = useCallback((assetId) => {
                const checkbox = document.querySelector(`.asset-checkbox[value="${assetId}"]`);
                if (checkbox && checkbox.dataset && checkbox.dataset.isTask) {
                    return checkbox.dataset.isTask === 'true';
                }
                const asset = assetIndex.get(assetId);
                return asset ? isInventoryTaskOnly(asset) : false;
            }, [assetIndex, isInventoryTaskOnly]);
            const getSelectedAssetsForAction = useCallback((actionType) => {
                if (typeof BatchList_getItems !== 'function') {
                    return [];
                }
                const selectedIds = BatchList_getItems();
                if (actionType === 'INVENTORY') {
                    return selectedIds;
                }
                let blockedCount = 0;
                const allowed = selectedIds.filter(assetId => {
                    const isTask = resolveAssetIsTask(assetId);
                    if (isTask) {
                        blockedCount += 1;
                        return false;
                    }
                    return true;
                });
                if (blockedCount > 0) {
                    const message = `å·²è‡ªå‹•æ’é™¤ ${blockedCount} ç­†åŒçµ„æˆå“¡è³‡ç”¢ï¼Œåƒ…ä¿ç•™å¯æ“ä½œçš„é …ç›®ã€‚`;
                    if (typeof window.BatchList_showToast === 'function') {
                        window.BatchList_showToast(message, 'warning');
                    } else {
                        alert(message);
                    }
                }
                return allowed;
            }, [resolveAssetIsTask]);

            // è™•ç†å–®å€‹è³‡ç”¢é¸å–
            const handleAssetSelect = useCallback((assetId) => {
                setSelectedAssetIds(prev => {
                    const isSelected = prev.includes(assetId);
                    let newSelection;

                    if (isSelected) {
                        // å–æ¶ˆé¸å–
                        newSelection = prev.filter(id => id !== assetId);
                        if (typeof window.BatchList_removeItem === 'function') {
                            window.BatchList_removeItem(assetId);
                        }
                    } else {
                        // é¸å–
                        newSelection = [...prev, assetId];
                        if (typeof window.BatchList_addItem === 'function') {
                            window.BatchList_addItem(assetId);
                        }
                    }
                    return newSelection;
                });
            }, []);

            // ç›£è½ BatchList è®ŠåŒ–ä¸¦åŒæ­¥ï¼ˆè™•ç† Scanner Enter éµæƒæçš„æƒ…æ³ï¼‰
            useEffect(() => {
                const syncFromBatchList = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        const batchItems = window.BatchList_getItems();
                        setSelectedAssetIds(prev => {
                            // åªæ·»åŠ æ–°çš„é …ç›®ï¼Œä¸ç§»é™¤èˆŠçš„
                            const newItems = batchItems.filter(id => !prev.includes(id));
                            if (newItems.length > 0) {
                                return [...prev, ...newItems];
                            }
                            return prev;
                        });
                    }
                };

                // å®šæœŸåŒæ­¥ï¼ˆè™•ç†å¤–éƒ¨æ·»åŠ çš„æƒ…æ³ï¼‰
                const interval = setInterval(syncFromBatchList, 500);
                return () => clearInterval(interval);
            }, []);

            // ========== ç›¤é»åŠŸèƒ½è¼”åŠ©å‡½æ•¸ ==========

            const buildInventoryPendingByAsset = useCallback((pendingItems) => {
                const map = {};
                (pendingItems || []).forEach(item => {
                    const assetId = String(item.assetId || '').trim();
                    if (!assetId) return;
                    if (!map[assetId]) {
                        map[assetId] = {
                            assetId: assetId,
                            assetName: item.assetName || '',
                            keeperName: item.keeperName || '',
                            userName: item.userName || '',
                            location: item.location || '',
                            sessions: []
                        };
                    }

                    const sessions = map[assetId].sessions;
                    const exists = sessions.some(s => s.inventoryId === item.inventoryId);
                    if (!exists) {
                        sessions.push({
                            inventoryId: item.inventoryId,
                            inventoryDate: item.inventoryDate || '',
                            inventoryPerson: item.inventoryPerson || '',
                            inventoryEmail: item.inventoryEmail || ''
                        });
                    }
                });
                return map;
            }, []);

            const loadPendingInventoryAssignments = useCallback((forceUserScope, options = {}) => {
              const { onComplete } = options;
              google.script.run
                .withSuccessHandler((response) => {
                  if (!response) {
                    setInventoryPendingByAsset({});
                    setPendingInventoryItems([]);
                    if (typeof onComplete === 'function') {
                      onComplete(new Error('æ²’æœ‰å›æ‡‰'));
                    }
                    return;
                  }
                  if (response.error) {
                    console.warn('è¼‰å…¥ç›¤é»å¾…è¾¦å¤±æ•—ï¼š', response.error);
                    setInventoryPendingByAsset({});
                    setPendingInventoryItems([]);
                    if (typeof onComplete === 'function') {
                      onComplete(new Error(response.error));
                    }
                    return;
                  }
                  const pendingItems = response.pendingItems || [];
                  const map = buildInventoryPendingByAsset(pendingItems);
                  setInventoryPendingByAsset(map);
                  setPendingInventoryItems(pendingItems);
                  if (typeof onComplete === 'function') {
                    onComplete(null, response);
                  }
                })
                .withFailureHandler((error) => {
                  console.error('è¼‰å…¥ç›¤é»å¾…è¾¦å¤±æ•—:', error);
                  setInventoryPendingByAsset({});
                  setPendingInventoryItems([]);
                  if (typeof onComplete === 'function') {
                    onComplete(error);
                  }
                })
                .getPendingInventoryAssignments(forceUserScope);
            }, [buildInventoryPendingByAsset]);

            const getAssetPendingSessions = useCallback((assetId) => {
                const entry = inventoryPendingByAsset[assetId];
                return entry ? entry.sessions || [] : [];
            }, [inventoryPendingByAsset]);

            // æª¢æŸ¥è³‡ç”¢æ˜¯å¦åœ¨å¾…ç›¤é»æ¸…å–®ä¸­ï¼ˆå¯æŒ‡å®šç›¤é»æœƒè©±ï¼‰
            const isAssetPendingInventory = useCallback((assetId, sessionId) => {
                const sessions = getAssetPendingSessions(assetId);
                if (sessions.length === 0) return false;
                if (!sessionId) return true;
                return sessions.some(session => session.inventoryId === sessionId);
            }, [getAssetPendingSessions]);

            // è¼‰å…¥è³‡æ–™
            const loadData = (overrideViewMode) => {
                showFlyProgressBar('æ­£åœ¨è¼‰å…¥è²¡ç”¢ç‹€æ…‹è³‡æ–™...');
                setIsLoadingCards(true); // åˆå§‹è¼‰å…¥æ™‚ä¹Ÿé¡¯ç¤ºå¡ç‰‡è¼‰å…¥å‹•ç•«
                const effectiveViewMode = overrideViewMode || viewMode;
                const forceUserScope = effectiveViewMode === 'user';

                google.script.run
                    .withSuccessHandler(url => {
                        setWebAppUrl(url);

                        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å¤±æ•—ï¼š' + response.error);
                                    hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                    return;
                                }

                                // âœ¨ æ–¹æ¡ˆ Bï¼šé è™•ç†æœå°‹æ–‡å­—ï¼Œé¿å…æ¯æ¬¡æœå°‹éƒ½é‡æ–°è¨ˆç®—
                                const processedAssets = (response.assets || []).map(asset => ({
                                    ...asset,
                                    searchText: [
                                        asset.assetId,
                                        asset.assetName,
                                        asset.leader,
                                        asset.location
                                    ].filter(Boolean).join(' ').toLowerCase()
                                }));
                                setAllAssets(processedAssets);
                                setIsAdmin(response.isAdmin);
                                if (!response.isAdmin) {
                                    setViewMode('user');
                                }
                                setCurrentUserEmail(response.userEmail);
                                setCurrentUserName(response.userName || '');

                                let pendingLoaded = false;
                                let inventoryLoaded = false;
                                const finishCardLoading = () => {
                                    if (pendingLoaded && inventoryLoaded) {
                                        setIsLoadingCards(false);
                                    }
                                };

                                // è¼‰å…¥å¾…æ¥æ”¶è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(pendingResponse => {
                                        if (pendingResponse && pendingResponse.approvals) {
                                            setPendingApprovalsData(pendingResponse.approvals);
                                        }
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥å¾…æ¥æ”¶æ¸…å–®å¤±æ•—ï¼š', error.message);
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getPendingApprovals(forceUserScope);

                                // è¼‰å…¥ç›¤é»è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(inventoryResponse => {
                                        if (inventoryResponse) {
                                            setInventorySessions(inventoryResponse);
                                            setCurrentUserGroup(inventoryResponse.currentUserGroup || '');

                                            // å¦‚æœ‰é€²è¡Œä¸­æœƒè©±ï¼Œè¼‰å…¥è©³æƒ…ä»¥ç²å–å¾…ç›¤é»è³‡ç”¢
                                            if (inventoryResponse.activeSessions && inventoryResponse.activeSessions.length > 0) {
                                                const sessionId = inventoryResponse.activeSessions[0].inventoryId;
                                                setCurrentInventorySessionId(sessionId);
                                            }
                                        }
                                        loadPendingInventoryAssignments(forceUserScope);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥ç›¤é»è³‡æ–™å¤±æ•—ï¼š', error.message);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getInventoryData(forceUserScope);

                                // è¼‰å…¥è½‰ç§»å¾…åˆ—å°æ•¸é‡
                                google.script.run
                                    .withSuccessHandler(count => {
                                        if (typeof count === 'number') {
                                            setTransferPendingCount(count);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»æ•¸é‡å¤±æ•—ï¼š', error.message);
                                        setTransferPendingCount(0);
                                    })
                                    .getTransferableItemsCount(forceUserScope);

                                // è¼‰å…¥æˆ‘ç”³è«‹çš„è½‰ç§»ä¸­è³‡ç”¢æ•¸é‡
                                google.script.run
                                    .withSuccessHandler(response => {
                                        if (response && typeof response.count === 'number') {
                                            setTransferringCount(response.count);
                                            setTransferringAssets(response.assets || []);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»ä¸­æ•¸é‡å¤±æ•—ï¼š', error.message);
                                        setTransferringCount(0);
                                        setTransferringAssets(null);
                                    })
                                    .getTransferringAssets(forceUserScope);

                                // è¼‰å…¥è½‰ç§»é¸é …è³‡æ–™ï¼ˆä¿ç®¡äººã€åœ°é»ç­‰ï¼‰
                                google.script.run
                                    .withSuccessHandler(transferData => {
                                        if (transferData && !transferData.error) {
                                            setTransferOptions(transferData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»é¸é …å¤±æ•—ï¼š', error.message);
                                    })
                                    .getTransferData();

                                // è¼‰å…¥å‡ºå€Ÿé¸é …è³‡æ–™ï¼ˆå€Ÿç”¨äººã€åœ°é»ï¼‰
                                google.script.run
                                    .withSuccessHandler(lendingData => {
                                        if (lendingData && !lendingData.error) {
                                            setLendingOptions(lendingData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥å‡ºå€Ÿé¸é …å¤±æ•—ï¼š', error.message);
                                    })
                                    .getLendingData();

                                // é å…ˆè¼‰å…¥å‡ºå€Ÿä¸­æ¸…å–®
                                google.script.run
                                    .withSuccessHandler(response => {
                                        if (response && !response.error) {
                                            setLentAssetsDetails(response.assets || []);
                                        } else {
                                            setLentAssetsDetails(null);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('é å…ˆè¼‰å…¥å‡ºå€Ÿæ¸…å–®å¤±æ•—ï¼š', error.message);
                                        setLentAssetsDetails(null);
                                    })
                                    .getLentOutAssets(forceUserScope);

                                setIsReady(true);
                                hideFlyProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
                            })
                            .withFailureHandler(error => {
                                setIsLoadingCards(false); // å¤±æ•—æ™‚ä¹Ÿé—œé–‰å¡ç‰‡å‹•ç•«
                                hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                alert('éŒ¯èª¤ï¼š' + error.message);
                            })
                            .getUserStateData(forceUserScope);
                    })
                    .getAppUrl();
            };

            // é‡æ–°æ•´ç†å¡ç‰‡æ•¸æ“šï¼ˆä¸¦è¡Œè¼‰å…¥ï¼‰
            const refreshCardData = useCallback(async () => {
                const MIN_LOADING_DURATION = 500; // æœ€çŸ­é¡¯ç¤ºæ™‚é–“ 500ms
                setIsLoadingCards(true);
                const startTime = Date.now();
                const forceUserScope = viewMode === 'user';

                try {
                    // ä¸¦è¡Œè¼‰å…¥äº”å€‹ API
                    const [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse, transferringResponse, pendingInventoryResponse, lentResponse] = await Promise.allSettled([
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingApprovals(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getInventoryData(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getUserStateData(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferableItemsCount(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferringAssets(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingInventoryAssignments(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getLentOutAssets(forceUserScope);
                        })
                    ]);

                    // è™•ç†æˆåŠŸçš„çµæœ
                    if (pendingResponse.status === 'fulfilled' && pendingResponse.value?.approvals) {
                        setPendingApprovalsData(pendingResponse.value.approvals);
                    }
                    if (inventoryResponse.status === 'fulfilled' && inventoryResponse.value) {
                        setInventorySessions(inventoryResponse.value);
                    }
                    if (assetsResponse.status === 'fulfilled' && assetsResponse.value?.assets) {
                        // âœ¨ æ–¹æ¡ˆ Bï¼šé è™•ç†æœå°‹æ–‡å­—
                        const processedAssets = assetsResponse.value.assets.map(asset => ({
                            ...asset,
                            searchText: [
                                asset.assetId,
                                asset.assetName,
                                asset.leader,
                                asset.location
                            ].filter(Boolean).join(' ').toLowerCase()
                        }));
                        setAllAssets(processedAssets);
                    }
                    if (transferCountResponse.status === 'fulfilled' && typeof transferCountResponse.value === 'number') {
                        setTransferPendingCount(transferCountResponse.value);
                    }
                    if (transferringResponse.status === 'fulfilled' && typeof transferringResponse.value?.count === 'number') {
                        setTransferringCount(transferringResponse.value.count);
                        setTransferringAssets(transferringResponse.value.assets || []);
                    }
                    if (pendingInventoryResponse.status === 'fulfilled') {
                      const response = pendingInventoryResponse.value;
                      if (response && !response.error) {
                        const pendingItems = response.pendingItems || [];
                        const map = buildInventoryPendingByAsset(pendingItems);
                        setInventoryPendingByAsset(map);
                        setPendingInventoryItems(pendingItems);
                      } else {
                        setInventoryPendingByAsset({});
                        setPendingInventoryItems([]);
                      }
                    }
                    if (lentResponse.status === 'fulfilled') {
                        const response = lentResponse.value;
                        if (response && !response.error) {
                            setLentAssetsDetails(response.assets || []);
                        } else {
                            setLentAssetsDetails(null);
                        }
                    }

                    // æª¢æŸ¥å¤±æ•—çš„è«‹æ±‚
                    const failures = [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse, transferringResponse, pendingInventoryResponse, lentResponse]
                        .filter(r => r.status === 'rejected');
                    if (failures.length > 0) {
                        console.warn('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š', failures);
                        alert('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                    }

                    // ç¢ºä¿æœ€çŸ­é¡¯ç¤ºæ™‚é–“
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, MIN_LOADING_DURATION - elapsedTime);

                    setTimeout(() => {
                        setIsLoadingCards(false);
                    }, remainingTime);

                } catch (error) {
                    setIsLoadingCards(false);
                    console.error('é‡æ–°æ•´ç†å¤±æ•—ï¼š', error);
                    alert('é‡æ–°æ•´ç†å¤±æ•—ï¼š' + error.message);
                }
            }, [buildInventoryPendingByAsset, viewMode]);

            // é‡æ–°æ•´ç†æŒ‰éˆ•é»æ“Šè™•ç†
            const handleRefreshCards = () => {
                refreshCardData();
            };

            const handleViewModeChange = (mode) => {
                if (!isAdmin) return;
                if (mode === viewMode) return;
                setViewMode(mode);
                setTransferringAssets(null);
                setLentAssetsDetails(null);
                loadData(mode);
            };

            useEffect(() => {
                if (!isAdminView && showInventoryMgmtModal) {
                    setShowInventoryMgmtModal(false);
                }
            }, [isAdminView, showInventoryMgmtModal]);

            useEffect(() => {
                loadData();

                // è¨­å®šå…¨åŸŸåˆ·æ–°å‡½æ•¸
                window.refreshReactData = () => {
                    loadData();
                };
            }, []);

            // åŒæ­¥ç‹€æ…‹åˆ°å…¨åŸŸè®Šæ•¸ä¾› jQuery Modal ä½¿ç”¨
            useEffect(() => {
                window.pendingApprovals = pendingApprovalsData;
            }, [pendingApprovalsData]);

            // è¨ˆç®—ç¯©é¸å¾Œçš„è³‡ç”¢
            const filteredAssets = useMemo(() => {
                // âœ¨ æ–¹æ¡ˆ Bï¼šé è™•ç†æœå°‹é—œéµå­—ï¼ˆåªè¨ˆç®—ä¸€æ¬¡ï¼‰
                const searchLower = filters.search ? filters.search.toLowerCase() : '';

                return allAssets.filter(asset => {
                    const statusMatch = !filters.status || asset.status === filters.status;
                    const categoryMatch = !filters.category || asset.category === filters.category;
                    const leaderMatch = !filters.leader || asset.leader === filters.leader;
                    // âœ¨ ä½¿ç”¨é è™•ç†çš„ searchTextï¼Œé¿å…æ¯ç­†è³‡ç”¢é‡è¤‡è¨ˆç®— toUpperCase()
                    const searchMatch = !searchLower ||
                        (asset.searchText && asset.searchText.includes(searchLower));
                    return statusMatch && categoryMatch && leaderMatch && searchMatch;
                });
            }, [allAssets, filters]);

            // è™•ç†å…¨é¸ï¼ˆå¿…é ˆåœ¨ filteredAssets å®šç¾©ä¹‹å¾Œï¼‰
            const handleSelectAll = useCallback((checked) => {
                const selectableAssets = filteredAssets.filter(a => a.status === 'åœ¨åº«');
                const selectableIds = selectableAssets.map(a => a.assetId);

                // âœ¨ å–å¾—ä¸Šé™å€¼ï¼ˆé è¨­ 500ï¼‰
                const MAX_BATCH_SIZE = typeof window.BatchList_getMaxSize === 'function'
                    ? window.BatchList_getMaxSize()
                    : 500;

                if (checked) {
                    // âœ¨ æ•¸é‡é æª¢æŸ¥ï¼šè¶…éä¸Šé™æ™‚å½ˆå‡ºè­¦å‘Š
                    if (selectableIds.length > MAX_BATCH_SIZE) {
                        const proceed = window.confirm(
                            `æ‚¨å³å°‡é¸å– ${selectableIds.length} ç­†è³‡ç”¢ï¼Œè¶…éå»ºè­°ä¸Šé™ ${MAX_BATCH_SIZE} ç­†ã€‚\n` +
                            `å¤§é‡é¸å–å¯èƒ½é€ æˆé é¢åæ‡‰ç·©æ…¢ã€‚\n\n` +
                            `é»æ“Šã€Œå–æ¶ˆã€å°‡ä¸æœƒé¸æ“‡ä»»ä½•è³‡ç”¢\n` +
                            `é»æ“Šã€Œç¢ºèªã€å°‡è‡ªå‹•é¸æ“‡å‰${MAX_BATCH_SIZE} ç­†è³‡ç”¢\n`
                        );
                        if (!proceed) return;
                    }

                    // âœ¨ å…¨é¸ï¼šä½¿ç”¨æ‰¹é‡ API æå‡æ•ˆèƒ½
                    setSelectedAssetIds(prev => {
                        const newIds = selectableIds.filter(id => !prev.includes(id));
                        if (typeof window.BatchList_addItems === 'function') {
                            // ä½¿ç”¨æ‰¹é‡æ–°å¢ï¼ˆä¸€æ¬¡æ€§æ›´æ–° UIï¼‰
                            window.BatchList_addItems(newIds);
                        } else if (typeof window.BatchList_addItemSilent === 'function') {
                            // é™ç´šï¼šéœé»˜æ–°å¢å¾Œä¸€æ¬¡æ€§æ›´æ–°
                            newIds.forEach(id => window.BatchList_addItemSilent(id));
                            if (typeof window.BatchList_updateUI === 'function') {
                                window.BatchList_updateUI();
                            }
                        } else {
                            // æœ€çµ‚é™ç´šï¼šé€ç­†åŠ å…¥
                            newIds.forEach(id => {
                                if (typeof window.BatchList_addItem === 'function') {
                                    window.BatchList_addItem(id);
                                }
                            });
                        }
                        return [...new Set([...prev, ...selectableIds])];
                    });
                } else {
                    // å–æ¶ˆå…¨é¸
                    setSelectedAssetIds(prev => {
                        selectableIds.forEach(id => {
                            if (typeof window.BatchList_removeItem === 'function') {
                                window.BatchList_removeItem(id);
                            }
                        });
                        return prev.filter(id => !selectableIds.includes(id));
                    });
                }
            }, [filteredAssets]);

            // è¨ˆç®—é‡è¤‡ç”¢ç·¨
            const duplicateInfo = useMemo(() => {
                const map = new Map();
                const duplicates = new Map();
                let duplicateCount = 0;

                filteredAssets.forEach(asset => {
                    const key = String(asset.assetId || '').trim();
                    if (map.has(key)) {
                        duplicateCount += 1;
                        const existing = map.get(key);
                        if (!duplicates.has(key)) {
                            duplicates.set(key, [existing]);
                        }
                        duplicates.get(key).push(asset);
                    } else {
                        map.set(key, asset);
                    }
                });

                const groups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                    assetId,
                    items
                }));

                return { duplicateCount, groups };
            }, [filteredAssets]);

            // åŒæ­¥é‡è¤‡ç”¢ç·¨è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
            useEffect(() => {
                window.duplicateGroups = duplicateInfo.groups;
            }, [duplicateInfo.groups]);

            // åŒæ­¥ã€Œåœ¨åº«ã€è³‡ç”¢åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾› BatchList å’Œ Scanner æ¨¡çµ„ä½¿ç”¨
            useEffect(() => {
                // âš ï¸ åªåŒ…å«ã€Œåœ¨åº«ã€ç‹€æ…‹çš„è³‡ç”¢ï¼Œé™åˆ¶å¯é¸å–ç¯„åœ
                window.allAssets = allAssets
                    .filter(asset => asset.status === 'åœ¨åº«')
                    .map(asset => ({
                        id: asset.assetId,
                        assetName: asset.assetName,
                        keeperName: asset.leader,
                        location: asset.location,
                        status: asset.status
                    }));

                // é‡å»º BatchList ç´¢å¼•
                if (typeof window.BatchList_rebuildIndex === 'function') {
                    window.BatchList_rebuildIndex();
                }

                // âœ¨ é‡æ–°åˆå§‹åŒ– Scanner æœå°‹æ¡†å¢å¼·ï¼ˆReact å‹•æ…‹æ¸²æŸ“å¾Œéœ€é‡æ–°ç¶å®šï¼‰
                if (typeof window.Scanner_enhanceSearchBox === 'function') {
                    setTimeout(() => {
                        window.Scanner_enhanceSearchBox();
                        console.log('[App] å·²é‡æ–°åˆå§‹åŒ– Scanner æœå°‹æ¡†å¢å¼·');
                    }, 100);
                }

                console.log('[App] å·²æ›´æ–° window.allAssetsï¼Œå…±', window.allAssets.length, 'ç­†ã€Œåœ¨åº«ã€è³‡ç”¢');
            }, [allAssets]);

            // è¨ˆç®—å¡ç‰‡çµ±è¨ˆæ•¸é‡
            const cardCounts = useMemo(() => {
                // âœ¨ ç›´æ¥ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„å¾…ç›¤é»è³‡ç”¢æ•¸é‡ï¼ˆç®¡ç†å“¡é¡¯ç¤ºå…¨åŸŸï¼‰
                const inventoryCount = isAdminView
                    ? (inventorySessions?.totalPendingInventoryCount || inventorySessions?.myPendingInventoryCount || 0)
                    : (inventorySessions?.myPendingInventoryCount || 0);

                const scrapPendingCount = (() => {
                    const scrappingAssets = allAssets.filter(a => a.status === 'å ±å»¢ä¸­');
                    if (isAdminView) {
                        return scrappingAssets.length;
                    } else {
                        return scrappingAssets.filter(a =>
                            a.leaderEmail?.toLowerCase() === currentUserEmail.toLowerCase() ||
                            a.userEmail?.toLowerCase() === currentUserEmail.toLowerCase()
                        ).length;
                    }
                })();

                return {
                    transferring: transferringCount,  // æˆ‘ç”³è«‹çš„è½‰ç§»ä¸­è³‡ç”¢
                    pending: pendingApprovalsData.length,
                    lent: allAssets.filter(a => a.status === 'å‡ºå€Ÿä¸­').length,
                    scrapPending: scrapPendingCount,
                    transferPending: transferPendingCount,
                    inventory: inventoryCount
                };
            }, [allAssets, pendingApprovalsData, inventorySessions, currentUserEmail, isAdminView, transferPendingCount, transferringCount]);

            // è™•ç†å¡ç‰‡é»æ“Š
            const handleCardClick = (cardId) => {
                switch(cardId) {
                    case 'transferring':
                        // è¨­å®šè¼‰å…¥ç‹€æ…‹ä¸¦æ‰“é–‹ modal
                        setActiveModal('transferring');

                        if (transferringAssets !== null) {
                            setIsLoadingTransferring(false);
                            return;
                        }

                        setIsLoadingTransferring(true);
                        // èª¿ç”¨å¾Œç«¯ç²å–è½‰ç§»ä¸­è³‡ç”¢è©³æƒ…
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥è½‰ç§»ä¸­è³‡æ–™å¤±æ•—ï¼š' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingTransferring(false);
                                    return;
                                }
                                setTransferringAssets(response.assets || []);
                                setIsLoadingTransferring(false);
                            })
                            .withFailureHandler(error => {
                                console.error('è¼‰å…¥è½‰ç§»ä¸­è©³æƒ…å¤±æ•—ï¼š', error.message);
                                alert('è¼‰å…¥è½‰ç§»ä¸­è©³æƒ…å¤±æ•—ï¼š' + error.message);
                                setActiveModal(null);
                                setIsLoadingTransferring(false);
                            })
                            .getTransferringAssets(viewMode === 'user');
                        break;
                    case 'pending':
                        window.openPendingApprovalModal();
                        break;
                    case 'lent':
                        // è¨­å®šè¼‰å…¥ç‹€æ…‹ä¸¦æ‰“é–‹ modal
                        setActiveModal('lent');

                        if (lentAssetsDetails !== null) {
                            setIsLoadingLentDetails(false);
                            return;
                        }

                        setIsLoadingLentDetails(true);
                        // èª¿ç”¨å¾Œç«¯ç²å–è©³ç´°å‡ºå€Ÿè³‡è¨Š
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å‡ºå€Ÿè³‡æ–™å¤±æ•—ï¼š' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingLentDetails(false);
                                    return;
                                }
                                setLentAssetsDetails(response.assets || []);
                                setIsLoadingLentDetails(false);
                            })
                            .withFailureHandler(error => {
                                console.error('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š', error.message);
                                alert('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š' + error.message);
                                setActiveModal(null);
                                setIsLoadingLentDetails(false);
                            })
                            .getLentOutAssets(viewMode === 'user');
                        break;
                    case 'scrapPending':
                        setIsLoadingScrapDetails(true);
                        setActiveModal('scrapPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('è²¡ç”¢', viewMode === 'user');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('ç‰©å“', viewMode === 'user');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingScrapDetails(false);
                                return;
                            }

                            setScrapPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingScrapDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingScrapDetails(false);
                        });
                        break;
                    case 'transferPending':
                        setIsLoadingTransferDetails(true);
                        setActiveModal('transferPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('è²¡ç”¢', viewMode === 'user');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('ç‰©å“', viewMode === 'user');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingTransferDetails(false);
                                return;
                            }

                            setTransferPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingTransferDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingTransferDetails(false);
                        });
                        break;
                    case 'inventory':
                        setActiveModal('inventoryPending');
                        setPendingInventoryError('');
                        setIsLoadingPendingInventory(true);
                        loadPendingInventoryAssignments(viewMode === 'user', {
                          onComplete: (error) => {
                            setIsLoadingPendingInventory(false);
                            if (error) {
                              setPendingInventoryError(error.message || 'è¼‰å…¥å¤±æ•—');
                            }
                          }
                        });
                        break;
                }
            };

            // è™•ç†ç¯©é¸è®Šæ›´ï¼ˆä½¿ç”¨ useCallback ç©©å®šå¼•ç”¨ï¼‰
            const handleFilterChange = useCallback((filterName, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterName]: value
                }));
            }, []);

            // âœ¨ æ³¨æ„ï¼šwindow.clearSearchBox å·²ç§»è‡³ FilterSection çµ„ä»¶ä¸­å®šç¾©
            // é€™æ¨£å¯ä»¥åŒæ™‚æ¸…ç©º localSearchï¼ˆè¼¸å…¥æ¡†é¡¯ç¤ºå€¼ï¼‰å’Œ filters.searchï¼ˆç¯©é¸å€¼ï¼‰

            // å¿«é€Ÿæ“ä½œ Modal é–‹å•Ÿå‡½æ•¸
            const handleOpenTransferModal = (asset) => {
                if (!transferOptions) {
                    alert('è½‰ç§»é¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('transfer');
            };

            const handleOpenLendingModal = (asset) => {
                if (!lendingOptions) {
                    alert('å‡ºå€Ÿé¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('lending');
            };

            const handleOpenScrapModal = (asset) => {
                setSelectedAsset(asset);
                setQuickActionModalType('scrap');
            };

            const handleCloseQuickActionModal = () => {
                setQuickActionModalType(null);
                setSelectedAsset(null);
            };

            const handleQuickActionSuccess = () => {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            };

            // ========== ç·¨è¼¯è³‡ç”¢ Modal è™•ç†å‡½æ•¸ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰==========
            const handleOpenEditModal = (asset) => {
                setEditingAsset(asset);
                setShowEditAssetModal(true);
            };

            const handleEditAssetSuccess = useCallback(() => {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            }, []);

            // ========== ç›¤é»æ“ä½œè™•ç†å‡½æ•¸ ==========
            // é–‹å•Ÿå–®ç­†ç›¤é» Modal
                    const handleOpenInventoryModal = (asset) => {
                        const sessions = getAssetPendingSessions(asset.assetId);
                        if (!sessions || sessions.length === 0) {
                            alert('æ­¤è³‡ç”¢ç›®å‰æ²’æœ‰å¾…ç›¤é»çš„æœƒè©±');
                            return;
                        }
                const defaultSessionId = currentInventorySessionId && sessions.some(s => s.inventoryId === currentInventorySessionId)
                    ? currentInventorySessionId
                    : sessions[0].inventoryId;
                setInventoryModalSessions(sessions);
                setInventoryModalSessionId(defaultSessionId || '');
                        setInventoryModalAsset(asset);
                        setShowInventoryModal(true);
                    };

            // é–‹å•Ÿæ‰¹æ¬¡ç›¤é» Modal
            const handleBatchInventory = () => {
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const items = getSelectedAssetsForAction('INVENTORY');
                if (items.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                // éæ¿¾å‡ºå¾…ç›¤é»çš„è³‡ç”¢
                const pendingItems = items.filter(id => isAssetPendingInventory(id));
                if (pendingItems.length === 0) {
                    alert('é¸å–çš„è³‡ç”¢ä¸­æ²’æœ‰å¾…ç›¤é»çš„é …ç›®');
                    return;
                }
                // æ‰¾å‡ºæ‰€æœ‰é¸å–è³‡ç”¢çš„å…±åŒç›¤é»æœƒè©±
                let commonSessionIds = null;
                pendingItems.forEach((assetId) => {
                    const sessionIds = getAssetPendingSessions(assetId).map(session => session.inventoryId);
                    if (sessionIds.length === 0) return;
                    const sessionSet = new Set(sessionIds);
                    if (commonSessionIds === null) {
                        commonSessionIds = sessionSet;
                    } else {
                        commonSessionIds = new Set([...commonSessionIds].filter(id => sessionSet.has(id)));
                    }
                });

                const resolvedSessionId = commonSessionIds && commonSessionIds.size > 0
                    ? (currentInventorySessionId && commonSessionIds.has(currentInventorySessionId)
                        ? currentInventorySessionId
                        : Array.from(commonSessionIds)[0])
                    : '';

                if (!resolvedSessionId) {
                    alert('é¸å–çš„è³‡ç”¢åˆ†å±¬ä¸åŒç›¤é»æœƒè©±ï¼Œè«‹åˆ†æ‰¹è™•ç†æˆ–ä½¿ç”¨å–®ç­†ç›¤é»ã€‚');
                    return;
                }

                setBatchInventorySessionId(resolvedSessionId);
                setSelectedInventoryAssetIds(pendingItems);
                setShowBatchInventoryModal(true);
            };

            // ç›¤é»æˆåŠŸå›èª¿
            const handleInventorySuccess = useCallback(() => {
                // é‡æ–°è¼‰å…¥ç›¤é»å¾…è¾¦æ¸…å–®
                loadPendingInventoryAssignments(viewMode === 'user');
                // åˆ·æ–°å¡ç‰‡æ•¸æ“š
                refreshCardData();
            }, [loadPendingInventoryAssignments, refreshCardData, viewMode]);

            // ========== æ‰¹æ¬¡æ“ä½œè™•ç†å‡½æ•¸ ==========
            const handleBatchTransfer = () => {
                if (!transferOptions) {
                    alert('è½‰ç§»é¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                const items = getSelectedAssetsForAction('TRANSFER');
                if (items.length === 0) {
                    alert('é¸å–çš„è³‡ç”¢çš†ç‚ºåŒçµ„æˆå“¡è³‡ç”¢ï¼Œç„¡æ³•æ‰¹æ¬¡è½‰ç§»ã€‚');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('transfer');
            };

            const handleBatchLending = () => {
                if (!lendingOptions) {
                    alert('å‡ºå€Ÿé¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                const items = getSelectedAssetsForAction('LENDING');
                if (items.length === 0) {
                    alert('é¸å–çš„è³‡ç”¢çš†ç‚ºåŒçµ„æˆå“¡è³‡ç”¢ï¼Œç„¡æ³•æ‰¹æ¬¡å‡ºå€Ÿã€‚');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('lending');
            };

            const handleBatchScrap = () => {
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                const items = getSelectedAssetsForAction('SCRAP');
                if (items.length === 0) {
                    alert('é¸å–çš„è³‡ç”¢çš†ç‚ºåŒçµ„æˆå“¡è³‡ç”¢ï¼Œç„¡æ³•æ‰¹æ¬¡å ±å»¢ã€‚');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('scrap');
            };

            const handleCloseBatchModal = () => {
                setBatchModalType(null);
                setBatchActionAssetIds([]);
            };

            const handleBatchActionSuccess = () => {
                setBatchModalType(null);
                setBatchActionAssetIds([]);
                // æ¸…ç©ºæ‰¹æ¬¡æ¸…å–®
                if (typeof BatchList_resetOnSubmit === 'function') {
                    BatchList_resetOnSubmit();
                }
                // æ¸…ç©º React é¸å–ç‹€æ…‹
                setSelectedAssetIds([]);
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            };

            // æ–°å¢è³‡ç”¢æˆåŠŸå¾Œçš„å›èª¿
            const handleAddAssetSuccess = useCallback(() => {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            }, []);

            // è™•ç†å–æ¶ˆ
            const handleCancel = (assetId, status) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­† [${status}] ç‹€æ…‹çš„ç”³è«‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å–æ¶ˆç”³è«‹...');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            hideFlyProgressBar('å–æ¶ˆå®Œæˆï¼', 300);

                            setTimeout(() => {
                                alert('ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚');
                                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                                loadData();
                            }, 400);
                        } else {
                            hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                            alert('éŒ¯èª¤ï¼š' + response.error);
                        }
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .cancelTransferOrScrap(assetId);
            };

            // è™•ç†å›æº¯
            const handleRestore = (assetId) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å°‡æ­¤ã€Œå·²å ±å»¢ã€è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ³¨æ„ï¼šæ­¤æ“ä½œæœƒä¿ç•™åŸå ±å»¢è¨˜éŒ„ä¸¦æ·»åŠ å›æº¯æ¨™è¨˜ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');

                google.script.run
                    .withSuccessHandler(result => {
                        hideFlyProgressBar('å›æº¯å®Œæˆï¼', 300);

                        setTimeout(() => {
                            alert(result.message);
                            showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                            loadData();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å›æº¯å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .restoreFromScrap([assetId]);
            };

            if (!isReady) {
                return null;
            }

            return (
                <div className="ml-[88px] p-6 max-w-[1600px] mx-auto">
                    <div className="mb-6 flex justify-between items-center">
                        {/* å·¦å´ï¼šæ¨™é¡Œ */}
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800">è²¡ç”¢ç‹€æ…‹æŸ¥è©¢</h1>
                            <p className="text-slate-500 mt-1">
                                {currentUserName && <span className="font-medium text-slate-700">{currentUserName}</span>}
                                {currentUserName && 'ï¼Œ'}æ­¡è¿å›ä¾†ï¼Œä»Šå¤©æ˜¯ {(() => {
                                    const now = new Date();
                                    const date = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                                    const hours = now.getHours();
                                    const minutes = now.getMinutes().toString().padStart(2, '0');
                                    const seconds = now.getSeconds().toString().padStart(2, '0');
                                    const period = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
                                    const displayHours = hours % 12 || 12;
                                    return `${date} ${period} ${displayHours}:${minutes}`;
                                })()}
                            </p>
                        </div>

                        {/* å³å´ï¼šè¦–è§’åˆ‡æ› + é‡æ–°æ•´ç†æŒ‰éˆ• + è¼‰å…¥ç‹€æ…‹æŒ‡ç¤º */}
                        <div className="flex items-center gap-3">
                            {isAdmin && (
                                <div className="flex items-center gap-2">
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${
                                        isAdminView
                                            ? 'bg-amber-50 text-amber-700 border-amber-200'
                                            : 'bg-teal-50 text-teal-700 border-teal-200'
                                    }`}>
                                        {isAdminView ? 'ç®¡ç†å“¡æª¢è¦–ï¼šå…¨åŸŸæ¨¡å¼' : 'ä¸€èˆ¬æª¢è¦–ï¼šç¾¤çµ„æ¨¡å¼'}
                                    </span>
                                    <div className="flex items-center bg-white border border-slate-200 rounded-full p-1 shadow-sm">
                                        <button
                                            onClick={() => handleViewModeChange('user')}
                                            className={`px-3 py-1 text-sm rounded-full transition-colors ${
                                                viewMode === 'user'
                                                    ? 'bg-slate-800 text-white'
                                                    : 'text-slate-600 hover:bg-slate-100'
                                            }`}
                                            title="ä¸€èˆ¬ä½¿ç”¨è€…è¦–è§’"
                                        >
                                            ä¸€èˆ¬
                                        </button>
                                        <button
                                            onClick={() => handleViewModeChange('admin')}
                                            className={`px-3 py-1 text-sm rounded-full transition-colors ${
                                                viewMode === 'admin'
                                                    ? 'bg-slate-800 text-white'
                                                    : 'text-slate-600 hover:bg-slate-100'
                                            }`}
                                            title="ç®¡ç†è€…è¦–è§’"
                                        >
                                            ç®¡ç†è€…
                                        </button>
                                    </div>
                                </div>
                            )}
                            {/* è¼‰å…¥ç‹€æ…‹æ–‡å­— */}
                            {isLoadingCards && (
                                <span className="text-sm text-slate-500 flex items-center gap-2">
                                    <i className="fas fa-spinner fa-spin text-blue-500"></i>
                                    æ­£åœ¨è¼‰å…¥çµ±è¨ˆæ•¸æ“š...
                                </span>
                            )}

                            {/* ç›¤é»ç®¡ç†æŒ‰éˆ• */}
                            {isAdminView && (
                                <button
                                    id="btn-inventory-mgmt"
                                    onClick={() => setShowInventoryMgmtModal(true)}
                                    className="px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 transition-all shadow-sm flex items-center gap-2"
                                    title="ç›¤é»ç®¡ç†"
                                >
                                    <i className="fa-solid fa-clipboard-list text-slate-500"></i>
                                    <span className="hidden sm:inline">ç›¤é»ç®¡ç†</span>
                                </button>
                            )}

                            {/* æ–°å¢è³‡ç”¢æŒ‰éˆ• */}
                            <button
                                onClick={() => setShowAddAssetModal(true)}
                                className="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                                title="æ–°å¢è²¡ç”¢/ç‰©å“"
                            >
                                <i className="fas fa-plus"></i>
                                <span className="hidden sm:inline">æ–°å¢è³‡ç”¢</span>
                            </button>

                            {/* é‡æ–°æ•´ç†æŒ‰éˆ• */}
                            <button
                                onClick={handleRefreshCards}
                                disabled={isLoadingCards}
                                className="w-12 h-12 rounded-full bg-blue-500 text-white hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center group"
                                title="é‡æ–°æ•´ç†çµ±è¨ˆæ•¸æ“š"
                                aria-label="é‡æ–°æ•´ç†"
                            >
                                <i className={`fas fa-sync-alt text-lg transition-transform ${isLoadingCards ? 'animate-spin' : 'group-hover:rotate-180'}`}></i>
                            </button>
                        </div>
                    </div>

                    <DashboardCards counts={cardCounts} onClick={handleCardClick} isLoading={isLoadingCards} />

                    {/* âœ¨ æ–°å¢ï¼šç›¤é»é€²åº¦ç›£æ§å„€è¡¨æ¿ */}
                    <InventoryDashboardCard 
                        isAdminView={isAdminView}
                        inventorySessions={inventorySessions}
                        onRefresh={() => {
                            refreshCardData();
                            loadPendingInventoryAssignments(viewMode === 'user');
                        }} 
                    />

                    <FilterSection
                        filters={filters}
                        onFilterChange={handleFilterChange}
                        isAdmin={isAdminView}
                        allAssets={allAssets}
                    />

                    {/* æƒæå€åŸŸ - ä¾› Scanner æ¨¡çµ„ä½¿ç”¨ */}
                    <div id="Scanner_zone" className="scanner-zone mb-6" style={{ display: 'none' }}></div>

                    {/* æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•å¡ç‰‡ */}
                    <BatchActionButtons
                        onBatchTransfer={handleBatchTransfer}
                        onBatchLending={handleBatchLending}
                        onBatchScrap={handleBatchScrap}
                        hasPendingInventory={cardCounts.inventory > 0}
                        onBatchInventory={handleBatchInventory}
                    />

                    {duplicateInfo.duplicateCount > 0 && (
                        <AlertBanner
                            count={duplicateInfo.duplicateCount}
                            onClick={() => window.openDuplicateAssetsModal()}
                        />
                    )}

                    <AssetTable
                        assets={filteredAssets}
                        isAdmin={isAdminView}
                        currentUserEmail={currentUserEmail}
                        isInventoryTaskOnly={isInventoryTaskOnly}
                        onCancel={handleCancel}
                        onRestore={handleRestore}
                        onOpenTransferModal={handleOpenTransferModal}
                        onOpenLendingModal={handleOpenLendingModal}
                        onOpenScrapModal={handleOpenScrapModal}
                        onOpenEditModal={handleOpenEditModal}
                        isAssetPendingInventory={isAssetPendingInventory}
                        onOpenInventoryModal={handleOpenInventoryModal}
                        selectedAssetIds={selectedAssetIds}
                        onAssetSelect={handleAssetSelect}
                        onSelectAll={handleSelectAll}
                    />

                    {activeModal === 'transferring' && (
                        <TransferringModal
                            assets={transferringAssets}
                            isLoading={isLoadingTransferring}
                            onClose={() => {
                                setActiveModal(null);
                            }}
                            onCancelSuccess={() => {
                                setActiveModal(null);
                                // åˆ·æ–°å¡ç‰‡æ•¸æ“šå’Œè³‡ç”¢è¡¨æ ¼
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'lent' && (
                        <LentAssetsModal
                            lentAssetsDetails={lentAssetsDetails}
                            isLoading={isLoadingLentDetails}
                            onClose={() => {
                                setActiveModal(null);
                            }}
                            onReturnSuccess={() => {
                                setActiveModal(null);
                                // åˆ·æ–°å¡ç‰‡æ•¸æ“šå’Œè³‡ç”¢è¡¨æ ¼
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'scrapPrint' && (
                        <ScrapPrintModal
                            details={scrapPendingDetails}
                            isLoading={isLoadingScrapDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'transferPrint' && (
                        <TransferPrintModal
                            details={transferPendingDetails}
                            isLoading={isLoadingTransferDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'inventoryPending' && (
                      <PendingInventoryModal
                        pendingItems={pendingInventoryItems}
                        isAdmin={isAdminView}
                        isLoading={isLoadingPendingInventory}
                        error={pendingInventoryError}
                        onClose={() => {
                          setActiveModal(null);
                          setPendingInventoryError('');
                          setIsLoadingPendingInventory(false);
                        }}
                      />
                    )}

                    {/* å¿«é€Ÿæ“ä½œ Modal */}
                    {quickActionModalType === 'transfer' && (
                        <QuickTransferModal
                            asset={selectedAsset}
                            transferOptions={transferOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'lending' && (
                        <QuickLendingModal
                            asset={selectedAsset}
                            lendingOptions={lendingOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'scrap' && (
                        <QuickScrapModal
                            asset={selectedAsset}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {/* æ‰¹æ¬¡æ“ä½œ Modal */}
                    {batchModalType === 'transfer' && (
                        <BatchTransferModal
                            transferOptions={transferOptions}
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'lending' && (
                        <BatchLendingModal
                            lendingOptions={lendingOptions}
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'scrap' && (
                        <BatchScrapModal
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {/* æ–°å¢è³‡ç”¢ Modal */}
                    {showAddAssetModal && (
                        <AddAssetModal
                            onClose={() => setShowAddAssetModal(false)}
                            onSuccess={handleAddAssetSuccess}
                        />
                    )}

                    {/* ç›¤é»ç®¡ç† Modal */}
                    {showInventoryMgmtModal && (
                        <InventoryManagementModal
                            isAdminView={isAdminView}
                            onClose={() => setShowInventoryMgmtModal(false)}
                        />
                    )}

                    {/* ç·¨è¼¯è³‡ç”¢ Modalï¼ˆåƒ…ç®¡ç†å“¡ï¼‰*/}
                    {showEditAssetModal && editingAsset && (
                        <EditAssetModal
                            asset={editingAsset}
                            onClose={() => {
                                setShowEditAssetModal(false);
                                setEditingAsset(null);
                            }}
                            onSuccess={handleEditAssetSuccess}
                        />
                    )}

                    {/* å–®ç­†ç›¤é» Modal */}
                    {showInventoryModal && inventoryModalAsset && (
                        <InventoryConfirmModal
                            asset={inventoryModalAsset}
                            isBatch={false}
                            sessionId={currentInventorySessionId}
                            availableSessions={inventoryModalSessions}
                            defaultSessionId={inventoryModalSessionId}
                            isAdmin={isAdminView}
                            onClose={() => {
                                setShowInventoryModal(false);
                                setInventoryModalAsset(null);
                                setInventoryModalSessions([]);
                                setInventoryModalSessionId('');
                            }}
                            onSuccess={handleInventorySuccess}
                        />
                    )}

                    {/* æ‰¹æ¬¡ç›¤é» Modal */}
                    {showBatchInventoryModal && selectedInventoryAssetIds.length > 0 && (
                        <InventoryConfirmModal
                            assetIds={selectedInventoryAssetIds}
                            isBatch={true}
                            sessionId={batchInventorySessionId || currentInventorySessionId}
                            isAdmin={isAdminView}
                            onClose={() => {
                                setShowBatchInventoryModal(false);
                                setSelectedInventoryAssetIds([]);
                                setBatchInventorySessionId('');
                            }}
                            onSuccess={handleInventorySuccess}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('react-root')).render(<App />);
    </script>
</body>
</html>
