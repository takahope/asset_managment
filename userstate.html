<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { padding: 20px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #007bff; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .export-buttons { margin-bottom: 15px; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>

    <div id="main-content">
        <h4>財產狀態查詢</h4>

        <!-- 匯出按鈕 -->
        <div class="export-buttons">
            <button id="export-excel-btn" class="btn btn-success btn-sm" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> 匯出 Excel
            </button>
            <button id="export-csv-btn" class="btn btn-info btn-sm" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> 匯出 CSV
            </button>
            <small class="text-muted ml-2">※ 將匯出目前篩選的資料</small>
        </div>

        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="status-filter">依狀態篩選：</label>
                <select id="status-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="category-filter">依財產類別篩選：</label>
                <select id="category-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div id="leader-filter-container" class="form-group col-md-3" style="display: none;">
                <label for="leader-filter">依保管人篩選：</label>
                <select id="leader-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="search-box">關鍵字搜尋：</label>
                <input type="text" id="search-box" class="form-control" placeholder="搜尋產編、名稱、保管人...">
            </div>
        </div>

        <div id="loading-spinner">
            <div class="loader"></div>
            <p class="text-center">正在載入資料...</p>
        </div>
        
        <div id="table-container" class="table-container" style="display:none;">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th>財產編號</th>
                        <th>財產名稱</th>
                        <th>使用者</th>
                        <th>保管人</th>
                        <th>保管位置</th>
                        <th>財產類別</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="asset-list">
                </tbody>
            </table>
        </div>
        <div id="status-message"></div>
    </div>

    <script>
        let allAssets = [];
        let isAdmin = false;
        let currentUserEmail = '';
        let webAppUrl = ''; // ✨ 新增：儲存 Web App 的基礎 URL

        document.addEventListener("DOMContentLoaded", () => {
            showLoading(true);
            google.script.run.withSuccessHandler(url => { webAppUrl = url; }).getAppUrl(); // ✨ 新增：獲取 URL
            google.script.run
                .withSuccessHandler(populatePage)
                .withFailureHandler(showError)
                .getUserStateData();
        });

        function populatePage(response) {
            if (response.error) {
                showError({ message: response.error });
                return;
            }

            isAdmin = response.isAdmin;
            allAssets = response.assets;
            currentUserEmail = response.userEmail; // ✨ 儲存當前使用者 Email

            populateFilters(allAssets);

            if (isAdmin) {
                document.getElementById('leader-filter-container').style.display = 'block';
            }

            document.getElementById('status-filter').addEventListener('change', filterAndRender);
            document.getElementById('category-filter').addEventListener('change', filterAndRender);
            document.getElementById('leader-filter').addEventListener('change', filterAndRender);
            document.getElementById('search-box').addEventListener('input', filterAndRender);

            filterAndRender(); // 初始渲染
            showLoading(false);
            document.getElementById('table-container').style.display = 'block';
        }

        function populateFilters(assets) {
            const statusSet = new Set();
            const categorySet = new Set();
            const leaderSet = new Set();
            assets.forEach(asset => {
                statusSet.add(asset.status);
                categorySet.add(asset.category);
                if (isAdmin) leaderSet.add(asset.leader);
            });

            const statusFilter = document.getElementById('status-filter');
            statusSet.forEach(status => {
                if(status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                }
            });

            const categoryFilter = document.getElementById('category-filter');
            categorySet.forEach(category => {
                if(category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });

            if (isAdmin) {
                const leaderFilter = document.getElementById('leader-filter');
                leaderSet.forEach(leader => {
                    if(leader) {
                        const option = document.createElement('option');
                        option.value = leader;
                        option.textContent = leader;
                        leaderFilter.appendChild(option);
                    }
                });
            }
        }

        function filterAndRender() {
            const statusFilterValue = document.getElementById('status-filter').value;
            const categoryFilterValue = document.getElementById('category-filter').value;
            const leaderFilterValue = isAdmin ? document.getElementById('leader-filter').value : '';
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            const filteredAssets = allAssets.filter(asset => {
                const statusMatch = !statusFilterValue || asset.status === statusFilterValue;
                const categoryMatch = !categoryFilterValue || asset.category === categoryFilterValue;
                const leaderMatch = !leaderFilterValue || asset.leader === leaderFilterValue;
                const searchMatch = !searchValue || 
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.leader.toUpperCase().includes(searchValue);
                return statusMatch && categoryMatch && leaderMatch && searchMatch;
            });

            renderTable(filteredAssets);
        }

        function renderTable(assets) {
            const listBody = document.getElementById('asset-list');
            listBody.innerHTML = '';

            if (!assets || assets.length === 0) {
                listBody.innerHTML = '<tr><td colspan="8" class="text-center">沒有符合條件的資料。</td></tr>';
                return;
            }

            const statusColors = {
                '在庫': 'badge-success',
                '出借中': 'badge-warning',
                '報廢中': 'badge-danger',
                '已報廢': 'badge-secondary',
                '轉移中': 'badge-primary'
            };

            assets.forEach(asset => {
                const row = document.createElement('tr');
                const statusColor = statusColors[asset.status] || 'badge-info';
                
                let actionHtml = '';
                const canCancel = isAdmin || currentUserEmail === asset.leaderEmail;
                if (canCancel && (asset.status === '轉移中' || asset.status === '報廢中')) {
                    actionHtml = `<button class="btn btn-sm btn-danger" onclick="promptCancel('${asset.assetId}', '${asset.status}')">取消</button>`;
                }

                row.innerHTML = `
                    <td>${asset.assetId}</td>
                    <td>${asset.assetName}</td>
                    <td>${asset.userName}</td>
                    <td>${asset.leader}</td>
                    <td>${asset.location}</td>
                    <td>${asset.category}</td>
                    <td><span class="badge ${statusColor}">${asset.status}</span></td>
                    <td>${actionHtml}</td>
                `;
                listBody.appendChild(row);
            });
        }

        // ✨ 新增：取消按鈕的處理函式
        function promptCancel(assetId, status) {
            const confirmation = confirm(`您確定要取消這筆 [${status}] 狀態的申請嗎？\n\n財產編號：${assetId}\n\n此操作將會把財產狀態恢復為「在庫」。`);
            if (confirmation) {
                showLoading(true);
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            // 操作成功後，直接重新導向到目前頁面，取代 location.reload()
                            window.open(webAppUrl + '?page=userstate', '_top');
                        } else {
                            showLoading(false);
                            showError({ message: response.error });
                        }
                    })
                    .withFailureHandler(showError)
                    .cancelTransferOrScrap(assetId);
            }
        }

        function showLoading(isLoading) {
            document.getElementById('loading-spinner').style.display = isLoading ? 'block' : 'none';
            document.getElementById('table-container').style.display = isLoading ? 'none' : 'block';
        }

        function showError(error) {
            showLoading(false);
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = '錯誤：' + error.message;
        }

        // ✨ 新增：匯出到 Excel 功能
        function exportToExcel() {
            const filteredAssets = getFilteredAssets();

            if (!filteredAssets || filteredAssets.length === 0) {
                alert('沒有可匯出的資料');
                return;
            }

            // 準備匯出資料
            const exportData = filteredAssets.map(asset => ({
                '財產編號': asset.assetId,
                '財產名稱': asset.assetName,
                '使用者': asset.userName,
                '保管人': asset.leader,
                '保管位置': asset.location,
                '財產類別': asset.category,
                '狀態': asset.status
            }));

            // 建立工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // 設定欄寬
            ws['!cols'] = [
                { wch: 15 },  // 財產編號
                { wch: 30 },  // 財產名稱
                { wch: 15 },  // 使用者
                { wch: 15 },  // 保管人
                { wch: 20 },  // 保管位置
                { wch: 15 },  // 財產類別
                { wch: 10 }   // 狀態
            ];

            XLSX.utils.book_append_sheet(wb, ws, "財產清單");

            // 生成檔案名稱（包含時間戳記）
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `財產清單_${timestamp}.xlsx`;

            // 下載檔案
            XLSX.writeFile(wb, filename);

            showExportSuccess('Excel', filteredAssets.length);
        }

        // ✨ 新增：匯出到 CSV 功能
        function exportToCSV() {
            const filteredAssets = getFilteredAssets();

            if (!filteredAssets || filteredAssets.length === 0) {
                alert('沒有可匯出的資料');
                return;
            }

            // CSV 標題
            const headers = ['財產編號', '財產名稱', '使用者', '保管人', '保管位置', '財產類別', '狀態'];

            // 準備 CSV 內容
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += headers.join(',') + '\n';

            filteredAssets.forEach(asset => {
                const row = [
                    escapeCsvField(asset.assetId),
                    escapeCsvField(asset.assetName),
                    escapeCsvField(asset.userName),
                    escapeCsvField(asset.leader),
                    escapeCsvField(asset.location),
                    escapeCsvField(asset.category),
                    escapeCsvField(asset.status)
                ];
                csvContent += row.join(',') + '\n';
            });

            // 建立下載連結
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `財產清單_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showExportSuccess('CSV', filteredAssets.length);
        }

        // ✨ 輔助函數：CSV 欄位轉義
        function escapeCsvField(field) {
            if (field == null) return '';
            field = String(field);
            // 如果包含逗號、雙引號或換行符號，需要用雙引號包裹，並將雙引號轉義
            if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                field = '"' + field.replace(/"/g, '""') + '"';
            }
            return field;
        }

        // ✨ 輔助函數：取得當前篩選的資料
        function getFilteredAssets() {
            const statusFilterValue = document.getElementById('status-filter').value;
            const categoryFilterValue = document.getElementById('category-filter').value;
            const leaderFilterValue = isAdmin ? document.getElementById('leader-filter').value : '';
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            return allAssets.filter(asset => {
                const statusMatch = !statusFilterValue || asset.status === statusFilterValue;
                const categoryMatch = !categoryFilterValue || asset.category === categoryFilterValue;
                const leaderMatch = !leaderFilterValue || asset.leader === leaderFilterValue;
                const searchMatch = !searchValue ||
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.leader.toUpperCase().includes(searchValue);
                return statusMatch && categoryMatch && leaderMatch && searchMatch;
            });
        }

        // ✨ 輔助函數：顯示匯出成功訊息
        function showExportSuccess(format, count) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-success';
            statusDiv.textContent = `成功匯出 ${count} 筆資料為 ${format} 格式`;
            setTimeout(() => {
                statusDiv.className = '';
                statusDiv.textContent = '';
            }, 3000);
        }
    </script>
</body>
</html>
