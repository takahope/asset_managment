<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>

    <div id="main-content">
        <h4>è²¡ç”¢ç‹€æ…‹æŸ¥è©¢</h4>
        
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="status-filter">ä¾ç‹€æ…‹ç¯©é¸ï¼š</label>
                <select id="status-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="category-filter">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸ï¼š</label>
                <select id="category-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div id="leader-filter-container" class="form-group col-md-3" style="display: none;">
                <label for="leader-filter">ä¾ä¿ç®¡äººç¯©é¸ï¼š</label>
                <select id="leader-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="search-box">é—œéµå­—æœå°‹ï¼š</label>
                <input type="text" id="search-box" class="form-control" placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€ä¿ç®¡äºº...">
            </div>
        </div>

        <div id="table-container" class="table-container" style="display:none;">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 15%;">è²¡ç”¢ç·¨è™Ÿ</th>
                        <th style="width: 18%;">è²¡ç”¢åç¨±</th>
                        <th style="width: 13%;">å‹è™Ÿ/å» ç‰Œ</th>
                        <th style="width: 11%;">ä½¿ç”¨è€…</th>
                        <th style="width: 11%;">ä¿ç®¡äºº</th>
                        <th style="width: 11%;">ä¿ç®¡ä½ç½®</th>
                        <th style="width: 11%;">è²¡ç”¢é¡åˆ¥</th>
                        <th style="width: 7%;">ç‹€æ…‹</th>
                        <th style="width: 3%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="asset-list">
                </tbody>
            </table>
        </div>
        <div id="status-message"></div>
    </div>

    <script>
        let allAssets = [];
        let isAdmin = false;
        let currentUserEmail = '';
        let webAppUrl = ''; // âœ¨ æ–°å¢ï¼šå„²å­˜ Web App çš„åŸºç¤ URL

        document.addEventListener("DOMContentLoaded", () => {
            toggleTableVisibility(false);
            showFlyProgressBar('æ­£åœ¨è¼‰å…¥è²¡ç”¢ç‹€æ…‹è³‡æ–™...');
            google.script.run.withSuccessHandler(url => {
                webAppUrl = url; // âœ¨ ç²å– URL
                // ç¢ºä¿å…ˆå–å¾— URL å†è¼‰å…¥é é¢è³‡æ–™
                google.script.run
                    .withSuccessHandler(populatePage)
                    .withFailureHandler(showError)
                    .getUserStateData();
            }).getAppUrl();
        });

        function populatePage(response) {
            if (response.error) {
                showError({ message: response.error });
                return;
            }

            isAdmin = response.isAdmin;
            allAssets = response.assets;
            currentUserEmail = response.userEmail; // âœ¨ å„²å­˜ç•¶å‰ä½¿ç”¨è€… Email

            populateFilters(allAssets);

            if (isAdmin) {
                document.getElementById('leader-filter-container').style.display = 'block';
            }

            document.getElementById('status-filter').addEventListener('change', filterAndRender);
            document.getElementById('category-filter').addEventListener('change', filterAndRender);
            document.getElementById('leader-filter').addEventListener('change', filterAndRender);
            document.getElementById('search-box').addEventListener('input', filterAndRender);

            filterAndRender(); // åˆå§‹æ¸²æŸ“
            hideFlyProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
            setTimeout(() => {
                toggleTableVisibility(true);
            }, 300);
        }

        function populateFilters(assets) {
            const statusSet = new Set();
            const categorySet = new Set();
            const leaderSet = new Set();
            assets.forEach(asset => {
                statusSet.add(asset.status);
                categorySet.add(asset.category);
                if (isAdmin) leaderSet.add(asset.leader);
            });

            const statusFilter = document.getElementById('status-filter');
            statusFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
            statusSet.forEach(status => {
                if(status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                }
            });

            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
            categorySet.forEach(category => {
                if(category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });

            if (isAdmin) {
                const leaderFilter = document.getElementById('leader-filter');
                leaderFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
                leaderSet.forEach(leader => {
                    if(leader) {
                        const option = document.createElement('option');
                        option.value = leader;
                        option.textContent = leader;
                        leaderFilter.appendChild(option);
                    }
                });
            }
        }

        function filterAndRender() {
            const statusFilterValue = document.getElementById('status-filter').value;
            const categoryFilterValue = document.getElementById('category-filter').value;
            const leaderFilterValue = isAdmin ? document.getElementById('leader-filter').value : '';
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            const filteredAssets = allAssets.filter(asset => {
                const statusMatch = !statusFilterValue || asset.status === statusFilterValue;
                const categoryMatch = !categoryFilterValue || asset.category === categoryFilterValue;
                const leaderMatch = !leaderFilterValue || asset.leader === leaderFilterValue;
                const searchMatch = !searchValue || 
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.leader.toUpperCase().includes(searchValue);
                return statusMatch && categoryMatch && leaderMatch && searchMatch;
            });

            renderTable(filteredAssets);
        }

        function renderTable(assets) {
            const listBody = document.getElementById('asset-list');
            listBody.innerHTML = '';

            if (!assets || assets.length === 0) {
                listBody.innerHTML = '<tr><td colspan="8" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</td></tr>';
                return;
            }

            const statusColors = {
                'åœ¨åº«': 'badge-success',
                'å‡ºå€Ÿä¸­': 'badge-warning',
                'å ±å»¢ä¸­': 'badge-danger',
                'å·²å ±å»¢': 'badge-secondary',
                'è½‰ç§»ä¸­': 'badge-primary',
                'å¾…æ¥æ”¶': 'badge-primary'
            };

            // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
            assets.forEach(asset => {
                const row = document.createElement('tr');
                const statusColor = statusColors[asset.status] || 'badge-info';
                const canCancel = isAdmin || currentUserEmail === asset.leaderEmail || currentUserEmail === asset.userEmail;

                // ä½¿ç”¨ textContent å®‰å…¨è¨­å®šæ–‡å­—å…§å®¹
                const cells = [
                    asset.assetId,
                    asset.assetName,
                    asset.modelBrand,
                    asset.userName,
                    asset.leader,
                    asset.location,
                    asset.category
                ];

                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData || '';
                    row.appendChild(td);
                });

                // ç‹€æ…‹ Badge
                const statusTd = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${statusColor}`;
                badge.textContent = asset.status;
                statusTd.appendChild(badge);
                row.appendChild(statusTd);

                // æ“ä½œæŒ‰éˆ•ï¼ˆä½¿ç”¨ addEventListener æ›¿ä»£ onclickï¼‰
                const actionTd = document.createElement('td');

                // åŸæœ‰çš„å–æ¶ˆé‚è¼¯ï¼ˆå¾…æ¥æ”¶/è½‰ç§»ä¸­/å ±å»¢ä¸­ï¼‰
                if (canCancel && (asset.status === 'å¾…æ¥æ”¶' || asset.status === 'è½‰ç§»ä¸­' || asset.status === 'å ±å»¢ä¸­')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-sm btn-danger';
                    cancelBtn.textContent = 'å–æ¶ˆ';
                    // ä½¿ç”¨é–‰åŒ…å®‰å…¨å‚³éåƒæ•¸ï¼Œé¿å… XSS
                    cancelBtn.addEventListener('click', () => promptCancel(asset.assetId, asset.status));
                    actionTd.appendChild(cancelBtn);
                }

                // æ–°å¢ï¼šå·²å ±å»¢ç‹€æ…‹çš„å›æº¯æŒ‰éˆ•ï¼ˆåƒ…é™ç®¡ç†å“¡ï¼‰
                if (isAdmin && asset.status === 'å·²å ±å»¢') {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.className = 'btn btn-sm btn-warning';
                    restoreBtn.textContent = 'å›æº¯';
                    restoreBtn.addEventListener('click', () => promptRestore(asset.assetId));
                    actionTd.appendChild(restoreBtn);
                }

                row.appendChild(actionTd);

                listBody.appendChild(row);
            });
        }

        // âœ¨ æ–°å¢ï¼šå–æ¶ˆæŒ‰éˆ•çš„è™•ç†å‡½å¼
        function promptCancel(assetId, status) {
            const confirmation = confirm(`æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­† [${status}] ç‹€æ…‹çš„ç”³è«‹å—ï¼Ÿ\n\nè²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\næ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`);
            if (confirmation) {
                toggleTableVisibility(false);
                showFlyProgressBar('æ­£åœ¨å–æ¶ˆç”³è«‹...');
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            // 1. å…ˆè®“é€²åº¦æ¢å®Œæˆï¼ˆè·‘åˆ° 100% ä¸¦é¡¯ç¤ºå®Œæˆæ–‡å­—ï¼‰
                            hideFlyProgressBar('å–æ¶ˆå®Œæˆï¼', 300);
                            toggleTableVisibility(false);

                            // 2. ç­‰å¾…é€²åº¦æ¢å®Œå…¨éš±è—å¾Œï¼ˆ300ms + 100ms ç·©è¡ï¼‰å†å½ˆå‡º alert
                            setTimeout(() => {
                                alert('ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚');

                                // 3. ç”¨æˆ¶æŒ‰ OK å¾Œï¼Œé¡¯ç¤ºæ–°çš„è¼‰å…¥å‹•ç•«é‡æ–°è¼‰å…¥è³‡æ–™
                                toggleTableVisibility(false);
                                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                                google.script.run
                                    .withSuccessHandler(populatePage)
                                    .withFailureHandler(showError)
                                    .getUserStateData();
                            }, 400); // ç¸½å»¶é²ï¼š300ms (é€²åº¦æ¢éš±è—) + 100ms (ç·©è¡)
                        } else {
                            hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                            showError({ message: response.error });
                        }
                    })
                    .withFailureHandler(showError)
                    .cancelTransferOrScrap(assetId);
            }
        }

        /**
         * è™•ç†ã€Œå·²å ±å»¢ã€è³‡ç”¢çš„å›æº¯æ“ä½œï¼ˆåƒ…é™ç®¡ç†å“¡ï¼‰
         * @param {string} assetId - è³‡ç”¢ç·¨è™Ÿ
         */
        function promptRestore(assetId) {
            const confirmation = confirm(
                `æ‚¨ç¢ºå®šè¦å°‡æ­¤ã€Œå·²å ±å»¢ã€è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                `æ³¨æ„ï¼šæ­¤æ“ä½œæœƒä¿ç•™åŸå ±å»¢è¨˜éŒ„ä¸¦æ·»åŠ å›æº¯æ¨™è¨˜ã€‚`
            );

            if (!confirmation) return;

            // éš±è—è¡¨æ ¼ï¼Œé¡¯ç¤ºé€²åº¦æ¢
            toggleTableVisibility(false);
            showFlyProgressBar('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');

            // èª¿ç”¨å¾Œç«¯å‡½æ•¸ï¼ˆæ³¨æ„ï¼šå‚³éæ•¸çµ„ï¼‰
            google.script.run
                .withSuccessHandler(handleRestoreSuccess)
                .withFailureHandler(handleRestoreError)
                .restoreFromScrap([assetId]);  // âš ï¸ é—œéµï¼šå‚³éå–®å…ƒç´ æ•¸çµ„
        }

        /**
         * è™•ç†å›æº¯æˆåŠŸçš„éŸ¿æ‡‰
         * @param {Object} result - å¾Œç«¯è¿”å›çš„ç‰©ä»¶ { success, message, count, failed }
         */
        function handleRestoreSuccess(result) {
            // æ­¥é©Ÿ 1ï¼šå®Œæˆé€²åº¦æ¢ï¼ˆè·‘åˆ° 100% ä¸¦é¡¯ç¤ºå®Œæˆæ–‡å­—ï¼‰
            hideFlyProgressBar('å›æº¯å®Œæˆï¼', 300);
            toggleTableVisibility(false);

            // æ­¥é©Ÿ 2ï¼šç­‰å¾…é€²åº¦æ¢å®Œå…¨éš±è—å¾Œå½ˆå‡º alertï¼ˆ300ms éš±è— + 100ms ç·©è¡ï¼‰
            setTimeout(() => {
                // ç›´æ¥é¡¯ç¤ºå¾Œç«¯è¿”å›çš„è¨Šæ¯
                alert(result.message);

                // æ­¥é©Ÿ 3ï¼šç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œéƒ½é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
                // (å³ä½¿å›æº¯å¤±æ•—ï¼Œä¹Ÿå¯èƒ½å› ç‚ºç‹€æ…‹å·²ç¶“è®Šæ›´ï¼Œæ‰€ä»¥é‡è¼‰æ˜¯å®‰å…¨çš„)
                toggleTableVisibility(false);
                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                google.script.run
                    .withSuccessHandler(populatePage)
                    .withFailureHandler(showError)
                    .getUserStateData();
            }, 400); // ç¸½å»¶é²ï¼š300ms (é€²åº¦æ¢éš±è—) + 100ms (ç·©è¡)
        }

        /**
         * è™•ç†å›æº¯å¤±æ•—çš„éŒ¯èª¤ (ç³»çµ±éŒ¯èª¤æˆ–ä¾‹å¤–)
         * @param {Object} error - éŒ¯èª¤å°è±¡
         */
        function handleRestoreError(error) {
            hideFlyProgressBar('å›æº¯å¤±æ•—', 0);
            alert('éŒ¯èª¤ï¼š' + (error.message || 'å›æº¯æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'));
            // âš ï¸ é—œéµä¿®å¾©ï¼šéŒ¯èª¤å¾Œæ¢å¾©è¡¨æ ¼é¡¯ç¤ºï¼Œé¿å… UI å¡æ­»
            toggleTableVisibility(true);
        }

        /**
         * çµ±ä¸€æ§åˆ¶è¡¨æ ¼çš„é¡¯ç¤º/éš±è—
         * @param {boolean} show - true é¡¯ç¤ºè¡¨æ ¼ï¼Œfalse éš±è—è¡¨æ ¼
         */
        function toggleTableVisibility(show) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.style.display = show ? 'block' : 'none';
        }

        function showError(error) {
            hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = 'éŒ¯èª¤ï¼š' + error.message;
        }
    </script>
</body>
</html>
