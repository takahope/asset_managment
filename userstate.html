<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">

    <!-- 攔截並過濾產線環境警告 (Tailwind & Babel) -->
    <script>
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (typeof args[0] === 'string') {
                    // 過濾 Tailwind 警告
                    if (args[0].includes('cdn.tailwindcss.com')) return;
                    // 過濾 Babel 警告
                    if (args[0].includes('in-browser Babel transformer')) return;
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Bootstrap CSS (僅用於 Modal) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --ink-900: #0f172a;
            --ink-700: #334155;
            --ink-500: #64748b;
            --surface: #ffffff;
            --surface-muted: #f8fafc;
            --accent-500: #2f6c7f;
            --accent-400: #3d8c9c;
            --accent-300: #7dd3c7;
            --warm-200: #f7d7b5;
            --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.12);
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: "Noto Sans TC", "Noto Sans", sans-serif;
            color: var(--ink-900);
            background:
                radial-gradient(circle at 12% 12%, rgba(125, 211, 199, 0.25), transparent 55%),
                radial-gradient(circle at 88% 0%, rgba(247, 215, 181, 0.32), transparent 48%),
                linear-gradient(180deg, #f8fafc 0%, #eef2f7 60%, #ecf4f2 100%);
        }

        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 配合 shared-nav 側邊欄 */
        .duplicate-group-row {
            background-color: #fff7e6;
            font-weight: 600;
        }

        .page-shell {
            position: relative;
            padding: 28px 24px 40px;
            z-index: 0;
            background-image: radial-gradient(circle, rgba(61, 140, 156, 0.35), transparent 70%);
            background-repeat: no-repeat;
            background-size: 320px 320px;
            background-position: right -140px top -120px;
        }

        .page-hero {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(244, 250, 250, 0.92));
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 24px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(6px);
        }

        .page-hero__text {
            max-width: 640px;
        }

        .page-title {
            font-family: "Noto Serif TC", "Noto Serif", serif;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            color: var(--ink-900);
        }

        .page-subtitle {
            color: var(--ink-500);
            margin-top: 6px;
            line-height: 1.6;
        }

        .page-hero__actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .hero-status,
        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .hero-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--ink-500);
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.72);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .hero-btn {
            border-radius: 14px;
            padding: 10px 16px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hero-btn--ghost {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--ink-700);
        }

        .hero-btn--primary {
            background: linear-gradient(135deg, #1aa39f, #2f6c7f);
            color: #ffffff;
            border: none;
            box-shadow: 0 14px 32px rgba(26, 163, 159, 0.25);
        }

        .hero-btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 38px rgba(26, 163, 159, 0.3);
        }

        .hero-refresh {
            width: 44px;
            height: 44px;
            border-radius: 999px;
        }

        .dashboard-grid {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 640px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }

        .status-card {
            position: relative;
            overflow: hidden;
            background: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            animation: cardRise 0.45s ease-out both;
            animation-delay: var(--delay, 0ms);
        }

        .status-card::after {
            content: "";
            position: absolute;
            top: -40px;
            right: -40px;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(61, 140, 156, 0.18), transparent 70%);
        }

        .status-card:hover {
            transform: translateY(-2px);
            border-color: rgba(46, 120, 140, 0.35);
            box-shadow: 0 20px 44px rgba(15, 23, 42, 0.12);
        }

        .status-card__bar {
            width: 4px;
            height: 34px;
            border-radius: 999px;
        }

        .status-card__count {
            font-family: "Noto Serif TC", "Noto Serif", serif;
        }

        @keyframes cardRise {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .status-card {
                animation: none;
            }
        }

        @media (max-width: 768px) {
            .page-shell {
                padding: 20px 16px 86px;
                background-size: 260px 260px;
                background-position: right -200px top -160px;
            }

            .page-hero {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px;
            }

            .page-hero__actions {
                width: 100%;
                align-items: flex-start;
            }

            .hero-status,
            .hero-actions {
                justify-content: flex-start;
            }

            .page-title {
                font-size: 1.7rem;
            }

            .page-subtitle {
                font-size: 0.95rem;
            }

            .hero-refresh {
                width: 40px;
                height: 40px;
            }
        }

        /* 盤點管理 Modal */
        .inventory-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 60;
            backdrop-filter: blur(2px);
        }

        .inventory-modal {
            background: #ffffff;
            border-radius: 16px;
            width: min(1040px, 96vw);
            max-height: 94vh;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .inventory-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
        }

        .inventory-modal-body {
            padding: 24px;
            display: grid;
            gap: 20px;
            overflow: visible;
            grid-template-columns: minmax(0, 1fr);
            flex: 1;
            min-height: 0;
        }

        @media (min-width: 1024px) {
            .inventory-modal-body {
                grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.05fr);
            }
        }

        .inventory-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .inventory-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .inventory-card--stretch {
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .inventory-card--stretch .inventory-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inventory-action-footer {
            margin-top: auto;
            padding-top: 8px;
        }

        @media (min-width: 1024px) {
            #inventory-action-area {
                min-height: 560px;
            }
        }

        .inventory-card-header {
            padding: 10px 16px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .inventory-card-header--primary {
            background: #3b82f6;
        }

        .inventory-card-header--neutral {
            background: #6b7280;
        }

        .inventory-card-body {
            padding: 16px;
        }

        .inventory-card-body--primary {
            background: #ffffff;
        }

        .inventory-card-body--neutral {
            background: #f3f4f6;
        }

        .inventory-empty-state {
            font-size: 13px;
            color: #6b7280;
            text-align: center;
            padding: 12px 0;
        }

        .inventory-start-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .inventory-option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inventory-option-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }

        .inventory-primary-button {
            background: #3b82f6;
            color: #ffffff;
            border-radius: 8px;
            padding: 8px 18px;
            font-weight: 600;
        }

        .inventory-primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inventory-modal-footer {
            padding: 12px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
        }

        .inventory-secondary-button {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            color: #475569;
            border-radius: 8px;
            padding: 6px 16px;
            font-size: 14px;
        }

        .inventory-secondary-button:hover {
            background: #f1f5f9;
        }

        .inventory-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: min(62vh, 640px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .inventory-history-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
        }

        .inventory-history-item.is-completed {
            opacity: 0.7;
        }

        .inventory-history-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .inventory-history-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inventory-history-session {
            font-weight: 700;
            color: #111827;
        }

        .inventory-history-count {
            text-align: right;
        }

        .inventory-history-right {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .inventory-history-count-number {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .inventory-history-count-label {
            font-size: 12px;
            color: #6b7280;
        }

        .inventory-history-delete {
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #64748b;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 14px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-history-delete:hover {
            background: #f8fafc;
            color: #dc2626;
            border-color: #fecaca;
        }

        .inventory-history-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inventory-history-meta {
            font-size: 13px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .inventory-history-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #0f766e;
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
        }

        .inventory-badge {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .inventory-badge--open {
            background: #f6c344;
            color: #4b3d00;
        }

        .inventory-badge--completed {
            background: #e5e7eb;
            color: #4b5563;
        }

        .inventory-badge--unknown {
            background: #e2e8f0;
            color: #475569;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>
    <?!= include('toast_progress'); ?>
    <script>
        window.BatchList_skipPaginationHook = true;
    </script>
    <?!= include('batch_processing_list'); ?>
    <?!= include('selectbyqr'); ?>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div id="react-root"></div>

    <!-- Bootstrap Modals (保留現有結構) -->
    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">重複產編清單</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>財產編號</th>
                                    <th>財產名稱</th>
                                    <th>使用者</th>
                                    <th>保管人</th>
                                    <th>保管位置</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingApprovalModal" tabindex="-1" role="dialog" aria-labelledby="pendingApprovalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pendingApprovalTitle">待接收資產清單</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row mb-2">
                        <div class="form-group col-md-5">
                            <label for="pending-location-filter">依原保管地點篩選</label>
                            <select id="pending-location-filter" class="form-control">
                                <option value="">-- 顯示全部 --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-7">
                            <label for="pending-search-box">關鍵字搜尋 (產編/產名/原保管人)</label>
                            <input type="text" id="pending-search-box" class="form-control" placeholder="輸入關鍵字">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 4%;"><input type="checkbox" id="pending-select-all"></th>
                                    <th style="width: 10%;">財產編號</th>
                                    <th style="width: 11%;">財產名稱</th>
                                    <th style="width: 12%;">型號/廠牌</th>
                                    <th style="width: 14%;">保管人變更</th>
                                    <th style="width: 14%;">使用人變更</th>
                                    <th style="width: 13%;">地點變更</th>
                                    <th style="width: 11%;">轉移類型</th>
                                    <th style="width: 11%;">申請時間</th>
                                </tr>
                            </thead>
                            <tbody id="pending-approval-list"></tbody>
                        </table>
                    </div>
                    <div id="pending-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="submitPendingRejection()">拒絕所選</button>
                    <button type="button" class="btn btn-success" onclick="submitPendingApproval()">接受所選</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentModeModal" tabindex="-1" role="dialog" aria-labelledby="assignmentModeTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentModeTitle">選擇分派方式</h5>
                    <button type="button" class="close" data-dismiss="modal" onclick="window.inventoryCancelAssignmentMode && window.inventoryCancelAssignmentMode()">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">請選擇本次盤點的分派方式：</p>
                    <div class="custom-control custom-radio mb-2">
                        <input type="radio" id="assignment-mode-group" name="assignmentMode" class="custom-control-input" value="group" checked>
                        <label class="custom-control-label" for="assignment-mode-group">依照組別分派</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="assignment-mode-person" name="assignmentMode" class="custom-control-input" value="person">
                        <label class="custom-control-label" for="assignment-mode-person">依照人名分派</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="window.inventoryCancelAssignmentMode && window.inventoryCancelAssignmentMode()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="window.inventoryConfirmAssignmentMode && window.inventoryConfirmAssignmentMode()">開始盤點</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentAssetsModal" tabindex="-1" role="dialog" aria-labelledby="assignmentAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentAssetsTitle">分派清單</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="assignment-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>財產編號</th>
                                    <th>財產名稱</th>
                                    <th>使用人</th>
                                    <th>保管人</th>
                                    <th>地點</th>
                                    <th>盤點結果</th>
                                </tr>
                            </thead>
                            <tbody id="assignment-assets-body"></tbody>
                        </table>
                    </div>
                    <div id="assignment-assets-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 全域函數橋接 jQuery Modal -->
    <script>
        // 全域變數供 React 與 jQuery 共享
        window.pendingApprovals = [];
        window.filteredPendingApprovals = [];
        window.pendingCurrentPage = 1;
        window.pendingRowsPerPage = 50;
        window.duplicateGroups = [];
        window.assignmentRowsPerPage = 500;
        window.assignmentModalState = {
            key: '',
            title: '',
            assets: [],
            page: 1,
            loading: false,
            error: ''
        };

        window.openPendingApprovalModal = () => {
            if (!window.pendingApprovals || window.pendingApprovals.length === 0) return;

            if (!document.getElementById('pendingApprovalModal').dataset.initialized) {
                document.getElementById('pending-location-filter').addEventListener('change', filterPendingApprovals);
                document.getElementById('pending-search-box').addEventListener('input', filterPendingApprovals);
                document.getElementById('pending-select-all').addEventListener('change', (event) => {
                    document.querySelectorAll('.pending-approval-checkbox').forEach(cb => {
                        cb.checked = event.target.checked;
                    });
                });
                document.getElementById('pendingApprovalModal').dataset.initialized = 'true';
            }

            populatePendingFilters();
            filterPendingApprovals();
            $('#pendingApprovalModal').modal('show');
        };

        window.openDuplicateAssetsModal = () => {
            if (!window.duplicateGroups || window.duplicateGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        };

        window.openInventoryAssignmentModal = (state = {}) => {
            window.assignmentModalState = {
                key: '',
                title: '',
                assets: [],
                page: 1,
                loading: false,
                error: '',
                ...state
            };
            renderAssignmentAssetsModal();
            $('#assignmentAssetsModal').modal('show');
        };

        window.updateInventoryAssignmentModal = (state = {}) => {
            window.assignmentModalState = {
                ...window.assignmentModalState,
                ...state
            };
            renderAssignmentAssetsModal();
        };

        function populatePendingFilters() {
            const locationFilter = document.getElementById('pending-location-filter');
            locationFilter.innerHTML = '<option value="">-- 顯示全部 --</option>';
            const uniqueLocations = [...new Set(window.pendingApprovals.map(item => item.oldLocation))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilter.appendChild(option);
            });
        }

        function filterPendingApprovals() {
            const locationFilter = document.getElementById('pending-location-filter').value.toUpperCase();
            const searchFilter = document.getElementById('pending-search-box').value.toUpperCase();

            window.filteredPendingApprovals = window.pendingApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation && item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    (item.oldKeeper && item.oldKeeper.toUpperCase().includes(searchFilter));
                return locationMatch && searchMatch;
            });

            window.pendingCurrentPage = 1;
            renderPendingPage(window.pendingCurrentPage);
        }

        function renderPendingPage(page) {
            window.pendingCurrentPage = page;
            const listBody = document.getElementById('pending-approval-list');
            const pagination = document.getElementById('pending-pagination');
            listBody.innerHTML = '';

            if (window.filteredPendingApprovals.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = '沒有符合條件的項目。';
                row.appendChild(cell);
                listBody.appendChild(row);
                pagination.textContent = '';
                return;
            }

            const start = (page - 1) * window.pendingRowsPerPage;
            const end = start + window.pendingRowsPerPage;
            const items = window.filteredPendingApprovals.slice(start, end);

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const row = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pending-approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' → ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                const transferType = item.transferType || '地點';
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('保管人') && transferType.includes('使用人')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = '保管人+使用人';
                } else if (transferType.includes('保管人')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = '保管人';
                } else if (transferType.includes('使用人')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = '使用人';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = '地點';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                fragment.appendChild(row);
            });

            listBody.appendChild(fragment);
            renderPendingPagination();
            document.getElementById('pending-select-all').checked = false;
        }

        function renderPendingPagination() {
            const pagination = document.getElementById('pending-pagination');
            const totalPages = Math.ceil(window.filteredPendingApprovals.length / window.pendingRowsPerPage);

            if (window.filteredPendingApprovals.length === 0) {
                pagination.innerHTML = '<span class="text-muted">沒有符合篩選條件的項目。</span>';
                return;
            }
            if (totalPages <= 1) {
                pagination.innerHTML = `<span class="text-muted">共 ${window.filteredPendingApprovals.length} 筆資料</span>`;
                return;
            }

            const info = document.createElement('span');
            info.className = 'text-muted';
            info.textContent = `共 ${window.filteredPendingApprovals.length} 筆資料，第 ${window.pendingCurrentPage} / ${totalPages} 頁`;

            const nav = document.createElement('ul');
            nav.className = 'pagination mb-0';

            const prev = document.createElement('li');
            prev.className = `page-item ${window.pendingCurrentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.textContent = '上一頁';
            prevLink.addEventListener('click', () => {
                if (window.pendingCurrentPage > 1) renderPendingPage(window.pendingCurrentPage - 1);
            });
            prev.appendChild(prevLink);

            const next = document.createElement('li');
            next.className = `page-item ${window.pendingCurrentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.textContent = '下一頁';
            nextLink.addEventListener('click', () => {
                if (window.pendingCurrentPage < totalPages) renderPendingPage(window.pendingCurrentPage + 1);
            });
            next.appendChild(nextLink);

            nav.appendChild(prev);
            nav.appendChild(next);

            pagination.innerHTML = '';
            pagination.appendChild(info);
            pagination.appendChild(nav);
        }

        function renderAssignmentAssetsModal() {
            const titleEl = document.getElementById('assignmentAssetsTitle');
            const metaEl = document.getElementById('assignment-assets-meta');
            const bodyEl = document.getElementById('assignment-assets-body');
            const paginationEl = document.getElementById('assignment-assets-pagination');
            const state = window.assignmentModalState || {};

            const normalizedKey = state.key || '未指派';
            const titleLabel = normalizedKey === '未指派'
                ? '未指派'
                : (String(normalizedKey).includes('@')
                    ? `${state.title || normalizedKey} (${normalizedKey})`
                    : (state.title || normalizedKey));

            if (titleEl) titleEl.textContent = `分派清單 - ${titleLabel}`;
            if (metaEl) metaEl.textContent = state.loading
                ? '載入中...'
                : (state.error ? '' : `共 ${(state.assets || []).length} 筆資產`);

            if (!bodyEl || !paginationEl) return;
            bodyEl.innerHTML = '';
            paginationEl.innerHTML = '';

            if (state.loading) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>載入中...';
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            if (state.error) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-danger';
                cell.textContent = state.error;
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            const assets = Array.isArray(state.assets) ? state.assets : [];
            const total = assets.length;
            if (total === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.textContent = '沒有符合條件的資產';
                row.appendChild(cell);
                bodyEl.appendChild(row);
                return;
            }

            const pageCount = Math.max(1, Math.ceil(total / window.assignmentRowsPerPage));
            let page = Number(state.page || 1);
            if (page > pageCount) page = pageCount;

            const start = (page - 1) * window.assignmentRowsPerPage;
            const end = start + window.assignmentRowsPerPage;
            const pageAssets = assets.slice(start, end);
            const fragment = document.createDocumentFragment();

            pageAssets.forEach(asset => {
                const row = document.createElement('tr');
                const cells = [
                    asset.assetId,
                    asset.assetName,
                    asset.userName,
                    asset.keeperName,
                    asset.location,
                    asset.inventoryResult
                ];
                cells.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value || '';
                    row.appendChild(td);
                });
                fragment.appendChild(row);
            });

            bodyEl.appendChild(fragment);

            if (pageCount <= 1) return;

            const info = document.createElement('div');
            info.className = 'text-muted';
            info.textContent = `第 ${page} / ${pageCount} 頁`;
            paginationEl.appendChild(info);

            const nav = document.createElement('div');
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-sm btn-outline-secondary mr-2';
            prevBtn.textContent = '上一頁';
            prevBtn.disabled = page <= 1;
            prevBtn.addEventListener('click', () => {
                if (page > 1) {
                    window.assignmentModalState.page = page - 1;
                    renderAssignmentAssetsModal();
                }
            });

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-sm btn-outline-secondary';
            nextBtn.textContent = '下一頁';
            nextBtn.disabled = page >= pageCount;
            nextBtn.addEventListener('click', () => {
                if (page < pageCount) {
                    window.assignmentModalState.page = page + 1;
                    renderAssignmentAssetsModal();
                }
            });

            nav.appendChild(prevBtn);
            nav.appendChild(nextBtn);
            paginationEl.appendChild(nav);
        }

        function submitPendingApproval() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('請至少勾選一個項目再送出。');
                return;
            }

            showToastProgress('正在處理接收作業...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('處理完成！', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('處理失敗！', 300);
                    alert('處理失敗：' + error.message);
                })
                .processBatchApproval(selected);
        }

        function submitPendingRejection() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('請至少勾選一個項目再送出。');
                return;
            }
            if (!confirm(`確定要拒絕所選的 ${selected.length} 筆待接收資產嗎？`)) {
                return;
            }

            showToastProgress('正在處理拒絕作業...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('處理完成！', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('處理失敗！', 300);
                    alert('處理失敗：' + error.message);
                })
                .processBatchRejection(selected);
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = window.duplicateGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `共 ${totalGroups} 組，${totalRows} 筆資產`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `產編：${group.assetId || '(空白)'}（${group.items.length} 筆）`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.leader,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }
    </script>

    <!-- React 應用 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // Icons (參考 onepage_example.html)
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const SearchIcon = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;

        const STATUS_COLORS = {
            '在庫': 'bg-green-50 text-green-700 border-green-200',
            '出借中': 'bg-yellow-50 text-yellow-700 border-yellow-200',
            '借出中': 'bg-yellow-50 text-yellow-700 border-yellow-200',
            '報廢中': 'bg-red-50 text-red-700 border-red-200',
            '已報廢': 'bg-gray-50 text-gray-700 border-gray-200',
            '轉移中': 'bg-blue-50 text-blue-700 border-blue-200',
            '待接收': 'bg-purple-50 text-purple-700 border-purple-200'
        };

        const STATUS_DETAIL_TYPES = {
            '轉移中': 'transfer',
            '出借中': 'lending',
            '借出中': 'lending',
            '報廢中': 'scrap'
        };

        const STATUS_DETAIL_THEMES = {
            transfer: {
                title: '轉移中資訊',
                icon: 'fa-right-left',
                headerClass: 'bg-cyan-50',
                textClass: 'text-cyan-800'
            },
            lending: {
                title: '出借中資訊',
                icon: 'fa-hand-holding-hand',
                headerClass: 'bg-amber-50',
                textClass: 'text-amber-800'
            },
            scrap: {
                title: '報廢中資訊',
                icon: 'fa-trash-can',
                headerClass: 'bg-red-50',
                textClass: 'text-red-700'
            }
        };

        // LoadingCard 組件 - 卡片載入佔位符（水平長方形樣式）
        const LoadingCard = () => (
            <div className="status-card px-4 py-3 rounded-2xl">
                <div className="flex items-center gap-3">
                    <div className="flex flex-col items-center gap-1">
                        <div className="w-5 h-5 bg-slate-200 rounded animate-pulse"></div>
                        <div className="status-card__bar bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="h-4 bg-slate-200 rounded w-16 mb-1 animate-pulse"></div>
                        <div className="h-3 bg-slate-100 rounded w-24 animate-pulse"></div>
                    </div>
                    <div className="w-8 h-7 bg-slate-200 rounded animate-pulse"></div>
                </div>
            </div>
        );

        // DashboardCards 組件
        const DashboardCards = ({ counts, onClick, isLoading }) => {
            // 載入狀態渲染
            if (isLoading) {
                return (
                    <div className="dashboard-grid mb-6">
                        {[1, 2, 3, 4, 5, 6].map(i => <LoadingCard key={i} />)}
                    </div>
                );
            }

            const cards = [
                {
                    id: 'transferring',
                    label: '轉移中',
                    count: counts.transferring,
                    color: 'bg-cyan-500',
                    icon: '🔁',
                    description: '我申請轉出、等待對方接收'
                },
                {
                    id: 'pending',
                    label: '待接收',
                    count: counts.pending,
                    color: 'bg-blue-500',
                    icon: '📥',
                    description: '需要您確認接收的資產'
                },
                {
                    id: 'lent',
                    label: '出借中',
                    count: counts.lent,
                    color: 'bg-green-500',
                    icon: '📤',
                    description: '目前出借的資產'
                },
                {
                    id: 'scrapPending',
                    label: '待列印報廢申請單',
                    count: counts.scrapPending,
                    color: 'bg-orange-500',
                    icon: '🗑️',
                    description: '報廢中的資產（需列印申請單）'
                },
                {
                    id: 'transferPending',
                    label: '待列印轉移申請單',
                    count: counts.transferPending,
                    color: 'bg-purple-500',
                    icon: '🔄',
                    description: '已被接收的資產（需列印轉移申請單）'
                },
                {
                    id: 'inventory',
                    label: '待盤點',
                    count: counts.inventory,
                    color: 'bg-red-500',
                    icon: '📋',
                    description: '需要您完成的盤點任務'
                }
            ];

            return (
                <div className="dashboard-grid mb-6">
                    {cards.map((card, index) => (
                        <button
                            key={card.id}
                            onClick={() => onClick(card.id)}
                            style={{ '--delay': `${index * 60}ms` }}
                            className="status-card rounded-2xl px-4 py-3 cursor-pointer text-left group focus:outline-none focus:ring-2 focus:ring-teal-200"
                        >
                            <div className="flex items-center gap-3">
                                {/* 左側：圖標與彩色指示條 */}
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-2xl">{card.icon}</span>
                                    <div className={`status-card__bar ${card.color} opacity-80`}></div>
                                </div>
                                {/* 中間：標題與描述 */}
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-slate-600 group-hover:text-slate-800 transition-colors">{card.label}</p>
                                    <p className="text-xs text-slate-400 whitespace-pre-wrap" title={card.description}>{card.description}</p>
                                </div>
                                {/* 右側：數字 */}
                                <div className="status-card__count text-2xl font-bold text-slate-800 tabular-nums">
                                    {card.count}
                                </div>
                            </div>
                        </button>
                    ))}
                </div>
            );
        };

        // InventoryDashboardCard 組件 - 盤點進度監控儀表板
        const InventoryDashboardCard = ({ isAdminView, currentUserEmail, currentUserGroup, onRefresh, inventorySessions }) => {
            const [selectedSessionId, setSelectedSessionId] = useState('');
            const [groupStats, setGroupStats] = useState([]);
            const [isLoadingStats, setIsLoadingStats] = useState(false);
            const [statsError, setStatsError] = useState('');
            const [isExpanded, setIsExpanded] = useState(true);
            const sessionDetailsCacheRef = useRef(new Map());

            const sessions = useMemo(() => inventorySessions?.activeSessions || [], [inventorySessions]);
            const isLoadingSessions = !inventorySessions;
            const isLoadingDashboard = isLoadingSessions || (sessions.length > 0 && !selectedSessionId);

            const getSessionSortKey = useCallback((session) => {
                const idValue = String(session?.inventoryId || '');
                const idNumber = Number(idValue.replace(/^INV/i, ''));
                if (!Number.isNaN(idNumber) && idNumber > 0) {
                    return idNumber;
                }
                const parsed = Date.parse(session?.inventoryDate || '');
                return Number.isNaN(parsed) ? 0 : parsed;
            }, []);

            const pickLatestSessionId = useCallback((sessionList) => {
                if (!sessionList || sessionList.length === 0) return '';
                const sorted = sessionList.slice().sort((a, b) => getSessionSortKey(b) - getSessionSortKey(a));
                return sorted[0]?.inventoryId || '';
            }, [getSessionSortKey]);

            useEffect(() => {
                if (sessions.length === 0) {
                    setSelectedSessionId('');
                    setGroupStats([]);
                    return;
                }
                const exists = sessions.some(s => s.inventoryId === selectedSessionId);
                if (!exists) {
                    setSelectedSessionId(pickLatestSessionId(sessions));
                }
            }, [sessions, selectedSessionId, pickLatestSessionId]);

            const fetchGroupStats = useCallback((sessionId) => {
                if (!sessionId) {
                    setGroupStats([]);
                    setStatsError('');
                    setIsLoadingStats(false);
                    return;
                }
                setIsLoadingStats(true);
                setStatsError('');
                google.script.run
                    .withSuccessHandler(result => {
                        setGroupStats(result || []);
                        setIsLoadingStats(false);
                    })
                    .withFailureHandler(error => {
                        console.error('載入盤點分組統計失敗:', error);
                        setGroupStats([]);
                        setStatsError(error.message || '載入失敗');
                        setIsLoadingStats(false);
                    })
                    .getInventoryStatsByAssignee(sessionId);
            }, []);

            useEffect(() => {
                fetchGroupStats(selectedSessionId);
            }, [selectedSessionId, fetchGroupStats]);

            const normalizeAssignmentKey = useCallback((value) => {
                const raw = String(value || '').trim();
                if (!raw) return '';
                return raw.includes('@') ? raw.toLowerCase() : raw;
            }, []);

            const resolveAssignmentKey = useCallback((value) => {
                const normalized = normalizeAssignmentKey(value);
                return normalized || '未指派';
            }, [normalizeAssignmentKey]);

            const normalizeEmail = useCallback((value) => String(value || '').trim().toLowerCase(), []);
            const normalizeGroup = useCallback((value) => String(value || '').trim(), []);
            const canViewAssignmentDetails = useCallback((assignmentKey) => {
                if (isAdminView) return true;
                if (!assignmentKey || assignmentKey === '未指派') return false;
                if (assignmentKey.includes('@')) {
                    return assignmentKey === normalizeEmail(currentUserEmail);
                }
                return assignmentKey === normalizeGroup(currentUserGroup);
            }, [isAdminView, currentUserEmail, currentUserGroup, normalizeEmail, normalizeGroup]);

            const openAssignmentDetails = useCallback((stat) => {
                if (!selectedSessionId) {
                    alert('尚未選擇盤點會話');
                    return;
                }

                const assignmentKey = resolveAssignmentKey(stat?.email || stat?.name || stat?.displayName);
                if (!canViewAssignmentDetails(assignmentKey)) {
                    alert('一般使用者僅能查看分配給自己或所屬組別的清單。');
                    return;
                }
                const displayName = stat?.displayName || stat?.name || stat?.email || assignmentKey;

                if (typeof window.openInventoryAssignmentModal === 'function') {
                    window.openInventoryAssignmentModal({
                        key: assignmentKey,
                        title: displayName,
                        assets: [],
                        page: 1,
                        loading: true,
                        error: ''
                    });
                }

                const renderAssets = (details) => {
                    const list = Array.isArray(details) ? details : [];
                    const assets = list.filter(asset => resolveAssignmentKey(asset.assignedUser) === assignmentKey);
                    if (typeof window.updateInventoryAssignmentModal === 'function') {
                        window.updateInventoryAssignmentModal({
                            key: assignmentKey,
                            title: displayName,
                            assets: assets,
                            page: 1,
                            loading: false,
                            error: ''
                        });
                    }
                };

                const cached = sessionDetailsCacheRef.current.get(selectedSessionId);
                if (cached) {
                    renderAssets(cached);
                    return;
                }

                google.script.run
                    .withSuccessHandler(details => {
                        const safeDetails = Array.isArray(details) ? details : [];
                        sessionDetailsCacheRef.current.set(selectedSessionId, safeDetails);
                        renderAssets(safeDetails);
                    })
                    .withFailureHandler(error => {
                        const message = error?.message || '載入失敗';
                        if (typeof window.updateInventoryAssignmentModal === 'function') {
                            window.updateInventoryAssignmentModal({
                                key: assignmentKey,
                                title: displayName,
                                assets: [],
                                page: 1,
                                loading: false,
                                error: message
                            });
                        } else {
                            alert(`載入詳細清單失敗：${message}`);
                        }
                    })
                    .getInventoryDetails(selectedSessionId);
            }, [resolveAssignmentKey, selectedSessionId, canViewAssignmentDetails]);

            // 如果沒有進行中的會話，不顯示卡片
            if (!isLoadingSessions && sessions.length === 0) {
                return null;
            }

            const selectedSession = sessions.find(s => s.inventoryId === selectedSessionId);
            const totalCount = Number(selectedSession?.totalCount || 0);
            const verifiedCount = Number(selectedSession?.verifiedCount || 0);
            const progressPercent = totalCount > 0 ? Math.round((verifiedCount / totalCount) * 100) : 0;
            
            // 處理完成盤點
            const handleCompleteSession = () => {
                if (!isAdminView) {
                    alert('僅管理員可執行此操作');
                    return;
                }

                if (!selectedSessionId) {
                    alert('尚未選擇盤點會話');
                    return;
                }

                if (totalCount === 0) {
                    alert('此盤點會話沒有可處理的資產');
                    return;
                }
                
                if (verifiedCount < totalCount) {
                    alert(`尚有 ${totalCount - verifiedCount} 筆未盤點，無法完成會話。`);
                    return;
                }
                
                if (!confirm(`確定要完成盤點會話「${selectedSessionId}」嗎？\n\n此操作將結束此會話，無法再修改盤點結果。`)) {
                    return;
                }
                
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            alert(`盤點會話已完成！\n\n統計：\n正常：${result.stats.normal}\n遺失：${result.stats.missing}\n損壞：${result.stats.damaged}`);
                            onRefresh && onRefresh();
                        } else {
                            alert(result.message || '操作失敗');
                        }
                    })
                    .withFailureHandler(error => {
                        alert('完成盤點失敗：' + error.message);
                    })
                    .completeInventorySession(selectedSessionId);
            };
            
            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    {/* 卡片標題（可折疊） */}
                    <div 
                        className="px-4 py-3 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors"
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <div className="flex items-center gap-2">
                            <i className="fa-solid fa-chart-line text-teal-500"></i>
                            <h3 className="text-base font-semibold text-slate-800">盤點進度監控儀表板</h3>
                            {!isExpanded && selectedSession && (
                                <span className="text-xs text-slate-500 ml-2">
                                    ({selectedSession.inventoryDate} - {progressPercent}%)
                                </span>
                            )}
                        </div>
                        <i className={`fa-solid fa-chevron-${isExpanded ? 'up' : 'down'} text-slate-400 transition-transform`}></i>
                    </div>
                    
                    {/* 卡片內容 */}
                    {isExpanded && (
                        <div className="p-4">
                            {isLoadingDashboard ? (
                                <div className="text-center py-8">
                                    <i className="fa-solid fa-spinner fa-spin text-2xl text-teal-500"></i>
                                    <p className="text-sm text-slate-500 mt-2">載入中...</p>
                                </div>
                            ) : (
                                <>
                                    {/* 會話選擇下拉選單 */}
                                    {sessions.length > 1 && (
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-slate-700 mb-2">選擇盤點會話</label>
                                            <select 
                                                value={selectedSessionId}
                                                onChange={(e) => setSelectedSessionId(e.target.value)}
                                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                            >
                                                {sessions.map(session => (
                                                    <option key={session.inventoryId} value={session.inventoryId}>
                                                        {session.inventoryDate} - {session.inventoryPerson}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* 總體進度 */}
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div className="text-center p-3 bg-slate-50 rounded-lg">
                                            <div className="text-3xl font-bold text-teal-600">{progressPercent}%</div>
                                            <div className="text-xs text-slate-500 mt-1">總體完成率</div>
                                        </div>
                                        <div className="text-center p-3 bg-slate-50 rounded-lg">
                                            <div className="text-3xl font-bold text-slate-700">{verifiedCount}/{totalCount}</div>
                                            <div className="text-xs text-slate-500 mt-1">已盤點/總數</div>
                                        </div>
                                    </div>
                                    
                                    {/* 進度條 */}
                                    <div className="mb-4">
                                        <div className="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                                            <div 
                                                className="bg-gradient-to-r from-teal-500 to-teal-600 h-full transition-all duration-300"
                                                style={{ width: `${progressPercent}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    
                                    {/* 分組統計表 */}
                                    {isLoadingStats ? (
                                        <div className="text-center text-sm text-slate-500 py-4">載入分組統計中...</div>
                                    ) : statsError ? (
                                        <div className="text-center text-sm text-rose-600 py-4">分組統計載入失敗：{statsError}</div>
                                    ) : groupStats.length > 0 ? (
                                        <div className="overflow-hidden rounded-lg border border-slate-200 mb-4">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">分配對象</th>
                                                        <th className="px-3 py-2 text-left font-medium text-slate-600">進度</th>
                                                        <th className="px-3 py-2 text-right font-medium text-slate-600">數量</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {groupStats.map((stat, idx) => {
                                                        const assignedCount = Number(stat.assignedCount || 0);
                                                        const verifiedCountValue = Number(stat.verifiedCount || 0);
                                                        const percent = assignedCount > 0
                                                            ? Math.round((verifiedCountValue / assignedCount) * 100)
                                                            : 0;
                                                        let colorClass = 'bg-red-500';
                                                        if (percent >= 50) colorClass = 'bg-yellow-500';
                                                        if (percent >= 100) colorClass = 'bg-green-500';
                                                        const label = stat.displayName || stat.name || stat.email || '未指派';
                                                        const isUnassigned = label === '未指派';
                                                        const assignmentKey = resolveAssignmentKey(stat?.email || stat?.name || stat?.displayName);
                                                        const canView = canViewAssignmentDetails(assignmentKey);
                                                        
                                                        return (
                                                            <tr
                                                                key={idx}
                                                                className={`hover:bg-slate-50 ${canView ? 'cursor-pointer' : 'opacity-60'}`}
                                                                onClick={canView ? () => openAssignmentDetails(stat) : undefined}
                                                                title={canView ? '查看詳細清單' : '僅限本人/組別查看'}
                                                            >
                                                                <td className="px-3 py-2">
                                                                    {isUnassigned ? (
                                                                        <span className="inline-flex items-center gap-2 text-red-600 font-medium">
                                                                            <span>⚠️ 未指派</span>
                                                                            <span className={`text-xs font-normal ${canView ? 'text-teal-600' : 'text-slate-400'}`}>
                                                                                {canView ? '查看' : '限本人/組別'}
                                                                            </span>
                                                                        </span>
                                                                    ) : (
                                                                        <span className="inline-flex items-center gap-2">
                                                                            <span>{label}</span>
                                                                            <span className={`text-xs ${canView ? 'text-teal-600' : 'text-slate-400'}`}>
                                                                                {canView ? '查看' : '限本人/組別'}
                                                                            </span>
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="flex-1 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                                            <div 
                                                                                className={`${colorClass} h-full transition-all`}
                                                                                style={{ width: `${percent}%` }}
                                                                            ></div>
                                                                        </div>
                                                                        <span className="text-xs text-slate-600 w-10 text-right">{percent}%</span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-3 py-2 text-right text-slate-600">
                                                                    {verifiedCountValue} / {assignedCount}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="text-center text-sm text-slate-500 py-4">尚無分組統計資料</div>
                                    )}
                                    
                                    {/* 管理員按鈕 */}
                                    {isAdminView && (
                                        <div className="mt-4 flex justify-end gap-2">
                                            <button
                                                onClick={() => {
                                                    fetchGroupStats(selectedSessionId);
                                                    onRefresh && onRefresh();
                                                }}
                                                className="px-4 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors"
                                            >
                                                <i className="fa-solid fa-rotate mr-2"></i>
                                                重新載入
                                            </button>
                                            <button
                                                onClick={handleCompleteSession}
                                                disabled={!selectedSessionId || totalCount === 0 || verifiedCount < totalCount}
                                                className="px-4 py-2 text-sm bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            >
                                                <i className="fa-solid fa-check mr-2"></i>
                                                完成盤點
                                            </button>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const InventoryManagementModal = ({ onClose, isAdminView }) => {
            const [historyItems, setHistoryItems] = useState([]);
            const [isHistoryLoading, setIsHistoryLoading] = useState(true);
            const [historyError, setHistoryError] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [filterValue, setFilterValue] = useState('');
            const [filterOptions, setFilterOptions] = useState({ locations: [], keepers: [], users: [], groups: [] });
            const [optionsError, setOptionsError] = useState('');
            const [isOptionsLoading, setIsOptionsLoading] = useState(true);
            const [isStarting, setIsStarting] = useState(false);
            const [startError, setStartError] = useState('');
            const [startMessage, setStartMessage] = useState('');
            const [deleteMessage, setDeleteMessage] = useState('');
            const [deleteError, setDeleteError] = useState('');
            const [deletingSessionId, setDeletingSessionId] = useState('');
            const [groupDropdownOpen, setGroupDropdownOpen] = useState(false);
            const pendingStartOptionsRef = useRef(null);
            const groupDropdownRef = useRef(null);

            const runScript = useCallback((fnName, ...args) => new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)[fnName](...args);
            }), []);

            const loadModalData = useCallback((options = {}) => {
                const { keepDeleteMessage = false } = options;
                setIsHistoryLoading(true);
                setHistoryError('');
                setOptionsError('');
                setStartError('');
                setStartMessage('');
                setIsOptionsLoading(true);
                if (!keepDeleteMessage) {
                    setDeleteMessage('');
                    setDeleteError('');
                }

                const historyPromise = runScript('getInventoryHistory', true);
                const optionsPromise = runScript('getInventoryData');

                Promise.allSettled([historyPromise, optionsPromise]).then(results => {
                    const [historyResult, optionsResult] = results;

                    if (historyResult.status === 'fulfilled') {
                        const history = historyResult.value;
                        if (history === null) {
                            setHistoryError('載入歷史記錄失敗：資料格式錯誤');
                            setHistoryItems([]);
                        } else {
                            setHistoryItems(Array.isArray(history) ? history : []);
                        }
                    } else {
                        const message = historyResult.reason?.message || String(historyResult.reason || '載入失敗');
                        setHistoryError(`載入歷史記錄失敗：${message}`);
                        setHistoryItems([]);
                    }

                    let optionsErrorMessage = '';
                    if (optionsResult.status === 'fulfilled' && optionsResult.value) {
                        setFilterOptions({
                            locations: optionsResult.value.locations || [],
                            keepers: optionsResult.value.keepers || [],
                            users: optionsResult.value.users || [],
                            groups: optionsResult.value.groups || []
                        });
                    } else {
                        const message = optionsResult.reason?.message || String(optionsResult.reason || '載入失敗');
                        optionsErrorMessage = `盤點範圍載入失敗：${message}`;
                        setFilterOptions({ locations: [], keepers: [], users: [], groups: [] });
                    }

                    setOptionsError(optionsErrorMessage);
                    setIsOptionsLoading(false);
                    setIsHistoryLoading(false);
                });
            }, [runScript]);

            useEffect(() => {
                loadModalData();
            }, [loadModalData]);

            useEffect(() => {
                setFilterValue(filterType === 'group' ? [] : '');
                if (filterType !== 'group') {
                    setGroupDropdownOpen(false);
                }
            }, [filterType]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (groupDropdownRef.current && !groupDropdownRef.current.contains(event.target)) {
                        setGroupDropdownOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const hideAssignmentModal = useCallback(() => {
                if (window.$ && typeof window.$.fn?.modal === 'function') {
                    window.$('#assignmentModeModal').modal('hide');
                }
            }, []);

            const handleOverlayClick = (event) => {
                if (event.target === event.currentTarget) {
                    hideAssignmentModal();
                    onClose();
                }
            };

            const submitStartSession = useCallback((options) => {
                setIsStarting(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setIsStarting(false);
                        if (result && result.success) {
                            loadModalData();
                            setStartMessage(result.message || '盤點會話已成功建立。');
                        } else {
                            setStartError(result?.error || '開始盤點失敗');
                        }
                    })
                    .withFailureHandler(error => {
                        setIsStarting(false);
                        setStartError(error.message || '開始盤點失敗');
                    })
                    .startInventorySession(options);
            }, [loadModalData]);

            const handleAssignmentModeConfirm = useCallback(() => {
                const selectedMode = document.querySelector('input[name="assignmentMode"]:checked');
                const assignmentMode = selectedMode ? selectedMode.value : 'person';
                const options = pendingStartOptionsRef.current;
                pendingStartOptionsRef.current = null;
                hideAssignmentModal();
                if (!options) return;
                submitStartSession({
                    ...options,
                    assignmentMode: assignmentMode
                });
            }, [hideAssignmentModal, submitStartSession]);

            const handleAssignmentModeCancel = useCallback(() => {
                pendingStartOptionsRef.current = null;
                hideAssignmentModal();
            }, [hideAssignmentModal]);

            useEffect(() => {
                window.inventoryConfirmAssignmentMode = handleAssignmentModeConfirm;
                window.inventoryCancelAssignmentMode = handleAssignmentModeCancel;
                return () => {
                    delete window.inventoryConfirmAssignmentMode;
                    delete window.inventoryCancelAssignmentMode;
                    hideAssignmentModal();
                };
            }, [handleAssignmentModeConfirm, handleAssignmentModeCancel]);

            const handleStartSession = () => {
                setStartError('');
                setStartMessage('');

                let selectedValue = '';
                if (filterType === 'location') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('請選擇地點');
                        return;
                    }
                } else if (filterType === 'keeper') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('請選擇保管人');
                        return;
                    }
                } else if (filterType === 'user') {
                    selectedValue = filterValue;
                    if (!selectedValue) {
                        setStartError('請選擇使用人');
                        return;
                    }
                } else if (filterType === 'group') {
                    if (selectedGroups.length === 0) {
                        setStartError('請選擇組別');
                        return;
                    }
                    selectedValue = selectedGroups;
                }

                const options = {
                    filterType: filterType,
                    filterValue: selectedValue,
                    assetIds: []
                };

                if (isAdminView) {
                    pendingStartOptionsRef.current = options;
                    if (window.$ && typeof window.$.fn?.modal === 'function') {
                        window.$('#assignmentModeModal').modal('show');
                    } else {
                        submitStartSession({ ...options, assignmentMode: 'person' });
                    }
                    return;
                }
                submitStartSession({ ...options, assignmentMode: 'person' });
            };

            const selectedGroups = Array.isArray(filterValue) ? filterValue : [];
            const availableGroups = filterOptions.groups || [];
            const isGroupOptionsLoading = isOptionsLoading && availableGroups.length === 0;
            const toggleGroupOption = (group) => {
                setFilterValue(prev => {
                    const current = Array.isArray(prev) ? prev : [];
                    if (current.includes(group)) {
                        return current.filter(item => item !== group);
                    }
                    return [...current, group];
                });
            };
            const removeGroupOption = (group) => {
                setFilterValue(prev => {
                    const current = Array.isArray(prev) ? prev : [];
                    return current.filter(item => item !== group);
                });
            };
            const selectAllGroups = () => {
                setFilterValue(availableGroups.slice());
            };
            const clearGroups = () => {
                setFilterValue([]);
            };

            const startDisabled = isStarting;

            const handleDeleteSession = (sessionId) => {
                if (!sessionId) return;
                const shouldDelete = confirm(`確定要刪除盤點會話「${sessionId}」嗎？\n\n此操作會刪除盤點紀錄與明細，無法復原。`);
                if (!shouldDelete) return;

                setDeleteMessage('');
                setDeleteError('');
                setDeletingSessionId(sessionId);

                google.script.run
                    .withSuccessHandler(result => {
                        setDeletingSessionId('');
                        if (result && result.success) {
                            setDeleteMessage(result.message || '盤點會話已刪除。');
                            loadModalData({ keepDeleteMessage: true });
                        } else {
                            setDeleteError(result?.error || '刪除失敗');
                        }
                    })
                    .withFailureHandler(error => {
                        setDeletingSessionId('');
                        setDeleteError(error.message || '刪除失敗');
                    })
                    .deleteInventorySession(sessionId);
            };

            const renderHistoryContent = () => {
                if (isHistoryLoading) {
                    return (
                        <div className="inventory-empty-state">
                            <i className="fa-solid fa-spinner fa-spin mr-2 text-slate-400"></i>
                            載入歷史記錄中...
                        </div>
                    );
                }

                if (historyError) {
                    return (
                        <div className="inventory-empty-state text-rose-600">{historyError}</div>
                    );
                }

                if (!historyItems || historyItems.length === 0) {
                    return (
                        <div className="inventory-empty-state">尚無歷史記錄</div>
                    );
                }

                return historyItems.map((record, index) => {
                    const statusValue = record.status || '';
                    const statusCode = record.statusCode || '';
                    const isCompleted = statusValue === '已完成' || statusCode === 'COMPLETED';
                    const isOpen = statusValue === '進行中' || statusCode === 'OPEN';
                    const badgeClass = isCompleted
                        ? 'inventory-badge inventory-badge--completed'
                        : isOpen
                            ? 'inventory-badge inventory-badge--open'
                            : 'inventory-badge inventory-badge--unknown';
                    const badgeLabel = statusValue || (isCompleted ? '已完成' : isOpen ? '進行中' : '未定義');
                    const progressDisplay = record.progressDisplay ||
                        `${Number(record.verifiedCount || 0)} / ${Number(record.totalCount || 0)}`;
                    const timestamp = record.timestamp || record.inventoryDate || '未提供';
                    const summary = record.summary || record.filter || '未指定';
                    const sessionId = record.sessionId || record.inventoryId || `session-${index}`;
                    const personName = record.inventoryPerson || '';
                    const personEmail = record.inventoryEmail || '';
                    const personLabel = personEmail
                        ? `${personName || personEmail.split('@')[0]} (${personEmail})`
                        : (personName || '未指定');
                    const itemClass = `inventory-history-item${isCompleted ? ' is-completed' : ''}`;
                    const isDeleting = deletingSessionId === sessionId;

                    return (
                        <div key={sessionId} className={itemClass}>
                            <div className="inventory-history-head">
                                <div className="inventory-history-title">
                                    <span className="inventory-history-session">{sessionId}</span>
                                    <span className={badgeClass}>{badgeLabel}</span>
                                </div>
                                <div className="inventory-history-right">
                                    <div className="inventory-history-count">
                                        <div className="inventory-history-count-number">{progressDisplay}</div>
                                        <div className="inventory-history-count-label">已盤點/總計</div>
                                    </div>
                                    <button
                                        type="button"
                                        className="inventory-history-delete"
                                        onClick={() => handleDeleteSession(sessionId)}
                                        disabled={isDeleting}
                                        title="刪除盤點會話"
                                    >
                                        {isDeleting ? (
                                            <i className="fa-solid fa-spinner fa-spin"></i>
                                        ) : (
                                            <i className="fa-regular fa-trash-can"></i>
                                        )}
                                    </button>
                                </div>
                            </div>
                            <div className="inventory-history-meta">
                                <span>範圍: {summary}</span>
                                <span>開始時間: {timestamp}</span>
                            </div>
                            <div className="inventory-history-footer">
                                <i className="fa-regular fa-user"></i>
                                盤點人：{personLabel}
                            </div>
                        </div>
                    );
                });
            };

            return (
                <div
                    id="modal-inventory"
                    className="inventory-modal-overlay"
                    role="dialog"
                    aria-modal="true"
                    onClick={handleOverlayClick}
                >
                    <div className="inventory-modal" onClick={(event) => event.stopPropagation()}>
                        <div className="inventory-modal-header">
                            <h3 className="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                <i className="fa-solid fa-clipboard-list text-blue-500"></i>
                                盤點管理 (Inventory Management)
                            </h3>
                            <button
                                type="button"
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                onClick={onClose}
                                aria-label="關閉"
                            >
                                <i className="fa-solid fa-xmark text-xl"></i>
                            </button>
                        </div>
                        <div className="inventory-modal-body">
                            <div className="inventory-column">
                                <section className="inventory-card inventory-card--stretch" id="inventory-action-area">
                                    <div className="inventory-card-header inventory-card-header--primary">
                                        <i className="fa-solid fa-circle-plus"></i>
                                        開始新的盤點
                                    </div>
                                    <div className="inventory-card-body inventory-card-body--primary">
                                        <>
                                        <div className="text-sm font-semibold text-slate-700 mb-3">選擇盤點範圍：</div>
                                        <div className="inventory-option-group">
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="all"
                                                    checked={filterType === 'all'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                盤點所有資產（在庫狀態）
                                            </label>
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="location"
                                                    checked={filterType === 'location'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                依地點篩選
                                            </label>
                                            {filterType === 'location' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">請選擇地點</option>
                                                    {filterOptions.locations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="keeper"
                                                    checked={filterType === 'keeper'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                依保管人篩選
                                            </label>
                                            {filterType === 'keeper' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">請選擇保管人</option>
                                                    {filterOptions.keepers.map(keeper => (
                                                        <option key={keeper} value={keeper}>{keeper}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="user"
                                                    checked={filterType === 'user'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                依使用人篩選
                                            </label>
                                            {filterType === 'user' && (
                                                <select
                                                    value={filterValue}
                                                    onChange={(event) => setFilterValue(event.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="">請選擇使用人</option>
                                                    {filterOptions.users.map(user => (
                                                        <option key={user} value={user}>{user}</option>
                                                    ))}
                                                </select>
                                            )}
                                            <label className="inventory-option-label">
                                                <input
                                                    type="radio"
                                                    name="inventory-filter-type"
                                                    value="group"
                                                    checked={filterType === 'group'}
                                                    onChange={(event) => setFilterType(event.target.value)}
                                                />
                                                依組別篩選
                                            </label>
                                            {filterType === 'group' && (
                                                <div className="space-y-2">
                                                    <div className="text-sm text-slate-600">
                                                        選擇組別（已選 {selectedGroups.length} 項）
                                                    </div>
                                                    <div className="relative" ref={groupDropdownRef}>
                                                        <button
                                                            type="button"
                                                            onClick={() => setGroupDropdownOpen(prev => !prev)}
                                                            className={`w-full px-3 py-2 border rounded-lg text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm ${
                                                                groupDropdownOpen
                                                                    ? 'border-blue-400 ring-2 ring-blue-100'
                                                                    : 'border-slate-200 hover:border-slate-300'
                                                            }`}
                                                        >
                                                            <span className={selectedGroups.length === 0 ? 'text-slate-400' : 'text-slate-700'}>
                                                                {isGroupOptionsLoading
                                                                    ? '載入組別中...'
                                                                    : (selectedGroups.length === 0 ? '請選擇組別...' : `已選擇 ${selectedGroups.length} 個組別`)}
                                                            </span>
                                                            {isGroupOptionsLoading ? (
                                                                <i className="fa-solid fa-spinner fa-spin text-slate-400"></i>
                                                            ) : (
                                                                <i
                                                                    className={`fa-solid fa-chevron-down text-slate-400 transition-transform ${
                                                                        groupDropdownOpen ? 'rotate-180' : ''
                                                                    }`}
                                                                ></i>
                                                            )}
                                                        </button>

                                                        {groupDropdownOpen && (
                                                            <div className="absolute z-50 mt-2 w-full rounded-lg border border-slate-200 bg-white shadow-xl">
                                                                <div className="p-2 border-b border-slate-100 bg-slate-50">
                                                                    <div className="flex justify-between px-1 text-xs">
                                                                        <button
                                                                            type="button"
                                                                            onClick={selectAllGroups}
                                                                            className="text-blue-600 hover:text-blue-800 font-medium"
                                                                        >
                                                                            全選
                                                                        </button>
                                                                        <button
                                                                            type="button"
                                                                            onClick={clearGroups}
                                                                            className="text-slate-500 hover:text-slate-700"
                                                                        >
                                                                            清除所有
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div className="max-h-72 overflow-y-auto p-1">
                                                                    {isGroupOptionsLoading ? (
                                                                        <div className="py-6 text-center text-sm text-slate-500">
                                                                            <i className="fa-solid fa-spinner fa-spin mr-2"></i>
                                                                            組別載入中...
                                                                        </div>
                                                                    ) : availableGroups.length > 0 ? (
                                                                        availableGroups.map(group => (
                                                                            <label
                                                                                key={group}
                                                                                className="flex items-center gap-2 px-3 py-2.5 rounded-md cursor-pointer hover:bg-slate-50 text-sm text-slate-700"
                                                                            >
                                                                                <input
                                                                                    type="checkbox"
                                                                                    className="h-4 w-4 border-slate-300 rounded text-blue-600 focus:ring-blue-500"
                                                                                    checked={selectedGroups.includes(group)}
                                                                                    onChange={() => toggleGroupOption(group)}
                                                                                />
                                                                                <span className="flex-1">{group}</span>
                                                                                {selectedGroups.includes(group) && (
                                                                                    <i className="fa-solid fa-check text-blue-600 text-xs"></i>
                                                                                )}
                                                                            </label>
                                                                        ))
                                                                    ) : (
                                                                        <div className="py-4 text-center text-sm text-slate-500">找不到符合的組別</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {selectedGroups.length > 0 && (
                                                        <div className="flex flex-wrap gap-2">
                                                            {selectedGroups.map(group => (
                                                                <span
                                                                    key={group}
                                                                    className="inline-flex items-center gap-1 rounded-full border border-blue-200 bg-blue-50 px-2.5 py-1 text-xs text-blue-700"
                                                                >
                                                                    {group}
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => removeGroupOption(group)}
                                                                        className="inline-flex h-4 w-4 items-center justify-center rounded-full text-blue-600 hover:bg-blue-200"
                                                                        aria-label={`移除 ${group}`}
                                                                    >
                                                                        <i className="fa-solid fa-xmark text-[10px]"></i>
                                                                    </button>
                                                                </span>
                                                            ))}
                                                            <button
                                                                type="button"
                                                                onClick={clearGroups}
                                                                className="text-xs text-slate-500 hover:text-rose-600 underline"
                                                            >
                                                                清除
                                                            </button>
                                                        </div>
                                                    )}
                                                    <div className="text-xs text-slate-500">
                                                        提示：點擊下拉選單勾選，標籤可快速移除。
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="inventory-action-footer">
                                            <button
                                                id="btn-start-continue"
                                                type="button"
                                                onClick={handleStartSession}
                                                disabled={startDisabled}
                                                className="inventory-primary-button"
                                            >
                                                {isStarting ? '啟動中...' : '開始盤點'}
                                            </button>
                                        </div>
                                        {startMessage && (
                                            <div className="text-sm text-emerald-600 mt-3">{startMessage}</div>
                                        )}
                                        {optionsError && (
                                            <div className="text-sm text-rose-600 mt-2">{optionsError}</div>
                                        )}
                                        {startError && (
                                            <div className="text-sm text-rose-600 mt-2">{startError}</div>
                                        )}
                                        </>
                                    </div>
                                </section>
                            </div>

                            <div className="inventory-column">
                                <section className="inventory-card" id="history-list-container">
                                    <div className="inventory-card-header inventory-card-header--neutral">
                                        <i className="fa-solid fa-clock-rotate-left"></i>
                                        盤點歷史記錄
                                    </div>
                                    <div className="inventory-card-body inventory-card-body--neutral">
                                        {deleteMessage && (
                                            <div className="inventory-empty-state text-emerald-600">{deleteMessage}</div>
                                        )}
                                        {deleteError && (
                                            <div className="inventory-empty-state text-rose-600">{deleteError}</div>
                                        )}
                                        <div id="history-list" className="inventory-history-list">
                                            {renderHistoryContent()}
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div className="inventory-modal-footer">
                            <button
                                type="button"
                                className="inventory-secondary-button"
                                onClick={() => {
                                    hideAssignmentModal();
                                    onClose();
                                }}
                            >
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // FilterSection 組件
        const FilterSection = ({ filters, onFilterChange, isAdmin, allAssets }) => {
            // ✨ Debounce 機制：本地搜尋狀態（即時更新輸入框）
            const [localSearch, setLocalSearch] = useState(filters.search);
            const debounceTimerRef = useRef(null);

            // ✨ 當外部 filters.search 變化時同步到本地（例如 Scanner 清空搜尋框）
            useEffect(() => {
                setLocalSearch(filters.search);
            }, [filters.search]);

            // ✨ Debounce 搜尋處理函數
            const handleSearchChange = useCallback((value) => {
                setLocalSearch(value);  // 立即更新輸入框顯示

                // 清除前一個 timer
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }

                // 180ms 後才觸發實際篩選
                debounceTimerRef.current = setTimeout(() => {
                    onFilterChange('search', value);
                }, 180);
            }, [onFilterChange]);

            // ✨ 清理 timer
            useEffect(() => {
                return () => {
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                    }
                };
            }, []);

            // ✨ 暴露清空搜尋框函數供 Scanner 模組使用
            useEffect(() => {
                window.clearSearchBox = () => {
                    // ✨ 關鍵：清除 debounce timer，防止延遲篩選覆蓋清空操作
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                        debounceTimerRef.current = null;
                    }
                    setLocalSearch('');
                    onFilterChange('search', '');
                };
                return () => {
                    delete window.clearSearchBox;
                };
            }, [onFilterChange]);

            const statusOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.status))].filter(Boolean).sort()
            , [allAssets]);

            const categoryOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.category))].filter(Boolean).sort()
            , [allAssets]);

            const leaderOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.leader))].filter(Boolean).sort()
            , [allAssets]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">依狀態篩選</label>
                            <select
                                value={filters.status}
                                onChange={(e) => onFilterChange('status', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- 顯示全部 --</option>
                                {statusOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">依財產類別篩選</label>
                            <select
                                value={filters.category}
                                onChange={(e) => onFilterChange('category', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- 顯示全部 --</option>
                                {categoryOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        {isAdmin && (
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">依保管人篩選</label>
                                <select
                                    value={filters.leader}
                                    onChange={(e) => onFilterChange('leader', e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">-- 顯示全部 --</option>
                                    {leaderOptions.map(opt => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">關鍵字搜尋</label>
                            <div className="relative flex">
                                <div className="relative flex-1">
                                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                    <input
                                        id="search-box"
                                        type="text"
                                        value={localSearch}
                                        onChange={(e) => handleSearchChange(e.target.value)}
                                        placeholder="搜尋產編、名稱、保管人... (可掃描條碼按 Enter)"
                                        className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <button
                                    type="button"
                                    onClick={() => window.Scanner_toggle && window.Scanner_toggle()}
                                    className="px-3 py-2 bg-slate-100 border border-l-0 border-slate-200 rounded-r-lg hover:bg-slate-200 transition-colors"
                                    title="開啟條碼掃描器"
                                >
                                    <i className="fa-solid fa-barcode text-slate-600"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // AlertBanner 組件
        const AlertBanner = ({ count, onClick }) => (
            <div
                className="bg-yellow-50 border-l-4 border-yellow-400 py-2 px-4 mb-6 cursor-pointer hover:bg-yellow-100 transition-colors"
                onClick={onClick}
            >
                <div className="flex items-center">
                    <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span className="text-yellow-800">
                        偵測到 {count} 筆重複產編。
                        <span className="text-blue-600 ml-2 underline">點擊查看詳情</span>
                    </span>
                </div>
            </div>
        );

        // BatchActionButtons 組件 - 批次操作按鈕卡片
        const BatchActionButtons = ({ onBatchTransfer, onBatchLending, onBatchScrap, hasPendingInventory, onBatchInventory }) => {
            const [batchCount, setBatchCount] = useState(0);

            useEffect(() => {
                // 監聽 BatchList 變化
                const updateCount = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        setBatchCount(window.BatchList_getItems().length);
                    }
                };

                // 初始更新
                updateCount();

                // 定期更新（每 500ms）
                const interval = setInterval(updateCount, 500);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className="text-sm text-slate-600">
                                <i className="fa-solid fa-cart-shopping text-blue-500 mr-2"></i>
                                已選取 <span className="font-bold text-blue-600">{batchCount}</span> 項資產
                            </div>
                            {batchCount > 0 && (
                                <button
                                    onClick={() => window.BatchList_toggleSidebar && window.BatchList_toggleSidebar()}
                                    className="text-xs text-blue-500 hover:text-blue-700 underline"
                                >
                                    查看清單
                                </button>
                            )}
                        </div>
                        <div className="flex gap-2 flex-wrap">
                            <button
                                onClick={onBatchTransfer}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-right-left"></i> 批次轉移
                            </button>
                            <button
                                onClick={onBatchLending}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-hand-holding-hand"></i> 批次出借
                            </button>
                            <button
                                onClick={onBatchScrap}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-regular fa-trash-can"></i> 批次報廢
                            </button>
                            {/* 批次盤點按鈕 - 如果有待盤點資產則顯示 */}
                            {hasPendingInventory && (
                                <button
                                    onClick={onBatchInventory}
                                    disabled={batchCount === 0}
                                    className="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                                >
                                    <i className="fa-solid fa-clipboard-check"></i> 批次盤點
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // AssetTable 組件
        const AssetTable = ({ assets, isAdmin, currentUserEmail, isInventoryTaskOnly, onCancel, onRestore, onOpenTransferModal, onOpenLendingModal, onOpenScrapModal, onOpenEditModal, onOpenStatusDetail, isAssetPendingInventory, onOpenInventoryModal, selectedAssetIds = [], onAssetSelect, onSelectAll }) => {

            // ✨ 分頁設定
            const ROWS_PER_PAGE = 500;
            const [currentPage, setCurrentPage] = useState(1);

            // ✨ 當 assets 變化時（篩選條件改變），重置頁碼
            useEffect(() => {
                setCurrentPage(1);
            }, [assets]);

            // ✨ 計算分頁資料
            const totalPages = useMemo(() => {
                return Math.max(1, Math.ceil((assets?.length || 0) / ROWS_PER_PAGE));
            }, [assets]);

            const paginatedAssets = useMemo(() => {
                if (!assets) return [];
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                return assets.slice(start, end);
            }, [assets, currentPage]);

            // 計算可選資產（僅在庫）
            const selectableAssets = useMemo(() => {
                return assets ? assets.filter(a => a.status === '在庫') : [];
            }, [assets]);

            // 計算全選狀態
            const isAllSelected = selectableAssets.length > 0 &&
                selectableAssets.every(a => selectedAssetIds.includes(a.assetId));
            const isPartialSelected = selectableAssets.some(a => selectedAssetIds.includes(a.assetId)) && !isAllSelected;

            if (!assets || assets.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                        <p className="text-slate-500">沒有符合條件的資料。</p>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    {/* ✨ 分頁控制器 - 位於表格上方 */}
                    <div className="flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <span className="text-sm text-slate-600">
                            第 <span className="font-semibold text-blue-600">{currentPage}</span> / {totalPages} 頁（共 <span className="font-semibold text-blue-600">{assets.length}</span> 筆）
                        </span>
                        {totalPages > 1 && (
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                    disabled={currentPage <= 1}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage <= 1
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    上一頁
                                </button>
                                <button
                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                    disabled={currentPage >= totalPages}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage >= totalPages
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    下一頁
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm" id="asset-list">
                            <thead className="bg-slate-50 border-b border-slate-200 sticky top-0">
                                <tr>
                                    {/* 勾選欄位 - 全選 checkbox */}
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-center w-10">
                                        <input
                                            type="checkbox"
                                            checked={isAllSelected}
                                            ref={(el) => { if (el) el.indeterminate = isPartialSelected; }}
                                            onChange={(e) => onSelectAll && onSelectAll(e.target.checked)}
                                            className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                            title={`全選所有「在庫」資產 (${selectableAssets.length} 筆)`}
                                        />
                                    </th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">財產編號</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[160px] max-w-[160px]">財產名稱</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[180px] max-w-[180px]">型號/廠牌</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">使用者</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">保管人</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 min-w-[100px]">保管位置</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">財產類別</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">狀態</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-left whitespace-nowrap min-w-[160px]">操作</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {paginatedAssets.map((asset, index) => {
                                    const isTask = typeof isInventoryTaskOnly === 'function'
                                        ? isInventoryTaskOnly(asset)
                                        : false;
                                    const normalizedCurrentEmail = String(currentUserEmail || '').toLowerCase();
                                    const isOwner = normalizedCurrentEmail &&
                                        (normalizedCurrentEmail === String(asset.leaderEmail || '').toLowerCase() ||
                                            normalizedCurrentEmail === String(asset.userEmail || '').toLowerCase());
                                    const canCancel = !isTask && (isAdmin || isOwner);
                                    const isSelectable = asset.status === '在庫';
                                    const isSelected = selectedAssetIds.includes(asset.assetId);
                                    const rowHoverClass = isTask ? 'hover:bg-teal-100' : 'hover:bg-slate-50';
                                    const rowBaseClass = isTask ? 'bg-teal-50' : '';
                                    const rowSelectedClass = isSelected ? 'ring-1 ring-blue-200 ring-inset' : '';
                                    const statusBadgeClass = STATUS_COLORS[asset.status] || 'bg-slate-100 text-slate-700 border-slate-200';
                                    const statusDetailType = STATUS_DETAIL_TYPES[asset.status];
                                    const canOpenStatusDetail = statusDetailType && typeof onOpenStatusDetail === 'function';

                                    return (
                                        <tr key={`${asset.assetId}-${index}`} className={`${rowHoverClass} transition-colors ${rowBaseClass} ${rowSelectedClass} ${!isTask && isSelected ? 'bg-blue-50' : ''}`}>
                                            {/* 勾選欄位 */}
                                            <td className="px-2 py-3 text-center align-top">
                                                {isSelectable ? (
                                                    <input
                                                        type="checkbox"
                                                        className="asset-checkbox w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                        value={asset.assetId}
                                                        checked={isSelected}
                                                        onChange={() => onAssetSelect && onAssetSelect(asset.assetId)}
                                                        data-is-task={isTask ? 'true' : 'false'}
                                                    />
                                                ) : (
                                                    <span className="text-slate-300" title="僅「在庫」資產可選取">-</span>
                                                )}
                                            </td>
                                            <td className="px-2 py-3 font-mono text-slate-600 whitespace-nowrap align-top">{asset.assetId}</td>
                                            <td className="px-2 py-3 font-medium text-slate-800 align-top w-[160px] max-w-[160px]">
                                                <div className="flex items-start gap-2">
                                                    <div className="line-clamp-2 min-w-0 flex-1" title={asset.assetName}>{asset.assetName}</div>
                                                    {isTask && (
                                                        <span className="inline-flex items-center rounded-full bg-teal-100 text-teal-700 text-xs font-semibold px-2 py-0.5 whitespace-nowrap">
                                                            盤點任務
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top w-[180px] max-w-[180px]">
                                                <div className="line-clamp-2 text-xs break-all" title={asset.modelBrand}>{asset.modelBrand || '-'}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.userName}</td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.leader}</td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <div className="line-clamp-2" title={asset.location}>{asset.location}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <span className="bg-slate-100 px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    {asset.category}
                                                </span>
                                            </td>
                                            <td className="px-2 py-3 align-top">
                                                {canOpenStatusDetail ? (
                                                    <button
                                                        type="button"
                                                        onClick={() => onOpenStatusDetail(asset)}
                                                        className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap cursor-pointer transition-shadow hover:shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-200 ${statusBadgeClass}`}
                                                        title={`查看${asset.status}詳情`}
                                                        aria-label={`查看 ${asset.assetId} ${asset.status} 詳情`}
                                                    >
                                                        <span>{asset.status}</span>
                                                        <i className="fa-solid fa-circle-info text-[10px]"></i>
                                                    </button>
                                                ) : (
                                                    <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap ${statusBadgeClass}`}>
                                                        {asset.status}
                                                    </span>
                                                )}
                                            </td>
                                            <td className="px-2 py-3 text-left align-top whitespace-nowrap">
                                                {/* 操作按鈕區域 */}
                                                <div className="flex justify-start gap-2">
                                                    {/* 修改按鈕 - 僅管理員可見 */}
                                                    {isAdmin && (
                                                        <button
                                                            onClick={() => onOpenEditModal(asset)}
                                                            className="text-amber-600 hover:text-amber-800 transition-colors p-1"
                                                            title="修改基本資料"
                                                        >
                                                            <i className="fa-solid fa-pen-to-square text-lg"></i>
                                                        </button>
                                                    )}
                                                    {/* 在庫資產：顯示轉移、出借、報廢按鈕 */}
                                                    {!isTask && asset.status === '在庫' && (
                                                        <>
                                                            <button
                                                                onClick={() => onOpenTransferModal(asset)}
                                                                className="text-blue-600 hover:text-blue-800 transition-colors p-1"
                                                                title="轉移"
                                                            >
                                                                <i className="fa-solid fa-right-left text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenLendingModal(asset)}
                                                                className="text-purple-600 hover:text-purple-800 transition-colors p-1"
                                                                title="出借"
                                                            >
                                                                <i className="fa-solid fa-hand-holding-hand text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenScrapModal(asset)}
                                                                className="text-red-600 hover:text-red-800 transition-colors p-1"
                                                                title="報廢"
                                                            >
                                                                <i className="fa-regular fa-trash-can text-lg"></i>
                                                            </button>
                                                            {/* 盤點按鈕 - 如果資產在待盤點清單中顯示 */}
                                                            {isAssetPendingInventory && isAssetPendingInventory(asset.assetId) && (
                                                                <button
                                                                    onClick={() => onOpenInventoryModal(asset)}
                                                                    className="text-teal-600 hover:text-teal-800 transition-colors p-1"
                                                                    title="盤點確認"
                                                                >
                                                                    <i className="fa-solid fa-clipboard-check text-lg"></i>
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                    {isTask && (
                                                        <>
                                                            {isAssetPendingInventory && isAssetPendingInventory(asset.assetId) && (
                                                                <button
                                                                    onClick={() => onOpenInventoryModal(asset)}
                                                                    className="text-teal-600 hover:text-teal-800 transition-colors p-1"
                                                                    title="盤點確認"
                                                                >
                                                                    <i className="fa-solid fa-clipboard-check text-lg"></i>
                                                                </button>
                                                            )}
                                                            <span className="text-slate-400 p-1" title="僅限盤點">
                                                                <i className="fa-solid fa-lock text-lg"></i>
                                                            </span>
                                                        </>
                                                    )}

                                                    {/* 待接收/轉移中/報廢中：顯示取消按鈕 */}
                                                    {canCancel && (asset.status === '待接收' || asset.status === '轉移中' || asset.status === '報廢中') && (
                                                        <button
                                                            onClick={() => onCancel(asset.assetId, asset.status)}
                                                            className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                                                        >
                                                            取消
                                                        </button>
                                                    )}

                                                    {/* 已報廢：管理員可回溯 */}
                                                    {isAdmin && asset.status === '已報廢' && (
                                                        <button
                                                            onClick={() => onRestore(asset.assetId)}
                                                            className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm font-medium"
                                                        >
                                                            回溯
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // TransferringModal - 轉移中資產 Modal（用於取消轉移）
        const TransferringModal = ({ assets, isLoading, onClose, onCancelSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                newKeeper: '',
                search: ''
            });

            // 當 assets 改變時，重置勾選狀態
            useEffect(() => {
                setSelectedAssetIds([]);
                setSelectAll(false);
            }, [assets]);

            // 篩選邏輯
            const filteredAssets = useMemo(() => {
                if (!assets) return [];

                return assets.filter(asset => {
                    // 新保管人篩選
                    const matchNewKeeper = !filters.newKeeper || asset.newKeeper === filters.newKeeper;

                    // 關鍵字搜尋
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.assetName && asset.assetName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.newKeeper && asset.newKeeper.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.newLocation && asset.newLocation.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchNewKeeper && matchSearch;
                });
            }, [assets, filters]);

            // 取得唯一新保管人列表（用於篩選下拉選單）
            const uniqueNewKeepers = useMemo(() => {
                if (!assets) return [];
                return [...new Set(assets.map(a => a.newKeeper).filter(Boolean))].sort();
            }, [assets]);

            // 處理全選
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedAssetIds(filteredAssets.map(asset => asset.assetId));
                } else {
                    setSelectedAssetIds([]);
                }
            }, [filteredAssets]);

            // 處理單個勾選
            const handleCheckboxChange = useCallback((assetId) => {
                setSelectedAssetIds(prev => {
                    if (prev.includes(assetId)) {
                        const newSelected = prev.filter(id => id !== assetId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, assetId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // 處理取消轉移提交
            const handleCancelTransfer = useCallback(() => {
                if (selectedAssetIds.length === 0) {
                    alert('請至少勾選一筆要取消的項目。');
                    return;
                }

                if (!confirm(`確定要取消所選的 ${selectedAssetIds.length} 筆轉移申請嗎？\n\n⚠️ 取消後資產狀態將恢復為「在庫」。`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('正在處理取消作業...');

                let successCount = 0;
                let failCount = 0;
                let errorMessages = [];

                // 依序處理每個取消請求
                const processNext = (index) => {
                    if (index >= selectedAssetIds.length) {
                        hideToastProgress('取消完成！', 300);
                        setIsSubmitting(false);

                        let message = `取消完成！\n成功：${successCount} 筆`;
                        if (failCount > 0) {
                            message += `\n失敗：${failCount} 筆`;
                            if (errorMessages.length > 0) {
                                message += `\n\n失敗原因：\n${errorMessages.slice(0, 3).join('\n')}`;
                                if (errorMessages.length > 3) {
                                    message += `\n...及其他 ${errorMessages.length - 3} 項`;
                                }
                            }
                        }
                        alert(message);

                        if (successCount > 0) {
                            onCancelSuccess();
                        }
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            if (result.success) {
                                successCount++;
                            } else {
                                failCount++;
                                errorMessages.push(`${selectedAssetIds[index]}: ${result.error || '未知錯誤'}`);
                            }
                            processNext(index + 1);
                        })
                        .withFailureHandler(error => {
                            failCount++;
                            errorMessages.push(`${selectedAssetIds[index]}: ${error.message || '未知錯誤'}`);
                            processNext(index + 1);
                        })
                        .cancelTransferOrScrap(selectedAssetIds[index]);
                };

                processNext(0);
            }, [selectedAssetIds, onCancelSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* 標題列 - 青色主題 */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-cyan-50">
                            <h3 className="text-lg font-bold text-cyan-800">
                                <i className="fas fa-exchange-alt mr-2"></i>
                                轉移中資產 - 追蹤與取消
                            </h3>
                            <button
                                onClick={onClose}
                                className="text-cyan-600 hover:text-cyan-800 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* 主要內容區域 */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // 載入中狀態
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-cyan-500"></i>
                                    <p className="text-slate-500 font-medium">載入轉移中資料...</p>
                                </div>
                            ) : !assets || assets.length === 0 ? (
                                // 無資料狀態
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">目前沒有轉移中的資產。</p>
                                    <p className="text-slate-400 text-sm">您申請的所有轉移都已完成或已被取消。</p>
                                </div>
                            ) : (
                                <>
                                    {/* 說明區塊 */}
                                    <div className="mb-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                                        <p className="text-sm text-cyan-800">
                                            <i className="fas fa-info-circle mr-2"></i>
                                            以下是您申請但尚未被對方接收的轉移資產。您可以選擇取消轉移，資產狀態將恢復為「在庫」。
                                        </p>
                                    </div>

                                    {/* 篩選控制區 */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {/* 新保管人篩選 */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">新保管人</label>
                                                <select
                                                    value={filters.newKeeper}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, newKeeper: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- 顯示全部 --</option>
                                                    {uniqueNewKeepers.map(keeper => (
                                                        <option key={keeper} value={keeper}>{keeper}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* 關鍵字搜尋 */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">關鍵字搜尋</label>
                                                <input
                                                    type="text"
                                                    value={filters.search}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                    placeholder="財產編號、名稱、新保管人、新地點..."
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>
                                        </div>

                                        {/* 篩選結果統計 */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            顯示 <span className="font-bold text-cyan-600">{filteredAssets.length}</span> / {assets.length} 筆
                                        </div>
                                    </div>

                                    {/* 資料表格 */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>目前篩選條件下沒有符合的資料</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer accent-cyan-500"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>財產編號</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>財產名稱</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>型號/廠牌</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '14%'}}>保管人變更</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '14%'}}>使用人變更</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '13%'}}>地點變更</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>轉移類型</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>申請時間</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        const isSelected = selectedAssetIds.includes(asset.assetId);
                                                        const keeperHasChange = asset.newKeeper && asset.oldKeeper !== asset.newKeeper;
                                                        const oldUser = asset.oldUser || asset.userName || '';
                                                        const newUser = asset.newUser || '';
                                                        const userHasChange = newUser && oldUser !== newUser;
                                                        const locationHasChange = asset.newLocation && asset.oldLocation !== asset.newLocation;
                                                        const transferType = asset.transferType || '地點';

                                                        return (
                                                            <tr
                                                                key={`${asset.assetId}-${index}`}
                                                                className={`hover:bg-slate-50 transition-colors ${isSelected ? 'bg-cyan-50' : ''}`}
                                                            >
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isSelected}
                                                                        onChange={() => handleCheckboxChange(asset.assetId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer accent-cyan-500"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-700">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-700">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || ''}</td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {keeperHasChange ? (
                                                                        <>
                                                                            {asset.oldKeeper || ''}
                                                                            <span className="text-cyan-600"> → </span>
                                                                            {asset.newKeeper || ''}
                                                                        </>
                                                                    ) : (
                                                                        asset.oldKeeper || ''
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {userHasChange ? (
                                                                        <>
                                                                            {oldUser}
                                                                            <span className="text-cyan-600"> → </span>
                                                                            {newUser}
                                                                        </>
                                                                    ) : (
                                                                        oldUser
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">
                                                                    {locationHasChange ? (
                                                                        <>
                                                                            {asset.oldLocation || ''}
                                                                            <span className="text-cyan-600"> → </span>
                                                                            {asset.newLocation || ''}
                                                                        </>
                                                                    ) : (
                                                                        asset.oldLocation || ''
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3">
                                                                    <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                                                        transferType.includes('保管人') && transferType.includes('使用人')
                                                                            ? 'bg-red-100 text-red-800'
                                                                            : transferType.includes('保管人')
                                                                                ? 'bg-yellow-100 text-yellow-800'
                                                                                : transferType.includes('使用人')
                                                                                    ? 'bg-sky-100 text-sky-800'
                                                                                    : 'bg-slate-100 text-slate-800'
                                                                    }`}>
                                                                        {transferType.includes('保管人') && transferType.includes('使用人')
                                                                            ? '保管人+使用人'
                                                                            : transferType.includes('保管人')
                                                                                ? '保管人'
                                                                                : transferType.includes('使用人')
                                                                                    ? '使用人'
                                                                                    : '地點'}
                                                                    </span>
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-500 text-xs">{asset.applicationTime || '-'}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* 頁腳 */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                已選擇 <span className="font-bold text-cyan-600">{selectedAssetIds.length}</span> 筆
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    disabled={isSubmitting}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                                >
                                    關閉
                                </button>
                                <button
                                    onClick={handleCancelTransfer}
                                    disabled={selectedAssetIds.length === 0 || isSubmitting}
                                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                >
                                    {isSubmitting ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i>
                                            處理中...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-times-circle"></i>
                                            取消選取的轉移
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PendingInventoryModal = ({
          pendingItems,
          isAdmin,
          isLoading,
          error,
          onClose
        }) => {
          const [activeSessionId, setActiveSessionId] = useState('');

          const sessions = useMemo(() => {
            const map = new Map();
            (pendingItems || []).forEach(item => {
              const sessionId = item.inventoryId || 'unknown';
              if (!map.has(sessionId)) {
                map.set(sessionId, {
                  inventoryId: sessionId,
                  inventoryDate: item.inventoryDate || '',
                  inventoryPerson: item.inventoryPerson || '',
                  inventoryEmail: item.inventoryEmail || '',
                  items: []
                });
              }
              map.get(sessionId).items.push(item);
            });
            return Array.from(map.values()).sort((a, b) => {
              const left = a.inventoryDate || '';
              const right = b.inventoryDate || '';
              return right.localeCompare(left, 'zh-Hant');
            });
          }, [pendingItems]);

          useEffect(() => {
            if (sessions.length === 0) {
              setActiveSessionId('');
              return;
            }
            if (!activeSessionId || !sessions.some(session => session.inventoryId === activeSessionId)) {
              setActiveSessionId(sessions[0].inventoryId);
            }
          }, [sessions, activeSessionId]);

          const activeSession = sessions.find(session => session.inventoryId === activeSessionId) || sessions[0];
          const totalCount = (pendingItems || []).length;
          const normalizeAssigned = (item) => {
            const raw = String(item.assignedUser || '').trim();
            let type = item.assignedUserType;
            if (!type || type === 'none') {
              if (raw) {
                type = raw.includes('@') ? 'user' : 'group';
              } else {
                type = 'none';
              }
            }
            const userLabel = item.assignedUserLabel || (type === 'user' && raw ? raw.split('@')[0] : '');
            const groupLabel = item.assignedGroup || (type === 'group' ? (item.assignedUserLabel || raw) : '');
            return { type, userLabel, groupLabel, raw };
          };
          const sessionAssignmentMode = useMemo(() => {
            if (!activeSession) return 'group';
            const items = activeSession.items || [];
            let hasUser = false;
            let hasGroup = false;
            items.forEach(item => {
              const info = normalizeAssigned(item);
              if (info.type === 'user') hasUser = true;
              if (info.type === 'group') hasGroup = true;
            });
            if (hasUser && !hasGroup) return 'user';
            if (hasGroup && !hasUser) return 'group';
            if (hasUser && hasGroup) return 'mixed';
            return 'group';
          }, [activeSession]);

          const formatSessionLabel = (session) => {
            const datePart = session.inventoryDate || '未提供日期';
            const personPart = session.inventoryPerson || session.inventoryEmail || '未指定盤點人';
            return `${datePart} / ${personPart}`;
          };

          const resolveAssignedDisplay = (item) => {
            const info = normalizeAssigned(item);
            if (info.type === 'group') {
              return info.groupLabel || '未指派';
            }
            if (info.type === 'user') {
              return info.userLabel || info.raw || '未指派';
            }
            return '未指派';
          };

          const groupedItems = useMemo(() => {
            if (!activeSession) return [];
            const items = activeSession.items || [];
            if (!isAdmin) {
              return [{
                key: 'all',
                label: '全部',
                items: items.slice().sort((a, b) => String(a.assetId || '').localeCompare(String(b.assetId || ''), 'zh-Hant'))
              }];
            }
            const groupMap = new Map();
            items.forEach(item => {
              const info = normalizeAssigned(item);
              let label = '';
              if (sessionAssignmentMode === 'user') {
                if (info.type === 'group') {
                  const groupName = info.groupLabel || '未指派';
                  label = `群組：${groupName}`;
                } else {
                  label = info.userLabel || info.raw || '未指派';
                }
              } else if (sessionAssignmentMode === 'group') {
                const groupName = info.groupLabel || '未指派';
                label = groupName || '未指派';
              } else {
                if (info.type === 'group') {
                  const groupName = info.groupLabel || '未指派';
                  label = `群組：${groupName}`;
                } else if (info.type === 'user') {
                  label = info.userLabel || info.raw || '未指派';
                } else {
                  label = '未指派';
                }
              }
              if (!groupMap.has(label)) {
                groupMap.set(label, []);
              }
              groupMap.get(label).push(item);
            });

            return Array.from(groupMap.entries())
              .map(([label, items]) => ({
                key: label,
                label,
                items: items.slice().sort((a, b) => String(a.assetId || '').localeCompare(String(b.assetId || ''), 'zh-Hant'))
              }))
              .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hant'));
          }, [activeSession, isAdmin, sessionAssignmentMode]);

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                <div className="px-6 py-4 border-b flex justify-between items-center bg-red-50">
                  <h3 className="text-lg font-bold text-red-800">
                    <i className="fa-solid fa-clipboard-list mr-2"></i>
                    待盤點資產清單
                  </h3>
                  <button
                    onClick={onClose}
                    className="text-red-600 hover:text-red-800 transition-colors"
                  >
                    <i className="fas fa-times text-xl"></i>
                  </button>
                </div>

                <div className="p-6 max-h-[75vh] overflow-y-auto">
                  {isLoading ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-4">
                      <i className="fas fa-spinner fa-spin text-4xl text-red-500"></i>
                      <p className="text-slate-500 font-medium">載入待盤點清單中...</p>
                    </div>
                  ) : error ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-3 text-center">
                      <i className="fas fa-triangle-exclamation text-4xl text-red-500"></i>
                      <p className="text-slate-600 font-medium">載入失敗</p>
                      <p className="text-sm text-slate-500">{error}</p>
                    </div>
                  ) : sessions.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-4">
                      <i className="fas fa-check-circle text-5xl text-green-500"></i>
                      <p className="text-slate-500 text-lg font-medium">目前沒有待盤點的資產。</p>
                      <p className="text-slate-400 text-sm">已完成所有盤點會話或尚未開始盤點。</p>
                    </div>
                  ) : (
                    <>
                      <div className="mb-4 flex flex-wrap items-center justify-between gap-3">
                        <div className="text-sm text-slate-600">
                          共 <span className="font-semibold text-red-600">{totalCount}</span> 筆待盤點資產，<span className="font-semibold text-red-600">{sessions.length}</span> 個會話
                        </div>
                      </div>

                      <div className="border-b border-slate-200 mb-4 flex flex-wrap gap-2">
                        {sessions.map(session => (
                          <button
                            key={session.inventoryId}
                            onClick={() => setActiveSessionId(session.inventoryId)}
                            className={`px-4 py-2 rounded-t-lg text-sm border ${
                              activeSession?.inventoryId === session.inventoryId
                                ? 'bg-white border-slate-200 border-b-white text-slate-800'
                                : 'bg-slate-50 border-transparent text-slate-500 hover:text-slate-700'
                            }`}
                            title={`會話代碼：${session.inventoryId}`}
                          >
                            <div className="font-medium line-clamp-1">{formatSessionLabel(session)}</div>
                            <div className="text-xs text-slate-400">{session.items.length} 筆</div>
                          </button>
                        ))}
                      </div>

                      {activeSession && (
                        <div className="mb-4 text-sm text-slate-500">
                          會話資訊：<span className="text-slate-700">{formatSessionLabel(activeSession)}</span>
                        </div>
                      )}

                      {groupedItems.map(group => (
                        <div key={group.key} className="mb-6">
                          {isAdmin && (
                            <div className="mb-2 text-sm font-semibold text-slate-700">
                              {group.label} <span className="text-slate-400">({group.items.length} 筆)</span>
                            </div>
                          )}
                          <div className="overflow-x-auto border border-slate-200 rounded-lg">
                            <table className="w-full text-sm border-collapse">
                              <thead className="bg-slate-50 sticky top-0">
                                <tr>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">財產編號</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">財產名稱</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">使用者</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">保管人</th>
                                  <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">保管位置</th>
                                  {isAdmin && (
                                    <th className="px-3 py-2 text-left font-semibold text-slate-600 border-b">指派對象</th>
                                  )}
                                </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100">
                                {group.items.map((item, index) => (
                                  <tr key={`${group.key}-${item.inventoryId}-${item.assetId}-${index}`} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-3 py-2 font-mono text-slate-700 whitespace-nowrap">{item.assetId || '-'}</td>
                                    <td className="px-3 py-2 text-slate-700">{item.assetName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.userName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.keeperName || '-'}</td>
                                    <td className="px-3 py-2 text-slate-600">{item.location || '-'}</td>
                                    {isAdmin && (
                                      <td className="px-3 py-2 text-slate-600">{resolveAssignedDisplay(item)}</td>
                                    )}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      ))}
                    </>
                  )}
                </div>

                <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                  >
                    關閉
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // React Modals
        const LentAssetsModal = ({ lentAssetsDetails, isLoading, onClose, onReturnSuccess }) => {
            const [selectedLendIds, setSelectedLendIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                location: '',
                startDate: '',
                endDate: '',
                overdueOnly: '',
                search: ''
            });

            // 當 lentAssetsDetails 改變時，重置勾選狀態
            useEffect(() => {
                setSelectedLendIds([]);
                setSelectAll(false);
            }, [lentAssetsDetails]);

            // 篩選邏輯
            const filteredAssets = useMemo(() => {
                if (!lentAssetsDetails) return [];

                return lentAssetsDetails.filter(asset => {
                    // 地點篩選
                    const matchLocation = !filters.location || asset.lendingLocation === filters.location;

                    // 日期範圍篩選
                    const returnDate = new Date(asset.expectedReturnDate);
                    const matchDateRange =
                        (!filters.startDate || returnDate >= new Date(filters.startDate)) &&
                        (!filters.endDate || returnDate <= new Date(filters.endDate));

                    // 逾期狀態篩選
                    let matchOverdue = true;
                    if (filters.overdueOnly === 'overdue' || filters.overdueOnly === 'notOverdue') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const assetReturnDate = new Date(asset.expectedReturnDate);
                        assetReturnDate.setHours(0, 0, 0, 0);
                        const isOverdue = assetReturnDate < today;
                        matchOverdue = filters.overdueOnly === 'overdue' ? isOverdue : !isOverdue;
                    }

                    // 關鍵字搜尋
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.borrower && asset.borrower.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.reason && asset.reason.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.keeperName && asset.keeperName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.userName && asset.userName.toUpperCase().includes(filters.search.toUpperCase())) ||
                        (asset.lenderName && asset.lenderName.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchLocation && matchDateRange && matchOverdue && matchSearch;
                });
            }, [lentAssetsDetails, filters]);

            // 取得唯一地點列表（用於篩選下拉選單）
            const uniqueLocations = useMemo(() => {
                if (!lentAssetsDetails) return [];
                return [...new Set(lentAssetsDetails.map(a => a.lendingLocation).filter(Boolean))].sort();
            }, [lentAssetsDetails]);

            // 處理全選
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedLendIds(filteredAssets.map(asset => asset.lendId));
                } else {
                    setSelectedLendIds([]);
                }
            }, [filteredAssets]);

            // 處理單個勾選
            const handleCheckboxChange = useCallback((lendId) => {
                setSelectedLendIds(prev => {
                    if (prev.includes(lendId)) {
                        const newSelected = prev.filter(id => id !== lendId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, lendId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // 處理歸還提交
            const handleSubmitReturn = useCallback(() => {
                if (selectedLendIds.length === 0) {
                    alert('請至少勾選一筆要歸還的項目。');
                    return;
                }

                if (!confirm(`確定要歸還所選的 ${selectedLendIds.length} 筆資產嗎？\n\n⚠️ 請確認此資產已歸還至原存放地點。`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('正在處理歸還作業...');

                google.script.run
                    .withSuccessHandler(message => {
                        hideToastProgress('歸還完成！', 300);
                        setTimeout(() => {
                            alert(message);
                            setIsSubmitting(false);
                            onReturnSuccess();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideToastProgress('歸還失敗！', 300);
                        setIsSubmitting(false);
                        alert('歸還失敗：' + error.message);
                    })
                    .processBatchReturn(selectedLendIds);
            }, [selectedLendIds, onReturnSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* 標題列 */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800">出借中資產 - 歸還作業</h3>
                            <button
                                onClick={onClose}
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* 主要內容區域 */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // 載入中狀態
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                    <p className="text-slate-500 font-medium">載入出借資料中...</p>
                                </div>
                            ) : !lentAssetsDetails || lentAssetsDetails.length === 0 ? (
                                // 無資料狀態
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">目前沒有出借中的資產。</p>
                                    <p className="text-slate-400 text-sm">所有資產都已歸還完畢。</p>
                                </div>
                            ) : (
                                <>
                                    {/* 篩選控制區 */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {/* 地點篩選 */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">出借後地點</label>
                                                <select
                                                    value={filters.location}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, location: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- 顯示全部 --</option>
                                                    {uniqueLocations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* 日期範圍篩選 */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">預計歸還日（起）</label>
                                                <input
                                                    type="date"
                                                    value={filters.startDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">預計歸還日（迄）</label>
                                                <input
                                                    type="date"
                                                    value={filters.endDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            {/* 逾期狀態篩選 */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">逾期狀態</label>
                                                <select
                                                    value={filters.overdueOnly}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, overdueOnly: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">全部</option>
                                                    <option value="overdue">已逾期</option>
                                                    <option value="notOverdue">未逾期</option>
                                                </select>
                                            </div>
                                        </div>

                                        {/* 關鍵字搜尋 */}
                                        <div className="mt-4">
                                            <label className="block text-xs font-medium text-slate-600 mb-1">關鍵字搜尋（財產編號、保管人、使用人、出借人、借用人、出借事由）</label>
                                            <input
                                                type="text"
                                                value={filters.search}
                                                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                placeholder="輸入關鍵字搜尋..."
                                                className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                disabled={isSubmitting}
                                            />
                                        </div>

                                        {/* 篩選結果統計 */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            顯示 <span className="font-bold text-blue-600">{filteredAssets.length}</span> / {lentAssetsDetails.length} 筆
                                        </div>
                                    </div>

                                    {/* 資料表格 */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>目前篩選條件下沒有符合的資料</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>財產編號</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>財產名稱</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>型號/廠牌</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>保管人</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>使用人</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>出借人</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>借用人</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>預計歸還日</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>原放置地點</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>出借後地點</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '21%'}}>出借事由</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        // 判斷是否逾期
                                                        const today = new Date();
                                                        today.setHours(0, 0, 0, 0);
                                                        const returnDate = new Date(asset.expectedReturnDate);
                                                        returnDate.setHours(0, 0, 0, 0);
                                                        const isOverdue = returnDate < today;

                                                        return (
                                                            <tr key={`lent-${asset.lendId}-${index}`} className={`hover:bg-slate-50 transition-colors ${isOverdue ? 'bg-red-50' : ''}`}>
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedLendIds.includes(asset.lendId)}
                                                                        onChange={() => handleCheckboxChange(asset.lendId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-600">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.keeperName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.userName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lenderName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.borrower || '-'}</td>
                                                                <td className={`px-3 py-3 ${isOverdue ? 'text-red-600 font-semibold' : 'text-slate-600'}`}>
                                                                    {asset.expectedReturnDate}
                                                                    {isOverdue && <i className="fas fa-exclamation-triangle ml-1"></i>}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.originalLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lendingLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.reason}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* 底部操作列 */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <span>
                                        已選擇 <span className="font-bold text-blue-600">{selectedLendIds.length}</span> / {filteredAssets.length} 筆
                                    </span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors font-medium"
                                    disabled={isSubmitting}
                                >
                                    關閉
                                </button>
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <button
                                        onClick={handleSubmitReturn}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed font-medium shadow-sm"
                                        disabled={selectedLendIds.length === 0 || isSubmitting}
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin"></i>
                                                處理中...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-check"></i>
                                                確認歸還所選項目
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScrapPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('財產');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // Tab 狀態
            const [activeTab, setActiveTab] = useState('pending'); // 'pending', 'history', 'byDate'

            // 已生成文件 Tab 狀態
            const [historyFiles, setHistoryFiles] = useState([]);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);

            // 列印已報廢資產 Tab 狀態
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [previewAssets, setPreviewAssets] = useState([]);
            const [isLoadingPreview, setIsLoadingPreview] = useState(false);
            const [isGeneratingByDate, setIsGeneratingByDate] = useState(false);

            // 當前類別的資產列表
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === '財產' ? details.property : details.items;
            }, [details, selectedCategory]);

            // 切換類別時清空選擇
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // 檢查是否收到 null（序列化失敗）
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('收到的報廢資料為 null，可能是後端序列化失敗');
                    alert('載入失敗：資料格式錯誤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('請至少勾選一個項目來產生報表。');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    '📄 彙總報表產生成功！\n\n' +
                                    `是否要在列印後同步更新這些財產的狀態為「已報廢」？\n\n` +
                                    `⚠️ 重要提醒\n` +
                                    '選擇【確定】後，這些記錄將不會再出現在待列印清單中\n\n' +
                                    `✅ 【確定】= 列印後更新狀態，將 ${result.assetIds.length} 筆財產狀態更新為「已報廢」（財產將標記為已報廢，無法再次列印此申請）\n` +
                                    `❌ 【取消】= 僅列印報表，不更新狀態（需至"總表更新"更新狀態）`
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('✅ ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                '❌ 狀態更新失敗：' + error.message + '\n' +
                                                '⚠️  文件已成功產生，但狀態未更新。\n' +
                                                '💡 請稍後使用「管理後台」手動更新狀態。'
                                            );
                                            onRefresh();
                                        })
                                        .processScrapConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('生成失敗：' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createScrapDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('載入失敗：' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            // ========== 已生成文件 Tab 函數 ==========
            const loadHistoryFiles = useCallback(() => {
                setIsLoadingHistory(true);
                google.script.run
                    .withSuccessHandler((files) => {
                        setHistoryFiles(files || []);
                        setIsLoadingHistory(false);
                    })
                    .withFailureHandler((error) => {
                        console.error('載入歷史文件失敗:', error);
                        setHistoryFiles([]);
                        setIsLoadingHistory(false);
                    })
                    .getScrapDriveFiles();
            }, []);

            // Tab 切換時載入歷史文件
            useEffect(() => {
                if (activeTab === 'history' && historyFiles.length === 0) {
                    loadHistoryFiles();
                }
            }, [activeTab, historyFiles.length, loadHistoryFiles]);

            // ========== 列印已報廢資產 Tab 函數 ==========
            const handlePreviewByDate = () => {
                if (!startDate || !endDate) {
                    alert('請選擇起始和結束日期');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    alert('起始日期不能晚於結束日期');
                    return;
                }

                setIsLoadingPreview(true);
                setPreviewAssets([]);

                google.script.run
                    .withSuccessHandler((assets) => {
                        if (assets === null) {
                            alert('載入失敗：資料格式錯誤');
                            setPreviewAssets([]);
                        } else if (!Array.isArray(assets)) {
                            alert('載入失敗：預期為陣列');
                            setPreviewAssets([]);
                        } else if (assets.length === 0) {
                            alert('該日期範圍內沒有已報廢的資產');
                            setPreviewAssets([]);
                        } else {
                            setPreviewAssets(assets);
                        }
                        setIsLoadingPreview(false);
                    })
                    .withFailureHandler((error) => {
                        alert('載入失敗：' + error.message);
                        setIsLoadingPreview(false);
                    })
                    .getScrapAssetsByDateRange(startDate, endDate, selectedCategory);
            };

            const handleGenerateByDate = () => {
                if (previewAssets.length === 0) {
                    alert('沒有可列印的資產');
                    return;
                }

                setIsGeneratingByDate(true);

                google.script.run
                    .withSuccessHandler((result) => {
                        alert(`報廢申請單已成功生成（共 ${result.assetCount} 筆資產）`);
                        window.open(result.fileUrl, '_blank');
                        setIsGeneratingByDate(false);
                    })
                    .withFailureHandler((error) => {
                        alert('生成失敗：' + error.message);
                        setIsGeneratingByDate(false);
                    })
                    .createScrapDocByDateRange(startDate, endDate, selectedCategory);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-orange-800">列印報廢申請單</h3>
                            <button onClick={onClose} className="text-orange-600 hover:text-orange-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Tab 導航 */}
                        <div className="px-6 border-b bg-slate-50">
                            <div className="flex">
                                <button
                                    onClick={() => setActiveTab('pending')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'pending'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    待報廢資產
                                </button>
                                <button
                                    onClick={() => setActiveTab('history')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'history'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    已生成文件
                                </button>
                                <button
                                    onClick={() => setActiveTab('byDate')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'byDate'
                                            ? 'border-orange-600 text-orange-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    列印已報廢資產
                                </button>
                            </div>
                        </div>

                        {/* ========== Tab 1: 待報廢資產 ========== */}
                        {activeTab === 'pending' && (
                            <>
                                {/* Category Selector */}
                                <div className="px-6 py-4 border-b bg-orange-50/50">
                                    <label className="font-medium text-slate-700 mr-4">請選擇財產類別：</label>
                                    <label className="inline-flex items-center mr-6">
                                        <input
                                            type="radio"
                                            name="scrapCategory"
                                            value="財產"
                                            checked={selectedCategory === '財產'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>財產</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="scrapCategory"
                                            value="物品"
                                            checked={selectedCategory === '物品'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>物品</span>
                                    </label>
                                </div>

                                {/* Content */}
                                <div className="flex-1 overflow-y-auto p-6">
                                    {isLoading ? (
                                        <div className="flex items-center justify-center py-16">
                                            <div className="text-center">
                                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
                                                <p className="mt-4 text-slate-600">載入中...</p>
                                            </div>
                                        </div>
                                    ) : currentAssets.length === 0 ? (
                                        <div className="text-center py-16 text-slate-500">
                                            <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                            <p>目前沒有任何狀態為「報廢中」的{selectedCategory}。</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-orange-50 sticky top-0">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                className="rounded"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-2 text-left">財產編號</th>
                                                        <th className="px-3 py-2 text-left">財產名稱</th>
                                                        <th className="px-3 py-2 text-left">型號/廠牌</th>
                                                        <th className="px-3 py-2 text-left">原保管人</th>
                                                        <th className="px-3 py-2 text-left">原使用人</th>
                                                        <th className="px-3 py-2 text-left">報廢日期</th>
                                                        <th className="px-3 py-2 text-left">報廢原因</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {currentAssets.map(asset => (
                                                        <tr key={asset.assetId} className="border-b hover:bg-orange-50/30">
                                                            <td className="px-3 py-2">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedIds.includes(asset.assetId)}
                                                                    onChange={() => handleSelectOne(asset.assetId)}
                                                                    className="rounded"
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">{asset.assetId}</td>
                                                            <td className="px-3 py-2">{asset.assetName}</td>
                                                            <td className="px-3 py-2">{asset.modelBrand}</td>
                                                            <td className="px-3 py-2">{asset.originalKeeper}</td>
                                                            <td className="px-3 py-2">{asset.originalUser || ''}</td>
                                                            <td className="px-3 py-2">{asset.scrapDate || ''}</td>
                                                            <td className="px-3 py-2">{asset.scrapReason || ''}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* ========== Tab 2: 已生成文件 ========== */}
                        {activeTab === 'history' && (
                            <div className="flex-1 overflow-y-auto p-6">
                                {isLoadingHistory ? (
                                    <div className="flex items-center justify-center py-16">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                                        <span className="ml-3 text-slate-600">載入中...</span>
                                    </div>
                                ) : historyFiles.length === 0 ? (
                                    <div className="text-center py-16 text-slate-500">
                                        <i className="fas fa-folder-open text-5xl mb-4 text-slate-300"></i>
                                        <p>目前沒有已生成的報廢文件。</p>
                                        <button
                                            onClick={loadHistoryFiles}
                                            className="mt-4 px-4 py-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                                        >
                                            <i className="fas fa-sync-alt mr-2"></i>重新載入
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-medium text-slate-700">已生成的報廢文件</h4>
                                            <button
                                                onClick={loadHistoryFiles}
                                                className="text-sm text-orange-600 hover:text-orange-800 transition-colors"
                                            >
                                                <i className="fas fa-sync-alt mr-1"></i>重新整理
                                            </button>
                                        </div>
                                        <div className="overflow-x-auto border rounded-lg">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">檔案名稱</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">最後修改時間</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">大小</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historyFiles.map((file, idx) => (
                                                        <tr key={idx} className="border-t hover:bg-slate-50">
                                                            <td className="px-4 py-3">{file.name}</td>
                                                            <td className="px-4 py-3 text-slate-600">{file.lastUpdated}</td>
                                                            <td className="px-4 py-3 text-slate-600">{file.size}</td>
                                                            <td className="px-4 py-3">
                                                                <a
                                                                    href={file.url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="text-blue-600 hover:text-blue-800 font-medium"
                                                                >
                                                                    <i className="fas fa-external-link-alt mr-1"></i>開啟
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* ========== Tab 3: 列印已報廢資產 ========== */}
                        {activeTab === 'byDate' && (
                            <div className="flex-1 overflow-y-auto p-6">
                                {/* 類別選擇 */}
                                <div className="mb-4 p-4 bg-orange-50 rounded-lg">
                                    <label className="font-medium text-slate-700 mr-4">財產類別：</label>
                                    <label className="inline-flex items-center mr-6">
                                        <input
                                            type="radio"
                                            name="scrapCategoryByDate"
                                            value="財產"
                                            checked={selectedCategory === '財產'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>財產</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="scrapCategoryByDate"
                                            value="物品"
                                            checked={selectedCategory === '物品'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>物品</span>
                                    </label>
                                </div>

                                {/* 日期選擇器 */}
                                <div className="mb-6 p-4 bg-slate-50 rounded-lg">
                                    <h4 className="font-medium text-slate-700 mb-3">
                                        <i className="fas fa-calendar-alt mr-2 text-slate-500"></i>
                                        選擇報廢期間
                                    </h4>
                                    <div className="flex flex-wrap items-end gap-4">
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">起始日期</label>
                                            <input
                                                type="date"
                                                value={startDate}
                                                onChange={(e) => setStartDate(e.target.value)}
                                                className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-600 mb-1">結束日期</label>
                                            <input
                                                type="date"
                                                value={endDate}
                                                onChange={(e) => setEndDate(e.target.value)}
                                                className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                            />
                                        </div>
                                        <button
                                            onClick={handlePreviewByDate}
                                            disabled={isLoadingPreview}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {isLoadingPreview ? (
                                                <>
                                                    <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                    <span>搜尋中...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <i className="fas fa-search"></i>
                                                    <span>預覽</span>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                {/* 預覽結果 */}
                                {previewAssets.length > 0 && (
                                    <>
                                        <h4 className="font-medium text-green-700 mb-3 flex items-center gap-2">
                                            <i className="fas fa-check-circle"></i>
                                            預覽符合條件的資產（{previewAssets.length} 筆）
                                        </h4>
                                        <div className="overflow-x-auto border rounded-lg mb-4">
                                            <table className="w-full text-sm">
                                                <thead className="bg-green-50">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">財產編號</th>
                                                        <th className="px-3 py-2 text-left">財產名稱</th>
                                                        <th className="px-3 py-2 text-left">型號/廠牌</th>
                                                        <th className="px-3 py-2 text-left">保管人</th>
                                                        <th className="px-3 py-2 text-left">報廢日期</th>
                                                        <th className="px-3 py-2 text-left">報廢原因</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {previewAssets.map((asset, idx) => (
                                                        <tr key={idx} className="border-t hover:bg-green-50/30">
                                                            <td className="px-3 py-2">{asset.assetId}</td>
                                                            <td className="px-3 py-2">{asset.assetName}</td>
                                                            <td className="px-3 py-2">{asset.modelBrand}</td>
                                                            <td className="px-3 py-2">{asset.leaderName}</td>
                                                            <td className="px-3 py-2">{asset.scrapDate}</td>
                                                            <td className="px-3 py-2">{asset.scrapReason}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="text-center">
                                            <button
                                                onClick={handleGenerateByDate}
                                                disabled={isGeneratingByDate}
                                                className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center gap-2 mx-auto"
                                            >
                                                {isGeneratingByDate ? (
                                                    <>
                                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                        <span>產生中...</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <i className="fas fa-file-alt"></i>
                                                        <span>生成報廢申請單</span>
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Footer - 根據 Tab 顯示不同內容 */}
                        {activeTab === 'pending' && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                                <div className="text-sm text-slate-600">
                                    已選擇 <span className="font-bold text-orange-600">{selectedIds.length}</span> 筆資產
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        disabled={isGenerating}
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleGenerateDoc}
                                        disabled={isGenerating || selectedIds.length === 0}
                                        className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {isGenerating ? (
                                            <>
                                                <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                <span>產生中...</span>
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-file-alt"></i>
                                                <span>生成報廢申請單</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* history 和 byDate Tab 只顯示關閉按鈕 */}
                        {(activeTab === 'history' || activeTab === 'byDate') && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                >
                                    關閉
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TransferPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('財產');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [activeTab, setActiveTab] = useState('pending');
            const [historyRecords, setHistoryRecords] = useState([]);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);
            const [historyError, setHistoryError] = useState('');
            const [hasHistoryLoaded, setHasHistoryLoaded] = useState(false);
            const [historyLoadedCategory, setHistoryLoadedCategory] = useState('');

            // 當前類別的資產列表
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === '財產' ? details.property : details.items;
            }, [details, selectedCategory]);

            // 切換類別時清空選擇
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
                setHistoryRecords([]);
                setHistoryError('');
                setHasHistoryLoaded(false);
                setHistoryLoadedCategory('');
            }, [selectedCategory]);

            // 檢查是否收到 null（序列化失敗）
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('收到的轉移資料為 null，可能是後端序列化失敗');
                    alert('載入失敗：資料格式錯誤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('請至少勾選一個項目來產生報表。');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    '📄 彙總轉移記錄產生成功！\n\n' +
                                    '❓ 是否要在生成文件後同步更新這些財產的更新狀態？\n\n' +
                                    '⚠️  提醒：選擇【確定】後，這些記錄將不會再出現在待列印清單中\n\n' +
                                    `✅ 【確定】= 標記 ${result.assetIds.length} 筆轉移記錄為已更新（無法再次列印）\n` +
                                    '❌ 【取消】= 僅開啟文件，不標記狀態（可再次列印，需至"總表更新"更新狀態）'
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('✅ ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                '❌ 狀態更新失敗：' + error.message + '\n' +
                                                '⚠️  文件已成功產生，但未標記為已上傳。\n' +
                                                '💡 請稍後使用「管理後台」手動更新狀態。'
                                            );
                                            onRefresh();
                                        })
                                        .processUploadConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('生成失敗：' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createTransferDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('載入失敗：' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            const loadHistoryRecords = useCallback(() => {
                setIsLoadingHistory(true);
                setHistoryError('');
                setHistoryRecords([]);

                google.script.run
                    .withSuccessHandler((records) => {
                        if (records === null || !Array.isArray(records)) {
                            setHistoryError('載入失敗：資料格式錯誤');
                            setHistoryRecords([]);
                        } else {
                            setHistoryRecords(records);
                        }
                        setIsLoadingHistory(false);
                        setHasHistoryLoaded(true);
                        setHistoryLoadedCategory(selectedCategory);
                    })
                    .withFailureHandler((error) => {
                        setHistoryError('載入失敗：' + (error.message || error));
                        setHistoryRecords([]);
                        setIsLoadingHistory(false);
                        setHasHistoryLoaded(true);
                        setHistoryLoadedCategory(selectedCategory);
                    })
                    .getTransferDocHistory(selectedCategory);
            }, [selectedCategory]);

            useEffect(() => {
                if (activeTab !== 'history') return;
                if (isLoadingHistory) return;
                if (hasHistoryLoaded && historyLoadedCategory === selectedCategory) return;
                loadHistoryRecords();
            }, [activeTab, hasHistoryLoaded, historyLoadedCategory, selectedCategory, isLoadingHistory, loadHistoryRecords]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">列印轉移申請單</h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Tabs */}
                        <div className="px-6 border-b bg-slate-50">
                            <div className="flex">
                                <button
                                    onClick={() => setActiveTab('pending')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'pending'
                                            ? 'border-purple-600 text-purple-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    待列印清單
                                </button>
                                <button
                                    onClick={() => setActiveTab('history')}
                                    className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                                        activeTab === 'history'
                                            ? 'border-purple-600 text-purple-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    查看歷史紀錄
                                </button>
                            </div>
                        </div>

                        {/* ========== Tab 1: 待列印清單 ========== */}
                        {activeTab === 'pending' && (
                            <>
                                <div className="px-6 py-4 border-b bg-purple-50/50">
                                    <label className="font-medium text-slate-700 mr-4">請選擇財產類別：</label>
                                    <label className="inline-flex items-center mr-6">
                                        <input
                                            type="radio"
                                            name="transferCategory"
                                            value="財產"
                                            checked={selectedCategory === '財產'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>財產</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="transferCategory"
                                            value="物品"
                                            checked={selectedCategory === '物品'}
                                            onChange={(e) => setSelectedCategory(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>物品</span>
                                    </label>
                                </div>

                                <div className="flex-1 overflow-y-auto p-6">
                                    {isLoading ? (
                                        <div className="flex items-center justify-center py-16">
                                            <div className="text-center">
                                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                                                <p className="mt-4 text-slate-600">載入中...</p>
                                            </div>
                                        </div>
                                    ) : currentAssets.length === 0 ? (
                                        <div className="text-center py-16 text-slate-500">
                                            <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                            <p>目前沒有任何已完成轉移的{selectedCategory}記錄。</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-purple-50 sticky top-0">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                className="rounded"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-2 text-left">財產編號</th>
                                                        <th className="px-3 py-2 text-left">財產名稱</th>
                                                        <th className="px-3 py-2 text-left">型號/廠牌</th>
                                                        <th className="px-3 py-2 text-left">原保管人</th>
                                                        <th className="px-3 py-2 text-left">原使用人</th>
                                                        <th className="px-3 py-2 text-left">原地點</th>
                                                        <th className="px-3 py-2 text-left">新保管人</th>
                                                        <th className="px-3 py-2 text-left">新使用人</th>
                                                        <th className="px-3 py-2 text-left">新地點</th>
                                                        <th className="px-3 py-2 text-left">轉移類型</th>
                                                        <th className="px-3 py-2 text-left">轉移日期</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {currentAssets.map(asset => (
                                                        <tr key={asset.assetId} className="border-b hover:bg-purple-50/30">
                                                            <td className="px-3 py-2">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedIds.includes(asset.assetId)}
                                                                    onChange={() => handleSelectOne(asset.assetId)}
                                                                    className="rounded"
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">{asset.assetId}</td>
                                                            <td className="px-3 py-2">{asset.assetName}</td>
                                                            <td className="px-3 py-2">{asset.modelBrand}</td>
                                                            <td className="px-3 py-2">{asset.oldKeeper}</td>
                                                            <td className="px-3 py-2">{asset.oldUser || ''}</td>
                                                            <td className="px-3 py-2">{asset.oldLocation}</td>
                                                            <td className="px-3 py-2">{asset.newKeeper}</td>
                                                            <td className="px-3 py-2">{asset.newUser || ''}</td>
                                                            <td className="px-3 py-2">{asset.newLocation}</td>
                                                            <td className="px-3 py-2">{asset.transferType}</td>
                                                            <td className="px-3 py-2">{asset.transferDate}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* ========== Tab 2: 查看歷史紀錄 ========== */}
                        {activeTab === 'history' && (
                            <div className="flex-1 overflow-y-auto p-6">
                                <div className="mb-4 p-4 bg-purple-50/60 rounded-lg flex flex-wrap items-center justify-between gap-3">
                                    <div>
                                        <label className="font-medium text-slate-700 mr-4">財產類別：</label>
                                        <label className="inline-flex items-center mr-6">
                                            <input
                                                type="radio"
                                                name="transferCategoryHistory"
                                                value="財產"
                                                checked={selectedCategory === '財產'}
                                                onChange={(e) => setSelectedCategory(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span>財產</span>
                                        </label>
                                        <label className="inline-flex items-center">
                                            <input
                                                type="radio"
                                                name="transferCategoryHistory"
                                                value="物品"
                                                checked={selectedCategory === '物品'}
                                                onChange={(e) => setSelectedCategory(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span>物品</span>
                                        </label>
                                    </div>
                                    <button
                                        onClick={loadHistoryRecords}
                                        className="text-sm text-purple-600 hover:text-purple-800 transition-colors"
                                    >
                                        <i className="fas fa-sync-alt mr-1"></i>重新整理
                                    </button>
                                </div>

                                {isLoadingHistory ? (
                                    <div className="flex items-center justify-center py-16">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                                        <span className="ml-3 text-slate-600">載入中...</span>
                                    </div>
                                ) : historyError ? (
                                    <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                                        {historyError}
                                    </div>
                                ) : historyRecords.length === 0 ? (
                                    <div className="text-center py-16 text-slate-500">
                                        <i className="fas fa-folder-open text-5xl mb-4 text-slate-300"></i>
                                        <p>目前沒有已列印的轉移文件紀錄。</p>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-medium text-slate-700">已列印轉移文件</h4>
                                            <div className="text-xs text-slate-500">共 {historyRecords.length} 筆</div>
                                        </div>
                                        <div className="overflow-x-auto border rounded-lg">
                                            <table className="w-full text-sm">
                                                <thead className="bg-purple-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">新保管人</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">轉移日期</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">包含筆數</th>
                                                        <th className="px-4 py-3 text-left font-medium text-slate-600">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historyRecords.map((record, idx) => (
                                                        <tr key={`${record.url || 'record'}-${idx}`} className="border-t hover:bg-purple-50/30">
                                                            <td className="px-4 py-3">{record.keeper || '-'}</td>
                                                            <td className="px-4 py-3 text-slate-600">{record.date || '-'}</td>
                                                            <td className="px-4 py-3 text-slate-600">
                                                                {record.count !== undefined && record.count !== null ? record.count : '-'}
                                                            </td>
                                                            <td className="px-4 py-3">
                                                                <a
                                                                    href={record.url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="text-purple-600 hover:text-purple-800 font-medium"
                                                                >
                                                                    <i className="fas fa-external-link-alt mr-1"></i>開啟文件
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* Footer - 根據 Tab 顯示不同內容 */}
                        {activeTab === 'pending' && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                                <div className="text-sm text-slate-600">
                                    已選擇 <span className="font-bold text-purple-600">{selectedIds.length}</span> 筆資產
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        disabled={isGenerating}
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleGenerateDoc}
                                        disabled={isGenerating || selectedIds.length === 0}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {isGenerating ? (
                                            <>
                                                <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                <span>產生中...</span>
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-file-alt"></i>
                                                <span>生成轉移申請單</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                >
                                    關閉
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StatusDetailModal = ({ state, onClose }) => {
            if (!state) return null;

            const { asset, type, detail, isLoading, error } = state;
            const theme = STATUS_DETAIL_THEMES[type] || {
                title: '狀態詳情',
                icon: 'fa-circle-info',
                headerClass: 'bg-slate-50',
                textClass: 'text-slate-800'
            };
            const statusBadgeClass = STATUS_COLORS[asset?.status] || 'bg-slate-100 text-slate-700 border-slate-200';
            const normalizeText = (value) => String(value || '').trim();
            const formatValue = (value) => {
                const text = normalizeText(value);
                return text ? text : '-';
            };
            const formatChange = (oldValue, newValue) => {
                const oldText = normalizeText(oldValue);
                const newText = normalizeText(newValue);
                if (!oldText && !newText) return '-';
                if (!newText || oldText === newText) return oldText || newText || '-';
                return `${oldText || '-'} → ${newText}`;
            };

            const detailRows = (() => {
                if (!detail) return [];
                if (type === 'transfer') {
                    const rows = [
                        { label: '流程狀態', value: formatValue(detail.workflowStatus || detail.status) },
                        { label: '申請時間', value: formatValue(detail.applicationTime) },
                        { label: '轉移類型', value: formatValue(detail.transferType) },
                        { label: '保管人變更', value: formatChange(detail.oldKeeper, detail.newKeeper), full: true },
                        { label: '使用人變更', value: formatChange(detail.oldUser, detail.newUser), full: true },
                        { label: '地點變更', value: formatChange(detail.oldLocation, detail.newLocation), full: true }
                    ];
                    if (detail.applicantEmail) {
                        rows.push({ label: '申請人', value: formatValue(detail.applicantEmail), full: true });
                    }
                    return rows;
                }
                if (type === 'lending') {
                    return [
                        { label: '出借人', value: formatValue(detail.lenderName) },
                        { label: '借用人', value: formatValue(detail.borrower) },
                        { label: '出借日期', value: formatValue(detail.applyTime) },
                        { label: '預計歸還日', value: formatValue(detail.expectedReturnDate) },
                        { label: '原放置地點', value: formatValue(detail.originalLocation) },
                        { label: '出借後地點', value: formatValue(detail.lendingLocation) },
                        { label: '出借事由', value: formatValue(detail.reason), full: true }
                    ];
                }
                if (type === 'scrap') {
                    return [
                        { label: '報廢日期', value: formatValue(detail.scrapDate) },
                        { label: '報廢原因', value: formatValue(detail.scrapReason), full: true },
                        { label: '原保管人', value: formatValue(detail.originalKeeper) },
                        { label: '原使用人', value: formatValue(detail.originalUser) },
                        { label: '保管位置', value: formatValue(detail.location) }
                    ];
                }
                return [];
            })();

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        <div className={`px-6 py-4 border-b flex justify-between items-center ${theme.headerClass}`}>
                            <div>
                                <h3 className={`text-lg font-bold ${theme.textClass}`}>
                                    <i className={`fa-solid ${theme.icon} mr-2`}></i>
                                    {theme.title}
                                </h3>
                                <div className="text-xs text-slate-500 mt-1">
                                    {asset?.assetId || ''} {asset?.assetName ? `・${asset.assetName}` : ''}
                                </div>
                            </div>
                            <button
                                onClick={onClose}
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 mb-4">
                                <div className="text-xs text-slate-500 mb-1">資產狀態</div>
                                <div className="flex flex-wrap items-center gap-2">
                                    <span className="font-mono text-slate-700">{asset?.assetId || '-'}</span>
                                    <span className="text-slate-700">{asset?.assetName || '-'}</span>
                                    <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap ${statusBadgeClass}`}>
                                        {asset?.status || '-'}
                                    </span>
                                </div>
                            </div>

                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center py-10 gap-3">
                                    <i className="fas fa-spinner fa-spin text-3xl text-slate-400"></i>
                                    <p className="text-slate-500 font-medium">載入狀態詳情中...</p>
                                </div>
                            ) : error ? (
                                <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                                    {error}
                                </div>
                            ) : detailRows.length === 0 ? (
                                <div className="text-center py-10 text-slate-500">
                                    <i className="fas fa-info-circle text-3xl mb-2 text-slate-300"></i>
                                    <p>目前沒有可顯示的詳情。</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {detailRows.map(row => (
                                        <div
                                            key={row.label}
                                            className={`rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 ${row.full ? 'md:col-span-2' : ''}`}
                                        >
                                            <div className="text-xs font-semibold text-slate-500">{row.label}</div>
                                            <div className="text-sm text-slate-700 mt-1 whitespace-pre-line">{row.value}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                            >
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== 快速操作 Modal 組件 =====

        // 轉移 Modal
        const QuickTransferModal = ({ asset, transferOptions, onClose, onSuccess }) => {
            const [transferMode, setTransferMode] = useState('normal'); // 'normal', 'station', 'info', 'intake'
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            // 駐站轉移專用 state
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !transferOptions) return null;

            const handleSubmit = () => {
                // 驗證表單
                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('請至少選擇一項變更（地點、保管人或使用人）');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('請選擇新地點');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('請選擇新保管人');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('請選擇新使用人');
                        return;
                    }
                } else if (transferMode === 'station') {
                    // 駐站轉移模式驗證
                    if (!custodianEmail) {
                        alert('請選擇駐管！');
                        return;
                    }
                    if (!stationLocation) {
                        alert('請選擇駐站地點！');
                        return;
                    }
                }

                const confirmation = confirm(`確定要轉移財產「${asset.assetId}」嗎？`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交轉移申請...');

                const formData = {
                    assetIds: [asset.assetId],
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                // 特殊模式的額外參數
                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('轉移申請已提交！', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                轉移財產
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 資產資訊 */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">財產編號</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">財產名稱</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                            </div>

                            {/* 轉移模式選擇 */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">轉移模式</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            name="transferMode"
                                            value="normal"
                                            checked={transferMode === 'normal'}
                                            onChange={(e) => setTransferMode(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>一般轉移</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="transferMode"
                                                value="station"
                                                checked={transferMode === 'station'}
                                                onChange={(e) => setTransferMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span>中心轉給駐站</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="info"
                                                    checked={transferMode === 'info'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>駐站回送中心資訊組</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="intake"
                                                    checked={transferMode === 'intake'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>駐站回送中心收案組</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* 一般轉移選項 */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    {/* 變更地點 */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeLocation}
                                                onChange={(e) => setChangeLocation(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">變更地點</span>
                                        </label>
                                        {changeLocation && (
                                            <select
                                                value={newLocation}
                                                onChange={(e) => setNewLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">請選擇新地點...</option>
                                                {transferOptions.locations?.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* 變更保管人 */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeKeeper}
                                                onChange={(e) => setChangeKeeper(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">變更保管人</span>
                                        </label>
                                        {changeKeeper && (
                                            <select
                                                value={newKeeperEmail}
                                                onChange={(e) => setNewKeeperEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">請選擇新保管人...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* 變更使用人 */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeUser}
                                                onChange={(e) => setChangeUser(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">變更使用人</span>
                                        </label>
                                        {changeUser && (
                                            <select
                                                value={newUserEmail}
                                                onChange={(e) => setNewUserEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">請選擇新使用人...</option>
                                                {transferOptions.users && Object.entries(transferOptions.users).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* 駐站轉移模式的下拉選單 */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>駐站模式說明：</strong>保管人和使用人將同時設為此駐管。
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* 駐管選擇 */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                轉移給駐管：<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={custodianEmail}
                                                onChange={(e) => setCustodianEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">請選擇駐管...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* 駐站地點選擇 */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                駐站地點：<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={stationLocation}
                                                onChange={(e) => setStationLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">請選擇駐站地點...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 其他特殊模式說明 */}
                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && '此模式將自動設定資訊組保管人、使用人和地點'}
                                        {transferMode === 'intake' && '此模式將自動設定收案組保管人和地點'}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                取消
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>提交中...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>提交申請</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 出借 Modal
        const QuickLendingModal = ({ asset, lendingOptions, onClose, onSuccess }) => {
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !lendingOptions) return null;

            const handleSubmit = () => {
                // 驗證表單
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('請填寫所有必填欄位（借用人、地點、歸還日期）');
                    return;
                }

                const confirmation = confirm(`確定要出借財產「${asset.assetId}」給 ${borrowerName} 嗎？`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交出借申請...');

                const formData = {
                    assetIds: [asset.assetId],
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('出借申請已提交！', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                出借財產
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 資產資訊 */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">財產編號</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">財產名稱</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">目前地點</div>
                                <div className="text-slate-800">{asset.location}</div>
                            </div>

                            <div className="space-y-4">
                                {/* 借用人 */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        借用人姓名 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={borrowerName}
                                        onChange={(e) => setBorrowerName(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">請選擇借用人...</option>
                                        {lendingOptions.borrowers?.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* 借出後地點 */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        借出後放置地點 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={lendingLocation}
                                        onChange={(e) => setLendingLocation(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">請選擇地點...</option>
                                        {lendingOptions.locations?.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* 預計歸還日期 */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        預計歸還日期 <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        value={returnDate}
                                        onChange={(e) => setReturnDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    />
                                </div>

                                {/* 出借事由 */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        出借事由/備註
                                    </label>
                                    <textarea
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        rows="3"
                                        placeholder="請輸入出借事由或備註..."
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                取消
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>提交中...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>提交申請</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 報廢 Modal
        const QuickScrapModal = ({ asset, onClose, onSuccess }) => {
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset) return null;

            const handleSubmit = () => {
                // 驗證表單
                if (!reason) {
                    alert('請選擇報廢原因');
                    return;
                }
                if ((reason === 'C' || reason === '其他') && !remarks.trim()) {
                    alert('選擇「其他」原因時，請務必填寫詳細說明');
                    return;
                }

                const confirmation = confirm(`確定要申請報廢財產「${asset.assetId}」嗎？\n報廢原因：${reason === 'A' ? 'A.維修不具效益，且逾使用年限' : reason === 'B' ? 'B.損壞無法修復，且逾使用年限' : 'C.其他'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交報廢申請...');

                const formData = {
                    assetIds: [asset.assetId],
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('報廢申請已提交！', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                申請報廢財產
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 資產資訊 */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">財產編號</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">財產名稱</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">目前狀態</div>
                                <div className="text-slate-800">{asset.status}</div>
                            </div>

                            {/* 警告訊息 */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">注意事項</div>
                                        <div>此操作將會將財產狀態更新為「報廢中」，待管理員最終確認。請確認報廢原因無誤後再提交。</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                {/* 報廢原因 */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        報廢原因 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    >
                                        <option value="">請選擇原因...</option>
                                        <option value="A">A.維修不具效益，且逾使用年限</option>
                                        <option value="B">B.損壞無法修復，且逾使用年限</option>
                                        <option value="C">C.其他</option>
                                    </select>
                                </div>

                                {/* 詳細說明 */}
                                {(reason === 'C' || reason === '其他') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">
                                            詳細說明 <span className="text-red-500">*</span>
                                        </label>
                                        <textarea
                                            value={remarks}
                                            onChange={(e) => setRemarks(e.target.value)}
                                            rows="4"
                                            placeholder="請詳細說明報廢原因..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                        ></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                取消
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>提交中...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>提交報廢申請</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== 批次操作 Modal 組件 =====

        // 批次轉移 Modal
        const BatchTransferModal = ({ transferOptions, allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [transferMode, setTransferMode] = useState('normal');
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            // 從 BatchList 獲取已選資產
            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            // 獲取已選資產的詳細資訊
            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!transferOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('請先選取要轉移的資產');
                    return;
                }

                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('請至少選擇一項變更（地點、保管人或使用人）');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('請選擇新地點');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('請選擇新保管人');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('請選擇新使用人');
                        return;
                    }
                } else if (transferMode === 'station') {
                    if (!custodianEmail) {
                        alert('請選擇駐管！');
                        return;
                    }
                    if (!stationLocation) {
                        alert('請選擇駐站地點！');
                        return;
                    }
                }

                const confirmation = confirm(`確定要批次轉移 ${selectedAssetIds.length} 筆資產嗎？`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交批次轉移申請...');

                const formData = {
                    assetIds: selectedAssetIds,
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('批次轉移申請已提交！', 0);
                        alert(message);
                        // 清空 BatchList
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                批次轉移財產 ({selectedAssetIds.length} 筆)
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 已選資產清單 */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">已選擇的資產：</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">沒有選取的資產</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 轉移模式選擇 */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">轉移模式</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input type="radio" name="batchTransferMode" value="normal" checked={transferMode === 'normal'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                        <span>一般轉移</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input type="radio" name="batchTransferMode" value="station" checked={transferMode === 'station'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                            <span>中心轉給駐站</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="info" checked={transferMode === 'info'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>駐站回送中心資訊組</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="intake" checked={transferMode === 'intake'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>駐站回送中心收案組</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* 一般轉移選項 */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeLocation} onChange={(e) => setChangeLocation(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">變更地點</span>
                                        </label>
                                        {changeLocation && (
                                            <select value={newLocation} onChange={(e) => setNewLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">請選擇新地點...</option>
                                                {transferOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeKeeper} onChange={(e) => setChangeKeeper(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">變更保管人</span>
                                        </label>
                                        {changeKeeper && (
                                            <select value={newKeeperEmail} onChange={(e) => setNewKeeperEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">請選擇新保管人...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeUser} onChange={(e) => setChangeUser(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">變更使用人</span>
                                        </label>
                                        {changeUser && (
                                            <select value={newUserEmail} onChange={(e) => setNewUserEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">請選擇新使用人...</option>
                                                {transferOptions.users && Object.entries(transferOptions.users).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* 駐站轉移 */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>駐站模式說明：</strong>保管人和使用人將同時設為此駐管。
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">轉移給駐管：<span className="text-red-600">*</span></label>
                                            <select value={custodianEmail} onChange={(e) => setCustodianEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">請選擇駐管...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">駐站地點：<span className="text-red-600">*</span></label>
                                            <select value={stationLocation} onChange={(e) => setStationLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">請選擇駐站地點...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && '此模式將自動設定資訊組保管人、使用人和地點'}
                                        {transferMode === 'intake' && '此模式將自動設定收案組保管人和地點'}
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">取消</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>提交中...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>提交批次轉移</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 批次出借 Modal
        const BatchLendingModal = ({ lendingOptions, allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!lendingOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('請先選取要出借的資產');
                    return;
                }
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('請填寫所有必填欄位（借用人、地點、歸還日期）');
                    return;
                }

                const confirmation = confirm(`確定要批次出借 ${selectedAssetIds.length} 筆資產給 ${borrowerName} 嗎？`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交批次出借申請...');

                const formData = {
                    assetIds: selectedAssetIds,
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('批次出借申請已提交！', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                批次出借財產 ({selectedAssetIds.length} 筆)
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 已選資產清單 */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">已選擇的資產：</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">沒有選取的資產</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">借用人姓名 <span className="text-red-500">*</span></label>
                                    <select value={borrowerName} onChange={(e) => setBorrowerName(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">請選擇借用人...</option>
                                        {lendingOptions.borrowers?.map(name => (<option key={name} value={name}>{name}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">借出後放置地點 <span className="text-red-500">*</span></label>
                                    <select value={lendingLocation} onChange={(e) => setLendingLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">請選擇地點...</option>
                                        {lendingOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">預計歸還日期 <span className="text-red-500">*</span></label>
                                    <input type="date" value={returnDate} onChange={(e) => setReturnDate(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">出借事由/備註</label>
                                    <textarea value={reason} onChange={(e) => setReason(e.target.value)} rows="3" placeholder="請輸入出借事由或備註..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">取消</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>提交中...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>提交批次出借</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 批次報廢 Modal
        const BatchScrapModal = ({ allAssets = [], selectedAssetIds: initialSelectedAssetIds = null, onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (Array.isArray(initialSelectedAssetIds)) {
                    setSelectedAssetIds(initialSelectedAssetIds);
                    return;
                }
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, [initialSelectedAssetIds]);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('請先選取要報廢的資產');
                    return;
                }
                if (!reason) {
                    alert('請選擇報廢原因');
                    return;
                }
                if ((reason === 'C' || reason === '其他') && !remarks.trim()) {
                    alert('選擇「其他」原因時，請務必填寫詳細說明');
                    return;
                }

                const confirmation = confirm(`確定要批次申請報廢 ${selectedAssetIds.length} 筆資產嗎？\n報廢原因：${reason === 'A' ? 'A.維修不具效益，且逾使用年限' : reason === 'B' ? 'B.損壞無法修復，且逾使用年限' : 'C.其他'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('正在提交批次報廢申請...');

                const formData = {
                    assetIds: selectedAssetIds,
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('批次報廢申請已提交！', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('提交失敗', 0);
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                批次申請報廢財產 ({selectedAssetIds.length} 筆)
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* 已選資產清單 */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">已選擇的資產：</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">沒有選取的資產</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 警告訊息 */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">注意事項</div>
                                        <div>此操作將會將所有選中的財產狀態更新為「報廢中」，待管理員最終確認。</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">報廢原因 <span className="text-red-500">*</span></label>
                                    <select value={reason} onChange={(e) => setReason(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                        <option value="">請選擇原因...</option>
                                        <option value="A">A.維修不具效益，且逾使用年限</option>
                                        <option value="B">B.損壞無法修復，且逾使用年限</option>
                                        <option value="C">C.其他</option>
                                    </select>
                                </div>
                                {(reason === 'C' || reason === '其他') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">詳細說明 <span className="text-red-500">*</span></label>
                                        <textarea value={remarks} onChange={(e) => setRemarks(e.target.value)} rows="4" placeholder="請詳細說明報廢原因..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">取消</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>提交中...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>提交批次報廢</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== 新增資產 Modal ==========
        const AddAssetModal = ({ onClose, onSuccess }) => {
            // 載入與提交狀態
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [dropdownData, setDropdownData] = useState(null);

            // 表單狀態
            const [assetType, setAssetType] = useState('property');
            const [assetId, setAssetId] = useState('');
            const [assetName, setAssetName] = useState('');
            const [modelBrand, setModelBrand] = useState('');
            const [category, setCategory] = useState('');
            const [purchaseDate, setPurchaseDate] = useState('');
            const [useLife, setUseLife] = useState('');
            const [isItAsset, setIsItAsset] = useState(false);
            const [isActuallyComputer, setIsActuallyComputer] = useState(false);
            const [isIsoScope, setIsIsoScope] = useState(false);
            const [location, setLocation] = useState('');
            const [keeperEmail, setKeeperEmail] = useState('');
            const [userEmail, setUserEmail] = useState('');
            const [remarks, setRemarks] = useState('');

            // 載入下拉選單資料
            useEffect(() => {
                google.script.run
                    .withSuccessHandler((data) => {
                        setDropdownData(data);
                        setIsLoading(false);
                    })
                    .withFailureHandler((error) => {
                        alert('載入選單資料失敗：' + error.message);
                        onClose();
                    })
                    .getDropdownData();
            }, []);

            // 資訊資產連動邏輯：取消主選項時清空子選項
            useEffect(() => {
                if (!isItAsset) {
                    setIsActuallyComputer(false);
                    setIsIsoScope(false);
                }
            }, [isItAsset]);

            // 表單驗證與提交
            const handleSubmit = () => {
                // 前端必填驗證
                if (!assetId.trim() || !assetName.trim() || !location || !keeperEmail) {
                    alert('請填寫所有必填欄位（編號、名稱、地點、保管人）');
                    return;
                }

                if (!confirm(`確定要新增${assetType === 'property' ? '財產' : '物品'}「${assetId}」嗎？`)) {
                    return;
                }

                setIsSubmitting(true);
                if (typeof showFlyProgressBar === 'function') {
                    showFlyProgressBar('正在新增資產...');
                }

                const formData = {
                    assetType,
                    assetId: assetId.trim(),
                    assetName: assetName.trim(),
                    modelBrand: modelBrand.trim(),
                    category: category.trim(),
                    purchaseDate,
                    useLife,
                    isItAsset,
                    isActuallyComputer,
                    isIsoScope,
                    location,
                    keeperEmail,
                    userEmail: userEmail || keeperEmail,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler((message) => {
                        if (typeof hideFlyProgressBar === 'function') {
                            hideFlyProgressBar('新增成功！', 300);
                        }
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler((error) => {
                        if (typeof hideFlyProgressBar === 'function') {
                            hideFlyProgressBar('新增失敗', 0);
                        }
                        alert('錯誤：' + error.message);
                        setIsSubmitting(false);
                    })
                    .addNewAsset(formData);
            };

            // 排序後的保管人列表
            const sortedKeepers = useMemo(() => {
                if (!dropdownData?.keepers) return [];
                return Object.entries(dropdownData.keepers)
                    .sort((a, b) => a[1].localeCompare(b[1], 'zh-Hant'));
            }, [dropdownData]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-emerald-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-emerald-800">
                                <i className="fas fa-plus-circle mr-2"></i>
                                新增財產 / 物品
                            </h3>
                            <button onClick={onClose} disabled={isSubmitting} className="text-emerald-600 hover:text-emerald-800 transition-colors disabled:opacity-50">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-emerald-500"></i>
                                    <p className="text-slate-500 font-medium">載入選單資料中...</p>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* 區塊 1: 資料類型 */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-folder-open mr-2 text-slate-500"></i>資料類型
                                        </div>
                                        <div className="flex gap-6">
                                            <label className="flex items-center cursor-pointer">
                                                <input type="radio" name="addAssetType" value="property"
                                                    checked={assetType === 'property'}
                                                    onChange={(e) => setAssetType(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>財產（列入財產總表）</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input type="radio" name="addAssetType" value="item"
                                                    checked={assetType === 'item'}
                                                    onChange={(e) => setAssetType(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>物品（列入物品總表）</span>
                                            </label>
                                        </div>
                                    </div>

                                    {/* 區塊 2: 基本資料 */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-info-circle mr-2 text-slate-500"></i>基本資料
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {/* 編號 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    編號 <span className="text-red-500">*</span>
                                                </label>
                                                <input type="text" value={assetId} onChange={(e) => setAssetId(e.target.value)}
                                                    placeholder="例如：A1120001"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                                <p className="text-xs text-slate-500 mt-1">系統將檢查唯一性</p>
                                            </div>

                                            {/* 名稱 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    名稱 <span className="text-red-500">*</span>
                                                </label>
                                                <input type="text" value={assetName} onChange={(e) => setAssetName(e.target.value)}
                                                    placeholder="例如：ASUS 筆記型電腦"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* 型號/廠牌 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">型號/廠牌</label>
                                                <input type="text" value={modelBrand} onChange={(e) => setModelBrand(e.target.value)}
                                                    placeholder="例如：ASUS VivoBook 15"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* 類別 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">類別</label>
                                                <input type="text" value={category} onChange={(e) => setCategory(e.target.value)}
                                                    list="add-asset-category-list"
                                                    placeholder="選擇或輸入類別"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                                <datalist id="add-asset-category-list">
                                                    {dropdownData?.categories?.map(cat => (
                                                        <option key={cat} value={cat} />
                                                    ))}
                                                </datalist>
                                            </div>

                                            {/* 取得日期 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">取得日期</label>
                                                <input type="date" value={purchaseDate} onChange={(e) => setPurchaseDate(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>

                                            {/* 使用年限 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">使用年限（年）</label>
                                                <input type="number" value={useLife} onChange={(e) => setUseLife(e.target.value)}
                                                    min="0" placeholder="例如：3"
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                />
                                            </div>
                                        </div>

                                        {/* 資訊資產標記 */}
                                        <div className="mt-4 p-3 bg-white rounded-lg border border-slate-200">
                                            <label className="flex items-center cursor-pointer">
                                                <input type="checkbox" checked={isItAsset} onChange={(e) => setIsItAsset(e.target.checked)}
                                                    className="mr-2 w-4 h-4"
                                                />
                                                <span className="font-medium text-slate-700">此設備是否為資訊資產？</span>
                                            </label>

                                            {/* 子選項 */}
                                            {isItAsset && (
                                                <div className="ml-6 mt-3 space-y-2">
                                                    <label className="flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={isActuallyComputer} onChange={(e) => setIsActuallyComputer(e.target.checked)}
                                                            className="mr-2 w-4 h-4"
                                                        />
                                                        <span className="text-slate-600">此設備為電腦主機/筆電</span>
                                                    </label>
                                                    <label className="flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={isIsoScope} onChange={(e) => setIsIsoScope(e.target.checked)}
                                                            className="mr-2 w-4 h-4"
                                                        />
                                                        <span className="text-slate-600">此設備是否在 ISO 驗證範圍內</span>
                                                    </label>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* 區塊 3: 保管與位置 */}
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="font-medium text-slate-700 mb-3">
                                            <i className="fas fa-map-marker-alt mr-2 text-slate-500"></i>保管與位置
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {/* 保管地點 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    保管地點 <span className="text-red-500">*</span>
                                                </label>
                                                <select value={location} onChange={(e) => setLocation(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                >
                                                    <option value="">請選擇地點...</option>
                                                    {dropdownData?.locations?.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* 保管人 */}
                                            <div>
                                                <label className="block text-sm font-medium text-slate-600 mb-1">
                                                    保管人 <span className="text-red-500">*</span>
                                                </label>
                                                <select value={keeperEmail} onChange={(e) => {
                                                    setKeeperEmail(e.target.value);
                                                    if (!userEmail) setUserEmail(e.target.value);
                                                }}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                >
                                                    <option value="">請選擇保管人...</option>
                                                    {sortedKeepers.map(([email, name]) => (
                                                        <option key={email} value={email}>{name} ({email})</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* 使用人 - 僅財產模式顯示 */}
                                            {assetType === 'property' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">使用人（預設同保管人）</label>
                                                    <select value={userEmail} onChange={(e) => setUserEmail(e.target.value)}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                                    >
                                                        <option value="">同保管人</option>
                                                        {sortedKeepers.map(([email, name]) => (
                                                            <option key={email} value={email}>{name} ({email})</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* 區塊 4: 備註 */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-1">備註</label>
                                        <textarea value={remarks} onChange={(e) => setRemarks(e.target.value)}
                                            rows="3" placeholder="選填..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">
                                取消
                            </button>
                            <button onClick={handleSubmit} disabled={isSubmitting || isLoading} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (
                                    <><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>新增中...</span></>
                                ) : (
                                    <><i className="fas fa-check"></i><span>確認新增</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== 編輯資產 Modal（僅管理員）==========
        const EditAssetModal = ({ asset, onClose, onSuccess }) => {
            // 載入與提交狀態
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [categories, setCategories] = useState([]);

            // 表單狀態（從 asset prop 載入初始值）
            const [assetName, setAssetName] = useState(asset?.assetName || '');
            const [modelBrand, setModelBrand] = useState(asset?.modelBrand || '');
            const [category, setCategory] = useState(asset?.category || '');
            const [purchaseDate, setPurchaseDate] = useState(() => {
                // 處理日期格式轉換
                if (!asset?.purchaseDate) return '';
                const date = new Date(asset.purchaseDate);
                if (isNaN(date.getTime())) return '';
                return date.toISOString().split('T')[0];
            });
            const [useLife, setUseLife] = useState(asset?.useLife || '');
            const [isItAsset, setIsItAsset] = useState(asset?.isItAsset === '是');
            const [isActuallyComputer, setIsActuallyComputer] = useState(asset?.isActuallyComputer === '是');
            const [isIsoScope, setIsIsoScope] = useState(asset?.isIsoScope === '是');

            // 載入類別選項
            useEffect(() => {
                google.script.run
                    .withSuccessHandler((data) => {
                        setCategories(data.categories || []);
                        setIsLoading(false);
                    })
                    .withFailureHandler((error) => {
                        console.error('載入類別資料失敗：', error);
                        setIsLoading(false);
                    })
                    .getDropdownData();
            }, []);

            // 資訊資產連動邏輯：取消主選項時清空子選項
            useEffect(() => {
                if (!isItAsset) {
                    setIsActuallyComputer(false);
                    setIsIsoScope(false);
                }
            }, [isItAsset]);

            // 表單提交
            const handleSubmit = () => {
                // 驗證必填欄位
                if (!assetName.trim()) {
                    alert('請填寫名稱');
                    return;
                }

                setIsSubmitting(true);

                const updates = {
                    assetName: assetName.trim(),
                    modelBrand: modelBrand.trim(),
                    category: category.trim(),
                    purchaseDate: purchaseDate || '',
                    useLife: useLife || '',
                    isItAsset: isItAsset ? '是' : '',
                    isActuallyComputer: isActuallyComputer ? '是' : '',
                    isIsoScope: isIsoScope ? '是' : ''
                };

                google.script.run
                    .withSuccessHandler((message) => {
                        setIsSubmitting(false);
                        alert(message);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler((error) => {
                        setIsSubmitting(false);
                        alert('更新失敗：' + error.message);
                    })
                    .updateAssetBasicInfo(asset.assetId, updates);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        {/* Header */}
                        <div className="bg-amber-50 px-6 py-4 border-b border-amber-100 rounded-t-2xl sticky top-0">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                        <i className="fa-solid fa-pen-to-square text-amber-600"></i>
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-slate-800">修改資產基本資料</h3>
                                        <p className="text-sm text-slate-500">編號：{asset?.assetId}</p>
                                    </div>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="w-8 h-8 rounded-lg hover:bg-amber-100 flex items-center justify-center transition-colors"
                                >
                                    <i className="fas fa-times text-slate-500"></i>
                                </button>
                            </div>
                        </div>

                        {/* Body */}
                        <div className="p-6 space-y-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-12">
                                    <i className="fas fa-spinner fa-spin text-2xl text-amber-500"></i>
                                    <span className="ml-3 text-slate-600">載入中...</span>
                                </div>
                            ) : (
                                <>
                                    {/* 只讀資訊區 */}
                                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <h4 className="text-sm font-medium text-slate-700 mb-3 flex items-center gap-2">
                                            <i className="fas fa-info-circle text-slate-400"></i>
                                            資產資訊（不可修改）
                                        </h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">編號</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.assetId || '-'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">保管地點</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.location || '-'}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-slate-500 mb-1">保管人</label>
                                                <div className="px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-600">
                                                    {asset?.leader || '-'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 可編輯欄位 */}
                                    <div className="space-y-4">
                                        <h4 className="text-sm font-medium text-slate-700 flex items-center gap-2">
                                            <i className="fas fa-edit text-amber-500"></i>
                                            可修改欄位
                                        </h4>

                                        {/* 名稱與型號 */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                                    名稱 <span className="text-red-500">*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    value={assetName}
                                                    onChange={(e) => setAssetName(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="請輸入名稱"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                                    型號/廠牌
                                                </label>
                                                <input
                                                    type="text"
                                                    value={modelBrand}
                                                    onChange={(e) => setModelBrand(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="請輸入型號或廠牌"
                                                />
                                            </div>
                                        </div>

                                        {/* 類別與日期 */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">類別</label>
                                                <input
                                                    type="text"
                                                    list="edit-category-list"
                                                    value={category}
                                                    onChange={(e) => setCategory(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="選擇或輸入類別"
                                                />
                                                <datalist id="edit-category-list">
                                                    {categories.map((cat, idx) => (
                                                        <option key={idx} value={cat} />
                                                    ))}
                                                </datalist>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">取得日期</label>
                                                <input
                                                    type="date"
                                                    value={purchaseDate}
                                                    onChange={(e) => setPurchaseDate(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">使用年限（年）</label>
                                                <input
                                                    type="number"
                                                    value={useLife}
                                                    onChange={(e) => setUseLife(e.target.value)}
                                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors"
                                                    placeholder="例如：3"
                                                    min="0"
                                                />
                                            </div>
                                        </div>

                                        {/* 資訊資產標記 */}
                                        <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                            <h5 className="text-sm font-medium text-blue-800 mb-3 flex items-center gap-2">
                                                <i className="fas fa-laptop text-blue-500"></i>
                                                資訊資產標記
                                            </h5>
                                            <div className="space-y-3">
                                                <label className="flex items-center gap-3 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={isItAsset}
                                                        onChange={(e) => setIsItAsset(e.target.checked)}
                                                        className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                    />
                                                    <span className="text-sm text-slate-700">此設備是否為資訊資產？</span>
                                                </label>

                                                {/* 子選項：只在 isItAsset 勾選時顯示 */}
                                                {isItAsset && (
                                                    <div className="ml-7 space-y-2 pt-2 border-t border-blue-200">
                                                        <label className="flex items-center gap-3 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={isActuallyComputer}
                                                                onChange={(e) => setIsActuallyComputer(e.target.checked)}
                                                                className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                            />
                                                            <span className="text-sm text-slate-600">此設備為電腦主機/筆電</span>
                                                        </label>
                                                        <label className="flex items-center gap-3 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={isIsoScope}
                                                                onChange={(e) => setIsIsoScope(e.target.checked)}
                                                                className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                                            />
                                                            <span className="text-sm text-slate-600">此設備是否在 ISO 驗證範圍內</span>
                                                        </label>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 bg-slate-50 border-t border-slate-200 rounded-b-2xl flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors disabled:opacity-50"
                            >
                                取消
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isLoading || isSubmitting}
                                className="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <><i className="fas fa-spinner fa-spin"></i><span>更新中...</span></>
                                ) : (
                                    <><i className="fas fa-save"></i><span>儲存變更</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ========== 盤點確認 Modal（單筆/批次共用）==========
            const InventoryConfirmModal = ({ asset, assetIds, isBatch, sessionId, availableSessions, defaultSessionId, isAdmin, onClose, onSuccess }) => {
            const [result, setResult] = useState('正常');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const initialSessionId = isBatch ? sessionId : (defaultSessionId || sessionId || '');
            const [selectedSessionId, setSelectedSessionId] = useState(initialSessionId);

            useEffect(() => {
                setSelectedSessionId(initialSessionId);
            }, [initialSessionId]);

            const shouldShowSessionSelect = !isBatch && isAdmin && availableSessions && availableSessions.length > 1;
            const formatSessionLabel = (session) => {
                const datePart = session.inventoryDate ? session.inventoryDate : '未提供日期';
                const personPart = session.inventoryPerson || session.inventoryEmail || '未指定盤點人';
                return `${datePart} / ${personPart}`;
            };

            const handleSubmit = () => {
                setIsSubmitting(true);
                showFlyProgressBar('正在提交盤點結果...');

                if (!selectedSessionId) {
                    hideFlyProgressBar('盤點失敗', 0);
                    alert('請選擇盤點會話');
                    setIsSubmitting(false);
                    return;
                }

                if (isBatch) {
                    // 批次盤點
                    const assetResults = assetIds.map(id => ({
                        assetId: id,
                        result: result,
                        remarks: remarks
                    }));

                    google.script.run
                        .withSuccessHandler((response) => {
                            hideFlyProgressBar('盤點完成！', 300);
                            alert(response.message);
                            setIsSubmitting(false);
                            onSuccess();
                            onClose();
                        })
                        .withFailureHandler((error) => {
                            hideFlyProgressBar('盤點失敗', 0);
                            alert('盤點失敗：' + error.message);
                            setIsSubmitting(false);
                        })
                        .markBatchInventory(selectedSessionId, assetResults);
                } else {
                    // 單筆盤點
                    google.script.run
                        .withSuccessHandler((response) => {
                            hideFlyProgressBar('盤點完成！', 300);
                            if (response.success) {
                                alert(response.message);
                                onSuccess();
                                onClose();
                            } else {
                                alert('盤點失敗：' + response.error);
                            }
                            setIsSubmitting(false);
                        })
                        .withFailureHandler((error) => {
                            hideFlyProgressBar('盤點失敗', 0);
                            alert('盤點失敗：' + error.message);
                            setIsSubmitting(false);
                        })
                        .markAssetInventory(selectedSessionId, asset.assetId, result, remarks);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-teal-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-teal-800">
                                <i className="fa-solid fa-clipboard-check mr-2"></i>
                                {isBatch ? `批次盤點確認 (${assetIds?.length || 0} 筆)` : '盤點確認'}
                            </h3>
                            <button onClick={onClose} className="text-teal-600 hover:text-teal-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Body */}
                        <div className="p-6 space-y-4">
                            {!isBatch && asset && (
                                <div className="bg-slate-50 rounded-lg p-4 space-y-2">
                                    <p><span className="font-medium text-slate-600">財產編號：</span>{asset.assetId}</p>
                                    <p><span className="font-medium text-slate-600">財產名稱：</span>{asset.assetName}</p>
                                    <p><span className="font-medium text-slate-600">保管人：</span>{asset.leader || asset.keeperName}</p>
                                    <p><span className="font-medium text-slate-600">地點：</span>{asset.location}</p>
                                </div>
                            )}

                            {shouldShowSessionSelect && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">盤點會話</label>
                                    <select
                                        value={selectedSessionId}
                                        onChange={(e) => setSelectedSessionId(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
                                    >
                                        {availableSessions.map(session => (
                                            <option key={session.inventoryId} value={session.inventoryId}>
                                                {formatSessionLabel(session)}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {/* 盤點結果選項 */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">盤點結果</label>
                                <div className="space-y-2">
                                    {['正常', '遺失', '損壞'].map(opt => (
                                        <label key={opt} className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="radio"
                                                name="inventoryResult"
                                                value={opt}
                                                checked={result === opt}
                                                onChange={(e) => setResult(e.target.value)}
                                                className="w-4 h-4 text-teal-600"
                                            />
                                            <span className={`${opt === '遺失' ? 'text-red-600' : opt === '損壞' ? 'text-orange-600' : 'text-green-600'}`}>
                                                {opt}
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* 備註 */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">備註（選填）</label>
                                <textarea
                                    value={remarks}
                                    onChange={(e) => setRemarks(e.target.value)}
                                    rows="3"
                                    placeholder="輸入備註..."
                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
                                />
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                取消
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <><i className="fas fa-spinner fa-spin"></i><span>提交中...</span></>
                                ) : (
                                    <><i className="fas fa-check"></i><span>確認盤點</span></>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 主 App 組件
        function App() {
            const [isReady, setIsReady] = useState(false);
            const [allAssets, setAllAssets] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [viewMode, setViewMode] = useState('user');
            const [currentUserEmail, setCurrentUserEmail] = useState('');
            const [currentUserName, setCurrentUserName] = useState('');
            const [webAppUrl, setWebAppUrl] = useState('');
            const [pendingApprovalsData, setPendingApprovalsData] = useState([]);
            const [inventorySessions, setInventorySessions] = useState(null);
            const [filters, setFilters] = useState({
                status: '',
                category: '',
                leader: '',
                search: ''
            });
            const [activeModal, setActiveModal] = useState(null);
            const [isLoadingCards, setIsLoadingCards] = useState(false);
            const [lentAssetsDetails, setLentAssetsDetails] = useState(null);
            const [isLoadingLentDetails, setIsLoadingLentDetails] = useState(false);
            const [scrapPendingDetails, setScrapPendingDetails] = useState(null);
            const [transferPendingDetails, setTransferPendingDetails] = useState(null);
            const [transferPendingCount, setTransferPendingCount] = useState(0);
            const [isLoadingScrapDetails, setIsLoadingScrapDetails] = useState(false);
            const [isLoadingTransferDetails, setIsLoadingTransferDetails] = useState(false);
            const [statusDetailState, setStatusDetailState] = useState(null);
            const statusDetailRequestRef = useRef(0);

            // 轉移中（我申請的轉移）相關 state
            const [transferringCount, setTransferringCount] = useState(0);
            const [transferringAssets, setTransferringAssets] = useState(null);
            const [isLoadingTransferring, setIsLoadingTransferring] = useState(false);

            // 快速操作 Modal 相關 state
            const [quickActionModalType, setQuickActionModalType] = useState(null); // 'transfer', 'lending', 'scrap'
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [transferOptions, setTransferOptions] = useState(null);
            const [lendingOptions, setLendingOptions] = useState(null);

            // 批次操作 Modal 相關 state
            const [batchModalType, setBatchModalType] = useState(null); // 'transfer', 'lending', 'scrap'
            const [batchActionAssetIds, setBatchActionAssetIds] = useState([]);

            // 新增資產 Modal 相關 state
            const [showAddAssetModal, setShowAddAssetModal] = useState(false);
            const [addAssetDropdownData, setAddAssetDropdownData] = useState(null);

            // 編輯資產 Modal 相關 state（僅管理員）
            const [showEditAssetModal, setShowEditAssetModal] = useState(false);
            const [editingAsset, setEditingAsset] = useState(null);

            // 資產選取狀態（與 BatchList 同步）
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);

            // 盤點管理 Modal 相關 state
            const [showInventoryMgmtModal, setShowInventoryMgmtModal] = useState(false);

            // 盤點相關狀態
            const [inventoryPendingByAsset, setInventoryPendingByAsset] = useState({});
            const [pendingInventoryItems, setPendingInventoryItems] = useState([]);
            const [isLoadingPendingInventory, setIsLoadingPendingInventory] = useState(false);
            const [pendingInventoryError, setPendingInventoryError] = useState('');
            const [currentInventorySessionId, setCurrentInventorySessionId] = useState(null);
            const [showInventoryModal, setShowInventoryModal] = useState(false);
            const [inventoryModalAsset, setInventoryModalAsset] = useState(null); // 單筆盤點
            const [inventoryModalSessions, setInventoryModalSessions] = useState([]);
            const [inventoryModalSessionId, setInventoryModalSessionId] = useState('');
            const [showBatchInventoryModal, setShowBatchInventoryModal] = useState(false);
            const [selectedInventoryAssetIds, setSelectedInventoryAssetIds] = useState([]);
            const [batchInventorySessionId, setBatchInventorySessionId] = useState('');
            const [currentUserGroup, setCurrentUserGroup] = useState('');
            const viewModeInitializedRef = useRef(false);
            const inventoryToastTimerRef = useRef(null);

            const isAdminView = isAdmin && viewMode === 'admin';
            const normalizeEmail = (value) => String(value || '').trim().toLowerCase();
            const isInventoryTaskOnly = useCallback((asset) => {
                if (!asset) return false;
                if (isAdminView) return false;
                const currentEmail = normalizeEmail(currentUserEmail);
                if (!currentEmail) return false;
                const leaderEmail = normalizeEmail(asset.leaderEmail);
                const userEmail = normalizeEmail(asset.userEmail);
                return leaderEmail !== currentEmail && userEmail !== currentEmail;
            }, [isAdminView, currentUserEmail]);
            const assetIndex = useMemo(() => {
                const map = new Map();
                (allAssets || []).forEach(asset => {
                    map.set(asset.assetId, asset);
                });
                return map;
            }, [allAssets]);
            const resolveAssetIsTask = useCallback((assetId) => {
                const checkbox = document.querySelector(`.asset-checkbox[value="${assetId}"]`);
                if (checkbox && checkbox.dataset && checkbox.dataset.isTask) {
                    return checkbox.dataset.isTask === 'true';
                }
                const asset = assetIndex.get(assetId);
                return asset ? isInventoryTaskOnly(asset) : false;
            }, [assetIndex, isInventoryTaskOnly]);
            const getSelectedAssetsForAction = useCallback((actionType) => {
                if (typeof BatchList_getItems !== 'function') {
                    return [];
                }
                const selectedIds = BatchList_getItems();
                if (actionType === 'INVENTORY') {
                    return selectedIds;
                }
                let blockedCount = 0;
                const allowed = selectedIds.filter(assetId => {
                    const isTask = resolveAssetIsTask(assetId);
                    if (isTask) {
                        blockedCount += 1;
                        return false;
                    }
                    return true;
                });
                if (blockedCount > 0) {
                    const message = `已自動排除 ${blockedCount} 筆同組成員資產，僅保留可操作的項目。`;
                    if (typeof window.BatchList_showToast === 'function') {
                        window.BatchList_showToast(message, 'warning');
                    } else {
                        alert(message);
                    }
                }
                return allowed;
            }, [resolveAssetIsTask]);

            // 處理單個資產選取
            const handleAssetSelect = useCallback((assetId) => {
                setSelectedAssetIds(prev => {
                    const isSelected = prev.includes(assetId);
                    let newSelection;

                    if (isSelected) {
                        // 取消選取
                        newSelection = prev.filter(id => id !== assetId);
                        if (typeof window.BatchList_removeItem === 'function') {
                            window.BatchList_removeItem(assetId);
                        }
                    } else {
                        // 選取
                        newSelection = [...prev, assetId];
                        if (typeof window.BatchList_addItem === 'function') {
                            window.BatchList_addItem(assetId);
                        }
                    }
                    return newSelection;
                });
            }, []);

            // 監聽 BatchList 變化並同步（處理 Scanner Enter 鍵掃描的情況）
            useEffect(() => {
                const syncFromBatchList = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        const batchItems = window.BatchList_getItems();
                        setSelectedAssetIds(prev => {
                            // 只添加新的項目，不移除舊的
                            const newItems = batchItems.filter(id => !prev.includes(id));
                            if (newItems.length > 0) {
                                return [...prev, ...newItems];
                            }
                            return prev;
                        });
                    }
                };

                // 定期同步（處理外部添加的情況）
                const interval = setInterval(syncFromBatchList, 500);
                return () => clearInterval(interval);
            }, []);

            // ========== 盤點功能輔助函數 ==========

            const buildInventoryPendingByAsset = useCallback((pendingItems) => {
                const map = {};
                (pendingItems || []).forEach(item => {
                    const assetId = String(item.assetId || '').trim();
                    if (!assetId) return;
                    if (!map[assetId]) {
                        map[assetId] = {
                            assetId: assetId,
                            assetName: item.assetName || '',
                            keeperName: item.keeperName || '',
                            userName: item.userName || '',
                            location: item.location || '',
                            sessions: []
                        };
                    }

                    const sessions = map[assetId].sessions;
                    const exists = sessions.some(s => s.inventoryId === item.inventoryId);
                    if (!exists) {
                        sessions.push({
                            inventoryId: item.inventoryId,
                            inventoryDate: item.inventoryDate || '',
                            inventoryPerson: item.inventoryPerson || '',
                            inventoryEmail: item.inventoryEmail || ''
                        });
                    }
                });
                return map;
            }, []);

            const loadPendingInventoryAssignments = useCallback((forceUserScope, options = {}) => {
              const { onComplete } = options;
              setIsLoadingPendingInventory(true);
              setPendingInventoryError('');
              google.script.run
                .withSuccessHandler((response) => {
                  if (!response) {
                    setInventoryPendingByAsset({});
                    setPendingInventoryItems([]);
                    setIsLoadingPendingInventory(false);
                    setPendingInventoryError('沒有回應');
                    if (typeof onComplete === 'function') {
                      onComplete(new Error('沒有回應'));
                    }
                    return;
                  }
                  if (response.error) {
                    console.warn('載入盤點待辦失敗：', response.error);
                    setInventoryPendingByAsset({});
                    setPendingInventoryItems([]);
                    setIsLoadingPendingInventory(false);
                    setPendingInventoryError(response.error);
                    if (typeof onComplete === 'function') {
                      onComplete(new Error(response.error));
                    }
                    return;
                  }
                  const pendingItems = response.pendingItems || [];
                  const map = buildInventoryPendingByAsset(pendingItems);
                  setInventoryPendingByAsset(map);
                  setPendingInventoryItems(pendingItems);
                  setIsLoadingPendingInventory(false);
                  setPendingInventoryError('');
                  if (typeof onComplete === 'function') {
                    onComplete(null, response);
                  }
                })
                .withFailureHandler((error) => {
                  console.error('載入盤點待辦失敗:', error);
                  setInventoryPendingByAsset({});
                  setPendingInventoryItems([]);
                  setIsLoadingPendingInventory(false);
                  setPendingInventoryError(error.message || '載入失敗');
                  if (typeof onComplete === 'function') {
                    onComplete(error);
                  }
                })
                .getPendingInventoryAssignments(forceUserScope);
            }, [buildInventoryPendingByAsset]);

            const getAssetPendingSessions = useCallback((assetId) => {
                const entry = inventoryPendingByAsset[assetId];
                return entry ? entry.sessions || [] : [];
            }, [inventoryPendingByAsset]);

            // 檢查資產是否在待盤點清單中（可指定盤點會話）
            const isAssetPendingInventory = useCallback((assetId, sessionId) => {
                const sessions = getAssetPendingSessions(assetId);
                if (sessions.length === 0) return false;
                if (!sessionId) return true;
                return sessions.some(session => session.inventoryId === sessionId);
            }, [getAssetPendingSessions]);

            // 載入資料
            const loadData = (overrideViewMode) => {
                showFlyProgressBar('正在載入財產狀態資料...');
                setIsLoadingCards(true); // 初始載入時也顯示卡片載入動畫
                const effectiveViewMode = overrideViewMode || viewMode;
                const forceUserScope = effectiveViewMode === 'user';

                google.script.run
                    .withSuccessHandler(url => {
                        setWebAppUrl(url);

                        // 載入使用者資料
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('載入失敗：' + response.error);
                                    hideFlyProgressBar('載入失敗', 0);
                                    return;
                                }

                                setIsAdmin(response.isAdmin);
                                setCurrentUserEmail(response.userEmail);
                                setCurrentUserName(response.userName || '');
                                const shouldSwitchToAdmin = response.isAdmin && forceUserScope && !viewModeInitializedRef.current;
                                if (shouldSwitchToAdmin) {
                                    setViewMode('admin');
                                    viewModeInitializedRef.current = true;
                                    loadData('admin');
                                    return;
                                }

                                // ✨ 方案 B：預處理搜尋文字，避免每次搜尋都重新計算
                                const processedAssets = (response.assets || []).map(asset => ({
                                    ...asset,
                                    searchText: [
                                        asset.assetId,
                                        asset.assetName,
                                        asset.leader,
                                        asset.location
                                    ].filter(Boolean).join(' ').toLowerCase()
                                }));
                                setAllAssets(processedAssets);
                                if (!viewModeInitializedRef.current) {
                                    setViewMode(response.isAdmin ? 'admin' : 'user');
                                    viewModeInitializedRef.current = true;
                                }

                                let pendingLoaded = false;
                                let inventoryLoaded = false;
                                const finishCardLoading = () => {
                                    if (pendingLoaded && inventoryLoaded) {
                                        setIsLoadingCards(false);
                                    }
                                };

                                // 載入待接收資料
                                google.script.run
                                    .withSuccessHandler(pendingResponse => {
                                        if (pendingResponse && pendingResponse.approvals) {
                                            setPendingApprovalsData(pendingResponse.approvals);
                                        }
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入待接收清單失敗：', error.message);
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getPendingApprovals(forceUserScope);

                                // 載入盤點資料
                                google.script.run
                                    .withSuccessHandler(inventoryResponse => {
                                        if (inventoryResponse) {
                                            setInventorySessions(inventoryResponse);
                                            setCurrentUserGroup(inventoryResponse.currentUserGroup || '');

                                            // 如有進行中會話，載入詳情以獲取待盤點資產
                                            if (inventoryResponse.activeSessions && inventoryResponse.activeSessions.length > 0) {
                                                const sessionId = inventoryResponse.activeSessions[0].inventoryId;
                                                setCurrentInventorySessionId(sessionId);
                                            }
                                        }
                                        loadPendingInventoryAssignments(forceUserScope);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入盤點資料失敗：', error.message);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getInventoryData(forceUserScope);

                                // 載入轉移待列印數量
                                google.script.run
                                    .withSuccessHandler(count => {
                                        if (typeof count === 'number') {
                                            setTransferPendingCount(count);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入轉移數量失敗：', error.message);
                                        setTransferPendingCount(0);
                                    })
                                    .getTransferableItemsCount(forceUserScope);

                                // 載入我申請的轉移中資產數量
                                google.script.run
                                    .withSuccessHandler(response => {
                                        if (response && typeof response.count === 'number') {
                                            setTransferringCount(response.count);
                                            setTransferringAssets(response.assets || []);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入轉移中數量失敗：', error.message);
                                        setTransferringCount(0);
                                        setTransferringAssets(null);
                                    })
                                    .getTransferringAssets(forceUserScope);

                                // 載入轉移選項資料（保管人、地點等）
                                google.script.run
                                    .withSuccessHandler(transferData => {
                                        if (transferData && !transferData.error) {
                                            setTransferOptions(transferData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入轉移選項失敗：', error.message);
                                    })
                                    .getTransferData();

                                // 載入出借選項資料（借用人、地點）
                                google.script.run
                                    .withSuccessHandler(lendingData => {
                                        if (lendingData && !lendingData.error) {
                                            setLendingOptions(lendingData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('載入出借選項失敗：', error.message);
                                    })
                                    .getLendingData();

                                // 預先載入出借中清單
                                google.script.run
                                    .withSuccessHandler(response => {
                                        if (response && !response.error) {
                                            setLentAssetsDetails(response.assets || []);
                                        } else {
                                            setLentAssetsDetails(null);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('預先載入出借清單失敗：', error.message);
                                        setLentAssetsDetails(null);
                                    })
                                    .getLentOutAssets(forceUserScope);

                                setIsReady(true);
                                hideFlyProgressBar('資料載入完成！', 300);
                            })
                            .withFailureHandler(error => {
                                setIsLoadingCards(false); // 失敗時也關閉卡片動畫
                                hideFlyProgressBar('載入失敗', 0);
                                alert('錯誤：' + error.message);
                            })
                            .getUserStateData(forceUserScope);
                    })
                    .getAppUrl();
            };

            // 重新整理卡片數據（並行載入）
            const refreshCardData = useCallback(async () => {
                const MIN_LOADING_DURATION = 500; // 最短顯示時間 500ms
                setIsLoadingCards(true);
                setIsLoadingPendingInventory(true);
                setPendingInventoryError('');
                const startTime = Date.now();
                const forceUserScope = viewMode === 'user';

                try {
                    // 並行載入五個 API
                    const [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse, transferringResponse, pendingInventoryResponse, lentResponse] = await Promise.allSettled([
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingApprovals(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getInventoryData(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getUserStateData(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferableItemsCount(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferringAssets(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingInventoryAssignments(forceUserScope);
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getLentOutAssets(forceUserScope);
                        })
                    ]);

                    // 處理成功的結果
                    if (pendingResponse.status === 'fulfilled' && pendingResponse.value?.approvals) {
                        setPendingApprovalsData(pendingResponse.value.approvals);
                    }
                    if (inventoryResponse.status === 'fulfilled' && inventoryResponse.value) {
                        setInventorySessions(inventoryResponse.value);
                    }
                    if (assetsResponse.status === 'fulfilled' && assetsResponse.value?.assets) {
                        // ✨ 方案 B：預處理搜尋文字
                        const processedAssets = assetsResponse.value.assets.map(asset => ({
                            ...asset,
                            searchText: [
                                asset.assetId,
                                asset.assetName,
                                asset.leader,
                                asset.location
                            ].filter(Boolean).join(' ').toLowerCase()
                        }));
                        setAllAssets(processedAssets);
                    }
                    if (transferCountResponse.status === 'fulfilled' && typeof transferCountResponse.value === 'number') {
                        setTransferPendingCount(transferCountResponse.value);
                    }
                    if (transferringResponse.status === 'fulfilled' && typeof transferringResponse.value?.count === 'number') {
                        setTransferringCount(transferringResponse.value.count);
                        setTransferringAssets(transferringResponse.value.assets || []);
                    }
                    let pendingInventoryLoadError = '';
                    if (pendingInventoryResponse.status === 'fulfilled') {
                      const response = pendingInventoryResponse.value;
                      if (response && !response.error) {
                        const pendingItems = response.pendingItems || [];
                        const map = buildInventoryPendingByAsset(pendingItems);
                        setInventoryPendingByAsset(map);
                        setPendingInventoryItems(pendingItems);
                      } else {
                        setInventoryPendingByAsset({});
                        setPendingInventoryItems([]);
                        pendingInventoryLoadError = response?.error || '載入失敗';
                      }
                    } else {
                      setInventoryPendingByAsset({});
                      setPendingInventoryItems([]);
                      pendingInventoryLoadError = pendingInventoryResponse.reason?.message || '載入失敗';
                    }
                    if (pendingInventoryLoadError) {
                      setPendingInventoryError(pendingInventoryLoadError);
                    }
                    if (lentResponse.status === 'fulfilled') {
                        const response = lentResponse.value;
                        if (response && !response.error) {
                            setLentAssetsDetails(response.assets || []);
                        } else {
                            setLentAssetsDetails(null);
                        }
                    }

                    // 檢查失敗的請求
                    const failures = [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse, transferringResponse, pendingInventoryResponse, lentResponse]
                        .filter(r => r.status === 'rejected');
                    if (failures.length > 0) {
                        console.warn('部分數據載入失敗：', failures);
                        alert('部分數據載入失敗，請稍後重試。');
                    }

                    // 確保最短顯示時間
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, MIN_LOADING_DURATION - elapsedTime);

                    setTimeout(() => {
                        setIsLoadingCards(false);
                    }, remainingTime);

                } catch (error) {
                    setIsLoadingCards(false);
                    console.error('重新整理失敗：', error);
                    alert('重新整理失敗：' + error.message);
                    setPendingInventoryError(error.message || '載入失敗');
                } finally {
                    setIsLoadingPendingInventory(false);
                }
            }, [buildInventoryPendingByAsset, viewMode]);

            // 重新整理按鈕點擊處理
            const handleRefreshCards = () => {
                refreshCardData();
            };

            const handleViewModeChange = (mode) => {
                if (!isAdmin) return;
                if (mode === viewMode) return;
                setViewMode(mode);
                setTransferringAssets(null);
                setLentAssetsDetails(null);
                loadData(mode);
            };

            useEffect(() => {
                if (!isAdminView && showInventoryMgmtModal) {
                    setShowInventoryMgmtModal(false);
                }
            }, [isAdminView, showInventoryMgmtModal]);

            useEffect(() => {
                loadData();

                // 設定全域刷新函數
                window.refreshReactData = () => {
                    loadData();
                };
            }, []);

            // 同步狀態到全域變數供 jQuery Modal 使用
            useEffect(() => {
                window.pendingApprovals = pendingApprovalsData;
            }, [pendingApprovalsData]);

            useEffect(() => {
                if (!isReady) return;

                if (isLoadingPendingInventory) {
                    if (!inventoryToastTimerRef.current) {
                        inventoryToastTimerRef.current = setTimeout(() => {
                            if (typeof window.showInventoryLoadingToast === 'function') {
                                window.showInventoryLoadingToast('盤點資料載入中，盤點確認按鈕即將出現...');
                            }
                            inventoryToastTimerRef.current = null;
                        }, 250);
                    }
                    return;
                }

                if (inventoryToastTimerRef.current) {
                    clearTimeout(inventoryToastTimerRef.current);
                    inventoryToastTimerRef.current = null;
                }

                if (typeof window.hideInventoryLoadingToast === 'function') {
                    const completionText = pendingInventoryError
                        ? '盤點資料載入失敗，請稍後重試'
                        : '盤點確認按鈕已就緒';
                    window.hideInventoryLoadingToast(completionText, 300, !pendingInventoryError);
                }
            }, [isLoadingPendingInventory, isReady, pendingInventoryError]);

            useEffect(() => {
                return () => {
                    if (inventoryToastTimerRef.current) {
                        clearTimeout(inventoryToastTimerRef.current);
                        inventoryToastTimerRef.current = null;
                    }
                };
            }, []);

            // 計算篩選後的資產
            const filteredAssets = useMemo(() => {
                // ✨ 方案 B：預處理搜尋關鍵字（只計算一次）
                const searchLower = filters.search ? filters.search.toLowerCase() : '';

                return allAssets.filter(asset => {
                    const statusMatch = !filters.status || asset.status === filters.status;
                    const categoryMatch = !filters.category || asset.category === filters.category;
                    const leaderMatch = !filters.leader || asset.leader === filters.leader;
                    // ✨ 使用預處理的 searchText，避免每筆資產重複計算 toUpperCase()
                    const searchMatch = !searchLower ||
                        (asset.searchText && asset.searchText.includes(searchLower));
                    return statusMatch && categoryMatch && leaderMatch && searchMatch;
                });
            }, [allAssets, filters]);

            // 處理全選（必須在 filteredAssets 定義之後）
            const handleSelectAll = useCallback((checked) => {
                const selectableAssets = filteredAssets.filter(a => a.status === '在庫');
                const selectableIds = selectableAssets.map(a => a.assetId);

                // ✨ 取得上限值（預設 500）
                const MAX_BATCH_SIZE = typeof window.BatchList_getMaxSize === 'function'
                    ? window.BatchList_getMaxSize()
                    : 500;

                if (checked) {
                    // ✨ 數量預檢查：超過上限時彈出警告
                    if (selectableIds.length > MAX_BATCH_SIZE) {
                        const proceed = window.confirm(
                            `您即將選取 ${selectableIds.length} 筆資產，超過建議上限 ${MAX_BATCH_SIZE} 筆。\n` +
                            `大量選取可能造成頁面反應緩慢。\n\n` +
                            `點擊「取消」將不會選擇任何資產\n` +
                            `點擊「確認」將自動選擇前${MAX_BATCH_SIZE} 筆資產\n`
                        );
                        if (!proceed) return;
                    }

                    // ✨ 全選：使用批量 API 提升效能
                    setSelectedAssetIds(prev => {
                        const newIds = selectableIds.filter(id => !prev.includes(id));
                        if (typeof window.BatchList_addItems === 'function') {
                            // 使用批量新增（一次性更新 UI）
                            window.BatchList_addItems(newIds);
                        } else if (typeof window.BatchList_addItemSilent === 'function') {
                            // 降級：靜默新增後一次性更新
                            newIds.forEach(id => window.BatchList_addItemSilent(id));
                            if (typeof window.BatchList_updateUI === 'function') {
                                window.BatchList_updateUI();
                            }
                        } else {
                            // 最終降級：逐筆加入
                            newIds.forEach(id => {
                                if (typeof window.BatchList_addItem === 'function') {
                                    window.BatchList_addItem(id);
                                }
                            });
                        }
                        return [...new Set([...prev, ...selectableIds])];
                    });
                } else {
                    // 取消全選
                    setSelectedAssetIds(prev => {
                        selectableIds.forEach(id => {
                            if (typeof window.BatchList_removeItem === 'function') {
                                window.BatchList_removeItem(id);
                            }
                        });
                        return prev.filter(id => !selectableIds.includes(id));
                    });
                }
            }, [filteredAssets]);

            // 計算重複產編
            const duplicateInfo = useMemo(() => {
                const map = new Map();
                const duplicates = new Map();
                let duplicateCount = 0;

                filteredAssets.forEach(asset => {
                    const key = String(asset.assetId || '').trim();
                    if (map.has(key)) {
                        duplicateCount += 1;
                        const existing = map.get(key);
                        if (!duplicates.has(key)) {
                            duplicates.set(key, [existing]);
                        }
                        duplicates.get(key).push(asset);
                    } else {
                        map.set(key, asset);
                    }
                });

                const groups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                    assetId,
                    items
                }));

                return { duplicateCount, groups };
            }, [filteredAssets]);

            // 同步重複產編資料到全域變數
            useEffect(() => {
                window.duplicateGroups = duplicateInfo.groups;
            }, [duplicateInfo.groups]);

            // 同步「在庫」資產到全域變數，供 BatchList 和 Scanner 模組使用
            useEffect(() => {
                if (!isReady) return;

                // ⚠️ 只包含「在庫」狀態的資產，限制可選取範圍
                window.allAssets = allAssets
                    .filter(asset => asset.status === '在庫')
                    .map(asset => ({
                        id: asset.assetId,
                        assetName: asset.assetName,
                        keeperName: asset.leader,
                        location: asset.location,
                        status: asset.status
                    }));

                // 重建 BatchList 索引
                if (typeof window.BatchList_rebuildIndex === 'function') {
                    window.BatchList_rebuildIndex();
                }

                // ✨ 重新初始化 Scanner 搜尋框增強（React 動態渲染後需重新綁定）
                if (typeof window.Scanner_enhanceSearchBox === 'function') {
                    setTimeout(() => {
                        window.Scanner_enhanceSearchBox();
                        console.log('[App] 已重新初始化 Scanner 搜尋框增強');
                    }, 100);
                }

                console.log('[App] 已更新 window.allAssets，共', window.allAssets.length, '筆「在庫」資產');
            }, [allAssets, isReady]);

            // 計算卡片統計數量
            const cardCounts = useMemo(() => {
                // ✨ 直接使用後端計算的待盤點資產數量（管理員顯示全域）
                const inventoryCount = isAdminView
                    ? (inventorySessions?.totalPendingInventoryCount || inventorySessions?.myPendingInventoryCount || 0)
                    : (inventorySessions?.myPendingInventoryCount || 0);

                const scrapPendingCount = (() => {
                    const scrappingAssets = allAssets.filter(a => a.status === '報廢中');
                    if (isAdminView) {
                        return scrappingAssets.length;
                    } else {
                        return scrappingAssets.filter(a =>
                            a.leaderEmail?.toLowerCase() === currentUserEmail.toLowerCase() ||
                            a.userEmail?.toLowerCase() === currentUserEmail.toLowerCase()
                        ).length;
                    }
                })();

                return {
                    transferring: transferringCount,  // 我申請的轉移中資產
                    pending: pendingApprovalsData.length,
                    lent: allAssets.filter(a => a.status === '出借中').length,
                    scrapPending: scrapPendingCount,
                    transferPending: transferPendingCount,
                    inventory: inventoryCount
                };
            }, [allAssets, pendingApprovalsData, inventorySessions, currentUserEmail, isAdminView, transferPendingCount, transferringCount]);

            // 處理卡片點擊
            const handleCardClick = (cardId) => {
                switch(cardId) {
                    case 'transferring':
                        // 設定載入狀態並打開 modal
                        setActiveModal('transferring');

                        if (transferringAssets !== null) {
                            setIsLoadingTransferring(false);
                            return;
                        }

                        setIsLoadingTransferring(true);
                        // 調用後端獲取轉移中資產詳情
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('載入轉移中資料失敗：' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingTransferring(false);
                                    return;
                                }
                                setTransferringAssets(response.assets || []);
                                setIsLoadingTransferring(false);
                            })
                            .withFailureHandler(error => {
                                console.error('載入轉移中詳情失敗：', error.message);
                                alert('載入轉移中詳情失敗：' + error.message);
                                setActiveModal(null);
                                setIsLoadingTransferring(false);
                            })
                            .getTransferringAssets(viewMode === 'user');
                        break;
                    case 'pending':
                        window.openPendingApprovalModal();
                        break;
                    case 'lent':
                        // 設定載入狀態並打開 modal
                        setActiveModal('lent');

                        if (lentAssetsDetails !== null) {
                            setIsLoadingLentDetails(false);
                            return;
                        }

                        setIsLoadingLentDetails(true);
                        // 調用後端獲取詳細出借資訊
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('載入出借資料失敗：' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingLentDetails(false);
                                    return;
                                }
                                setLentAssetsDetails(response.assets || []);
                                setIsLoadingLentDetails(false);
                            })
                            .withFailureHandler(error => {
                                console.error('載入出借詳情失敗：', error.message);
                                alert('載入出借詳情失敗：' + error.message);
                                setActiveModal(null);
                                setIsLoadingLentDetails(false);
                            })
                            .getLentOutAssets(viewMode === 'user');
                        break;
                    case 'scrapPending':
                        setIsLoadingScrapDetails(true);
                        setActiveModal('scrapPrint');

                        // 並行載入財產和物品兩個類別
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('財產', viewMode === 'user');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('物品', viewMode === 'user');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('收到的報廢資料格式錯誤，可能是後端序列化失敗', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('載入失敗：資料格式錯誤');
                                setActiveModal(null);
                                setIsLoadingScrapDetails(false);
                                return;
                            }

                            setScrapPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingScrapDetails(false);
                        }).catch(error => {
                            console.error('載入報廢詳情失敗：', error);
                            alert('載入報廢詳情失敗：' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingScrapDetails(false);
                        });
                        break;
                    case 'transferPending':
                        setIsLoadingTransferDetails(true);
                        setActiveModal('transferPrint');

                        // 並行載入財產和物品兩個類別
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('財產', viewMode === 'user');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('物品', viewMode === 'user');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('收到的轉移資料格式錯誤，可能是後端序列化失敗', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('載入失敗：資料格式錯誤');
                                setActiveModal(null);
                                setIsLoadingTransferDetails(false);
                                return;
                            }

                            setTransferPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingTransferDetails(false);
                        }).catch(error => {
                            console.error('載入轉移詳情失敗：', error);
                            alert('載入轉移詳情失敗：' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingTransferDetails(false);
                        });
                        break;
                    case 'inventory':
                        setActiveModal('inventoryPending');
                        loadPendingInventoryAssignments(viewMode === 'user');
                        break;
                }
            };

            // 處理篩選變更（使用 useCallback 穩定引用）
            const handleFilterChange = useCallback((filterName, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterName]: value
                }));
            }, []);

            // ✨ 注意：window.clearSearchBox 已移至 FilterSection 組件中定義
            // 這樣可以同時清空 localSearch（輸入框顯示值）和 filters.search（篩選值）

            // 快速操作 Modal 開啟函數
            const handleOpenTransferModal = (asset) => {
                if (!transferOptions) {
                    alert('轉移選項尚未載入，請稍後再試');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('transfer');
            };

            const handleOpenLendingModal = (asset) => {
                if (!lendingOptions) {
                    alert('出借選項尚未載入，請稍後再試');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('lending');
            };

            const handleOpenScrapModal = (asset) => {
                setSelectedAsset(asset);
                setQuickActionModalType('scrap');
            };

            const handleCloseQuickActionModal = () => {
                setQuickActionModalType(null);
                setSelectedAsset(null);
            };

            const handleQuickActionSuccess = () => {
                // 重新載入資料
                loadData();
            };

            const handleOpenStatusDetail = useCallback((asset) => {
                if (!asset) return;
                const detailType = STATUS_DETAIL_TYPES[asset.status];
                if (!detailType) return;

                statusDetailRequestRef.current += 1;
                const requestId = statusDetailRequestRef.current;

                setStatusDetailState({
                    asset: {
                        assetId: asset.assetId,
                        assetName: asset.assetName,
                        status: asset.status
                    },
                    type: detailType,
                    detail: null,
                    isLoading: true,
                    error: ''
                });

                google.script.run
                    .withSuccessHandler(response => {
                        if (statusDetailRequestRef.current !== requestId) return;
                        if (!response || response.error) {
                            const message = response?.error || '載入失敗';
                            setStatusDetailState(prev => prev ? { ...prev, isLoading: false, error: message } : prev);
                            return;
                        }
                        setStatusDetailState(prev => {
                            if (!prev) return prev;
                            const updatedAsset = {
                                ...prev.asset,
                                assetName: response.assetName || prev.asset.assetName,
                                status: response.status || prev.asset.status
                            };
                            return {
                                ...prev,
                                asset: updatedAsset,
                                type: response.type || prev.type,
                                detail: response.detail || null,
                                isLoading: false,
                                error: ''
                            };
                        });
                    })
                    .withFailureHandler(error => {
                        if (statusDetailRequestRef.current !== requestId) return;
                        const message = error?.message || '載入失敗';
                        setStatusDetailState(prev => prev ? { ...prev, isLoading: false, error: message } : prev);
                    })
                    .getAssetStatusDetail(asset.assetId, viewMode === 'user');
            }, [viewMode]);

            const handleCloseStatusDetail = useCallback(() => {
                setStatusDetailState(null);
            }, []);

            // ========== 編輯資產 Modal 處理函數（僅管理員）==========
            const handleOpenEditModal = (asset) => {
                setEditingAsset(asset);
                setShowEditAssetModal(true);
            };

            const handleEditAssetSuccess = useCallback(() => {
                // 重新載入資料
                loadData();
            }, []);

            // ========== 盤點操作處理函數 ==========
            // 開啟單筆盤點 Modal
                    const handleOpenInventoryModal = (asset) => {
                        const sessions = getAssetPendingSessions(asset.assetId);
                        if (!sessions || sessions.length === 0) {
                            alert('此資產目前沒有待盤點的會話');
                            return;
                        }
                const defaultSessionId = currentInventorySessionId && sessions.some(s => s.inventoryId === currentInventorySessionId)
                    ? currentInventorySessionId
                    : sessions[0].inventoryId;
                setInventoryModalSessions(sessions);
                setInventoryModalSessionId(defaultSessionId || '');
                        setInventoryModalAsset(asset);
                        setShowInventoryModal(true);
                    };

            // 開啟批次盤點 Modal
            const handleBatchInventory = () => {
                if (typeof BatchList_getItems !== 'function') {
                    alert('批次選取功能尚未載入');
                    return;
                }
                const items = getSelectedAssetsForAction('INVENTORY');
                if (items.length === 0) {
                    alert('請先選取要處理的資產');
                    return;
                }
                // 過濾出待盤點的資產
                const pendingItems = items.filter(id => isAssetPendingInventory(id));
                if (pendingItems.length === 0) {
                    alert('選取的資產中沒有待盤點的項目');
                    return;
                }
                // 找出所有選取資產的共同盤點會話
                let commonSessionIds = null;
                pendingItems.forEach((assetId) => {
                    const sessionIds = getAssetPendingSessions(assetId).map(session => session.inventoryId);
                    if (sessionIds.length === 0) return;
                    const sessionSet = new Set(sessionIds);
                    if (commonSessionIds === null) {
                        commonSessionIds = sessionSet;
                    } else {
                        commonSessionIds = new Set([...commonSessionIds].filter(id => sessionSet.has(id)));
                    }
                });

                const resolvedSessionId = commonSessionIds && commonSessionIds.size > 0
                    ? (currentInventorySessionId && commonSessionIds.has(currentInventorySessionId)
                        ? currentInventorySessionId
                        : Array.from(commonSessionIds)[0])
                    : '';

                if (!resolvedSessionId) {
                    alert('選取的資產分屬不同盤點會話，請分批處理或使用單筆盤點。');
                    return;
                }

                setBatchInventorySessionId(resolvedSessionId);
                setSelectedInventoryAssetIds(pendingItems);
                setShowBatchInventoryModal(true);
            };

            // 盤點成功回調
            const handleInventorySuccess = useCallback(() => {
                // 重新載入盤點待辦清單
                loadPendingInventoryAssignments(viewMode === 'user');
                // 刷新卡片數據
                refreshCardData();
            }, [loadPendingInventoryAssignments, refreshCardData, viewMode]);

            // ========== 批次操作處理函數 ==========
            const handleBatchTransfer = () => {
                if (!transferOptions) {
                    alert('轉移選項尚未載入，請稍後再試');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('批次選取功能尚未載入');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('請先選取要處理的資產');
                    return;
                }
                const items = getSelectedAssetsForAction('TRANSFER');
                if (items.length === 0) {
                    alert('選取的資產皆為同組成員資產，無法批次轉移。');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('transfer');
            };

            const handleBatchLending = () => {
                if (!lendingOptions) {
                    alert('出借選項尚未載入，請稍後再試');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('批次選取功能尚未載入');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('請先選取要處理的資產');
                    return;
                }
                const items = getSelectedAssetsForAction('LENDING');
                if (items.length === 0) {
                    alert('選取的資產皆為同組成員資產，無法批次出借。');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('lending');
            };

            const handleBatchScrap = () => {
                if (typeof BatchList_getItems !== 'function') {
                    alert('批次選取功能尚未載入');
                    return;
                }
                const rawItems = BatchList_getItems();
                if (rawItems.length === 0) {
                    alert('請先選取要處理的資產');
                    return;
                }
                const items = getSelectedAssetsForAction('SCRAP');
                if (items.length === 0) {
                    alert('選取的資產皆為同組成員資產，無法批次報廢。');
                    return;
                }
                setBatchActionAssetIds(items);
                setBatchModalType('scrap');
            };

            const handleCloseBatchModal = () => {
                setBatchModalType(null);
                setBatchActionAssetIds([]);
            };

            const handleBatchActionSuccess = () => {
                setBatchModalType(null);
                setBatchActionAssetIds([]);
                // 清空批次清單
                if (typeof BatchList_resetOnSubmit === 'function') {
                    BatchList_resetOnSubmit();
                }
                // 清空 React 選取狀態
                setSelectedAssetIds([]);
                // 重新載入資料
                loadData();
            };

            // 新增資產成功後的回調
            const handleAddAssetSuccess = useCallback(() => {
                // 重新載入資料
                loadData();
            }, []);

            // 處理取消
            const handleCancel = (assetId, status) => {
                const confirmation = confirm(
                    `您確定要取消這筆 [${status}] 狀態的申請嗎？\n\n` +
                    `財產編號：${assetId}\n\n` +
                    `此操作將會把財產狀態恢復為「在庫」。`
                );

                if (!confirmation) return;

                showFlyProgressBar('正在取消申請...');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            hideFlyProgressBar('取消完成！', 300);

                            setTimeout(() => {
                                alert('申請已成功取消。');
                                showFlyProgressBar('正在更新資料...');
                                loadData();
                            }, 400);
                        } else {
                            hideFlyProgressBar('取消失敗', 0);
                            alert('錯誤：' + response.error);
                        }
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('取消失敗', 0);
                        alert('錯誤：' + error.message);
                    })
                    .cancelTransferOrScrap(assetId);
            };

            // 處理回溯
            const handleRestore = (assetId) => {
                const confirmation = confirm(
                    `您確定要將此「已報廢」資產回溯為「在庫」狀態嗎？\n\n` +
                    `財產編號：${assetId}\n\n` +
                    `注意：此操作會保留原報廢記錄並添加回溯標記。`
                );

                if (!confirmation) return;

                showFlyProgressBar('正在回溯資產狀態...');

                google.script.run
                    .withSuccessHandler(result => {
                        hideFlyProgressBar('回溯完成！', 300);

                        setTimeout(() => {
                            alert(result.message);
                            showFlyProgressBar('正在更新資料...');
                            loadData();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('回溯失敗', 0);
                        alert('錯誤：' + error.message);
                    })
                    .restoreFromScrap([assetId]);
            };

            if (!isReady) {
                return null;
            }

            return (
                <div className="page-shell max-w-[1600px] mx-auto">
                    <div className="page-hero mb-6">
                        {/* 左側：標題 */}
                        <div className="page-hero__text">
                            <h1 className="page-title">財產狀態查詢</h1>
                            <p className="page-subtitle">
                                {currentUserName && <span className="font-medium text-slate-700">{currentUserName}</span>}
                                {currentUserName && '，'}歡迎回來，今天是 {(() => {
                                    const now = new Date();
                                    const date = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                                    const hours = now.getHours();
                                    const minutes = now.getMinutes().toString().padStart(2, '0');
                                    const seconds = now.getSeconds().toString().padStart(2, '0');
                                    const period = hours >= 12 ? '下午' : '上午';
                                    const displayHours = hours % 12 || 12;
                                    return `${date} ${period} ${displayHours}:${minutes}`;
                                })()}
                            </p>
                        </div>

                        {/* 右側：視角切換 + 重新整理按鈕 + 載入狀態指示 */}
                        <div className="page-hero__actions">
                            {isAdmin && (
                                <div className="hero-status">
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold border ${
                                        isAdminView
                                            ? 'bg-amber-50 text-amber-700 border-amber-200'
                                            : 'bg-teal-50 text-teal-700 border-teal-200'
                                    }`}>
                                        {isAdminView ? '管理員檢視：全域模式' : '一般檢視：群組模式'}
                                    </span>
                                    <div className="flex items-center bg-white border border-slate-200 rounded-full p-1 shadow-sm">
                                        <button
                                            onClick={() => handleViewModeChange('user')}
                                            className={`px-3 py-1 text-sm rounded-full transition-colors ${
                                                viewMode === 'user'
                                                    ? 'bg-slate-800 text-white'
                                                    : 'text-slate-600 hover:bg-slate-100'
                                            }`}
                                            title="一般使用者視角"
                                        >
                                            一般
                                        </button>
                                        <button
                                            onClick={() => handleViewModeChange('admin')}
                                            className={`px-3 py-1 text-sm rounded-full transition-colors ${
                                                viewMode === 'admin'
                                                    ? 'bg-slate-800 text-white'
                                                    : 'text-slate-600 hover:bg-slate-100'
                                            }`}
                                            title="管理者視角"
                                        >
                                            管理者
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="hero-actions">
                                {/* 載入狀態文字 */}
                                {isLoadingCards && (
                                    <span className="hero-loading">
                                        <i className="fas fa-spinner fa-spin text-blue-500"></i>
                                        正在載入統計數據...
                                    </span>
                                )}

                                {/* 盤點管理按鈕 */}
                                {isAdminView && (
                                    <button
                                        id="btn-inventory-mgmt"
                                        onClick={() => setShowInventoryMgmtModal(true)}
                                        className="hero-btn hero-btn--ghost"
                                        title="盤點管理"
                                    >
                                        <i className="fa-solid fa-clipboard-list text-slate-500"></i>
                                        <span className="hidden sm:inline">盤點管理</span>
                                    </button>
                                )}

                                {/* 新增資產按鈕 */}
                                <button
                                    onClick={() => setShowAddAssetModal(true)}
                                    className="hero-btn hero-btn--primary"
                                    title="新增財產/物品"
                                >
                                    <i className="fas fa-plus"></i>
                                    <span className="hidden sm:inline">新增資產</span>
                                </button>

                                {/* 重新整理按鈕 */}
                                <button
                                    onClick={handleRefreshCards}
                                    disabled={isLoadingCards}
                                    className="hero-refresh bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed transition-all shadow-sm flex items-center justify-center group"
                                    title="重新整理統計數據"
                                    aria-label="重新整理"
                                >
                                    <i className={`fas fa-sync-alt text-lg transition-transform ${isLoadingCards ? 'animate-spin' : 'group-hover:rotate-180'}`}></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <DashboardCards counts={cardCounts} onClick={handleCardClick} isLoading={isLoadingCards} />

                    {/* ✨ 新增：盤點進度監控儀表板 */}
                    <InventoryDashboardCard 
                        isAdminView={isAdminView}
                        currentUserEmail={currentUserEmail}
                        currentUserGroup={currentUserGroup}
                        inventorySessions={inventorySessions}
                        onRefresh={() => {
                            refreshCardData();
                            loadPendingInventoryAssignments(viewMode === 'user');
                        }} 
                    />

                    <FilterSection
                        filters={filters}
                        onFilterChange={handleFilterChange}
                        isAdmin={isAdminView}
                        allAssets={allAssets}
                    />

                    {/* 掃描區域 - 供 Scanner 模組使用 */}
                    <div id="Scanner_zone" className="scanner-zone mb-6" style={{ display: 'none' }}></div>

                    {/* 批次操作按鈕卡片 */}
                    <BatchActionButtons
                        onBatchTransfer={handleBatchTransfer}
                        onBatchLending={handleBatchLending}
                        onBatchScrap={handleBatchScrap}
                        hasPendingInventory={cardCounts.inventory > 0}
                        onBatchInventory={handleBatchInventory}
                    />

                    {duplicateInfo.duplicateCount > 0 && (
                        <AlertBanner
                            count={duplicateInfo.duplicateCount}
                            onClick={() => window.openDuplicateAssetsModal()}
                        />
                    )}

                    <AssetTable
                        assets={filteredAssets}
                        isAdmin={isAdminView}
                        currentUserEmail={currentUserEmail}
                        isInventoryTaskOnly={isInventoryTaskOnly}
                        onCancel={handleCancel}
                        onRestore={handleRestore}
                        onOpenTransferModal={handleOpenTransferModal}
                        onOpenLendingModal={handleOpenLendingModal}
                        onOpenScrapModal={handleOpenScrapModal}
                        onOpenEditModal={handleOpenEditModal}
                        onOpenStatusDetail={handleOpenStatusDetail}
                        isAssetPendingInventory={isAssetPendingInventory}
                        onOpenInventoryModal={handleOpenInventoryModal}
                        selectedAssetIds={selectedAssetIds}
                        onAssetSelect={handleAssetSelect}
                        onSelectAll={handleSelectAll}
                    />

                    {statusDetailState && (
                        <StatusDetailModal
                            state={statusDetailState}
                            onClose={handleCloseStatusDetail}
                        />
                    )}

                    {activeModal === 'transferring' && (
                        <TransferringModal
                            assets={transferringAssets}
                            isLoading={isLoadingTransferring}
                            onClose={() => {
                                setActiveModal(null);
                            }}
                            onCancelSuccess={() => {
                                setActiveModal(null);
                                // 刷新卡片數據和資產表格
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'lent' && (
                        <LentAssetsModal
                            lentAssetsDetails={lentAssetsDetails}
                            isLoading={isLoadingLentDetails}
                            onClose={() => {
                                setActiveModal(null);
                            }}
                            onReturnSuccess={() => {
                                setActiveModal(null);
                                // 刷新卡片數據和資產表格
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'scrapPrint' && (
                        <ScrapPrintModal
                            details={scrapPendingDetails}
                            isLoading={isLoadingScrapDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'transferPrint' && (
                        <TransferPrintModal
                            details={transferPendingDetails}
                            isLoading={isLoadingTransferDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'inventoryPending' && (
                      <PendingInventoryModal
                        pendingItems={pendingInventoryItems}
                        isAdmin={isAdminView}
                        isLoading={isLoadingPendingInventory}
                        error={pendingInventoryError}
                        onClose={() => {
                          setActiveModal(null);
                          setPendingInventoryError('');
                          setIsLoadingPendingInventory(false);
                        }}
                      />
                    )}

                    {/* 快速操作 Modal */}
                    {quickActionModalType === 'transfer' && (
                        <QuickTransferModal
                            asset={selectedAsset}
                            transferOptions={transferOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'lending' && (
                        <QuickLendingModal
                            asset={selectedAsset}
                            lendingOptions={lendingOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'scrap' && (
                        <QuickScrapModal
                            asset={selectedAsset}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {/* 批次操作 Modal */}
                    {batchModalType === 'transfer' && (
                        <BatchTransferModal
                            transferOptions={transferOptions}
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'lending' && (
                        <BatchLendingModal
                            lendingOptions={lendingOptions}
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'scrap' && (
                        <BatchScrapModal
                            allAssets={allAssets}
                            selectedAssetIds={batchActionAssetIds}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {/* 新增資產 Modal */}
                    {showAddAssetModal && (
                        <AddAssetModal
                            onClose={() => setShowAddAssetModal(false)}
                            onSuccess={handleAddAssetSuccess}
                        />
                    )}

                    {/* 盤點管理 Modal */}
                    {showInventoryMgmtModal && (
                        <InventoryManagementModal
                            isAdminView={isAdminView}
                            onClose={() => setShowInventoryMgmtModal(false)}
                        />
                    )}

                    {/* 編輯資產 Modal（僅管理員）*/}
                    {showEditAssetModal && editingAsset && (
                        <EditAssetModal
                            asset={editingAsset}
                            onClose={() => {
                                setShowEditAssetModal(false);
                                setEditingAsset(null);
                            }}
                            onSuccess={handleEditAssetSuccess}
                        />
                    )}

                    {/* 單筆盤點 Modal */}
                    {showInventoryModal && inventoryModalAsset && (
                        <InventoryConfirmModal
                            asset={inventoryModalAsset}
                            isBatch={false}
                            sessionId={currentInventorySessionId}
                            availableSessions={inventoryModalSessions}
                            defaultSessionId={inventoryModalSessionId}
                            isAdmin={isAdminView}
                            onClose={() => {
                                setShowInventoryModal(false);
                                setInventoryModalAsset(null);
                                setInventoryModalSessions([]);
                                setInventoryModalSessionId('');
                            }}
                            onSuccess={handleInventorySuccess}
                        />
                    )}

                    {/* 批次盤點 Modal */}
                    {showBatchInventoryModal && selectedInventoryAssetIds.length > 0 && (
                        <InventoryConfirmModal
                            assetIds={selectedInventoryAssetIds}
                            isBatch={true}
                            sessionId={batchInventorySessionId || currentInventorySessionId}
                            isAdmin={isAdminView}
                            onClose={() => {
                                setShowBatchInventoryModal(false);
                                setSelectedInventoryAssetIds([]);
                                setBatchInventorySessionId('');
                            }}
                            onSuccess={handleInventorySuccess}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('react-root')).render(<App />);
    </script>
</body>
</html>
