<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>

    <div id="main-content">
        <h4>財產狀態查詢</h4>
        
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="status-filter">依狀態篩選：</label>
                <select id="status-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="category-filter">依財產類別篩選：</label>
                <select id="category-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div id="leader-filter-container" class="form-group col-md-3" style="display: none;">
                <label for="leader-filter">依保管人篩選：</label>
                <select id="leader-filter" class="form-control">
                    <option value="">-- 顯示全部 --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="search-box">關鍵字搜尋：</label>
                <input type="text" id="search-box" class="form-control" placeholder="搜尋產編、名稱、保管人...">
            </div>
        </div>

        <div id="table-container" class="table-container" style="display:none;">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th>財產編號</th>
                        <th>財產名稱</th>
                        <th>使用者</th>
                        <th>保管人</th>
                        <th>保管位置</th>
                        <th>財產類別</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="asset-list">
                </tbody>
            </table>
        </div>
        <div id="status-message"></div>
    </div>

    <script>
        let allAssets = [];
        let isAdmin = false;
        let currentUserEmail = '';
        let webAppUrl = ''; // ✨ 新增：儲存 Web App 的基礎 URL

        document.addEventListener("DOMContentLoaded", () => {
            showLoading(true, '正在載入財產狀態資料...');
            google.script.run.withSuccessHandler(url => {
                webAppUrl = url; // ✨ 獲取 URL
                // 確保先取得 URL 再載入頁面資料
                google.script.run
                    .withSuccessHandler(populatePage)
                    .withFailureHandler(showError)
                    .getUserStateData();
            }).getAppUrl();
        });

        function populatePage(response) {
            if (response.error) {
                showError({ message: response.error });
                return;
            }

            isAdmin = response.isAdmin;
            allAssets = response.assets;
            currentUserEmail = response.userEmail; // ✨ 儲存當前使用者 Email

            populateFilters(allAssets);

            if (isAdmin) {
                document.getElementById('leader-filter-container').style.display = 'block';
            }

            document.getElementById('status-filter').addEventListener('change', filterAndRender);
            document.getElementById('category-filter').addEventListener('change', filterAndRender);
            document.getElementById('leader-filter').addEventListener('change', filterAndRender);
            document.getElementById('search-box').addEventListener('input', filterAndRender);

            filterAndRender(); // 初始渲染
            showLoading(false);
            document.getElementById('table-container').style.display = 'block';
        }

        function populateFilters(assets) {
            const statusSet = new Set();
            const categorySet = new Set();
            const leaderSet = new Set();
            assets.forEach(asset => {
                statusSet.add(asset.status);
                categorySet.add(asset.category);
                if (isAdmin) leaderSet.add(asset.leader);
            });

            const statusFilter = document.getElementById('status-filter');
            statusFilter.innerHTML = '<option value="">-- 顯示全部 --</option>'; // 清空舊選項
            statusSet.forEach(status => {
                if(status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                }
            });

            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">-- 顯示全部 --</option>'; // 清空舊選項
            categorySet.forEach(category => {
                if(category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });

            if (isAdmin) {
                const leaderFilter = document.getElementById('leader-filter');
                leaderFilter.innerHTML = '<option value="">-- 顯示全部 --</option>'; // 清空舊選項
                leaderSet.forEach(leader => {
                    if(leader) {
                        const option = document.createElement('option');
                        option.value = leader;
                        option.textContent = leader;
                        leaderFilter.appendChild(option);
                    }
                });
            }
        }

        function filterAndRender() {
            const statusFilterValue = document.getElementById('status-filter').value;
            const categoryFilterValue = document.getElementById('category-filter').value;
            const leaderFilterValue = isAdmin ? document.getElementById('leader-filter').value : '';
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            const filteredAssets = allAssets.filter(asset => {
                const statusMatch = !statusFilterValue || asset.status === statusFilterValue;
                const categoryMatch = !categoryFilterValue || asset.category === categoryFilterValue;
                const leaderMatch = !leaderFilterValue || asset.leader === leaderFilterValue;
                const searchMatch = !searchValue || 
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.leader.toUpperCase().includes(searchValue);
                return statusMatch && categoryMatch && leaderMatch && searchMatch;
            });

            renderTable(filteredAssets);
        }

        function renderTable(assets) {
            const listBody = document.getElementById('asset-list');
            listBody.innerHTML = '';

            if (!assets || assets.length === 0) {
                listBody.innerHTML = '<tr><td colspan="8" class="text-center">沒有符合條件的資料。</td></tr>';
                return;
            }

            const statusColors = {
                '在庫': 'badge-success',
                '出借中': 'badge-warning',
                '報廢中': 'badge-danger',
                '已報廢': 'badge-secondary',
                '轉移中': 'badge-primary',
                '待接收': 'badge-primary'
            };

            assets.forEach(asset => {
                const row = document.createElement('tr');
                const statusColor = statusColors[asset.status] || 'badge-info';
                
                let actionHtml = '';
                const canCancel = isAdmin || currentUserEmail === asset.leaderEmail || currentUserEmail === asset.userEmail;
                // 支援「待接收」與「轉移中」(舊資料相容)
                if (canCancel && (asset.status === '待接收' || asset.status === '轉移中' || asset.status === '報廢中')) {
                    actionHtml = `<button class="btn btn-sm btn-danger" onclick="promptCancel('${asset.assetId}', '${asset.status}')">取消</button>`;
                }

                row.innerHTML = `
                    <td>${asset.assetId}</td>
                    <td>${asset.assetName}</td>
                    <td>${asset.userName}</td>
                    <td>${asset.leader}</td>
                    <td>${asset.location}</td>
                    <td>${asset.category}</td>
                    <td><span class="badge ${statusColor}">${asset.status}</span></td>
                    <td>${actionHtml}</td>
                `;
                listBody.appendChild(row);
            });
        }

        // ✨ 新增：取消按鈕的處理函式
        function promptCancel(assetId, status) {
            const confirmation = confirm(`您確定要取消這筆 [${status}] 狀態的申請嗎？\n\n財產編號：${assetId}\n\n此操作將會把財產狀態恢復為「在庫」。`);
            if (confirmation) {
                showLoading(true, '正在取消申請...');
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            // 原地更新資料，避免跨域重載問題
                            alert('申請已成功取消。正在更新資料...');
                            google.script.run
                                .withSuccessHandler(populatePage)
                                .withFailureHandler(showError)
                                .getUserStateData();
                        } else {
                            showLoading(false);
                            showError({ message: response.error });
                        }
                    })
                    .withFailureHandler(showError)
                    .cancelTransferOrScrap(assetId);
            }
        }

        function showLoading(isLoading, statusText = '正在載入資料...') {
            if (isLoading) {
                showFlyProgressBar(statusText);
                document.getElementById('table-container').style.display = 'none';
            } else {
                hideFlyProgressBar('資料載入完成！', 300);
                document.getElementById('table-container').style.display = 'block';
            }
        }

        function showError(error) {
            showLoading(false);
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = '錯誤：' + error.message;
        }
    </script>
</body>
</html>
