<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Bootstrap CSS (åƒ…ç”¨æ–¼ Modal) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* é…åˆ shared-nav å´é‚Šæ¬„ */
        .duplicate-group-row {
            background-color: #fff7e6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>
    <?!= include('toast_progress'); ?>
    <?!= include('batch_processing_list'); ?>
    <?!= include('selectbyqr'); ?>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div id="react-root"></div>

    <!-- Bootstrap Modals (ä¿ç•™ç¾æœ‰çµæ§‹) -->
    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">é‡è¤‡ç”¢ç·¨æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th>è²¡ç”¢åç¨±</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>ä¿ç®¡äºº</th>
                                    <th>ä¿ç®¡ä½ç½®</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingApprovalModal" tabindex="-1" role="dialog" aria-labelledby="pendingApprovalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pendingApprovalTitle">å¾…æ¥æ”¶è³‡ç”¢æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row mb-2">
                        <div class="form-group col-md-5">
                            <label for="pending-location-filter">ä¾åŸä¿ç®¡åœ°é»ç¯©é¸</label>
                            <select id="pending-location-filter" class="form-control">
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-7">
                            <label for="pending-search-box">é—œéµå­—æœå°‹ (ç”¢ç·¨/ç”¢å/åŸä¿ç®¡äºº)</label>
                            <input type="text" id="pending-search-box" class="form-control" placeholder="è¼¸å…¥é—œéµå­—">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 4%;"><input type="checkbox" id="pending-select-all"></th>
                                    <th style="width: 10%;">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th style="width: 11%;">è²¡ç”¢åç¨±</th>
                                    <th style="width: 12%;">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th style="width: 14%;">ä¿ç®¡äººè®Šæ›´</th>
                                    <th style="width: 14%;">ä½¿ç”¨äººè®Šæ›´</th>
                                    <th style="width: 13%;">åœ°é»è®Šæ›´</th>
                                    <th style="width: 11%;">è½‰ç§»é¡å‹</th>
                                    <th style="width: 11%;">ç”³è«‹æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="pending-approval-list"></tbody>
                        </table>
                    </div>
                    <div id="pending-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="submitPendingRejection()">æ‹’çµ•æ‰€é¸</button>
                    <button type="button" class="btn btn-success" onclick="submitPendingApproval()">æ¥å—æ‰€é¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨åŸŸå‡½æ•¸æ©‹æ¥ jQuery Modal -->
    <script>
        // å…¨åŸŸè®Šæ•¸ä¾› React èˆ‡ jQuery å…±äº«
        window.pendingApprovals = [];
        window.filteredPendingApprovals = [];
        window.pendingCurrentPage = 1;
        window.pendingRowsPerPage = 50;
        window.duplicateGroups = [];

        window.openPendingApprovalModal = () => {
            if (!window.pendingApprovals || window.pendingApprovals.length === 0) return;

            if (!document.getElementById('pendingApprovalModal').dataset.initialized) {
                document.getElementById('pending-location-filter').addEventListener('change', filterPendingApprovals);
                document.getElementById('pending-search-box').addEventListener('input', filterPendingApprovals);
                document.getElementById('pending-select-all').addEventListener('change', (event) => {
                    document.querySelectorAll('.pending-approval-checkbox').forEach(cb => {
                        cb.checked = event.target.checked;
                    });
                });
                document.getElementById('pendingApprovalModal').dataset.initialized = 'true';
            }

            populatePendingFilters();
            filterPendingApprovals();
            $('#pendingApprovalModal').modal('show');
        };

        window.openDuplicateAssetsModal = () => {
            if (!window.duplicateGroups || window.duplicateGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        };

        function populatePendingFilters() {
            const locationFilter = document.getElementById('pending-location-filter');
            locationFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            const uniqueLocations = [...new Set(window.pendingApprovals.map(item => item.oldLocation))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilter.appendChild(option);
            });
        }

        function filterPendingApprovals() {
            const locationFilter = document.getElementById('pending-location-filter').value.toUpperCase();
            const searchFilter = document.getElementById('pending-search-box').value.toUpperCase();

            window.filteredPendingApprovals = window.pendingApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation && item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    (item.oldKeeper && item.oldKeeper.toUpperCase().includes(searchFilter));
                return locationMatch && searchMatch;
            });

            window.pendingCurrentPage = 1;
            renderPendingPage(window.pendingCurrentPage);
        }

        function renderPendingPage(page) {
            window.pendingCurrentPage = page;
            const listBody = document.getElementById('pending-approval-list');
            const pagination = document.getElementById('pending-pagination');
            listBody.innerHTML = '';

            if (window.filteredPendingApprovals.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚';
                row.appendChild(cell);
                listBody.appendChild(row);
                pagination.textContent = '';
                return;
            }

            const start = (page - 1) * window.pendingRowsPerPage;
            const end = start + window.pendingRowsPerPage;
            const items = window.filteredPendingApprovals.slice(start, end);

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const row = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pending-approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                const transferType = item.transferType || 'åœ°é»';
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                } else if (transferType.includes('ä¿ç®¡äºº')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                } else if (transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = 'åœ°é»';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                fragment.appendChild(row);
            });

            listBody.appendChild(fragment);
            renderPendingPagination();
            document.getElementById('pending-select-all').checked = false;
        }

        function renderPendingPagination() {
            const pagination = document.getElementById('pending-pagination');
            const totalPages = Math.ceil(window.filteredPendingApprovals.length / window.pendingRowsPerPage);

            if (window.filteredPendingApprovals.length === 0) {
                pagination.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                pagination.innerHTML = `<span class="text-muted">å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™</span>`;
                return;
            }

            const info = document.createElement('span');
            info.className = 'text-muted';
            info.textContent = `å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™ï¼Œç¬¬ ${window.pendingCurrentPage} / ${totalPages} é `;

            const nav = document.createElement('ul');
            nav.className = 'pagination mb-0';

            const prev = document.createElement('li');
            prev.className = `page-item ${window.pendingCurrentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.textContent = 'ä¸Šä¸€é ';
            prevLink.addEventListener('click', () => {
                if (window.pendingCurrentPage > 1) renderPendingPage(window.pendingCurrentPage - 1);
            });
            prev.appendChild(prevLink);

            const next = document.createElement('li');
            next.className = `page-item ${window.pendingCurrentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.textContent = 'ä¸‹ä¸€é ';
            nextLink.addEventListener('click', () => {
                if (window.pendingCurrentPage < totalPages) renderPendingPage(window.pendingCurrentPage + 1);
            });
            next.appendChild(nextLink);

            nav.appendChild(prev);
            nav.appendChild(next);

            pagination.innerHTML = '';
            pagination.appendChild(info);
            pagination.appendChild(nav);
        }

        function submitPendingApproval() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ¥æ”¶ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchApproval(selected);
        }

        function submitPendingRejection() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦æ‹’çµ•æ‰€é¸çš„ ${selected.length} ç­†å¾…æ¥æ”¶è³‡ç”¢å—ï¼Ÿ`)) {
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ‹’çµ•ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchRejection(selected);
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = window.duplicateGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `å…± ${totalGroups} çµ„ï¼Œ${totalRows} ç­†è³‡ç”¢`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `ç”¢ç·¨ï¼š${group.assetId || '(ç©ºç™½)'}ï¼ˆ${group.items.length} ç­†ï¼‰`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.leader,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }
    </script>

    <!-- React æ‡‰ç”¨ -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // Icons (åƒè€ƒ onepage_example.html)
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const SearchIcon = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;

        // LoadingCard çµ„ä»¶ - å¡ç‰‡è¼‰å…¥ä½”ä½ç¬¦ï¼ˆæ°´å¹³é•·æ–¹å½¢æ¨£å¼ï¼‰
        const LoadingCard = () => (
            <div className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm">
                <div className="flex items-center gap-3">
                    <div className="flex flex-col items-center gap-1">
                        <div className="w-5 h-5 bg-slate-200 rounded animate-pulse"></div>
                        <div className="w-1.5 h-6 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="h-4 bg-slate-200 rounded w-16 mb-1 animate-pulse"></div>
                        <div className="h-3 bg-slate-100 rounded w-24 animate-pulse"></div>
                    </div>
                    <div className="w-8 h-7 bg-slate-200 rounded animate-pulse"></div>
                </div>
            </div>
        );

        // DashboardCards çµ„ä»¶
        const DashboardCards = ({ counts, onClick, isLoading }) => {
            // è¼‰å…¥ç‹€æ…‹æ¸²æŸ“
            if (isLoading) {
                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                        {[1, 2, 3, 4, 5].map(i => <LoadingCard key={i} />)}
                    </div>
                );
            }

            const cards = [
                {
                    id: 'pending',
                    label: 'å¾…æ¥æ”¶',
                    count: counts.pending,
                    color: 'bg-blue-500',
                    icon: 'ğŸ“¥',
                    description: 'éœ€è¦æ‚¨ç¢ºèªæ¥æ”¶çš„è³‡ç”¢'
                },
                {
                    id: 'lent',
                    label: 'å‡ºå€Ÿä¸­',
                    count: counts.lent,
                    color: 'bg-green-500',
                    icon: 'ğŸ“¤',
                    description: 'ç›®å‰å‡ºå€Ÿçš„è³‡ç”¢'
                },
                {
                    id: 'scrapPending',
                    label: 'å¾…åˆ—å°å ±å»¢ç”³è«‹å–®',
                    count: counts.scrapPending,
                    color: 'bg-orange-500',
                    icon: 'ğŸ—‘ï¸',
                    description: 'å ±å»¢ä¸­çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'transferPending',
                    label: 'å¾…åˆ—å°è½‰ç§»ç”³è«‹å–®',
                    count: counts.transferPending,
                    color: 'bg-purple-500',
                    icon: 'ğŸ”„',
                    description: 'å·²è¢«æ¥æ”¶çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°è½‰ç§»ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'inventory',
                    label: 'å¾…ç›¤é»',
                    count: counts.inventory,
                    color: 'bg-red-500',
                    icon: 'ğŸ“‹',
                    description: 'éœ€è¦æ‚¨å®Œæˆçš„ç›¤é»ä»»å‹™'
                }
            ];

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                    {cards.map(card => (
                        <button
                            key={card.id}
                            onClick={() => onClick(card.id)}
                            className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-slate-300 transition-all cursor-pointer text-left group"
                        >
                            <div className="flex items-center gap-3">
                                {/* å·¦å´ï¼šåœ–æ¨™èˆ‡å½©è‰²æŒ‡ç¤ºæ¢ */}
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-xl">{card.icon}</span>
                                    <div className={`w-1.5 h-6 rounded-full ${card.color} opacity-80`}></div>
                                </div>
                                {/* ä¸­é–“ï¼šæ¨™é¡Œèˆ‡æè¿° */}
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-slate-600 group-hover:text-slate-800 transition-colors">{card.label}</p>
                                    <p className="text-xs text-slate-400 whitespace-pre-wrap" title={card.description}>{card.description}</p>
                                </div>
                                {/* å³å´ï¼šæ•¸å­— */}
                                <div className="text-2xl font-bold text-slate-800 tabular-nums">
                                    {card.count}
                                </div>
                            </div>
                        </button>
                    ))}
                </div>
            );
        };

        // FilterSection çµ„ä»¶
        const FilterSection = ({ filters, onFilterChange, isAdmin, allAssets }) => {
            // âœ¨ Debounce æ©Ÿåˆ¶ï¼šæœ¬åœ°æœå°‹ç‹€æ…‹ï¼ˆå³æ™‚æ›´æ–°è¼¸å…¥æ¡†ï¼‰
            const [localSearch, setLocalSearch] = useState(filters.search);
            const debounceTimerRef = useRef(null);

            // âœ¨ ç•¶å¤–éƒ¨ filters.search è®ŠåŒ–æ™‚åŒæ­¥åˆ°æœ¬åœ°ï¼ˆä¾‹å¦‚ Scanner æ¸…ç©ºæœå°‹æ¡†ï¼‰
            useEffect(() => {
                setLocalSearch(filters.search);
            }, [filters.search]);

            // âœ¨ Debounce æœå°‹è™•ç†å‡½æ•¸
            const handleSearchChange = useCallback((value) => {
                setLocalSearch(value);  // ç«‹å³æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º

                // æ¸…é™¤å‰ä¸€å€‹ timer
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }

                // 180ms å¾Œæ‰è§¸ç™¼å¯¦éš›ç¯©é¸
                debounceTimerRef.current = setTimeout(() => {
                    onFilterChange('search', value);
                }, 180);
            }, [onFilterChange]);

            // âœ¨ æ¸…ç† timer
            useEffect(() => {
                return () => {
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                    }
                };
            }, []);

            // âœ¨ æš´éœ²æ¸…ç©ºæœå°‹æ¡†å‡½æ•¸ä¾› Scanner æ¨¡çµ„ä½¿ç”¨
            useEffect(() => {
                window.clearSearchBox = () => {
                    setLocalSearch('');
                    onFilterChange('search', '');
                };
                return () => {
                    delete window.clearSearchBox;
                };
            }, [onFilterChange]);

            const statusOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.status))].filter(Boolean).sort()
            , [allAssets]);

            const categoryOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.category))].filter(Boolean).sort()
            , [allAssets]);

            const leaderOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.leader))].filter(Boolean).sort()
            , [allAssets]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ç‹€æ…‹ç¯©é¸</label>
                            <select
                                value={filters.status}
                                onChange={(e) => onFilterChange('status', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {statusOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸</label>
                            <select
                                value={filters.category}
                                onChange={(e) => onFilterChange('category', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {categoryOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        {isAdmin && (
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ä¿ç®¡äººç¯©é¸</label>
                                <select
                                    value={filters.leader}
                                    onChange={(e) => onFilterChange('leader', e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                    {leaderOptions.map(opt => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">é—œéµå­—æœå°‹</label>
                            <div className="relative flex">
                                <div className="relative flex-1">
                                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                    <input
                                        id="search-box"
                                        type="text"
                                        value={localSearch}
                                        onChange={(e) => handleSearchChange(e.target.value)}
                                        placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€ä¿ç®¡äºº... (å¯æƒææ¢ç¢¼æŒ‰ Enter)"
                                        className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <button
                                    type="button"
                                    onClick={() => window.Scanner_toggle && window.Scanner_toggle()}
                                    className="px-3 py-2 bg-slate-100 border border-l-0 border-slate-200 rounded-r-lg hover:bg-slate-200 transition-colors"
                                    title="é–‹å•Ÿæ¢ç¢¼æƒæå™¨"
                                >
                                    <i className="fa-solid fa-barcode text-slate-600"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // AlertBanner çµ„ä»¶
        const AlertBanner = ({ count, onClick }) => (
            <div
                className="bg-yellow-50 border-l-4 border-yellow-400 py-2 px-4 mb-6 cursor-pointer hover:bg-yellow-100 transition-colors"
                onClick={onClick}
            >
                <div className="flex items-center">
                    <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span className="text-yellow-800">
                        åµæ¸¬åˆ° {count} ç­†é‡è¤‡ç”¢ç·¨ã€‚
                        <span className="text-blue-600 ml-2 underline">é»æ“ŠæŸ¥çœ‹è©³æƒ…</span>
                    </span>
                </div>
            </div>
        );

        // BatchActionButtons çµ„ä»¶ - æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•å¡ç‰‡
        const BatchActionButtons = ({ onBatchTransfer, onBatchLending, onBatchScrap }) => {
            const [batchCount, setBatchCount] = useState(0);

            useEffect(() => {
                // ç›£è½ BatchList è®ŠåŒ–
                const updateCount = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        setBatchCount(window.BatchList_getItems().length);
                    }
                };

                // åˆå§‹æ›´æ–°
                updateCount();

                // å®šæœŸæ›´æ–°ï¼ˆæ¯ 500msï¼‰
                const interval = setInterval(updateCount, 500);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className="text-sm text-slate-600">
                                <i className="fa-solid fa-cart-shopping text-blue-500 mr-2"></i>
                                å·²é¸å– <span className="font-bold text-blue-600">{batchCount}</span> é …è³‡ç”¢
                            </div>
                            {batchCount > 0 && (
                                <button
                                    onClick={() => window.BatchList_toggleSidebar && window.BatchList_toggleSidebar()}
                                    className="text-xs text-blue-500 hover:text-blue-700 underline"
                                >
                                    æŸ¥çœ‹æ¸…å–®
                                </button>
                            )}
                        </div>
                        <div className="flex gap-2 flex-wrap">
                            <button
                                onClick={onBatchTransfer}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-right-left"></i> æ‰¹æ¬¡è½‰ç§»
                            </button>
                            <button
                                onClick={onBatchLending}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-solid fa-hand-holding-hand"></i> æ‰¹æ¬¡å‡ºå€Ÿ
                            </button>
                            <button
                                onClick={onBatchScrap}
                                disabled={batchCount === 0}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 text-sm"
                            >
                                <i className="fa-regular fa-trash-can"></i> æ‰¹æ¬¡å ±å»¢
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // AssetTable çµ„ä»¶
        const AssetTable = ({ assets, isAdmin, currentUserEmail, onCancel, onRestore, onOpenTransferModal, onOpenLendingModal, onOpenScrapModal, selectedAssetIds = [], onAssetSelect, onSelectAll }) => {
            const statusColors = {
                'åœ¨åº«': 'bg-green-50 text-green-700 border-green-200',
                'å‡ºå€Ÿä¸­': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                'å ±å»¢ä¸­': 'bg-red-50 text-red-700 border-red-200',
                'å·²å ±å»¢': 'bg-gray-50 text-gray-700 border-gray-200',
                'è½‰ç§»ä¸­': 'bg-blue-50 text-blue-700 border-blue-200',
                'å¾…æ¥æ”¶': 'bg-purple-50 text-purple-700 border-purple-200'
            };

            // âœ¨ åˆ†é è¨­å®š
            const ROWS_PER_PAGE = 500;
            const [currentPage, setCurrentPage] = useState(1);

            // âœ¨ ç•¶ assets è®ŠåŒ–æ™‚ï¼ˆç¯©é¸æ¢ä»¶æ”¹è®Šï¼‰ï¼Œé‡ç½®é ç¢¼
            useEffect(() => {
                setCurrentPage(1);
            }, [assets]);

            // âœ¨ è¨ˆç®—åˆ†é è³‡æ–™
            const totalPages = useMemo(() => {
                return Math.max(1, Math.ceil((assets?.length || 0) / ROWS_PER_PAGE));
            }, [assets]);

            const paginatedAssets = useMemo(() => {
                if (!assets) return [];
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                return assets.slice(start, end);
            }, [assets, currentPage]);

            // è¨ˆç®—å¯é¸è³‡ç”¢ï¼ˆåƒ…åœ¨åº«ï¼‰
            const selectableAssets = useMemo(() => {
                return assets ? assets.filter(a => a.status === 'åœ¨åº«') : [];
            }, [assets]);

            // è¨ˆç®—å…¨é¸ç‹€æ…‹
            const isAllSelected = selectableAssets.length > 0 &&
                selectableAssets.every(a => selectedAssetIds.includes(a.assetId));
            const isPartialSelected = selectableAssets.some(a => selectedAssetIds.includes(a.assetId)) && !isAllSelected;

            if (!assets || assets.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                        <p className="text-slate-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    {/* âœ¨ åˆ†é æ§åˆ¶å™¨ - ä½æ–¼è¡¨æ ¼ä¸Šæ–¹ */}
                    <div className="flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-slate-200">
                        <span className="text-sm text-slate-600">
                            ç¬¬ <span className="font-semibold text-blue-600">{currentPage}</span> / {totalPages} é ï¼ˆå…± <span className="font-semibold text-blue-600">{assets.length}</span> ç­†ï¼‰
                        </span>
                        {totalPages > 1 && (
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                    disabled={currentPage <= 1}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage <= 1
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    ä¸Šä¸€é 
                                </button>
                                <button
                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                    disabled={currentPage >= totalPages}
                                    className={`px-3 py-1 text-sm rounded border ${
                                        currentPage >= totalPages
                                            ? 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'
                                            : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                    }`}
                                >
                                    ä¸‹ä¸€é 
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm" id="asset-list">
                            <thead className="bg-slate-50 border-b border-slate-200 sticky top-0">
                                <tr>
                                    {/* å‹¾é¸æ¬„ä½ - å…¨é¸ checkbox */}
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-center w-10">
                                        <input
                                            type="checkbox"
                                            checked={isAllSelected}
                                            ref={(el) => { if (el) el.indeterminate = isPartialSelected; }}
                                            onChange={(e) => onSelectAll && onSelectAll(e.target.checked)}
                                            className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                            title={`å…¨é¸æ‰€æœ‰ã€Œåœ¨åº«ã€è³‡ç”¢ (${selectableAssets.length} ç­†)`}
                                        />
                                    </th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[160px] max-w-[160px]">è²¡ç”¢åç¨±</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 w-[180px] max-w-[180px]">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ä½¿ç”¨è€…</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ä¿ç®¡äºº</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 min-w-[100px]">ä¿ç®¡ä½ç½®</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢é¡åˆ¥</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 whitespace-nowrap">ç‹€æ…‹</th>
                                    <th className="px-2 py-3 font-semibold text-slate-600 text-left whitespace-nowrap min-w-[160px]">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {paginatedAssets.map((asset, index) => {
                                    const canCancel = isAdmin ||
                                                    currentUserEmail === asset.leaderEmail ||
                                                    currentUserEmail === asset.userEmail;
                                    const isSelectable = asset.status === 'åœ¨åº«';
                                    const isSelected = selectedAssetIds.includes(asset.assetId);

                                    return (
                                        <tr key={`${asset.assetId}-${index}`} className={`hover:bg-slate-50 transition-colors ${isSelected ? 'bg-blue-50' : ''}`}>
                                            {/* å‹¾é¸æ¬„ä½ */}
                                            <td className="px-2 py-3 text-center align-top">
                                                {isSelectable ? (
                                                    <input
                                                        type="checkbox"
                                                        className="asset-checkbox w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                        value={asset.assetId}
                                                        checked={isSelected}
                                                        onChange={() => onAssetSelect && onAssetSelect(asset.assetId)}
                                                    />
                                                ) : (
                                                    <span className="text-slate-300" title="åƒ…ã€Œåœ¨åº«ã€è³‡ç”¢å¯é¸å–">-</span>
                                                )}
                                            </td>
                                            <td className="px-2 py-3 font-mono text-slate-600 whitespace-nowrap align-top">{asset.assetId}</td>
                                            <td className="px-2 py-3 font-medium text-slate-800 align-top w-[160px] max-w-[160px]">
                                                <div className="line-clamp-2" title={asset.assetName}>{asset.assetName}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top w-[180px] max-w-[180px]">
                                                <div className="line-clamp-2 text-xs break-all" title={asset.modelBrand}>{asset.modelBrand || '-'}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.userName}</td>
                                            <td className="px-2 py-3 text-slate-600 whitespace-nowrap align-top">{asset.leader}</td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <div className="line-clamp-2" title={asset.location}>{asset.location}</div>
                                            </td>
                                            <td className="px-2 py-3 text-slate-600 align-top">
                                                <span className="bg-slate-100 px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    {asset.category}
                                                </span>
                                            </td>
                                            <td className="px-2 py-3 align-top">
                                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap ${statusColors[asset.status] || 'bg-slate-100 text-slate-700 border-slate-200'}`}>
                                                    {asset.status}
                                                </span>
                                            </td>
                                            <td className="px-2 py-3 text-left align-top whitespace-nowrap">
                                                {/* æ“ä½œæŒ‰éˆ•å€åŸŸ */}
                                                <div className="flex justify-start gap-2">
                                                    {/* åœ¨åº«è³‡ç”¢ï¼šé¡¯ç¤ºè½‰ç§»ã€å‡ºå€Ÿã€å ±å»¢æŒ‰éˆ• */}
                                                    {asset.status === 'åœ¨åº«' && (
                                                        <>
                                                            <button
                                                                onClick={() => onOpenTransferModal(asset)}
                                                                className="text-blue-600 hover:text-blue-800 transition-colors p-1"
                                                                title="è½‰ç§»"
                                                            >
                                                                <i className="fa-solid fa-right-left text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenLendingModal(asset)}
                                                                className="text-purple-600 hover:text-purple-800 transition-colors p-1"
                                                                title="å‡ºå€Ÿ"
                                                            >
                                                                <i className="fa-solid fa-hand-holding-hand text-lg"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => onOpenScrapModal(asset)}
                                                                className="text-red-600 hover:text-red-800 transition-colors p-1"
                                                                title="å ±å»¢"
                                                            >
                                                                <i className="fa-regular fa-trash-can text-lg"></i>
                                                            </button>
                                                        </>
                                                    )}

                                                    {/* å¾…æ¥æ”¶/è½‰ç§»ä¸­/å ±å»¢ä¸­ï¼šé¡¯ç¤ºå–æ¶ˆæŒ‰éˆ• */}
                                                    {canCancel && (asset.status === 'å¾…æ¥æ”¶' || asset.status === 'è½‰ç§»ä¸­' || asset.status === 'å ±å»¢ä¸­') && (
                                                        <button
                                                            onClick={() => onCancel(asset.assetId, asset.status)}
                                                            className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                                                        >
                                                            å–æ¶ˆ
                                                        </button>
                                                    )}

                                                    {/* å·²å ±å»¢ï¼šç®¡ç†å“¡å¯å›æº¯ */}
                                                    {isAdmin && asset.status === 'å·²å ±å»¢' && (
                                                        <button
                                                            onClick={() => onRestore(asset.assetId)}
                                                            className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm font-medium"
                                                        >
                                                            å›æº¯
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // React Modals
        const LentAssetsModal = ({ lentAssetsDetails, isLoading, onClose, onReturnSuccess }) => {
            const [selectedLendIds, setSelectedLendIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                location: '',
                startDate: '',
                endDate: '',
                overdueOnly: '',
                search: ''
            });

            // ç•¶ lentAssetsDetails æ”¹è®Šæ™‚ï¼Œé‡ç½®å‹¾é¸ç‹€æ…‹
            useEffect(() => {
                setSelectedLendIds([]);
                setSelectAll(false);
            }, [lentAssetsDetails]);

            // ç¯©é¸é‚è¼¯
            const filteredAssets = useMemo(() => {
                if (!lentAssetsDetails) return [];

                return lentAssetsDetails.filter(asset => {
                    // åœ°é»ç¯©é¸
                    const matchLocation = !filters.location || asset.lendingLocation === filters.location;

                    // æ—¥æœŸç¯„åœç¯©é¸
                    const returnDate = new Date(asset.expectedReturnDate);
                    const matchDateRange =
                        (!filters.startDate || returnDate >= new Date(filters.startDate)) &&
                        (!filters.endDate || returnDate <= new Date(filters.endDate));

                    // é€¾æœŸç‹€æ…‹ç¯©é¸
                    let matchOverdue = true;
                    if (filters.overdueOnly === 'overdue' || filters.overdueOnly === 'notOverdue') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const assetReturnDate = new Date(asset.expectedReturnDate);
                        assetReturnDate.setHours(0, 0, 0, 0);
                        const isOverdue = assetReturnDate < today;
                        matchOverdue = filters.overdueOnly === 'overdue' ? isOverdue : !isOverdue;
                    }

                    // é—œéµå­—æœå°‹
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.borrower.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.reason && asset.reason.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchLocation && matchDateRange && matchOverdue && matchSearch;
                });
            }, [lentAssetsDetails, filters]);

            // å–å¾—å”¯ä¸€åœ°é»åˆ—è¡¨ï¼ˆç”¨æ–¼ç¯©é¸ä¸‹æ‹‰é¸å–®ï¼‰
            const uniqueLocations = useMemo(() => {
                if (!lentAssetsDetails) return [];
                return [...new Set(lentAssetsDetails.map(a => a.lendingLocation).filter(Boolean))].sort();
            }, [lentAssetsDetails]);

            // è™•ç†å…¨é¸
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedLendIds(filteredAssets.map(asset => asset.lendId));
                } else {
                    setSelectedLendIds([]);
                }
            }, [filteredAssets]);

            // è™•ç†å–®å€‹å‹¾é¸
            const handleCheckboxChange = useCallback((lendId) => {
                setSelectedLendIds(prev => {
                    if (prev.includes(lendId)) {
                        const newSelected = prev.filter(id => id !== lendId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, lendId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // è™•ç†æ­¸é‚„æäº¤
            const handleSubmitReturn = useCallback(() => {
                if (selectedLendIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è¦æ­¸é‚„çš„é …ç›®ã€‚');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦æ­¸é‚„æ‰€é¸çš„ ${selectedLendIds.length} ç­†è³‡ç”¢å—ï¼Ÿ\n\nâš ï¸ è«‹ç¢ºèªæ­¤è³‡ç”¢å·²æ­¸é‚„è‡³åŸå­˜æ”¾åœ°é»ã€‚`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('æ­£åœ¨è™•ç†æ­¸é‚„ä½œæ¥­...');

                google.script.run
                    .withSuccessHandler(message => {
                        hideToastProgress('æ­¸é‚„å®Œæˆï¼', 300);
                        setTimeout(() => {
                            alert(message);
                            setIsSubmitting(false);
                            onReturnSuccess();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideToastProgress('æ­¸é‚„å¤±æ•—ï¼', 300);
                        setIsSubmitting(false);
                        alert('æ­¸é‚„å¤±æ•—ï¼š' + error.message);
                    })
                    .processBatchReturn(selectedLendIds);
            }, [selectedLendIds, onReturnSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* æ¨™é¡Œåˆ— */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800">å‡ºå€Ÿä¸­è³‡ç”¢ - æ­¸é‚„ä½œæ¥­</h3>
                            <button
                                onClick={onClose}
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // è¼‰å…¥ä¸­ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                    <p className="text-slate-500 font-medium">è¼‰å…¥å‡ºå€Ÿè³‡æ–™ä¸­...</p>
                                </div>
                            ) : !lentAssetsDetails || lentAssetsDetails.length === 0 ? (
                                // ç„¡è³‡æ–™ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">ç›®å‰æ²’æœ‰å‡ºå€Ÿä¸­çš„è³‡ç”¢ã€‚</p>
                                    <p className="text-slate-400 text-sm">æ‰€æœ‰è³‡ç”¢éƒ½å·²æ­¸é‚„å®Œç•¢ã€‚</p>
                                </div>
                            ) : (
                                <>
                                    {/* ç¯©é¸æ§åˆ¶å€ */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {/* åœ°é»ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">å‡ºå€Ÿå¾Œåœ°é»</label>
                                                <select
                                                    value={filters.location}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, location: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                                    {uniqueLocations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* æ—¥æœŸç¯„åœç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆèµ·ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.startDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆè¿„ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.endDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            {/* é€¾æœŸç‹€æ…‹ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é€¾æœŸç‹€æ…‹</label>
                                                <select
                                                    value={filters.overdueOnly}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, overdueOnly: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">å…¨éƒ¨</option>
                                                    <option value="overdue">å·²é€¾æœŸ</option>
                                                    <option value="notOverdue">æœªé€¾æœŸ</option>
                                                </select>
                                            </div>
                                        </div>

                                        {/* é—œéµå­—æœå°‹ */}
                                        <div className="mt-4">
                                            <label className="block text-xs font-medium text-slate-600 mb-1">é—œéµå­—æœå°‹ï¼ˆè²¡ç”¢ç·¨è™Ÿã€å€Ÿç”¨äººã€å‡ºå€Ÿäº‹ç”±ï¼‰</label>
                                            <input
                                                type="text"
                                                value={filters.search}
                                                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                placeholder="è¼¸å…¥é—œéµå­—æœå°‹..."
                                                className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                disabled={isSubmitting}
                                            />
                                        </div>

                                        {/* ç¯©é¸çµæœçµ±è¨ˆ */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            é¡¯ç¤º <span className="font-bold text-blue-600">{filteredAssets.length}</span> / {lentAssetsDetails.length} ç­†
                                        </div>
                                    </div>

                                    {/* è³‡æ–™è¡¨æ ¼ */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>å€Ÿç”¨äºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>é è¨ˆæ­¸é‚„æ—¥</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>å‡ºå€Ÿå¾Œåœ°é»</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '21%'}}>å‡ºå€Ÿäº‹ç”±</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        // åˆ¤æ–·æ˜¯å¦é€¾æœŸ
                                                        const today = new Date();
                                                        today.setHours(0, 0, 0, 0);
                                                        const returnDate = new Date(asset.expectedReturnDate);
                                                        returnDate.setHours(0, 0, 0, 0);
                                                        const isOverdue = returnDate < today;

                                                        return (
                                                            <tr key={`lent-${asset.lendId}-${index}`} className={`hover:bg-slate-50 transition-colors ${isOverdue ? 'bg-red-50' : ''}`}>
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedLendIds.includes(asset.lendId)}
                                                                        onChange={() => handleCheckboxChange(asset.lendId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-600">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.borrower}</td>
                                                                <td className={`px-3 py-3 ${isOverdue ? 'text-red-600 font-semibold' : 'text-slate-600'}`}>
                                                                    {asset.expectedReturnDate}
                                                                    {isOverdue && <i className="fas fa-exclamation-triangle ml-1"></i>}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lendingLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.reason}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* åº•éƒ¨æ“ä½œåˆ— */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <span>
                                        å·²é¸æ“‡ <span className="font-bold text-blue-600">{selectedLendIds.length}</span> / {filteredAssets.length} ç­†
                                    </span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors font-medium"
                                    disabled={isSubmitting}
                                >
                                    é—œé–‰
                                </button>
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <button
                                        onClick={handleSubmitReturn}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed font-medium shadow-sm"
                                        disabled={selectedLendIds.length === 0 || isSubmitting}
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin"></i>
                                                è™•ç†ä¸­...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-check"></i>
                                                ç¢ºèªæ­¸é‚„æ‰€é¸é …ç›®
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScrapPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½å ±è¡¨ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    `æ˜¯å¦è¦åœ¨åˆ—å°å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„ç‹€æ…‹ç‚ºã€Œå·²å ±å»¢ã€ï¼Ÿ\n\n` +
                                    `âš ï¸ é‡è¦æé†’\n` +
                                    'é¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= åˆ—å°å¾Œæ›´æ–°ç‹€æ…‹ï¼Œå°‡ ${result.assetIds.length} ç­†è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€ï¼ˆè²¡ç”¢å°‡æ¨™è¨˜ç‚ºå·²å ±å»¢ï¼Œç„¡æ³•å†æ¬¡åˆ—å°æ­¤ç”³è«‹ï¼‰\n` +
                                    `âŒ ã€å–æ¶ˆã€‘= åƒ…åˆ—å°å ±è¡¨ï¼Œä¸æ›´æ–°ç‹€æ…‹ï¼ˆéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰`
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†ç‹€æ…‹æœªæ›´æ–°ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processScrapConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createScrapDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-orange-800">åˆ—å°å ±å»¢ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-orange-600 hover:text-orange-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Category Selector */}
                        <div className="px-6 py-4 border-b bg-orange-50/50">
                            <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                            <label className="inline-flex items-center mr-6">
                                <input
                                    type="radio"
                                    name="scrapCategory"
                                    value="è²¡ç”¢"
                                    checked={selectedCategory === 'è²¡ç”¢'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>è²¡ç”¢</span>
                            </label>
                            <label className="inline-flex items-center">
                                <input
                                    type="radio"
                                    name="scrapCategory"
                                    value="ç‰©å“"
                                    checked={selectedCategory === 'ç‰©å“'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>ç‰©å“</span>
                            </label>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-16">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
                                        <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                    </div>
                                </div>
                            ) : currentAssets.length === 0 ? (
                                <div className="text-center py-16 text-slate-500">
                                    <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                    <p>ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„{selectedCategory}ã€‚</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-orange-50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="rounded"
                                                    />
                                                </th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">å ±å»¢æ—¥æœŸ</th>
                                                <th className="px-3 py-2 text-left">å ±å»¢åŸå› </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {currentAssets.map(asset => (
                                                <tr key={asset.assetId} className="border-b hover:bg-orange-50/30">
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedIds.includes(asset.assetId)}
                                                            onChange={() => handleSelectOne(asset.assetId)}
                                                            className="rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2">{asset.assetId}</td>
                                                    <td className="px-3 py-2">{asset.assetName}</td>
                                                    <td className="px-3 py-2">{asset.modelBrand}</td>
                                                    <td className="px-3 py-2">{asset.originalKeeper}</td>
                                                    <td className="px-3 py-2">{asset.originalUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.scrapDate || ''}</td>
                                                    <td className="px-3 py-2">{asset.scrapReason || ''}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-orange-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    disabled={isGenerating}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleGenerateDoc}
                                    disabled={isGenerating || selectedIds.length === 0}
                                    className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? (
                                        <>
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                            <span>ç”¢ç”Ÿä¸­...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-file-alt"></i>
                                            <span>ç”Ÿæˆå ±å»¢ç”³è«‹å–®</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TransferPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½è½‰ç§»è¨˜éŒ„ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    'â“ æ˜¯å¦è¦åœ¨ç”Ÿæˆæ–‡ä»¶å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„æ›´æ–°ç‹€æ…‹ï¼Ÿ\n\n' +
                                    'âš ï¸  æé†’ï¼šé¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= æ¨™è¨˜ ${result.assetIds.length} ç­†è½‰ç§»è¨˜éŒ„ç‚ºå·²æ›´æ–°ï¼ˆç„¡æ³•å†æ¬¡åˆ—å°ï¼‰\n` +
                                    'âŒ ã€å–æ¶ˆã€‘= åƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ¨™è¨˜ç‹€æ…‹ï¼ˆå¯å†æ¬¡åˆ—å°ï¼Œéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰'
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†æœªæ¨™è¨˜ç‚ºå·²ä¸Šå‚³ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processUploadConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createTransferDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">åˆ—å°è½‰ç§»ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Category Selector */}
                        <div className="px-6 py-4 border-b bg-purple-50/50">
                            <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                            <label className="inline-flex items-center mr-6">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="è²¡ç”¢"
                                    checked={selectedCategory === 'è²¡ç”¢'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>è²¡ç”¢</span>
                            </label>
                            <label className="inline-flex items-center">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="ç‰©å“"
                                    checked={selectedCategory === 'ç‰©å“'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>ç‰©å“</span>
                            </label>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-16">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                                        <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                    </div>
                                </div>
                            ) : currentAssets.length === 0 ? (
                                <div className="text-center py-16 text-slate-500">
                                    <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                    <p>ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆè½‰ç§»çš„{selectedCategory}è¨˜éŒ„ã€‚</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-purple-50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="rounded"
                                                    />
                                                </th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">åŸåœ°é»</th>
                                                <th className="px-3 py-2 text-left">æ–°ä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°ä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°åœ°é»</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»é¡å‹</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»æ—¥æœŸ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {currentAssets.map(asset => (
                                                <tr key={asset.assetId} className="border-b hover:bg-purple-50/30">
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedIds.includes(asset.assetId)}
                                                            onChange={() => handleSelectOne(asset.assetId)}
                                                            className="rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2">{asset.assetId}</td>
                                                    <td className="px-3 py-2">{asset.assetName}</td>
                                                    <td className="px-3 py-2">{asset.modelBrand}</td>
                                                    <td className="px-3 py-2">{asset.oldKeeper}</td>
                                                    <td className="px-3 py-2">{asset.oldUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.oldLocation}</td>
                                                    <td className="px-3 py-2">{asset.newKeeper}</td>
                                                    <td className="px-3 py-2">{asset.newUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.newLocation}</td>
                                                    <td className="px-3 py-2">{asset.transferType}</td>
                                                    <td className="px-3 py-2">{asset.transferDate}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-purple-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    disabled={isGenerating}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleGenerateDoc}
                                    disabled={isGenerating || selectedIds.length === 0}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? (
                                        <>
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                            <span>ç”¢ç”Ÿä¸­...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-file-alt"></i>
                                            <span>ç”Ÿæˆè½‰ç§»ç”³è«‹å–®</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== å¿«é€Ÿæ“ä½œ Modal çµ„ä»¶ =====

        // è½‰ç§» Modal
        const QuickTransferModal = ({ asset, transferOptions, onClose, onSuccess }) => {
            const [transferMode, setTransferMode] = useState('normal'); // 'normal', 'station', 'info', 'intake'
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            // é§ç«™è½‰ç§»å°ˆç”¨ state
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !transferOptions) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è®Šæ›´ï¼ˆåœ°é»ã€ä¿ç®¡äººæˆ–ä½¿ç”¨äººï¼‰');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('è«‹é¸æ“‡æ–°åœ°é»');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('è«‹é¸æ“‡æ–°ä¿ç®¡äºº');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('è«‹é¸æ“‡æ–°ä½¿ç”¨äºº');
                        return;
                    }
                } else if (transferMode === 'station') {
                    // é§ç«™è½‰ç§»æ¨¡å¼é©—è­‰
                    if (!custodianEmail) {
                        alert('è«‹é¸æ“‡é§ç®¡ï¼');
                        return;
                    }
                    if (!stationLocation) {
                        alert('è«‹é¸æ“‡é§ç«™åœ°é»ï¼');
                        return;
                    }
                }

                const confirmation = confirm(`ç¢ºå®šè¦è½‰ç§»è²¡ç”¢ã€Œ${asset.assetId}ã€å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤è½‰ç§»ç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                // ç‰¹æ®Šæ¨¡å¼çš„é¡å¤–åƒæ•¸
                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('è½‰ç§»ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                è½‰ç§»è²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                            </div>

                            {/* è½‰ç§»æ¨¡å¼é¸æ“‡ */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»æ¨¡å¼</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            name="transferMode"
                                            value="normal"
                                            checked={transferMode === 'normal'}
                                            onChange={(e) => setTransferMode(e.target.value)}
                                            className="mr-2"
                                        />
                                        <span>ä¸€èˆ¬è½‰ç§»</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="transferMode"
                                                value="station"
                                                checked={transferMode === 'station'}
                                                onChange={(e) => setTransferMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span>ä¸­å¿ƒè½‰çµ¦é§ç«™</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="info"
                                                    checked={transferMode === 'info'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>é§ç«™å›é€ä¸­å¿ƒè³‡è¨Šçµ„</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="transferMode"
                                                    value="intake"
                                                    checked={transferMode === 'intake'}
                                                    onChange={(e) => setTransferMode(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span>é§ç«™å›é€ä¸­å¿ƒæ”¶æ¡ˆçµ„</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* ä¸€èˆ¬è½‰ç§»é¸é … */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    {/* è®Šæ›´åœ°é» */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeLocation}
                                                onChange={(e) => setChangeLocation(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´åœ°é»</span>
                                        </label>
                                        {changeLocation && (
                                            <select
                                                value={newLocation}
                                                onChange={(e) => setNewLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°åœ°é»...</option>
                                                {transferOptions.locations?.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* è®Šæ›´ä¿ç®¡äºº */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeKeeper}
                                                onChange={(e) => setChangeKeeper(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä¿ç®¡äºº</span>
                                        </label>
                                        {changeKeeper && (
                                            <select
                                                value={newKeeperEmail}
                                                onChange={(e) => setNewKeeperEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°ä¿ç®¡äºº...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    {/* è®Šæ›´ä½¿ç”¨äºº */}
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input
                                                type="checkbox"
                                                checked={changeUser}
                                                onChange={(e) => setChangeUser(e.target.checked)}
                                                className="mr-2"
                                            />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä½¿ç”¨äºº</span>
                                        </label>
                                        {changeUser && (
                                            <select
                                                value={newUserEmail}
                                                onChange={(e) => setNewUserEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡æ–°ä½¿ç”¨äºº...</option>
                                                {transferOptions.userList && Object.entries(transferOptions.userList).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* é§ç«™è½‰ç§»æ¨¡å¼çš„ä¸‹æ‹‰é¸å–® */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>é§ç«™æ¨¡å¼èªªæ˜ï¼š</strong>ä¿ç®¡äººå’Œä½¿ç”¨äººå°‡åŒæ™‚è¨­ç‚ºæ­¤é§ç®¡ã€‚
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* é§ç®¡é¸æ“‡ */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                è½‰ç§»çµ¦é§ç®¡ï¼š<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={custodianEmail}
                                                onChange={(e) => setCustodianEmail(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡é§ç®¡...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (
                                                    <option key={email} value={email}>{name}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* é§ç«™åœ°é»é¸æ“‡ */}
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                                é§ç«™åœ°é»ï¼š<span className="text-red-600">*</span>
                                            </label>
                                            <select
                                                value={stationLocation}
                                                onChange={(e) => setStationLocation(e.target.value)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="">è«‹é¸æ“‡é§ç«™åœ°é»...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (
                                                    <option key={loc} value={loc}>{loc}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* å…¶ä»–ç‰¹æ®Šæ¨¡å¼èªªæ˜ */}
                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šè³‡è¨Šçµ„ä¿ç®¡äººã€ä½¿ç”¨äººå’Œåœ°é»'}
                                        {transferMode === 'intake' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šæ”¶æ¡ˆçµ„ä¿ç®¡äººå’Œåœ°é»'}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å‡ºå€Ÿ Modal
        const QuickLendingModal = ({ asset, lendingOptions, onClose, onSuccess }) => {
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset || !lendingOptions) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå€Ÿç”¨äººã€åœ°é»ã€æ­¸é‚„æ—¥æœŸï¼‰');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦å‡ºå€Ÿè²¡ç”¢ã€Œ${asset.assetId}ã€çµ¦ ${borrowerName} å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤å‡ºå€Ÿç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('å‡ºå€Ÿç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                å‡ºå€Ÿè²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">ç›®å‰åœ°é»</div>
                                <div className="text-slate-800">{asset.location}</div>
                            </div>

                            <div className="space-y-4">
                                {/* å€Ÿç”¨äºº */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å€Ÿç”¨äººå§“å <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={borrowerName}
                                        onChange={(e) => setBorrowerName(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">è«‹é¸æ“‡å€Ÿç”¨äºº...</option>
                                        {lendingOptions.borrowers?.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* å€Ÿå‡ºå¾Œåœ°é» */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å€Ÿå‡ºå¾Œæ”¾ç½®åœ°é» <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={lendingLocation}
                                        onChange={(e) => setLendingLocation(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    >
                                        <option value="">è«‹é¸æ“‡åœ°é»...</option>
                                        {lendingOptions.locations?.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* é è¨ˆæ­¸é‚„æ—¥æœŸ */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        é è¨ˆæ­¸é‚„æ—¥æœŸ <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        value={returnDate}
                                        onChange={(e) => setReturnDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    />
                                </div>

                                {/* å‡ºå€Ÿäº‹ç”± */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å‡ºå€Ÿäº‹ç”±/å‚™è¨»
                                    </label>
                                    <textarea
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        rows="3"
                                        placeholder="è«‹è¼¸å…¥å‡ºå€Ÿäº‹ç”±æˆ–å‚™è¨»..."
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å ±å»¢ Modal
        const QuickScrapModal = ({ asset, onClose, onSuccess }) => {
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            if (!asset) return null;

            const handleSubmit = () => {
                // é©—è­‰è¡¨å–®
                if (!reason) {
                    alert('è«‹é¸æ“‡å ±å»¢åŸå› ');
                    return;
                }
                if ((reason === 'C' || reason === 'å…¶ä»–') && !remarks.trim()) {
                    alert('é¸æ“‡ã€Œå…¶ä»–ã€åŸå› æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°èªªæ˜');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦ç”³è«‹å ±å»¢è²¡ç”¢ã€Œ${asset.assetId}ã€å—ï¼Ÿ\nå ±å»¢åŸå› ï¼š${reason === 'A' ? 'A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : reason === 'B' ? 'B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : 'C.å…¶ä»–'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤å ±å»¢ç”³è«‹...');

                const formData = {
                    assetIds: [asset.assetId],
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('å ±å»¢ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                ç”³è«‹å ±å»¢è²¡ç”¢
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* è³‡ç”¢è³‡è¨Š */}
                            <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                                <div className="text-sm text-slate-600 mb-1">è²¡ç”¢ç·¨è™Ÿ</div>
                                <div className="font-bold text-slate-800">{asset.assetId}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">è²¡ç”¢åç¨±</div>
                                <div className="text-slate-800">{asset.assetName}</div>
                                <div className="text-sm text-slate-600 mt-2 mb-1">ç›®å‰ç‹€æ…‹</div>
                                <div className="text-slate-800">{asset.status}</div>
                            </div>

                            {/* è­¦å‘Šè¨Šæ¯ */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">æ³¨æ„äº‹é …</div>
                                        <div>æ­¤æ“ä½œå°‡æœƒå°‡è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå ±å»¢ä¸­ã€ï¼Œå¾…ç®¡ç†å“¡æœ€çµ‚ç¢ºèªã€‚è«‹ç¢ºèªå ±å»¢åŸå› ç„¡èª¤å¾Œå†æäº¤ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                {/* å ±å»¢åŸå›  */}
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        å ±å»¢åŸå›  <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    >
                                        <option value="">è«‹é¸æ“‡åŸå› ...</option>
                                        <option value="A">A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="B">B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="C">C.å…¶ä»–</option>
                                    </select>
                                </div>

                                {/* è©³ç´°èªªæ˜ */}
                                {(reason === 'C' || reason === 'å…¶ä»–') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">
                                            è©³ç´°èªªæ˜ <span className="text-red-500">*</span>
                                        </label>
                                        <textarea
                                            value={remarks}
                                            onChange={(e) => setRemarks(e.target.value)}
                                            rows="4"
                                            placeholder="è«‹è©³ç´°èªªæ˜å ±å»¢åŸå› ..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                        ></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isSubmitting ? (
                                    <>
                                        <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                        <span>æäº¤ä¸­...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fa-solid fa-paper-plane"></i>
                                        <span>æäº¤å ±å»¢ç”³è«‹</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== æ‰¹æ¬¡æ“ä½œ Modal çµ„ä»¶ =====

        // æ‰¹æ¬¡è½‰ç§» Modal
        const BatchTransferModal = ({ transferOptions, allAssets = [], onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [transferMode, setTransferMode] = useState('normal');
            const [changeLocation, setChangeLocation] = useState(false);
            const [changeKeeper, setChangeKeeper] = useState(false);
            const [changeUser, setChangeUser] = useState(false);
            const [newLocation, setNewLocation] = useState('');
            const [newKeeperEmail, setNewKeeperEmail] = useState('');
            const [newUserEmail, setNewUserEmail] = useState('');
            const [custodianEmail, setCustodianEmail] = useState('');
            const [stationLocation, setStationLocation] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            // å¾ BatchList ç²å–å·²é¸è³‡ç”¢
            useEffect(() => {
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, []);

            // ç²å–å·²é¸è³‡ç”¢çš„è©³ç´°è³‡è¨Š
            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!transferOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è½‰ç§»çš„è³‡ç”¢');
                    return;
                }

                if (transferMode === 'normal') {
                    if (!changeLocation && !changeKeeper && !changeUser) {
                        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è®Šæ›´ï¼ˆåœ°é»ã€ä¿ç®¡äººæˆ–ä½¿ç”¨äººï¼‰');
                        return;
                    }
                    if (changeLocation && !newLocation) {
                        alert('è«‹é¸æ“‡æ–°åœ°é»');
                        return;
                    }
                    if (changeKeeper && !newKeeperEmail) {
                        alert('è«‹é¸æ“‡æ–°ä¿ç®¡äºº');
                        return;
                    }
                    if (changeUser && !newUserEmail) {
                        alert('è«‹é¸æ“‡æ–°ä½¿ç”¨äºº');
                        return;
                    }
                } else if (transferMode === 'station') {
                    if (!custodianEmail) {
                        alert('è«‹é¸æ“‡é§ç®¡ï¼');
                        return;
                    }
                    if (!stationLocation) {
                        alert('è«‹é¸æ“‡é§ç«™åœ°é»ï¼');
                        return;
                    }
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡è½‰ç§» ${selectedAssetIds.length} ç­†è³‡ç”¢å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡è½‰ç§»ç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    newKeeperEmail: changeKeeper ? newKeeperEmail : null,
                    newLocation: changeLocation ? newLocation : null,
                    newUserName: null,
                    newUserEmail: changeUser ? newUserEmail : null,
                    isStationTransfer: transferMode === 'station',
                    isInfoTransfer: transferMode === 'info',
                    isIntakeTransfer: transferMode === 'intake'
                };

                if (transferMode === 'station') {
                    formData.custodianEmail = custodianEmail;
                    formData.stationLocation = stationLocation;
                } else if (transferMode === 'info' && transferOptions.infoCustodian) {
                    formData.infoCustodianEmail = Object.keys(transferOptions.infoCustodian)[0];
                    formData.infoUserEmail = Object.keys(transferOptions.infoUser || {})[0];
                    formData.infoLocation = transferOptions.infoLocation;
                    formData.infoComputerLocation = transferOptions.infoComputerLocation;
                } else if (transferMode === 'intake' && transferOptions.intakeCustodian) {
                    formData.intakeCustodianEmail = Object.keys(transferOptions.intakeCustodian)[0];
                    formData.intakeLocation = transferOptions.intakeLocation;
                }

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡è½‰ç§»ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        // æ¸…ç©º BatchList
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchTransferApplication(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-blue-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-blue-800">
                                <i className="fa-solid fa-right-left mr-2"></i>
                                æ‰¹æ¬¡è½‰ç§»è²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-blue-600 hover:text-blue-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* è½‰ç§»æ¨¡å¼é¸æ“‡ */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»æ¨¡å¼</label>
                                <div className="space-y-2">
                                    <label className="flex items-center">
                                        <input type="radio" name="batchTransferMode" value="normal" checked={transferMode === 'normal'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                        <span>ä¸€èˆ¬è½‰ç§»</span>
                                    </label>
                                    {transferOptions.custodians && Object.keys(transferOptions.custodians).length > 0 && (
                                        <label className="flex items-center">
                                            <input type="radio" name="batchTransferMode" value="station" checked={transferMode === 'station'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                            <span>ä¸­å¿ƒè½‰çµ¦é§ç«™</span>
                                        </label>
                                    )}
                                    {transferOptions.infoCustodian && (
                                        <>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="info" checked={transferMode === 'info'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>é§ç«™å›é€ä¸­å¿ƒè³‡è¨Šçµ„</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input type="radio" name="batchTransferMode" value="intake" checked={transferMode === 'intake'} onChange={(e) => setTransferMode(e.target.value)} className="mr-2" />
                                                <span>é§ç«™å›é€ä¸­å¿ƒæ”¶æ¡ˆçµ„</span>
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* ä¸€èˆ¬è½‰ç§»é¸é … */}
                            {transferMode === 'normal' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeLocation} onChange={(e) => setChangeLocation(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´åœ°é»</span>
                                        </label>
                                        {changeLocation && (
                                            <select value={newLocation} onChange={(e) => setNewLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°åœ°é»...</option>
                                                {transferOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeKeeper} onChange={(e) => setChangeKeeper(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä¿ç®¡äºº</span>
                                        </label>
                                        {changeKeeper && (
                                            <select value={newKeeperEmail} onChange={(e) => setNewKeeperEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°ä¿ç®¡äºº...</option>
                                                {transferOptions.keepers && Object.entries(transferOptions.keepers).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                    <div>
                                        <label className="flex items-center mb-2">
                                            <input type="checkbox" checked={changeUser} onChange={(e) => setChangeUser(e.target.checked)} className="mr-2" />
                                            <span className="font-medium text-slate-700">è®Šæ›´ä½¿ç”¨äºº</span>
                                        </label>
                                        {changeUser && (
                                            <select value={newUserEmail} onChange={(e) => setNewUserEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡æ–°ä½¿ç”¨äºº...</option>
                                                {transferOptions.userList && Object.entries(transferOptions.userList).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* é§ç«™è½‰ç§» */}
                            {transferMode === 'station' && (
                                <div className="p-4 bg-blue-50 rounded-lg space-y-4">
                                    <div className="flex items-center gap-2 text-sm text-blue-800 mb-3">
                                        <i className="fas fa-info-circle"></i>
                                        <strong>é§ç«™æ¨¡å¼èªªæ˜ï¼š</strong>ä¿ç®¡äººå’Œä½¿ç”¨äººå°‡åŒæ™‚è¨­ç‚ºæ­¤é§ç®¡ã€‚
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">è½‰ç§»çµ¦é§ç®¡ï¼š<span className="text-red-600">*</span></label>
                                            <select value={custodianEmail} onChange={(e) => setCustodianEmail(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡é§ç®¡...</option>
                                                {transferOptions.custodians && Object.entries(transferOptions.custodians).map(([email, name]) => (<option key={email} value={email}>{name}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">é§ç«™åœ°é»ï¼š<span className="text-red-600">*</span></label>
                                            <select value={stationLocation} onChange={(e) => setStationLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="">è«‹é¸æ“‡é§ç«™åœ°é»...</option>
                                                {transferOptions.stationLocations && transferOptions.stationLocations.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {(transferMode === 'info' || transferMode === 'intake') && (
                                <div className="p-4 bg-blue-50 rounded-lg">
                                    <p className="text-sm text-blue-800">
                                        {transferMode === 'info' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šè³‡è¨Šçµ„ä¿ç®¡äººã€ä½¿ç”¨äººå’Œåœ°é»'}
                                        {transferMode === 'intake' && 'æ­¤æ¨¡å¼å°‡è‡ªå‹•è¨­å®šæ”¶æ¡ˆçµ„ä¿ç®¡äººå’Œåœ°é»'}
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡è½‰ç§»</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // æ‰¹æ¬¡å‡ºå€Ÿ Modal
        const BatchLendingModal = ({ lendingOptions, allAssets = [], onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [borrowerName, setBorrowerName] = useState('');
            const [lendingLocation, setLendingLocation] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [reason, setReason] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, []);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            if (!lendingOptions) return null;

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦å‡ºå€Ÿçš„è³‡ç”¢');
                    return;
                }
                if (!borrowerName || !lendingLocation || !returnDate) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆå€Ÿç”¨äººã€åœ°é»ã€æ­¸é‚„æ—¥æœŸï¼‰');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡å‡ºå€Ÿ ${selectedAssetIds.length} ç­†è³‡ç”¢çµ¦ ${borrowerName} å—ï¼Ÿ`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡å‡ºå€Ÿç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    borrowerName,
                    lendingLocation,
                    returnDate,
                    reason
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡å‡ºå€Ÿç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchLending(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">
                                <i className="fa-solid fa-hand-holding-hand mr-2"></i>
                                æ‰¹æ¬¡å‡ºå€Ÿè²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å€Ÿç”¨äººå§“å <span className="text-red-500">*</span></label>
                                    <select value={borrowerName} onChange={(e) => setBorrowerName(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">è«‹é¸æ“‡å€Ÿç”¨äºº...</option>
                                        {lendingOptions.borrowers?.map(name => (<option key={name} value={name}>{name}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å€Ÿå‡ºå¾Œæ”¾ç½®åœ°é» <span className="text-red-500">*</span></label>
                                    <select value={lendingLocation} onChange={(e) => setLendingLocation(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">è«‹é¸æ“‡åœ°é»...</option>
                                        {lendingOptions.locations?.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">é è¨ˆæ­¸é‚„æ—¥æœŸ <span className="text-red-500">*</span></label>
                                    <input type="date" value={returnDate} onChange={(e) => setReturnDate(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å‡ºå€Ÿäº‹ç”±/å‚™è¨»</label>
                                    <textarea value={reason} onChange={(e) => setReason(e.target.value)} rows="3" placeholder="è«‹è¼¸å…¥å‡ºå€Ÿäº‹ç”±æˆ–å‚™è¨»..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡å‡ºå€Ÿ</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // æ‰¹æ¬¡å ±å»¢ Modal
        const BatchScrapModal = ({ allAssets = [], onClose, onSuccess }) => {
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);
            const [reason, setReason] = useState('');
            const [remarks, setRemarks] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (typeof window.BatchList_getItems === 'function') {
                    setSelectedAssetIds(window.BatchList_getItems());
                }
            }, []);

            const selectedAssetsDetails = useMemo(() => {
                return selectedAssetIds.map(id => allAssets.find(a => a.assetId === id)).filter(Boolean);
            }, [selectedAssetIds, allAssets]);

            const handleSubmit = () => {
                if (selectedAssetIds.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦å ±å»¢çš„è³‡ç”¢');
                    return;
                }
                if (!reason) {
                    alert('è«‹é¸æ“‡å ±å»¢åŸå› ');
                    return;
                }
                if ((reason === 'C' || reason === 'å…¶ä»–') && !remarks.trim()) {
                    alert('é¸æ“‡ã€Œå…¶ä»–ã€åŸå› æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°èªªæ˜');
                    return;
                }

                const confirmation = confirm(`ç¢ºå®šè¦æ‰¹æ¬¡ç”³è«‹å ±å»¢ ${selectedAssetIds.length} ç­†è³‡ç”¢å—ï¼Ÿ\nå ±å»¢åŸå› ï¼š${reason === 'A' ? 'A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : reason === 'B' ? 'B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™' : 'C.å…¶ä»–'}`);
                if (!confirmation) return;

                setIsSubmitting(true);
                showFlyProgressBar('æ­£åœ¨æäº¤æ‰¹æ¬¡å ±å»¢ç”³è«‹...');

                const formData = {
                    assetIds: selectedAssetIds,
                    reason,
                    remarks: remarks.trim()
                };

                google.script.run
                    .withSuccessHandler(message => {
                        hideFlyProgressBar('æ‰¹æ¬¡å ±å»¢ç”³è«‹å·²æäº¤ï¼', 0);
                        alert(message);
                        if (typeof window.BatchList_resetOnSubmit === 'function') {
                            window.BatchList_resetOnSubmit();
                        }
                        setIsSubmitting(false);
                        onSuccess();
                        onClose();
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('æäº¤å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                        setIsSubmitting(false);
                    })
                    .processBatchScrapping(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-red-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-red-800">
                                <i className="fa-regular fa-trash-can mr-2"></i>
                                æ‰¹æ¬¡ç”³è«‹å ±å»¢è²¡ç”¢ ({selectedAssetIds.length} ç­†)
                            </h3>
                            <button onClick={onClose} className="text-red-600 hover:text-red-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div className="px-6 py-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                            {/* å·²é¸è³‡ç”¢æ¸…å–® */}
                            <div className="mb-4">
                                <div className="text-sm font-medium text-slate-700 mb-2">å·²é¸æ“‡çš„è³‡ç”¢ï¼š</div>
                                <div className="max-h-32 overflow-y-auto bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    {selectedAssetsDetails.length === 0 ? (
                                        <div className="text-slate-400 text-sm">æ²’æœ‰é¸å–çš„è³‡ç”¢</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {selectedAssetsDetails.map(asset => (
                                                <div key={asset.assetId} className="text-sm flex justify-between">
                                                    <span className="font-mono text-slate-600">{asset.assetId}</span>
                                                    <span className="text-slate-500 truncate ml-2">{asset.assetName}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* è­¦å‘Šè¨Šæ¯ */}
                            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div className="flex items-start gap-2">
                                    <i className="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                                    <div className="text-sm text-red-800">
                                        <div className="font-medium mb-1">æ³¨æ„äº‹é …</div>
                                        <div>æ­¤æ“ä½œå°‡æœƒå°‡æ‰€æœ‰é¸ä¸­çš„è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå ±å»¢ä¸­ã€ï¼Œå¾…ç®¡ç†å“¡æœ€çµ‚ç¢ºèªã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">å ±å»¢åŸå›  <span className="text-red-500">*</span></label>
                                    <select value={reason} onChange={(e) => setReason(e.target.value)} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                        <option value="">è«‹é¸æ“‡åŸå› ...</option>
                                        <option value="A">A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="B">B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                                        <option value="C">C.å…¶ä»–</option>
                                    </select>
                                </div>
                                {(reason === 'C' || reason === 'å…¶ä»–') && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">è©³ç´°èªªæ˜ <span className="text-red-500">*</span></label>
                                        <textarea value={remarks} onChange={(e) => setRemarks(e.target.value)} rows="4" placeholder="è«‹è©³ç´°èªªæ˜å ±å»¢åŸå› ..." className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                            <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors disabled:opacity-50">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} disabled={isSubmitting || selectedAssetIds.length === 0} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                {isSubmitting ? (<><div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>æäº¤ä¸­...</span></>) : (<><i className="fa-solid fa-paper-plane"></i><span>æäº¤æ‰¹æ¬¡å ±å»¢</span></>)}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ä¸» App çµ„ä»¶
        function App() {
            const [isReady, setIsReady] = useState(false);
            const [allAssets, setAllAssets] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [currentUserEmail, setCurrentUserEmail] = useState('');
            const [currentUserName, setCurrentUserName] = useState('');
            const [webAppUrl, setWebAppUrl] = useState('');
            const [pendingApprovalsData, setPendingApprovalsData] = useState([]);
            const [inventorySessions, setInventorySessions] = useState(null);
            const [filters, setFilters] = useState({
                status: '',
                category: '',
                leader: '',
                search: ''
            });
            const [activeModal, setActiveModal] = useState(null);
            const [isLoadingCards, setIsLoadingCards] = useState(false);
            const [lentAssetsDetails, setLentAssetsDetails] = useState(null);
            const [isLoadingLentDetails, setIsLoadingLentDetails] = useState(false);
            const [scrapPendingDetails, setScrapPendingDetails] = useState(null);
            const [transferPendingDetails, setTransferPendingDetails] = useState(null);
            const [transferPendingCount, setTransferPendingCount] = useState(0);
            const [isLoadingScrapDetails, setIsLoadingScrapDetails] = useState(false);
            const [isLoadingTransferDetails, setIsLoadingTransferDetails] = useState(false);

            // å¿«é€Ÿæ“ä½œ Modal ç›¸é—œ state
            const [quickActionModalType, setQuickActionModalType] = useState(null); // 'transfer', 'lending', 'scrap'
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [transferOptions, setTransferOptions] = useState(null);
            const [lendingOptions, setLendingOptions] = useState(null);

            // æ‰¹æ¬¡æ“ä½œ Modal ç›¸é—œ state
            const [batchModalType, setBatchModalType] = useState(null); // 'transfer', 'lending', 'scrap'

            // è³‡ç”¢é¸å–ç‹€æ…‹ï¼ˆèˆ‡ BatchList åŒæ­¥ï¼‰
            const [selectedAssetIds, setSelectedAssetIds] = useState([]);

            // è™•ç†å–®å€‹è³‡ç”¢é¸å–
            const handleAssetSelect = useCallback((assetId) => {
                setSelectedAssetIds(prev => {
                    const isSelected = prev.includes(assetId);
                    let newSelection;

                    if (isSelected) {
                        // å–æ¶ˆé¸å–
                        newSelection = prev.filter(id => id !== assetId);
                        if (typeof window.BatchList_removeItem === 'function') {
                            window.BatchList_removeItem(assetId);
                        }
                    } else {
                        // é¸å–
                        newSelection = [...prev, assetId];
                        if (typeof window.BatchList_addItem === 'function') {
                            window.BatchList_addItem(assetId);
                        }
                    }
                    return newSelection;
                });
            }, []);

            // ç›£è½ BatchList è®ŠåŒ–ä¸¦åŒæ­¥ï¼ˆè™•ç† Scanner Enter éµæƒæçš„æƒ…æ³ï¼‰
            useEffect(() => {
                const syncFromBatchList = () => {
                    if (typeof window.BatchList_getItems === 'function') {
                        const batchItems = window.BatchList_getItems();
                        setSelectedAssetIds(prev => {
                            // åªæ·»åŠ æ–°çš„é …ç›®ï¼Œä¸ç§»é™¤èˆŠçš„
                            const newItems = batchItems.filter(id => !prev.includes(id));
                            if (newItems.length > 0) {
                                return [...prev, ...newItems];
                            }
                            return prev;
                        });
                    }
                };

                // å®šæœŸåŒæ­¥ï¼ˆè™•ç†å¤–éƒ¨æ·»åŠ çš„æƒ…æ³ï¼‰
                const interval = setInterval(syncFromBatchList, 500);
                return () => clearInterval(interval);
            }, []);

            // è¼‰å…¥è³‡æ–™
            const loadData = () => {
                showFlyProgressBar('æ­£åœ¨è¼‰å…¥è²¡ç”¢ç‹€æ…‹è³‡æ–™...');
                setIsLoadingCards(true); // åˆå§‹è¼‰å…¥æ™‚ä¹Ÿé¡¯ç¤ºå¡ç‰‡è¼‰å…¥å‹•ç•«

                google.script.run
                    .withSuccessHandler(url => {
                        setWebAppUrl(url);

                        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å¤±æ•—ï¼š' + response.error);
                                    hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                    return;
                                }

                                setAllAssets(response.assets || []);
                                setIsAdmin(response.isAdmin);
                                setCurrentUserEmail(response.userEmail);
                                setCurrentUserName(response.userName || '');

                                let pendingLoaded = false;
                                let inventoryLoaded = false;
                                const finishCardLoading = () => {
                                    if (pendingLoaded && inventoryLoaded) {
                                        setIsLoadingCards(false);
                                    }
                                };

                                // è¼‰å…¥å¾…æ¥æ”¶è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(pendingResponse => {
                                        if (pendingResponse && pendingResponse.approvals) {
                                            setPendingApprovalsData(pendingResponse.approvals);
                                        }
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥å¾…æ¥æ”¶æ¸…å–®å¤±æ•—ï¼š', error.message);
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getPendingApprovals();

                                // è¼‰å…¥ç›¤é»è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(inventoryResponse => {
                                        if (inventoryResponse) {
                                            setInventorySessions(inventoryResponse);
                                        }
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥ç›¤é»è³‡æ–™å¤±æ•—ï¼š', error.message);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getInventoryData();

                                // è¼‰å…¥è½‰ç§»å¾…åˆ—å°æ•¸é‡
                                google.script.run
                                    .withSuccessHandler(count => {
                                        if (typeof count === 'number') {
                                            setTransferPendingCount(count);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»æ•¸é‡å¤±æ•—ï¼š', error.message);
                                        setTransferPendingCount(0);
                                    })
                                    .getTransferableItemsCount();

                                // è¼‰å…¥è½‰ç§»é¸é …è³‡æ–™ï¼ˆä¿ç®¡äººã€åœ°é»ç­‰ï¼‰
                                google.script.run
                                    .withSuccessHandler(transferData => {
                                        if (transferData && !transferData.error) {
                                            setTransferOptions(transferData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»é¸é …å¤±æ•—ï¼š', error.message);
                                    })
                                    .getTransferData();

                                // è¼‰å…¥å‡ºå€Ÿé¸é …è³‡æ–™ï¼ˆå€Ÿç”¨äººã€åœ°é»ï¼‰
                                google.script.run
                                    .withSuccessHandler(lendingData => {
                                        if (lendingData && !lendingData.error) {
                                            setLendingOptions(lendingData);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥å‡ºå€Ÿé¸é …å¤±æ•—ï¼š', error.message);
                                    })
                                    .getLendingData();

                                setIsReady(true);
                                hideFlyProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
                            })
                            .withFailureHandler(error => {
                                setIsLoadingCards(false); // å¤±æ•—æ™‚ä¹Ÿé—œé–‰å¡ç‰‡å‹•ç•«
                                hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                alert('éŒ¯èª¤ï¼š' + error.message);
                            })
                            .getUserStateData();
                    })
                    .getAppUrl();
            };

            // é‡æ–°æ•´ç†å¡ç‰‡æ•¸æ“šï¼ˆä¸¦è¡Œè¼‰å…¥ï¼‰
            const refreshCardData = useCallback(async () => {
                const MIN_LOADING_DURATION = 500; // æœ€çŸ­é¡¯ç¤ºæ™‚é–“ 500ms
                setIsLoadingCards(true);
                const startTime = Date.now();

                try {
                    // ä¸¦è¡Œè¼‰å…¥å››å€‹ API
                    const [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse] = await Promise.allSettled([
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingApprovals();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getInventoryData();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getUserStateData();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferableItemsCount();
                        })
                    ]);

                    // è™•ç†æˆåŠŸçš„çµæœ
                    if (pendingResponse.status === 'fulfilled' && pendingResponse.value?.approvals) {
                        setPendingApprovalsData(pendingResponse.value.approvals);
                    }
                    if (inventoryResponse.status === 'fulfilled' && inventoryResponse.value) {
                        setInventorySessions(inventoryResponse.value);
                    }
                    if (assetsResponse.status === 'fulfilled' && assetsResponse.value?.assets) {
                        setAllAssets(assetsResponse.value.assets);
                    }
                    if (transferCountResponse.status === 'fulfilled' && typeof transferCountResponse.value === 'number') {
                        setTransferPendingCount(transferCountResponse.value);
                    }

                    // æª¢æŸ¥å¤±æ•—çš„è«‹æ±‚
                    const failures = [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse]
                        .filter(r => r.status === 'rejected');
                    if (failures.length > 0) {
                        console.warn('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š', failures);
                        alert('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                    }

                    // ç¢ºä¿æœ€çŸ­é¡¯ç¤ºæ™‚é–“
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, MIN_LOADING_DURATION - elapsedTime);

                    setTimeout(() => {
                        setIsLoadingCards(false);
                    }, remainingTime);

                } catch (error) {
                    setIsLoadingCards(false);
                    console.error('é‡æ–°æ•´ç†å¤±æ•—ï¼š', error);
                    alert('é‡æ–°æ•´ç†å¤±æ•—ï¼š' + error.message);
                }
            }, []);

            // é‡æ–°æ•´ç†æŒ‰éˆ•é»æ“Šè™•ç†
            const handleRefreshCards = () => {
                refreshCardData();
            };

            useEffect(() => {
                loadData();

                // è¨­å®šå…¨åŸŸåˆ·æ–°å‡½æ•¸
                window.refreshReactData = () => {
                    loadData();
                };
            }, []);

            // åŒæ­¥ç‹€æ…‹åˆ°å…¨åŸŸè®Šæ•¸ä¾› jQuery Modal ä½¿ç”¨
            useEffect(() => {
                window.pendingApprovals = pendingApprovalsData;
            }, [pendingApprovalsData]);

            // è¨ˆç®—ç¯©é¸å¾Œçš„è³‡ç”¢
            const filteredAssets = useMemo(() => {
                return allAssets.filter(asset => {
                    const statusMatch = !filters.status || asset.status === filters.status;
                    const categoryMatch = !filters.category || asset.category === filters.category;
                    const leaderMatch = !filters.leader || asset.leader === filters.leader;
                    const searchMatch = !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.assetName.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.leader.toUpperCase().includes(filters.search.toUpperCase());
                    return statusMatch && categoryMatch && leaderMatch && searchMatch;
                });
            }, [allAssets, filters]);

            // è™•ç†å…¨é¸ï¼ˆå¿…é ˆåœ¨ filteredAssets å®šç¾©ä¹‹å¾Œï¼‰
            const handleSelectAll = useCallback((checked) => {
                const selectableAssets = filteredAssets.filter(a => a.status === 'åœ¨åº«');
                const selectableIds = selectableAssets.map(a => a.assetId);

                // âœ¨ å–å¾—ä¸Šé™å€¼ï¼ˆé è¨­ 500ï¼‰
                const MAX_BATCH_SIZE = typeof window.BatchList_getMaxSize === 'function'
                    ? window.BatchList_getMaxSize()
                    : 500;

                if (checked) {
                    // âœ¨ æ•¸é‡é æª¢æŸ¥ï¼šè¶…éä¸Šé™æ™‚å½ˆå‡ºè­¦å‘Š
                    if (selectableIds.length > MAX_BATCH_SIZE) {
                        const proceed = window.confirm(
                            `æ‚¨å³å°‡é¸å– ${selectableIds.length} ç­†è³‡ç”¢ï¼Œè¶…éå»ºè­°ä¸Šé™ ${MAX_BATCH_SIZE} ç­†ã€‚\n` +
                            `å¤§é‡é¸å–å¯èƒ½é€ æˆé é¢åæ‡‰ç·©æ…¢ã€‚\n\n` +
                            `æ˜¯å¦ç¹¼çºŒï¼Ÿ`
                        );
                        if (!proceed) return;
                    }

                    // âœ¨ å…¨é¸ï¼šä½¿ç”¨æ‰¹é‡ API æå‡æ•ˆèƒ½
                    setSelectedAssetIds(prev => {
                        const newIds = selectableIds.filter(id => !prev.includes(id));
                        if (typeof window.BatchList_addItems === 'function') {
                            // ä½¿ç”¨æ‰¹é‡æ–°å¢ï¼ˆä¸€æ¬¡æ€§æ›´æ–° UIï¼‰
                            window.BatchList_addItems(newIds);
                        } else if (typeof window.BatchList_addItemSilent === 'function') {
                            // é™ç´šï¼šéœé»˜æ–°å¢å¾Œä¸€æ¬¡æ€§æ›´æ–°
                            newIds.forEach(id => window.BatchList_addItemSilent(id));
                            if (typeof window.BatchList_updateUI === 'function') {
                                window.BatchList_updateUI();
                            }
                        } else {
                            // æœ€çµ‚é™ç´šï¼šé€ç­†åŠ å…¥
                            newIds.forEach(id => {
                                if (typeof window.BatchList_addItem === 'function') {
                                    window.BatchList_addItem(id);
                                }
                            });
                        }
                        return [...new Set([...prev, ...selectableIds])];
                    });
                } else {
                    // å–æ¶ˆå…¨é¸
                    setSelectedAssetIds(prev => {
                        selectableIds.forEach(id => {
                            if (typeof window.BatchList_removeItem === 'function') {
                                window.BatchList_removeItem(id);
                            }
                        });
                        return prev.filter(id => !selectableIds.includes(id));
                    });
                }
            }, [filteredAssets]);

            // è¨ˆç®—é‡è¤‡ç”¢ç·¨
            const duplicateInfo = useMemo(() => {
                const map = new Map();
                const duplicates = new Map();
                let duplicateCount = 0;

                filteredAssets.forEach(asset => {
                    const key = String(asset.assetId || '').trim();
                    if (map.has(key)) {
                        duplicateCount += 1;
                        const existing = map.get(key);
                        if (!duplicates.has(key)) {
                            duplicates.set(key, [existing]);
                        }
                        duplicates.get(key).push(asset);
                    } else {
                        map.set(key, asset);
                    }
                });

                const groups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                    assetId,
                    items
                }));

                return { duplicateCount, groups };
            }, [filteredAssets]);

            // åŒæ­¥é‡è¤‡ç”¢ç·¨è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
            useEffect(() => {
                window.duplicateGroups = duplicateInfo.groups;
            }, [duplicateInfo.groups]);

            // åŒæ­¥ã€Œåœ¨åº«ã€è³‡ç”¢åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾› BatchList å’Œ Scanner æ¨¡çµ„ä½¿ç”¨
            useEffect(() => {
                // âš ï¸ åªåŒ…å«ã€Œåœ¨åº«ã€ç‹€æ…‹çš„è³‡ç”¢ï¼Œé™åˆ¶å¯é¸å–ç¯„åœ
                window.allAssets = allAssets
                    .filter(asset => asset.status === 'åœ¨åº«')
                    .map(asset => ({
                        id: asset.assetId,
                        assetName: asset.assetName,
                        keeperName: asset.leader,
                        location: asset.location,
                        status: asset.status
                    }));

                // é‡å»º BatchList ç´¢å¼•
                if (typeof window.BatchList_rebuildIndex === 'function') {
                    window.BatchList_rebuildIndex();
                }

                // âœ¨ é‡æ–°åˆå§‹åŒ– Scanner æœå°‹æ¡†å¢å¼·ï¼ˆReact å‹•æ…‹æ¸²æŸ“å¾Œéœ€é‡æ–°ç¶å®šï¼‰
                if (typeof window.Scanner_enhanceSearchBox === 'function') {
                    setTimeout(() => {
                        window.Scanner_enhanceSearchBox();
                        console.log('[App] å·²é‡æ–°åˆå§‹åŒ– Scanner æœå°‹æ¡†å¢å¼·');
                    }, 100);
                }

                console.log('[App] å·²æ›´æ–° window.allAssetsï¼Œå…±', window.allAssets.length, 'ç­†ã€Œåœ¨åº«ã€è³‡ç”¢');
            }, [allAssets]);

            // è¨ˆç®—å¡ç‰‡çµ±è¨ˆæ•¸é‡
            const cardCounts = useMemo(() => {
                // âœ¨ ç›´æ¥ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„å¾…ç›¤é»è³‡ç”¢æ•¸é‡
                const inventoryCount = inventorySessions?.myPendingInventoryCount || 0;

                const scrapPendingCount = (() => {
                    const scrappingAssets = allAssets.filter(a => a.status === 'å ±å»¢ä¸­');
                    if (isAdmin) {
                        return scrappingAssets.length;
                    } else {
                        return scrappingAssets.filter(a =>
                            a.leaderEmail?.toLowerCase() === currentUserEmail.toLowerCase() ||
                            a.userEmail?.toLowerCase() === currentUserEmail.toLowerCase()
                        ).length;
                    }
                })();

                return {
                    pending: pendingApprovalsData.length,
                    lent: allAssets.filter(a => a.status === 'å‡ºå€Ÿä¸­').length,
                    scrapPending: scrapPendingCount,
                    transferPending: transferPendingCount,
                    inventory: inventoryCount
                };
            }, [allAssets, pendingApprovalsData, inventorySessions, currentUserEmail, isAdmin, transferPendingCount]);

            // è™•ç†å¡ç‰‡é»æ“Š
            const handleCardClick = (cardId) => {
                switch(cardId) {
                    case 'pending':
                        window.openPendingApprovalModal();
                        break;
                    case 'lent':
                        // è¨­å®šè¼‰å…¥ç‹€æ…‹ä¸¦æ‰“é–‹ modal
                        setIsLoadingLentDetails(true);
                        setActiveModal('lent');

                        // èª¿ç”¨å¾Œç«¯ç²å–è©³ç´°å‡ºå€Ÿè³‡è¨Š
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å‡ºå€Ÿè³‡æ–™å¤±æ•—ï¼š' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingLentDetails(false);
                                    return;
                                }
                                setLentAssetsDetails(response.assets || []);
                                setIsLoadingLentDetails(false);
                            })
                            .withFailureHandler(error => {
                                console.error('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š', error.message);
                                alert('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š' + error.message);
                                setActiveModal(null);
                                setIsLoadingLentDetails(false);
                            })
                            .getLentOutAssets();
                        break;
                    case 'scrapPending':
                        setIsLoadingScrapDetails(true);
                        setActiveModal('scrapPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('è²¡ç”¢');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('ç‰©å“');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingScrapDetails(false);
                                return;
                            }

                            setScrapPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingScrapDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingScrapDetails(false);
                        });
                        break;
                    case 'transferPending':
                        setIsLoadingTransferDetails(true);
                        setActiveModal('transferPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('è²¡ç”¢');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('ç‰©å“');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingTransferDetails(false);
                                return;
                            }

                            setTransferPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingTransferDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingTransferDetails(false);
                        });
                        break;
                    case 'inventory':
                        const inventoryUrl = webAppUrl + '?page=inventory';
                        window.open(inventoryUrl, '_top');
                        break;
                }
            };

            // è™•ç†ç¯©é¸è®Šæ›´
            const handleFilterChange = (filterName, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterName]: value
                }));
            };

            // âœ¨ æš´éœ²æ¸…ç©ºæœå°‹æ¡†çš„å…¨åŸŸå‡½æ•¸ï¼ˆä¾› Scanner æ¨¡çµ„ä½¿ç”¨ï¼‰
            useEffect(() => {
                window.clearSearchBox = () => {
                    setFilters(prev => ({ ...prev, search: '' }));
                };
                return () => {
                    delete window.clearSearchBox;
                };
            }, []);

            // å¿«é€Ÿæ“ä½œ Modal é–‹å•Ÿå‡½æ•¸
            const handleOpenTransferModal = (asset) => {
                if (!transferOptions) {
                    alert('è½‰ç§»é¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('transfer');
            };

            const handleOpenLendingModal = (asset) => {
                if (!lendingOptions) {
                    alert('å‡ºå€Ÿé¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                setSelectedAsset(asset);
                setQuickActionModalType('lending');
            };

            const handleOpenScrapModal = (asset) => {
                setSelectedAsset(asset);
                setQuickActionModalType('scrap');
            };

            const handleCloseQuickActionModal = () => {
                setQuickActionModalType(null);
                setSelectedAsset(null);
            };

            const handleQuickActionSuccess = () => {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            };

            // ========== æ‰¹æ¬¡æ“ä½œè™•ç†å‡½æ•¸ ==========
            const handleBatchTransfer = () => {
                if (!transferOptions) {
                    alert('è½‰ç§»é¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const items = BatchList_getItems();
                if (items.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                setBatchModalType('transfer');
            };

            const handleBatchLending = () => {
                if (!lendingOptions) {
                    alert('å‡ºå€Ÿé¸é …å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const items = BatchList_getItems();
                if (items.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                setBatchModalType('lending');
            };

            const handleBatchScrap = () => {
                if (typeof BatchList_getItems !== 'function') {
                    alert('æ‰¹æ¬¡é¸å–åŠŸèƒ½å°šæœªè¼‰å…¥');
                    return;
                }
                const items = BatchList_getItems();
                if (items.length === 0) {
                    alert('è«‹å…ˆé¸å–è¦è™•ç†çš„è³‡ç”¢');
                    return;
                }
                setBatchModalType('scrap');
            };

            const handleCloseBatchModal = () => {
                setBatchModalType(null);
            };

            const handleBatchActionSuccess = () => {
                setBatchModalType(null);
                // æ¸…ç©ºæ‰¹æ¬¡æ¸…å–®
                if (typeof BatchList_resetOnSubmit === 'function') {
                    BatchList_resetOnSubmit();
                }
                // æ¸…ç©º React é¸å–ç‹€æ…‹
                setSelectedAssetIds([]);
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadData();
            };

            // è™•ç†å–æ¶ˆ
            const handleCancel = (assetId, status) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­† [${status}] ç‹€æ…‹çš„ç”³è«‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å–æ¶ˆç”³è«‹...');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            hideFlyProgressBar('å–æ¶ˆå®Œæˆï¼', 300);

                            setTimeout(() => {
                                alert('ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚');
                                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                                loadData();
                            }, 400);
                        } else {
                            hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                            alert('éŒ¯èª¤ï¼š' + response.error);
                        }
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .cancelTransferOrScrap(assetId);
            };

            // è™•ç†å›æº¯
            const handleRestore = (assetId) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å°‡æ­¤ã€Œå·²å ±å»¢ã€è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ³¨æ„ï¼šæ­¤æ“ä½œæœƒä¿ç•™åŸå ±å»¢è¨˜éŒ„ä¸¦æ·»åŠ å›æº¯æ¨™è¨˜ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');

                google.script.run
                    .withSuccessHandler(result => {
                        hideFlyProgressBar('å›æº¯å®Œæˆï¼', 300);

                        setTimeout(() => {
                            alert(result.message);
                            showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                            loadData();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å›æº¯å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .restoreFromScrap([assetId]);
            };

            if (!isReady) {
                return null;
            }

            return (
                <div className="ml-[88px] p-6 max-w-[1600px] mx-auto">
                    <div className="mb-6 flex justify-between items-center">
                        {/* å·¦å´ï¼šæ¨™é¡Œ */}
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800">è²¡ç”¢ç‹€æ…‹æŸ¥è©¢</h1>
                            <p className="text-slate-500 mt-1">
                                {currentUserName && <span className="font-medium text-slate-700">{currentUserName}</span>}
                                {currentUserName && 'ï¼Œ'}æ­¡è¿å›ä¾†ï¼Œä»Šå¤©æ˜¯ {(() => {
                                    const now = new Date();
                                    const date = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                                    const hours = now.getHours();
                                    const minutes = now.getMinutes().toString().padStart(2, '0');
                                    const seconds = now.getSeconds().toString().padStart(2, '0');
                                    const period = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
                                    const displayHours = hours % 12 || 12;
                                    return `${date} ${period} ${displayHours}:${minutes}`;
                                })()}
                            </p>
                        </div>

                        {/* å³å´ï¼šé‡æ–°æ•´ç†æŒ‰éˆ• + è¼‰å…¥ç‹€æ…‹æŒ‡ç¤º */}
                        <div className="flex items-center gap-3">
                            {/* è¼‰å…¥ç‹€æ…‹æ–‡å­— */}
                            {isLoadingCards && (
                                <span className="text-sm text-slate-500 flex items-center gap-2">
                                    <i className="fas fa-spinner fa-spin text-blue-500"></i>
                                    æ­£åœ¨è¼‰å…¥çµ±è¨ˆæ•¸æ“š...
                                </span>
                            )}

                            {/* é‡æ–°æ•´ç†æŒ‰éˆ• */}
                            <button
                                onClick={handleRefreshCards}
                                disabled={isLoadingCards}
                                className="w-12 h-12 rounded-full bg-blue-500 text-white hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center group"
                                title="é‡æ–°æ•´ç†çµ±è¨ˆæ•¸æ“š"
                                aria-label="é‡æ–°æ•´ç†"
                            >
                                <i className={`fas fa-sync-alt text-lg transition-transform ${isLoadingCards ? 'animate-spin' : 'group-hover:rotate-180'}`}></i>
                            </button>
                        </div>
                    </div>

                    <DashboardCards counts={cardCounts} onClick={handleCardClick} isLoading={isLoadingCards} />

                    <FilterSection
                        filters={filters}
                        onFilterChange={handleFilterChange}
                        isAdmin={isAdmin}
                        allAssets={allAssets}
                    />

                    {/* æƒæå€åŸŸ - ä¾› Scanner æ¨¡çµ„ä½¿ç”¨ */}
                    <div id="Scanner_zone" className="scanner-zone mb-6" style={{ display: 'none' }}></div>

                    {/* æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•å¡ç‰‡ */}
                    <BatchActionButtons
                        onBatchTransfer={handleBatchTransfer}
                        onBatchLending={handleBatchLending}
                        onBatchScrap={handleBatchScrap}
                    />

                    {duplicateInfo.duplicateCount > 0 && (
                        <AlertBanner
                            count={duplicateInfo.duplicateCount}
                            onClick={() => window.openDuplicateAssetsModal()}
                        />
                    )}

                    <AssetTable
                        assets={filteredAssets}
                        isAdmin={isAdmin}
                        currentUserEmail={currentUserEmail}
                        onCancel={handleCancel}
                        onRestore={handleRestore}
                        onOpenTransferModal={handleOpenTransferModal}
                        onOpenLendingModal={handleOpenLendingModal}
                        onOpenScrapModal={handleOpenScrapModal}
                        selectedAssetIds={selectedAssetIds}
                        onAssetSelect={handleAssetSelect}
                        onSelectAll={handleSelectAll}
                    />

                    {activeModal === 'lent' && (
                        <LentAssetsModal
                            lentAssetsDetails={lentAssetsDetails}
                            isLoading={isLoadingLentDetails}
                            onClose={() => {
                                setActiveModal(null);
                                setLentAssetsDetails(null);
                            }}
                            onReturnSuccess={() => {
                                setActiveModal(null);
                                setLentAssetsDetails(null);
                                // åˆ·æ–°å¡ç‰‡æ•¸æ“šå’Œè³‡ç”¢è¡¨æ ¼
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'scrapPrint' && (
                        <ScrapPrintModal
                            details={scrapPendingDetails}
                            isLoading={isLoadingScrapDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'transferPrint' && (
                        <TransferPrintModal
                            details={transferPendingDetails}
                            isLoading={isLoadingTransferDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {/* å¿«é€Ÿæ“ä½œ Modal */}
                    {quickActionModalType === 'transfer' && (
                        <QuickTransferModal
                            asset={selectedAsset}
                            transferOptions={transferOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'lending' && (
                        <QuickLendingModal
                            asset={selectedAsset}
                            lendingOptions={lendingOptions}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {quickActionModalType === 'scrap' && (
                        <QuickScrapModal
                            asset={selectedAsset}
                            onClose={handleCloseQuickActionModal}
                            onSuccess={handleQuickActionSuccess}
                        />
                    )}

                    {/* æ‰¹æ¬¡æ“ä½œ Modal */}
                    {batchModalType === 'transfer' && (
                        <BatchTransferModal
                            transferOptions={transferOptions}
                            allAssets={allAssets}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'lending' && (
                        <BatchLendingModal
                            lendingOptions={lendingOptions}
                            allAssets={allAssets}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}

                    {batchModalType === 'scrap' && (
                        <BatchScrapModal
                            allAssets={allAssets}
                            onClose={handleCloseBatchModal}
                            onSuccess={handleBatchActionSuccess}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('react-root')).render(<App />);
    </script>
</body>
</html>
