<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .duplicate-group-row { background-color: #fff7e6; font-weight: 600; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>
    <?!= include('toast_progress'); ?>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div id="main-content">
        <h4>è²¡ç”¢ç‹€æ…‹æŸ¥è©¢</h4>
        
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="status-filter">ä¾ç‹€æ…‹ç¯©é¸ï¼š</label>
                <select id="status-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="category-filter">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸ï¼š</label>
                <select id="category-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div id="leader-filter-container" class="form-group col-md-3" style="display: none;">
                <label for="leader-filter">ä¾ä¿ç®¡äººç¯©é¸ï¼š</label>
                <select id="leader-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="search-box">é—œéµå­—æœå°‹ï¼š</label>
                <input type="text" id="search-box" class="form-control" placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€ä¿ç®¡äºº...">
            </div>
        </div>

        <div class="alert alert-warning justify-content-between align-items-center" id="pending-approval-banner" style="display:none;">
            <div>
                <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                <span id="pending-approval-text"></span>
            </div>
            <span class="text-primary">é»æ“Šæ­¤é€²è¡Œè™•ç†</span>
        </div>

        <div class="alert alert-warning py-2" id="duplicate-warning" style="display:none;"></div>

        <div id="table-container" class="table-container" style="display:none;">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 15%;">è²¡ç”¢ç·¨è™Ÿ</th>
                        <th style="width: 18%;">è²¡ç”¢åç¨±</th>
                        <th style="width: 13%;">å‹è™Ÿ/å» ç‰Œ</th>
                        <th style="width: 11%;">ä½¿ç”¨è€…</th>
                        <th style="width: 11%;">ä¿ç®¡äºº</th>
                        <th style="width: 11%;">ä¿ç®¡ä½ç½®</th>
                        <th style="width: 11%;">è²¡ç”¢é¡åˆ¥</th>
                        <th style="width: 7%;">ç‹€æ…‹</th>
                        <th style="width: 3%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="asset-list">
                </tbody>
            </table>
        </div>
        <div id="status-message"></div>
    </div>

    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">é‡è¤‡ç”¢ç·¨æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th>è²¡ç”¢åç¨±</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>ä¿ç®¡äºº</th>
                                    <th>ä¿ç®¡ä½ç½®</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingApprovalModal" tabindex="-1" role="dialog" aria-labelledby="pendingApprovalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pendingApprovalTitle">å¾…æ¥æ”¶è³‡ç”¢æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row mb-2">
                        <div class="form-group col-md-5">
                            <label for="pending-location-filter">ä¾åŸä¿ç®¡åœ°é»ç¯©é¸</label>
                            <select id="pending-location-filter" class="form-control">
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-7">
                            <label for="pending-search-box">é—œéµå­—æœå°‹ (ç”¢ç·¨/ç”¢å/åŸä¿ç®¡äºº)</label>
                            <input type="text" id="pending-search-box" class="form-control" placeholder="è¼¸å…¥é—œéµå­—">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 4%;"><input type="checkbox" id="pending-select-all"></th>
                                    <th style="width: 10%;">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th style="width: 11%;">è²¡ç”¢åç¨±</th>
                                    <th style="width: 12%;">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th style="width: 14%;">ä¿ç®¡äººè®Šæ›´</th>
                                    <th style="width: 14%;">ä½¿ç”¨äººè®Šæ›´</th>
                                    <th style="width: 13%;">åœ°é»è®Šæ›´</th>
                                    <th style="width: 11%;">è½‰ç§»é¡å‹</th>
                                    <th style="width: 11%;">ç”³è«‹æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="pending-approval-list"></tbody>
                        </table>
                    </div>
                    <div id="pending-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="submitPendingRejection()">æ‹’çµ•æ‰€é¸</button>
                    <button type="button" class="btn btn-success" onclick="submitPendingApproval()">æ¥å—æ‰€é¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allAssets = [];
        let isAdmin = false;
        let currentUserEmail = '';
        let webAppUrl = ''; // âœ¨ æ–°å¢ï¼šå„²å­˜ Web App çš„åŸºç¤ URL
        let duplicateGroups = [];
        let pendingApprovals = [];
        let filteredPendingApprovals = [];
        let pendingCurrentPage = 1;
        const pendingRowsPerPage = 50;

        document.addEventListener("DOMContentLoaded", () => {
            toggleTableVisibility(false);
            showFlyProgressBar('æ­£åœ¨è¼‰å…¥è²¡ç”¢ç‹€æ…‹è³‡æ–™...');
            google.script.run.withSuccessHandler(url => {
                webAppUrl = url; // âœ¨ ç²å– URL
                // ç¢ºä¿å…ˆå–å¾— URL å†è¼‰å…¥é é¢è³‡æ–™
                google.script.run
                    .withSuccessHandler(populatePage)
                    .withFailureHandler(showError)
                    .getUserStateData();
            }).getAppUrl();
        });

        function populatePage(response) {
            if (response.error) {
                showError({ message: response.error });
                return;
            }

            isAdmin = response.isAdmin;
            allAssets = response.assets;
            currentUserEmail = response.userEmail; // âœ¨ å„²å­˜ç•¶å‰ä½¿ç”¨è€… Email

            populateFilters(allAssets);

            if (isAdmin) {
                document.getElementById('leader-filter-container').style.display = 'block';
            }

            document.getElementById('status-filter').addEventListener('change', filterAndRender);
            document.getElementById('category-filter').addEventListener('change', filterAndRender);
            document.getElementById('leader-filter').addEventListener('change', filterAndRender);
            document.getElementById('search-box').addEventListener('input', filterAndRender);

            initPendingApprovalNotice();
            filterAndRender(); // åˆå§‹æ¸²æŸ“
            hideFlyProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
            setTimeout(() => {
                toggleTableVisibility(true);
            }, 300);
        }

        function populateFilters(assets) {
            const statusSet = new Set();
            const categorySet = new Set();
            const leaderSet = new Set();
            assets.forEach(asset => {
                statusSet.add(asset.status);
                categorySet.add(asset.category);
                if (isAdmin) leaderSet.add(asset.leader);
            });

            const statusFilter = document.getElementById('status-filter');
            statusFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
            statusSet.forEach(status => {
                if(status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                }
            });

            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
            categorySet.forEach(category => {
                if(category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });

            if (isAdmin) {
                const leaderFilter = document.getElementById('leader-filter');
                leaderFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>'; // æ¸…ç©ºèˆŠé¸é …
                leaderSet.forEach(leader => {
                    if(leader) {
                        const option = document.createElement('option');
                        option.value = leader;
                        option.textContent = leader;
                        leaderFilter.appendChild(option);
                    }
                });
            }
        }

        function filterAndRender() {
            const statusFilterValue = document.getElementById('status-filter').value;
            const categoryFilterValue = document.getElementById('category-filter').value;
            const leaderFilterValue = isAdmin ? document.getElementById('leader-filter').value : '';
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            const filteredAssets = allAssets.filter(asset => {
                const statusMatch = !statusFilterValue || asset.status === statusFilterValue;
                const categoryMatch = !categoryFilterValue || asset.category === categoryFilterValue;
                const leaderMatch = !leaderFilterValue || asset.leader === leaderFilterValue;
                const searchMatch = !searchValue || 
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.leader.toUpperCase().includes(searchValue);
                return statusMatch && categoryMatch && leaderMatch && searchMatch;
            });

            updateDuplicateWarning(filteredAssets);
            renderTable(filteredAssets);
        }

        function initPendingApprovalNotice() {
            loadPendingApprovals();
        }

        function loadPendingApprovals() {
            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.error) {
                        console.warn('è¼‰å…¥å¾…æ¥æ”¶æ¸…å–®å¤±æ•—ï¼š', response.error);
                        return;
                    }
                    pendingApprovals = (response && response.approvals) ? response.approvals : [];
                    updatePendingBanner();
                })
                .withFailureHandler(error => {
                    console.warn('è¼‰å…¥å¾…æ¥æ”¶æ¸…å–®å¤±æ•—ï¼š', error.message);
                })
                .getPendingApprovals();
        }

        function updatePendingBanner() {
            const banner = document.getElementById('pending-approval-banner');
            const text = document.getElementById('pending-approval-text');
            if (!banner || !text) return;

            if (pendingApprovals.length > 0) {
                text.textContent = `æ‚¨æœ‰ ${pendingApprovals.length} ç­†å¾…æ¥æ”¶è³‡ç”¢ï¼Œè«‹é»æ“Šæ­¤é€²è¡Œè™•ç†`;
                banner.style.display = 'flex';
                banner.classList.add('d-flex');
                banner.onclick = openPendingApprovalModal;
            } else {
                text.textContent = '';
                banner.style.display = 'none';
                banner.classList.remove('d-flex');
                banner.onclick = null;
            }
        }

        function openPendingApprovalModal() {
            if (!pendingApprovals || pendingApprovals.length === 0) return;

            if (!document.getElementById('pendingApprovalModal').dataset.initialized) {
                document.getElementById('pending-location-filter').addEventListener('change', filterPendingApprovals);
                document.getElementById('pending-search-box').addEventListener('input', filterPendingApprovals);
                document.getElementById('pending-select-all').addEventListener('change', (event) => {
                    document.querySelectorAll('.pending-approval-checkbox').forEach(cb => {
                        cb.checked = event.target.checked;
                    });
                });
                document.getElementById('pendingApprovalModal').dataset.initialized = 'true';
            }

            populatePendingFilters();
            filterPendingApprovals();
            $('#pendingApprovalModal').modal('show');
        }

        function populatePendingFilters() {
            const locationFilter = document.getElementById('pending-location-filter');
            locationFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            const uniqueLocations = [...new Set(pendingApprovals.map(item => item.oldLocation))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilter.appendChild(option);
            });
        }

        function filterPendingApprovals() {
            const locationFilter = document.getElementById('pending-location-filter').value.toUpperCase();
            const searchFilter = document.getElementById('pending-search-box').value.toUpperCase();

            filteredPendingApprovals = pendingApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation && item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    (item.oldKeeper && item.oldKeeper.toUpperCase().includes(searchFilter));
                return locationMatch && searchMatch;
            });

            pendingCurrentPage = 1;
            renderPendingPage(pendingCurrentPage);
        }

        function renderPendingPage(page) {
            pendingCurrentPage = page;
            const listBody = document.getElementById('pending-approval-list');
            const pagination = document.getElementById('pending-pagination');
            listBody.innerHTML = '';

            if (filteredPendingApprovals.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;  // æ›´æ–°ç‚º 9 æ¬„ï¼ˆå¢åŠ äº†å‹è™Ÿ/å» ç‰Œï¼‰
                cell.className = 'text-center text-muted';
                cell.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚';
                row.appendChild(cell);
                listBody.appendChild(row);
                pagination.textContent = '';
                return;
            }

            const start = (page - 1) * pendingRowsPerPage;
            const end = start + pendingRowsPerPage;
            const items = filteredPendingApprovals.slice(start, end);

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const row = document.createElement('tr');

                // Checkbox å„²å­˜æ ¼
                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pending-approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                // è³‡ç”¢ç·¨è™Ÿå’Œåç¨±
                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                // å‹è™Ÿ/å» ç‰Œ
                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹è®Šæ›´é¡¯ç¤ºå„²å­˜æ ¼ï¼ˆèˆ‡ review.html ä¸€è‡´ï¼‰
                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                // ä¿ç®¡äººè®Šæ›´
                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                // ä½¿ç”¨äººè®Šæ›´
                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                // åœ°é»è®Šæ›´
                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                // è½‰ç§»é¡å‹ Badgeï¼ˆèˆ‡ review.html ä¸€è‡´ï¼‰
                const transferType = item.transferType || 'åœ°é»';
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                } else if (transferType.includes('ä¿ç®¡äºº')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                } else if (transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = 'åœ°é»';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                // ç”³è«‹æ™‚é–“
                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                fragment.appendChild(row);
            });

            listBody.appendChild(fragment);
            renderPendingPagination();
            document.getElementById('pending-select-all').checked = false;
        }

        function renderPendingPagination() {
            const pagination = document.getElementById('pending-pagination');
            const totalPages = Math.ceil(filteredPendingApprovals.length / pendingRowsPerPage);

            if (filteredPendingApprovals.length === 0) {
                pagination.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                pagination.innerHTML = `<span class="text-muted">å…± ${filteredPendingApprovals.length} ç­†è³‡æ–™</span>`;
                return;
            }

            const info = document.createElement('span');
            info.className = 'text-muted';
            info.textContent = `å…± ${filteredPendingApprovals.length} ç­†è³‡æ–™ï¼Œç¬¬ ${pendingCurrentPage} / ${totalPages} é `;

            const nav = document.createElement('ul');
            nav.className = 'pagination mb-0';

            const prev = document.createElement('li');
            prev.className = `page-item ${pendingCurrentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.textContent = 'ä¸Šä¸€é ';
            prevLink.addEventListener('click', () => {
                if (pendingCurrentPage > 1) renderPendingPage(pendingCurrentPage - 1);
            });
            prev.appendChild(prevLink);

            const next = document.createElement('li');
            next.className = `page-item ${pendingCurrentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.textContent = 'ä¸‹ä¸€é ';
            nextLink.addEventListener('click', () => {
                if (pendingCurrentPage < totalPages) renderPendingPage(pendingCurrentPage + 1);
            });
            next.appendChild(nextLink);

            nav.appendChild(prev);
            nav.appendChild(next);

            pagination.innerHTML = '';
            pagination.appendChild(info);
            pagination.appendChild(nav);
        }

        function submitPendingApproval() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ¥æ”¶ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    loadPendingApprovals();
                    refreshUserStateData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchApproval(selected);
        }

        function submitPendingRejection() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦æ‹’çµ•æ‰€é¸çš„ ${selected.length} ç­†å¾…æ¥æ”¶è³‡ç”¢å—ï¼Ÿ`)) {
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ‹’çµ•ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    loadPendingApprovals();
                    refreshUserStateData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchRejection(selected);
        }

        function refreshUserStateData() {
            google.script.run
                .withSuccessHandler(response => {
                    if (response.error) {
                        showError({ message: response.error });
                        return;
                    }
                    allAssets = response.assets;
                    isAdmin = response.isAdmin;
                    currentUserEmail = response.userEmail;
                    filterAndRender();
                })
                .withFailureHandler(showError)
                .getUserStateData();
        }

        function updateDuplicateWarning(assets) {
            const warningEl = document.getElementById('duplicate-warning');
            if (!warningEl) return;

            const result = dedupeAssets(assets);
            duplicateGroups = result.duplicateGroups;

            if (result.duplicateCount > 0) {
                warningEl.innerHTML = `åµæ¸¬åˆ° ${result.duplicateCount} ç­†é‡è¤‡ç”¢ç·¨ã€‚<span class="text-primary ml-2">é»æ“ŠæŸ¥çœ‹è©³æƒ…</span>`;
                warningEl.style.display = 'block';
                warningEl.style.cursor = 'pointer';
                warningEl.onclick = openDuplicateAssetsModal;
            } else {
                warningEl.textContent = '';
                warningEl.style.display = 'none';
                warningEl.style.cursor = '';
                warningEl.onclick = null;
            }
        }

        function dedupeAssets(assets) {
            const map = new Map();
            const duplicates = new Map();
            let duplicateCount = 0;

            assets.forEach(asset => {
                const key = String(asset.assetId || '').trim();
                if (map.has(key)) {
                    duplicateCount += 1;
                    const existing = map.get(key);
                    if (!duplicates.has(key)) {
                        duplicates.set(key, [existing]);
                    }
                    duplicates.get(key).push(asset);
                } else {
                    map.set(key, asset);
                }
            });

            const duplicateGroups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                assetId: assetId,
                items: items
            }));

            return {
                duplicateCount: duplicateCount,
                duplicateGroups: duplicateGroups
            };
        }

        function openDuplicateAssetsModal() {
            if (!duplicateGroups || duplicateGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = duplicateGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `å…± ${totalGroups} çµ„ï¼Œ${totalRows} ç­†è³‡ç”¢`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `ç”¢ç·¨ï¼š${group.assetId || '(ç©ºç™½)'}ï¼ˆ${group.items.length} ç­†ï¼‰`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.leader,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }

        function renderTable(assets) {
            const listBody = document.getElementById('asset-list');
            listBody.innerHTML = '';

            if (!assets || assets.length === 0) {
                listBody.innerHTML = '<tr><td colspan="8" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</td></tr>';
                return;
            }

            const statusColors = {
                'åœ¨åº«': 'badge-success',
                'å‡ºå€Ÿä¸­': 'badge-warning',
                'å ±å»¢ä¸­': 'badge-danger',
                'å·²å ±å»¢': 'badge-secondary',
                'è½‰ç§»ä¸­': 'badge-primary',
                'å¾…æ¥æ”¶': 'badge-primary'
            };

            // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
            assets.forEach(asset => {
                const row = document.createElement('tr');
                const statusColor = statusColors[asset.status] || 'badge-info';
                const canCancel = isAdmin || currentUserEmail === asset.leaderEmail || currentUserEmail === asset.userEmail;

                // ä½¿ç”¨ textContent å®‰å…¨è¨­å®šæ–‡å­—å…§å®¹
                const cells = [
                    asset.assetId,
                    asset.assetName,
                    asset.modelBrand,
                    asset.userName,
                    asset.leader,
                    asset.location,
                    asset.category
                ];

                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData || '';
                    row.appendChild(td);
                });

                // ç‹€æ…‹ Badge
                const statusTd = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${statusColor}`;
                badge.textContent = asset.status;
                statusTd.appendChild(badge);
                row.appendChild(statusTd);

                // æ“ä½œæŒ‰éˆ•ï¼ˆä½¿ç”¨ addEventListener æ›¿ä»£ onclickï¼‰
                const actionTd = document.createElement('td');

                // åŸæœ‰çš„å–æ¶ˆé‚è¼¯ï¼ˆå¾…æ¥æ”¶/è½‰ç§»ä¸­/å ±å»¢ä¸­ï¼‰
                if (canCancel && (asset.status === 'å¾…æ¥æ”¶' || asset.status === 'è½‰ç§»ä¸­' || asset.status === 'å ±å»¢ä¸­')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-sm btn-danger';
                    cancelBtn.textContent = 'å–æ¶ˆ';
                    // ä½¿ç”¨é–‰åŒ…å®‰å…¨å‚³éåƒæ•¸ï¼Œé¿å… XSS
                    cancelBtn.addEventListener('click', () => promptCancel(asset.assetId, asset.status));
                    actionTd.appendChild(cancelBtn);
                }

                // æ–°å¢ï¼šå·²å ±å»¢ç‹€æ…‹çš„å›æº¯æŒ‰éˆ•ï¼ˆåƒ…é™ç®¡ç†å“¡ï¼‰
                if (isAdmin && asset.status === 'å·²å ±å»¢') {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.className = 'btn btn-sm btn-warning';
                    restoreBtn.textContent = 'å›æº¯';
                    restoreBtn.addEventListener('click', () => promptRestore(asset.assetId));
                    actionTd.appendChild(restoreBtn);
                }

                row.appendChild(actionTd);

                listBody.appendChild(row);
            });
        }

        // âœ¨ æ–°å¢ï¼šå–æ¶ˆæŒ‰éˆ•çš„è™•ç†å‡½å¼
        function promptCancel(assetId, status) {
            const confirmation = confirm(`æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­† [${status}] ç‹€æ…‹çš„ç”³è«‹å—ï¼Ÿ\n\nè²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\næ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`);
            if (confirmation) {
                toggleTableVisibility(false);
                showFlyProgressBar('æ­£åœ¨å–æ¶ˆç”³è«‹...');
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            // 1. å…ˆè®“é€²åº¦æ¢å®Œæˆï¼ˆè·‘åˆ° 100% ä¸¦é¡¯ç¤ºå®Œæˆæ–‡å­—ï¼‰
                            hideFlyProgressBar('å–æ¶ˆå®Œæˆï¼', 300);
                            toggleTableVisibility(false);

                            // 2. ç­‰å¾…é€²åº¦æ¢å®Œå…¨éš±è—å¾Œï¼ˆ300ms + 100ms ç·©è¡ï¼‰å†å½ˆå‡º alert
                            setTimeout(() => {
                                alert('ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚');

                                // 3. ç”¨æˆ¶æŒ‰ OK å¾Œï¼Œé¡¯ç¤ºæ–°çš„è¼‰å…¥å‹•ç•«é‡æ–°è¼‰å…¥è³‡æ–™
                                toggleTableVisibility(false);
                                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                                google.script.run
                                    .withSuccessHandler(populatePage)
                                    .withFailureHandler(showError)
                                    .getUserStateData();
                            }, 400); // ç¸½å»¶é²ï¼š300ms (é€²åº¦æ¢éš±è—) + 100ms (ç·©è¡)
                        } else {
                            hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                            showError({ message: response.error });
                        }
                    })
                    .withFailureHandler(showError)
                    .cancelTransferOrScrap(assetId);
            }
        }

        /**
         * è™•ç†ã€Œå·²å ±å»¢ã€è³‡ç”¢çš„å›æº¯æ“ä½œï¼ˆåƒ…é™ç®¡ç†å“¡ï¼‰
         * @param {string} assetId - è³‡ç”¢ç·¨è™Ÿ
         */
        function promptRestore(assetId) {
            const confirmation = confirm(
                `æ‚¨ç¢ºå®šè¦å°‡æ­¤ã€Œå·²å ±å»¢ã€è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                `æ³¨æ„ï¼šæ­¤æ“ä½œæœƒä¿ç•™åŸå ±å»¢è¨˜éŒ„ä¸¦æ·»åŠ å›æº¯æ¨™è¨˜ã€‚`
            );

            if (!confirmation) return;

            // éš±è—è¡¨æ ¼ï¼Œé¡¯ç¤ºé€²åº¦æ¢
            toggleTableVisibility(false);
            showFlyProgressBar('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');

            // èª¿ç”¨å¾Œç«¯å‡½æ•¸ï¼ˆæ³¨æ„ï¼šå‚³éæ•¸çµ„ï¼‰
            google.script.run
                .withSuccessHandler(handleRestoreSuccess)
                .withFailureHandler(handleRestoreError)
                .restoreFromScrap([assetId]);  // âš ï¸ é—œéµï¼šå‚³éå–®å…ƒç´ æ•¸çµ„
        }

        /**
         * è™•ç†å›æº¯æˆåŠŸçš„éŸ¿æ‡‰
         * @param {Object} result - å¾Œç«¯è¿”å›çš„ç‰©ä»¶ { success, message, count, failed }
         */
        function handleRestoreSuccess(result) {
            // æ­¥é©Ÿ 1ï¼šå®Œæˆé€²åº¦æ¢ï¼ˆè·‘åˆ° 100% ä¸¦é¡¯ç¤ºå®Œæˆæ–‡å­—ï¼‰
            hideFlyProgressBar('å›æº¯å®Œæˆï¼', 300);
            toggleTableVisibility(false);

            // æ­¥é©Ÿ 2ï¼šç­‰å¾…é€²åº¦æ¢å®Œå…¨éš±è—å¾Œå½ˆå‡º alertï¼ˆ300ms éš±è— + 100ms ç·©è¡ï¼‰
            setTimeout(() => {
                // ç›´æ¥é¡¯ç¤ºå¾Œç«¯è¿”å›çš„è¨Šæ¯
                alert(result.message);

                // æ­¥é©Ÿ 3ï¼šç„¡è«–æˆåŠŸèˆ‡å¦ï¼Œéƒ½é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
                // (å³ä½¿å›æº¯å¤±æ•—ï¼Œä¹Ÿå¯èƒ½å› ç‚ºç‹€æ…‹å·²ç¶“è®Šæ›´ï¼Œæ‰€ä»¥é‡è¼‰æ˜¯å®‰å…¨çš„)
                toggleTableVisibility(false);
                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                google.script.run
                    .withSuccessHandler(populatePage)
                    .withFailureHandler(showError)
                    .getUserStateData();
            }, 400); // ç¸½å»¶é²ï¼š300ms (é€²åº¦æ¢éš±è—) + 100ms (ç·©è¡)
        }

        /**
         * è™•ç†å›æº¯å¤±æ•—çš„éŒ¯èª¤ (ç³»çµ±éŒ¯èª¤æˆ–ä¾‹å¤–)
         * @param {Object} error - éŒ¯èª¤å°è±¡
         */
        function handleRestoreError(error) {
            hideFlyProgressBar('å›æº¯å¤±æ•—', 0);
            alert('éŒ¯èª¤ï¼š' + (error.message || 'å›æº¯æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'));
            // âš ï¸ é—œéµä¿®å¾©ï¼šéŒ¯èª¤å¾Œæ¢å¾©è¡¨æ ¼é¡¯ç¤ºï¼Œé¿å… UI å¡æ­»
            toggleTableVisibility(true);
        }

        /**
         * çµ±ä¸€æ§åˆ¶è¡¨æ ¼çš„é¡¯ç¤º/éš±è—
         * @param {boolean} show - true é¡¯ç¤ºè¡¨æ ¼ï¼Œfalse éš±è—è¡¨æ ¼
         */
        function toggleTableVisibility(show) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.style.display = show ? 'block' : 'none';
        }

        function showError(error) {
            hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = 'éŒ¯èª¤ï¼š' + error.message;
        }
    </script>
</body>
</html>
