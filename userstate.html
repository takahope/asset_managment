<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Bootstrap CSS (åƒ…ç”¨æ–¼ Modal) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* é…åˆ shared-nav å´é‚Šæ¬„ */
        .duplicate-group-row {
            background-color: #fff7e6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_fly'); ?>
    <?!= include('toast_progress'); ?>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div id="react-root"></div>

    <!-- Bootstrap Modals (ä¿ç•™ç¾æœ‰çµæ§‹) -->
    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">é‡è¤‡ç”¢ç·¨æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th>è²¡ç”¢åç¨±</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>ä¿ç®¡äºº</th>
                                    <th>ä¿ç®¡ä½ç½®</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingApprovalModal" tabindex="-1" role="dialog" aria-labelledby="pendingApprovalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pendingApprovalTitle">å¾…æ¥æ”¶è³‡ç”¢æ¸…å–®</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row mb-2">
                        <div class="form-group col-md-5">
                            <label for="pending-location-filter">ä¾åŸä¿ç®¡åœ°é»ç¯©é¸</label>
                            <select id="pending-location-filter" class="form-control">
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                            </select>
                        </div>
                        <div class="form-group col-md-7">
                            <label for="pending-search-box">é—œéµå­—æœå°‹ (ç”¢ç·¨/ç”¢å/åŸä¿ç®¡äºº)</label>
                            <input type="text" id="pending-search-box" class="form-control" placeholder="è¼¸å…¥é—œéµå­—">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th style="width: 4%;"><input type="checkbox" id="pending-select-all"></th>
                                    <th style="width: 10%;">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th style="width: 11%;">è²¡ç”¢åç¨±</th>
                                    <th style="width: 12%;">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th style="width: 14%;">ä¿ç®¡äººè®Šæ›´</th>
                                    <th style="width: 14%;">ä½¿ç”¨äººè®Šæ›´</th>
                                    <th style="width: 13%;">åœ°é»è®Šæ›´</th>
                                    <th style="width: 11%;">è½‰ç§»é¡å‹</th>
                                    <th style="width: 11%;">ç”³è«‹æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="pending-approval-list"></tbody>
                        </table>
                    </div>
                    <div id="pending-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="submitPendingRejection()">æ‹’çµ•æ‰€é¸</button>
                    <button type="button" class="btn btn-success" onclick="submitPendingApproval()">æ¥å—æ‰€é¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨åŸŸå‡½æ•¸æ©‹æ¥ jQuery Modal -->
    <script>
        // å…¨åŸŸè®Šæ•¸ä¾› React èˆ‡ jQuery å…±äº«
        window.pendingApprovals = [];
        window.filteredPendingApprovals = [];
        window.pendingCurrentPage = 1;
        window.pendingRowsPerPage = 50;
        window.duplicateGroups = [];

        window.openPendingApprovalModal = () => {
            if (!window.pendingApprovals || window.pendingApprovals.length === 0) return;

            if (!document.getElementById('pendingApprovalModal').dataset.initialized) {
                document.getElementById('pending-location-filter').addEventListener('change', filterPendingApprovals);
                document.getElementById('pending-search-box').addEventListener('input', filterPendingApprovals);
                document.getElementById('pending-select-all').addEventListener('change', (event) => {
                    document.querySelectorAll('.pending-approval-checkbox').forEach(cb => {
                        cb.checked = event.target.checked;
                    });
                });
                document.getElementById('pendingApprovalModal').dataset.initialized = 'true';
            }

            populatePendingFilters();
            filterPendingApprovals();
            $('#pendingApprovalModal').modal('show');
        };

        window.openDuplicateAssetsModal = () => {
            if (!window.duplicateGroups || window.duplicateGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        };

        function populatePendingFilters() {
            const locationFilter = document.getElementById('pending-location-filter');
            locationFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            const uniqueLocations = [...new Set(window.pendingApprovals.map(item => item.oldLocation))].filter(Boolean).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilter.appendChild(option);
            });
        }

        function filterPendingApprovals() {
            const locationFilter = document.getElementById('pending-location-filter').value.toUpperCase();
            const searchFilter = document.getElementById('pending-search-box').value.toUpperCase();

            window.filteredPendingApprovals = window.pendingApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation && item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    (item.oldKeeper && item.oldKeeper.toUpperCase().includes(searchFilter));
                return locationMatch && searchMatch;
            });

            window.pendingCurrentPage = 1;
            renderPendingPage(window.pendingCurrentPage);
        }

        function renderPendingPage(page) {
            window.pendingCurrentPage = page;
            const listBody = document.getElementById('pending-approval-list');
            const pagination = document.getElementById('pending-pagination');
            listBody.innerHTML = '';

            if (window.filteredPendingApprovals.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚';
                row.appendChild(cell);
                listBody.appendChild(row);
                pagination.textContent = '';
                return;
            }

            const start = (page - 1) * window.pendingRowsPerPage;
            const end = start + window.pendingRowsPerPage;
            const items = window.filteredPendingApprovals.slice(start, end);

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const row = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pending-approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                const transferType = item.transferType || 'åœ°é»';
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                } else if (transferType.includes('ä¿ç®¡äºº')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                } else if (transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = 'åœ°é»';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                fragment.appendChild(row);
            });

            listBody.appendChild(fragment);
            renderPendingPagination();
            document.getElementById('pending-select-all').checked = false;
        }

        function renderPendingPagination() {
            const pagination = document.getElementById('pending-pagination');
            const totalPages = Math.ceil(window.filteredPendingApprovals.length / window.pendingRowsPerPage);

            if (window.filteredPendingApprovals.length === 0) {
                pagination.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                pagination.innerHTML = `<span class="text-muted">å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™</span>`;
                return;
            }

            const info = document.createElement('span');
            info.className = 'text-muted';
            info.textContent = `å…± ${window.filteredPendingApprovals.length} ç­†è³‡æ–™ï¼Œç¬¬ ${window.pendingCurrentPage} / ${totalPages} é `;

            const nav = document.createElement('ul');
            nav.className = 'pagination mb-0';

            const prev = document.createElement('li');
            prev.className = `page-item ${window.pendingCurrentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.textContent = 'ä¸Šä¸€é ';
            prevLink.addEventListener('click', () => {
                if (window.pendingCurrentPage > 1) renderPendingPage(window.pendingCurrentPage - 1);
            });
            prev.appendChild(prevLink);

            const next = document.createElement('li');
            next.className = `page-item ${window.pendingCurrentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.textContent = 'ä¸‹ä¸€é ';
            nextLink.addEventListener('click', () => {
                if (window.pendingCurrentPage < totalPages) renderPendingPage(window.pendingCurrentPage + 1);
            });
            next.appendChild(nextLink);

            nav.appendChild(prev);
            nav.appendChild(next);

            pagination.innerHTML = '';
            pagination.appendChild(info);
            pagination.appendChild(nav);
        }

        function submitPendingApproval() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ¥æ”¶ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchApproval(selected);
        }

        function submitPendingRejection() {
            const selected = Array.from(document.querySelectorAll('.pending-approval-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦æ‹’çµ•æ‰€é¸çš„ ${selected.length} ç­†å¾…æ¥æ”¶è³‡ç”¢å—ï¼Ÿ`)) {
                return;
            }

            showToastProgress('æ­£åœ¨è™•ç†æ‹’çµ•ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(message => {
                    hideToastProgress('è™•ç†å®Œæˆï¼', 300);
                    $('#pendingApprovalModal').modal('hide');
                    alert(message);
                    window.refreshReactData && window.refreshReactData();
                })
                .withFailureHandler(error => {
                    hideToastProgress('è™•ç†å¤±æ•—ï¼', 300);
                    alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                })
                .processBatchRejection(selected);
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = window.duplicateGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `å…± ${totalGroups} çµ„ï¼Œ${totalRows} ç­†è³‡ç”¢`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `ç”¢ç·¨ï¼š${group.assetId || '(ç©ºç™½)'}ï¼ˆ${group.items.length} ç­†ï¼‰`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.leader,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }
    </script>

    <!-- React æ‡‰ç”¨ -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // Icons (åƒè€ƒ onepage_example.html)
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const SearchIcon = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;

        // LoadingCard çµ„ä»¶ - å¡ç‰‡è¼‰å…¥ä½”ä½ç¬¦ï¼ˆæ°´å¹³é•·æ–¹å½¢æ¨£å¼ï¼‰
        const LoadingCard = () => (
            <div className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm">
                <div className="flex items-center gap-3">
                    <div className="flex flex-col items-center gap-1">
                        <div className="w-5 h-5 bg-slate-200 rounded animate-pulse"></div>
                        <div className="w-1.5 h-6 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="h-4 bg-slate-200 rounded w-16 mb-1 animate-pulse"></div>
                        <div className="h-3 bg-slate-100 rounded w-24 animate-pulse"></div>
                    </div>
                    <div className="w-8 h-7 bg-slate-200 rounded animate-pulse"></div>
                </div>
            </div>
        );

        // DashboardCards çµ„ä»¶
        const DashboardCards = ({ counts, onClick, isLoading }) => {
            // è¼‰å…¥ç‹€æ…‹æ¸²æŸ“
            if (isLoading) {
                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                        {[1, 2, 3, 4, 5].map(i => <LoadingCard key={i} />)}
                    </div>
                );
            }

            const cards = [
                {
                    id: 'pending',
                    label: 'å¾…æ¥æ”¶',
                    count: counts.pending,
                    color: 'bg-blue-500',
                    icon: 'ğŸ“¥',
                    description: 'éœ€è¦æ‚¨ç¢ºèªæ¥æ”¶çš„è³‡ç”¢'
                },
                {
                    id: 'lent',
                    label: 'å‡ºå€Ÿä¸­',
                    count: counts.lent,
                    color: 'bg-green-500',
                    icon: 'ğŸ“¤',
                    description: 'ç›®å‰å‡ºå€Ÿçš„è³‡ç”¢'
                },
                {
                    id: 'scrapPending',
                    label: 'å¾…åˆ—å°å ±å»¢ç”³è«‹å–®',
                    count: counts.scrapPending,
                    color: 'bg-orange-500',
                    icon: 'ğŸ—‘ï¸',
                    description: 'å ±å»¢ä¸­çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'transferPending',
                    label: 'å¾…åˆ—å°è½‰ç§»ç”³è«‹å–®',
                    count: counts.transferPending,
                    color: 'bg-purple-500',
                    icon: 'ğŸ”„',
                    description: 'å·²è¢«æ¥æ”¶çš„è³‡ç”¢ï¼ˆéœ€åˆ—å°è½‰ç§»ç”³è«‹å–®ï¼‰'
                },
                {
                    id: 'inventory',
                    label: 'å¾…ç›¤é»',
                    count: counts.inventory,
                    color: 'bg-red-500',
                    icon: 'ğŸ“‹',
                    description: 'éœ€è¦æ‚¨å®Œæˆçš„ç›¤é»ä»»å‹™'
                }
            ];

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                    {cards.map(card => (
                        <button
                            key={card.id}
                            onClick={() => onClick(card.id)}
                            className="bg-white px-4 py-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-slate-300 transition-all cursor-pointer text-left group"
                        >
                            <div className="flex items-center gap-3">
                                {/* å·¦å´ï¼šåœ–æ¨™èˆ‡å½©è‰²æŒ‡ç¤ºæ¢ */}
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-xl">{card.icon}</span>
                                    <div className={`w-1.5 h-6 rounded-full ${card.color} opacity-80`}></div>
                                </div>
                                {/* ä¸­é–“ï¼šæ¨™é¡Œèˆ‡æè¿° */}
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-slate-600 group-hover:text-slate-800 transition-colors">{card.label}</p>
                                    <p className="text-xs text-slate-400 whitespace-pre-wrap" title={card.description}>{card.description}</p>
                                </div>
                                {/* å³å´ï¼šæ•¸å­— */}
                                <div className="text-2xl font-bold text-slate-800 tabular-nums">
                                    {card.count}
                                </div>
                            </div>
                        </button>
                    ))}
                </div>
            );
        };

        // FilterSection çµ„ä»¶
        const FilterSection = ({ filters, onFilterChange, isAdmin, allAssets }) => {
            const statusOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.status))].filter(Boolean).sort()
            , [allAssets]);

            const categoryOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.category))].filter(Boolean).sort()
            , [allAssets]);

            const leaderOptions = useMemo(() =>
                [...new Set(allAssets.map(a => a.leader))].filter(Boolean).sort()
            , [allAssets]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ç‹€æ…‹ç¯©é¸</label>
                            <select
                                value={filters.status}
                                onChange={(e) => onFilterChange('status', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {statusOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸</label>
                            <select
                                value={filters.category}
                                onChange={(e) => onFilterChange('category', e.target.value)}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                {categoryOptions.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>

                        {isAdmin && (
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ä¾ä¿ç®¡äººç¯©é¸</label>
                                <select
                                    value={filters.leader}
                                    onChange={(e) => onFilterChange('leader', e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                    {leaderOptions.map(opt => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">é—œéµå­—æœå°‹</label>
                            <div className="relative">
                                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                <input
                                    type="text"
                                    value={filters.search}
                                    onChange={(e) => onFilterChange('search', e.target.value)}
                                    placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€ä¿ç®¡äºº..."
                                    className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // AlertBanner çµ„ä»¶
        const AlertBanner = ({ count, onClick }) => (
            <div
                className="bg-yellow-50 border-l-4 border-yellow-400 py-2 px-4 mb-6 cursor-pointer hover:bg-yellow-100 transition-colors"
                onClick={onClick}
            >
                <div className="flex items-center">
                    <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span className="text-yellow-800">
                        åµæ¸¬åˆ° {count} ç­†é‡è¤‡ç”¢ç·¨ã€‚
                        <span className="text-blue-600 ml-2 underline">é»æ“ŠæŸ¥çœ‹è©³æƒ…</span>
                    </span>
                </div>
            </div>
        );

        // AssetTable çµ„ä»¶
        const AssetTable = ({ assets, isAdmin, currentUserEmail, onCancel, onRestore }) => {
            const statusColors = {
                'åœ¨åº«': 'bg-green-50 text-green-700 border-green-200',
                'å‡ºå€Ÿä¸­': 'bg-yellow-50 text-yellow-700 border-yellow-200',
                'å ±å»¢ä¸­': 'bg-red-50 text-red-700 border-red-200',
                'å·²å ±å»¢': 'bg-gray-50 text-gray-700 border-gray-200',
                'è½‰ç§»ä¸­': 'bg-blue-50 text-blue-700 border-blue-200',
                'å¾…æ¥æ”¶': 'bg-purple-50 text-purple-700 border-purple-200'
            };

            if (!assets || assets.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                        <p className="text-slate-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 sticky top-0">
                                <tr>
                                    <th className="px-4 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢ç·¨è™Ÿ</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 min-w-[200px]">è²¡ç”¢åç¨±</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 min-w-[150px]">å‹è™Ÿ/å» ç‰Œ</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 whitespace-nowrap">ä½¿ç”¨è€…</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 whitespace-nowrap">ä¿ç®¡äºº</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 min-w-[120px]">ä¿ç®¡ä½ç½®</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 whitespace-nowrap">è²¡ç”¢é¡åˆ¥</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 whitespace-nowrap">ç‹€æ…‹</th>
                                    <th className="px-4 py-3 font-semibold text-slate-600 text-right whitespace-nowrap">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {assets.map((asset, index) => {
                                    const canCancel = isAdmin ||
                                                    currentUserEmail === asset.leaderEmail ||
                                                    currentUserEmail === asset.userEmail;

                                    return (
                                        <tr key={`${asset.assetId}-${index}`} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-4 py-3 font-mono text-slate-600 whitespace-nowrap align-top">{asset.assetId}</td>
                                            <td className="px-4 py-3 font-medium text-slate-800 align-top">
                                                <div className="line-clamp-2" title={asset.assetName}>{asset.assetName}</div>
                                            </td>
                                            <td className="px-4 py-3 text-slate-600 align-top">
                                                <div className="line-clamp-2" title={asset.modelBrand}>{asset.modelBrand || '-'}</div>
                                            </td>
                                            <td className="px-4 py-3 text-slate-600 whitespace-nowrap align-top">{asset.userName}</td>
                                            <td className="px-4 py-3 text-slate-600 whitespace-nowrap align-top">{asset.leader}</td>
                                            <td className="px-4 py-3 text-slate-600 align-top">
                                                <div className="line-clamp-2" title={asset.location}>{asset.location}</div>
                                            </td>
                                            <td className="px-4 py-3 text-slate-600 align-top">
                                                <span className="bg-slate-100 px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    {asset.category}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 align-top">
                                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border whitespace-nowrap ${statusColors[asset.status] || 'bg-slate-100 text-slate-700 border-slate-200'}`}>
                                                    {asset.status}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-right align-top whitespace-nowrap">
                                                {canCancel && (asset.status === 'å¾…æ¥æ”¶' || asset.status === 'è½‰ç§»ä¸­' || asset.status === 'å ±å»¢ä¸­') && (
                                                    <button
                                                        onClick={() => onCancel(asset.assetId, asset.status)}
                                                        className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                                                    >
                                                        å–æ¶ˆ
                                                    </button>
                                                )}
                                                {isAdmin && asset.status === 'å·²å ±å»¢' && (
                                                    <button
                                                        onClick={() => onRestore(asset.assetId)}
                                                        className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm font-medium ml-2"
                                                    >
                                                        å›æº¯
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // React Modals
        const LentAssetsModal = ({ lentAssetsDetails, isLoading, onClose, onReturnSuccess }) => {
            const [selectedLendIds, setSelectedLendIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filters, setFilters] = useState({
                location: '',
                startDate: '',
                endDate: '',
                overdueOnly: '',
                search: ''
            });

            // ç•¶ lentAssetsDetails æ”¹è®Šæ™‚ï¼Œé‡ç½®å‹¾é¸ç‹€æ…‹
            useEffect(() => {
                setSelectedLendIds([]);
                setSelectAll(false);
            }, [lentAssetsDetails]);

            // ç¯©é¸é‚è¼¯
            const filteredAssets = useMemo(() => {
                if (!lentAssetsDetails) return [];

                return lentAssetsDetails.filter(asset => {
                    // åœ°é»ç¯©é¸
                    const matchLocation = !filters.location || asset.lendingLocation === filters.location;

                    // æ—¥æœŸç¯„åœç¯©é¸
                    const returnDate = new Date(asset.expectedReturnDate);
                    const matchDateRange =
                        (!filters.startDate || returnDate >= new Date(filters.startDate)) &&
                        (!filters.endDate || returnDate <= new Date(filters.endDate));

                    // é€¾æœŸç‹€æ…‹ç¯©é¸
                    let matchOverdue = true;
                    if (filters.overdueOnly === 'overdue' || filters.overdueOnly === 'notOverdue') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const assetReturnDate = new Date(asset.expectedReturnDate);
                        assetReturnDate.setHours(0, 0, 0, 0);
                        const isOverdue = assetReturnDate < today;
                        matchOverdue = filters.overdueOnly === 'overdue' ? isOverdue : !isOverdue;
                    }

                    // é—œéµå­—æœå°‹
                    const matchSearch =
                        !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.borrower.toUpperCase().includes(filters.search.toUpperCase()) ||
                        (asset.reason && asset.reason.toUpperCase().includes(filters.search.toUpperCase()));

                    return matchLocation && matchDateRange && matchOverdue && matchSearch;
                });
            }, [lentAssetsDetails, filters]);

            // å–å¾—å”¯ä¸€åœ°é»åˆ—è¡¨ï¼ˆç”¨æ–¼ç¯©é¸ä¸‹æ‹‰é¸å–®ï¼‰
            const uniqueLocations = useMemo(() => {
                if (!lentAssetsDetails) return [];
                return [...new Set(lentAssetsDetails.map(a => a.lendingLocation).filter(Boolean))].sort();
            }, [lentAssetsDetails]);

            // è™•ç†å…¨é¸
            const handleSelectAll = useCallback((e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedLendIds(filteredAssets.map(asset => asset.lendId));
                } else {
                    setSelectedLendIds([]);
                }
            }, [filteredAssets]);

            // è™•ç†å–®å€‹å‹¾é¸
            const handleCheckboxChange = useCallback((lendId) => {
                setSelectedLendIds(prev => {
                    if (prev.includes(lendId)) {
                        const newSelected = prev.filter(id => id !== lendId);
                        if (filteredAssets && newSelected.length < filteredAssets.length) {
                            setSelectAll(false);
                        }
                        return newSelected;
                    } else {
                        const newSelected = [...prev, lendId];
                        if (filteredAssets && newSelected.length === filteredAssets.length) {
                            setSelectAll(true);
                        }
                        return newSelected;
                    }
                });
            }, [filteredAssets]);

            // è™•ç†æ­¸é‚„æäº¤
            const handleSubmitReturn = useCallback(() => {
                if (selectedLendIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è¦æ­¸é‚„çš„é …ç›®ã€‚');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦æ­¸é‚„æ‰€é¸çš„ ${selectedLendIds.length} ç­†è³‡ç”¢å—ï¼Ÿ\n\nâš ï¸ è«‹ç¢ºèªæ­¤è³‡ç”¢å·²æ­¸é‚„è‡³åŸå­˜æ”¾åœ°é»ã€‚`)) {
                    return;
                }

                setIsSubmitting(true);
                showToastProgress('æ­£åœ¨è™•ç†æ­¸é‚„ä½œæ¥­...');

                google.script.run
                    .withSuccessHandler(message => {
                        hideToastProgress('æ­¸é‚„å®Œæˆï¼', 300);
                        setTimeout(() => {
                            alert(message);
                            setIsSubmitting(false);
                            onReturnSuccess();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideToastProgress('æ­¸é‚„å¤±æ•—ï¼', 300);
                        setIsSubmitting(false);
                        alert('æ­¸é‚„å¤±æ•—ï¼š' + error.message);
                    })
                    .processBatchReturn(selectedLendIds);
            }, [selectedLendIds, onReturnSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                        {/* æ¨™é¡Œåˆ— */}
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800">å‡ºå€Ÿä¸­è³‡ç”¢ - æ­¸é‚„ä½œæ¥­</h3>
                            <button
                                onClick={onClose}
                                className="text-slate-400 hover:text-slate-600 transition-colors"
                                disabled={isSubmitting}
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* ä¸»è¦å…§å®¹å€åŸŸ */}
                        <div className="p-6 max-h-[75vh] overflow-y-auto">
                            {isLoading ? (
                                // è¼‰å…¥ä¸­ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                    <p className="text-slate-500 font-medium">è¼‰å…¥å‡ºå€Ÿè³‡æ–™ä¸­...</p>
                                </div>
                            ) : !lentAssetsDetails || lentAssetsDetails.length === 0 ? (
                                // ç„¡è³‡æ–™ç‹€æ…‹
                                <div className="flex flex-col items-center justify-center py-12 gap-4">
                                    <i className="fas fa-check-circle text-5xl text-green-500"></i>
                                    <p className="text-slate-500 text-lg font-medium">ç›®å‰æ²’æœ‰å‡ºå€Ÿä¸­çš„è³‡ç”¢ã€‚</p>
                                    <p className="text-slate-400 text-sm">æ‰€æœ‰è³‡ç”¢éƒ½å·²æ­¸é‚„å®Œç•¢ã€‚</p>
                                </div>
                            ) : (
                                <>
                                    {/* ç¯©é¸æ§åˆ¶å€ */}
                                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {/* åœ°é»ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">å‡ºå€Ÿå¾Œåœ°é»</label>
                                                <select
                                                    value={filters.location}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, location: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                                                    {uniqueLocations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* æ—¥æœŸç¯„åœç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆèµ·ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.startDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é è¨ˆæ­¸é‚„æ—¥ï¼ˆè¿„ï¼‰</label>
                                                <input
                                                    type="date"
                                                    value={filters.endDate}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                />
                                            </div>

                                            {/* é€¾æœŸç‹€æ…‹ç¯©é¸ */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-600 mb-1">é€¾æœŸç‹€æ…‹</label>
                                                <select
                                                    value={filters.overdueOnly}
                                                    onChange={(e) => setFilters(prev => ({ ...prev, overdueOnly: e.target.value }))}
                                                    className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    disabled={isSubmitting}
                                                >
                                                    <option value="">å…¨éƒ¨</option>
                                                    <option value="overdue">å·²é€¾æœŸ</option>
                                                    <option value="notOverdue">æœªé€¾æœŸ</option>
                                                </select>
                                            </div>
                                        </div>

                                        {/* é—œéµå­—æœå°‹ */}
                                        <div className="mt-4">
                                            <label className="block text-xs font-medium text-slate-600 mb-1">é—œéµå­—æœå°‹ï¼ˆè²¡ç”¢ç·¨è™Ÿã€å€Ÿç”¨äººã€å‡ºå€Ÿäº‹ç”±ï¼‰</label>
                                            <input
                                                type="text"
                                                value={filters.search}
                                                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                                                placeholder="è¼¸å…¥é—œéµå­—æœå°‹..."
                                                className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                disabled={isSubmitting}
                                            />
                                        </div>

                                        {/* ç¯©é¸çµæœçµ±è¨ˆ */}
                                        <div className="mt-3 text-sm text-slate-600">
                                            é¡¯ç¤º <span className="font-bold text-blue-600">{filteredAssets.length}</span> / {lentAssetsDetails.length} ç­†
                                        </div>
                                    </div>

                                    {/* è³‡æ–™è¡¨æ ¼ */}
                                    {filteredAssets.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <i className="fas fa-filter text-3xl mb-2"></i>
                                            <p>ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-50 sticky top-0 shadow-sm">
                                                    <tr>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '5%'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectAll}
                                                                onChange={handleSelectAll}
                                                                disabled={isSubmitting}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>è²¡ç”¢ç·¨è™Ÿ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>è²¡ç”¢åç¨±</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>å‹è™Ÿ/å» ç‰Œ</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '10%'}}>å€Ÿç”¨äºº</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '12%'}}>é è¨ˆæ­¸é‚„æ—¥</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '15%'}}>å‡ºå€Ÿå¾Œåœ°é»</th>
                                                        <th className="px-3 py-3 text-left font-semibold text-slate-600 border-b-2 border-slate-200" style={{width: '21%'}}>å‡ºå€Ÿäº‹ç”±</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredAssets.map((asset, index) => {
                                                        // åˆ¤æ–·æ˜¯å¦é€¾æœŸ
                                                        const today = new Date();
                                                        today.setHours(0, 0, 0, 0);
                                                        const returnDate = new Date(asset.expectedReturnDate);
                                                        returnDate.setHours(0, 0, 0, 0);
                                                        const isOverdue = returnDate < today;

                                                        return (
                                                            <tr key={`lent-${asset.lendId}-${index}`} className={`hover:bg-slate-50 transition-colors ${isOverdue ? 'bg-red-50' : ''}`}>
                                                                <td className="px-3 py-3">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedLendIds.includes(asset.lendId)}
                                                                        onChange={() => handleCheckboxChange(asset.lendId)}
                                                                        disabled={isSubmitting}
                                                                        className="w-4 h-4 cursor-pointer"
                                                                    />
                                                                </td>
                                                                <td className="px-3 py-3 font-mono text-slate-600">{asset.assetId}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.assetName || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.modelBrand || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.borrower}</td>
                                                                <td className={`px-3 py-3 ${isOverdue ? 'text-red-600 font-semibold' : 'text-slate-600'}`}>
                                                                    {asset.expectedReturnDate}
                                                                    {isOverdue && <i className="fas fa-exclamation-triangle ml-1"></i>}
                                                                </td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.lendingLocation || '-'}</td>
                                                                <td className="px-3 py-3 text-slate-600">{asset.reason}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* åº•éƒ¨æ“ä½œåˆ— */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <span>
                                        å·²é¸æ“‡ <span className="font-bold text-blue-600">{selectedLendIds.length}</span> / {filteredAssets.length} ç­†
                                    </span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors font-medium"
                                    disabled={isSubmitting}
                                >
                                    é—œé–‰
                                </button>
                                {lentAssetsDetails && lentAssetsDetails.length > 0 && (
                                    <button
                                        onClick={handleSubmitReturn}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed font-medium shadow-sm"
                                        disabled={selectedLendIds.length === 0 || isSubmitting}
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin"></i>
                                                è™•ç†ä¸­...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-check"></i>
                                                ç¢ºèªæ­¸é‚„æ‰€é¸é …ç›®
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScrapPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½å ±è¡¨ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    `æ˜¯å¦è¦åœ¨åˆ—å°å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„ç‹€æ…‹ç‚ºã€Œå·²å ±å»¢ã€ï¼Ÿ\n\n` +
                                    `âš ï¸ é‡è¦æé†’\n` +
                                    'é¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= åˆ—å°å¾Œæ›´æ–°ç‹€æ…‹ï¼Œå°‡ ${result.assetIds.length} ç­†è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€ï¼ˆè²¡ç”¢å°‡æ¨™è¨˜ç‚ºå·²å ±å»¢ï¼Œç„¡æ³•å†æ¬¡åˆ—å°æ­¤ç”³è«‹ï¼‰\n` +
                                    `âŒ ã€å–æ¶ˆã€‘= åƒ…åˆ—å°å ±è¡¨ï¼Œä¸æ›´æ–°ç‹€æ…‹ï¼ˆéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰`
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†ç‹€æ…‹æœªæ›´æ–°ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processScrapConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createScrapDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-orange-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-orange-800">åˆ—å°å ±å»¢ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-orange-600 hover:text-orange-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Category Selector */}
                        <div className="px-6 py-4 border-b bg-orange-50/50">
                            <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                            <label className="inline-flex items-center mr-6">
                                <input
                                    type="radio"
                                    name="scrapCategory"
                                    value="è²¡ç”¢"
                                    checked={selectedCategory === 'è²¡ç”¢'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>è²¡ç”¢</span>
                            </label>
                            <label className="inline-flex items-center">
                                <input
                                    type="radio"
                                    name="scrapCategory"
                                    value="ç‰©å“"
                                    checked={selectedCategory === 'ç‰©å“'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>ç‰©å“</span>
                            </label>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-16">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"></div>
                                        <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                    </div>
                                </div>
                            ) : currentAssets.length === 0 ? (
                                <div className="text-center py-16 text-slate-500">
                                    <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                    <p>ç›®å‰æ²’æœ‰ä»»ä½•ç‹€æ…‹ç‚ºã€Œå ±å»¢ä¸­ã€çš„{selectedCategory}ã€‚</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-orange-50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="rounded"
                                                    />
                                                </th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">å ±å»¢æ—¥æœŸ</th>
                                                <th className="px-3 py-2 text-left">å ±å»¢åŸå› </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {currentAssets.map(asset => (
                                                <tr key={asset.assetId} className="border-b hover:bg-orange-50/30">
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedIds.includes(asset.assetId)}
                                                            onChange={() => handleSelectOne(asset.assetId)}
                                                            className="rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2">{asset.assetId}</td>
                                                    <td className="px-3 py-2">{asset.assetName}</td>
                                                    <td className="px-3 py-2">{asset.modelBrand}</td>
                                                    <td className="px-3 py-2">{asset.originalKeeper}</td>
                                                    <td className="px-3 py-2">{asset.originalUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.scrapDate || ''}</td>
                                                    <td className="px-3 py-2">{asset.scrapReason || ''}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-orange-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    disabled={isGenerating}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleGenerateDoc}
                                    disabled={isGenerating || selectedIds.length === 0}
                                    className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? (
                                        <>
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                            <span>ç”¢ç”Ÿä¸­...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-file-alt"></i>
                                            <span>ç”Ÿæˆå ±å»¢ç”³è«‹å–®</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TransferPrintModal = ({ details, isLoading, webAppUrl, onClose, onRefresh }) => {
            const [selectedCategory, setSelectedCategory] = useState('è²¡ç”¢');
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectAll, setSelectAll] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            // ç•¶å‰é¡åˆ¥çš„è³‡ç”¢åˆ—è¡¨
            const currentAssets = useMemo(() => {
                if (!details) return [];
                return selectedCategory === 'è²¡ç”¢' ? details.property : details.items;
            }, [details, selectedCategory]);

            // åˆ‡æ›é¡åˆ¥æ™‚æ¸…ç©ºé¸æ“‡
            useEffect(() => {
                setSelectedIds([]);
                setSelectAll(false);
            }, [selectedCategory]);

            // æª¢æŸ¥æ˜¯å¦æ”¶åˆ° nullï¼ˆåºåˆ—åŒ–å¤±æ•—ï¼‰
            useEffect(() => {
                if (!isLoading && details === null) {
                    console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™ç‚º nullï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—');
                    alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                    onClose();
                }
            }, [details, isLoading, onClose]);

            const handleSelectAll = (e) => {
                const checked = e.target.checked;
                setSelectAll(checked);
                if (checked) {
                    setSelectedIds(currentAssets.map(a => a.assetId));
                } else {
                    setSelectedIds([]);
                }
            };

            const handleSelectOne = (assetId) => {
                setSelectedIds(prev => {
                    if (prev.includes(assetId)) {
                        return prev.filter(id => id !== assetId);
                    } else {
                        return [...prev, assetId];
                    }
                });
            };

            const handleGenerateDoc = () => {
                if (selectedIds.length === 0) {
                    alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚');
                    return;
                }

                setIsGenerating(true);

                google.script.run
                    .withSuccessHandler(adminName => {
                        google.script.run
                            .withSuccessHandler(result => {
                                const shouldUpdate = confirm(
                                    'ğŸ“„ å½™ç¸½è½‰ç§»è¨˜éŒ„ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                    'â“ æ˜¯å¦è¦åœ¨ç”Ÿæˆæ–‡ä»¶å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„æ›´æ–°ç‹€æ…‹ï¼Ÿ\n\n' +
                                    'âš ï¸  æé†’ï¼šé¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                    `âœ… ã€ç¢ºå®šã€‘= æ¨™è¨˜ ${result.assetIds.length} ç­†è½‰ç§»è¨˜éŒ„ç‚ºå·²æ›´æ–°ï¼ˆç„¡æ³•å†æ¬¡åˆ—å°ï¼‰\n` +
                                    'âŒ ã€å–æ¶ˆã€‘= åƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ¨™è¨˜ç‹€æ…‹ï¼ˆå¯å†æ¬¡åˆ—å°ï¼Œéœ€è‡³"ç¸½è¡¨æ›´æ–°"æ›´æ–°ç‹€æ…‹ï¼‰'
                                );

                                window.open(result.fileUrl, '_blank');

                                if (shouldUpdate) {
                                    google.script.run
                                        .withSuccessHandler(message => {
                                            alert('âœ… ' + message);
                                            onRefresh();
                                        })
                                        .withFailureHandler(error => {
                                            alert(
                                                'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                                                'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†æœªæ¨™è¨˜ç‚ºå·²ä¸Šå‚³ã€‚\n' +
                                                'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚'
                                            );
                                            onRefresh();
                                        })
                                        .processUploadConfirmation(result.assetIds);
                                } else {
                                    onRefresh();
                                }
                                setIsGenerating(false);
                            })
                            .withFailureHandler(error => {
                                alert('ç”Ÿæˆå¤±æ•—ï¼š' + (error.message || error));
                                setIsGenerating(false);
                            })
                            .createTransferDoc(adminName, selectedCategory, selectedIds);
                    })
                    .withFailureHandler(error => {
                        alert('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || error));
                        setIsGenerating(false);
                    })
                    .getAdminName();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col">
                        {/* Header */}
                        <div className="px-6 py-4 border-b bg-purple-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-purple-800">åˆ—å°è½‰ç§»ç”³è«‹å–®</h3>
                            <button onClick={onClose} className="text-purple-600 hover:text-purple-800 transition-colors">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Category Selector */}
                        <div className="px-6 py-4 border-b bg-purple-50/50">
                            <label className="font-medium text-slate-700 mr-4">è«‹é¸æ“‡è²¡ç”¢é¡åˆ¥ï¼š</label>
                            <label className="inline-flex items-center mr-6">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="è²¡ç”¢"
                                    checked={selectedCategory === 'è²¡ç”¢'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>è²¡ç”¢</span>
                            </label>
                            <label className="inline-flex items-center">
                                <input
                                    type="radio"
                                    name="transferCategory"
                                    value="ç‰©å“"
                                    checked={selectedCategory === 'ç‰©å“'}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="mr-2"
                                />
                                <span>ç‰©å“</span>
                            </label>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex items-center justify-center py-16">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                                        <p className="mt-4 text-slate-600">è¼‰å…¥ä¸­...</p>
                                    </div>
                                </div>
                            ) : currentAssets.length === 0 ? (
                                <div className="text-center py-16 text-slate-500">
                                    <i className="fas fa-inbox text-5xl mb-4 text-slate-300"></i>
                                    <p>ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆè½‰ç§»çš„{selectedCategory}è¨˜éŒ„ã€‚</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-purple-50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="rounded"
                                                    />
                                                </th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                                <th className="px-3 py-2 text-left">è²¡ç”¢åç¨±</th>
                                                <th className="px-3 py-2 text-left">å‹è™Ÿ/å» ç‰Œ</th>
                                                <th className="px-3 py-2 text-left">åŸä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">åŸä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">åŸåœ°é»</th>
                                                <th className="px-3 py-2 text-left">æ–°ä¿ç®¡äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°ä½¿ç”¨äºº</th>
                                                <th className="px-3 py-2 text-left">æ–°åœ°é»</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»é¡å‹</th>
                                                <th className="px-3 py-2 text-left">è½‰ç§»æ—¥æœŸ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {currentAssets.map(asset => (
                                                <tr key={asset.assetId} className="border-b hover:bg-purple-50/30">
                                                    <td className="px-3 py-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedIds.includes(asset.assetId)}
                                                            onChange={() => handleSelectOne(asset.assetId)}
                                                            className="rounded"
                                                        />
                                                    </td>
                                                    <td className="px-3 py-2">{asset.assetId}</td>
                                                    <td className="px-3 py-2">{asset.assetName}</td>
                                                    <td className="px-3 py-2">{asset.modelBrand}</td>
                                                    <td className="px-3 py-2">{asset.oldKeeper}</td>
                                                    <td className="px-3 py-2">{asset.oldUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.oldLocation}</td>
                                                    <td className="px-3 py-2">{asset.newKeeper}</td>
                                                    <td className="px-3 py-2">{asset.newUser || ''}</td>
                                                    <td className="px-3 py-2">{asset.newLocation}</td>
                                                    <td className="px-3 py-2">{asset.transferType}</td>
                                                    <td className="px-3 py-2">{asset.transferDate}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-6 py-4 border-t bg-slate-50 flex justify-between items-center">
                            <div className="text-sm text-slate-600">
                                å·²é¸æ“‡ <span className="font-bold text-purple-600">{selectedIds.length}</span> ç­†è³‡ç”¢
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                    disabled={isGenerating}
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleGenerateDoc}
                                    disabled={isGenerating || selectedIds.length === 0}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isGenerating ? (
                                        <>
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                            <span>ç”¢ç”Ÿä¸­...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-file-alt"></i>
                                            <span>ç”Ÿæˆè½‰ç§»ç”³è«‹å–®</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ä¸» App çµ„ä»¶
        function App() {
            const [isReady, setIsReady] = useState(false);
            const [allAssets, setAllAssets] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [currentUserEmail, setCurrentUserEmail] = useState('');
            const [webAppUrl, setWebAppUrl] = useState('');
            const [pendingApprovalsData, setPendingApprovalsData] = useState([]);
            const [inventorySessions, setInventorySessions] = useState(null);
            const [filters, setFilters] = useState({
                status: '',
                category: '',
                leader: '',
                search: ''
            });
            const [activeModal, setActiveModal] = useState(null);
            const [isLoadingCards, setIsLoadingCards] = useState(false);
            const [lentAssetsDetails, setLentAssetsDetails] = useState(null);
            const [isLoadingLentDetails, setIsLoadingLentDetails] = useState(false);
            const [scrapPendingDetails, setScrapPendingDetails] = useState(null);
            const [transferPendingDetails, setTransferPendingDetails] = useState(null);
            const [transferPendingCount, setTransferPendingCount] = useState(0);
            const [isLoadingScrapDetails, setIsLoadingScrapDetails] = useState(false);
            const [isLoadingTransferDetails, setIsLoadingTransferDetails] = useState(false);

            // è¼‰å…¥è³‡æ–™
            const loadData = () => {
                showFlyProgressBar('æ­£åœ¨è¼‰å…¥è²¡ç”¢ç‹€æ…‹è³‡æ–™...');
                setIsLoadingCards(true); // åˆå§‹è¼‰å…¥æ™‚ä¹Ÿé¡¯ç¤ºå¡ç‰‡è¼‰å…¥å‹•ç•«

                google.script.run
                    .withSuccessHandler(url => {
                        setWebAppUrl(url);

                        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å¤±æ•—ï¼š' + response.error);
                                    hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                    return;
                                }

                                setAllAssets(response.assets || []);
                                setIsAdmin(response.isAdmin);
                                setCurrentUserEmail(response.userEmail);

                                let pendingLoaded = false;
                                let inventoryLoaded = false;
                                const finishCardLoading = () => {
                                    if (pendingLoaded && inventoryLoaded) {
                                        setIsLoadingCards(false);
                                    }
                                };

                                // è¼‰å…¥å¾…æ¥æ”¶è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(pendingResponse => {
                                        if (pendingResponse && pendingResponse.approvals) {
                                            setPendingApprovalsData(pendingResponse.approvals);
                                        }
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥å¾…æ¥æ”¶æ¸…å–®å¤±æ•—ï¼š', error.message);
                                        pendingLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getPendingApprovals();

                                // è¼‰å…¥ç›¤é»è³‡æ–™
                                google.script.run
                                    .withSuccessHandler(inventoryResponse => {
                                        if (inventoryResponse) {
                                            setInventorySessions(inventoryResponse);
                                        }
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥ç›¤é»è³‡æ–™å¤±æ•—ï¼š', error.message);
                                        inventoryLoaded = true;
                                        finishCardLoading();
                                    })
                                    .getInventoryData();

                                // è¼‰å…¥è½‰ç§»å¾…åˆ—å°æ•¸é‡
                                google.script.run
                                    .withSuccessHandler(count => {
                                        if (typeof count === 'number') {
                                            setTransferPendingCount(count);
                                        }
                                    })
                                    .withFailureHandler(error => {
                                        console.warn('è¼‰å…¥è½‰ç§»æ•¸é‡å¤±æ•—ï¼š', error.message);
                                        setTransferPendingCount(0);
                                    })
                                    .getTransferableItemsCount();

                                setIsReady(true);
                                hideFlyProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
                            })
                            .withFailureHandler(error => {
                                setIsLoadingCards(false); // å¤±æ•—æ™‚ä¹Ÿé—œé–‰å¡ç‰‡å‹•ç•«
                                hideFlyProgressBar('è¼‰å…¥å¤±æ•—', 0);
                                alert('éŒ¯èª¤ï¼š' + error.message);
                            })
                            .getUserStateData();
                    })
                    .getAppUrl();
            };

            // é‡æ–°æ•´ç†å¡ç‰‡æ•¸æ“šï¼ˆä¸¦è¡Œè¼‰å…¥ï¼‰
            const refreshCardData = useCallback(async () => {
                const MIN_LOADING_DURATION = 500; // æœ€çŸ­é¡¯ç¤ºæ™‚é–“ 500ms
                setIsLoadingCards(true);
                const startTime = Date.now();

                try {
                    // ä¸¦è¡Œè¼‰å…¥å››å€‹ API
                    const [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse] = await Promise.allSettled([
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getPendingApprovals();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getInventoryData();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getUserStateData();
                        }),
                        new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getTransferableItemsCount();
                        })
                    ]);

                    // è™•ç†æˆåŠŸçš„çµæœ
                    if (pendingResponse.status === 'fulfilled' && pendingResponse.value?.approvals) {
                        setPendingApprovalsData(pendingResponse.value.approvals);
                    }
                    if (inventoryResponse.status === 'fulfilled' && inventoryResponse.value) {
                        setInventorySessions(inventoryResponse.value);
                    }
                    if (assetsResponse.status === 'fulfilled' && assetsResponse.value?.assets) {
                        setAllAssets(assetsResponse.value.assets);
                    }
                    if (transferCountResponse.status === 'fulfilled' && typeof transferCountResponse.value === 'number') {
                        setTransferPendingCount(transferCountResponse.value);
                    }

                    // æª¢æŸ¥å¤±æ•—çš„è«‹æ±‚
                    const failures = [pendingResponse, inventoryResponse, assetsResponse, transferCountResponse]
                        .filter(r => r.status === 'rejected');
                    if (failures.length > 0) {
                        console.warn('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š', failures);
                        alert('éƒ¨åˆ†æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                    }

                    // ç¢ºä¿æœ€çŸ­é¡¯ç¤ºæ™‚é–“
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, MIN_LOADING_DURATION - elapsedTime);

                    setTimeout(() => {
                        setIsLoadingCards(false);
                    }, remainingTime);

                } catch (error) {
                    setIsLoadingCards(false);
                    console.error('é‡æ–°æ•´ç†å¤±æ•—ï¼š', error);
                    alert('é‡æ–°æ•´ç†å¤±æ•—ï¼š' + error.message);
                }
            }, []);

            // é‡æ–°æ•´ç†æŒ‰éˆ•é»æ“Šè™•ç†
            const handleRefreshCards = () => {
                refreshCardData();
            };

            useEffect(() => {
                loadData();

                // è¨­å®šå…¨åŸŸåˆ·æ–°å‡½æ•¸
                window.refreshReactData = () => {
                    loadData();
                };
            }, []);

            // åŒæ­¥ç‹€æ…‹åˆ°å…¨åŸŸè®Šæ•¸ä¾› jQuery Modal ä½¿ç”¨
            useEffect(() => {
                window.pendingApprovals = pendingApprovalsData;
            }, [pendingApprovalsData]);

            // è¨ˆç®—ç¯©é¸å¾Œçš„è³‡ç”¢
            const filteredAssets = useMemo(() => {
                return allAssets.filter(asset => {
                    const statusMatch = !filters.status || asset.status === filters.status;
                    const categoryMatch = !filters.category || asset.category === filters.category;
                    const leaderMatch = !filters.leader || asset.leader === filters.leader;
                    const searchMatch = !filters.search ||
                        asset.assetId.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.assetName.toUpperCase().includes(filters.search.toUpperCase()) ||
                        asset.leader.toUpperCase().includes(filters.search.toUpperCase());
                    return statusMatch && categoryMatch && leaderMatch && searchMatch;
                });
            }, [allAssets, filters]);

            // è¨ˆç®—é‡è¤‡ç”¢ç·¨
            const duplicateInfo = useMemo(() => {
                const map = new Map();
                const duplicates = new Map();
                let duplicateCount = 0;

                filteredAssets.forEach(asset => {
                    const key = String(asset.assetId || '').trim();
                    if (map.has(key)) {
                        duplicateCount += 1;
                        const existing = map.get(key);
                        if (!duplicates.has(key)) {
                            duplicates.set(key, [existing]);
                        }
                        duplicates.get(key).push(asset);
                    } else {
                        map.set(key, asset);
                    }
                });

                const groups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                    assetId,
                    items
                }));

                return { duplicateCount, groups };
            }, [filteredAssets]);

            // åŒæ­¥é‡è¤‡ç”¢ç·¨è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
            useEffect(() => {
                window.duplicateGroups = duplicateInfo.groups;
            }, [duplicateInfo.groups]);

            // è¨ˆç®—å¡ç‰‡çµ±è¨ˆæ•¸é‡
            const cardCounts = useMemo(() => {
                // âœ¨ ç›´æ¥ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„å¾…ç›¤é»è³‡ç”¢æ•¸é‡
                const inventoryCount = inventorySessions?.myPendingInventoryCount || 0;

                const scrapPendingCount = (() => {
                    const scrappingAssets = allAssets.filter(a => a.status === 'å ±å»¢ä¸­');
                    if (isAdmin) {
                        return scrappingAssets.length;
                    } else {
                        return scrappingAssets.filter(a =>
                            a.leaderEmail?.toLowerCase() === currentUserEmail.toLowerCase() ||
                            a.userEmail?.toLowerCase() === currentUserEmail.toLowerCase()
                        ).length;
                    }
                })();

                return {
                    pending: pendingApprovalsData.length,
                    lent: allAssets.filter(a => a.status === 'å‡ºå€Ÿä¸­').length,
                    scrapPending: scrapPendingCount,
                    transferPending: transferPendingCount,
                    inventory: inventoryCount
                };
            }, [allAssets, pendingApprovalsData, inventorySessions, currentUserEmail, isAdmin, transferPendingCount]);

            // è™•ç†å¡ç‰‡é»æ“Š
            const handleCardClick = (cardId) => {
                switch(cardId) {
                    case 'pending':
                        window.openPendingApprovalModal();
                        break;
                    case 'lent':
                        // è¨­å®šè¼‰å…¥ç‹€æ…‹ä¸¦æ‰“é–‹ modal
                        setIsLoadingLentDetails(true);
                        setActiveModal('lent');

                        // èª¿ç”¨å¾Œç«¯ç²å–è©³ç´°å‡ºå€Ÿè³‡è¨Š
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.error) {
                                    alert('è¼‰å…¥å‡ºå€Ÿè³‡æ–™å¤±æ•—ï¼š' + response.error);
                                    setActiveModal(null);
                                    setIsLoadingLentDetails(false);
                                    return;
                                }
                                setLentAssetsDetails(response.assets || []);
                                setIsLoadingLentDetails(false);
                            })
                            .withFailureHandler(error => {
                                console.error('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š', error.message);
                                alert('è¼‰å…¥å‡ºå€Ÿè©³æƒ…å¤±æ•—ï¼š' + error.message);
                                setActiveModal(null);
                                setIsLoadingLentDetails(false);
                            })
                            .getLentOutAssets();
                        break;
                    case 'scrapPending':
                        setIsLoadingScrapDetails(true);
                        setActiveModal('scrapPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('è²¡ç”¢');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllScrappableItems('ç‰©å“');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„å ±å»¢è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingScrapDetails(false);
                                return;
                            }

                            setScrapPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingScrapDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥å ±å»¢è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingScrapDetails(false);
                        });
                        break;
                    case 'transferPending':
                        setIsLoadingTransferDetails(true);
                        setActiveModal('transferPrint');

                        // ä¸¦è¡Œè¼‰å…¥è²¡ç”¢å’Œç‰©å“å…©å€‹é¡åˆ¥
                        Promise.allSettled([
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('è²¡ç”¢');
                            }),
                            new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .getAllTransferableItems('ç‰©å“');
                            })
                        ]).then(([propertyResult, itemResult]) => {
                            const propertyAssets = propertyResult.status === 'fulfilled' ? propertyResult.value : [];
                            const itemAssets = itemResult.status === 'fulfilled' ? itemResult.value : [];
                            const hasInvalidData = (propertyResult.status === 'fulfilled' && !Array.isArray(propertyAssets)) ||
                                (itemResult.status === 'fulfilled' && !Array.isArray(itemAssets));
                            if (hasInvalidData) {
                                console.error('æ”¶åˆ°çš„è½‰ç§»è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯å¾Œç«¯åºåˆ—åŒ–å¤±æ•—', {
                                    propertyAssets,
                                    itemAssets
                                });
                                alert('è¼‰å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤');
                                setActiveModal(null);
                                setIsLoadingTransferDetails(false);
                                return;
                            }

                            setTransferPendingDetails({
                                property: propertyAssets,
                                items: itemAssets,
                                total: (propertyAssets?.length || 0) + (itemAssets?.length || 0)
                            });
                            setIsLoadingTransferDetails(false);
                        }).catch(error => {
                            console.error('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š', error);
                            alert('è¼‰å…¥è½‰ç§»è©³æƒ…å¤±æ•—ï¼š' + (error.message || error));
                            setActiveModal(null);
                            setIsLoadingTransferDetails(false);
                        });
                        break;
                    case 'inventory':
                        const inventoryUrl = webAppUrl + '?page=inventory';
                        window.open(inventoryUrl, '_top');
                        break;
                }
            };

            // è™•ç†ç¯©é¸è®Šæ›´
            const handleFilterChange = (filterName, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterName]: value
                }));
            };

            // è™•ç†å–æ¶ˆ
            const handleCancel = (assetId, status) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™ç­† [${status}] ç‹€æ…‹çš„ç”³è«‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ­¤æ“ä½œå°‡æœƒæŠŠè²¡ç”¢ç‹€æ…‹æ¢å¾©ç‚ºã€Œåœ¨åº«ã€ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å–æ¶ˆç”³è«‹...');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            hideFlyProgressBar('å–æ¶ˆå®Œæˆï¼', 300);

                            setTimeout(() => {
                                alert('ç”³è«‹å·²æˆåŠŸå–æ¶ˆã€‚');
                                showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                                loadData();
                            }, 400);
                        } else {
                            hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                            alert('éŒ¯èª¤ï¼š' + response.error);
                        }
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å–æ¶ˆå¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .cancelTransferOrScrap(assetId);
            };

            // è™•ç†å›æº¯
            const handleRestore = (assetId) => {
                const confirmation = confirm(
                    `æ‚¨ç¢ºå®šè¦å°‡æ­¤ã€Œå·²å ±å»¢ã€è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                    `è²¡ç”¢ç·¨è™Ÿï¼š${assetId}\n\n` +
                    `æ³¨æ„ï¼šæ­¤æ“ä½œæœƒä¿ç•™åŸå ±å»¢è¨˜éŒ„ä¸¦æ·»åŠ å›æº¯æ¨™è¨˜ã€‚`
                );

                if (!confirmation) return;

                showFlyProgressBar('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');

                google.script.run
                    .withSuccessHandler(result => {
                        hideFlyProgressBar('å›æº¯å®Œæˆï¼', 300);

                        setTimeout(() => {
                            alert(result.message);
                            showFlyProgressBar('æ­£åœ¨æ›´æ–°è³‡æ–™...');
                            loadData();
                        }, 400);
                    })
                    .withFailureHandler(error => {
                        hideFlyProgressBar('å›æº¯å¤±æ•—', 0);
                        alert('éŒ¯èª¤ï¼š' + error.message);
                    })
                    .restoreFromScrap([assetId]);
            };

            if (!isReady) {
                return null;
            }

            return (
                <div className="ml-[88px] p-6 max-w-[1600px] mx-auto">
                    <div className="mb-6 flex justify-between items-center">
                        {/* å·¦å´ï¼šæ¨™é¡Œ */}
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800">è²¡ç”¢ç‹€æ…‹æŸ¥è©¢</h1>
                            <p className="text-slate-500 mt-1">
                                æ­¡è¿å›ä¾†ï¼Œä»Šå¤©æ˜¯ {new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>

                        {/* å³å´ï¼šé‡æ–°æ•´ç†æŒ‰éˆ• + è¼‰å…¥ç‹€æ…‹æŒ‡ç¤º */}
                        <div className="flex items-center gap-3">
                            {/* è¼‰å…¥ç‹€æ…‹æ–‡å­— */}
                            {isLoadingCards && (
                                <span className="text-sm text-slate-500 flex items-center gap-2">
                                    <i className="fas fa-spinner fa-spin text-blue-500"></i>
                                    æ­£åœ¨è¼‰å…¥çµ±è¨ˆæ•¸æ“š...
                                </span>
                            )}

                            {/* é‡æ–°æ•´ç†æŒ‰éˆ• */}
                            <button
                                onClick={handleRefreshCards}
                                disabled={isLoadingCards}
                                className="w-12 h-12 rounded-full bg-blue-500 text-white hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center group"
                                title="é‡æ–°æ•´ç†çµ±è¨ˆæ•¸æ“š"
                                aria-label="é‡æ–°æ•´ç†"
                            >
                                <i className={`fas fa-sync-alt text-lg transition-transform ${isLoadingCards ? 'animate-spin' : 'group-hover:rotate-180'}`}></i>
                            </button>
                        </div>
                    </div>

                    <DashboardCards counts={cardCounts} onClick={handleCardClick} isLoading={isLoadingCards} />

                    <FilterSection
                        filters={filters}
                        onFilterChange={handleFilterChange}
                        isAdmin={isAdmin}
                        allAssets={allAssets}
                    />

                    {duplicateInfo.duplicateCount > 0 && (
                        <AlertBanner
                            count={duplicateInfo.duplicateCount}
                            onClick={() => window.openDuplicateAssetsModal()}
                        />
                    )}

                    <AssetTable
                        assets={filteredAssets}
                        isAdmin={isAdmin}
                        currentUserEmail={currentUserEmail}
                        onCancel={handleCancel}
                        onRestore={handleRestore}
                    />

                    {activeModal === 'lent' && (
                        <LentAssetsModal
                            lentAssetsDetails={lentAssetsDetails}
                            isLoading={isLoadingLentDetails}
                            onClose={() => {
                                setActiveModal(null);
                                setLentAssetsDetails(null);
                            }}
                            onReturnSuccess={() => {
                                setActiveModal(null);
                                setLentAssetsDetails(null);
                                // åˆ·æ–°å¡ç‰‡æ•¸æ“šå’Œè³‡ç”¢è¡¨æ ¼
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'scrapPrint' && (
                        <ScrapPrintModal
                            details={scrapPendingDetails}
                            isLoading={isLoadingScrapDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setScrapPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}

                    {activeModal === 'transferPrint' && (
                        <TransferPrintModal
                            details={transferPendingDetails}
                            isLoading={isLoadingTransferDetails}
                            webAppUrl={webAppUrl}
                            onClose={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                            }}
                            onRefresh={() => {
                                setActiveModal(null);
                                setTransferPendingDetails(null);
                                refreshCardData();
                            }}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('react-root')).render(<App />);
    </script>
</body>
</html>
