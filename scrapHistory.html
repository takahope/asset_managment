<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message {
            margin-top: 15px;
            /* ç¢ºä¿ç‹€æ…‹è¨Šæ¯é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¹‹ä¸Š */
            position: relative;
            z-index: 10000;  /* é«˜æ–¼é€²åº¦æ¢çš„ z-index: 9999 */
        }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .restore-btn-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .selected-count {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_backtrace'); ?>

    <div id="main-content">
        <h4>å·²å ±å»¢è³‡ç”¢ç®¡ç†</h4>
        <p class="text-muted">æ­¤é é¢å¯æŸ¥çœ‹æ‰€æœ‰å·²å ±å»¢çš„è³‡ç”¢ï¼Œä¸¦å¯å°‡é¸å®šçš„è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹ã€‚</p>

        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="category-filter">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸ï¼š</label>
                <select id="category-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="leader-filter">ä¾ä¿ç®¡äººç¯©é¸ï¼š</label>
                <select id="leader-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="location-filter">ä¾åœ°é»ç¯©é¸ï¼š</label>
                <select id="location-filter" class="form-control">
                    <option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="search-box">é—œéµå­—æœå°‹ï¼š</label>
                <input type="text" id="search-box" class="form-control" placeholder="æœå°‹ç”¢ç·¨ã€åç¨±ã€åŸå› ...">
            </div>
        </div>

        <div id="table-container" class="table-container" style="display:none;">
            <table class="table table-hover table-sm">
                <thead class="thead-light" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 4%;"><input type="checkbox" id="select-all" title="å…¨é¸"></th>
                        <th style="width: 12%;">è²¡ç”¢ç·¨è™Ÿ</th>
                        <th style="width: 15%;">è²¡ç”¢åç¨±</th>
                        <th style="width: 10%;">è²¡ç”¢é¡åˆ¥</th>
                        <th style="width: 10%;">ä¿ç®¡äºº</th>
                        <th style="width: 10%;">ä½¿ç”¨è€…</th>
                        <th style="width: 10%;">åœ°é»</th>
                        <th style="width: 10%;">å ±å»¢æ—¥æœŸ</th>
                        <th style="width: 19%;">å ±å»¢åŸå› </th>
                    </tr>
                </thead>
                <tbody id="asset-list">
                </tbody>
            </table>
        </div>

        <div id="restore-section" class="restore-btn-container" style="display:none;">
            <div class="d-flex justify-content-between align-items-center">
                <span>å·²é¸æ“‡ <span id="selected-count" class="selected-count">0</span> ç­†è³‡ç”¢</span>
                <button id="restore-btn" class="btn btn-warning btn-lg" onclick="submitRestore()" disabled>
                    å›æº¯æ‰€é¸é …ç›®ç‚ºã€Œåœ¨åº«ã€
                </button>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <div id="error-content" style="display:none;">
        <div class="alert alert-danger">
            <h5>æ¬Šé™ä¸è¶³</h5>
            <p id="error-message"></p>
            <button class="btn btn-secondary" onclick="goToPortal()">è¿”å›å…¥å£</button>
        </div>
    </div>

    <script>
        let allAssets = [];

        document.addEventListener("DOMContentLoaded", () => {
            toggleTableVisibility(false);
            showProgressBarbacktrace('æ­£åœ¨è¼‰å…¥å·²å ±å»¢è³‡ç”¢è³‡æ–™...');
            google.script.run
                .withSuccessHandler(populatePage)
                .withFailureHandler(showError)
                .getScrapHistoryData();
        });

        function populatePage(response) {
            if (response.error) {
                hideProgressBarbacktrace('è¼‰å…¥å¤±æ•—', 0);
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-content').style.display = 'block';
                document.getElementById('error-message').textContent = response.error;
                return;
            }

            allAssets = response.assets;
            populateFilters(allAssets);

            const tableContainer = document.getElementById('table-container');

            // ç¶å®šäº‹ä»¶ç›£è½ï¼ˆåªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚ç¶å®šï¼Œé¿å…é‡è¤‡ç¶å®šï¼‰
            if (!tableContainer.dataset.initialized) {
                document.getElementById('category-filter').addEventListener('change', filterAndRender);
                document.getElementById('leader-filter').addEventListener('change', filterAndRender);
                document.getElementById('location-filter').addEventListener('change', filterAndRender);
                document.getElementById('search-box').addEventListener('input', filterAndRender);
                document.getElementById('select-all').addEventListener('change', toggleSelectAll);
                tableContainer.dataset.initialized = 'true';
            }

            filterAndRender();
            hideProgressBarbacktrace('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);
            toggleTableVisibility(true);
        }

        function populateFilters(assets) {
            const categorySet = new Set();
            const leaderSet = new Set();
            const locationSet = new Set();

            assets.forEach(asset => {
                if (asset.assetCategory) categorySet.add(asset.assetCategory);
                if (asset.leaderName) leaderSet.add(asset.leaderName);
                if (asset.location) locationSet.add(asset.location);
            });

            // å¡«å……é¡åˆ¥ç¯©é¸å™¨
            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            categorySet.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            // å¡«å……ä¿ç®¡äººç¯©é¸å™¨
            const leaderFilter = document.getElementById('leader-filter');
            leaderFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            leaderSet.forEach(leader => {
                const option = document.createElement('option');
                option.value = leader;
                option.textContent = leader;
                leaderFilter.appendChild(option);
            });

            // å¡«å……åœ°é»ç¯©é¸å™¨
            const locationFilter = document.getElementById('location-filter');
            locationFilter.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨ --</option>';
            locationSet.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        function filterAndRender() {
            const categoryValue = document.getElementById('category-filter').value;
            const leaderValue = document.getElementById('leader-filter').value;
            const locationValue = document.getElementById('location-filter').value;
            const searchValue = document.getElementById('search-box').value.toUpperCase();

            const filteredAssets = allAssets.filter(asset => {
                const categoryMatch = !categoryValue || asset.assetCategory === categoryValue;
                const leaderMatch = !leaderValue || asset.leaderName === leaderValue;
                const locationMatch = !locationValue || asset.location === locationValue;
                const searchMatch = !searchValue ||
                                    asset.assetId.toUpperCase().includes(searchValue) ||
                                    asset.assetName.toUpperCase().includes(searchValue) ||
                                    asset.scrapReason.toUpperCase().includes(searchValue);
                return categoryMatch && leaderMatch && locationMatch && searchMatch;
            });

            renderTable(filteredAssets);
            updateSelectedCount();
        }

        function renderTable(assets) {
            const listBody = document.getElementById('asset-list');
            listBody.innerHTML = '';

            // é‡ç½®å…¨é¸æ¡†
            document.getElementById('select-all').checked = false;

            if (!assets || assets.length === 0) {
                listBody.innerHTML = '<tr><td colspan="9" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å·²å ±å»¢è³‡ç”¢ã€‚</td></tr>';
                return;
            }

            // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
            assets.forEach(asset => {
                const row = document.createElement('tr');

                // æ ¼å¼åŒ–å ±å»¢åŸå› ï¼ˆç§»é™¤æ¨™è¨˜å‰ç¶´ï¼‰
                let displayReason = asset.scrapReason || '';
                displayReason = displayReason.replace('[å ±å»¢å®Œæˆ]', '').replace('[å ±å»¢ç”³è«‹]', '').trim();
                const fullReason = displayReason;
                if (displayReason.length > 30) {
                    displayReason = displayReason.substring(0, 30) + '...';
                }

                // Checkbox å„²å­˜æ ¼ï¼ˆä½¿ç”¨ addEventListener æ›¿ä»£ onchangeï¼‰
                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'asset-checkbox';
                checkbox.value = asset.assetId;
                checkbox.addEventListener('change', updateSelectedCount);
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                // å…¶ä»–æ¬„ä½ä½¿ç”¨ textContent å®‰å…¨è¨­å®š
                [asset.assetId, asset.assetName, asset.assetCategory, asset.leaderName,
                 asset.userName || '-', asset.location || '-', asset.scrapDate || '-'].forEach(data => {
                    const td = document.createElement('td');
                    td.textContent = data || '';
                    row.appendChild(td);
                });

                // å ±å»¢åŸå› æ¬„ä½ï¼ˆéœ€è¨­å®š title å±¬æ€§ï¼‰
                const reasonTd = document.createElement('td');
                reasonTd.textContent = displayReason || '-';
                reasonTd.title = fullReason || '';
                row.appendChild(reasonTd);

                listBody.appendChild(row);
            });
        }

        function toggleSelectAll(e) {
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.asset-checkbox:checked');
            const count = selectedCheckboxes.length;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('restore-btn').disabled = count === 0;
        }

        function submitRestore() {
            const selectedCheckboxes = document.querySelectorAll('.asset-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦å›æº¯çš„è³‡ç”¢ã€‚');
                return;
            }

            const confirmation = confirm(
                `æ‚¨ç¢ºå®šè¦å°‡é€™ ${selectedIds.length} ç­†å·²å ±å»¢è³‡ç”¢å›æº¯ç‚ºã€Œåœ¨åº«ã€ç‹€æ…‹å—ï¼Ÿ\n\n` +
                `æ­¤æ“ä½œæœƒï¼š\n` +
                `1. å°‡è³‡ç”¢ç‹€æ…‹å¾ã€Œå·²å ±å»¢ã€æ”¹ç‚ºã€Œåœ¨åº«ã€\n` +
                `2. åœ¨å‚™è¨»æ¬„è¨˜éŒ„å›æº¯è³‡è¨Š\n\n` +
                `é¸å®šçš„è²¡ç”¢ç·¨è™Ÿï¼š\n${selectedIds.join(', ')}`
            );

            if (!confirmation) return;

            toggleTableVisibility(false);
            showProgressBarbacktrace('æ­£åœ¨å›æº¯è³‡ç”¢ç‹€æ…‹...');
            google.script.run
                .withSuccessHandler(handleRestoreResult)
                .withFailureHandler(showError)
                .restoreFromScrap(selectedIds);
        }

        function handleRestoreResult(result) {
            // æ­¥é©Ÿ 1ï¼šéš±è—é€²åº¦æ¢ï¼Œä½†ä¿æŒè¡¨æ ¼éš±è—ï¼ˆé¿å…èˆŠè³‡æ–™é–ƒç¾ï¼‰
            hideProgressBarbacktrace('å›æº¯å®Œæˆï¼', 0);
            toggleTableVisibility(false);

            // æ­¥é©Ÿ 2ï¼šé¡¯ç¤ºçµæœè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
            // result ç¾åœ¨æ˜¯ç‰©ä»¶ { success, message, count, failed }
            const message = result.message.replace(/\n/g, '<br>') + ' æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...';
            const className = result.success ? 'alert-success' : 'alert-warning';
            
            showMessage(message, className);

            // æ­¥é©Ÿ 3ï¼šçŸ­æš«å»¶é²å¾Œå•Ÿå‹•é‡æ–°è¼‰å…¥é€²åº¦æ¢ï¼ˆè®“ç”¨æˆ¶å…ˆçœ‹åˆ°ç¶ è‰²è¨Šæ¯ï¼‰
            setTimeout(() => {
                loadData();
            }, 150);  // 150ms å»¶é²ï¼Œç¢ºä¿ç¶ è‰²è¨Šæ¯å…ˆæ¸²æŸ“
        }

        function loadData() {
            toggleTableVisibility(false);
            showProgressBarbacktrace('æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
            google.script.run
                .withSuccessHandler(populatePage)
                .withFailureHandler(showError)
                .getScrapHistoryData();
        }

        /**
         * é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.innerHTML = msg;

            // 3 ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        /**
         * åˆ‡æ›è¡¨æ ¼å’ŒæŒ‰éˆ•å€åŸŸçš„é¡¯ç¤ºç‹€æ…‹
         * @param {boolean} show - true é¡¯ç¤ºè¡¨æ ¼ï¼Œfalse éš±è—è¡¨æ ¼
         */
        function toggleTableVisibility(show) {
            if (show) {
                document.getElementById('table-container').style.display = 'block';
                document.getElementById('restore-section').style.display = 'block';
            } else {
                document.getElementById('table-container').style.display = 'none';
                document.getElementById('restore-section').style.display = 'none';
            }
        }

        function showError(error) {
            hideProgressBarbacktrace('è¼‰å…¥å¤±æ•—', 0);
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = 'éŒ¯èª¤ï¼š' + error.message;
        }

        function goToPortal() {
            google.script.run.withSuccessHandler(url => {
                window.open(url, '_top');
            }).getAppUrl();
        }
    </script>
</body>
</html>
