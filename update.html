<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #007bff; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        .section-divider { margin-top: 40px; margin-bottom: 20px; }
        .table thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
    <div class="container-fluid">
        <div id="loading-spinner">
            <div class="loader"></div>
            <p class="text-center">正在載入管理員待辦事項...</p>
        </div>

        <div id="main-content" style="display:none;">
            <div id="upload-section">
                <h4>1. 待更新上傳狀態的財產</h4>
                <p>請勾選已完成外部系統上傳作業的「已轉移」財產。</p>
                <div id="upload-table-container" class="table-container">
                  <table class="table table-hover table-sm">
                    <thead class="thead-light">
                      <tr>
                        <th style="width: 4%;"><input type="checkbox" id="select-all-upload"></th>
                        <th style="width: 11%;">財產編號</th>
                        <th style="width: 13%;">財產名稱</th>
                        <th style="width: 15%;">保管人變更</th>
                        <th style="width: 15%;">使用人變更</th>
                        <th style="width: 15%;">地點變更</th>
                        <th style="width: 13%;">轉移類型</th>
                        <th style="width: 14%;">轉移完成日期</th>
                      </tr>
                    </thead>
                    <tbody id="upload-list"></tbody>
                  </table>
                </div>
                <div id="no-upload-message" class="alert alert-info" style="display:none;">目前沒有待處理的更新項目。</div>
                <div class="mt-3">
                  <button id="submit-upload-btn" class="btn btn-primary" onclick="submitUploadConfirmation()">送出更新狀態</button>
                </div>
            </div>

            <hr class="section-divider">

            <div id="scrap-section">
                <h4>2. 待確認報廢的財產</h4>
                <p>請勾選已確認要報廢的財產，完成最終報廢程序。</p>
                <div id="scrap-table-container" class="table-container">
                  <table class="table table-hover table-sm">
                    <thead class="thead-light">
                      <tr>
                        <th style="width: 4%;"><input type="checkbox" id="select-all-scrap"></th>
                        <th style="width: 15%;">財產編號</th>
                        <th style="width: 18%;">財產名稱</th>
                        <th style="width: 12%;">使用者</th>
                        <th style="width: 12%;">保管人</th>
                        <th style="width: 39%;">報廢申請原因</th>
                      </tr>
                    </thead>
                    <tbody id="scrap-list"></tbody>
                  </table>
                </div>
                <div id="no-scrap-message" class="alert alert-info" style="display:none;">目前沒有待確認的報廢申請。</div>
                <div class="mt-3">
                  <button id="submit-scrap-btn" class="btn btn-danger" onclick="submitScrapConfirmation()">確認報廢所選項目</button>
                </div>
            </div>
            
            <hr>
            <button class="btn btn-secondary" onclick="google.script.host.close()">關閉</button>
            <div id="status-message" class="mt-3"></div>
        </div>

        <div id="error-content" class="text-center" style="display:none;">
            <h3 class="text-danger">權限不足</h3>
            <p id="error-message" class="lead"></p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", loadData);

        function loadData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(populateLists)
                .withFailureHandler(showError)
                .getAssetsForUpdate();
        }

        function populateLists(response) {
            if (response.error) {
                showPermissionError(response.error);
                return;
            }
            showLoading(false);
            
            // --- 填充「待上傳」列表 ---
            const assetsForUpload = response.assetsForUpload;
            const uploadListBody = document.getElementById('upload-list');
            uploadListBody.innerHTML = '';
            if (assetsForUpload && assetsForUpload.length > 0) {
                document.getElementById('upload-table-container').style.display = 'block';
                document.getElementById('submit-upload-btn').style.display = 'inline-block';
                document.getElementById('no-upload-message').style.display = 'none';
                assetsForUpload.forEach(asset => {
                    // ✨ 根據轉移類型顯示不同顏色的標籤
                    const transferType = asset.transferType || '地點';
                    let typeBadge = '';
                    if (transferType.includes('保管人') && transferType.includes('使用人')) {
                        typeBadge = '<span class="badge badge-danger">保管人+使用人</span>';
                    } else if (transferType.includes('保管人')) {
                        typeBadge = '<span class="badge badge-warning">保管人</span>';
                    } else if (transferType.includes('使用人')) {
                        typeBadge = '<span class="badge badge-info">使用人</span>';
                    } else {
                        typeBadge = '<span class="badge badge-secondary">地點</span>';
                    }

                    // ✨ 箭頭式顯示變更
                    const keeperChange = (asset.newKeeper && asset.oldKeeper !== asset.newKeeper)
                        ? `${asset.oldKeeper} <span class="text-primary">→</span> ${asset.newKeeper}`
                        : (asset.oldKeeper || asset.leader || '');

                    const oldUser = asset.oldUser || '';
                    const newUser = asset.newUser || '';
                    const userChange = (newUser && oldUser !== newUser)
                        ? `${oldUser} <span class="text-primary">→</span> ${newUser}`
                        : (oldUser || asset.userName || '無');

                    const locationChange = (asset.newLocation && asset.oldLocation !== asset.newLocation)
                        ? `${asset.oldLocation} <span class="text-primary">→</span> ${asset.newLocation}`
                        : (asset.oldLocation || asset.location || '');

                    const row = `
                        <tr>
                            <td><input type="checkbox" class="upload-checkbox" value="${asset.assetId}"></td>
                            <td>${asset.assetId}</td>
                            <td>${asset.assetName || ''}</td>
                            <td>${keeperChange}</td>
                            <td>${userChange}</td>
                            <td>${locationChange}</td>
                            <td>${typeBadge}</td>
                            <td>${asset.transferDate}</td>
                        </tr>`;
                    uploadListBody.innerHTML += row;
                });
            } else {
                document.getElementById('upload-table-container').style.display = 'none';
                document.getElementById('submit-upload-btn').style.display = 'none';
                document.getElementById('no-upload-message').style.display = 'block';
            }

            // --- 填充「待報廢」列表 ---
            const assetsForScrap = response.assetsForScrap;
            const scrapListBody = document.getElementById('scrap-list');
            scrapListBody.innerHTML = '';
             if (assetsForScrap && assetsForScrap.length > 0) {
                document.getElementById('scrap-table-container').style.display = 'block';
                document.getElementById('submit-scrap-btn').style.display = 'inline-block';
                document.getElementById('no-scrap-message').style.display = 'none';
                assetsForScrap.forEach(asset => {
                    const row = `
                        <tr>
                            <td><input type="checkbox" class="scrap-checkbox" value="${asset.assetId}"></td>
                            <td>${asset.assetId}</td>
                            <td>${asset.assetName || ''}</td>
                            <td>${asset.userName}</td>
                            <td>${asset.leader}</td>
                            <td>${asset.scrapReason || ''}</td>
                        </tr>`;
                    scrapListBody.innerHTML += row;
                });
            } else {
                document.getElementById('scrap-table-container').style.display = 'none';
                document.getElementById('submit-scrap-btn').style.display = 'none';
                document.getElementById('no-scrap-message').style.display = 'block';
            }

            // 綁定全選事件
            document.getElementById('select-all-upload').addEventListener('change', e => {
                document.querySelectorAll('.upload-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
            document.getElementById('select-all-scrap').addEventListener('change', e => {
                document.querySelectorAll('.scrap-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
        }
        
        function submitUploadConfirmation() {
            const selectedIds = Array.from(document.querySelectorAll('.upload-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) { showMessage('請勾選要送出更新的項目。', 'alert-warning'); return; }
            showLoading(true, '正在更新上傳狀態...');
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(showError).processUploadConfirmation(selectedIds);
        }
        
        function submitScrapConfirmation() {
            const selectedIds = Array.from(document.querySelectorAll('.scrap-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) { showMessage('請勾選要確認報廢的項目。', 'alert-warning'); return; }
            
            const confirmation = confirm(`您確定要將 ${selectedIds.length} 筆財產的狀態更新為「已報廢」嗎？`);
            if (!confirmation) return;

            showLoading(true, '正在確認報廢...');
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(showError).processScrapConfirmation(selectedIds);
        }
        
        function handleSuccess(message) {
            showMessage(message, 'alert-success');
            setTimeout(loadData, 2000); // 2秒後自動重新載入清單
        }

        function showPermissionError(message) { /* ...與前一版相同... */ }
        function showError(error) { /* ...與前一版相同... */ }
        function showMessage(msg, className) { /* ...與前一版相同... */ }
        function showLoading(isLoading, text = '...') { /* ...與前一版相同... */ }
        
        // --- 為方便您複製貼上，此處提供完整的輔助函式 ---
        function showPermissionError(message) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-content').style.display = 'block';
        }
        function showError(error) {
            showLoading(false);
            showMessage('錯誤：' + error.message, 'alert-danger');
        }
        function showMessage(msg, className) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;
        }
        function showLoading(isLoading, text = '正在載入...') {
            const loader = document.getElementById('loading-spinner');
            const content = document.getElementById('main-content');
            if (isLoading) {
                loader.querySelector('p').textContent = text;
                loader.style.display = 'block';
                content.style.display = 'none';
                document.getElementById('status-message').innerHTML = '';
            } else {
                loader.style.display = 'none';
                content.style.display = 'block';
            }
        }
    </script>
</body>
</html>