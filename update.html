<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        .section-divider { margin-top: 40px; margin-bottom: 20px; }
        .table thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
    <div class="container-fluid">
        <div id="main-content" style="display:none;">
            <div id="upload-section">
                <h4>1. å¾…æ›´æ–°ä¸Šå‚³ç‹€æ…‹çš„è²¡ç”¢</h4>
                <p>è«‹å‹¾é¸å·²å®Œæˆå¤–éƒ¨ç³»çµ±ä¸Šå‚³ä½œæ¥­çš„ã€Œå·²è½‰ç§»ã€è²¡ç”¢ã€‚</p>
                <div id="upload-table-container" class="table-container">
                  <table class="table table-hover table-sm">
                    <thead class="thead-light">
                      <tr>
                        <th style="width: 4%;"><input type="checkbox" id="select-all-upload"></th>
                        <th style="width: 11%;">è²¡ç”¢ç·¨è™Ÿ</th>
                        <th style="width: 13%;">è²¡ç”¢åç¨±</th>
                        <th style="width: 15%;">ä¿ç®¡äººè®Šæ›´</th>
                        <th style="width: 15%;">ä½¿ç”¨äººè®Šæ›´</th>
                        <th style="width: 15%;">åœ°é»è®Šæ›´</th>
                        <th style="width: 13%;">è½‰ç§»é¡å‹</th>
                        <th style="width: 14%;">è½‰ç§»å®Œæˆæ—¥æœŸ</th>
                      </tr>
                    </thead>
                    <tbody id="upload-list"></tbody>
                  </table>
                </div>
                <div id="no-upload-message" class="alert alert-info" style="display:none;">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„æ›´æ–°é …ç›®ã€‚</div>
                <div class="mt-3">
                  <button id="submit-upload-btn" class="btn btn-primary" onclick="submitUploadConfirmation()">é€å‡ºæ›´æ–°ç‹€æ…‹</button>
                </div>
            </div>

            <hr class="section-divider">

            <div id="scrap-section">
                <h4>2. å¾…ç¢ºèªå ±å»¢çš„è²¡ç”¢</h4>
                <p>è«‹å‹¾é¸å·²ç¢ºèªè¦å ±å»¢çš„è²¡ç”¢ï¼Œå®Œæˆæœ€çµ‚å ±å»¢ç¨‹åºã€‚</p>
                <div id="scrap-table-container" class="table-container">
                  <table class="table table-hover table-sm">
                    <thead class="thead-light">
                      <tr>
                        <th style="width: 4%;"><input type="checkbox" id="select-all-scrap"></th>
                        <th style="width: 15%;">è²¡ç”¢ç·¨è™Ÿ</th>
                        <th style="width: 18%;">è²¡ç”¢åç¨±</th>
                        <th style="width: 12%;">ä½¿ç”¨è€…</th>
                        <th style="width: 12%;">ä¿ç®¡äºº</th>
                        <th style="width: 39%;">å ±å»¢ç”³è«‹åŸå› </th>
                      </tr>
                    </thead>
                    <tbody id="scrap-list"></tbody>
                  </table>
                </div>
                <div id="no-scrap-message" class="alert alert-info" style="display:none;">ç›®å‰æ²’æœ‰å¾…ç¢ºèªçš„å ±å»¢ç”³è«‹ã€‚</div>
                <div class="mt-3">
                  <button id="submit-scrap-btn" class="btn btn-danger" onclick="submitScrapConfirmation()">ç¢ºèªå ±å»¢æ‰€é¸é …ç›®</button>
                </div>
            </div>
            
            <hr>
            <button class="btn btn-secondary" onclick="google.script.host.close()">é—œé–‰</button>
            <div id="status-message" class="mt-3"></div>
        </div>

        <div id="error-content" class="text-center" style="display:none;">
            <h3 class="text-danger">æ¬Šé™ä¸è¶³</h3>
            <p id="error-message" class="lead"></p>
        </div>
    </div>

    <?!= include('progress_bar_basic'); ?>
    <script>
        document.addEventListener("DOMContentLoaded", loadData);

        function loadData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(populateLists)
                .withFailureHandler(showError)
                .getAssetsForUpdate();
        }

        function populateLists(response) {
            if (response.error) {
                showPermissionError(response.error);
                return;
            }
            showLoading(false);
            
            // --- å¡«å……ã€Œå¾…ä¸Šå‚³ã€åˆ—è¡¨ ---
            const assetsForUpload = response.assetsForUpload;
            const uploadListBody = document.getElementById('upload-list');
            uploadListBody.innerHTML = '';
            if (assetsForUpload && assetsForUpload.length > 0) {
                document.getElementById('upload-table-container').style.display = 'block';
                document.getElementById('submit-upload-btn').style.display = 'inline-block';
                document.getElementById('no-upload-message').style.display = 'none';
                // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
                // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹è®Šæ›´é¡¯ç¤ºå„²å­˜æ ¼
                function createChangeTd(oldVal, newVal, hasChange, fallback) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || fallback || '';
                    }
                    return td;
                }

                assetsForUpload.forEach(asset => {
                    const row = document.createElement('tr');
                    const transferType = asset.transferType || 'åœ°é»';

                    // Checkbox å„²å­˜æ ¼
                    const checkboxTd = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'upload-checkbox';
                    checkbox.value = asset.assetId;
                    checkboxTd.appendChild(checkbox);
                    row.appendChild(checkboxTd);

                    // è³‡ç”¢ç·¨è™Ÿå’Œåç¨±
                    const assetIdTd = document.createElement('td');
                    assetIdTd.textContent = asset.assetId;
                    row.appendChild(assetIdTd);

                    const assetNameTd = document.createElement('td');
                    assetNameTd.textContent = asset.assetName || '';
                    row.appendChild(assetNameTd);

                    // ä¿ç®¡äººè®Šæ›´
                    const keeperHasChange = asset.newKeeper && asset.oldKeeper !== asset.newKeeper;
                    row.appendChild(createChangeTd(asset.oldKeeper, asset.newKeeper, keeperHasChange, asset.leader));

                    // ä½¿ç”¨äººè®Šæ›´
                    const oldUser = asset.oldUser || '';
                    const newUser = asset.newUser || '';
                    const userHasChange = newUser && oldUser !== newUser;
                    row.appendChild(createChangeTd(oldUser, newUser, userHasChange, asset.userName || 'ç„¡'));

                    // åœ°é»è®Šæ›´
                    const locationHasChange = asset.newLocation && asset.oldLocation !== asset.newLocation;
                    row.appendChild(createChangeTd(asset.oldLocation, asset.newLocation, locationHasChange, asset.location));

                    // è½‰ç§»é¡å‹ Badge
                    const typeTd = document.createElement('td');
                    const typeBadgeEl = document.createElement('span');
                    if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                        typeBadgeEl.className = 'badge badge-danger';
                        typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                    } else if (transferType.includes('ä¿ç®¡äºº')) {
                        typeBadgeEl.className = 'badge badge-warning';
                        typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                    } else if (transferType.includes('ä½¿ç”¨äºº')) {
                        typeBadgeEl.className = 'badge badge-info';
                        typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                    } else {
                        typeBadgeEl.className = 'badge badge-secondary';
                        typeBadgeEl.textContent = 'åœ°é»';
                    }
                    typeTd.appendChild(typeBadgeEl);
                    row.appendChild(typeTd);

                    // è½‰ç§»æ—¥æœŸ
                    const transferDateTd = document.createElement('td');
                    transferDateTd.textContent = asset.transferDate;
                    row.appendChild(transferDateTd);

                    uploadListBody.appendChild(row);
                });
            } else {
                document.getElementById('upload-table-container').style.display = 'none';
                document.getElementById('submit-upload-btn').style.display = 'none';
                document.getElementById('no-upload-message').style.display = 'block';
            }

            // --- å¡«å……ã€Œå¾…å ±å»¢ã€åˆ—è¡¨ ---
            const assetsForScrap = response.assetsForScrap;
            const scrapListBody = document.getElementById('scrap-list');
            scrapListBody.innerHTML = '';
             if (assetsForScrap && assetsForScrap.length > 0) {
                document.getElementById('scrap-table-container').style.display = 'block';
                document.getElementById('submit-scrap-btn').style.display = 'inline-block';
                document.getElementById('no-scrap-message').style.display = 'none';
                // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
                assetsForScrap.forEach(asset => {
                    const row = document.createElement('tr');

                    // Checkbox å„²å­˜æ ¼
                    const checkboxTd = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'scrap-checkbox';
                    checkbox.value = asset.assetId;
                    checkboxTd.appendChild(checkbox);
                    row.appendChild(checkboxTd);

                    // å…¶ä»–æ¬„ä½ä½¿ç”¨ textContent å®‰å…¨è¨­å®š
                    [asset.assetId, asset.assetName || '', asset.userName, asset.leader, asset.scrapReason || ''].forEach(data => {
                        const td = document.createElement('td');
                        td.textContent = data || '';
                        row.appendChild(td);
                    });

                    scrapListBody.appendChild(row);
                });
            } else {
                document.getElementById('scrap-table-container').style.display = 'none';
                document.getElementById('submit-scrap-btn').style.display = 'none';
                document.getElementById('no-scrap-message').style.display = 'block';
            }

            // ç¶å®šå…¨é¸äº‹ä»¶
            document.getElementById('select-all-upload').addEventListener('change', e => {
                document.querySelectorAll('.upload-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
            document.getElementById('select-all-scrap').addEventListener('change', e => {
                document.querySelectorAll('.scrap-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
        }
        
        function submitUploadConfirmation() {
            const selectedIds = Array.from(document.querySelectorAll('.upload-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) { showMessage('è«‹å‹¾é¸è¦é€å‡ºæ›´æ–°çš„é …ç›®ã€‚', 'alert-warning'); return; }
            showLoading(true, 'æ­£åœ¨æ›´æ–°ä¸Šå‚³ç‹€æ…‹...');
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(showError).processUploadConfirmation(selectedIds);
        }
        
        function submitScrapConfirmation() {
            const selectedIds = Array.from(document.querySelectorAll('.scrap-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) { showMessage('è«‹å‹¾é¸è¦ç¢ºèªå ±å»¢çš„é …ç›®ã€‚', 'alert-warning'); return; }
            
            const confirmation = confirm(`æ‚¨ç¢ºå®šè¦å°‡ ${selectedIds.length} ç­†è²¡ç”¢çš„ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å ±å»¢ã€å—ï¼Ÿ`);
            if (!confirmation) return;

            showLoading(true, 'æ­£åœ¨ç¢ºèªå ±å»¢...');
            google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(showError).processScrapConfirmation(selectedIds);
        }
        
        function handleSuccess(message) {
            showMessage(message, 'alert-success');
            setTimeout(loadData, 2000); // 2ç§’å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥æ¸…å–®
        }

        function showPermissionError(message) { /* ...èˆ‡å‰ä¸€ç‰ˆç›¸åŒ... */ }
        function showError(error) { /* ...èˆ‡å‰ä¸€ç‰ˆç›¸åŒ... */ }
        function showMessage(msg, className) { /* ...èˆ‡å‰ä¸€ç‰ˆç›¸åŒ... */ }
        function showLoading(isLoading, text = '...') { /* ...èˆ‡å‰ä¸€ç‰ˆç›¸åŒ... */ }
        
        // --- ç‚ºæ–¹ä¾¿æ‚¨è¤‡è£½è²¼ä¸Šï¼Œæ­¤è™•æä¾›å®Œæ•´çš„è¼”åŠ©å‡½å¼ ---
        function showPermissionError(message) {
            if (typeof hideProgressBar === 'function') hideProgressBar();
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-content').style.display = 'block';
        }
        function showError(error) {
            showLoading(false);
            showMessage('éŒ¯èª¤ï¼š' + error.message, 'alert-danger');
        }
        function showMessage(msg, className) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;
        }
        function showLoading(isLoading, text = 'æ­£åœ¨è¼‰å…¥...') {
            const content = document.getElementById('main-content');
            if (isLoading) {
                if (typeof showProgressBar === 'function') showProgressBar(text);
                content.style.display = 'none';
                document.getElementById('status-message').innerHTML = '';
            } else {
                if (typeof hideProgressBar === 'function') hideProgressBar();
                content.style.display = 'block';
            }
        }
    </script>
</body>
</html>