<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; }
        .table-container { max-height: 450px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        .btn-print { min-width: 100px; }
        .table thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_runner'); ?>
    <?!= include('progress_bar_print'); ?>

    <div id="main-content">
        <h4>åˆ—å°è½‰ç§»è¨˜éŒ„</h4>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p id="intro-text">æ­¤è™•æœƒä¾ä¿ç®¡äººåˆ—å‡ºæ‰€æœ‰å·²å®Œæˆè½‰ç§»çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥ç‚ºæ¯ä½ä¿ç®¡äººç”¢ç”Ÿä¸€ä»½å½™æ•´çš„è½‰ç§»å ±è¡¨ã€‚</p>
            <div>
                <button id="history-btn" class="btn btn-info mr-2" onclick="showHistory()">æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
                <button id="view-toggle-btn" class="btn btn-outline-secondary" onclick="toggleView()">åˆ‡æ›ç°¡æ˜“æ¨¡å¼</button>
            </div>
        </div>

        <div class="form-group">
            <label><b>è«‹é¸æ“‡è¦åˆ—å°çš„è²¡ç”¢é¡åˆ¥ï¼š</b></label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryProperty" value="è²¡ç”¢" checked>
                    <label class="form-check-label" for="categoryProperty">è²¡ç”¢</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="assetCategory" id="categoryItem" value="ç‰©å“">
                    <label class="form-check-label" for="categoryItem">ç‰©å“</label>
                </div>
            </div>
        </div>


        <!-- ç°¡æ˜“æ¨¡å¼ -->
        <div id="simple-view" style="display: none;">
            <div id="table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light">
                        <tr>
                            <th>ä¿ç®¡äºº</th>
                            <th>å·²è½‰ç§»æ•¸é‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="transfer-list">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è©³ç´°æ¨¡å¼ -->
        <div id="detailed-view" style="display: none;">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-success" onclick="generateConsolidatedDoc()">ç”¢ç”Ÿå½™ç¸½å ±è¡¨</button>
            </div>
            <div id="detailed-table-container" class="table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light">
                        <tr>
                            <th><input type="checkbox" id="select-all-detailed"></th>
                            <th>è²¡ç”¢ç·¨è™Ÿ</th>
                            <th>è²¡ç”¢åç¨±</th>
                            <th>åŸä¿ç®¡äºº</th>
                            <th>åŸä½¿ç”¨äºº</th>
                            <th>åŸå­˜ç½®åœ°é»</th>
                            <th>æ–°ä¿ç®¡äºº</th>
                            <th>æ–°ä½¿ç”¨äºº</th>
                            <th>æ–°å­˜ç½®åœ°é»</th>
                            <th>è½‰ç§»é¡å‹</th>
                            <th>è½‰ç§»æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-transfer-list">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å·²åˆ—å°è½‰ç§»æ–‡ä»¶ç´€éŒ„</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>æ–°ä¿ç®¡äºº</th>
                                    <th>è½‰ç§»æ—¥æœŸ</th>
                                    <th>åŒ…å«ç­†æ•¸</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-list">
                                <!-- History items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isDetailedView = true;
        let isAdmin = false; // âœ¨ å…¨åŸŸè®Šæ•¸è¨˜éŒ„æ¬Šé™

        document.addEventListener("DOMContentLoaded", () => {
            showLoading(true); // ä¸€é–‹å§‹å°±é¡¯ç¤ºé€²åº¦æ¢ï¼Œé¿å…é é¢å…§å®¹å…ˆé–ƒç¾
            google.script.run
                .withSuccessHandler(hasPermission => {
                    isAdmin = hasPermission;
                    console.log(`ğŸ‘¤ ä½¿ç”¨è€…æ¬Šé™ç‹€æ…‹: ${isAdmin ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ä½¿ç”¨è€…'}`);
                    
                    // æ ¹æ“šæ¬Šé™èª¿æ•´ UI
                    if (isAdmin) {
                        document.getElementById('intro-text').textContent = 'æ­¤è™•æœƒä¾ä¿ç®¡äººåˆ—å‡ºæ‰€æœ‰å·²å®Œæˆè½‰ç§»çš„è²¡ç”¢ã€‚æ‚¨å¯ä»¥ç‚ºæ¯ä½ä¿ç®¡äººç”¢ç”Ÿä¸€ä»½å½™æ•´çš„è½‰ç§»å ±è¡¨ã€‚';
                    } else {
                        document.getElementById('intro-text').textContent = 'æ­¤è™•åˆ—å‡ºæ‚¨åä¸‹ï¼ˆä½œç‚ºæ–°ä¿ç®¡äººæˆ–æ–°ä½¿ç”¨äººï¼‰æ‰€æœ‰å·²å®Œæˆè½‰ç§»çš„è²¡ç”¢è¨˜éŒ„ã€‚';
                        // ä¸€èˆ¬ä½¿ç”¨è€…éš±è—åˆ‡æ›è¦–åœ–æŒ‰éˆ•ï¼Œå¼·åˆ¶ä½¿ç”¨è©³ç´°æ¨¡å¼
                        document.getElementById('view-toggle-btn').style.display = 'none';
                        isDetailedView = true; 
                    }

                    loadData(); // è¼‰å…¥è³‡æ–™ (å¾Œç«¯æœƒéæ¿¾)

                    document.querySelectorAll('input[name="assetCategory"]').forEach(radio => {
                        radio.addEventListener('change', loadData);
                    });
                    document.getElementById('select-all-detailed').addEventListener('change', toggleSelectAll);
                })
                .withFailureHandler(showError)
                .checkAdminPermissions();
        });

        function toggleView() {
            if (!isAdmin) return; // ä¸€èˆ¬ä½¿ç”¨è€…ç¦æ­¢åˆ‡æ›

            isDetailedView = !isDetailedView;
            const simpleView = document.getElementById('simple-view');
            const detailedView = document.getElementById('detailed-view');
            const toggleBtn = document.getElementById('view-toggle-btn');

            if (isDetailedView) {
                simpleView.style.display = 'none';
                detailedView.style.display = 'block';
                toggleBtn.textContent = 'åˆ‡æ›ç°¡æ˜“æ¨¡å¼';
            } else {
                simpleView.style.display = 'block';
                detailedView.style.display = 'none';
                toggleBtn.textContent = 'åˆ‡æ›è©³ç´°æ¨¡å¼';
            }
            loadData();
        }

        function loadData() {
            showLoading(true);
            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;

            // ä¸€èˆ¬ä½¿ç”¨è€…å¼·åˆ¶ä½¿ç”¨è©³ç´°æ¨¡å¼ API
            if (isDetailedView || !isAdmin) {
                google.script.run
                    .withSuccessHandler(renderDetailedTable)
                    .withFailureHandler(showError)
                    .getAllTransferableItems(assetCategory);
            } else {
                google.script.run
                    .withSuccessHandler(renderSimpleTable)
                    .withFailureHandler(showError)
                    .getTransferDataForPrint(assetCategory);
            }
        }
// ... (rest of the functions)

        function renderSimpleTable(keepers) {
            const listBody = document.getElementById('transfer-list');
            listBody.innerHTML = '';

            if (!keepers || keepers.length === 0) {
                listBody.innerHTML = '<tr><td colspan="3" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆè½‰ç§»çš„è¨˜éŒ„ã€‚</td></tr>';
            } else {
                keepers.forEach(keeper => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${keeper.keeper}</td>
                        <td>${keeper.count}</td>
                        <td>
                            <button id="btn-${keeper.keeper}" class="btn btn-primary btn-sm btn-print" onclick="generateDoc('${keeper.keeper}', this)">
                                ç”¢ç”Ÿå ±è¡¨
                            </button>
                        </td>
                    `;
                    listBody.appendChild(row);
                });
            }
            showLoading(false);
        }

        function renderDetailedTable(items) {
            const listBody = document.getElementById('detailed-transfer-list');
            listBody.innerHTML = '';

            if (!items || items.length === 0) {
                listBody.innerHTML = '<tr><td colspan="11" class="text-center">ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆè½‰ç§»çš„è¨˜éŒ„ã€‚</td></tr>';
            } else {
                items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="detailed-checkbox" value="${item.assetId}"></td>
                        <td>${item.assetId}</td>
                        <td>${item.assetName}</td>
                        <td>${item.oldKeeper}</td>
                        <td>${item.oldUser || ''}</td>
                        <td>${item.oldLocation}</td>
                        <td>${item.newKeeper}</td>
                        <td>${item.newUser || ''}</td>
                        <td>${item.newLocation}</td>
                        <td>${item.transferType}</td>
                        <td>${item.transferDate}</td>
                    `;
                    listBody.appendChild(row);
                });
            }
            showLoading(false);
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('.detailed-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }

        function generateDoc(keeperName, btn) {
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;
            showPrintProgressBar('æ­£åœ¨ç‚º ' + keeperName + ' ç”¢ç”Ÿè½‰ç§»å ±è¡¨...');

            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
            google.script.run
                .withSuccessHandler(result => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
                    // å…ˆè©¢å•æ˜¯å¦æ¨™è¨˜ç‚ºå·²ä¸Šå‚³
                    const shouldUpdate = confirm(
                        'ğŸ“„ è½‰ç§»è¨˜éŒ„ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                        'â“ æ˜¯å¦è¦æ¨™è¨˜é€™äº›è½‰ç§»ç‚ºã€Œå·²ä¸Šå‚³ã€ï¼Ÿ\n\n' +
                        `âœ… ç¢ºèªï¼šæ¨™è¨˜ ${result.assetIds.length} ç­†è½‰ç§»è¨˜éŒ„ç‚ºå·²ä¸Šå‚³\n` +
                        'âš ï¸  æé†’ï¼šæ¨™è¨˜å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                        'âŒ å–æ¶ˆï¼šåƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ¨™è¨˜ç‹€æ…‹'
                    );

                    // å†é–‹å•Ÿæ–‡ä»¶
                    window.open(result.fileUrl, '_blank');

                    if (shouldUpdate) {
                        updateTransferStatus(result.assetIds, keeperName, btn);
                    } else {
                        showMessage(`ğŸ“„ å·²æˆåŠŸç‚º ${keeperName} ç”¢ç”Ÿè½‰ç§»å ±è¡¨ï¼ˆæœªæ¨™è¨˜ä¸Šå‚³ï¼‰`, 'alert-info');
                        loadData();
                        btn.disabled = false;
                        btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .withFailureHandler(error => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå ±è¡¨';
                })
                .createTransferDoc(keeperName, assetCategory, null);
        }

        function generateConsolidatedDoc() {
            const selectedIds = Array.from(document.querySelectorAll('.detailed-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ä¾†ç”¢ç”Ÿå ±è¡¨ã€‚', 'alert-warning');
                return;
            }

            const btn = document.querySelector('.btn-success');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ç”¢ç”Ÿä¸­`;
            showPrintProgressBar('æ­£åœ¨ç”¢ç”Ÿå½™ç¸½è½‰ç§»å ±è¡¨...');

            google.script.run
                .withSuccessHandler(adminName => {
                    const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
                    google.script.run
                        .withSuccessHandler(result => {
                            hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå®Œæˆï¼');
                            // å…ˆè©¢å•æ˜¯å¦æ¨™è¨˜ç‚ºå·²ä¸Šå‚³
                            const shouldUpdate = confirm(
                                'ğŸ“„ å½™ç¸½è½‰ç§»è¨˜éŒ„ç”¢ç”ŸæˆåŠŸï¼\n\n' +
                                'â“ æ˜¯å¦è¦åœ¨ç”Ÿæˆæ–‡ä»¶å¾ŒåŒæ­¥æ›´æ–°é€™äº›è²¡ç”¢çš„æ›´æ–°ç‹€æ…‹ï¼Ÿ\n\n' +
                                'âš ï¸  æé†’ï¼šé¸æ“‡ã€ç¢ºå®šã€‘å¾Œï¼Œé€™äº›è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨å¾…åˆ—å°æ¸…å–®ä¸­\n\n' +
                                `âœ… ã€ç¢ºå®šã€‘= æ¨™è¨˜ ${result.assetIds.length} ç­†è½‰ç§»è¨˜éŒ„ç‚ºå·²æ›´æ–°ï¼ˆç„¡æ³•å†æ¬¡åˆ—å°ï¼‰\n` +
                                'âŒ ã€å–æ¶ˆã€‘= åƒ…é–‹å•Ÿæ–‡ä»¶ï¼Œä¸æ¨™è¨˜ç‹€æ…‹ï¼ˆå¯å†æ¬¡åˆ—å°ï¼Œéœ€è‡³â€ç¸½è¡¨æ›´æ–°â€œæ›´æ–°ç‹€æ…‹ï¼‰'
                            );

                            // å†é–‹å•Ÿæ–‡ä»¶
                            window.open(result.fileUrl, '_blank');

                            if (shouldUpdate) {
                                updateTransferStatus(result.assetIds, adminName, btn);
                            } else {
                                showMessage(`ğŸ“„ å·²æˆåŠŸç”¢ç”Ÿå½™ç¸½è½‰ç§»å ±è¡¨ï¼ˆæœªæ¨™è¨˜ä¸Šå‚³ï¼‰`, 'alert-info');
                                loadData();
                                btn.disabled = false;
                                btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                            }
                        })
                        .withFailureHandler(error => {
                            hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                            showError(error);
                            btn.disabled = false;
                            btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                        })
                        .createTransferDoc(adminName, assetCategory, selectedIds);
                })
                .withFailureHandler(error => {
                    hidePrintProgressBar('å ±è¡¨ç”¢ç”Ÿå¤±æ•—');
                    showError(error);
                    btn.disabled = false;
                    btn.textContent = 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨';
                })
                .getAdminName();
        }

        /**
         * æ¨™è¨˜è½‰ç§»è¨˜éŒ„ç‚ºã€Œå·²ä¸Šå‚³ã€
         * @param {Array<string>} assetIds - è¦æ¨™è¨˜çš„è³‡ç”¢IDé™£åˆ—
         * @param {string} userName - æ“ä½œè€…åç¨±
         * @param {HTMLElement} btn - æŒ‰éˆ•å…ƒç´ 
         */
        function updateTransferStatus(assetIds, userName, btn) {
            if (!assetIds || assetIds.length === 0) {
                showMessage('âŒ ç„¡æ³•æ›´æ–°ï¼šè³‡ç”¢IDåˆ—è¡¨ç‚ºç©º', 'alert-danger');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                }
                return;
            }

            // é¡¯ç¤ºæ›´æ–°ç‹€æ…‹
            if (btn) {
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­`;
            }

            google.script.run
                .withSuccessHandler(message => {
                    showMessage(`âœ… ${message}`, 'alert-success');
                    loadData();
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .withFailureHandler(error => {
                    showMessage(
                        'âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + error.message + '\n' +
                        'âš ï¸  æ–‡ä»¶å·²æˆåŠŸç”¢ç”Ÿï¼Œä½†æœªæ¨™è¨˜ç‚ºå·²ä¸Šå‚³ã€‚\n' +
                        'ğŸ’¡ è«‹ç¨å¾Œä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€æ‰‹å‹•æ›´æ–°ç‹€æ…‹ã€‚',
                        'alert-warning'
                    );
                    loadData();
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = btn.classList.contains('btn-success') ? 'ç”¢ç”Ÿå½™ç¸½å ±è¡¨' : 'ç”¢ç”Ÿå ±è¡¨';
                    }
                })
                .processUploadConfirmation(assetIds);
        }

        function showMessage(msg, className) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;
            setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = ''; }, 5000);
        }

        function showLoading(isLoading) {
            if (isLoading) {
                showProgressBar('æ­£åœ¨è¼‰å…¥å·²å®Œæˆè½‰ç§»æ¸…å–®...');
            } else {
                hideProgressBar('è¼‰å…¥å®Œæˆï¼', 300);
            }
            document.getElementById('simple-view').style.display = isLoading ? 'none' : (isDetailedView ? 'none' : 'block');
            document.getElementById('detailed-view').style.display = isLoading ? 'none' : (isDetailedView ? 'block' : 'none');
        }

        function showError(error) {
            showLoading(false);
            showMessage('éŒ¯èª¤ï¼š' + error.message, 'alert-danger');
        }

        /**
         * é¡¯ç¤ºæ­·å²ç´€éŒ„ Modal
         */
        function showHistory() {
            $('#historyModal').modal('show');
            const listBody = document.getElementById('history-list');
            listBody.innerHTML = '<tr><td colspan="4" class="text-center">è¼‰å…¥ä¸­...</td></tr>';

            const assetCategory = document.querySelector('input[name="assetCategory"]:checked').value;
            google.script.run
                .withSuccessHandler(renderHistoryTable)
                .withFailureHandler(error => {
                    listBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
                })
                .getTransferDocHistory(assetCategory);
        }

        /**
         * æ¸²æŸ“æ­·å²ç´€éŒ„è¡¨æ ¼
         * @param {Array} history - æ­·å²ç´€éŒ„é™£åˆ—
         */
        function renderHistoryTable(history) {
            const listBody = document.getElementById('history-list');
            listBody.innerHTML = '';

            if (!history || history.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" class="text-center">æ²’æœ‰æ­·å²ç´€éŒ„</td></tr>';
                return;
            }

            history.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.keeper}</td>
                    <td>${doc.date}</td>
                    <td>${doc.count}</td>
                    <td>
                        <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">é–‹å•Ÿæ–‡ä»¶</a>
                    </td>
                `;
                listBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
