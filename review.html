<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }

        #status-message {
            /* 確保狀態訊息顯示在進度條之上 */
            position: relative;
            z-index: 10000;  /* 高於進度條的 z-index: 9999 */
        }

        .approval-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .pagination-controls {
            margin-top: 15px;
            user-select: none;
        }
        .pagination-controls .page-link {
            cursor: pointer;
        }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
  <?!= include('progress_bar_review'); ?>

    <div id="main-content">
        <!-- 靜態區域：始終可見 -->
        <div id="static-header">
            <h4>財產轉移接收儀表板</h4>
            <p class="text-muted">以下是所有待您接收的財產轉移申請，您可以使用篩選器快速尋找。</p>
            <hr>

            <!-- 篩選器區塊 -->
            <div class="form-row mb-3">
                <div class="form-group col-md-5">
                    <label for="location-filter-select">依「原保管地點」篩選：</label>
                    <select id="location-filter-select" class="form-control">
                        <option value="">-- 顯示全部地點 --</option>
                    </select>
                </div>
                <div class="form-group col-md-7">
                    <label for="search-box">依「關鍵字」搜尋 (產編/產名/原保管人)：</label>
                    <input type="text" class="form-control" id="search-box" placeholder="輸入關鍵字...">
                </div>
            </div>
        </div>

        <!-- 動態區域：載入時隱藏 -->
        <div id="dynamic-form">
            <!-- 表格區塊 -->
            <div id="approval-table-container" class="approval-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 4%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 11%;">財產編號</th>
                            <th style="width: 13%;">財產名稱</th>
                            <th style="width: 15%;">保管人變更</th>
                            <th style="width: 15%;">使用人變更</th>
                            <th style="width: 15%;">地點變更</th>
                            <th style="width: 13%;">轉移類型</th>
                            <th style="width: 14%;">申請時間</th>
                        </tr>
                    </thead>
                    <tbody id="approval-list"></tbody>
                </table>
            </div>

            <!-- 分頁控制項 -->
            <div id="pagination-controls" class="d-flex justify-content-between align-items-center"></div>

            <div id="no-data-message" class="alert alert-info mt-3" style="display:none;">
                恭喜！目前沒有任何待您接收的項目。
            </div>

            <!-- 操作按鈕 -->
            <div class="mt-4">
                <button id="submit-btn" class="btn btn-success btn-lg" onclick="submitApproval()">批次核准所選項目</button>
            </div>
        </div>

        <div id="status-message" class="mt-3"></div>
    </div>

    <script>
        // JavaScript 邏輯完全不需要修改，因此維持原樣
        let allApprovals = [];
        let filteredApprovals = [];
        let currentPage = 1;
        const rowsPerPage = 2000;

        document.addEventListener("DOMContentLoaded", loadData);


        function loadData() {
            console.log(`[FRONTEND] 開始呼叫後端 getPendingApprovals 函式... 時間: ${new Date().toLocaleTimeString()}`);

            // 只隱藏動態區域
            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';

            showProgressBar('正在載入您的待接收清單...');
            const startTime = new Date();

            google.script.run
                .withSuccessHandler(response => {
                    const endTime = new Date();
                    const duration = (endTime - startTime) / 1000;
                    console.log(`[FRONTEND] 成功從後端接收到資料！耗時 ${duration.toFixed(2)} 秒。`);
                    populateData(response);
                })
                .withFailureHandler(handleError)
                .getPendingApprovals();
        }
        
        function populateData(response) {
            console.log("[FRONTEND] populateData 函式開始執行...");
            if (response.error) { handleError({message: response.error}); return; }

            allApprovals = response.approvals || [];
            filteredApprovals = allApprovals;
            console.log(`[FRONTEND] 接收到 ${allApprovals.length} 筆待審核資料。`);

            hideProgressBar('資料載入完成！', 300);

            // 延遲顯示動態區域（與進度條隱藏動畫同步）
            setTimeout(() => {
                const dynamicForm = document.getElementById('dynamic-form');

                if (allApprovals.length > 0) {
                    populateLocationFilter(allApprovals);
                    currentPage = 1;
                    renderPage(currentPage);

                    // 綁定事件監聽器（只在首次載入時綁定）
                    if (!dynamicForm.dataset.initialized) {
                        document.getElementById('location-filter-select').addEventListener('change', filterTable);
                        document.getElementById('search-box').addEventListener('input', filterTable);
                        document.getElementById('select-all').addEventListener('change', (e) => {
                            document.querySelectorAll('.approval-checkbox').forEach(cb => cb.checked = e.target.checked);
                        });
                        dynamicForm.dataset.initialized = 'true';
                    }

                    dynamicForm.style.display = 'block';
                } else {
                    console.log("[FRONTEND] 沒有待審核資料，顯示提示訊息。");
                    // 只更新 dynamic-form，保持標題和篩選器可見
                    dynamicForm.innerHTML = `
                        <div class="alert alert-info" role="alert">
                            <h5 class="alert-heading">恭喜！目前沒有待接收的項目</h5>
                            <p>您目前沒有任何待接收的財產轉移申請。</p>
                            <hr>
                            <p class="mb-0">如有疑問，請聯絡系統管理員。</p>
                        </div>
                    `;
                    dynamicForm.style.display = 'block';
                }
            }, 300);
        }

        function populateLocationFilter(approvals) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            const uniqueLocations = [...new Set(approvals.map(item => item.oldLocation))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();

            filteredApprovals = allApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    item.oldKeeper.toUpperCase().includes(searchFilter);
                return locationMatch && searchMatch;
            });
            
            currentPage = 1;
            renderPage(currentPage);
        }

        function renderPage(page) {
            const tableStartTime = new Date();
            console.log(`[FRONTEND] 開始在瀏覽器中渲染第 ${page} 頁的表格...`);
            
            currentPage = page;
            const approvalListBody = document.getElementById('approval-list');
            
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredApprovals.slice(start, end);

            let tableHtml = '';
            paginatedItems.forEach(item => {
                // ✨ 根據轉移類型顯示不同顏色的標籤
                const transferType = item.transferType || '地點';
                let typeBadge = '';
                if (transferType.includes('保管人') && transferType.includes('使用人')) {
                    typeBadge = '<span class="badge badge-danger">保管人+使用人</span>';
                } else if (transferType.includes('保管人')) {
                    typeBadge = '<span class="badge badge-warning">保管人</span>';
                } else if (transferType.includes('使用人')) {
                    typeBadge = '<span class="badge badge-info">使用人</span>';
                } else {
                    typeBadge = '<span class="badge badge-secondary">地點</span>';
                }

                // ✨ 方案B：箭頭式顯示變更
                // 保管人變更
                const keeperChange = (item.newKeeper && item.oldKeeper !== item.newKeeper)
                    ? `${item.oldKeeper} <span class="text-primary">→</span> ${item.newKeeper}`
                    : item.oldKeeper;

                // 使用人變更
                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userChange = (newUser && oldUser !== newUser)
                    ? `${oldUser} <span class="text-primary">→</span> ${newUser}`
                    : oldUser;

                // 地點變更
                const locationChange = (item.newLocation && item.oldLocation !== item.newLocation)
                    ? `${item.oldLocation} <span class="text-primary">→</span> ${item.newLocation}`
                    : item.oldLocation;

                tableHtml += `
                    <tr>
                        <td><input type="checkbox" class="approval-checkbox" value="${item.appId}"></td>
                        <td>${item.assetId}</td>
                        <td>${item.assetName}</td>
                        <td>${keeperChange}</td>
                        <td>${userChange}</td>
                        <td>${locationChange}</td>
                        <td>${typeBadge}</td>
                        <td>${item.applyTime}</td>
                    </tr>`;
            });
            approvalListBody.innerHTML = tableHtml;

            const tableEndTime = new Date();
            const duration = (tableEndTime - tableStartTime);
            console.log(`[FRONTEND] 表格渲染完成！共 ${paginatedItems.length} 列。耗時 ${duration} 毫秒。`);

            renderPaginationControls();
            document.getElementById('select-all').checked = false;
        }
        
        function renderPaginationControls() {
            const controlsContainer = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(filteredApprovals.length / rowsPerPage);
            
            if (filteredApprovals.length === 0) {
                controlsContainer.innerHTML = '<span class="text-muted">沒有符合篩選條件的項目。</span>';
                return;
            }
            if (totalPages <= 1) {
                controlsContainer.innerHTML = `<span class="text-muted">共 ${filteredApprovals.length} 筆資料</span>`;
                return;
            }

            let paginationHtml = `<span class="text-muted">共 ${filteredApprovals.length} 筆資料，第 ${currentPage} / ${totalPages} 頁</span>`;
            
            let buttonsHtml = '<ul class="pagination mb-0">';
            buttonsHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage - 1})">上一頁</a></li>`;
            buttonsHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage + 1})">下一頁</a></li>`;
            buttonsHtml += '</ul>';
            
            controlsContainer.innerHTML = paginationHtml + buttonsHtml;
        }
        
        function submitApproval() {
            const checkedBoxes = document.querySelectorAll('.approval-checkbox:checked');
            const selectedAppIds = Array.from(checkedBoxes).map(cb => cb.value);

            console.log(`[FRONTEND] submitApproval 函式被觸發，共勾選了 ${selectedAppIds.length} 筆資料。`);
            if (selectedAppIds.length === 0) {
                showMessage('請至少勾選一個項目再送出。', 'alert-warning');
                return;
            }

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // 隱藏動態區域

            console.log("[FRONTEND] 開始呼叫後端 processBatchApproval 函式...");
            showProgressBar('正在批次處理核准作業...');
            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleError)
                .processBatchApproval(selectedAppIds);
        }

        function handleSuccess(message) {
            console.log(`[FRONTEND] 後端 processBatchApproval 執行成功，回傳訊息: "${message}"`);
            // 步驟 1：隱藏提交時的進度條
            hideProgressBar('處理完成！', 0);

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // 確保動態區域隱藏

            // 步驟 2：立即顯示綠色提示訊息（3 秒後自動消失）
            showMessage(message + ' 正在重新載入資料...', 'alert-success');

            // 步驟 3：短暫延遲後啟動重新載入進度條（讓用戶先看到綠色訊息）
            setTimeout(() => {
                loadData();  // 這會調用 showProgressBar()
            }, 150);  // 150ms 延遲，確保綠色訊息先渲染
        }

        function handleError(error) {
            console.error(`[FRONTEND] 發生錯誤！錯誤訊息: ${error.message}`);
            hideProgressBar('載入失敗！', 300); // 使用新的進度條組件

            setTimeout(() => {
                showMessage('錯誤：' + error.message, 'alert-danger');
            }, 300);
        }

        /**
         * 顯示提示訊息（3 秒後自動消失）
         * @param {string} msg - 訊息內容
         * @param {string} className - Bootstrap alert 樣式類別
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.innerHTML = msg.replace(/\n/g, '<br>');

            // 3 秒後自動清除訊息
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }
    </script>
</body>
</html>
