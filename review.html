<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }

        #status-message {
            /* ç¢ºä¿ç‹€æ…‹è¨Šæ¯é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¹‹ä¸Š */
            position: relative;
            z-index: 10000;  /* é«˜æ–¼é€²åº¦æ¢çš„ z-index: 9999 */
        }

        .approval-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .pagination-controls {
            margin-top: 15px;
            user-select: none;
        }
        .pagination-controls .page-link {
            cursor: pointer;
        }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
  <?!= include('progress_bar_review'); ?>

    <div id="main-content">
        <!-- éœæ…‹å€åŸŸï¼šå§‹çµ‚å¯è¦‹ -->
        <div id="static-header">
            <h4>è²¡ç”¢è½‰ç§»æ¥æ”¶å„€è¡¨æ¿</h4>
            <p class="text-muted">ä»¥ä¸‹æ˜¯æ‰€æœ‰å¾…æ‚¨æ¥æ”¶çš„è²¡ç”¢è½‰ç§»ç”³è«‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç¯©é¸å™¨å¿«é€Ÿå°‹æ‰¾ã€‚</p>
            <hr>

            <!-- ç¯©é¸å™¨å€å¡Š -->
            <div class="form-row mb-3">
                <div class="form-group col-md-5">
                    <label for="location-filter-select">ä¾ã€ŒåŸä¿ç®¡åœ°é»ã€ç¯©é¸ï¼š</label>
                    <select id="location-filter-select" class="form-control">
                        <option value="">-- é¡¯ç¤ºå…¨éƒ¨åœ°é» --</option>
                    </select>
                </div>
                <div class="form-group col-md-7">
                    <label for="search-box">ä¾ã€Œé—œéµå­—ã€æœå°‹ (ç”¢ç·¨/ç”¢å/åŸä¿ç®¡äºº)ï¼š</label>
                    <input type="text" class="form-control" id="search-box" placeholder="è¼¸å…¥é—œéµå­—...">
                </div>
            </div>
        </div>

        <!-- å‹•æ…‹å€åŸŸï¼šè¼‰å…¥æ™‚éš±è— -->
        <div id="dynamic-form">
            <!-- è¡¨æ ¼å€å¡Š -->
            <div id="approval-table-container" class="approval-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 4%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 10%;">è²¡ç”¢ç·¨è™Ÿ</th>
                            <th style="width: 11%;">è²¡ç”¢åç¨±</th>
                            <th style="width: 12%;">å‹è™Ÿ/å» ç‰Œ</th>
                            <th style="width: 14%;">ä¿ç®¡äººè®Šæ›´</th>
                            <th style="width: 14%;">ä½¿ç”¨äººè®Šæ›´</th>
                            <th style="width: 13%;">åœ°é»è®Šæ›´</th>
                            <th style="width: 11%;">è½‰ç§»é¡å‹</th>
                            <th style="width: 11%;">ç”³è«‹æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="approval-list"></tbody>
                </table>
            </div>

            <!-- åˆ†é æ§åˆ¶é … -->
            <div id="pagination-controls" class="d-flex justify-content-between align-items-center"></div>

            <div id="no-data-message" class="alert alert-info mt-3" style="display:none;">
                æ­å–œï¼ç›®å‰æ²’æœ‰ä»»ä½•å¾…æ‚¨æ¥æ”¶çš„é …ç›®ã€‚
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="mt-4">
                <button id="submit-btn" class="btn btn-success btn-lg" onclick="submitApproval()">æ‰¹æ¬¡æ ¸å‡†æ‰€é¸é …ç›®</button>
            </div>
        </div>

        <div id="status-message" class="mt-3"></div>
    </div>

    <script>
        // JavaScript é‚è¼¯å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼Œå› æ­¤ç¶­æŒåŸæ¨£
        let allApprovals = [];
        let filteredApprovals = [];
        let currentPage = 1;
        const rowsPerPage = 2000;

        document.addEventListener("DOMContentLoaded", loadData);


        function loadData() {
            console.log(`[FRONTEND] é–‹å§‹å‘¼å«å¾Œç«¯ getPendingApprovals å‡½å¼... æ™‚é–“: ${new Date().toLocaleTimeString()}`);

            // åªéš±è—å‹•æ…‹å€åŸŸ
            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';

            showProgressBar('æ­£åœ¨è¼‰å…¥æ‚¨çš„å¾…æ¥æ”¶æ¸…å–®...');
            const startTime = new Date();

            google.script.run
                .withSuccessHandler(response => {
                    const endTime = new Date();
                    const duration = (endTime - startTime) / 1000;
                    console.log(`[FRONTEND] æˆåŠŸå¾å¾Œç«¯æ¥æ”¶åˆ°è³‡æ–™ï¼è€—æ™‚ ${duration.toFixed(2)} ç§’ã€‚`);
                    populateData(response);
                })
                .withFailureHandler(handleError)
                .getPendingApprovals();
        }
        
        function populateData(response) {
            console.log("[FRONTEND] populateData å‡½å¼é–‹å§‹åŸ·è¡Œ...");
            if (response.error) { handleError({message: response.error}); return; }

            allApprovals = response.approvals || [];
            filteredApprovals = allApprovals;
            console.log(`[FRONTEND] æ¥æ”¶åˆ° ${allApprovals.length} ç­†å¾…å¯©æ ¸è³‡æ–™ã€‚`);

            hideProgressBar('è³‡æ–™è¼‰å…¥å®Œæˆï¼', 300);

            // å»¶é²é¡¯ç¤ºå‹•æ…‹å€åŸŸï¼ˆèˆ‡é€²åº¦æ¢éš±è—å‹•ç•«åŒæ­¥ï¼‰
            setTimeout(() => {
                const dynamicForm = document.getElementById('dynamic-form');

                if (allApprovals.length > 0) {
                    populateLocationFilter(allApprovals);
                    currentPage = 1;
                    renderPage(currentPage);

                    // ç¶å®šäº‹ä»¶ç›£è½å™¨ï¼ˆåªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚ç¶å®šï¼‰
                    if (!dynamicForm.dataset.initialized) {
                        document.getElementById('location-filter-select').addEventListener('change', filterTable);
                        document.getElementById('search-box').addEventListener('input', filterTable);
                        document.getElementById('select-all').addEventListener('change', (e) => {
                            document.querySelectorAll('.approval-checkbox').forEach(cb => cb.checked = e.target.checked);
                        });
                        dynamicForm.dataset.initialized = 'true';
                    }

                    dynamicForm.style.display = 'block';
                } else {
                    console.log("[FRONTEND] æ²’æœ‰å¾…å¯©æ ¸è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯ã€‚");
                    // åªæ›´æ–° dynamic-formï¼Œä¿æŒæ¨™é¡Œå’Œç¯©é¸å™¨å¯è¦‹
                    dynamicForm.innerHTML = `
                        <div class="alert alert-info" role="alert">
                            <h5 class="alert-heading">æ­å–œï¼ç›®å‰æ²’æœ‰å¾…æ¥æ”¶çš„é …ç›®</h5>
                            <p>æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•å¾…æ¥æ”¶çš„è²¡ç”¢è½‰ç§»ç”³è«‹ã€‚</p>
                            <hr>
                            <p class="mb-0">å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
                        </div>
                    `;
                    dynamicForm.style.display = 'block';
                }
            }, 300);
        }

        function populateLocationFilter(approvals) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            const uniqueLocations = [...new Set(approvals.map(item => item.oldLocation))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();

            filteredApprovals = allApprovals.filter(item => {
                const locationMatch = (locationFilter === '') || (item.oldLocation.toUpperCase() === locationFilter);
                const searchMatch = item.assetId.toUpperCase().includes(searchFilter) ||
                                    (item.assetName && item.assetName.toUpperCase().includes(searchFilter)) ||
                                    item.oldKeeper.toUpperCase().includes(searchFilter);
                return locationMatch && searchMatch;
            });
            
            currentPage = 1;
            renderPage(currentPage);
        }

        function renderPage(page) {
            const tableStartTime = new Date();
            console.log(`[FRONTEND] é–‹å§‹åœ¨ç€è¦½å™¨ä¸­æ¸²æŸ“ç¬¬ ${page} é çš„è¡¨æ ¼...`);
            
            currentPage = page;
            const approvalListBody = document.getElementById('approval-list');
            
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredApprovals.slice(start, end);

            let tableHtml = '';
            paginatedItems.forEach(item => {
                // âœ¨ æ ¹æ“šè½‰ç§»é¡å‹é¡¯ç¤ºä¸åŒé¡è‰²çš„æ¨™ç±¤
                const transferType = item.transferType || 'åœ°é»';
                let typeBadge = '';
                // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
                const row = document.createElement('tr');

                // Checkbox å„²å­˜æ ¼
                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'approval-checkbox';
                checkbox.value = item.appId;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                // è³‡ç”¢ç·¨è™Ÿå’Œåç¨±
                const assetIdTd = document.createElement('td');
                assetIdTd.textContent = item.assetId;
                row.appendChild(assetIdTd);

                const assetNameTd = document.createElement('td');
                assetNameTd.textContent = item.assetName;
                row.appendChild(assetNameTd);

                const modelBrandTd = document.createElement('td');
                modelBrandTd.textContent = item.modelBrand || '';
                row.appendChild(modelBrandTd);

                // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹è®Šæ›´é¡¯ç¤ºå„²å­˜æ ¼
                function createChangeTd(oldVal, newVal, hasChange) {
                    const td = document.createElement('td');
                    if (hasChange) {
                        td.appendChild(document.createTextNode(oldVal || ''));
                        const arrow = document.createElement('span');
                        arrow.className = 'text-primary';
                        arrow.textContent = ' â†’ ';
                        td.appendChild(arrow);
                        td.appendChild(document.createTextNode(newVal || ''));
                    } else {
                        td.textContent = oldVal || '';
                    }
                    return td;
                }

                // ä¿ç®¡äººè®Šæ›´
                const keeperHasChange = item.newKeeper && item.oldKeeper !== item.newKeeper;
                row.appendChild(createChangeTd(item.oldKeeper, item.newKeeper, keeperHasChange));

                // ä½¿ç”¨äººè®Šæ›´
                const oldUser = item.oldUser || item.userName || '';
                const newUser = item.newUser || '';
                const userHasChange = newUser && oldUser !== newUser;
                row.appendChild(createChangeTd(oldUser, newUser, userHasChange));

                // åœ°é»è®Šæ›´
                const locationHasChange = item.newLocation && item.oldLocation !== item.newLocation;
                row.appendChild(createChangeTd(item.oldLocation, item.newLocation, locationHasChange));

                // è½‰ç§»é¡å‹ Badge
                const typeTd = document.createElement('td');
                const typeBadgeEl = document.createElement('span');
                if (transferType.includes('ä¿ç®¡äºº') && transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-danger';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº+ä½¿ç”¨äºº';
                } else if (transferType.includes('ä¿ç®¡äºº')) {
                    typeBadgeEl.className = 'badge badge-warning';
                    typeBadgeEl.textContent = 'ä¿ç®¡äºº';
                } else if (transferType.includes('ä½¿ç”¨äºº')) {
                    typeBadgeEl.className = 'badge badge-info';
                    typeBadgeEl.textContent = 'ä½¿ç”¨äºº';
                } else {
                    typeBadgeEl.className = 'badge badge-secondary';
                    typeBadgeEl.textContent = 'åœ°é»';
                }
                typeTd.appendChild(typeBadgeEl);
                row.appendChild(typeTd);

                // ç”³è«‹æ™‚é–“
                const applyTimeTd = document.createElement('td');
                applyTimeTd.textContent = item.applyTime;
                row.appendChild(applyTimeTd);

                approvalListBody.appendChild(row);
            });

            const tableEndTime = new Date();
            const duration = (tableEndTime - tableStartTime);
            console.log(`[FRONTEND] è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼å…± ${paginatedItems.length} åˆ—ã€‚è€—æ™‚ ${duration} æ¯«ç§’ã€‚`);

            renderPaginationControls();
            document.getElementById('select-all').checked = false;
        }
        
        function renderPaginationControls() {
            const controlsContainer = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(filteredApprovals.length / rowsPerPage);
            
            if (filteredApprovals.length === 0) {
                controlsContainer.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                controlsContainer.innerHTML = `<span class="text-muted">å…± ${filteredApprovals.length} ç­†è³‡æ–™</span>`;
                return;
            }

            let paginationHtml = `<span class="text-muted">å…± ${filteredApprovals.length} ç­†è³‡æ–™ï¼Œç¬¬ ${currentPage} / ${totalPages} é </span>`;
            
            let buttonsHtml = '<ul class="pagination mb-0">';
            buttonsHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage - 1})">ä¸Šä¸€é </a></li>`;
            buttonsHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage + 1})">ä¸‹ä¸€é </a></li>`;
            buttonsHtml += '</ul>';
            
            controlsContainer.innerHTML = paginationHtml + buttonsHtml;
        }
        
        function submitApproval() {
            const checkedBoxes = document.querySelectorAll('.approval-checkbox:checked');
            const selectedAppIds = Array.from(checkedBoxes).map(cb => cb.value);

            console.log(`[FRONTEND] submitApproval å‡½å¼è¢«è§¸ç™¼ï¼Œå…±å‹¾é¸äº† ${selectedAppIds.length} ç­†è³‡æ–™ã€‚`);
            if (selectedAppIds.length === 0) {
                showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®å†é€å‡ºã€‚', 'alert-warning');
                return;
            }

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // éš±è—å‹•æ…‹å€åŸŸ

            console.log("[FRONTEND] é–‹å§‹å‘¼å«å¾Œç«¯ processBatchApproval å‡½å¼...");
            showProgressBar('æ­£åœ¨æ‰¹æ¬¡è™•ç†æ ¸å‡†ä½œæ¥­...');
            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleError)
                .processBatchApproval(selectedAppIds);
        }

        function handleSuccess(message) {
            console.log(`[FRONTEND] å¾Œç«¯ processBatchApproval åŸ·è¡ŒæˆåŠŸï¼Œå›å‚³è¨Šæ¯: "${message}"`);
            // æ­¥é©Ÿ 1ï¼šéš±è—æäº¤æ™‚çš„é€²åº¦æ¢
            hideProgressBar('è™•ç†å®Œæˆï¼', 0);

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // ç¢ºä¿å‹•æ…‹å€åŸŸéš±è—

            // æ­¥é©Ÿ 2ï¼šç«‹å³é¡¯ç¤ºç¶ è‰²æç¤ºè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
            showMessage(message + ' æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...', 'alert-success');

            // æ­¥é©Ÿ 3ï¼šçŸ­æš«å»¶é²å¾Œå•Ÿå‹•é‡æ–°è¼‰å…¥é€²åº¦æ¢ï¼ˆè®“ç”¨æˆ¶å…ˆçœ‹åˆ°ç¶ è‰²è¨Šæ¯ï¼‰
            setTimeout(() => {
                loadData();  // é€™æœƒèª¿ç”¨ showProgressBar()
            }, 150);  // 150ms å»¶é²ï¼Œç¢ºä¿ç¶ è‰²è¨Šæ¯å…ˆæ¸²æŸ“
        }

        function handleError(error) {
            console.error(`[FRONTEND] ç™¼ç”ŸéŒ¯èª¤ï¼éŒ¯èª¤è¨Šæ¯: ${error.message}`);
            hideProgressBar('è¼‰å…¥å¤±æ•—ï¼', 300); // ä½¿ç”¨æ–°çš„é€²åº¦æ¢çµ„ä»¶

            setTimeout(() => {
                showMessage('éŒ¯èª¤ï¼š' + error.message, 'alert-danger');
            }, 300);
        }

        /**
         * é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
         * @param {string} msg - è¨Šæ¯å…§å®¹
         * @param {string} className - Bootstrap alert æ¨£å¼é¡åˆ¥
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.innerHTML = msg.replace(/\n/g, '<br>');

            // 3 ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }
    </script>
</body>
</html>
