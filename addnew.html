<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message { margin-top: 15px; font-weight: bold; }
        .required-field::after { content: "*"; color: red; margin-left: 4px; }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('progress_bar_addnew'); ?>

    <div id="main-form" style="display:none;" class="container-fluid">
        <h4 class="mb-4">新增財產 / 物品</h4>

        <form id="add-asset-form">
            <!-- 類型選擇 -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    資料類型
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="assetType" id="typeProperty" value="property" checked onchange="toggleFields()">
                            <label class="form-check-label" for="typeProperty">財產 (列入財產總表)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="assetType" id="typeItem" value="item" onchange="toggleFields()">
                            <label class="form-check-label" for="typeItem">物品 (列入物品總表)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 基本資料 -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    基本資料
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="assetId" class="required-field">編號</label>
                            <input type="text" class="form-control" id="assetId" required placeholder="例如：A1120001">
                            <small class="form-text text-muted">請輸入完整的財產或物品編號，系統將檢查唯一性。</small>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="assetName" class="required-field">名稱</label>
                            <input type="text" class="form-control" id="assetName" required placeholder="例如：ASUS 筆記型電腦">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="modelBrand">型號/廠牌</label>
                            <input type="text" class="form-control" id="modelBrand" placeholder="例如：ASUS VivoBook 15">
                        </div>
                         <div class="form-group col-md-4">
                            <label for="category">類別</label>
                            <input type="text" class="form-control" id="category" list="categoryList" placeholder="選擇或輸入類別">
                            <datalist id="categoryList"></datalist>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="purchaseDate">取得日期</label>
                            <input type="date" class="form-control" id="purchaseDate">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="useLife">使用年限 (年)</label>
                            <input type="number" class="form-control" id="useLife" min="0" placeholder="例如：3">
                        </div>
                        <div class="form-group col-md-4">
                            <label>資訊資產標記</label>

                            <!-- 第一層：資訊資產主控 checkbox -->
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isItAsset">
                                <label class="form-check-label" for="isItAsset">
                                    此設備是否為資訊資產？
                                </label>
                            </div>

                            <!-- 第二層：子選項容器，預設隱藏 -->
                            <div id="it-asset-sub-options" style="display: none; margin-left: 20px; margin-top: 10px;">
                                <!-- 子選項 1：電腦主機/筆電 -->
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isActuallyComputer">
                                    <label class="form-check-label" for="isActuallyComputer">
                                        此設備為電腦主機/筆電
                                    </label>
                                </div>

                                <!-- 子選項 2：ISO 驗證範圍 -->
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="isIsoScope">
                                    <label class="form-check-label" for="isIsoScope">
                                        此設備是否在 ISO 驗證範圍內
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 保管與位置 -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    保管與位置
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="location" class="required-field">保管地點</label>
                            <select class="form-control" id="location" required>
                                <option value="">載入中...</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="keeper" class="required-field">保管人</label>
                            <select class="form-control" id="keeper" required onchange="autoFillUser()">
                                <option value="">載入中...</option>
                            </select>
                        </div>
                         <div class="form-group col-md-4 property-only">
                            <label for="user">使用人 (預設同保管人)</label>
                            <select class="form-control" id="user">
                                <option value="">同保管人</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他 -->
            <div class="form-group">
                <label for="remarks">備註</label>
                <textarea class="form-control" id="remarks" rows="3"></textarea>
            </div>

            <button type="button" class="btn btn-primary btn-lg btn-block" onclick="submitForm()">新增資料</button>
        </form>
    </div>

    <div id="status-message"></div>

    <script>
        let keeperMap = {}; // Email -> Name
        let userMap = {};   // Email -> Name

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('main-form').style.display = 'none';
            showProgressBarAddnew('正在載入選單資料...');

            // ✨ 新增：設定資訊資產連動邏輯
            setupItAssetDependency();

            google.script.run
                .withSuccessHandler(initForm)
                .withFailureHandler(onLoadError)
                .getDropdownData();
        });

        function initForm(data) {
            hideProgressBarAddnew('載入完成');
            setTimeout(() => {
                document.getElementById('main-form').style.display = 'block';
                
                // 填充地點
                const locationSelect = document.getElementById('location');
                locationSelect.innerHTML = '<option value="">請選擇地點...</option>';
                data.locations.forEach(loc => {
                    locationSelect.add(new Option(loc, loc));
                });

                // 填充保管人與使用人
                const keeperSelect = document.getElementById('keeper');
                const userSelect = document.getElementById('user');
                keeperSelect.innerHTML = '<option value="">請選擇保管人...</option>';
                userSelect.innerHTML = '<option value="">同保管人</option>';
                
                keeperMap = data.keepers;
                userMap = data.keepers; // 假設使用人列表同保管人

                // 排序並加入選單
                const sortedKeepers = Object.entries(keeperMap).sort((a, b) => a[1].localeCompare(b[1], 'zh-Hant'));
                
                sortedKeepers.forEach(([email, name]) => {
                    keeperSelect.add(new Option(`${name} (${email})`, email));
                    userSelect.add(new Option(`${name} (${email})`, email));
                });

                // 填充類別 Datalist
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';  // ✅ 先清空舊選項
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    categoryList.appendChild(option);
                });

            }, 300);
        }

        function toggleFields() {
            const type = document.querySelector('input[name="assetType"]:checked').value;
            const propertyOnlyFields = document.querySelectorAll('.property-only');

            propertyOnlyFields.forEach(el => {
                el.style.display = (type === 'property') ? 'block' : 'none';
            });

            if (type === 'item') {
                document.getElementById('user').value = ""; // 清空使用人
            }
        }

        /**
         * ✨ 新增：設定資訊資產 checkbox 與子選項的連動關係
         */
        function setupItAssetDependency() {
            const mainCheckbox = document.getElementById('isItAsset');
            const subOptionsContainer = document.getElementById('it-asset-sub-options');
            const computerCheckbox = document.getElementById('isActuallyComputer');
            const isoCheckbox = document.getElementById('isIsoScope');

            mainCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    // 勾選時：顯示子選項（保留其原有狀態）
                    subOptionsContainer.style.display = 'block';
                } else {
                    // 取消勾選時：隱藏子選項並重置其狀態
                    subOptionsContainer.style.display = 'none';
                    computerCheckbox.checked = false;
                    isoCheckbox.checked = false;
                }
            });
        }

        function autoFillUser() {
            const type = document.querySelector('input[name="assetType"]:checked').value;
            const keeperVal = document.getElementById('keeper').value;
            
            // 如果是財產模式，且使用人尚未選擇，則預設選為保管人
            if (type === 'property' && document.getElementById('user').value === "") {
                document.getElementById('user').value = keeperVal;
            }
        }

        function submitForm() {
            const form = {
                assetType: document.querySelector('input[name="assetType"]:checked').value,
                assetId: document.getElementById('assetId').value.trim(),
                assetName: document.getElementById('assetName').value.trim(),
                modelBrand: document.getElementById('modelBrand').value.trim(),    // ✨ 新增型號/廠牌
                category: document.getElementById('category').value.trim(),
                purchaseDate: document.getElementById('purchaseDate').value,
                useLife: document.getElementById('useLife').value,
                isItAsset: document.getElementById('isItAsset').checked,           // ✨ 新增
                isActuallyComputer: document.getElementById('isActuallyComputer').checked,
                isIsoScope: document.getElementById('isIsoScope').checked,         // ✨ 新增
                location: document.getElementById('location').value,
                keeperEmail: document.getElementById('keeper').value,
                userEmail: document.getElementById('user').value,
                remarks: document.getElementById('remarks').value.trim()
            };

            // 驗證
            if (!form.assetId || !form.assetName || !form.location || !form.keeperEmail) {
                showError({message: "請填寫所有必填欄位 (編號、名稱、地點、保管人)"});
                return;
            }

            document.getElementById('main-form').style.display = 'none';
            // 使用新的進度條
            showProgressBarAddnew('處理中，請稍候...');
            
            document.getElementById('status-message').textContent = '';
            document.getElementById('status-message').className = '';

            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onSubmitError)
                .addNewAsset(form);
        }

        function onSuccess(message) {
            // 使用新的進度條隱藏函數
            hideProgressBarAddnew('新增成功！');

            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-success text-center';
            statusMsg.textContent = message;

            // 2秒後重置表單並重新載入資料
            setTimeout(() => {
                statusMsg.textContent = '';
                statusMsg.className = '';

                // 重置表單
                document.getElementById('add-asset-form').reset();
                document.getElementById('typeProperty').checked = true;
                toggleFields(); // 恢復財產模式的欄位顯示

                // ✨ 新增：重置資訊資產連動狀態
                document.getElementById('it-asset-sub-options').style.display = 'none';
                document.getElementById('isItAsset').checked = false;
                document.getElementById('isActuallyComputer').checked = false;
                document.getElementById('isIsoScope').checked = false;

                // 重新載入下拉選單資料
                document.getElementById('main-form').style.display = 'none';
                showProgressBarAddnew('準備繼續新增...');

                google.script.run
                    .withSuccessHandler(initForm)
                    .withFailureHandler(onLoadError)
                    .getDropdownData();
            }, 2000);
        }

        // 專門處理初始載入錯誤
        function onLoadError(error) {
            hideProgressBarAddnew('載入失敗', 300);
            setTimeout(() => {
                document.getElementById('main-form').style.display = 'block';
                showError(error);
            }, 300);
        }

        // 專門處理送出表單錯誤
        function onSubmitError(error) {
            hideProgressBarAddnew('新增失敗', 300);
            setTimeout(() => {
                document.getElementById('main-form').style.display = 'block';
                showError(error);
            }, 300);
        }

        function showError(error) {
            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "錯誤：" + error.message;
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>