<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 引入 FontAwesome 增加圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f4f7f6;
        }

        /* 響應式容器 */
        .container-responsive {
            max-width: 1200px;
            margin: 0 auto;
        }

        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 卡片樣式優化 */
        .section-card {
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: none;
        }

        .session-item { cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; position: relative; }
        .session-item:hover { background-color: #f0f0f0; }
        .session-item.active { background-color: #fff3cd; border-color: #f1c40f; box-shadow: 0 0 0 2px rgba(241, 196, 15, 0.35); }
        .session-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background-color: #f1c40f; border-radius: 5px 0 0 5px; }

        /* 資產清單容器 - 移除固定高度,避免內部捲動 */
        .asset-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .asset-item:last-child { border-bottom: none; }
        .asset-item:hover { background-color: #f1f8ff; }

        .badge-result { padding: 5px 10px; border-radius: 3px; font-size: 0.9em; }
        .result-normal { background-color: #4caf50; color: white; }
        .result-missing { background-color: #f44336; color: white; }
        .result-damaged { background-color: #ff9800; color: white; }
        .result-unverified { background-color: #9e9e9e; color: white; }
        .progress-container { margin: 15px 0; }
        .stats-box { padding: 15px; background-color: #f5f5f5; border-radius: 5px; margin-top: 15px; }

        /* 批次操作相關樣式 */
        #batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #batch-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* 資產卡片 checkbox 樣式 */
        .asset-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 0;
            transition: all 0.2s;
        }

        .asset-item:has(.asset-checkbox:checked) {
            border-color: #007bff;
            background-color: #e7f3ff;
        }

        .asset-item-header {
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 10px;
            border-bottom: 1px solid #eee;
        }

        .asset-item-header .btn {
            font-size: 0.85rem;
            padding: 4px 10px;
        }

        .asset-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .asset-item-body {
            padding: 10px;
            cursor: pointer;
        }

        .asset-item-body:hover {
            background-color: #f8f9fa;
        }

        .asset-item-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            margin: 0;
        }
        
        /* 新增：儀表板樣式 */
        .dashboard-card {
            border-left: 4px solid #17a2b8;
        }
        .keeper-stat-row {
            transition: background 0.2s;
            cursor: pointer;
        }
        .keeper-stat-row:hover {
            background-color: #f8f9fa;
        }
        .progress-sm {
            height: 6px;
            margin-top: 5px;
        }

        .duplicate-group-row {
            background-color: #fff7e6;
            font-weight: 600;
        }
        
        /* 視圖切換按鈕 */
        .view-switch-btn {
            margin-bottom: 15px;
        }

        /* 移動端優化 - 避免卡片內捲動 */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container-responsive { padding: 0; }
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('batch_processing_list'); ?>
    <?!= include('selectbyqr'); ?>

    <div id="loader-container" class="text-center">
        <div class="loader"></div>
        <p>正在載入盤點資料...</p>
    </div>

    <div class="container-responsive">
        <div id="main-content" style="display:none;">
            <h4>資產盤點管理</h4>

        <!-- Active Sessions Section -->
        <div class="card section-card" id="active-sessions-card" style="display:none;">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">進行中的盤點會話</h5>
            </div>
            <div class="card-body">
                <div id="active-sessions-list"></div>
            </div>
        </div>

        <!-- Start New Session Section -->
        <div class="card section-card" id="start-session-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">開始新的盤點</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label><b>選擇盤點範圍：</b></label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-all" value="all" checked>
                        <label class="form-check-label" for="filter-all">盤點所有資產（在庫狀態）</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-location" value="location">
                        <label class="form-check-label" for="filter-location">依地點篩選</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-keeper" value="keeper">
                        <label class="form-check-label" for="filter-keeper">依保管人篩選</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-user" value="user">
                        <label class="form-check-label" for="filter-user">依使用人篩選</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-group" value="group">
                        <label class="form-check-label" for="filter-group">依組別篩選</label>
                    </div>
                </div>

                <div class="form-group" id="location-select-group" style="display:none;">
                    <label for="location-select">選擇地點：</label>
                    <select id="location-select" class="form-control"></select>
                </div>

                <div class="form-group" id="keeper-select-group" style="display:none;">
                    <label for="keeper-select">選擇保管人：</label>
                    <select id="keeper-select" class="form-control"></select>
                </div>

                <div class="form-group" id="user-select-group" style="display:none;">
                    <label for="user-select">選擇使用人：</label>
                    <select id="user-select" class="form-control"></select>
                </div>

                <div class="form-group" id="group-select-group" style="display:none;">
                    <label for="group-select">選擇組別：</label>
                    <select id="group-select" class="form-control" multiple size="6"></select>
                    <small class="form-text text-muted">可使用 Ctrl / Command 進行複選</small>
                </div>

                <button class="btn btn-primary" id="start-session-btn" onclick="startNewSession()">
                    <span class="btn-text">開始盤點</span>
                    <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                </button>
            </div>
        </div>

        <!-- Inventory Session Detail -->
        <div class="card section-card" id="session-detail-card" style="display:none;">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">盤點進行中 - <span id="session-id-display"></span></h5>
                <span class="badge badge-light" id="user-role-badge">載入中...</span>
            </div>
            <div class="card-body">
                
                <!-- ✨ 新增：監控儀表板 (預設隱藏，點擊展開) -->
                <div class="card mb-4 dashboard-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center" 
                         style="cursor:pointer;" onclick="$('#dashboard-content').collapse('toggle')">
                        <h6 class="mb-0 text-info"><i class="fa-solid fa-chart-line"></i> 盤點進度監控儀表板</h6>
                        <i class="fa-solid fa-chevron-down text-muted"></i>
                    </div>
                    <div id="dashboard-content" class="collapse">
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <h3 class="display-4" id="dashboard-total-progress">0%</h3>
                                    <small class="text-muted">總體完成率</small>
                                </div>
                                <div class="col-6">
                                    <h3 class="display-4" id="dashboard-my-progress">0%</h3>
                                    <small class="text-muted">我的完成率</small>
                                </div>
                            </div>
                            
                            <h6 class="border-bottom pb-2 mb-3">各組/人盤點進度</h6>
                            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>組別/人員</th>
                                            <th class="text-center">進度</th>
                                            <th class="text-right">完成/應盤</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dashboard-keeper-list">
                                        <!-- JS 動態插入 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 視圖切換 (管理員可見) -->
                <div class="view-switch-btn btn-group btn-group-toggle" data-toggle="buttons" id="view-mode-group" style="display:none;">
                    <label class="btn btn-outline-primary active">
                        <input type="radio" name="viewMode" value="mine" checked> 
                        <i class="fa-solid fa-user"></i> 只看我的任務
                    </label>
                    <label class="btn btn-outline-secondary">
                        <input type="radio" name="viewMode" value="all"> 
                        <i class="fa-solid fa-users"></i> 查看全部資產
                    </label>
                </div>

                <div class="progress-container">
                    <div class="d-flex justify-content-between mb-2">
                        <span>進度：<span id="progress-text">0/0</span></span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 掃描器區域 -->
                <div id="Scanner_zone" class="scanner-zone" style="display:none;"></div>

                <!-- 批次操作按鈕區 -->
                <div id="batch-actions" style="margin-bottom: 15px;">
                    <button class="btn btn-success btn-sm" onclick="openBatchMarkModal()">
                        <i class="fa-solid fa-check-double"></i> 批次盤點確認
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllAssets()">
                        <i class="fa-solid fa-check-square"></i> 全選
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllAssets()">
                        <i class="fa-regular fa-square"></i> 取消全選
                    </button>
                </div>

                <div class="form-group">
                    <label for="search-box">搜尋資產：</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="search-box" placeholder="輸入產編、名稱或地點搜尋，或掃描條碼按 Enter">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="Scanner_toggle()" title="開啟條碼掃描器">
                                <i class="fa-solid fa-barcode"></i> 掃描
                            </button>
                        </div>
                    </div>
                </div>

                <div id="inventory-pagination" class="d-flex justify-content-between align-items-center mb-2"></div>

                <!-- 資產清單容器 -->
                <div id="assets-list-container">
                        <div class="alert alert-info" id="my-task-hint" style="display:none;">
                        <i class="fa-solid fa-clipboard-check"></i> 
                        <strong>您好，<span id="current-user-name"></span>！</strong> 
                        以下是系統自動指派給您的 <span id="my-task-count">0</span> 筆盤點任務。
                    </div>
                    <div class="alert alert-warning py-2" id="duplicate-warning" style="display:none;"></div>
                    <div id="assets-list" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                        <div class="text-center text-muted py-5" id="empty-state-hint">
                            <i class="fa-solid fa-clipboard-list fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p class="mb-0">請點選進行中的盤點或新增盤點任務</p>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success" onclick="completeSession()">
                        <span class="btn-text">完成盤點</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="refreshSessionDetails()">重新整理</button>
                    <button class="btn btn-outline-secondary ml-2" onclick="backToStart()">返回</button>
                </div>
            </div>
        </div>

        <!-- Inventory History -->
        <div class="card section-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">盤點歷史記錄</h5>
            </div>
            <div class="card-body">
                <div id="history-list">
                    <p class="text-muted">尚無歷史記錄</p>
                </div>
            </div>
        </div>
        </div> <!-- 關閉 main-content -->
    </div> <!-- 關閉 container-responsive -->

    <!-- Modal for marking asset -->
    <div class="modal fade" id="markAssetModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">標記資產盤點結果</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><b>財產編號：</b><span id="modal-asset-id"></span></p>
                    <p><b>財產名稱：</b><span id="modal-asset-name"></span></p>
                    <p><b>保管人：</b><span id="modal-keeper-name"></span></p>
                    <p><b>地點：</b><span id="modal-location"></span></p>

                    <div class="form-group">
                        <label><b>盤點結果：</b></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-normal" value="正常" checked>
                            <label class="form-check-label" for="result-normal">正常</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-missing" value="遺失">
                            <label class="form-check-label" for="result-missing">遺失</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-damaged" value="損壞">
                            <label class="form-check-label" for="result-damaged">損壞</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inventory-remarks">備註：</label>
                        <textarea class="form-control" id="inventory-remarks" rows="3" placeholder="選填"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryResult()">
                        <span class="btn-text">儲存</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批次標記彈窗 -->
    <div class="modal fade" id="batchMarkModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批次標記盤點結果</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p>已選擇 <strong id="batch-selected-count">0</strong> 項資產</p>
                    </div>
                    <div class="form-group">
                        <label for="batchResult"><b>盤點結果：</b></label>
                        <select class="form-control" id="batchResult">
                            <option value="正常">正常</option>
                            <option value="遺失">遺失</option>
                            <option value="損壞">損壞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="batchRemarks">備註（選填）：</label>
                        <textarea class="form-control" id="batchRemarks" rows="3" placeholder="此備註將套用到所有選中的資產"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="batch-submit-btn" onclick="submitBatchMark()">
                        <span class="btn-text">確認標記</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentModeModal" tabindex="-1" role="dialog" aria-labelledby="assignmentModeTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentModeTitle">選擇分派方式</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">請選擇本次盤點的分派方式：</p>
                    <div class="custom-control custom-radio mb-2">
                        <input type="radio" id="assignment-mode-group" name="assignmentMode" class="custom-control-input" value="group" checked>
                        <label class="custom-control-label" for="assignment-mode-group">依照組別分派</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="assignment-mode-person" name="assignmentMode" class="custom-control-input" value="person">
                        <label class="custom-control-label" for="assignment-mode-person">依照人名分派</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAssignmentMode()">開始盤點</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignmentAssetsModal" tabindex="-1" role="dialog" aria-labelledby="assignmentAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignmentAssetsTitle">分派清單</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="assignment-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>財產編號</th>
                                    <th>財產名稱</th>
                                    <th>型號/廠牌</th>
                                    <th>使用人</th>
                                    <th>保管人</th>
                                    <th>地點</th>
                                    <th>盤點結果</th>
                                </tr>
                            </thead>
                            <tbody id="assignment-assets-body"></tbody>
                        </table>
                    </div>
                    <div id="assignment-assets-pagination" class="d-flex justify-content-between align-items-center mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="duplicateAssetsModal" tabindex="-1" role="dialog" aria-labelledby="duplicateAssetsTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateAssetsTitle">重複產編清單</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="duplicate-assets-meta" class="text-muted mb-2"></div>
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="thead-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>財產編號</th>
                                    <th>財產名稱</th>
                                    <th>使用人</th>
                                    <th>保管人</th>
                                    <th>地點</th>
                                </tr>
                            </thead>
                            <tbody id="duplicate-assets-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let inventoryData = null;
        let currentSessionId = null;
        let currentSessionDetails = [];
        let selectedAssets = new Set(); // 儲存選中的資產 ID
        let isAdmin = false; // 儲存當前使用者是否為管理員
        let currentUserEmail = ''; // 新增：儲存當前使用者 Email
        let emailToNameMap = {}; // 指派人員 Email -> 姓名
        let currentUserGroup = ''; // 指派人員所屬組別
        let currentViewMode = 'mine'; // 預設視圖：我的任務
        let pendingStartOptions = null; // 管理員分派方式暫存
        let filteredSessionAssets = [];
        let currentPage = 1;
        const rowsPerPage = 500;
        let searchDebounceTimer = null;
        let dashboardStatsMap = {};
        const assignmentRowsPerPage = 500;
        let assignmentModalState = { key: '', title: '', assets: [], page: 1 };
        let duplicateAssetGroups = [];

        document.addEventListener("DOMContentLoaded", function() {
            loadInventoryData();

            // Filter type change handlers
            document.querySelectorAll('input[name="filterType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('location-select-group').style.display =
                        this.value === 'location' ? 'block' : 'none';
                    document.getElementById('keeper-select-group').style.display =
                        this.value === 'keeper' ? 'block' : 'none';
                    document.getElementById('user-select-group').style.display =
                        this.value === 'user' ? 'block' : 'none';
                    document.getElementById('group-select-group').style.display =
                        this.value === 'group' ? 'block' : 'none';
                });
            });

            // Asset search handler - modified to use renderAssetsList
            document.getElementById('search-box').addEventListener('input', function() {
                scheduleSearchRender();
            });

            // 監聽視圖切換
            $("input[name='viewMode']").change(function() {
                currentViewMode = $(this).val();
                renderAssetsList(true);
            });

            $('#dashboard-keeper-list').on('click', '.keeper-stat-row', function() {
                const assignmentKey = $(this).data('assignKey');
                if (!assignmentKey) return;
                const stat = dashboardStatsMap[assignmentKey] || { name: assignmentKey };
                openAssignmentAssets(assignmentKey, stat.name);
            });
        });

        function loadInventoryData() {
            document.getElementById('loader-container').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';

            google.script.run
                .withSuccessHandler(function(data) {
                    inventoryData = data;
                    isAdmin = data.isAdmin || false; // 儲存管理員狀態
                    currentUserEmail = data.currentUserEmail; // 從後端獲取
                    emailToNameMap = data.emailToNameMap || {};
                    currentUserGroup = data.currentUserGroup || '';
                    
                    // 設定使用者名稱顯示
                    const userNameElements = document.querySelectorAll('#current-user-name');
                    userNameElements.forEach(el => el.textContent = currentUserEmail ? currentUserEmail.split('@')[0] : '使用者');

                    populateFilters(data);
                    displayActiveSessions(data.activeSessions);
                    loadHistory();
                    document.getElementById('start-session-card').style.display = isAdmin ? 'block' : 'none';

                    document.getElementById('loader-container').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                })
                .withFailureHandler(function(error) {
                    alert('載入資料失敗：' + error.message);
                    document.getElementById('loader-container').style.display = 'none';
                })
                .getInventoryData();
        }

        function populateFilters(data) {
            // Populate location select
            const locationSelect = document.getElementById('location-select');
            locationSelect.innerHTML = '<option value="">請選擇地點</option>';
            data.locations.forEach(loc => {
                locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
            });

            // Populate keeper select
            const keeperSelect = document.getElementById('keeper-select');
            keeperSelect.innerHTML = '<option value="">請選擇保管人</option>';
            data.keepers.forEach(keeper => {
                keeperSelect.innerHTML += `<option value="${keeper}">${keeper}</option>`;
            });

            // Populate user select
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">請選擇使用人</option>';
            data.users.forEach(user => {
                userSelect.innerHTML += `<option value="${user}">${user}</option>`;
            });

            // Populate group select (multi-select)
            const groupSelect = document.getElementById('group-select');
            groupSelect.innerHTML = '';
            (data.groups || []).forEach(group => {
                groupSelect.innerHTML += `<option value="${group}">${group}</option>`;
            });
        }

        function displayActiveSessions(sessions) {
            const card = document.getElementById('active-sessions-card');
            const list = document.getElementById('active-sessions-list');
            const startCard = document.getElementById('start-session-card');

            if (sessions.length === 0) {
                card.style.display = 'none';
                if (startCard) {
                    startCard.style.display = isAdmin ? 'block' : 'none';
                }
                return;
            }

            card.style.display = 'block';
            if (startCard) {
                startCard.style.display = 'none';
            }
            list.innerHTML = '';

            sessions.forEach(session => {
                const percentage = session.totalCount > 0
                    ? Math.round((session.verifiedCount / session.totalCount) * 100)
                    : 0;
                const isActive = currentSessionId && session.inventoryId === currentSessionId;

                // 管理員模式：顯示會話擁有者資訊
                const ownerInfo = isAdmin && session.inventoryEmail
                    ? `<br><small class="text-info"><i class="fa-solid fa-user"></i> 盤點人：${session.inventoryPerson} (${session.inventoryEmail})</small>`
                    : '';

                list.innerHTML += `
                    <div class="session-item${isActive ? ' active' : ''}" data-inventory-id="${session.inventoryId}" onclick="loadSessionDetails('${session.inventoryId}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <b>${session.inventoryId}</b><br>
                                <small class="text-muted">範圍: ${session.filter}</small>
                                ${ownerInfo}
                            </div>
                            <div class="text-right">
                                <div>${session.verifiedCount} / ${session.totalCount}</div>
                                <small class="text-muted">${percentage}%</small>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        function highlightActiveSession(inventoryId) {
            const items = document.querySelectorAll('#active-sessions-list .session-item');
            items.forEach(item => {
                const isActive = item.dataset.inventoryId === inventoryId;
                item.classList.toggle('active', isActive);
            });
        }

        function normalizeAssignment(value) {
            return value ? String(value).trim() : '';
        }

        function isEmailAssignment(value) {
            return value.includes('@');
        }

        function getAssignmentKey(value) {
            const normalized = normalizeAssignment(value);
            if (!normalized) return '';
            return isEmailAssignment(normalized) ? normalized.toLowerCase() : normalized;
        }

        function isAssignmentMine(value) {
            const normalized = normalizeAssignment(value);
            if (!normalized) return false;
            if (isEmailAssignment(normalized)) return normalized.toLowerCase() === currentUserEmail;
            return currentUserGroup && normalized === currentUserGroup;
        }

        function scheduleSearchRender() {
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            searchDebounceTimer = setTimeout(() => {
                renderAssetsList(true);
            }, 180);
        }

        function startNewSession() {
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            let filterValue = '';

            if (filterType === 'location') {
                filterValue = document.getElementById('location-select').value;
                if (!filterValue) {
                    alert('請選擇地點');
                    return;
                }
            } else if (filterType === 'keeper') {
                filterValue = document.getElementById('keeper-select').value;
                if (!filterValue) {
                    alert('請選擇保管人');
                    return;
                }
            } else if (filterType === 'user') {
                filterValue = document.getElementById('user-select').value;
                if (!filterValue) {
                    alert('請選擇使用人');
                    return;
                }
            } else if (filterType === 'group') {
                const groupSelect = document.getElementById('group-select');
                const selectedGroups = Array.from(groupSelect.selectedOptions)
                    .map(option => option.value)
                    .filter(Boolean);
                if (selectedGroups.length === 0) {
                    alert('請選擇組別');
                    return;
                }
                filterValue = selectedGroups;
            }

            const options = {
                filterType: filterType,
                filterValue: filterValue,
                assetIds: []
            };

            if (isAdmin) {
                pendingStartOptions = options;
                $('#assignmentModeModal').modal('show');
                return;
            }

            options.assignmentMode = 'person';
            submitStartSession(options);
        }

        function confirmAssignmentMode() {
            if (!pendingStartOptions) {
                $('#assignmentModeModal').modal('hide');
                return;
            }
            const selectedMode = document.querySelector('input[name="assignmentMode"]:checked');
            pendingStartOptions.assignmentMode = selectedMode ? selectedMode.value : 'person';
            const options = pendingStartOptions;
            pendingStartOptions = null;
            $('#assignmentModeModal').modal('hide');
            submitStartSession(options);
        }

        function submitStartSession(options) {
            const btn = document.getElementById('start-session-btn');
            btn.disabled = true;
            btn.querySelector('.btn-text').style.display = 'none';
            btn.querySelector('.spinner-border').style.display = 'inline-block';

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';

                    if (result.success) {
                        alert(result.message);
                        loadSessionDetails(result.inventoryId);
                        loadInventoryData(); // Refresh
                    } else {
                        alert('開始盤點失敗：' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';
                    alert('開始盤點失敗：' + error.message);
                })
                .startInventorySession(options);
        }

        function loadSessionDetails(inventoryId) {
            currentSessionId = inventoryId;
            highlightActiveSession(inventoryId);
            document.getElementById('session-id-display').textContent = inventoryId;
            document.getElementById('start-session-card').style.display = 'none';
            document.getElementById('session-detail-card').style.display = 'block';

            // 切換會話時先清空本地選取與批次清單，避免跨會話殘留
            selectedAssets.clear();
            if (typeof BatchList_resetForSessionChange === 'function') {
                BatchList_resetForSessionChange();
            }
            updateBatchUI();

            // 重置視圖模式
            currentViewMode = 'mine';
            $("input[name='viewMode'][value='mine']").prop('checked', true).parent().addClass('active');
            $("input[name='viewMode'][value='all']").parent().removeClass('active');

            // ✨ 切換會話時先清空資產列表，顯示載入中
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">載入中...</span>
                    </div>
                    <p class="text-muted mt-3">正在載入盤點資料...</p>
                </div>
            `;
            document.getElementById('inventory-pagination').innerHTML = '';

            google.script.run
                .withSuccessHandler(function(details) {
                    currentSessionDetails = details.map(asset => {
                        const searchText = [
                            asset.assetId,
                            asset.assetName,
                            asset.location,
                            asset.keeperName,
                            asset.userName
                        ].filter(Boolean).join(' ').toLowerCase();
                        asset.searchText = searchText;
                        return asset;
                    });
                    currentPage = 1;

                    // 初始化全域資產列表與 BatchList 索引 (基於完整會話資料)
                    window.allAssets = currentSessionDetails.map(asset => ({
                        id: asset.assetId,
                        assetName: asset.assetName,
                        keeperName: asset.keeperName,
                        location: asset.location,
                        status: asset.inventoryResult,
                        assignedUser: asset.assignedUser
                    }));

                    if (typeof BatchList_rebuildIndex === 'function') {
                        BatchList_rebuildIndex();
                    }

                    // 1. 渲染儀表板
                    renderDashboard(details);

                    // 2. 決定是否顯示視圖切換按鈕 (管理員或發起人可切換)
                    // 這裡簡單判斷：如果是管理員，顯示切換按鈕
                    if (isAdmin) {
                        $('#view-mode-group').show();
                        $('#user-role-badge').text('管理員視角').addClass('badge-danger').removeClass('badge-success');
                    } else {
                        $('#view-mode-group').hide();
                        $('#user-role-badge').text('保管人視角').addClass('badge-success').removeClass('badge-danger');
                    }

                    // 3. 渲染列表 (根據當前視圖模式)
                    renderAssetsList();
                })
                .withFailureHandler(function(error) {
                    // ✨ 新增錯誤處理與重試按鈕
                    assetsList.innerHTML = `
                        <div class="text-center text-danger py-5">
                            <i class="fa-solid fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>載入失敗：${error.message}</p>
                            <button class="btn btn-sm btn-primary" onclick="loadSessionDetails('${inventoryId}')">
                                <i class="fa-solid fa-rotate"></i> 重試
                            </button>
                        </div>
                    `;
                })
                .getInventoryDetails(inventoryId);
        }

        // ✨ 新增：渲染儀表板
        function renderDashboard(details) {
            const total = details.length;
            const verified = details.filter(d => d.inventoryResult !== '未盤點').length;
            const totalPercent = total > 0 ? Math.round((verified / total) * 100) : 0;

            // 計算我的進度
            const myTasks = details.filter(d => isAssignmentMine(d.assignedUser));
            const myVerified = myTasks.filter(d => d.inventoryResult !== '未盤點').length;
            const myPercent = myTasks.length > 0 ? Math.round((myVerified / myTasks.length) * 100) : 0;

            $('#dashboard-total-progress').text(totalPercent + '%');
            $('#dashboard-my-progress').text(myPercent + '%');
            
            // 調用後端獲取分組統計 (或是前端自己算也可以，這裡前端算比較快)
            const statsMap = {};
            details.forEach(item => {
                const assignmentKey = getAssignmentKey(item.assignedUser) || '未指派';
                const rawAssignment = normalizeAssignment(item.assignedUser);
                const isEmail = rawAssignment ? isEmailAssignment(rawAssignment) : false;
                const displayName = assignmentKey === '未指派'
                    ? '未指派'
                    : (isEmail
                        ? (emailToNameMap[assignmentKey] || rawAssignment.split('@')[0] || assignmentKey)
                        : assignmentKey);
                
                if (!statsMap[assignmentKey]) {
                    statsMap[assignmentKey] = { name: displayName, total: 0, verified: 0, isEmail: isEmail };
                }
                statsMap[assignmentKey].total++;
                if (item.inventoryResult !== '未盤點') statsMap[assignmentKey].verified++;
            });

            dashboardStatsMap = statsMap;

            const tbody = $('#dashboard-keeper-list');
            tbody.empty();

            Object.entries(statsMap)
                .sort((a, b) => {
                    const pa = a[1].total > 0 ? a[1].verified / a[1].total : 0;
                    const pb = b[1].total > 0 ? b[1].verified / b[1].total : 0;
                    return pa - pb; // 完成率低的在前
                })
                .forEach(([email, stat]) => {
                    const percent = stat.total > 0 ? Math.round((stat.verified / stat.total) * 100) : 0;
                    let colorClass = 'bg-danger';
                    if (percent >= 50) colorClass = 'bg-warning';
                    if (percent >= 100) colorClass = 'bg-success';

                    const isMe = stat.isEmail
                        ? (email === currentUserEmail ? ' <span class="badge badge-info">我</span>' : '')
                        : (email === currentUserGroup ? ' <span class="badge badge-info">我</span>' : '');
                    const displayName = email === '未指派' ? '<span class="text-danger">⚠️ 未指派</span>' : stat.name;

                    const safeKey = String(email).replace(/"/g, '&quot;');
                    tbody.append(
                        `<tr class="keeper-stat-row" data-assign-key="${safeKey}">
                            <td>${displayName} ${isMe}</td>
                            <td class="align-middle">
                                <div class="progress progress-sm">
                                    <div class="progress-bar ${colorClass}" style="width: ${percent}%"></div>
                                </div>
                                <small class="text-muted">${percent}%</small>
                            </td>
                            <td class="text-right"><small>${stat.verified} / ${stat.total}</small></td>
                        </tr>`
                    );
                });
        }

        function openAssignmentAssets(assignmentKey, displayName) {
            const normalizedKey = assignmentKey || '未指派';
            const assets = currentSessionDetails.filter(asset => (getAssignmentKey(asset.assignedUser) || '未指派') === normalizedKey);
            assignmentModalState = {
                key: normalizedKey,
                title: displayName || normalizedKey,
                assets: assets,
                page: 1
            };
            renderAssignmentModal();
            $('#assignmentAssetsModal').modal('show');
        }

        function renderAssignmentModal() {
            const titleEl = document.getElementById('assignmentAssetsTitle');
            const metaEl = document.getElementById('assignment-assets-meta');
            const bodyEl = document.getElementById('assignment-assets-body');
            const paginationEl = document.getElementById('assignment-assets-pagination');

            const total = assignmentModalState.assets.length;
            const pageCount = Math.max(1, Math.ceil(total / assignmentRowsPerPage));
            if (assignmentModalState.page > pageCount) {
                assignmentModalState.page = pageCount;
            }

            const titleLabel = assignmentModalState.key === '未指派'
                ? '未指派'
                : (assignmentModalState.key.includes('@')
                    ? `${assignmentModalState.title} (${assignmentModalState.key})`
                    : assignmentModalState.title);
            titleEl.textContent = `分派清單 - ${titleLabel}`;
            metaEl.textContent = `共 ${total} 筆資產`;

            bodyEl.innerHTML = '';
            if (total === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.textContent = '沒有符合條件的資產';
                row.appendChild(cell);
                bodyEl.appendChild(row);
            } else {
                const start = (assignmentModalState.page - 1) * assignmentRowsPerPage;
                const end = start + assignmentRowsPerPage;
                const pageAssets = assignmentModalState.assets.slice(start, end);
                const fragment = document.createDocumentFragment();

                pageAssets.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.modelBrand,
                        asset.userName,
                        asset.keeperName,
                        asset.location,
                        asset.inventoryResult
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });

                bodyEl.appendChild(fragment);
            }

            paginationEl.innerHTML = '';
            if (pageCount <= 1) return;

            const info = document.createElement('div');
            info.className = 'text-muted';
            info.textContent = `第 ${assignmentModalState.page} / ${pageCount} 頁`;
            paginationEl.appendChild(info);

            const nav = document.createElement('div');
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-sm btn-outline-secondary mr-2';
            prevBtn.textContent = '上一頁';
            prevBtn.disabled = assignmentModalState.page <= 1;
            prevBtn.addEventListener('click', () => {
                if (assignmentModalState.page > 1) {
                    assignmentModalState.page -= 1;
                    renderAssignmentModal();
                }
            });

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-sm btn-outline-secondary';
            nextBtn.textContent = '下一頁';
            nextBtn.disabled = assignmentModalState.page >= pageCount;
            nextBtn.addEventListener('click', () => {
                if (assignmentModalState.page < pageCount) {
                    assignmentModalState.page += 1;
                    renderAssignmentModal();
                }
            });

            nav.appendChild(prevBtn);
            nav.appendChild(nextBtn);
            paginationEl.appendChild(nav);
        }

        function openDuplicateAssetsModal() {
            if (!duplicateAssetGroups || duplicateAssetGroups.length === 0) return;
            renderDuplicateAssetsModal();
            $('#duplicateAssetsModal').modal('show');
        }

        function renderDuplicateAssetsModal() {
            const metaEl = document.getElementById('duplicate-assets-meta');
            const bodyEl = document.getElementById('duplicate-assets-body');

            const groups = duplicateAssetGroups.slice().sort((a, b) => {
                if (!a.assetId && !b.assetId) return 0;
                if (!a.assetId) return 1;
                if (!b.assetId) return -1;
                return String(a.assetId).localeCompare(String(b.assetId), 'zh-Hant');
            });

            const totalGroups = groups.length;
            const totalRows = groups.reduce((sum, group) => sum + group.items.length, 0);
            metaEl.textContent = `共 ${totalGroups} 組，${totalRows} 筆資產`;

            bodyEl.innerHTML = '';
            const fragment = document.createDocumentFragment();

            groups.forEach(group => {
                const groupRow = document.createElement('tr');
                groupRow.className = 'duplicate-group-row';
                const groupCell = document.createElement('td');
                groupCell.colSpan = 5;
                groupCell.textContent = `產編：${group.assetId || '(空白)'}（${group.items.length} 筆）`;
                groupRow.appendChild(groupCell);
                fragment.appendChild(groupRow);

                group.items.forEach(asset => {
                    const row = document.createElement('tr');
                    const cells = [
                        asset.assetId,
                        asset.assetName,
                        asset.userName,
                        asset.keeperName,
                        asset.location
                    ];
                    cells.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value || '';
                        row.appendChild(td);
                    });
                    fragment.appendChild(row);
                });
            });

            bodyEl.appendChild(fragment);
        }

        // ✨ 修改：渲染資產列表 (支援過濾與分頁)
        function renderAssetsList(resetPage = false) {
            if (!currentSessionDetails) return; 
            
            let filteredAssets = currentSessionDetails;

            // 視圖過濾邏輯
            if (currentViewMode === 'mine') {
                filteredAssets = currentSessionDetails.filter(asset => 
                    isAssignmentMine(asset.assignedUser)
                );
                $('#my-task-hint').show();
            } else {
                $('#my-task-hint').hide();
            }

            // 搜尋過濾邏輯 (疊加)
            const searchTerm = $('#search-box').val().trim().toLowerCase();
            if (searchTerm) {
                filteredAssets = filteredAssets.filter(asset =>
                    asset.searchText && asset.searchText.includes(searchTerm)
                );
            }

            const dedupeResult = dedupeAssets(filteredAssets);
            filteredSessionAssets = dedupeResult.uniqueAssets;
            if (resetPage) {
                currentPage = 1;
            }

            const pageCount = Math.max(1, Math.ceil(filteredSessionAssets.length / rowsPerPage));
            if (currentPage > pageCount) {
                currentPage = pageCount;
            }

            // 更新進度條 (顯示當前視圖的進度)
            const total = dedupeResult.uniqueCount;
            const verified = dedupeResult.verifiedUniqueCount;
            const percentage = total > 0 ? Math.round((verified / total) * 100) : 0;
            
            $('#progress-text').text(`${verified}/${total}`);
            $('#progress-percentage').text(`${percentage}%`);
            $('#progress-bar').css('width', `${percentage}%`);

            if (currentViewMode === 'mine') {
                $('#my-task-count').text(total);
            }

            const warningEl = document.getElementById('duplicate-warning');
            if (warningEl) {
                duplicateAssetGroups = dedupeResult.duplicateGroups || [];
                if (dedupeResult.duplicateCount > 0) {
                    warningEl.innerHTML = `偵測到 ${dedupeResult.duplicateCount} 筆重複產編，已合併顯示並以去重數量計算。<span class="text-primary ml-2">點擊查看詳情</span>`;
                    warningEl.style.display = 'block';
                    warningEl.style.cursor = 'pointer';
                    warningEl.onclick = openDuplicateAssetsModal;
                } else {
                    warningEl.textContent = '';
                    warningEl.style.display = 'none';
                    warningEl.style.cursor = '';
                    warningEl.onclick = null;
                }
            }

            renderPage(currentPage);
            renderPagination(pageCount);
        }

        function dedupeAssets(assets) {
            const map = new Map();
            const duplicates = new Map();
            let duplicateCount = 0;

            assets.forEach(asset => {
                const key = String(asset.assetId || '').trim();
                if (map.has(key)) {
                    duplicateCount += 1;
                    const existing = map.get(key);
                    if (!duplicates.has(key)) {
                        duplicates.set(key, [existing]);
                    }
                    duplicates.get(key).push(asset);

                    const existingVerified = existing.inventoryResult && existing.inventoryResult !== '未盤點';
                    const currentVerified = asset.inventoryResult && asset.inventoryResult !== '未盤點';
                    if (!existingVerified && currentVerified) {
                        map.set(key, asset);
                    }
                } else {
                    map.set(key, asset);
                }
            });

            let verifiedUniqueCount = 0;
            map.forEach(asset => {
                if (asset.inventoryResult && asset.inventoryResult !== '未盤點') {
                    verifiedUniqueCount += 1;
                }
            });

            const duplicateGroups = Array.from(duplicates.entries()).map(([assetId, items]) => ({
                assetId: assetId,
                items: items
            }));

            return {
                uniqueAssets: Array.from(map.values()),
                duplicateCount: duplicateCount,
                verifiedUniqueCount: verifiedUniqueCount,
                uniqueCount: map.size,
                duplicateGroups: duplicateGroups
            };
        }

        // ========== 分頁相容函數 ========== 
        function renderTableForPage() {
            if (currentSessionDetails && currentSessionDetails.length > 0) {
                renderAssetsList();
            }
        }

        function renderPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedAssets = filteredSessionAssets.slice(start, end);
            displaySessionDetails(paginatedAssets);
        }

        function renderPagination(pageCount) {
            const paginationContainer = document.getElementById('inventory-pagination');
            paginationContainer.innerHTML = '';

            if (pageCount <= 1) return;

            const info = document.createElement('div');
            info.className = 'text-muted';
            info.textContent = `第 ${currentPage} / ${pageCount} 頁 (共 ${filteredSessionAssets.length} 筆)`;
            paginationContainer.appendChild(info);

            const nav = document.createElement('div');
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-sm btn-outline-secondary mr-2';
            prevBtn.textContent = '上一頁';
            prevBtn.disabled = currentPage <= 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    renderAssetsList();
                }
            });

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-sm btn-outline-secondary';
            nextBtn.textContent = '下一頁';
            nextBtn.disabled = currentPage >= pageCount;
            nextBtn.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage += 1;
                    renderAssetsList();
                }
            });

            nav.appendChild(prevBtn);
            nav.appendChild(nextBtn);
            paginationContainer.appendChild(nav);
        }

        function displaySessionDetails(details) {
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = '';

            if (details.length === 0) {
                assetsList.innerHTML = '<p class="text-muted text-center py-3">沒有資產需要盤點 (或符合搜尋條件)</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            details.forEach(asset => {
                const resultClass = asset.inventoryResult === '正常' ? 'result-normal' :
                                  asset.inventoryResult === '遺失' ? 'result-missing' :
                                  asset.inventoryResult === '損壞' ? 'result-damaged' :
                                  'result-unverified';

                const item = document.createElement('div');
                item.className = 'asset-item';

                const header = document.createElement('div');
                header.className = 'asset-item-header';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'asset-checkbox';
                checkbox.value = asset.assetId;  // ✨ 加上 value 屬性，與 batch_processing_list.html 一致
                checkbox.dataset.assetId = asset.assetId;
                checkbox.addEventListener('change', () => toggleAssetSelection(asset.assetId));
                header.appendChild(checkbox);

                const nameDiv = document.createElement('div');
                nameDiv.className = 'asset-item-name';
                nameDiv.textContent = `${asset.assetId} - ${asset.assetName || ''}`;
                header.appendChild(nameDiv);

                const actionBtn = document.createElement('button');
                actionBtn.className = 'btn btn-sm btn-outline-primary ml-auto';
                actionBtn.title = '標記此資產';
                actionBtn.addEventListener('click', () => openMarkModal(asset.assetId));
                actionBtn.innerHTML = '<i class="fa-solid fa-edit"></i>單筆確認';
                header.appendChild(actionBtn);

                const body = document.createElement('div');
                body.className = 'asset-item-body';

                const bodyRow = document.createElement('div');
                bodyRow.className = 'd-flex justify-content-between align-items-center';

                const metaWrap = document.createElement('div');
                const metaText = document.createElement('small');
                metaText.className = 'text-muted';
                metaText.textContent = `型號: ${asset.modelBrand || '-'} | 使用人: ${asset.userName || '-'} | 保管人: ${asset.keeperName || '-'} | 地點: ${asset.location || '-'}`;
                metaWrap.appendChild(metaText);

                if (asset.remarks) {
                    const remark = document.createElement('small');
                    remark.className = 'text-info d-block';
                    remark.textContent = `備註: ${asset.remarks}`;
                    metaWrap.appendChild(remark);
                }

                const badge = document.createElement('span');
                badge.className = `badge-result ${resultClass}`;
                badge.textContent = asset.inventoryResult;

                bodyRow.appendChild(metaWrap);
                bodyRow.appendChild(badge);
                body.appendChild(bodyRow);

                item.appendChild(header);
                item.appendChild(body);
                fragment.appendChild(item);
            });

            assetsList.appendChild(fragment);

            // 同步 checkbox 狀態（從 selectedAssets 和 BatchList 雙向同步）
            setTimeout(() => {
                // 從 selectedAssets 同步
                selectedAssets.forEach(assetId => {
                    const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // 從 BatchList 同步（Scanner Enter 鍵掃描會直接加入 BatchList）
                if (typeof BatchList_getItems === 'function') {
                    const batchItems = BatchList_getItems();
                    batchItems.forEach(assetId => {
                        const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);
                        if (checkbox && !checkbox.checked) {
                            checkbox.checked = true;
                            selectedAssets.add(assetId);
                        }
                    });
                }

                updateBatchUI();
            }, 100);
        }

        function filterAssetsList(searchTerm) {
            // 已被 renderAssetsList 取代，此為相容性保留
            renderAssetsList();
        }

        function openMarkModal(assetId) {
            const asset = currentSessionDetails.find(a => a.assetId === assetId);
            if (!asset) return;

            document.getElementById('modal-asset-id').textContent = asset.assetId;
            document.getElementById('modal-asset-name').textContent = asset.assetName;
            document.getElementById('modal-keeper-name').textContent = asset.keeperName;
            document.getElementById('modal-location').textContent = asset.location;
            document.getElementById('inventory-remarks').value = asset.remarks || '';

            // Set current result
            if (asset.inventoryResult === '正常') {
                document.getElementById('result-normal').checked = true;
            } else if (asset.inventoryResult === '遺失') {
                document.getElementById('result-missing').checked = true;
            } else if (asset.inventoryResult === '損壞') {
                document.getElementById('result-damaged').checked = true;
            } else {
                document.getElementById('result-normal').checked = true;
            }

            $('#markAssetModal').modal('show');
        }

        function saveInventoryResult() {
            const assetId = document.getElementById('modal-asset-id').textContent;
            const result = document.querySelector('input[name="inventoryResult"]:checked').value;
            const remarks = document.getElementById('inventory-remarks').value;

            const btn = $("#markAssetModal").find('.btn-primary');
            btn.prop('disabled', true);
            btn.find('.btn-text').hide();
            btn.find('.spinner-border').show();

            google.script.run
                .withSuccessHandler(function(response) {
                    btn.prop('disabled', false);
                    btn.find('.btn-text').show();
                    btn.find('.spinner-border').hide();

                    if (response.success) {
                        $('#markAssetModal').modal('hide');
                        refreshSessionDetails();
                    } else {
                        alert('儲存失敗：' + response.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.prop('disabled', false);
                    btn.find('.btn-text').show();
                    btn.find('.spinner-border').hide();
                    alert('儲存失敗：' + error.message);
                })
                .markAssetInventory(currentSessionId, assetId, result, remarks);
        }

        function refreshSessionDetails() {
            if (currentSessionId) {
                loadSessionDetails(currentSessionId);
            }
        }

        function completeSession() {
            if (!currentSessionId) return;

            if (!confirm('確定要完成此盤點會話嗎？完成後將無法再修改盤點結果。')) {
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.querySelector('.btn-text').style.display = 'none';
            btn.querySelector('.spinner-border').style.display = 'inline-block';

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';

                    if (result.success) {
                        const stats = result.stats;
                        let message = `盤點已完成！\n\n`;
                        message += `總計: ${stats.total} 筆\n`;
                        message += `正常: ${stats.normal} 筆\n`;
                        message += `遺失: ${stats.missing} 筆\n`;
                        message += `損壞: ${stats.damaged} 筆\n`;

                        alert(message);
                        backToStart();
                        loadInventoryData();
                    } else {
                        alert(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';
                    alert('完成盤點失敗：' + error.message);
                })
                .completeInventorySession(currentSessionId);
        }

        function backToStart() {
            currentSessionId = null;
            currentSessionDetails = [];
            selectedAssets.clear();
            filteredSessionAssets = [];
            currentPage = 1;
            document.getElementById('session-detail-card').style.display = 'none';
            document.getElementById('start-session-card').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('search-box').value = '';
            document.getElementById('inventory-pagination').innerHTML = '';
            
            // 重置儀表板
            $('#dashboard-keeper-list').empty();
            $('#dashboard-total-progress').text('0%');
            $('#dashboard-my-progress').text('0%');

            // ✨ 清空 window.allAssets，避免資料殘留
            window.allAssets = [];

            // ✨ 清空 BatchList 索引
            if (typeof BatchList_rebuildIndex === 'function') {
                BatchList_rebuildIndex();
            }

            // ✨ 恢復空狀態提示
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = `
                <div class="text-center text-muted py-5" id="empty-state-hint">
                    <i class="fa-solid fa-clipboard-list fa-3x mb-3" style="opacity: 0.3;"></i>
                    <p class="mb-0">請點選進行中的盤點或新增盤點任務</p>
                </div>
            `;
        }

        // ========== 批次處理函數 ========== 

        function toggleAssetSelection(assetId) {
            const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);

            if (checkbox && checkbox.checked) {
                selectedAssets.add(assetId);
                // 同步到 BatchList 模組
                if (typeof BatchList_addItem === 'function') {
                    BatchList_addItem(assetId);
                }
            } else {
                selectedAssets.delete(assetId);
                // 同步到 BatchList 模組
                if (typeof BatchList_removeItem === 'function') {
                    BatchList_removeItem(assetId);
                }
            }

            updateBatchUI();
        }

        function updateBatchUI() {
            const count = selectedAssets.size;

            // 更新計數
            const countEl = document.getElementById('batch-selected-count');
            if (countEl) {
                countEl.textContent = count;
            }
        }

        function selectAllAssets() {
            const targetAssets = filteredSessionAssets.length ? filteredSessionAssets : currentSessionDetails;
            const assetIds = targetAssets.map(asset => asset.assetId);

            // ✨ 取得上限值（預設 500）
            const MAX_BATCH_SIZE = typeof BatchList_getMaxSize === 'function'
                ? BatchList_getMaxSize() : 500;

            // ✨ 預檢查：超過上限時警告
            if (assetIds.length > MAX_BATCH_SIZE) {
                const proceed = window.confirm(
                    `您即將選取 ${selectableIds.length} 筆資產，超過建議上限 ${MAX_BATCH_SIZE} 筆。\n` +
                            `大量選取可能造成頁面反應緩慢。\n\n` +
                            `點擊「取消」將不會選擇任何資產\n` +
                            `點擊「確認」將自動選擇前${MAX_BATCH_SIZE} 筆資產\n`
                );
                if (!proceed) return;
            }

            // ✨ 使用批量 API（避免逐筆觸發 Toast）
            if (typeof BatchList_addItems === 'function') {
                BatchList_addItems(assetIds);
            }

            // 同步到本地 selectedAssets（以實際加入的為準）
            selectedAssets.clear();
            if (typeof BatchList_getItems === 'function') {
                BatchList_getItems().forEach(id => selectedAssets.add(id));
            } else {
                // 降級：直接使用前 MAX_BATCH_SIZE 筆
                assetIds.slice(0, MAX_BATCH_SIZE).forEach(id => selectedAssets.add(id));
            }

            // 更新 checkboxes（只勾選實際加入的）
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectedAssets.has(cb.value);
            });

            updateBatchUI();
        }

        function deselectAllAssets() {
            const assetIds = Array.from(selectedAssets);
            selectedAssets.clear();

            // 清空 BatchList
            if (typeof BatchList_removeItem === 'function') {
                assetIds.forEach(assetId => {
                    BatchList_removeItem(assetId);
                });
            }

            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });

            updateBatchUI();
        }

        function openBatchMarkModal() {
            if (selectedAssets.size === 0) {
                alert('請先選擇要標記的資產');
                return;
            }

            document.getElementById('batch-selected-count').textContent = selectedAssets.size;
            $('#batchMarkModal').modal('show');
        }

        function submitBatchMark() {
            const result = document.getElementById('batchResult').value;
            const remarks = document.getElementById('batchRemarks').value.trim();

            if (!result) {
                alert('請選擇盤點結果');
                return;
            }

            const assetResults = Array.from(selectedAssets).map(assetId => ({
                assetId: assetId,
                result: result,
                remarks: remarks
            }));

            // 顯示處理中
            const submitBtn = document.getElementById('batch-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const spinner = submitBtn.querySelector('.spinner-border');
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline-block';

            google.script.run
                .withSuccessHandler(function(response) {
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';

                    if (response.success) {
                        // 關閉彈窗
                        $('#batchMarkModal').modal('hide');

                        // 顯示成功訊息
                        if (typeof BatchList_showToast === 'function') {
                            BatchList_showToast(response.message, 'success');
                        } else {
                            alert(response.message);
                        }

                        // 清空選擇
                        deselectAllAssets();

                        // 清空批次備註
                        document.getElementById('batchRemarks').value = '';

                        // 重新載入資產列表
                        refreshSessionDetails();
                    } else {
                        alert('標記失敗：' + response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';
                    alert('標記失敗：' + error.message);
                })
                .markBatchInventory(currentSessionId, assetResults);
        }

        // ========== 批次處理函數結束 ========== 

        function loadHistory() {
            google.script.run
                .withSuccessHandler(function(history) {
                    const historyList = document.getElementById('history-list');

                    if (history.length === 0) {
                        historyList.innerHTML = '<p class="text-muted">尚無歷史記錄</p>';
                        return;
                    }

                    historyList.innerHTML = '';
                    history.forEach(record => {
                        const date = new Date(record.inventoryDate).toLocaleString('zh-TW');
                        const completionDate = record.completionTime ?
                            new Date(record.completionTime).toLocaleString('zh-TW') : '-';

                        const statusBadge = record.status === '已完成' ?
                            '<span class="badge badge-success">已完成</span>' :
                            '<span class="badge badge-warning">進行中</span>';

                        // 管理員模式：顯示會話擁有者資訊
                        const ownerInfo = isAdmin && record.inventoryEmail
                            ? `<br><small class="text-info"><i class="fa-solid fa-user"></i> 盤點人：${record.inventoryPerson} (${record.inventoryEmail})</small>`
                            : '';

                        historyList.innerHTML += `
                            <div class="session-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <b>${record.inventoryId}</b> ${statusBadge}<br>
                                        <small class="text-muted">
                                            範圍: ${record.filter}<br>
                                            開始時間: ${date}<br>
                                            ${record.status === '已完成' ? '完成時間: ' + completionDate : ''}
                                        </small>
                                        ${ownerInfo}
                                    </div>
                                    <div class="text-right">
                                        <div>${record.verifiedCount} / ${record.totalCount}</div>
                                        <small class="text-muted">已盤點/總計</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('載入歷史記錄失敗：', error);
                })
                .getInventoryHistory(isAdmin); // 管理員模式：查看所有記錄
        }
    </script>
</body>
</html>
