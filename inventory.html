<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 引入 FontAwesome 增加圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f4f7f6;
        }

        /* 響應式容器 */
        .container-responsive {
            max-width: 1200px;
            margin: 0 auto;
        }

        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 卡片樣式優化 */
        .section-card {
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: none;
        }

        .session-item { cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .session-item:hover { background-color: #f0f0f0; }
        .session-item.active { background-color: #e3f2fd; border-color: #2196F3; }

        /* 資產清單容器 - 移除固定高度,避免內部捲動 */
        .asset-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .asset-item:last-child { border-bottom: none; }
        .asset-item:hover { background-color: #f1f8ff; }

        .badge-result { padding: 5px 10px; border-radius: 3px; font-size: 0.9em; }
        .result-normal { background-color: #4caf50; color: white; }
        .result-missing { background-color: #f44336; color: white; }
        .result-damaged { background-color: #ff9800; color: white; }
        .result-unverified { background-color: #9e9e9e; color: white; }
        .progress-container { margin: 15px 0; }
        .stats-box { padding: 15px; background-color: #f5f5f5; border-radius: 5px; margin-top: 15px; }

        /* 批次操作相關樣式 */
        #batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #batch-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* 資產卡片 checkbox 樣式 */
        .asset-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 0;
            transition: all 0.2s;
        }

        .asset-item:has(.asset-checkbox:checked) {
            border-color: #007bff;
            background-color: #e7f3ff;
        }

        .asset-item-header {
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 10px;
            border-bottom: 1px solid #eee;
        }

        .asset-item-header .btn {
            font-size: 0.85rem;
            padding: 4px 10px;
        }

        .asset-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .asset-item-body {
            padding: 10px;
            cursor: pointer;
        }

        .asset-item-body:hover {
            background-color: #f8f9fa;
        }

        .asset-item-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            margin: 0;
        }

        /* 移動端優化 - 避免卡片內捲動 */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container-responsive { padding: 0; }
        }
    </style>
</head>
<body>
    <?!= include('shared-nav'); ?>
    <?!= include('batch_processing_list'); ?>
    <?!= include('selectbyqr'); ?>

    <div id="loader-container" class="text-center">
        <div class="loader"></div>
        <p>正在載入盤點資料...</p>
    </div>

    <div class="container-responsive">
        <div id="main-content" style="display:none;">
            <h4>資產盤點管理</h4>

        <!-- Active Sessions Section -->
        <div class="card section-card" id="active-sessions-card" style="display:none;">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">進行中的盤點會話</h5>
            </div>
            <div class="card-body">
                <div id="active-sessions-list"></div>
            </div>
        </div>

        <!-- Start New Session Section -->
        <div class="card section-card" id="start-session-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">開始新的盤點</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label><b>選擇盤點範圍：</b></label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-all" value="all" checked>
                        <label class="form-check-label" for="filter-all">盤點所有資產（在庫狀態）</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-location" value="location">
                        <label class="form-check-label" for="filter-location">依地點篩選</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-keeper" value="keeper">
                        <label class="form-check-label" for="filter-keeper">依保管人篩選</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="filterType" id="filter-user" value="user">
                        <label class="form-check-label" for="filter-user">依使用人篩選</label>
                    </div>
                </div>

                <div class="form-group" id="location-select-group" style="display:none;">
                    <label for="location-select">選擇地點：</label>
                    <select id="location-select" class="form-control"></select>
                </div>

                <div class="form-group" id="keeper-select-group" style="display:none;">
                    <label for="keeper-select">選擇保管人：</label>
                    <select id="keeper-select" class="form-control"></select>
                </div>

                <div class="form-group" id="user-select-group" style="display:none;">
                    <label for="user-select">選擇使用人：</label>
                    <select id="user-select" class="form-control"></select>
                </div>

                <button class="btn btn-primary" id="start-session-btn" onclick="startNewSession()">
                    <span class="btn-text">開始盤點</span>
                    <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                </button>
            </div>
        </div>

        <!-- Inventory Session Detail -->
        <div class="card section-card" id="session-detail-card" style="display:none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">盤點進行中 - <span id="session-id-display"></span></h5>
            </div>
            <div class="card-body">
                <div class="progress-container">
                    <div class="d-flex justify-content-between mb-2">
                        <span>進度：<span id="progress-text">0/0</span></span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 掃描器區域 -->
                <div id="Scanner_zone" class="scanner-zone" style="display:none;"></div>

                <!-- 批次操作按鈕區 -->
                <div id="batch-actions" style="margin-bottom: 15px;">
                    <button class="btn btn-success btn-sm" onclick="openBatchMarkModal()">
                        <i class="fa-solid fa-check-double"></i> 批次盤點確認
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllAssets()">
                        <i class="fa-solid fa-check-square"></i> 全選
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllAssets()">
                        <i class="fa-regular fa-square"></i> 取消全選
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="Scanner_toggle()">
                        <i class="fa-solid fa-camera"></i> 開啟掃描器
                    </button>
                    
                </div>

                <div class="form-group">
                    <label for="search-box">搜尋資產：</label>
                    <input type="text" class="form-control" id="search-box" placeholder="輸入產編或名稱，或掃描條碼按 Enter">
                </div>

                <div id="assets-list" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                    <div class="text-center text-muted py-5" id="empty-state-hint">
                        <i class="fa-solid fa-clipboard-list fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p class="mb-0">請點選進行中的盤點或新增盤點任務</p>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success" onclick="completeSession()">
                        <span class="btn-text">完成盤點</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="refreshSessionDetails()">重新整理</button>
                    <button class="btn btn-outline-secondary ml-2" onclick="backToStart()">返回</button>
                </div>
            </div>
        </div>

        <!-- Inventory History -->
        <div class="card section-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">盤點歷史記錄</h5>
            </div>
            <div class="card-body">
                <div id="history-list">
                    <p class="text-muted">尚無歷史記錄</p>
                </div>
            </div>
        </div>
        </div> <!-- 關閉 main-content -->
    </div> <!-- 關閉 container-responsive -->

    <!-- Modal for marking asset -->
    <div class="modal fade" id="markAssetModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">標記資產盤點結果</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><b>財產編號：</b><span id="modal-asset-id"></span></p>
                    <p><b>財產名稱：</b><span id="modal-asset-name"></span></p>
                    <p><b>保管人：</b><span id="modal-keeper-name"></span></p>
                    <p><b>地點：</b><span id="modal-location"></span></p>

                    <div class="form-group">
                        <label><b>盤點結果：</b></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-normal" value="正常" checked>
                            <label class="form-check-label" for="result-normal">正常</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-missing" value="遺失">
                            <label class="form-check-label" for="result-missing">遺失</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="inventoryResult" id="result-damaged" value="損壞">
                            <label class="form-check-label" for="result-damaged">損壞</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inventory-remarks">備註：</label>
                        <textarea class="form-control" id="inventory-remarks" rows="3" placeholder="選填"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryResult()">
                        <span class="btn-text">儲存</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批次標記彈窗 -->
    <div class="modal fade" id="batchMarkModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批次標記盤點結果</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p>已選擇 <strong id="batch-selected-count">0</strong> 項資產</p>
                    </div>
                    <div class="form-group">
                        <label for="batchResult"><b>盤點結果：</b></label>
                        <select class="form-control" id="batchResult">
                            <option value="正常">正常</option>
                            <option value="遺失">遺失</option>
                            <option value="損壞">損壞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="batchRemarks">備註（選填）：</label>
                        <textarea class="form-control" id="batchRemarks" rows="3" placeholder="此備註將套用到所有選中的資產"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="batch-submit-btn" onclick="submitBatchMark()">
                        <span class="btn-text">確認標記</span>
                        <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let inventoryData = null;
        let currentSessionId = null;
        let currentSessionDetails = [];
        let selectedAssets = new Set(); // 儲存選中的資產 ID

        document.addEventListener("DOMContentLoaded", function() {
            loadInventoryData();

            // Filter type change handlers
            document.querySelectorAll('input[name="filterType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('location-select-group').style.display =
                        this.value === 'location' ? 'block' : 'none';
                    document.getElementById('keeper-select-group').style.display =
                        this.value === 'keeper' ? 'block' : 'none';
                    document.getElementById('user-select-group').style.display =
                        this.value === 'user' ? 'block' : 'none';
                });
            });

            // Asset search handler
            document.getElementById('search-box').addEventListener('input', function() {
                filterAssetsList(this.value);
            });
        });

        function loadInventoryData() {
            document.getElementById('loader-container').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';

            google.script.run
                .withSuccessHandler(function(data) {
                    inventoryData = data;
                    populateFilters(data);
                    displayActiveSessions(data.activeSessions);
                    loadHistory();

                    document.getElementById('loader-container').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';

                    // ✨ 已移除自動載入邏輯，讓使用者手動選擇要載入的會話
                })
                .withFailureHandler(function(error) {
                    alert('載入資料失敗：' + error.message);
                    document.getElementById('loader-container').style.display = 'none';
                })
                .getInventoryData();
        }

        function populateFilters(data) {
            // Populate location select
            const locationSelect = document.getElementById('location-select');
            locationSelect.innerHTML = '<option value="">請選擇地點</option>';
            data.locations.forEach(loc => {
                locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
            });

            // Populate keeper select
            const keeperSelect = document.getElementById('keeper-select');
            keeperSelect.innerHTML = '<option value="">請選擇保管人</option>';
            data.keepers.forEach(keeper => {
                keeperSelect.innerHTML += `<option value="${keeper}">${keeper}</option>`;
            });

            // Populate user select
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">請選擇使用人</option>';
            data.users.forEach(user => {
                userSelect.innerHTML += `<option value="${user}">${user}</option>`;
            });
        }

        function displayActiveSessions(sessions) {
            const card = document.getElementById('active-sessions-card');
            const list = document.getElementById('active-sessions-list');

            if (sessions.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            list.innerHTML = '';

            sessions.forEach(session => {
                const percentage = session.totalCount > 0
                    ? Math.round((session.verifiedCount / session.totalCount) * 100)
                    : 0;

                list.innerHTML += `
                    <div class="session-item" onclick="loadSessionDetails('${session.inventoryId}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <b>${session.inventoryId}</b><br>
                                <small class="text-muted">範圍: ${session.filter}</small>
                            </div>
                            <div class="text-right">
                                <div>${session.verifiedCount} / ${session.totalCount}</div>
                                <small class="text-muted">${percentage}%</small>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        function startNewSession() {
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            let filterValue = '';

            if (filterType === 'location') {
                filterValue = document.getElementById('location-select').value;
                if (!filterValue) {
                    alert('請選擇地點');
                    return;
                }
            } else if (filterType === 'keeper') {
                filterValue = document.getElementById('keeper-select').value;
                if (!filterValue) {
                    alert('請選擇保管人');
                    return;
                }
            } else if (filterType === 'user') {
                filterValue = document.getElementById('user-select').value;
                if (!filterValue) {
                    alert('請選擇使用人');
                    return;
                }
            }

            const btn = document.getElementById('start-session-btn');
            btn.disabled = true;
            btn.querySelector('.btn-text').style.display = 'none';
            btn.querySelector('.spinner-border').style.display = 'inline-block';

            const options = {
                filterType: filterType,
                filterValue: filterValue,
                assetIds: []
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';

                    if (result.success) {
                        alert(result.message);
                        loadSessionDetails(result.inventoryId);
                        loadInventoryData(); // Refresh
                    } else {
                        alert('開始盤點失敗：' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';
                    alert('開始盤點失敗：' + error.message);
                })
                .startInventorySession(options);
        }

        function loadSessionDetails(inventoryId) {
            currentSessionId = inventoryId;
            document.getElementById('session-id-display').textContent = inventoryId;
            document.getElementById('start-session-card').style.display = 'none';
            document.getElementById('session-detail-card').style.display = 'block';

            // 切換會話時先清空本地選取與批次清單，避免跨會話殘留
            selectedAssets.clear();
            if (typeof BatchList_resetForSessionChange === 'function') {
                BatchList_resetForSessionChange();
            }
            updateBatchUI();

            // ✨ 切換會話時先清空資產列表，顯示載入中
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">載入中...</span>
                    </div>
                    <p class="text-muted mt-3">正在載入盤點資料...</p>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function(details) {
                    currentSessionDetails = details;

                    // 初始化全域資產列表與 BatchList 索引 (基於完整會話資料)
                    window.allAssets = details.map(asset => ({
                        id: asset.assetId,
                        assetName: asset.assetName,
                        keeperName: asset.keeperName,
                        location: asset.location,
                        status: asset.inventoryResult
                    }));

                    if (typeof BatchList_rebuildIndex === 'function') {
                        BatchList_rebuildIndex();
                    }

                    displaySessionDetails(details);
                })
                .withFailureHandler(function(error) {
                    // ✨ 新增錯誤處理與重試按鈕
                    assetsList.innerHTML = `
                        <div class="text-center text-danger py-5">
                            <i class="fa-solid fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>載入失敗：${error.message}</p>
                            <button class="btn btn-sm btn-primary" onclick="loadSessionDetails('${inventoryId}')">
                                <i class="fa-solid fa-rotate"></i> 重試
                            </button>
                        </div>
                    `;
                })
                .getInventoryDetails(inventoryId);
        }

        // ========== 分頁相容函數 ==========
        // 此函數供 BatchList 模組使用，inventory.html 沒有分頁功能，
        // 但需要此函數避免 BatchList 模組持續重試
        function renderTableForPage() {
            // inventory.html 沒有分頁，此函數僅為相容性而存在
            // 重新渲染當前的資產列表以同步 checkbox 狀態
            if (currentSessionDetails && currentSessionDetails.length > 0) {
                displaySessionDetails(currentSessionDetails);
            }
        }

        function displaySessionDetails(details) {
            const total = details.length;
            const verified = details.filter(d => d.inventoryResult !== '未盤點').length;
            const percentage = total > 0 ? Math.round((verified / total) * 100) : 0;

            document.getElementById('progress-text').textContent = `${verified}/${total}`;
            document.getElementById('progress-percentage').textContent = `${percentage}%`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = '';

            if (details.length === 0) {
                assetsList.innerHTML = '<p class="text-muted">沒有資產需要盤點</p>';
                return;
            }

            details.forEach(asset => {
                const resultClass = asset.inventoryResult === '正常' ? 'result-normal' :
                                  asset.inventoryResult === '遺失' ? 'result-missing' :
                                  asset.inventoryResult === '損壞' ? 'result-damaged' :
                                  'result-unverified';

                const resultBadge = `<span class="badge-result ${resultClass}">${asset.inventoryResult}</span>`;
                const escapedName = (asset.assetName || '').replace(/'/g, "\\'");

                assetsList.innerHTML += `
                    <div class="asset-item">
                        <div class="asset-item-header">
                            <input type="checkbox"
                                   class="asset-checkbox"
                                   data-asset-id="${asset.assetId}"
                                   onchange="toggleAssetSelection('${asset.assetId}')">
                            <div class="asset-item-name">${asset.assetId} - ${asset.assetName}</div>
                            <button class="btn btn-sm btn-outline-primary ml-auto"
                                    onclick="openMarkModal('${asset.assetId}')"
                                    title="標記此資產">
                                <i class="fa-solid fa-edit"></i> 單筆確認
                            </button>
                        </div>
                        <div class="asset-item-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">保管人: ${asset.keeperName} | 地點: ${asset.location}</small>
                                    ${asset.remarks ? '<br><small class="text-info">備註: ' + asset.remarks + '</small>' : ''}
                                </div>
                                <div>
                                    ${resultBadge}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // 同步 checkbox 狀態（從 selectedAssets 和 BatchList 雙向同步）
            setTimeout(() => {
                // 從 selectedAssets 同步
                selectedAssets.forEach(assetId => {
                    const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // 從 BatchList 同步（Scanner Enter 鍵掃描會直接加入 BatchList）
                if (typeof BatchList_getItems === 'function') {
                    const batchItems = BatchList_getItems();
                    batchItems.forEach(assetId => {
                        const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);
                        if (checkbox && !checkbox.checked) {
                            checkbox.checked = true;
                            selectedAssets.add(assetId);
                        }
                    });
                }

                updateBatchUI();
            }, 100);
        }

        function filterAssetsList(searchTerm) {
            if (!currentSessionDetails) return;

            const filtered = currentSessionDetails.filter(asset =>
                asset.assetId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                asset.assetName.toLowerCase().includes(searchTerm.toLowerCase())
            );

            displaySessionDetails(filtered);
        }

        function openMarkModal(assetId) {
            const asset = currentSessionDetails.find(a => a.assetId === assetId);
            if (!asset) return;

            document.getElementById('modal-asset-id').textContent = asset.assetId;
            document.getElementById('modal-asset-name').textContent = asset.assetName;
            document.getElementById('modal-keeper-name').textContent = asset.keeperName;
            document.getElementById('modal-location').textContent = asset.location;
            document.getElementById('inventory-remarks').value = asset.remarks || '';

            // Set current result
            if (asset.inventoryResult === '正常') {
                document.getElementById('result-normal').checked = true;
            } else if (asset.inventoryResult === '遺失') {
                document.getElementById('result-missing').checked = true;
            } else if (asset.inventoryResult === '損壞') {
                document.getElementById('result-damaged').checked = true;
            } else {
                document.getElementById('result-normal').checked = true;
            }

            $('#markAssetModal').modal('show');
        }

        function saveInventoryResult() {
            const assetId = document.getElementById('modal-asset-id').textContent;
            const result = document.querySelector('input[name="inventoryResult"]:checked').value;
            const remarks = document.getElementById('inventory-remarks').value;

            const btn = $('#markAssetModal').find('.btn-primary');
            btn.prop('disabled', true);
            btn.find('.btn-text').hide();
            btn.find('.spinner-border').show();

            google.script.run
                .withSuccessHandler(function(response) {
                    btn.prop('disabled', false);
                    btn.find('.btn-text').show();
                    btn.find('.spinner-border').hide();

                    if (response.success) {
                        $('#markAssetModal').modal('hide');
                        refreshSessionDetails();
                    } else {
                        alert('儲存失敗：' + response.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.prop('disabled', false);
                    btn.find('.btn-text').show();
                    btn.find('.spinner-border').hide();
                    alert('儲存失敗：' + error.message);
                })
                .markAssetInventory(currentSessionId, assetId, result, remarks);
        }

        function refreshSessionDetails() {
            if (currentSessionId) {
                loadSessionDetails(currentSessionId);
            }
        }

        function completeSession() {
            if (!currentSessionId) return;

            if (!confirm('確定要完成此盤點會話嗎？完成後將無法再修改盤點結果。')) {
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.querySelector('.btn-text').style.display = 'none';
            btn.querySelector('.spinner-border').style.display = 'inline-block';

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';

                    if (result.success) {
                        const stats = result.stats;
                        let message = `盤點已完成！\n\n`;
                        message += `總計: ${stats.total} 筆\n`;
                        message += `正常: ${stats.normal} 筆\n`;
                        message += `遺失: ${stats.missing} 筆\n`;
                        message += `損壞: ${stats.damaged} 筆\n`;

                        alert(message);
                        backToStart();
                        loadInventoryData();
                    } else {
                        alert(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.spinner-border').style.display = 'none';
                    alert('完成盤點失敗：' + error.message);
                })
                .completeInventorySession(currentSessionId);
        }

        function backToStart() {
            currentSessionId = null;
            currentSessionDetails = [];
            selectedAssets.clear();
            document.getElementById('session-detail-card').style.display = 'none';
            document.getElementById('start-session-card').style.display = 'block';
            document.getElementById('search-box').value = '';

            // ✨ 清空 window.allAssets，避免資料殘留
            window.allAssets = [];

            // ✨ 清空 BatchList 索引
            if (typeof BatchList_rebuildIndex === 'function') {
                BatchList_rebuildIndex();
            }

            // ✨ 恢復空狀態提示
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = `
                <div class="text-center text-muted py-5" id="empty-state-hint">
                    <i class="fa-solid fa-clipboard-list fa-3x mb-3" style="opacity: 0.3;"></i>
                    <p class="mb-0">請點選進行中的盤點或新增盤點任務</p>
                </div>
            `;
        }

        // ========== 批次處理函數 ==========

        function toggleAssetSelection(assetId) {
            const checkbox = document.querySelector(`input[data-asset-id="${assetId}"]`);

            if (checkbox && checkbox.checked) {
                selectedAssets.add(assetId);
                // 同步到 BatchList 模組
                if (typeof BatchList_addItem === 'function') {
                    BatchList_addItem(assetId);
                }
            } else {
                selectedAssets.delete(assetId);
                // 同步到 BatchList 模組
                if (typeof BatchList_removeItem === 'function') {
                    BatchList_removeItem(assetId);
                }
            }

            updateBatchUI();
        }

        function updateBatchUI() {
            const count = selectedAssets.size;

            // 更新計數
            const countEl = document.getElementById('batch-selected-count');
            if (countEl) {
                countEl.textContent = count;
            }
        }

        function selectAllAssets() {
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const assetId = cb.dataset.assetId;
                selectedAssets.add(assetId);
                if (typeof BatchList_addItem === 'function') {
                    BatchList_addItem(assetId);
                }
            });
            updateBatchUI();
        }

        function deselectAllAssets() {
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedAssets.clear();

            // 清空 BatchList
            if (typeof BatchList_removeItem === 'function') {
                checkboxes.forEach(cb => {
                    BatchList_removeItem(cb.dataset.assetId);
                });
            }

            updateBatchUI();
        }

        function openBatchMarkModal() {
            if (selectedAssets.size === 0) {
                alert('請先選擇要標記的資產');
                return;
            }

            document.getElementById('batch-selected-count').textContent = selectedAssets.size;
            $('#batchMarkModal').modal('show');
        }

        function submitBatchMark() {
            const result = document.getElementById('batchResult').value;
            const remarks = document.getElementById('batchRemarks').value.trim();

            if (!result) {
                alert('請選擇盤點結果');
                return;
            }

            const assetResults = Array.from(selectedAssets).map(assetId => ({
                assetId: assetId,
                result: result,
                remarks: remarks
            }));

            // 顯示處理中
            const submitBtn = document.getElementById('batch-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const spinner = submitBtn.querySelector('.spinner-border');
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline-block';

            google.script.run
                .withSuccessHandler(function(response) {
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';

                    if (response.success) {
                        // 關閉彈窗
                        $('#batchMarkModal').modal('hide');

                        // 顯示成功訊息
                        if (typeof BatchList_showToast === 'function') {
                            BatchList_showToast(response.message, 'success');
                        } else {
                            alert(response.message);
                        }

                        // 清空選擇
                        deselectAllAssets();

                        // 清空批次備註
                        document.getElementById('batchRemarks').value = '';

                        // 重新載入資產列表
                        refreshSessionDetails();
                    } else {
                        alert('標記失敗：' + response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';
                    alert('標記失敗：' + error.message);
                })
                .markBatchInventory(currentSessionId, assetResults);
        }

        // ========== 批次處理函數結束 ==========

        function loadHistory() {
            google.script.run
                .withSuccessHandler(function(history) {
                    const historyList = document.getElementById('history-list');

                    if (history.length === 0) {
                        historyList.innerHTML = '<p class="text-muted">尚無歷史記錄</p>';
                        return;
                    }

                    historyList.innerHTML = '';
                    history.forEach(record => {
                        const date = new Date(record.inventoryDate).toLocaleString('zh-TW');
                        const completionDate = record.completionTime ?
                            new Date(record.completionTime).toLocaleString('zh-TW') : '-';

                        const statusBadge = record.status === '已完成' ?
                            '<span class="badge badge-success">已完成</span>' :
                            '<span class="badge badge-warning">進行中</span>';

                        historyList.innerHTML += `
                            <div class="session-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <b>${record.inventoryId}</b> ${statusBadge}<br>
                                        <small class="text-muted">
                                            範圍: ${record.filter}<br>
                                            開始時間: ${date}<br>
                                            ${record.status === '已完成' ? '完成時間: ' + completionDate : ''}
                                        </small>
                                    </div>
                                    <div class="text-right">
                                        <div>${record.verifiedCount} / ${record.totalCount}</div>
                                        <small class="text-muted">已盤點/總計</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('載入歷史記錄失敗：', error);
                })
                .getInventoryHistory(false);
        }
    </script>
</body>
</html>
