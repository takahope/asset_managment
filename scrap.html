<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message {
            margin-top: 15px;
            font-weight: bold;
            /* ç¢ºä¿ç‹€æ…‹è¨Šæ¯é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¹‹ä¸Š */
            position: relative;
            z-index: 10000;  /* é«˜æ–¼é€²åº¦æ¢çš„ z-index: 9999 */
        }
        .asset-table-container { max-height: 250px; overflow-y: auto; margin-bottom: 15px; }
        /* âœ¨ æ–°å¢åˆ†é æ¨£å¼ âœ¨ */
        .pagination-controls { margin-top: 15px; user-select: none; }
        .pagination-controls .page-link { cursor: pointer; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
  <?!= include('progress_bar_basic'); ?>
    <div id="main-content">
        <!-- éœæ…‹å€åŸŸï¼šå§‹çµ‚å¯è¦‹ -->
        <div id="static-header">
            <h4>ç”³è«‹è²¡ç”¢å ±å»¢ (æ‰¹æ¬¡)</h4>
            <p class="text-danger">è«‹å‹¾é¸è¦å ±å»¢çš„é …ç›®ã€‚æ³¨æ„ï¼šæ­¤æ“ä½œå°‡æœƒå°‡è²¡ç”¢ç‹€æ…‹æ›´æ–°ç‚ºã€Œå ±å»¢ä¸­ã€ï¼Œå¾…ç®¡ç†å“¡æœ€çµ‚ç¢ºèªã€‚</p>

            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="location-filter-select">ä¾åœ°é»ç¯©é¸ï¼š</label>
                    <select id="location-filter-select" class="form-control">
                        <option value="">-- é¡¯ç¤ºå…¨éƒ¨åœ°é» --</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="category-filter-select">ä¾è²¡ç”¢é¡åˆ¥ç¯©é¸ï¼š</label>
                    <select id="category-filter-select" class="form-control">
                        <option value="">-- é¡¯ç¤ºå…¨éƒ¨é¡åˆ¥ --</option>
                        <option value="è²¡ç”¢">è²¡ç”¢</option>
                        <option value="éæ¶ˆè€—å“">éæ¶ˆè€—å“</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="search-box">ä¾é—œéµå­—æœå°‹ï¼š</label>
                    <input type="text" class="form-control" id="search-box" placeholder="è¼¸å…¥ç”¢ç·¨æˆ–åœ°é»...">
                </div>
            </div>
        </div>

        <!-- å‹•æ…‹å€åŸŸï¼šè¼‰å…¥æ™‚éš±è— -->
        <div id="dynamic-form">
            <div class="asset-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 20%;">è²¡ç”¢ç·¨è™Ÿ</th>
                            <th style="width: 25%;">è²¡ç”¢åç¨±</th>
                            <th style="width: 12%;">ä½¿ç”¨äºº</th>
                            <th style="width: 12%;">ä¿ç®¡äºº</th>
                            <th style="width: 13%;">ç›®å‰åœ°é»</th>
                            <th style="width: 13%;">ç›®å‰ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list"></tbody>
                </table>
            </div>

            <!-- âœ¨ æ–°å¢åˆ†é æ§åˆ¶é …çš„å®¹å™¨ âœ¨ -->
            <div id="pagination-controls" class="d-flex justify-content-between align-items-center"></div>

            <p>å·²å‹¾é¸ <span id="selected-count" class="font-weight-bold">0</span> ç­†è²¡ç”¢</p>
            <hr>

            <div class="form-group">
                <label for="reason-select"><b>å ±å»¢åŸå› ï¼š</b></label>
                <select id="reason-select" class="form-control" onchange="toggleRemarks()">
                    <option value="">è«‹é¸æ“‡åŸå› ...</option>
                    <option value="A">A.ç¶­ä¿®ä¸å…·æ•ˆç›Šï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                    <option value="B">B.æå£ç„¡æ³•ä¿®å¾©ï¼Œä¸”é€¾ä½¿ç”¨å¹´é™</option>
                    <option value="C">C.å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group" id="remarks-group" style="display: none;">
                <label for="remarks">è©³ç´°èªªæ˜ (é¸æ“‡ã€Œå…¶ä»–ã€æ™‚å¿…å¡«)ï¼š</label>
                <textarea class="form-control" id="remarks" rows="2"></textarea>
            </div>
            <button id="submit-btn" type="button" class="btn btn-danger" onclick="submitScrapping()">æäº¤å ±å»¢ç”³è«‹</button>
            <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">å–æ¶ˆ</button>
        </div>

        <div id="status-message"></div>
    </div>
    <script>
        // --- âœ¨ å…¨å±€è®Šæ•¸ç”¨æ–¼åˆ†é å’Œç¯©é¸ç®¡ç† âœ¨ ---
        let allAssets = [];
        let filteredAssets = [];
        let currentPage = 1;
        const rowsPerPage = 4000; // æ¯é é¡¯ç¤º 100 ç­†

        document.addEventListener("DOMContentLoaded", () => {
            // åªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚ç¶å®šäº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
            document.getElementById('location-filter-select').addEventListener('change', filterTable);
            document.getElementById('category-filter-select').addEventListener('change', filterTable);
            document.getElementById('search-box').addEventListener('input', filterTable);
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);

            // è¼‰å…¥è³‡æ–™
            showLoading(true);
            google.script.run
                .withSuccessHandler(populateData)
                .withFailureHandler(showError)
                .getScrappableAssets();
        });

        function populateData(response) {
            showLoading(false);
            if (response.error) {
                showError({message: response.error});
                return;
            }
            allAssets = response.assets;
            filteredAssets = allAssets;

            if (!allAssets || allAssets.length === 0) {
                // åªæ›´æ–° dynamic-formï¼Œä¿æŒæ¨™é¡Œå’Œç¯©é¸å™¨å¯è¦‹
                const dynamicForm = document.getElementById('dynamic-form');
                dynamicForm.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        <h5 class="alert-heading">ç›®å‰æ²’æœ‰å¯ç”³è«‹å ±å»¢çš„è²¡ç”¢</h5>
                        <p>æ‚¨ç›®å‰æ²’æœ‰ç‹€æ…‹ç‚ºã€Œåœ¨åº«ã€æˆ–ã€Œå‡ºå€Ÿä¸­ã€çš„è²¡ç”¢å¯ä¾›å ±å»¢ç”³è«‹ã€‚</p>
                        <hr>
                        <p class="mb-0">å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
                    </div>
                    <button class="btn btn-secondary" onclick="google.script.host.close()">é—œé–‰</button>
                `;
                dynamicForm.style.display = 'block';
                return;
            }

            populateLocationFilter(allAssets);
            currentPage = 1;
            renderPage(currentPage);
        }

        function renderPage(page) {
            currentPage = page;
            const assetListBody = document.getElementById('asset-list');
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredAssets.slice(start, end);

            // ğŸ›¡ï¸ å®‰å…¨æ€§ä¿®å¾©ï¼šä½¿ç”¨ DOM API æ›¿ä»£ innerHTML é˜²æ­¢ XSS
            assetListBody.innerHTML = '';
            paginatedItems.forEach(asset => {
                const row = document.createElement('tr');
                const statusClass = asset.status === 'å‡ºå€Ÿä¸­' ? 'badge-warning' : 'badge-success';

                // Checkbox å„²å­˜æ ¼
                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'asset-checkbox';
                checkbox.value = asset.id;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);

                // æ–‡å­—æ¬„ä½ä½¿ç”¨ textContent å®‰å…¨è¨­å®š
                [asset.id, asset.assetName, asset.userName, asset.leaderName, asset.location].forEach(data => {
                    const td = document.createElement('td');
                    td.textContent = data || '';
                    row.appendChild(td);
                });

                // ç‹€æ…‹æ¬„ä½
                const statusTd = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${statusClass}`;
                badge.textContent = asset.status;
                statusTd.appendChild(badge);
                row.appendChild(statusTd);

                assetListBody.appendChild(row);
            });

            renderPaginationControls();
            document.querySelectorAll('.asset-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedCount));
            document.getElementById('select-all').checked = false;
            updateSelectedCount();
        }

        function renderPaginationControls() {
            const controlsContainer = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(filteredAssets.length / rowsPerPage);
            
            if (filteredAssets.length === 0) {
                controlsContainer.innerHTML = '<span class="text-muted">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®ã€‚</span>';
                return;
            }
            if (totalPages <= 1) {
                controlsContainer.innerHTML = `<span class="text-muted">å…± ${filteredAssets.length} ç­†è³‡æ–™</span>`;
                return;
            }

            let paginationHtml = `<span class="text-muted">å…± ${filteredAssets.length} ç­†è³‡æ–™ï¼Œç¬¬ ${currentPage} / ${totalPages} é </span>`;
            let buttonsHtml = '<ul class="pagination mb-0">';
            buttonsHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage - 1})">ä¸Šä¸€é </a></li>`;
            buttonsHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage + 1})">ä¸‹ä¸€é </a></li>`;
            buttonsHtml += '</ul>';
            controlsContainer.innerHTML = paginationHtml + buttonsHtml;
        }

        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const categoryFilter = document.getElementById('category-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();
            filteredAssets = allAssets.filter(asset => {
                const locationMatch = (locationFilter === '') || (asset.location.toUpperCase() === locationFilter);
                const categoryMatch = (categoryFilter === '') || (asset.category.toUpperCase() === categoryFilter);
                const searchMatch = asset.id.toUpperCase().includes(searchFilter) || asset.location.toUpperCase().includes(searchFilter);
                return locationMatch && categoryMatch && searchMatch;
            });
            currentPage = 1;
            renderPage(currentPage);
        }

        function populateLocationFilter(assets) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            // æ¸…ç©ºèˆŠé¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹é è¨­é¸é …ï¼‰
            locationFilterSelect.innerHTML = '<option value="">-- é¡¯ç¤ºå…¨éƒ¨åœ°é» --</option>';
            const uniqueLocations = [...new Set(assets.map(asset => asset.location))].sort();
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function toggleRemarks() {
            const reason = document.getElementById('reason-select').value;
            document.getElementById('remarks-group').style.display = (reason === 'å…¶ä»–' || reason === 'æå£') ? 'block' : 'none';
        }

        function submitScrapping() {
            const selectedAssets = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            const reason = document.getElementById('reason-select').value;
            const remarks = document.getElementById('remarks').value.trim();
            if (selectedAssets.length === 0 || !reason) { showError({message: 'è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è²¡ç”¢ä¸¦é¸æ“‡å ±å»¢åŸå› ã€‚'}); return; }
            if ((reason === 'å…¶ä»–' || reason === 'æå£') && !remarks) { showError({message: 'é¸æ“‡ã€Œæå£ã€æˆ–ã€Œå…¶ä»–ã€åŸå› æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è©³ç´°èªªæ˜ã€‚'}); return; }
            
            const confirmation = confirm(`æ‚¨ç¢ºå®šè¦ç‚º ${selectedAssets.length} ç­†è²¡ç”¢æäº¤å ±å»¢ç”³è«‹å—ï¼Ÿ`);
            if (!confirmation) return;
            
            showLoading(true, "æ­£åœ¨æäº¤å ±å»¢ç”³è«‹...");
            const formData = { assetIds: selectedAssets, reason, remarks };
            google.script.run
                .withSuccessHandler(showSuccessAndClose)
                .withFailureHandler(showError)
                .processBatchScrapping(formData);
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.asset-checkbox:checked').length;
            document.getElementById('selected-count').textContent = count;
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('#asset-list .asset-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
            updateSelectedCount();
        }

        /**
         * é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
         * @param {string} msg - è¨Šæ¯å…§å®¹
         * @param {string} className - Bootstrap alert æ¨£å¼é¡åˆ¥
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;

            // 3 ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        function showLoading(isLoading, text = "æ­£åœ¨åˆ†æå¯å ±å»¢è³‡ç”¢è³‡æ–™ä¸­...") {
            const dynamicForm = document.getElementById('dynamic-form');
            if (isLoading) {
                dynamicForm.style.display = 'none';  // åªéš±è—å‹•æ…‹å€åŸŸ
                showProgressBar(text);
            } else {
                dynamicForm.style.display = 'block';
                hideProgressBar('åˆ†æå®Œæˆï¼', 300);
            }
        }

        function showSuccessAndClose(message) {
            // æ­¥é©Ÿ 1ï¼šéš±è—æäº¤æ™‚çš„é€²åº¦æ¢
            hideProgressBar('å ±å»¢ç”³è«‹å·²æäº¤ï¼', 0);

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // ç¢ºä¿å‹•æ…‹å€åŸŸéš±è—

            // æ­¥é©Ÿ 2ï¼šç«‹å³é¡¯ç¤ºç¶ è‰²æç¤ºè¨Šæ¯ï¼ˆ3 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
            showMessage(message + ' æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...', 'alert-success');

            // æ­¥é©Ÿ 3ï¼šçŸ­æš«å»¶é²å¾Œå•Ÿå‹•é‡æ–°è¼‰å…¥é€²åº¦æ¢ï¼ˆè®“ç”¨æˆ¶å…ˆçœ‹åˆ°ç¶ è‰²è¨Šæ¯ï¼‰
            setTimeout(() => {
                loadData();  // é€™æœƒèª¿ç”¨ showLoading(true, 'æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...')
            }, 150);  // 150ms å»¶é²ï¼Œç¢ºä¿ç¶ è‰²è¨Šæ¯å…ˆæ¸²æŸ“
        }

        function loadData() {
            showLoading(true, 'æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
            google.script.run
                .withSuccessHandler(populateData)
                .withFailureHandler(showError)
                .getScrappableAssets();
        }

        function showError(error) {
            showLoading(false);
            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "éŒ¯èª¤ï¼š" + error.message;
        }
    </script>
</body>
</html>