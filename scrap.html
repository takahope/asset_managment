<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message {
            margin-top: 15px;
            font-weight: bold;
            /* 確保狀態訊息顯示在進度條之上 */
            position: relative;
            z-index: 10000;  /* 高於進度條的 z-index: 9999 */
        }
        .asset-table-container { max-height: 250px; overflow-y: auto; margin-bottom: 15px; }
        /* ✨ 新增分頁樣式 ✨ */
        .pagination-controls { margin-top: 15px; user-select: none; }
        .pagination-controls .page-link { cursor: pointer; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
  <?!= include('progress_bar_basic'); ?>
    <div id="main-content">
        <!-- 靜態區域：始終可見 -->
        <div id="static-header">
            <h4>申請財產報廢 (批次)</h4>
            <p class="text-danger">請勾選要報廢的項目。注意：此操作將會將財產狀態更新為「報廢中」，待管理員最終確認。</p>

            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="location-filter-select">依地點篩選：</label>
                    <select id="location-filter-select" class="form-control">
                        <option value="">-- 顯示全部地點 --</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="category-filter-select">依財產類別篩選：</label>
                    <select id="category-filter-select" class="form-control">
                        <option value="">-- 顯示全部類別 --</option>
                        <option value="財產">財產</option>
                        <option value="非消耗品">非消耗品</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="search-box">依關鍵字搜尋：</label>
                    <input type="text" class="form-control" id="search-box" placeholder="輸入產編或地點...">
                </div>
            </div>
        </div>

        <!-- 動態區域：載入時隱藏 -->
        <div id="dynamic-form">
            <div class="asset-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 20%;">財產編號</th>
                            <th style="width: 25%;">財產名稱</th>
                            <th style="width: 12%;">使用人</th>
                            <th style="width: 12%;">保管人</th>
                            <th style="width: 13%;">目前地點</th>
                            <th style="width: 13%;">目前狀態</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list"></tbody>
                </table>
            </div>

            <!-- ✨ 新增分頁控制項的容器 ✨ -->
            <div id="pagination-controls" class="d-flex justify-content-between align-items-center"></div>

            <p>已勾選 <span id="selected-count" class="font-weight-bold">0</span> 筆財產</p>
            <hr>

            <div class="form-group">
                <label for="reason-select"><b>報廢原因：</b></label>
                <select id="reason-select" class="form-control" onchange="toggleRemarks()">
                    <option value="">請選擇原因...</option>
                    <option value="A">A.維修不具效益，且逾使用年限</option>
                    <option value="B">B.損壞無法修復，且逾使用年限</option>
                    <option value="C">C.其他</option>
                </select>
            </div>
            <div class="form-group" id="remarks-group" style="display: none;">
                <label for="remarks">詳細說明 (選擇「其他」時必填)：</label>
                <textarea class="form-control" id="remarks" rows="2"></textarea>
            </div>
            <button id="submit-btn" type="button" class="btn btn-danger" onclick="submitScrapping()">提交報廢申請</button>
            <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">取消</button>
        </div>

        <div id="status-message"></div>
    </div>
    <script>
        // --- ✨ 全局變數用於分頁和篩選管理 ✨ ---
        let allAssets = [];
        let filteredAssets = [];
        let currentPage = 1;
        const rowsPerPage = 4000; // 每頁顯示 100 筆

        document.addEventListener("DOMContentLoaded", () => {
            // 只在首次載入時綁定事件監聽器（避免重複綁定）
            document.getElementById('location-filter-select').addEventListener('change', filterTable);
            document.getElementById('category-filter-select').addEventListener('change', filterTable);
            document.getElementById('search-box').addEventListener('input', filterTable);
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);

            // 載入資料
            showLoading(true);
            google.script.run
                .withSuccessHandler(populateData)
                .withFailureHandler(showError)
                .getScrappableAssets();
        });

        function populateData(response) {
            showLoading(false);
            if (response.error) {
                showError({message: response.error});
                return;
            }
            allAssets = response.assets;
            filteredAssets = allAssets;

            if (!allAssets || allAssets.length === 0) {
                // 只更新 dynamic-form，保持標題和篩選器可見
                const dynamicForm = document.getElementById('dynamic-form');
                dynamicForm.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        <h5 class="alert-heading">目前沒有可申請報廢的財產</h5>
                        <p>您目前沒有狀態為「在庫」或「出借中」的財產可供報廢申請。</p>
                        <hr>
                        <p class="mb-0">如有疑問，請聯絡系統管理員。</p>
                    </div>
                    <button class="btn btn-secondary" onclick="google.script.host.close()">關閉</button>
                `;
                dynamicForm.style.display = 'block';
                return;
            }

            populateLocationFilter(allAssets);
            currentPage = 1;
            renderPage(currentPage);
        }

        function renderPage(page) {
            currentPage = page;
            const assetListBody = document.getElementById('asset-list');
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredAssets.slice(start, end);

            let tableHtml = '';
            paginatedItems.forEach(asset => {
                const statusClass = asset.status === '出借中' ? 'badge-warning' : 'badge-success';
                tableHtml += `<tr>
                    <td><input type="checkbox" class="asset-checkbox" value="${asset.id}"></td>
                    <td>${asset.id}</td>
                    <td>${asset.assetName}</td>
                    <td>${asset.userName}</td>
                    <td>${asset.leaderName}</td>
                    <td>${asset.location}</td>
                    <td><span class="badge ${statusClass}">${asset.status}</span></td>
                </tr>`;
            });
            assetListBody.innerHTML = tableHtml;

            renderPaginationControls();
            document.querySelectorAll('.asset-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedCount));
            document.getElementById('select-all').checked = false;
            updateSelectedCount();
        }

        function renderPaginationControls() {
            const controlsContainer = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(filteredAssets.length / rowsPerPage);
            
            if (filteredAssets.length === 0) {
                controlsContainer.innerHTML = '<span class="text-muted">沒有符合篩選條件的項目。</span>';
                return;
            }
            if (totalPages <= 1) {
                controlsContainer.innerHTML = `<span class="text-muted">共 ${filteredAssets.length} 筆資料</span>`;
                return;
            }

            let paginationHtml = `<span class="text-muted">共 ${filteredAssets.length} 筆資料，第 ${currentPage} / ${totalPages} 頁</span>`;
            let buttonsHtml = '<ul class="pagination mb-0">';
            buttonsHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage - 1})">上一頁</a></li>`;
            buttonsHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" onclick="renderPage(${currentPage + 1})">下一頁</a></li>`;
            buttonsHtml += '</ul>';
            controlsContainer.innerHTML = paginationHtml + buttonsHtml;
        }

        function filterTable() {
            const locationFilter = document.getElementById('location-filter-select').value.toUpperCase();
            const categoryFilter = document.getElementById('category-filter-select').value.toUpperCase();
            const searchFilter = document.getElementById('search-box').value.toUpperCase();
            filteredAssets = allAssets.filter(asset => {
                const locationMatch = (locationFilter === '') || (asset.location.toUpperCase() === locationFilter);
                const categoryMatch = (categoryFilter === '') || (asset.category.toUpperCase() === categoryFilter);
                const searchMatch = asset.id.toUpperCase().includes(searchFilter) || asset.location.toUpperCase().includes(searchFilter);
                return locationMatch && categoryMatch && searchMatch;
            });
            currentPage = 1;
            renderPage(currentPage);
        }

        function populateLocationFilter(assets) {
            const locationFilterSelect = document.getElementById('location-filter-select');
            // 清空舊選項（保留第一個預設選項）
            locationFilterSelect.innerHTML = '<option value="">-- 顯示全部地點 --</option>';
            const uniqueLocations = [...new Set(assets.map(asset => asset.location))].sort();
            uniqueLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationFilterSelect.appendChild(option);
            });
        }

        function toggleRemarks() {
            const reason = document.getElementById('reason-select').value;
            document.getElementById('remarks-group').style.display = (reason === '其他' || reason === '損壞') ? 'block' : 'none';
        }

        function submitScrapping() {
            const selectedAssets = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            const reason = document.getElementById('reason-select').value;
            const remarks = document.getElementById('remarks').value.trim();
            if (selectedAssets.length === 0 || !reason) { showError({message: '請至少勾選一筆財產並選擇報廢原因。'}); return; }
            if ((reason === '其他' || reason === '損壞') && !remarks) { showError({message: '選擇「損壞」或「其他」原因時，請務必填寫詳細說明。'}); return; }
            
            const confirmation = confirm(`您確定要為 ${selectedAssets.length} 筆財產提交報廢申請嗎？`);
            if (!confirmation) return;
            
            showLoading(true, "正在提交報廢申請...");
            const formData = { assetIds: selectedAssets, reason, remarks };
            google.script.run
                .withSuccessHandler(showSuccessAndClose)
                .withFailureHandler(showError)
                .processBatchScrapping(formData);
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.asset-checkbox:checked').length;
            document.getElementById('selected-count').textContent = count;
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('#asset-list .asset-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
            updateSelectedCount();
        }

        /**
         * 顯示提示訊息（3 秒後自動消失）
         * @param {string} msg - 訊息內容
         * @param {string} className - Bootstrap alert 樣式類別
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;

            // 3 秒後自動清除訊息
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        function showLoading(isLoading, text = "正在分析可報廢資產資料中...") {
            const dynamicForm = document.getElementById('dynamic-form');
            if (isLoading) {
                dynamicForm.style.display = 'none';  // 只隱藏動態區域
                showProgressBar(text);
            } else {
                dynamicForm.style.display = 'block';
                hideProgressBar('分析完成！', 300);
            }
        }

        function showSuccessAndClose(message) {
            // 步驟 1：隱藏提交時的進度條
            hideProgressBar('報廢申請已提交！', 0);

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // 確保動態區域隱藏

            // 步驟 2：立即顯示綠色提示訊息（3 秒後自動消失）
            showMessage(message + ' 正在重新載入資料...', 'alert-success');

            // 步驟 3：短暫延遲後啟動重新載入進度條（讓用戶先看到綠色訊息）
            setTimeout(() => {
                loadData();  // 這會調用 showLoading(true, '正在重新載入資料...')
            }, 150);  // 150ms 延遲，確保綠色訊息先渲染
        }

        function loadData() {
            showLoading(true, '正在重新載入資料...');
            google.script.run
                .withSuccessHandler(populateData)
                .withFailureHandler(showError)
                .getScrappableAssets();
        }

        function showError(error) {
            showLoading(false);
            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "錯誤：" + error.message;
        }
    </script>
</body>
</html>