<style>
  /* 全螢幕遮罩層 */
  .progress-loader-overlay-addnew {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    /* background-color: rgba(255, 255, 255, 0.3); */ /* 移除背景顏色 */
    /* backdrop-filter: blur(4px); */ /* 移除模糊效果 */
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* z-index: 9999; */ /* 移除 z-index */
    pointer-events: none; /* 允許點擊穿透此層 */
  }

  .progress-loader-overlay-addnew.active {
    display: flex;
  }

  /* 進度條容器 */
  .progress-loader-container-addnew {
    width: 80%;
    max-width: 500px;
    margin: 20px;
    display: flex;        /* 新增 Flex 佈局 */
    flex-direction: column; /* 垂直排列 */
    align-items: center;    /* 水平置中 */
    pointer-events: auto; /* 讓容器內的元素可以接收事件 */
  }

  /* --- 新增：GIF 動畫樣式 --- */
  .progress-loader-gif-addnew {
    width: 400px;       /* 根據你的 GIF 解析度調整大小 */
    height: auto;
    margin-bottom: 1px; /* 與進度條保持距離 */
    display: block;
  }

  /* 狀態文字 */
  .progress-loader-text-addnew {
    color: #495057;
    font-size: 16px;
    margin-top: 5px;
    font-weight: 500;
    text-align: center;
    font-family: 'Google Sans', Roboto, Arial, sans-serif;
  }

  /* 進度條外框修正 */
  .progress-addnew {
    width: 100%; /* 確保進度條佔滿容器寬度 */
    height: 20px;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    overflow: hidden;
  }

  /* 進度條本體 */
  .progress-bar-addnew {
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    background-color: #0d6efd;
    transition: width .6s ease;
  }

  /* Bootstrap Striped & Animated 效果模擬 (若未引入 Bootstrap CSS) */
  .progress-bar-striped-addnew {
    background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
    background-size: 1rem 1rem;
  }
  .progress-bar-animated-addnew {
    animation: progress-bar-stripes-addnew 1s linear infinite;
  }
  @keyframes progress-bar-stripes-addnew {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
  }
</style>

<div id="progress-loader-overlay-addnew" class="progress-loader-overlay-addnew">
  <div class="progress-loader-container-addnew">

    <img id="progress-loader-image-addnew"
         class="progress-loader-gif-addnew"
         src=""
         alt="Loading...">

    <div class="progress-addnew">
      <div id="progress-loader-bar-addnew"
           class="progress-bar-addnew progress-bar-striped-addnew progress-bar-animated-addnew"
           role="progressbar"
           style="width: 0%;"
           aria-valuenow="0"
           aria-valuemin="0"
           aria-valuemax="100">
           0%
      </div>
    </div>
  </div>
  <div id="progress-loader-text-addnew" class="progress-loader-text-addnew">正在載入資料，請稍候...</div>
</div>

<script>
  let _progressLoaderIntervalAddnew;

  function showProgressBarAddnew(statusText = '正在載入資料，請稍候...') {
    const overlay = document.getElementById('progress-loader-overlay-addnew');
    const progressBar = document.getElementById('progress-loader-bar-addnew');
    const loadingText = document.getElementById('progress-loader-text-addnew');

    // 如果進度條已經在運行中，只更新文字，不重置進度
    if (_progressLoaderIntervalAddnew) {
      loadingText.textContent = statusText;
      return;
    }

    // 重置進度條
    let progress = 1;
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    progressBar.textContent = '0%';

    loadingText.textContent = statusText;
    overlay.classList.add('active');

    // ✨ 強制重新播放 GIF 動畫（增強型 5 步驟重置邏輯）
    // 使用多種方式查找 img 元素（優先順序：getElementById > querySelector）
    const loaderImgById = document.getElementById('progress-loader-image-addnew');
    const loaderImgByQuery = document.querySelector('#progress-loader-image-addnew');
    const loaderImg = loaderImgById || loaderImgByQuery;

    if (loaderImg && loaderImg.src) {
      const originalSrc = loaderImg.src;
      const originalDisplay = loaderImg.style.display;

      // 增強型 GIF 重置邏輯（5 步驟）：
      // 1. 隱藏元素，強制瀏覽器停止 GIF 解碼
      loaderImg.style.display = 'none';

      // 2. 清空 src（使用 about:blank 而不是空字符串，避免被轉換為頁面 URL）
      loaderImg.src = 'about:blank';

      // 3. 強制重排（reflow）以確保瀏覽器處理了變更
      void loaderImg.offsetHeight;

      // 4. 使用 50ms 延遲來確保瀏覽器有足夠時間釋放資源
      setTimeout(() => {
        // 5. 恢復顯示並重新設定 src（添加時間戳避免快取）
        loaderImg.style.display = originalDisplay;
        const timestamp = new Date().getTime();
        loaderImg.src = originalSrc + '#' + timestamp;
      }, 50);
    }

    // 模擬進度增長
    _progressLoaderIntervalAddnew = setInterval(() => {
      if (progress < 90) {
        progress++;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';
      }
    }, 30);
  }

  function hideProgressBarAddnew(completionText = '資料載入完成！', delay = 300) {
    const overlay = document.getElementById('progress-loader-overlay-addnew');
    const progressBar = document.getElementById('progress-loader-bar-addnew');
    const loadingText = document.getElementById('progress-loader-text-addnew');

    clearInterval(_progressLoaderIntervalAddnew);
    _progressLoaderIntervalAddnew = null; // 重置標記，允許下次重新啟動進度條

    // 跳到 100%
    progressBar.style.width = '100%';
    progressBar.setAttribute('aria-valuenow', 100);
    progressBar.textContent = '100%'; // --- 新增：設定為 100% ---
    
    loadingText.textContent = completionText;

    setTimeout(() => {
      overlay.classList.remove('active');
    }, delay);
  }
</script>