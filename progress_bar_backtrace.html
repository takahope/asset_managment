<style>
  /* 全螢幕遮罩層 */
  .progress-loader-overlay-backtrace {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    /* background-color: rgba(255, 255, 255, 0.3); */ /* 移除背景顏色 */
    /* backdrop-filter: blur(4px); */ /* 移除模糊效果 */
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* z-index: 9999; */ /* 移除 z-index */
    pointer-events: none; /* 允許點擊穿透此層 */
  }

  .progress-loader-overlay-backtrace.active {
    display: flex;
  }

  /* 進度條容器 */
  .progress-loader-container-backtrace {
    width: 80%;
    max-width: 500px;
    margin: 20px;
    display: flex;        /* 新增 Flex 佈局 */
    flex-direction: column; /* 垂直排列 */
    align-items: center;    /* 水平置中 */
    pointer-events: auto; /* 讓容器內的元素可以接收事件 */
  }

  /* --- 新增：GIF 動畫樣式 --- */
  .progress-loader-gif-backtrace {
    width: 400px;       /* 根據你的 GIF 解析度調整大小 */
    height: auto;
    margin-bottom: 1px; /* 與進度條保持距離 */
    display: block;
  }

  /* 狀態文字 */
  .progress-loader-text-backtrace {
    color: #495057;
    font-size: 16px;
    margin-top: 5px;
    font-weight: 500;
    text-align: center;
    font-family: 'Google Sans', Roboto, Arial, sans-serif;
  }

  /* 進度條外框修正 */
  .progress-backtrace {
    width: 100%; /* 確保進度條佔滿容器寬度 */
    height: 20px;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    overflow: hidden;
  }

  /* 進度條本體 */
  .progress-bar-backtrace {
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    background-color: #0d6efd;
    transition: width .6s ease;
  }

  /* Bootstrap Striped & Animated 效果模擬 (若未引入 Bootstrap CSS) */
  .progress-bar-striped-backtrace {
    background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
    background-size: 1rem 1rem;
  }
  .progress-bar-animated-backtrace {
    animation: progress-bar-stripes-backtrace 1s linear infinite;
  }
  @keyframes progress-bar-stripes-backtrace {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
  }
</style>

<div id="progress-loader-overlay-backtrace" class="progress-loader-overlay-backtrace">
  <div class="progress-loader-container-backtrace">

    <img id="progress-loader-image-backtrace"
         class="progress-loader-gif-backtrace"
         src=""
         alt="Loading...">

    <div class="progress-backtrace">
      <div id="progress-loader-bar-backtrace"
           class="progress-bar-backtrace progress-bar-striped-backtrace progress-bar-animated-backtrace"
           role="progressbar"
           style="width: 0%;"
           aria-valuenow="0"
           aria-valuemin="0"
           aria-valuemax="100">
           0%
      </div>
    </div>
  </div>
  <div id="progress-loader-text-backtrace" class="progress-loader-text-backtrace">正在載入資料，請稍候...</div>
</div>

<script>
  let _progressLoaderIntervalbacktrace;

  function showProgressBarbacktrace(statusText = '正在載入資料，請稍候...') {
    const overlay = document.getElementById('progress-loader-overlay-backtrace');
    const progressBar = document.getElementById('progress-loader-bar-backtrace');
    const loadingText = document.getElementById('progress-loader-text-backtrace');

    // 如果進度條已經在運行中，只更新文字，不重置進度
    if (_progressLoaderIntervalbacktrace) {
      loadingText.textContent = statusText;
      return;
    }

    // 重置進度條
    let progress = 1;
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    progressBar.textContent = '0%';

    loadingText.textContent = statusText;
    overlay.classList.add('active');

    // 強制重新播放 GIF 動畫（清空再重設 src）
    const loaderImg = document.getElementById('progress-loader-image-backtrace');
    if (loaderImg) {
      const originalSrc = loaderImg.src;
      loaderImg.src = '';
      loaderImg.offsetHeight; // 觸發 reflow
      loaderImg.src = originalSrc;
    }

    // 模擬進度增長
    _progressLoaderIntervalbacktrace = setInterval(() => {
      if (progress < 90) {
        progress++;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';
      }
    }, 30);
  }

  function hideProgressBarbacktrace(completionText = '資料載入完成！', delay = 300) {
    const overlay = document.getElementById('progress-loader-overlay-backtrace');
    const progressBar = document.getElementById('progress-loader-bar-backtrace');
    const loadingText = document.getElementById('progress-loader-text-backtrace');

    clearInterval(_progressLoaderIntervalbacktrace);
    _progressLoaderIntervalbacktrace = null; // 重置標記，允許下次重新啟動進度條

    // 跳到 100%
    progressBar.style.width = '100%';
    progressBar.setAttribute('aria-valuenow', 100);
    progressBar.textContent = '100%'; // --- 新增：設定為 100% ---

    loadingText.textContent = completionText;

    setTimeout(() => {
      overlay.classList.remove('active');
    }, delay);
  }
</script>
