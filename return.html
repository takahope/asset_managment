<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        #status-message {
            margin-top: 15px;
            font-weight: bold;
            /* 確保狀態訊息顯示在進度條之上 */
            position: relative;
            z-index: 10000;  /* 高於進度條的 z-index: 9999 */
        }
        .asset-table-container { max-height: 400px; overflow-y: auto; margin-bottom: 15px; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
  <?!= include('progress_bar_basic'); ?>
    <div id="main-content">
        <!-- 靜態區域：始終可見 -->
        <div id="static-header">
            <h4>歸還作業管理</h4>
            <p>以下是您名下所有「出借中」的財產，請勾選已歸還的項目進行確認。</p>
        </div>

        <!-- 動態區域：載入時隱藏 -->
        <div id="dynamic-form">
            <div class="asset-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 20%;">財產編號</th>
                            <th style="width: 15%;">借用人</th>
                            <th style="width: 20%;">預計歸還日</th>
                            <th style="width: 20%;">出借後地點</th>
                            <th style="width: 20%;">出借事由</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list"></tbody>
                </table>
            </div>

            <div id="no-data-message" class="alert alert-info" style="display:none;">
                您目前沒有任何「出借中」的財產。
            </div>

            <button id="submit-btn" type="button" class="btn btn-success" onclick="submitReturn()">確認歸還所選項目</button>
            <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">關閉</button>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", loadData);

        function loadData() {
            // 只隱藏動態區域
            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';

            showProgressBar('正在載入歸還資料...');
            google.script.run
                .withSuccessHandler(populateTable)
                .withFailureHandler(showError)
                .getLentOutAssets();
        }

        function populateTable(response) {
            if (response.error) {
                showError({message: response.error});
                return;
            }

            const assets = response.assets;
            hideProgressBar('資料載入完成！', 300);

            // 延遲顯示動態區域（與進度條隱藏動畫同步）
            setTimeout(() => {
                const dynamicForm = document.getElementById('dynamic-form');

                if (!assets || assets.length === 0) {
                    // 只更新 dynamic-form，保持標題可見
                    dynamicForm.innerHTML = `
                        <div class="alert alert-info" role="alert">
                            <h5 class="alert-heading">目前沒有出借中的財產</h5>
                            <p>您目前沒有任何「出借中」的財產需要歸還。</p>
                            <hr>
                            <p class="mb-0">如有疑問，請聯絡系統管理員。</p>
                        </div>
                        <button class="btn btn-secondary" onclick="google.script.host.close()">關閉</button>
                    `;
                    dynamicForm.style.display = 'block';
                    return;
                }

                // 渲染表格
                const assetListBody = document.getElementById('asset-list');
                assetListBody.innerHTML = '';

                assets.forEach(asset => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="asset-checkbox" value="${asset.lendId}"></td>
                        <td>${asset.assetId}</td>
                        <td>${asset.borrower}</td>
                        <td>${asset.expectedReturnDate}</td>
                        <td>${asset.lendingLocation || ''}</td>
                        <td>${asset.reason}</td>
                    `;
                    assetListBody.appendChild(row);
                });

                // 綁定事件監聽器（只在首次載入時綁定）
                if (!dynamicForm.dataset.initialized) {
                    document.getElementById('select-all').addEventListener('change', toggleSelectAll);
                    dynamicForm.dataset.initialized = 'true';
                }

                dynamicForm.style.display = 'block';
            }, 300);
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('.asset-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }
        
        function submitReturn() {
            const selectedLendIds = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            if (selectedLendIds.length === 0) {
                showMessage('請至少勾選一筆要歸還的項目。', 'alert-warning');
                return;
            }

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // 隱藏動態區域

            showProgressBar('正在處理歸還作業...');
            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(showError)
                .processBatchReturn(selectedLendIds);
        }
        
        function handleSuccess(message) {
            // 步驟 1：隱藏提交時的進度條
            hideProgressBar('歸還完成！', 0);

            const dynamicForm = document.getElementById('dynamic-form');
            dynamicForm.style.display = 'none';  // 確保動態區域隱藏

            // 步驟 2：立即顯示綠色提示訊息（3 秒後自動消失）
            showMessage(message + ' 正在重新載入資料...', 'alert-success');

            // 步驟 3：短暫延遲後啟動重新載入進度條（讓用戶先看到綠色訊息）
            setTimeout(() => {
                loadData();  // 這會調用 showProgressBar()
            }, 3000);  // 3000ms 延遲，確保綠色訊息先渲染
        }

        /**
         * 顯示提示訊息（3 秒後自動消失）
         * @param {string} msg - 訊息內容
         * @param {string} className - Bootstrap alert 樣式類別
         */
        function showMessage(msg, className = 'alert-info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert ${className}`;
            statusDiv.textContent = msg;

            // 3 秒後自動清除訊息
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        function showError(error) {
            hideProgressBar('載入失敗！', 300);

            setTimeout(() => {
                showMessage('錯誤：' + error.message, 'alert-danger');
            }, 300);
        }
    </script>
</body>
</html>