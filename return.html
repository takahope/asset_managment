<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #28a745; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 15px; font-weight: bold; }
        .asset-table-container { max-height: 400px; overflow-y: auto; margin-bottom: 15px; }
    </style>
</head>
<body>
  <?!= include('shared-nav'); ?>
    <div id="main-content">
        <div id="main-form">
            <h4>歸還作業管理</h4>
            <p>以下是您名下所有「出借中」的財產，請勾選已歸還的項目進行確認。</p>

            <div class="asset-table-container">
                <table class="table table-hover table-sm">
                    <thead class="thead-light" style="position: sticky; top: 0;">
                        <tr>
                            <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                            <th style="width: 25%;">財產編號</th>
                            <th style="width: 20%;">借用人</th>
                            <th style="width: 20%;">預計歸還日</th>
                            <th style="width: 30%;">出借事由</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list">
                        </tbody>
                </table>
            </div>
             <div id="no-data-message" class="alert alert-info" style="display:none;">
                您目前沒有任何「出借中」的財產。
            </div>

            <button id="submit-btn" type="button" class="btn btn-success" onclick="submitReturn()">確認歸還所選項目</button>
            <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">關閉</button>
        </div>
        
        <div id="loading-spinner" style="display:none;">
            <div class="loader"></div>
            <p class="text-center">處理中，請稍候...</p>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", loadData);

        function loadData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(populateTable)
                .withFailureHandler(showError)
                .getLentOutAssets();
        }

        function populateTable(response) {
            showLoading(false);
            if (response.error) {
                showError({message: response.error});
                return;
            }
            const assets = response.assets;
            const assetListBody = document.getElementById('asset-list');
            assetListBody.innerHTML = '';

            if (!assets || assets.length === 0) {
                document.getElementById('asset-table-container').style.display = 'none';
                document.getElementById('submit-btn').style.display = 'none';
                document.getElementById('no-data-message').style.display = 'block';
                return;
            }
            
            assets.forEach(asset => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="asset-checkbox" value="${asset.lendId}"></td>
                    <td>${asset.assetId}</td>
                    <td>${asset.borrower}</td>
                    <td>${asset.expectedReturnDate}</td>
                    <td>${asset.reason}</td>
                `;
                assetListBody.appendChild(row);
            });
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
        }

        function toggleSelectAll(event) {
            document.querySelectorAll('.asset-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }
        
        function submitReturn() {
            const selectedLendIds = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => cb.value);
            if (selectedLendIds.length === 0) {
                showError({message: "請至少勾選一筆要歸還的項目。"});
                return;
            }

            showLoading(true, "正在提交歸還資料...");

            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(showError)
                .processBatchReturn(selectedLendIds);
        }
        
        function handleSuccess(message) {
            showLoading(false);
            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-success';
            statusMsg.textContent = message;
            // 2秒後自動重新載入清單
            setTimeout(loadData, 2000);
        }

        function showLoading(isLoading, text = "正在載入資料...") {
            const form = document.getElementById('main-form');
            const loader = document.getElementById('loading-spinner');
            const status = document.getElementById('status-message');
            
            if (isLoading) {
                form.style.display = 'none';
                loader.style.display = 'block';
                loader.querySelector('p').textContent = text;
                status.innerHTML = '';
            } else {
                form.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        function showError(error) {
            showLoading(false);
            const statusMsg = document.getElementById('status-message');
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = "錯誤：" + error.message;
        }
    </script>
</body>
</html>